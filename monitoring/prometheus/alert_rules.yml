# Alert rules for canvodpy performance monitoring
# These rules detect performance degradation and errors

groups:
  - name: canvodpy_performance
    interval: 30s
    rules:
      # Alert if icechunk write duration exceeds 10 seconds
      - alert: IcechunkWriteSlow
        expr: |
          (
            rate(canvodpy_icechunk_write_duration_seconds_sum[5m]) 
            / 
            rate(canvodpy_icechunk_write_duration_seconds_count[5m])
          ) > 10
        for: 5m
        labels:
          severity: warning
          component: icechunk
        annotations:
          summary: "Icechunk writes are slow"
          description: "Average icechunk write duration is {{ $value }}s (threshold: 10s)"
      
      # Alert if icechunk write duration is 2x baseline
      - alert: IcechunkWriteDegraded
        expr: |
          (
            rate(canvodpy_icechunk_write_duration_seconds_sum[5m]) 
            / 
            rate(canvodpy_icechunk_write_duration_seconds_count[5m])
          ) 
          > 
          2 * (
            rate(canvodpy_icechunk_write_duration_seconds_sum[1h] offset 1d) 
            / 
            rate(canvodpy_icechunk_write_duration_seconds_count[1h] offset 1d)
          )
        for: 10m
        labels:
          severity: warning
          component: icechunk
        annotations:
          summary: "Icechunk write performance degraded"
          description: "Write duration is 2x higher than yesterday's baseline"
      
      # Alert if RINEX processing duration exceeds 60 seconds
      - alert: RinexProcessingSlow
        expr: |
          (
            rate(canvodpy_rinex_processing_duration_seconds_sum[5m]) 
            / 
            rate(canvodpy_rinex_processing_duration_seconds_count[5m])
          ) > 60
        for: 5m
        labels:
          severity: warning
          component: rinex
        annotations:
          summary: "RINEX processing is slow"
          description: "Average RINEX processing duration is {{ $value }}s (threshold: 60s)"
