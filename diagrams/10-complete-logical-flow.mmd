flowchart TD
    %% ── Configuration ──
    subgraph CFG["Configuration"]
        YAML["YAML Config Files (processing, sites, sids)"]
        PYDANTIC["Pydantic Validation + Deep Merge with Defaults"]
        CONFIG["CanvodConfig"]
    end

    %% ── Site Initialization ──
    subgraph INIT["Site Initialization"]
        SITE["Site(name) Load receiver configs, initialize stores"]
        RINEX_STORE["RINEX Icechunk Store (versioned observations)"]
        VOD_STORE["VOD Icechunk Store (versioned retrievals)"]
    end

    %% ── Data Discovery ──
    subgraph DISCOVERY["Data Discovery (per DOY)"]
        MATCHER["PairDataDirMatcher (ThreadPoolExecutor)"]
        EXPAND["SCS Expansion Reference receivers expanded per canopy position"]
        SCHEDULE["Processing Schedule {date: {group: (dir, type, pos_dir)}}"]
    end

    %% ── Auxiliary Data (once per DOY) ──
    subgraph AUX["Auxiliary Data Pipeline (sequential, once per DOY)"]
        FTP["FTP Download ESA primary / NASA fallback"]
        SP3_PARSE["Parse SP3 Ephemerides (ECEF positions + velocities)"]
        CLK_PARSE["Parse CLK Corrections (satellite clock offsets)"]
        EPOCH_GRID["Generate 24h Epoch Grid (n = 86400 / sampling_interval)"]
        HERMITE["Hermite Spline Interpolation (ephemerides, cubic, velocity-aware)"]
        LINEAR["Piecewise Linear Interpolation (clock corrections, window=9, jump_thr=1e-6)"]
        AUX_ZARR["Merged Auxiliary Zarr (cached per DOY)"]
    end

    %% ── Parallel RINEX Processing ──
    subgraph PARALLEL["Parallel RINEX Processing (ProcessPoolExecutor, n workers)"]
        subgraph WORKER["Per Hourly File (independent process)"]
            READ["1. Read RINEX v3.04 (Rnxv3Obs.to_ds)"]
            FILTER["2. Filter Signals (keep_vars, keep_sids)"]
            SLICE_AUX["3. Slice Auxiliary (nearest-epoch match)"]
            COMMON_SID["4. Intersect SIDs (RINEX ∩ auxiliary)"]
            SPHERICAL["5. Spherical Coordinates (ECEF to r, theta, phi relative to receiver position)"]
        end
    end

    %% ── Storage ──
    subgraph WRITE["Icechunk Storage (sequential)"]
        HASH_CHECK["Check RINEX File Hash (skip if exists)"]
        NORMALIZE["Normalize Encodings (dtype compatibility)"]
        APPEND["Append to Group (epoch dimension)"]
        COMMIT["Atomic Commit (snapshot ID)"]
        META["Update Metadata (hash, epochs, snapshot, timestamp)"]
    end

    %% ── Grid Assignment ──
    subgraph GRID["Hemispheric Grid Assignment"]
        BUILD_GRID["Construct Grid (equal-area, HEALPix, geodesic, fibonacci, ...)"]
        KDTREE["Build KDTree (cell centres in Cartesian coordinates)"]
        ASSIGN["Spatial Query (O(n log m) per observation)"]
    end

    %% ── VOD Retrieval ──
    subgraph VOD["VOD Retrieval"]
        LOAD_C["Load Canopy Dataset (from RINEX store)"]
        LOAD_R["Load Reference Dataset (from RINEX store, SCS-matched group)"]
        DELTA["Compute Delta-SNR (SNR_canopy - SNR_ref)"]
        TRANSMISSIVITY["Convert to Transmissivity (10^(Delta-SNR/10))"]
        TAU["Tau-Omega Inversion VOD = -ln(T) * cos(theta)"]
        VOD_DS["VOD Dataset (per sid, epoch, cell)"]
    end

    %% ── Output ──
    subgraph OUTPUT["Output"]
        VOD_WRITE["Write to VOD Store (versioned, per analysis pair)"]
        VIZ_2D["2D Hemispheric Plot (polar projection)"]
        VIZ_3D["3D Interactive Surface (Plotly)"]
        EXPORT["Data Export (NetCDF, CSV, Zarr)"]
    end

    %% ── Connections ──

    %% Config flow
    YAML --> PYDANTIC --> CONFIG
    CONFIG --> SITE
    SITE --> RINEX_STORE
    SITE --> VOD_STORE

    %% Discovery
    CONFIG --> MATCHER
    MATCHER --> EXPAND
    EXPAND --> SCHEDULE

    %% Auxiliary pipeline
    SCHEDULE --> FTP
    FTP --> SP3_PARSE
    FTP --> CLK_PARSE
    SP3_PARSE --> HERMITE
    CLK_PARSE --> LINEAR
    SCHEDULE --> EPOCH_GRID
    EPOCH_GRID --> HERMITE
    EPOCH_GRID --> LINEAR
    HERMITE --> AUX_ZARR
    LINEAR --> AUX_ZARR

    %% Parallel processing
    SCHEDULE --> READ
    READ --> FILTER
    FILTER --> SLICE_AUX
    AUX_ZARR --> SLICE_AUX
    SLICE_AUX --> COMMON_SID
    COMMON_SID --> SPHERICAL

    %% Storage
    SPHERICAL --> HASH_CHECK
    HASH_CHECK --> NORMALIZE
    NORMALIZE --> APPEND
    APPEND --> COMMIT
    COMMIT --> META
    META --> RINEX_STORE

    %% Grid
    RINEX_STORE --> BUILD_GRID
    BUILD_GRID --> KDTREE
    KDTREE --> ASSIGN

    %% VOD
    ASSIGN --> LOAD_C
    ASSIGN --> LOAD_R
    LOAD_C --> DELTA
    LOAD_R --> DELTA
    DELTA --> TRANSMISSIVITY
    TRANSMISSIVITY --> TAU
    TAU --> VOD_DS

    %% Output
    VOD_DS --> VOD_WRITE
    VOD_WRITE --> VOD_STORE
    VOD_DS --> VIZ_2D
    VOD_DS --> VIZ_3D
    VOD_DS --> EXPORT
