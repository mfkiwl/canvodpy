flowchart TD
    Start([ğŸš€ Start Processing]) --> Input

    subgraph Input[ğŸ“¥ Data Ingestion]
        RINEX["ğŸ“„ RINEX Files<br/>(.XXo, all constellations)"]
        SP3["ğŸ›°ï¸ SP3 Files<br/>(Precise Orbits)"]
        CLK["â° CLK Files<br/>(Precise Clocks)"]
    end

    subgraph Reading[ğŸ” Reading and Parsing]
        RinexReader["Rnxv3Obs<br/>Parse RINEX v3.04"]
        AuxReader["SP3/CLK Parsers<br/>Load Auxiliary Data"]
    end

    subgraph Processing[âš™ï¸ Processing]
        Interp["Hermite Interpolation<br/>Orbits/clocks â†’ obs epochs"]
        Position["Coordinate Transform<br/>ECEF â†’ spherical (r, Î¸, Ï†)"]
        Augment["Dataset Augmentation<br/>Merge RINEX + geometry"]
    end

    subgraph Storage[ğŸ’¾ Versioned Storage - Icechunk]
        Icechunk["Observations Store<br/>(epoch Ã— sid)"]
    end

    subgraph Analysis[ğŸ“Š Analysis]
        VODCalc["VOD Retrieval<br/>Tau-Omega model Â· canopy vs reference"]
        GridAssign["Hemispheric Grid Assignment<br/>Equal-area / HEALPix / geodesic"]
        Aggregate["Aggregation<br/>Per-cell statistics"]
    end

    subgraph Output[ğŸ“ˆ Output]
        Viz2D["2D Hemisphere Plots<br/>Polar projection"]
        Viz3D["3D Interactive Plots<br/>Plotly surface"]
        Export["Data Export<br/>NetCDF / CSV"]
    end

    RINEX --> RinexReader
    SP3 --> AuxReader
    CLK --> AuxReader

    RinexReader --> Augment
    AuxReader --> Interp
    Interp --> Position
    Position --> Augment
    Augment --> Icechunk

    Icechunk --> VODCalc
    VODCalc --> GridAssign
    GridAssign --> Aggregate

    Aggregate --> Viz2D
    Aggregate --> Viz3D
    Aggregate --> Export

    Viz2D --> End([âœ… Complete])
    Viz3D --> End
    Export --> End

    style Start fill:#4caf50,stroke:#1b5e20,stroke-width:3px,color:#fff
    style End fill:#4caf50,stroke:#1b5e20,stroke-width:3px,color:#fff
    style Input fill:#fff3e0,stroke:#e65100,stroke-width:2px
    style Reading fill:#ffecb3,stroke:#f57c00,stroke-width:2px
    style Processing fill:#e1f5fe,stroke:#0277bd,stroke-width:2px
    style Storage fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    style Analysis fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    style Output fill:#e0f2f1,stroke:#00695c,stroke-width:2px
