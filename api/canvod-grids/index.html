
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="GNSS Transmissometry (GNSS-T) analysis framework for Python">
      
      
        <meta name="author" content="Nicolas Bader">
      
      
        <link rel="canonical" href="https://nfb2021.github.io/canvodpy/api/canvod-grids/">
      
      
        <link rel="prev" href="../canvod-auxiliary/">
      
      
        <link rel="next" href="../canvod-vod/">
      
      
        
      
      
      <link rel="icon" href="../../assets/logo.svg">
      <meta name="generator" content="zensical-0.0.20">
    
    
      
        <title>canvod.grids API Reference - canVODpy</title>
      
    
    
      
        
      
      <link rel="stylesheet" href="../../assets/stylesheets/modern/main.d4922b3c.min.css">
      
        
          
        
        <link rel="stylesheet" href="../../assets/stylesheets/modern/palette.dfe2e883.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,500,500i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Inter";--md-code-font:"JetBrains Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/canvod-nordic.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,t)=>(e<<5)-e+t.charCodeAt(0)),0),__md_get=(e,t=localStorage,a=__md_scope)=>JSON.parse(t.getItem(a.pathname+"."+e)),__md_set=(e,t,a=localStorage,_=__md_scope)=>{try{a.setItem(_.pathname+"."+e,JSON.stringify(t))}catch(e){}},document.documentElement.setAttribute("data-platform",navigator.platform)</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#canvodgrids-api-reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="canVODpy" class="md-header__button md-logo" aria-label="canVODpy" data-md-component="logo">
      
  <img src="../../assets/logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="lucide lucide-menu" viewBox="0 0 24 24"><path d="M4 5h16M4 12h16M4 19h16"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            canVODpy
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              canvod.grids API Reference
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="none" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="lucide lucide-sun" viewBox="0 0 24 24"><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="none" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="lucide lucide-moon" viewBox="0 0 24 24"><path d="M20.985 12.486a9 9 0 1 1-9.473-9.472c.405-.022.617.46.402.803a6 6 0 0 0 8.268 8.268c.344-.215.825-.004.803.401"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="lucide lucide-search" viewBox="0 0 24 24"><path d="m21 21-4.34-4.34"/><circle cx="11" cy="11" r="8"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog" aria-label="Search">
  <button type="button" class="md-search__button">
    Search
  </button>
</div>
      
    
    <div class="md-header__source">
      
        <a href="https://github.com/nfb2021/canvodpy" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    nfb2021/canvodpy
  </div>
</a>
      
    </div>
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../architecture/" class="md-tabs__link">
          
  
  Architecture

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../packages/readers/overview/" class="md-tabs__link">
          
  
  Packages

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../CONTRIBUTING/" class="md-tabs__link">
          
  
  Development

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../VERSIONING/" class="md-tabs__link">
          
  
  Release & Publishing

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../canvodpy/" class="md-tabs__link">
          
  
  API Reference

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="canVODpy" class="md-nav__button md-logo" aria-label="canVODpy" data-md-component="logo">
      
  <img src="../../assets/logo.svg" alt="logo">

    </a>
    canVODpy
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/nfb2021/canvodpy" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    nfb2021/canvodpy
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Architecture
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Monorepo Structure
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../namespace-packages/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Namespace Packages
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../dependencies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Package Dependencies
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Packages
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Packages
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    canvod-readers
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    canvod-readers
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/readers/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/readers/rinex-format/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    RINEX v3.04 Format
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/readers/architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Reader Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/readers/extending/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Extending Readers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    canvod-auxiliary
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    canvod-auxiliary
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/auxiliary/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/auxiliary/preprocessing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Preprocessing Pipeline
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/auxiliary/interpolation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Interpolation Methods
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/auxiliary/coordinates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Coordinate Systems
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/auxiliary/products/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Product Registry
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    canvod-grids
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    canvod-grids
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/grids/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    canvod-vod
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    canvod-vod
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/vod/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_5" >
        
          
          <label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    canvod-store
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    canvod-store
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/store/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/store/icechunk/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Icechunk Storage
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/store/storage-strategies/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Storage Strategies
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_6" >
        
          
          <label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    canvod-viz
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    canvod-viz
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/viz/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_7" >
        
          
          <label class="md-nav__link" for="__nav_3_7" id="__nav_3_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    canvod-utils
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    canvod-utils
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../packages/utils/overview/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Development
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Development
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CONTRIBUTING/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/development/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Development Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/architecture-design/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture & Design Patterns
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../build-system/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Build System
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../tooling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tooling
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Release & Publishing
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Release & Publishing
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../VERSIONING/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Versioning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../RELEASING/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Release Process
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/PYPI_SETUP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    PyPI Setup
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/ZENODO_SETUP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Zenodo DOI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/OIDC_EXPLAINED/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    OIDC Authentication
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../guides/HOW_RELEASE_WORKS/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Release Internals
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" checked>
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    API Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../canvodpy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    canvodpy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../canvod-readers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    canvod.readers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../canvod-auxiliary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    canvod.auxiliary
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    canvod.grids
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    canvod.grids
  

    
  </span>
  
  

      </a>
      
        


<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#package" class="md-nav__link">
    <span class="md-ellipsis">
      
        Package
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids" class="md-nav__link">
    <span class="md-ellipsis">
      
        grids
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.BaseGridBuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        BaseGridBuilder
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BaseGridBuilder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.BaseGridBuilder--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.BaseGridBuilder.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.BaseGridBuilder.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.BaseGridBuilder.get_grid_type" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_grid_type
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.BaseGridBuilder.build" class="md-nav__link">
    <span class="md-ellipsis">
      
        build
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="build">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.BaseGridBuilder.build--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.GridData" class="md-nav__link">
    <span class="md-ellipsis">
      
        GridData
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GridData">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.GridData--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.GridData.coords" class="md-nav__link">
    <span class="md-ellipsis">
      
        coords
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.GridData.ncells" class="md-nav__link">
    <span class="md-ellipsis">
      
        ncells
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.GridData.get_patches" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_patches
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.GridData.get_solid_angles" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_solid_angles
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.GridData.get_grid_stats" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_grid_stats
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.GridType" class="md-nav__link">
    <span class="md-ellipsis">
      
        GridType
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.CellAggregator" class="md-nav__link">
    <span class="md-ellipsis">
      
        CellAggregator
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CellAggregator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.CellAggregator.aggregate_by_cell" class="md-nav__link">
    <span class="md-ellipsis">
      
        aggregate_by_cell
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="aggregate_by_cell">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.CellAggregator.aggregate_by_cell--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.CellAggregator.aggregate_by_cell--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.create_hemigrid" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_hemigrid
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="create_hemigrid">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.create_hemigrid--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.create_hemigrid--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.create_hemigrid--examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Examples
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.create_hemigrid--equal-area-grid-with-10-resolution" class="md-nav__link">
    <span class="md-ellipsis">
      
        Equal area grid with 10Â° resolution
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.create_hemigrid--htm-grid-with-subdivision-level-3" class="md-nav__link">
    <span class="md-ellipsis">
      
        HTM grid with subdivision level 3
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.create_hemigrid--geodesic-grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        Geodesic grid
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Geodesic grid">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.create_hemigrid--notes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notes
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#grid-builders" class="md-nav__link">
    <span class="md-ellipsis">
      
        Grid Builders
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.core.grid_builder" class="md-nav__link">
    <span class="md-ellipsis">
      
        grid_builder
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.core.grid_builder.BaseGridBuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        BaseGridBuilder
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BaseGridBuilder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.core.grid_builder.BaseGridBuilder--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.core.grid_builder.BaseGridBuilder.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.core.grid_builder.BaseGridBuilder.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.core.grid_builder.BaseGridBuilder.get_grid_type" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_grid_type
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.core.grid_builder.BaseGridBuilder.build" class="md-nav__link">
    <span class="md-ellipsis">
      
        build
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="build">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.core.grid_builder.BaseGridBuilder.build--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#equal-area-grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        Equal-Area Grid
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_area_grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        equal_area_grid
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_area_grid.EqualAreaBuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        EqualAreaBuilder
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EqualAreaBuilder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_area_grid.EqualAreaBuilder--coordinate-convention-physics-gnss" class="md-nav__link">
    <span class="md-ellipsis">
      
        Coordinate convention (physics / GNSS)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_area_grid.EqualAreaBuilder--what-angular_resolution-means" class="md-nav__link">
    <span class="md-ellipsis">
      
        What HEALPix and hemispheric grid operations. Provides hemisphere grid structures for GNSS signal observation analysis. BaseGridBuilder &para; Bases: ABC Abstract base for hemispherical grid builders. Parameters&para; angular_resolution : float Angular resolution in degrees cutoff_theta : float Maximum polar angle cutoff in degrees phi_rotation : float Rotation angle in degrees (applied to all phi values) Source code in packages/canvod-grids/src/canvod/grids/core/grid_builder.py 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140class BaseGridBuilder(ABC): &quot;&quot;&quot;Abstract base for hemispherical grid builders. Parameters ---------- angular_resolution : float Angular resolution in degrees cutoff_theta : float Maximum polar angle cutoff in degrees phi_rotation : float Rotation angle in degrees (applied to all phi values) &quot;&quot;&quot; def __init__( self, angular_resolution: float = 2, cutoff_theta: float = 0, phi_rotation: float = 0, ) -&gt; None: &quot;&quot;&quot;Initialize the grid builder. Parameters ---------- angular_resolution : float, default 2 Angular resolution in degrees. cutoff_theta : float, default 0 Maximum polar angle cutoff in degrees. phi_rotation : float, default 0 Rotation angle in degrees. &quot;&quot;&quot; self.angular_resolution = angular_resolution self.angular_resolution_rad = np.deg2rad(angular_resolution) self.cutoff_theta = cutoff_theta self.cutoff_theta_rad = np.deg2rad(cutoff_theta) self.phi_rotation = phi_rotation self.phi_rotation_rad = np.deg2rad(phi_rotation) self._logger = _get_logger() @abstractmethod def _build_grid( self, ) -&gt; ( tuple[pl.DataFrame, np.ndarray, list[np.ndarray], list[np.ndarray]] | tuple[ pl.DataFrame, np.ndarray, list[np.ndarray], list[np.ndarray], dict[str, Any] ] ): &quot;&quot;&quot;Build grid. Returns ------- grid : pl.DataFrame Grid cells theta_lims : np.ndarray Theta band limits phi_lims : list[np.ndarray] Phi limits per band cell_ids : list[np.ndarray] Cell IDs per band extra_kwargs : dict, optional Additional metadata &quot;&quot;&quot; @abstractmethod def get_grid_type(self) -&gt; str: &quot;&quot;&quot;Get grid type identifier.&quot;&quot;&quot; def build(self) -&gt; GridData: &quot;&quot;&quot;Build hemisphere grid. Returns ------- GridData Complete grid data structure &quot;&quot;&quot; self._logger.info( &quot;grid_build_started&quot;, grid_type=self.get_grid_type(), angular_resolution=self.angular_resolution, ) result = self._build_grid() if len(result) == 4: grid, theta_lims, phi_lims, cell_ids = result extra_kwargs = {} elif len(result) == 5: grid, theta_lims, phi_lims, cell_ids, extra_kwargs = result else: raise ValueError(f&quot;Invalid grid builder result: {len(result)} elements&quot;) # Apply phi rotation if specified (vectorized operations) if self.phi_rotation_rad != 0: grid = grid.with_columns( [(pl.col(&quot;phi&quot;) + self.phi_rotation_rad) % (2 * np.pi)] ) if &quot;phi_min&quot; in grid.columns: grid = grid.with_columns( [ ( (pl.col(&quot;phi_min&quot;) + self.phi_rotation_rad) % (2 * np.pi) ).alias(&quot;phi_min&quot;), ( (pl.col(&quot;phi_max&quot;) + self.phi_rotation_rad) % (2 * np.pi) ).alias(&quot;phi_max&quot;), ] ) self._logger.info(&quot;grid_build_complete&quot;, ncells=len(grid)) return GridData( grid=grid, theta_lims=theta_lims, phi_lims=phi_lims, cell_ids=cell_ids, grid_type=self.get_grid_type(), **extra_kwargs, ) __init__(angular_resolution=2, cutoff_theta=0, phi_rotation=0) &para; Initialize the grid builder. Parameters&para; angular_resolution : float, default 2 Angular resolution in degrees. cutoff_theta : float, default 0 Maximum polar angle cutoff in degrees. phi_rotation : float, default 0 Rotation angle in degrees. Source code in packages/canvod-grids/src/canvod/grids/core/grid_builder.py 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56def __init__( self, angular_resolution: float = 2, cutoff_theta: float = 0, phi_rotation: float = 0, ) -&gt; None: &quot;&quot;&quot;Initialize the grid builder. Parameters ---------- angular_resolution : float, default 2 Angular resolution in degrees. cutoff_theta : float, default 0 Maximum polar angle cutoff in degrees. phi_rotation : float, default 0 Rotation angle in degrees. &quot;&quot;&quot; self.angular_resolution = angular_resolution self.angular_resolution_rad = np.deg2rad(angular_resolution) self.cutoff_theta = cutoff_theta self.cutoff_theta_rad = np.deg2rad(cutoff_theta) self.phi_rotation = phi_rotation self.phi_rotation_rad = np.deg2rad(phi_rotation) self._logger = _get_logger() get_grid_type() abstractmethod &para; Get grid type identifier. Source code in packages/canvod-grids/src/canvod/grids/core/grid_builder.py 84 85 86@abstractmethod def get_grid_type(self) -&gt; str: &quot;&quot;&quot;Get grid type identifier.&quot;&quot;&quot; build() &para; Build hemisphere grid. Returns&para; GridData Complete grid data structure Source code in packages/canvod-grids/src/canvod/grids/core/grid_builder.py 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140def build(self) -&gt; GridData: &quot;&quot;&quot;Build hemisphere grid. Returns ------- GridData Complete grid data structure &quot;&quot;&quot; self._logger.info( &quot;grid_build_started&quot;, grid_type=self.get_grid_type(), angular_resolution=self.angular_resolution, ) result = self._build_grid() if len(result) == 4: grid, theta_lims, phi_lims, cell_ids = result extra_kwargs = {} elif len(result) == 5: grid, theta_lims, phi_lims, cell_ids, extra_kwargs = result else: raise ValueError(f&quot;Invalid grid builder result: {len(result)} elements&quot;) # Apply phi rotation if specified (vectorized operations) if self.phi_rotation_rad != 0: grid = grid.with_columns( [(pl.col(&quot;phi&quot;) + self.phi_rotation_rad) % (2 * np.pi)] ) if &quot;phi_min&quot; in grid.columns: grid = grid.with_columns( [ ( (pl.col(&quot;phi_min&quot;) + self.phi_rotation_rad) % (2 * np.pi) ).alias(&quot;phi_min&quot;), ( (pl.col(&quot;phi_max&quot;) + self.phi_rotation_rad) % (2 * np.pi) ).alias(&quot;phi_max&quot;), ] ) self._logger.info(&quot;grid_build_complete&quot;, ncells=len(grid)) return GridData( grid=grid, theta_lims=theta_lims, phi_lims=phi_lims, cell_ids=cell_ids, grid_type=self.get_grid_type(), **extra_kwargs, ) GridData dataclass &para; Immutable container for hemispherical grid structure. Parameters&para; grid : pl.DataFrame Grid cells with phi, theta, and bounds theta_lims : np.ndarray Theta band limits phi_lims : list[np.ndarray] Phi limits per theta band cell_ids : list[np.ndarray] Cell IDs per theta band grid_type : str Grid type identifier solid_angles : np.ndarray, optional Solid angles per cell [steradians] metadata : dict, optional Additional grid metadata voronoi : Any, optional Voronoi tessellation object (for Fibonacci grids) vertices : np.ndarray, optional 3D vertices (for triangular grids) points_xyz : np.ndarray, optional 3D point cloud (for Fibonacci grids) vertex_phi : np.ndarray, optional Vertex phi coordinates vertex_theta : np.ndarray, optional Vertex theta coordinates Source code in packages/canvod-grids/src/canvod/grids/core/grid_data.py 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251@dataclass(frozen=True) class GridData: &quot;&quot;&quot;Immutable container for hemispherical grid structure. Parameters ---------- grid : pl.DataFrame Grid cells with phi, theta, and bounds theta_lims : np.ndarray Theta band limits phi_lims : list[np.ndarray] Phi limits per theta band cell_ids : list[np.ndarray] Cell IDs per theta band grid_type : str Grid type identifier solid_angles : np.ndarray, optional Solid angles per cell [steradians] metadata : dict, optional Additional grid metadata voronoi : Any, optional Voronoi tessellation object (for Fibonacci grids) vertices : np.ndarray, optional 3D vertices (for triangular grids) points_xyz : np.ndarray, optional 3D point cloud (for Fibonacci grids) vertex_phi : np.ndarray, optional Vertex phi coordinates vertex_theta : np.ndarray, optional Vertex theta coordinates &quot;&quot;&quot; grid: pl.DataFrame theta_lims: np.ndarray phi_lims: list[np.ndarray] cell_ids: list[np.ndarray] grid_type: str solid_angles: np.ndarray | None = None metadata: dict | None = None voronoi: Any | None = None vertices: np.ndarray | None = None points_xyz: np.ndarray | None = None vertex_phi: np.ndarray | None = None vertex_theta: np.ndarray | None = None @property def coords(self) -&gt; pl.DataFrame: &quot;&quot;&quot;Get cell coordinates.&quot;&quot;&quot; return self.grid.select([&quot;phi&quot;, &quot;theta&quot;]) @property def ncells(self) -&gt; int: &quot;&quot;&quot;Number of cells in grid.&quot;&quot;&quot; return len(self.grid) def get_patches(self) -&gt; pl.Series: &quot;&quot;&quot;Create matplotlib patches for polar visualization.&quot;&quot;&quot; patches = [ Rectangle( (row[&quot;phi_min&quot;], row[&quot;theta_min&quot;]), row[&quot;phi_max&quot;] - row[&quot;phi_min&quot;], row[&quot;theta_max&quot;] - row[&quot;theta_min&quot;], fill=True, ) for row in self.grid.iter_rows(named=True) ] return pl.Series(&quot;Patches&quot;, patches) def get_solid_angles(self) -&gt; np.ndarray: &quot;&quot;&quot;Calculate solid angle for each cell [steradians].&quot;&quot;&quot; if self.solid_angles is not None: return self.solid_angles # HEALPix if self.grid_type == &quot;healpix&quot; and &quot;healpix_nside&quot; in self.grid.columns: try: import healpy as hp nside = int(self.grid[&quot;healpix_nside&quot;][0]) return np.full( len(self.grid), hp.nside2pixarea(nside), dtype=np.float64 ) except ImportError: pass # Geodesic if self.grid_type == &quot;geodesic&quot; and &quot;geodesic_vertices&quot; in self.grid.columns: return self._compute_geodesic_solid_angles() # HTM if self.grid_type == &quot;htm&quot; and &quot;htm_vertex_0&quot; in self.grid.columns: return self._compute_htm_solid_angles() # Fibonacci if self.grid_type == &quot;fibonacci&quot; and &quot;voronoi_region&quot; in self.grid.columns: return self._compute_voronoi_solid_angles() # Default return self._geometric_solid_angles() def _compute_htm_solid_angles(self) -&gt; np.ndarray: &quot;&quot;&quot;Compute solid angles for HTM triangular cells.&quot;&quot;&quot; solid_angles = [] for row in self.grid.iter_rows(named=True): v0 = np.array(row[&quot;htm_vertex_0&quot;]) v1 = np.array(row[&quot;htm_vertex_1&quot;]) v2 = np.array(row[&quot;htm_vertex_2&quot;]) # Spherical excess formula a = np.arccos(np.clip(np.dot(v1, v2), -1, 1)) b = np.arccos(np.clip(np.dot(v0, v2), -1, 1)) c = np.arccos(np.clip(np.dot(v0, v1), -1, 1)) s = (a + b + c) / 2 tan_E_4 = np.sqrt( np.tan(s / 2) * np.tan((s - a) / 2) * np.tan((s - b) / 2) * np.tan((s - c) / 2) ) E = 4 * np.arctan(tan_E_4) solid_angles.append(E) return np.array(solid_angles) def _compute_geodesic_solid_angles(self) -&gt; np.ndarray: &quot;&quot;&quot;Compute solid angles for geodesic triangular cells.&quot;&quot;&quot; vertices = (self.metadata or {}).get(&quot;vertices&quot;) if vertices is None: return self._geometric_solid_angles() solid_angles = [] for row in self.grid.iter_rows(named=True): v_indices = row[&quot;geodesic_vertices&quot;] v0, v1, v2 = vertices[v_indices] a = np.arccos(np.clip(np.dot(v1, v2), -1, 1)) b = np.arccos(np.clip(np.dot(v0, v2), -1, 1)) c = np.arccos(np.clip(np.dot(v0, v1), -1, 1)) s = (a + b + c) / 2 tan_E_4 = np.sqrt( np.tan(s / 2) * np.tan((s - a) / 2) * np.tan((s - b) / 2) * np.tan((s - c) / 2) ) E = 4 * np.arctan(tan_E_4) solid_angles.append(E) return np.array(solid_angles) def _compute_voronoi_solid_angles(self) -&gt; np.ndarray: &quot;&quot;&quot;Compute solid angles for Voronoi cells.&quot;&quot;&quot; if self.voronoi is None: return self._geometric_solid_angles() sv = self.voronoi solid_angles = [] for row in self.grid.iter_rows(named=True): region = row[&quot;voronoi_region&quot;] if len(region) &lt; 3: solid_angles.append(np.nan) continue vertices = sv.vertices[region] center = np.array( [ np.sin(row[&quot;theta&quot;]) * np.cos(row[&quot;phi&quot;]), np.sin(row[&quot;theta&quot;]) * np.sin(row[&quot;phi&quot;]), np.cos(row[&quot;theta&quot;]), ] ) total_angle = 0 n = len(vertices) for i in range(n): v1 = vertices[i] v2 = vertices[(i + 1) % n] a = np.arccos(np.clip(np.dot(center, v1), -1, 1)) b = np.arccos(np.clip(np.dot(center, v2), -1, 1)) c = np.arccos(np.clip(np.dot(v1, v2), -1, 1)) s = (a + b + c) / 2 tan_E_4 = np.sqrt( np.tan(s / 2) * np.tan((s - a) / 2) * np.tan((s - b) / 2) * np.tan((s - c) / 2) ) E = 4 * np.arctan(tan_E_4) total_angle += E solid_angles.append(total_angle) return np.array(solid_angles) def _geometric_solid_angles(self) -&gt; np.ndarray: &quot;&quot;&quot;Fallback geometric calculation.&quot;&quot;&quot; solid_angles = [] for row in self.grid.iter_rows(named=True): delta_phi = row[&quot;phi_max&quot;] - row[&quot;phi_min&quot;] cos_diff = np.cos(row[&quot;theta_min&quot;]) - np.cos(row[&quot;theta_max&quot;]) omega = delta_phi * cos_diff solid_angles.append(omega) return np.array(solid_angles) def get_grid_stats(self) -&gt; dict: &quot;&quot;&quot;Get grid statistics including solid angle uniformity.&quot;&quot;&quot; solid_angles = self.get_solid_angles() stats = { &quot;total_cells&quot;: self.ncells, &quot;grid_type&quot;: self.grid_type, &quot;theta_bands&quot;: len(self.theta_lims), &quot;cells_per_band&quot;: [len(ids) for ids in self.cell_ids], &quot;solid_angle_mean_sr&quot;: float(np.mean(solid_angles)), &quot;solid_angle_std_sr&quot;: float(np.std(solid_angles)), &quot;solid_angle_cv_percent&quot;: float( np.std(solid_angles) / np.mean(solid_angles) * 100 ), &quot;total_solid_angle_sr&quot;: float(np.sum(solid_angles)), &quot;hemisphere_solid_angle_sr&quot;: 2 * np.pi, } # Add HEALPix-specific info if self.grid_type == &quot;healpix&quot; and &quot;healpix_nside&quot; in self.grid.columns: try: import healpy as hp nside = int(self.grid[&quot;healpix_nside&quot;][0]) stats[&quot;healpix_nside&quot;] = nside stats[&quot;healpix_npix_total&quot;] = hp.nside2npix(nside) stats[&quot;healpix_pixel_area_sr&quot;] = hp.nside2pixarea(nside) stats[&quot;healpix_resolution_arcmin&quot;] = hp.nside2resol(nside, arcmin=True) except ImportError: pass return stats coords property &para; Get cell coordinates. ncells property &para; Number of cells in grid. get_patches() &para; Create matplotlib patches for polar visualization. Source code in packages/canvod-grids/src/canvod/grids/core/grid_data.py 67 68 69 70 71 72 73 74 75 76 77 78def get_patches(self) -&gt; pl.Series: &quot;&quot;&quot;Create matplotlib patches for polar visualization.&quot;&quot;&quot; patches = [ Rectangle( (row[&quot;phi_min&quot;], row[&quot;theta_min&quot;]), row[&quot;phi_max&quot;] - row[&quot;phi_min&quot;], row[&quot;theta_max&quot;] - row[&quot;theta_min&quot;], fill=True, ) for row in self.grid.iter_rows(named=True) ] return pl.Series(&quot;Patches&quot;, patches) get_solid_angles() &para; Calculate solid angle for each cell [steradians]. Source code in packages/canvod-grids/src/canvod/grids/core/grid_data.py 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110def get_solid_angles(self) -&gt; np.ndarray: &quot;&quot;&quot;Calculate solid angle for each cell [steradians].&quot;&quot;&quot; if self.solid_angles is not None: return self.solid_angles # HEALPix if self.grid_type == &quot;healpix&quot; and &quot;healpix_nside&quot; in self.grid.columns: try: import healpy as hp nside = int(self.grid[&quot;healpix_nside&quot;][0]) return np.full( len(self.grid), hp.nside2pixarea(nside), dtype=np.float64 ) except ImportError: pass # Geodesic if self.grid_type == &quot;geodesic&quot; and &quot;geodesic_vertices&quot; in self.grid.columns: return self._compute_geodesic_solid_angles() # HTM if self.grid_type == &quot;htm&quot; and &quot;htm_vertex_0&quot; in self.grid.columns: return self._compute_htm_solid_angles() # Fibonacci if self.grid_type == &quot;fibonacci&quot; and &quot;voronoi_region&quot; in self.grid.columns: return self._compute_voronoi_solid_angles() # Default return self._geometric_solid_angles() get_grid_stats() &para; Get grid statistics including solid angle uniformity. Source code in packages/canvod-grids/src/canvod/grids/core/grid_data.py 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251def get_grid_stats(self) -&gt; dict: &quot;&quot;&quot;Get grid statistics including solid angle uniformity.&quot;&quot;&quot; solid_angles = self.get_solid_angles() stats = { &quot;total_cells&quot;: self.ncells, &quot;grid_type&quot;: self.grid_type, &quot;theta_bands&quot;: len(self.theta_lims), &quot;cells_per_band&quot;: [len(ids) for ids in self.cell_ids], &quot;solid_angle_mean_sr&quot;: float(np.mean(solid_angles)), &quot;solid_angle_std_sr&quot;: float(np.std(solid_angles)), &quot;solid_angle_cv_percent&quot;: float( np.std(solid_angles) / np.mean(solid_angles) * 100 ), &quot;total_solid_angle_sr&quot;: float(np.sum(solid_angles)), &quot;hemisphere_solid_angle_sr&quot;: 2 * np.pi, } # Add HEALPix-specific info if self.grid_type == &quot;healpix&quot; and &quot;healpix_nside&quot; in self.grid.columns: try: import healpy as hp nside = int(self.grid[&quot;healpix_nside&quot;][0]) stats[&quot;healpix_nside&quot;] = nside stats[&quot;healpix_npix_total&quot;] = hp.nside2npix(nside) stats[&quot;healpix_pixel_area_sr&quot;] = hp.nside2pixarea(nside) stats[&quot;healpix_resolution_arcmin&quot;] = hp.nside2resol(nside, arcmin=True) except ImportError: pass return stats GridType &para; Bases: Enum Available grid projection types for hemispherical tessellation. Source code in packages/canvod-grids/src/canvod/grids/core/grid_types.py 6 7 8 9 10 11 12 13 14 15class GridType(Enum): &quot;&quot;&quot;Available grid projection types for hemispherical tessellation.&quot;&quot;&quot; EQUAL_AREA = &quot;equal_area&quot; # Equal solid angle (ring-based) EQUAL_ANGLE = &quot;equal_angle&quot; # Equal angular spacing EQUIRECTANGULAR = &quot;equirectangular&quot; # Simple rectangular HEALPIX = &quot;healpix&quot; # Hierarchical equal area GEODESIC = &quot;geodesic&quot; # Icosahedral triangular FIBONACCI = &quot;fibonacci&quot; # Golden spiral + Voronoi HTM = &quot;htm&quot; # Hierarchical Triangular Mesh CellAggregator &para; Polars-based per-cell aggregation helpers. Source code in packages/canvod-grids/src/canvod/grids/aggregation.py 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168class CellAggregator: &quot;&quot;&quot;Polars-based per-cell aggregation helpers.&quot;&quot;&quot; @staticmethod def aggregate_by_cell( df: pl.DataFrame, value_var: str = &quot;VOD&quot;, method: str = &quot;mean&quot;, ) -&gt; pl.DataFrame: &quot;&quot;&quot;Aggregate values by ``cell_id``. Parameters ---------- df : pl.DataFrame Must contain ``cell_id`` and *value_var* columns. value_var : str Column to aggregate. method : {&#39;mean&#39;, &#39;median&#39;, &#39;std&#39;, &#39;count&#39;} Aggregation method. Returns ------- pl.DataFrame Two-column DataFrame: ``cell_id``, *value_var*. &quot;&quot;&quot; if &quot;cell_id&quot; not in df.columns: raise ValueError(&quot;pl.DataFrame must have &#39;cell_id&#39; column&quot;) if value_var not in df.columns: raise ValueError(f&quot;pl.DataFrame must have &#39;{value_var}&#39; column&quot;) agg_map = { &quot;mean&quot;: pl.col(value_var).mean(), &quot;median&quot;: pl.col(value_var).median(), &quot;std&quot;: pl.col(value_var).std(), &quot;count&quot;: pl.col(value_var).count(), } if method not in agg_map: raise ValueError(f&quot;Unknown method: {method}&quot;) return ( df.group_by(&quot;cell_id&quot;).agg(agg_map[method].alias(value_var)).sort(&quot;cell_id&quot;) ) aggregate_by_cell(df, value_var=&#39;VOD&#39;, method=&#39;mean&#39;) staticmethod &para; Aggregate values by cell_id. Parameters&para; df : pl.DataFrame Must contain cell_id and value_var columns. value_var : str Column to aggregate. method : {'mean', 'median', 'std', 'count'} Aggregation method. Returns&para; pl.DataFrame Two-column DataFrame: cell_id, value_var. Source code in packages/canvod-grids/src/canvod/grids/aggregation.py 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168@staticmethod def aggregate_by_cell( df: pl.DataFrame, value_var: str = &quot;VOD&quot;, method: str = &quot;mean&quot;, ) -&gt; pl.DataFrame: &quot;&quot;&quot;Aggregate values by ``cell_id``. Parameters ---------- df : pl.DataFrame Must contain ``cell_id`` and *value_var* columns. value_var : str Column to aggregate. method : {&#39;mean&#39;, &#39;median&#39;, &#39;std&#39;, &#39;count&#39;} Aggregation method. Returns ------- pl.DataFrame Two-column DataFrame: ``cell_id``, *value_var*. &quot;&quot;&quot; if &quot;cell_id&quot; not in df.columns: raise ValueError(&quot;pl.DataFrame must have &#39;cell_id&#39; column&quot;) if value_var not in df.columns: raise ValueError(f&quot;pl.DataFrame must have &#39;{value_var}&#39; column&quot;) agg_map = { &quot;mean&quot;: pl.col(value_var).mean(), &quot;median&quot;: pl.col(value_var).median(), &quot;std&quot;: pl.col(value_var).std(), &quot;count&quot;: pl.col(value_var).count(), } if method not in agg_map: raise ValueError(f&quot;Unknown method: {method}&quot;) return ( df.group_by(&quot;cell_id&quot;).agg(agg_map[method].alias(value_var)).sort(&quot;cell_id&quot;) ) create_hemigrid(grid_type, angular_resolution=10.0, **kwargs) &para; Create hemisphere grid of specified type. Factory function for creating various hemisphere grid types commonly used in GNSS analysis. Parameters&para; grid_type : str Type of grid to create: - 'equal_area': Regular lat/lon grid with equal solid angle cells - 'equal_angle': Regular angular spacing (not recommended) - 'rectangular' or 'equirectangular': Simple rectangular grid - 'HTM': Hierarchical Triangular Mesh - 'geodesic': Geodesic sphere subdivision (icosahedron-based) - 'healpix': HEALPix grid (requires healpy) - 'fibonacci': Fibonacci sphere (requires scipy) angular_resolution : float, default 10.0 Angular resolution in degrees **kwargs Additional grid-specific parameters: - cutoff_theta : float - Maximum theta angle cutoff (degrees) - phi_rotation : float - Rotation angle (degrees) - subdivision_level : int - For geodesic/HTM grids - htm_level : int - For HTM grids specifically - nside : int - For HEALPix grids - n_points : int - For Fibonacci grids Returns&para; GridData Complete hemisphere grid data structure Examples&para; Equal area grid with 10Â° resolution&para; grid = create_hemigrid('equal_area', angular_resolution=10.0) HTM grid with subdivision level 3&para; grid = create_hemigrid('HTM', angular_resolution=5.0, htm_level=3) Geodesic grid&para; grid = create_hemigrid('geodesic', angular_resolution=5.0, subdivision_level=2) Notes&para; Grid coordinates use standard spherical convention: - phi: azimuth angle, 0 to 2Ï (0 = East, Ï/2 = North) - theta: elevation angle, 0 to Ï/2 (0 = zenith, Ï/2 = horizon) Source code in packages/canvod-grids/src/canvod/grids/__init__.py 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195def create_hemigrid( grid_type: Literal[ &quot;equal_area&quot;, &quot;equal_angle&quot;, &quot;rectangular&quot;, &quot;equirectangular&quot;, &quot;HTM&quot;, &quot;geodesic&quot;, &quot;healpix&quot;, &quot;fibonacci&quot;, ], angular_resolution: float = 10.0, **kwargs: Any, ) -&gt; GridData: &quot;&quot;&quot;Create hemisphere grid of specified type. Factory function for creating various hemisphere grid types commonly used in GNSS analysis. Parameters ---------- grid_type : str Type of grid to create: - &#39;equal_area&#39;: Regular lat/lon grid with equal solid angle cells - &#39;equal_angle&#39;: Regular angular spacing (not recommended) - &#39;rectangular&#39; or &#39;equirectangular&#39;: Simple rectangular grid - &#39;HTM&#39;: Hierarchical Triangular Mesh - &#39;geodesic&#39;: Geodesic sphere subdivision (icosahedron-based) - &#39;healpix&#39;: HEALPix grid (requires healpy) - &#39;fibonacci&#39;: Fibonacci sphere (requires scipy) angular_resolution : float, default 10.0 Angular resolution in degrees **kwargs Additional grid-specific parameters: - cutoff_theta : float - Maximum theta angle cutoff (degrees) - phi_rotation : float - Rotation angle (degrees) - subdivision_level : int - For geodesic/HTM grids - htm_level : int - For HTM grids specifically - nside : int - For HEALPix grids - n_points : int - For Fibonacci grids Returns ------- GridData Complete hemisphere grid data structure Examples -------- &gt;&gt;&gt; # Equal area grid with 10Â° resolution &gt;&gt;&gt; grid = create_hemigrid(&#39;equal_area&#39;, angular_resolution=10.0) &gt;&gt;&gt; &gt;&gt;&gt; # HTM grid with subdivision level 3 &gt;&gt;&gt; grid = create_hemigrid(&#39;HTM&#39;, angular_resolution=5.0, htm_level=3) &gt;&gt;&gt; &gt;&gt;&gt; # Geodesic grid &gt;&gt;&gt; grid = create_hemigrid(&#39;geodesic&#39;, angular_resolution=5.0, subdivision_level=2) Notes ----- Grid coordinates use standard spherical convention: - phi: azimuth angle, 0 to 2Ï (0 = East, Ï/2 = North) - theta: elevation angle, 0 to Ï/2 (0 = zenith, Ï/2 = horizon) &quot;&quot;&quot; grid_type_lower = grid_type.lower() if grid_type_lower == &quot;equal_area&quot;: builder = EqualAreaBuilder( angular_resolution=angular_resolution, **kwargs, ) elif grid_type_lower == &quot;equal_angle&quot;: builder = EqualAngleBuilder( angular_resolution=angular_resolution, **kwargs, ) elif grid_type_lower in [&quot;rectangular&quot;, &quot;equirectangular&quot;]: builder = EquirectangularBuilder( angular_resolution=angular_resolution, **kwargs, ) elif grid_type_lower == &quot;htm&quot;: builder = HTMBuilder( angular_resolution=angular_resolution, **kwargs, ) elif grid_type_lower == &quot;geodesic&quot;: builder = GeodesicBuilder( angular_resolution=angular_resolution, **kwargs, ) elif grid_type_lower == &quot;healpix&quot;: builder = HEALPixBuilder( angular_resolution=angular_resolution, **kwargs, ) elif grid_type_lower == &quot;fibonacci&quot;: builder = FibonacciBuilder( angular_resolution=angular_resolution, **kwargs, ) else: raise ValueError( f&quot;Unknown grid type: {grid_type}. &quot; f&quot;Available types: equal_area, equal_angle, rectangular, &quot; f&quot;equirectangular, HTM, geodesic, healpix, fibonacci&quot; ) return builder.build() means
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_area_grid.EqualAreaBuilder--mathematical-construction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mathematical construction
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_area_grid.EqualAreaBuilder--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_area_grid.EqualAreaBuilder.get_grid_type" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_grid_type
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_grid_type">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_area_grid.EqualAreaBuilder.get_grid_type--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#healpix-grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        HEALPix Grid
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.healpix_grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        healpix_grid
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        HEALPixBuilder
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HEALPixBuilder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder--coordinate-convention" class="md-nav__link">
    <span class="md-ellipsis">
      
        Coordinate convention
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder--what-nside-resolution-means" class="md-nav__link">
    <span class="md-ellipsis">
      
        What Cell assignment and vertex extraction for hemisphere grids. Functions in this module operate on :class:~canvod.grids.core.GridData instances and VOD xarray Datasets. Cell assignment&para; add_cell_ids_to_vod_fast â vectorised KDTree lookup (preferred) add_cell_ids_to_vod â element-wise fallback add_cell_ids_to_ds_fast â dask-lazy variant for out-of-core data Vertex / grid conversion&para; extract_grid_vertices â flat (x, y, z) arrays for 3-D visualisation grid_to_dataset â xarray Dataset with vertices and solid angles add_cell_ids_to_vod_fast(vod_ds, grid, grid_name) &para; Assign grid cells to every observation in a VOD dataset (vectorised). Uses a KDTree built from the grid cell centres for O(n log m) lookup. Parameters&para; vod_ds : xr.Dataset VOD dataset with phi(epoch, sid) and theta(epoch, sid) coordinate variables and a VOD data variable. grid : GridData Hemisphere grid instance. grid_name : str Grid identifier used to name the output coordinate (cell_id_&lt;grid_name&gt;). Returns&para; xr.Dataset vod_ds with an additional cell_id_&lt;grid_name&gt;(epoch, sid) variable. Observations with non-finite Ï or Î¸ receive NaN. Source code in packages/canvod-grids/src/canvod/grids/operations.py 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154def add_cell_ids_to_vod_fast( vod_ds: xr.Dataset, grid: GridData, grid_name: str ) -&gt; xr.Dataset: &quot;&quot;&quot;Assign grid cells to every observation in a VOD dataset (vectorised). Uses a KDTree built from the grid cell centres for O(n log m) lookup. Parameters ---------- vod_ds : xr.Dataset VOD dataset with ``phi(epoch, sid)`` and ``theta(epoch, sid)`` coordinate variables and a ``VOD`` data variable. grid : GridData Hemisphere grid instance. grid_name : str Grid identifier used to name the output coordinate (``cell_id_&lt;grid_name&gt;``). Returns ------- xr.Dataset *vod_ds* with an additional ``cell_id_&lt;grid_name&gt;(epoch, sid)`` variable. Observations with non-finite Ï or Î¸ receive NaN. &quot;&quot;&quot; start_time = time.time() print(f&quot;\nAssigning cells for &#39;{grid_name}&#39;...&quot;) log.info( &quot;cell_assignment_started&quot;, grid_name=grid_name, grid_cells=len(grid.grid), observations=vod_ds[&quot;VOD&quot;].size, method=&quot;kdtree_fast&quot;, ) tree = _build_kdtree(grid) cell_id_col = grid.grid[&quot;cell_id&quot;].to_numpy() phi = vod_ds[&quot;phi&quot;].values.ravel() theta = vod_ds[&quot;theta&quot;].values.ravel() valid = np.isfinite(phi) &amp; np.isfinite(theta) cell_ids = np.full(len(phi), np.nan, dtype=np.float64) if np.any(valid): cell_ids[valid] = _query_points(tree, cell_id_col, phi[valid], theta[valid]) cell_ids_2d = cell_ids.reshape(vod_ds[&quot;VOD&quot;].shape) coord_name = f&quot;cell_id_{grid_name}&quot; vod_ds[coord_name] = ((&quot;epoch&quot;, &quot;sid&quot;), cell_ids_2d) n_assigned = np.sum(np.isfinite(cell_ids_2d)) n_unique = len(np.unique(cell_ids[np.isfinite(cell_ids)])) duration = time.time() - start_time print(f&quot; â Assigned: {n_assigned:,} / {cell_ids_2d.size:,} observations&quot;) print(f&quot; â Unique cells: {n_unique:,}&quot;) log.info( &quot;cell_assignment_complete&quot;, grid_name=grid_name, duration_seconds=round(duration, 2), observations_assigned=int(n_assigned), observations_total=cell_ids_2d.size, unique_cells=int(n_unique), coverage_percent=round(100 * n_assigned / cell_ids_2d.size, 2), ) return vod_ds add_cell_ids_to_vod(vod_ds, grid, grid_name) &para; Assign grid cells to a VOD dataset (element-wise fallback). Slower than :func:add_cell_ids_to_vod_fast; kept for cases where the full dataset does not fit in memory as numpy arrays. Parameters&para; vod_ds : xr.Dataset VOD dataset with phi, theta, and VOD variables. grid : GridData Hemisphere grid instance. grid_name : str Grid identifier for the output coordinate name. Returns&para; xr.Dataset vod_ds with cell_id_&lt;grid_name&gt;(epoch, sid) added. Source code in packages/canvod-grids/src/canvod/grids/operations.py 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210def add_cell_ids_to_vod( vod_ds: xr.Dataset, grid: GridData, grid_name: str ) -&gt; xr.Dataset: &quot;&quot;&quot;Assign grid cells to a VOD dataset (element-wise fallback). Slower than :func:`add_cell_ids_to_vod_fast`; kept for cases where the full dataset does not fit in memory as numpy arrays. Parameters ---------- vod_ds : xr.Dataset VOD dataset with ``phi``, ``theta``, and ``VOD`` variables. grid : GridData Hemisphere grid instance. grid_name : str Grid identifier for the output coordinate name. Returns ------- xr.Dataset *vod_ds* with ``cell_id_&lt;grid_name&gt;(epoch, sid)`` added. &quot;&quot;&quot; print(f&quot;\nAssigning cells for &#39;{grid_name}&#39;...&quot;) tree = _build_kdtree(grid) cell_id_col = grid.grid[&quot;cell_id&quot;].to_numpy() phi_flat = vod_ds[&quot;phi&quot;].to_numpy().ravel() theta_flat = vod_ds[&quot;theta&quot;].to_numpy().ravel() cell_ids_flat = np.full(vod_ds[&quot;VOD&quot;].size, np.nan) for i in range(len(phi_flat)): if np.isfinite(phi_flat[i]) and np.isfinite(theta_flat[i]): cell_ids_flat[i] = _query_points( tree, cell_id_col, np.array([phi_flat[i]]), np.array([theta_flat[i]]) )[0] cell_ids_2d = cell_ids_flat.reshape(vod_ds[&quot;VOD&quot;].shape) coord_name = f&quot;cell_id_{grid_name}&quot; vod_ds[coord_name] = ((&quot;epoch&quot;, &quot;sid&quot;), cell_ids_2d) n_assigned = np.sum(~np.isnan(cell_ids_2d)) print(f&quot; â Added coordinate &#39;{coord_name}&#39;&quot;) print(f&quot; â Assigned: {n_assigned:,} / {cell_ids_2d.size:,} observations&quot;) # Track grid references in dataset attrs if &quot;grid_references&quot; not in vod_ds.attrs: vod_ds.attrs[&quot;grid_references&quot;] = [] vod_ds.attrs[&quot;grid_references&quot;].append(f&quot;grids/{grid_name}&quot;) return vod_ds add_cell_ids_to_ds_fast(ds, grid, grid_name, data_var=&#39;VOD&#39;) &para; Assign grid cells lazily via dask (avoids loading full arrays). The output cell_id_&lt;grid_name&gt; variable is a dask array that computes on access or save. Parameters&para; ds : xr.Dataset Dataset with dask-backed phi and theta arrays. grid : GridData Hemisphere grid instance. grid_name : str Grid identifier for the output coordinate name. data_var : str Name of the main data variable (used only for shape reference). Returns&para; xr.Dataset ds with a lazy cell_id_&lt;grid_name&gt;(epoch, sid) variable. Source code in packages/canvod-grids/src/canvod/grids/operations.py 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291def add_cell_ids_to_ds_fast( ds: xr.Dataset, grid: GridData, grid_name: str, data_var: str = &quot;VOD&quot; ) -&gt; xr.Dataset: &quot;&quot;&quot;Assign grid cells lazily via dask (avoids loading full arrays). The output ``cell_id_&lt;grid_name&gt;`` variable is a dask array that computes on access or save. Parameters ---------- ds : xr.Dataset Dataset with dask-backed ``phi`` and ``theta`` arrays. grid : GridData Hemisphere grid instance. grid_name : str Grid identifier for the output coordinate name. data_var : str Name of the main data variable (used only for shape reference). Returns ------- xr.Dataset *ds* with a lazy ``cell_id_&lt;grid_name&gt;(epoch, sid)`` variable. &quot;&quot;&quot; import dask.array as da print(f&quot;\nAssigning cells for &#39;{grid_name}&#39;...&quot;) tree = _build_kdtree(grid) cell_id_col = grid.grid[&quot;cell_id&quot;].to_numpy() def _assign_chunk( phi_chunk: np.ndarray, theta_chunk: np.ndarray, ) -&gt; np.ndarray: &quot;&quot;&quot;Assign cell IDs for a chunk of data. Parameters ---------- phi_chunk : np.ndarray Chunk of azimuth values. theta_chunk : np.ndarray Chunk of elevation values. Returns ------- np.ndarray Chunk of cell IDs. &quot;&quot;&quot; phi_flat = phi_chunk.ravel() theta_flat = theta_chunk.ravel() valid = np.isfinite(phi_flat) &amp; np.isfinite(theta_flat) cell_ids = np.full(len(phi_flat), np.nan, dtype=np.float32) if np.any(valid): cell_ids[valid] = _query_points( tree, cell_id_col, phi_flat[valid], theta_flat[valid] ) return cell_ids.reshape(phi_chunk.shape) cell_ids_dask = da.map_blocks( _assign_chunk, ds[&quot;phi&quot;].data, ds[&quot;theta&quot;].data, dtype=np.float32, drop_axis=[], ) coord_name = f&quot;cell_id_{grid_name}&quot; ds[coord_name] = ((&quot;epoch&quot;, &quot;sid&quot;), cell_ids_dask) print(&quot; â Cell IDs assigned as lazy dask array&quot;) print(&quot; â Will compute on access/save&quot;) return ds extract_grid_vertices(grid) &para; Extract 3D vertices from hemisphere grid cells. Dispatches to a grid-typeâspecific extractor. The returned arrays are flat (not per-cell); use them directly for 3-D scatter plots. Parameters&para; grid : GridData Hemisphere grid instance. Returns&para; x_vertices, y_vertices, z_vertices : np.ndarray Cartesian vertex coordinates on the unit sphere. Source code in packages/canvod-grids/src/canvod/grids/operations.py 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328def extract_grid_vertices(grid: GridData) -&gt; tuple[np.ndarray, np.ndarray, np.ndarray]: &quot;&quot;&quot;Extract 3D vertices from hemisphere grid cells. Dispatches to a grid-typeâspecific extractor. The returned arrays are flat (not per-cell); use them directly for 3-D scatter plots. Parameters ---------- grid : GridData Hemisphere grid instance. Returns ------- x_vertices, y_vertices, z_vertices : np.ndarray Cartesian vertex coordinates on the unit sphere. &quot;&quot;&quot; extractors = { &quot;htm&quot;: _extract_htm_vertices, &quot;geodesic&quot;: _extract_geodesic_vertices, &quot;equal_area&quot;: _extract_rectangular_vertices, &quot;equal_angle&quot;: _extract_rectangular_vertices, &quot;equirectangular&quot;: _extract_rectangular_vertices, &quot;healpix&quot;: _extract_healpix_vertices, &quot;fibonacci&quot;: _extract_fibonacci_vertices, } extractor = extractors.get(grid.grid_type) if extractor is None: raise ValueError(f&quot;Unknown grid type: {grid.grid_type}&quot;) return extractor(grid) grid_to_dataset(grid) &para; Convert a HemiGrid to a unified xarray Dataset with vertices. The returned Dataset carries cell centres, NaN-padded vertex arrays, vertex counts, and solid angles â all indexed by cell_id. Parameters&para; grid : GridData Hemisphere grid instance. Returns&para; xr.Dataset Dataset with dimensions (cell_id, vertex) and variables cell_phi, cell_theta, vertices_phi, vertices_theta, n_vertices, solid_angle. Notes&para; This function is distinct from :meth:HemiGridStorageAdapter._prepare_vertices_dataframe in canvod-store. That method produces a long-form DataFrame for zarr ragged-array storage; this one produces a rectangular xarray Dataset suitable for analysis and visualisation. Source code in packages/canvod-grids/src/canvod/grids/operations.py 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510 511 512 513 514 515 516 517 518 519 520 521 522 523 524 525 526 527 528 529 530 531 532 533 534 535 536 537 538 539 540 541 542 543 544 545 546 547 548 549 550 551 552 553 554 555 556 557 558 559 560 561 562 563 564 565 566 567 568 569 570 571 572 573 574 575 576 577 578def grid_to_dataset(grid: GridData) -&gt; xr.Dataset: &quot;&quot;&quot;Convert a HemiGrid to a unified xarray Dataset with vertices. The returned Dataset carries cell centres, NaN-padded vertex arrays, vertex counts, and solid angles â all indexed by ``cell_id``. Parameters ---------- grid : GridData Hemisphere grid instance. Returns ------- xr.Dataset Dataset with dimensions ``(cell_id, vertex)`` and variables ``cell_phi``, ``cell_theta``, ``vertices_phi``, ``vertices_theta``, ``n_vertices``, ``solid_angle``. Notes ----- This function is distinct from :meth:`HemiGridStorageAdapter._prepare_vertices_dataframe` in ``canvod-store``. That method produces a long-form DataFrame for zarr ragged-array storage; this one produces a rectangular xarray Dataset suitable for analysis and visualisation. &quot;&quot;&quot; # Reuse the commented-out logic pattern from gnssvodpy vertices.py: # extract per-cell vertices into (n_cells, max_vertices) arrays. n_cells = grid.ncells grid_type = grid.grid_type if grid_type in (&quot;equal_area&quot;, &quot;equal_angle&quot;, &quot;equirectangular&quot;): max_v = 4 vertices_phi = np.full((n_cells, max_v), np.nan) vertices_theta = np.full((n_cells, max_v), np.nan) n_vertices = np.full(n_cells, 4, dtype=np.int32) for i, row in enumerate(grid.grid.iter_rows(named=True)): phi_min, phi_max = row[&quot;phi_min&quot;], row[&quot;phi_max&quot;] theta_min, theta_max = row[&quot;theta_min&quot;], row[&quot;theta_max&quot;] vertices_phi[i, :] = [phi_min, phi_max, phi_max, phi_min] vertices_theta[i, :] = [theta_min, theta_min, theta_max, theta_max] elif grid_type == &quot;htm&quot;: max_v = 4 # padded to 4 for rectangular layout; only 3 used vertices_phi = np.full((n_cells, max_v), np.nan) vertices_theta = np.full((n_cells, max_v), np.nan) n_vertices = np.full(n_cells, 3, dtype=np.int32) for i, row in enumerate(grid.grid.iter_rows(named=True)): for j, col in enumerate([&quot;htm_vertex_0&quot;, &quot;htm_vertex_1&quot;, &quot;htm_vertex_2&quot;]): v = np.array(row[col], dtype=float) r = np.linalg.norm(v) if r == 0: continue x, y, z = v / r vertices_theta[i, j] = np.arccos(np.clip(z, -1, 1)) vertices_phi[i, j] = np.mod(np.arctan2(y, x), 2 * np.pi) elif grid_type == &quot;geodesic&quot;: max_v = 3 vertices_phi = np.full((n_cells, max_v), np.nan) vertices_theta = np.full((n_cells, max_v), np.nan) n_vertices = np.full(n_cells, 3, dtype=np.int32) shared = grid.vertices # shared vertex array from GridData if shared is not None and &quot;geodesic_vertices&quot; in grid.grid.columns: shared = np.asarray(shared, dtype=float) for i, row in enumerate(grid.grid.iter_rows(named=True)): indices = row[&quot;geodesic_vertices&quot;] for j, v_idx in enumerate(indices): v = shared[int(v_idx)] r = np.linalg.norm(v) if r == 0: continue x, y, z = v / r vertices_theta[i, j] = np.arccos(np.clip(z, -1, 1)) vertices_phi[i, j] = np.mod(np.arctan2(y, x), 2 * np.pi) else: # Fallback: use cell centres as single-point &quot;vertices&quot; n_vertices[:] = 1 vertices_phi[:, 0] = grid.grid[&quot;phi&quot;].to_numpy() vertices_theta[:, 0] = grid.grid[&quot;theta&quot;].to_numpy() elif grid_type == &quot;healpix&quot;: max_v = 4 vertices_phi = np.full((n_cells, max_v), np.nan) vertices_theta = np.full((n_cells, max_v), np.nan) n_vertices = np.full(n_cells, 4, dtype=np.int32) for i, row in enumerate(grid.grid.iter_rows(named=True)): phi_min, phi_max = row[&quot;phi_min&quot;], row[&quot;phi_max&quot;] theta_min, theta_max = row[&quot;theta_min&quot;], row[&quot;theta_max&quot;] vertices_phi[i, :] = [phi_min, phi_max, phi_max, phi_min] vertices_theta[i, :] = [theta_min, theta_min, theta_max, theta_max] elif grid_type == &quot;fibonacci&quot;: # Point-based: single vertex per cell (the centre) max_v = 1 vertices_phi = grid.grid[&quot;phi&quot;].to_numpy().reshape(n_cells, 1) vertices_theta = grid.grid[&quot;theta&quot;].to_numpy().reshape(n_cells, 1) n_vertices = np.ones(n_cells, dtype=np.int32) else: raise ValueError(f&quot;Unknown grid type: {grid_type}&quot;) # Cell centres cell_phi = grid.grid[&quot;phi&quot;].to_numpy() cell_theta = grid.grid[&quot;theta&quot;].to_numpy() solid_angles = grid.get_solid_angles() ds = xr.Dataset( { &quot;cell_phi&quot;: ([&quot;cell_id&quot;], cell_phi), &quot;cell_theta&quot;: ([&quot;cell_id&quot;], cell_theta), &quot;vertices_phi&quot;: ([&quot;cell_id&quot;, &quot;vertex&quot;], vertices_phi), &quot;vertices_theta&quot;: ([&quot;cell_id&quot;, &quot;vertex&quot;], vertices_theta), &quot;n_vertices&quot;: ([&quot;cell_id&quot;], n_vertices), &quot;solid_angle&quot;: ([&quot;cell_id&quot;], solid_angles), }, coords={ &quot;cell_id&quot;: np.arange(n_cells), &quot;vertex&quot;: np.arange(max_v), }, attrs={ &quot;grid_type&quot;: grid.grid_type, &quot;angular_resolution&quot;: ( grid.metadata.get(&quot;angular_resolution&quot;, 0.0) if grid.metadata else 0.0 ), &quot;cutoff_theta&quot;: ( grid.metadata.get(&quot;cutoff_theta&quot;, 0.0) if grid.metadata else 0.0 ), &quot;n_cells&quot;: n_cells, }, ) return ds store_grid(grid, store, grid_name) &para; Store grid in unified xarray format to Icechunk store. Converts the grid to an xarray Dataset with vertex information and writes it to the grids/ group in the store. Parameters&para; grid : GridData Hemisphere grid instance to store. store Icechunk store instance (e.g., MyIcechunkStore). grid_name : str Grid identifier for storage path (e.g., 'equal_area_4deg'). Returns&para; str Snapshot ID from the commit. Examples&para; from canvod.grids import create_hemigrid, store_grid grid = create_hemigrid(angular_resolution=4, grid_type='equal_area') snapshot_id = store_grid(grid, my_store, 'equal_area_4deg') Source code in packages/canvod-grids/src/canvod/grids/operations.py 586 587 588 589 590 591 592 593 594 595 596 597 598 599 600 601 602 603 604 605 606 607 608 609 610 611 612 613 614 615 616 617 618 619 620 621 622 623 624 625 626 627 628 629 630 631 632 633 634 635def store_grid( grid: GridData, store: Any, grid_name: str, ) -&gt; str: &quot;&quot;&quot;Store grid in unified xarray format to Icechunk store. Converts the grid to an xarray Dataset with vertex information and writes it to the ``grids/`` group in the store. Parameters ---------- grid : GridData Hemisphere grid instance to store. store Icechunk store instance (e.g., MyIcechunkStore). grid_name : str Grid identifier for storage path (e.g., &#39;equal_area_4deg&#39;). Returns ------- str Snapshot ID from the commit. Examples -------- &gt;&gt;&gt; from canvod.grids import create_hemigrid, store_grid &gt;&gt;&gt; grid = create_hemigrid(angular_resolution=4, grid_type=&#39;equal_area&#39;) &gt;&gt;&gt; snapshot_id = store_grid(grid, my_store, &#39;equal_area_4deg&#39;) &quot;&quot;&quot; print(f&quot;\nStoring grid &#39;{grid_name}&#39;...&quot;) # Convert to unified xarray format ds_grid = grid_to_dataset(grid) # Store in grids/ directory group_path = f&quot;grids/{grid_name}&quot; with store.writable_session() as session: from icechunk.xarray import to_icechunk to_icechunk(ds_grid, session, group=group_path, mode=&quot;w&quot;) snapshot_id = session.commit(f&quot;Stored {grid_name} grid structure&quot;) print(f&quot; â Stored to &#39;{group_path}&#39;&quot;) print(f&quot; â Snapshot: {snapshot_id[:8]}...&quot;) print(f&quot; â Cells: {grid.ncells}, Type: {grid.grid_type}&quot;) return snapshot_id load_grid(store, grid_name) &para; Load a grid from Icechunk store. Loads the grid structure from grids/{grid_name} and reconstructs a GridData object. Parameters&para; store Icechunk store instance (e.g., MyIcechunkStore). grid_name : str Grid identifier (e.g., 'equal_area_4deg'). Returns&para; GridData Reconstructed grid instance. Examples&para; from canvod.grids import load_grid grid = load_grid(my_store, 'equal_area_4deg') print(f"Loaded {grid.ncells} cells") Source code in packages/canvod-grids/src/canvod/grids/operations.py 638 639 640 641 642 643 644 645 646 647 648 649 650 651 652 653 654 655 656 657 658 659 660 661 662 663 664 665 666 667 668 669 670 671 672 673 674 675 676 677 678 679 680 681 682 683 684 685 686 687 688 689 690 691 692 693 694 695 696 697 698 699 700 701 702 703 704 705 706 707 708 709 710 711 712 713 714 715 716 717 718 719 720 721 722 723 724 725 726 727 728 729 730 731 732 733 734 735 736 737 738 739 740 741 742 743 744 745 746 747 748 749 750 751 752 753 754 755 756 757 758 759 760 761 762 763 764 765 766 767 768 769 770 771 772 773 774 775 776 777 778 779 780 781 782 783 784def load_grid( store: Any, grid_name: str, ) -&gt; GridData: &quot;&quot;&quot;Load a grid from Icechunk store. Loads the grid structure from ``grids/{grid_name}`` and reconstructs a GridData object. Parameters ---------- store Icechunk store instance (e.g., MyIcechunkStore). grid_name : str Grid identifier (e.g., &#39;equal_area_4deg&#39;). Returns ------- GridData Reconstructed grid instance. Examples -------- &gt;&gt;&gt; from canvod.grids import load_grid &gt;&gt;&gt; grid = load_grid(my_store, &#39;equal_area_4deg&#39;) &gt;&gt;&gt; print(f&quot;Loaded {grid.ncells} cells&quot;) &quot;&quot;&quot; import polars as pl print(f&quot;\nLoading grid &#39;{grid_name}&#39;...&quot;) group_path = f&quot;grids/{grid_name}&quot; # Load from store with store.readonly_session() as session: ds_grid = xr.open_zarr(session.store, group=group_path, consolidated=False) # Extract metadata grid_type = ds_grid.attrs.get(&quot;grid_type&quot;) angular_resolution = ds_grid.attrs.get(&quot;angular_resolution&quot;, 0.0) cutoff_theta = ds_grid.attrs.get(&quot;cutoff_theta&quot;, np.pi / 2) if not grid_type: raise ValueError(f&quot;Grid &#39;{grid_name}&#39; missing grid_type attribute&quot;) # Reconstruct grid DataFrame from cell centers cell_phi = ds_grid[&quot;cell_phi&quot;].values cell_theta = ds_grid[&quot;cell_theta&quot;].values n_cells = len(cell_phi) # Build basic grid DataFrame grid_data = { &quot;cell_id&quot;: np.arange(n_cells), &quot;phi&quot;: cell_phi, &quot;theta&quot;: cell_theta, } # Add grid-type-specific columns if grid_type in (&quot;equal_area&quot;, &quot;equal_angle&quot;, &quot;equirectangular&quot;): # Reconstruct boundaries from vertices vertices_phi = ds_grid[&quot;vertices_phi&quot;].values vertices_theta = ds_grid[&quot;vertices_theta&quot;].values phi_min = vertices_phi[:, 0] # All 4 vertices are corners phi_max = vertices_phi[:, 1] theta_min = vertices_theta[:, 0] theta_max = vertices_theta[:, 2] grid_data.update( { &quot;phi_min&quot;: phi_min, &quot;phi_max&quot;: phi_max, &quot;theta_min&quot;: theta_min, &quot;theta_max&quot;: theta_max, } ) elif grid_type == &quot;htm&quot;: # Reconstruct HTM vertices from spherical to Cartesian vertices_phi = ds_grid[&quot;vertices_phi&quot;].values vertices_theta = ds_grid[&quot;vertices_theta&quot;].values htm_v0 = [] htm_v1 = [] htm_v2 = [] for i in range(n_cells): vertices = [] for j in range(3): phi_v = vertices_phi[i, j] theta_v = vertices_theta[i, j] x = np.sin(theta_v) * np.cos(phi_v) y = np.sin(theta_v) * np.sin(phi_v) z = np.cos(theta_v) vertices.append([x, y, z]) htm_v0.append(vertices[0]) htm_v1.append(vertices[1]) htm_v2.append(vertices[2]) grid_data.update( { &quot;htm_vertex_0&quot;: htm_v0, &quot;htm_vertex_1&quot;: htm_v1, &quot;htm_vertex_2&quot;: htm_v2, } ) # Create Polars DataFrame df_grid = pl.DataFrame(grid_data) # Reconstruct theta_lims, phi_lims, and cell_ids from grid # These are required for GridData but not critical for basic usage unique_theta = sorted(df_grid[&quot;theta&quot;].unique().to_list()) theta_lims = np.array(unique_theta) # Group cells by theta bin phi_lims_list = [] cell_ids_list = [] for theta_val in unique_theta: theta_cells = df_grid.filter(pl.col(&quot;theta&quot;) == theta_val) phi_vals = sorted(theta_cells[&quot;phi&quot;].to_list()) cell_ids = theta_cells[&quot;cell_id&quot;].to_list() phi_lims_list.append(np.array(phi_vals)) cell_ids_list.append(np.array(cell_ids)) # Create GridData instance from canvod.grids.core import GridData grid = GridData( grid=df_grid, theta_lims=theta_lims, phi_lims=phi_lims_list, cell_ids=cell_ids_list, grid_type=grid_type, metadata={ &quot;angular_resolution&quot;: angular_resolution, &quot;cutoff_theta&quot;: cutoff_theta, }, ) print(f&quot; â Loaded from &#39;{group_path}&#39;&quot;) print(f&quot; â Cells: {grid.ncells}, Type: {grid.grid_type}&quot;) return grid (resolution) means
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder--mathematical-construction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mathematical construction
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder.get_grid_type" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_grid_type
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_grid_type">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder.get_grid_type--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder.get_healpix_info" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_healpix_info
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_healpix_info">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder.get_healpix_info--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geodesic-grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        Geodesic Grid
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.geodesic_grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        geodesic_grid
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        GeodesicBuilder
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GeodesicBuilder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder--coordinate-convention-physics-gnss" class="md-nav__link">
    <span class="md-ellipsis">
      
        Coordinate convention (physics / GNSS)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder--what-angular_resolution-means" class="md-nav__link">
    <span class="md-ellipsis">
      
        What Equal-area grid implementation. EqualAreaBuilder &para; Bases: BaseGridBuilder Equal solid angle tessellation using concentric theta bands. The hemisphere is divided into annular bands of constant width in theta. Within each band the number of azimuthal (phi) sectors is chosen so that every cell subtends approximately the same solid angle. This is the only grid type that has been validated for scientific use in this codebase. Coordinate convention (physics / GNSS)&para; phi â [0, 2Ï) â azimuthal angle measured from East, counter-clockwise theta â [0, Ï/2] â polar angle measured from zenith (0 = straight up, Ï/2 = horizon) What angular_resolution means&para; angular_resolution (degrees) sets the width of each theta band. All bands have this same width ÎÎ¸. The azimuthal width of cells varies by band: near the zenith cells are wide in phi; near the horizon they are narrow, so that the solid angle stays constant. Mathematical construction&para; Target solid angle per cell is chosen equal to the solid angle of a cap of half-angle ÎÎ¸/2:: Î©_target = 2Ï (1 â cos(ÎÎ¸/2)) Zenith cap â a single cell covers [0, ÎÎ¸/2] in theta and the full azimuth [0, 2Ï). Theta bands â edges are placed at ÎÎ¸/2, 3ÎÎ¸/2, 5ÎÎ¸/2, â¦ up to Ï/2 â cutoff_theta. For each band [Î¸_inner, Î¸_outer] the band's total solid angle is:: Î©_band = 2Ï (cos Î¸_inner â cos Î¸_outer) Phi divisions â the number of sectors in the band is:: n_phi = round(Î©_band / Î©_target) Each sector spans ÎÏ = 2Ï / n_phi. The cell centre is placed at the geometric midpoint of its (phi, theta) rectangle. Parameters&para; angular_resolution : float Theta-band width in degrees. Controls both the radial resolution and (indirectly, via the equal-area constraint) the azimuthal resolution. cutoff_theta : float Minimum elevation above the horizon in degrees. Bands whose outer edge is at or below this cutoff are omitted. In GNSS terms this is the satellite elevation mask angle. phi_rotation : float Rigid rotation applied to all phi coordinates after grid construction, in degrees. Source code in packages/canvod-grids/src/canvod/grids/grids_impl/equal_area_grid.py 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182class EqualAreaBuilder(BaseGridBuilder): &quot;&quot;&quot;Equal solid angle tessellation using concentric theta bands. The hemisphere is divided into annular bands of constant width in theta. Within each band the number of azimuthal (phi) sectors is chosen so that every cell subtends approximately the same solid angle. This is the only grid type that has been validated for scientific use in this codebase. Coordinate convention (physics / GNSS) --------------------------------------- * phi â [0, 2Ï) â azimuthal angle measured from East, counter-clockwise * theta â [0, Ï/2] â polar angle measured from zenith (0 = straight up, Ï/2 = horizon) What ``angular_resolution`` means ---------------------------------- ``angular_resolution`` (degrees) sets the **width of each theta band**. All bands have this same width ÎÎ¸. The *azimuthal* width of cells varies by band: near the zenith cells are wide in phi; near the horizon they are narrow, so that the solid angle stays constant. Mathematical construction ------------------------- 1. **Target solid angle** per cell is chosen equal to the solid angle of a cap of half-angle ÎÎ¸/2:: Î©_target = 2Ï (1 â cos(ÎÎ¸/2)) 2. **Zenith cap** â a single cell covers [0, ÎÎ¸/2] in theta and the full azimuth [0, 2Ï). 3. **Theta bands** â edges are placed at ÎÎ¸/2, 3ÎÎ¸/2, 5ÎÎ¸/2, â¦ up to Ï/2 â cutoff_theta. For each band [Î¸_inner, Î¸_outer] the band&#39;s total solid angle is:: Î©_band = 2Ï (cos Î¸_inner â cos Î¸_outer) 4. **Phi divisions** â the number of sectors in the band is:: n_phi = round(Î©_band / Î©_target) Each sector spans ÎÏ = 2Ï / n_phi. The cell centre is placed at the geometric midpoint of its (phi, theta) rectangle. Parameters ---------- angular_resolution : float Theta-band width in degrees. Controls both the radial resolution and (indirectly, via the equal-area constraint) the azimuthal resolution. cutoff_theta : float Minimum elevation above the horizon in degrees. Bands whose outer edge is at or below this cutoff are omitted. In GNSS terms this is the satellite elevation mask angle. phi_rotation : float Rigid rotation applied to all phi coordinates after grid construction, in degrees. &quot;&quot;&quot; def get_grid_type(self) -&gt; str: &quot;&quot;&quot;Return the grid-type identifier string. Returns ------- str ``&quot;equal_area&quot;`` &quot;&quot;&quot; return GridType.EQUAL_AREA.value def _build_grid( self, ) -&gt; tuple[pl.DataFrame, np.ndarray, list[np.ndarray], list[np.ndarray]]: &quot;&quot;&quot;Construct the equal-area hemisphere grid. Returns ------- grid : pl.DataFrame One row per cell with columns: phi, theta, phi_min, phi_max, theta_min, theta_max, cell_id. theta_lims : np.ndarray Outer theta edge of each band (radians). phi_lims : list[np.ndarray] Array of phi_min values for each band. cell_ids : list[np.ndarray] Cell-id arrays, one per band. &quot;&quot;&quot; # Theta band edges (from zenith to horizon) max_theta = np.pi / 2 # horizon theta_edges = np.arange( self.angular_resolution_rad / 2, max_theta - self.cutoff_theta_rad, self.angular_resolution_rad, ) # Target solid angle per cell target_omega = 2 * np.pi * (1 - np.cos(self.angular_resolution_rad / 2)) cells = [] theta_lims = [] phi_lims = [] cell_ids = [] # Zenith cell (special case) - only if cutoff allows next_cell_id = 0 zenith_theta_max = self.angular_resolution_rad / 2 if self.cutoff_theta_rad &lt; zenith_theta_max: cells.append( pl.DataFrame( { &quot;phi&quot;: [0.0], &quot;theta&quot;: [0.0], &quot;phi_min&quot;: [0.0], &quot;phi_max&quot;: [2 * np.pi], &quot;theta_min&quot;: [max(0.0, self.cutoff_theta_rad)], &quot;theta_max&quot;: [zenith_theta_max], } ) ) theta_lims.append(zenith_theta_max) phi_lims.append(np.array([0.0])) cell_ids.append(np.array([0])) next_cell_id = 1 # Build theta bands for iband, theta_outer in enumerate(theta_edges[1:]): theta_inner = theta_edges[iband] # Skip bands below cutoff if theta_outer &lt;= self.cutoff_theta_rad: continue # Solid angle of this band band_omega = 2 * np.pi * (np.cos(theta_inner) - np.cos(theta_outer)) # Number of phi divisions n_phi = max(1, round(band_omega / target_omega)) phi_span = 2 * np.pi / n_phi cell_id_list = list(range(next_cell_id, next_cell_id + n_phi)) next_cell_id = cell_id_list[-1] + 1 # Use arange for better precision than linspace phi_min_arr = np.arange(n_phi) * phi_span phi_max_arr = (np.arange(n_phi) + 1) * phi_span phi_max_arr[-1] = 2 * np.pi # Force exact closure cells.append( pl.DataFrame( { &quot;phi&quot;: (phi_min_arr + phi_max_arr) / 2, &quot;theta&quot;: np.full(n_phi, (theta_inner + theta_outer) / 2), &quot;phi_min&quot;: phi_min_arr, &quot;phi_max&quot;: phi_max_arr, &quot;theta_min&quot;: np.full(n_phi, theta_inner), &quot;theta_max&quot;: np.full(n_phi, theta_outer), } ) ) theta_lims.append(theta_outer) phi_lims.append(phi_min_arr) cell_ids.append(np.array(cell_id_list)) if len(cells) == 0: raise ValueError( &quot;No cells generated - check cutoff_theta and angular_resolution&quot; ) grid = pl.concat(cells).with_columns(pl.int_range(0, pl.len()).alias(&quot;cell_id&quot;)) return grid, np.array(theta_lims), phi_lims, cell_ids get_grid_type() &para; Return the grid-type identifier string. Returns&para; str "equal_area" Source code in packages/canvod-grids/src/canvod/grids/grids_impl/equal_area_grid.py 68 69 70 71 72 73 74 75 76 77def get_grid_type(self) -&gt; str: &quot;&quot;&quot;Return the grid-type identifier string. Returns ------- str ``&quot;equal_area&quot;`` &quot;&quot;&quot; return GridType.EQUAL_AREA.value means
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder--mathematical-construction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mathematical construction
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder--notes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder.get_triangles" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_triangles
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_triangles">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder.get_triangles--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder.get_grid_type" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_grid_type
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_grid_type">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder.get_grid_type--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fibonacci-grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fibonacci Grid
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.fibonacci_grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        fibonacci_grid
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        FibonacciBuilder
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FibonacciBuilder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder--coordinate-convention-physics-gnss" class="md-nav__link">
    <span class="md-ellipsis">
      
        Coordinate convention (physics / GNSS)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder--what-n_points-resolution-means" class="md-nav__link">
    <span class="md-ellipsis">
      
        What Equal-angle grid implementation. EqualAngleBuilder &para; Bases: BaseGridBuilder Equal angular spacing in both theta and phi (NOT equal area). Every cell is a rectangle of the same angular size ÎÎ¸ Ã ÎÏ in the (theta, phi) parameter space. Because solid angle depends on cos(theta), cells near the zenith subtend more solid angle than cells near the horizon. This makes the grid biased toward the zenith for any solid-angle-weighted statistic. Not recommended for scientific analysis â use EqualAreaBuilder instead. Coordinate convention (physics / GNSS)&para; phi â [0, 2Ï) â azimuthal angle from East, counter-clockwise theta â [0, Ï/2] â polar angle from zenith What angular_resolution means&para; angular_resolution (degrees) is used as both the theta-band width and the phi-sector width. The number of phi divisions is constant across all bands:: n_phi = round(2Ï / ÎÎ¸) and does not change with latitude. Mathematical construction&para; A zenith cap cell covers [0, ÎÎ¸/2] Ã [0, 2Ï). Theta band edges are placed at ÎÎ¸/2, 3ÎÎ¸/2, â¦ up to Ï/2. Within every band, the full azimuth is split into n_phi sectors of equal width ÎÏ = 2Ï / n_phi. Cell centres are at the midpoint of each (phi, theta) rectangle. Parameters&para; angular_resolution : float Angular spacing in degrees, applied identically in both theta and phi. cutoff_theta : float Elevation mask angle in degrees (bands below this are omitted). phi_rotation : float Rigid azimuthal rotation applied after construction, in degrees. Source code in packages/canvod-grids/src/canvod/grids/grids_impl/equal_angle_grid.py 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144class EqualAngleBuilder(BaseGridBuilder): &quot;&quot;&quot;Equal angular spacing in both theta and phi (NOT equal area). Every cell is a rectangle of the same angular size ÎÎ¸ Ã ÎÏ in the (theta, phi) parameter space. Because solid angle depends on cos(theta), cells near the zenith subtend *more* solid angle than cells near the horizon. This makes the grid biased toward the zenith for any solid-angle-weighted statistic. **Not recommended for scientific analysis** â use ``EqualAreaBuilder`` instead. Coordinate convention (physics / GNSS) --------------------------------------- * phi â [0, 2Ï) â azimuthal angle from East, counter-clockwise * theta â [0, Ï/2] â polar angle from zenith What ``angular_resolution`` means ---------------------------------- ``angular_resolution`` (degrees) is used as **both** the theta-band width and the phi-sector width. The number of phi divisions is constant across all bands:: n_phi = round(2Ï / ÎÎ¸) and does not change with latitude. Mathematical construction ------------------------- 1. A zenith cap cell covers [0, ÎÎ¸/2] Ã [0, 2Ï). 2. Theta band edges are placed at ÎÎ¸/2, 3ÎÎ¸/2, â¦ up to Ï/2. 3. Within every band, the full azimuth is split into ``n_phi`` sectors of equal width ÎÏ = 2Ï / n_phi. 4. Cell centres are at the midpoint of each (phi, theta) rectangle. Parameters ---------- angular_resolution : float Angular spacing in degrees, applied identically in both theta and phi. cutoff_theta : float Elevation mask angle in degrees (bands below this are omitted). phi_rotation : float Rigid azimuthal rotation applied after construction, in degrees. &quot;&quot;&quot; def get_grid_type(self) -&gt; str: &quot;&quot;&quot;Return the grid-type identifier string. Returns ------- str ``&quot;equal_angle&quot;`` &quot;&quot;&quot; return GridType.EQUAL_ANGLE.value def _build_grid( self, ) -&gt; tuple[pl.DataFrame, np.ndarray, list[np.ndarray], list[np.ndarray]]: &quot;&quot;&quot;Construct the equal-angle hemisphere grid. Returns ------- grid : pl.DataFrame One row per cell. theta_lims : np.ndarray Outer theta edge of each band (radians). phi_lims : list[np.ndarray] Array of phi_min values for each band (identical across bands). cell_ids : list[np.ndarray] Cell-id arrays, one per band. &quot;&quot;&quot; max_theta = np.pi / 2 theta_edges = np.arange( self.angular_resolution_rad / 2, max_theta - self.cutoff_theta_rad, self.angular_resolution_rad, ) n_phi_divisions = int(2 * np.pi / self.angular_resolution_rad) cells = [] theta_lims = [] phi_lims = [] cell_ids = [] # Zenith cells.append( pl.DataFrame( { &quot;phi&quot;: [0.0], &quot;theta&quot;: [0.0], &quot;phi_min&quot;: [0.0], &quot;phi_max&quot;: [2 * np.pi], &quot;theta_min&quot;: [0.0], &quot;theta_max&quot;: [self.angular_resolution_rad / 2], } ) ) theta_lims.append(self.angular_resolution_rad / 2) phi_lims.append(np.array([0.0])) cell_ids.append(np.array([0])) next_cell_id = 1 for iband, theta_outer in enumerate(theta_edges[1:]): theta_inner = theta_edges[iband] phi_span = 2 * np.pi / n_phi_divisions cell_id_list = list(range(next_cell_id, next_cell_id + n_phi_divisions)) next_cell_id = cell_id_list[-1] + 1 phi_min_arr = np.linspace(0, 2 * np.pi - phi_span, n_phi_divisions) phi_max_arr = np.concatenate((phi_min_arr[1:], [2 * np.pi])) cells.append( pl.DataFrame( { &quot;phi&quot;: (phi_min_arr + phi_max_arr) / 2, &quot;theta&quot;: np.full( n_phi_divisions, (theta_inner + theta_outer) / 2, ), &quot;phi_min&quot;: phi_min_arr, &quot;phi_max&quot;: phi_max_arr, &quot;theta_min&quot;: np.full(n_phi_divisions, theta_inner), &quot;theta_max&quot;: np.full(n_phi_divisions, theta_outer), } ) ) theta_lims.append(theta_outer) phi_lims.append(phi_min_arr) cell_ids.append(np.array(cell_id_list)) grid = pl.concat(cells).with_row_index(&quot;cell_id&quot;) return grid, np.array(theta_lims), phi_lims, cell_ids get_grid_type() &para; Return the grid-type identifier string. Returns&para; str "equal_angle" Source code in packages/canvod-grids/src/canvod/grids/grids_impl/equal_angle_grid.py 53 54 55 56 57 58 59 60 61 62def get_grid_type(self) -&gt; str: &quot;&quot;&quot;Return the grid-type identifier string. Returns ------- str ``&quot;equal_angle&quot;`` &quot;&quot;&quot; return GridType.EQUAL_ANGLE.value (resolution) means
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder--mathematical-construction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mathematical construction
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder--notes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder.get_grid_type" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_grid_type
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_grid_type">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder.get_grid_type--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#htm-grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        HTM Grid
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.htm_grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        htm_grid
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.htm_grid.HTMBuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        HTMBuilder
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HTMBuilder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.htm_grid.HTMBuilder--coordinate-convention-physics-gnss" class="md-nav__link">
    <span class="md-ellipsis">
      
        Coordinate convention (physics / GNSS)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.htm_grid.HTMBuilder--what-htm_level-resolution-means" class="md-nav__link">
    <span class="md-ellipsis">
      
        What HEALPix grid implementation. HEALPixBuilder &para; Bases: BaseGridBuilder HEALPix tessellation (Hierarchical Equal Area isoLatitude Pixelization). HEALPix partitions the sphere into 12 base pixels arranged at equal latitudes. Each base pixel is recursively subdivided into 4 children, producing 12 Ã nsideÂ² pixels on the full sphere, all with exactly the same solid angle. This strict equal-area property makes HEALPix the gold standard for pixelisations that must be unbiased under solid-angle weighting. This builder delegates the pixel geometry entirely to the healpy library. It filters the full-sphere pixelisation down to the northern hemisphere and stores approximate bounding boxes (phi_min/max, theta_min/max) derived from the pixel resolution. The bounding boxes are not the true pixel boundaries (which are curvilinear); they are only approximations suitable for quick spatial queries. For exact pixel membership use healpy.ang2pix directly. Coordinate convention&para; HEALPix natively uses colatitude theta â [0, Ï] (0 = North Pole) and longitude phi â [0, 2Ï). This matches the GNSS convention used elsewhere in canvodpy: theta = 0 is the zenith, theta = Ï/2 is the horizon. No coordinate transform is applied. What nside (resolution) means&para; nside is the single resolution parameter of HEALPix. It must be a power of 2. The key derived quantities are:: n_pixels = 12 Ã nsideÂ² (full sphere) pixel_area = 4Ï / n_pixels (steradians, exact) resolution â â(pixel_area) (approximate angular diameter) â 58.6Â° / nside (degrees) nside Pixels (full) Approx resolution Pixel area (sr) 1 12 58.6Â° 1.049 2 48 29.3Â° 0.262 4 192 14.7Â° 0.065 8 768 7.3Â° 0.016 16 3 072 3.7Â° 0.004 32 12 288 1.8Â° 0.001 When nside is not provided, it is estimated from angular_resolution and rounded to the nearest power of 2:: nside_estimate = round_to_pow2( â(3/Ï) Ã 60 / angular_resolution ) Mathematical construction&para; HEALPix construction is performed entirely by healpy. At a high level: The sphere is divided into 12 congruent base pixels (a curvilinear quadrilateral arrangement at three latitude zones: polar caps and equatorial belt). Each base pixel is subdivided into nsideÂ² equal-area children using a hierarchical quadtree. Pixel centres are returned by healpy.pix2ang(nside, ipix) in RING ordering (pixels ordered by increasing colatitude). This builder keeps only pixels with theta â¤ Ï/2 â cutoff_theta (northern hemisphere above the elevation mask). Parameters&para; angular_resolution : float Approximate angular resolution in degrees. Used only to derive nside when that parameter is not given explicitly. cutoff_theta : float Elevation mask angle in degrees. Pixels with colatitude theta &gt; Ï/2 â cutoff_theta (i.e. below the mask) are excluded. nside : int or None HEALPix resolution parameter. Must be a power of 2. If None, estimated from angular_resolution. phi_rotation : float Rigid azimuthal rotation applied after construction, in degrees. Raises&para; ImportError If healpy is not installed. ValueError If nside is not a power of 2. Source code in packages/canvod-grids/src/canvod/grids/grids_impl/healpix_grid.py 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256class HEALPixBuilder(BaseGridBuilder): &quot;&quot;&quot;HEALPix tessellation (Hierarchical Equal Area isoLatitude Pixelization). HEALPix partitions the sphere into 12 base pixels arranged at equal latitudes. Each base pixel is recursively subdivided into 4 children, producing ``12 Ã nsideÂ²`` pixels on the full sphere, all with *exactly* the same solid angle. This strict equal-area property makes HEALPix the gold standard for pixelisations that must be unbiased under solid-angle weighting. This builder delegates the pixel geometry entirely to the ``healpy`` library. It filters the full-sphere pixelisation down to the northern hemisphere and stores approximate bounding boxes (``phi_min/max``, ``theta_min/max``) derived from the pixel resolution. The bounding boxes are **not** the true pixel boundaries (which are curvilinear); they are only approximations suitable for quick spatial queries. For exact pixel membership use ``healpy.ang2pix`` directly. Coordinate convention --------------------- HEALPix natively uses colatitude ``theta â [0, Ï]`` (0 = North Pole) and longitude ``phi â [0, 2Ï)``. This matches the GNSS convention used elsewhere in canvodpy: theta = 0 is the zenith, theta = Ï/2 is the horizon. **No coordinate transform is applied.** What ``nside`` (resolution) means ---------------------------------- ``nside`` is the single resolution parameter of HEALPix. It must be a power of 2. The key derived quantities are:: n_pixels = 12 Ã nsideÂ² (full sphere) pixel_area = 4Ï / n_pixels (steradians, exact) resolution â â(pixel_area) (approximate angular diameter) â 58.6Â° / nside (degrees) | nside | Pixels (full) | Approx resolution | Pixel area (sr) | |-------|---------------|-------------------|-----------------| | 1 | 12 | 58.6Â° | 1.049 | | 2 | 48 | 29.3Â° | 0.262 | | 4 | 192 | 14.7Â° | 0.065 | | 8 | 768 | 7.3Â° | 0.016 | | 16 | 3 072 | 3.7Â° | 0.004 | | 32 | 12 288 | 1.8Â° | 0.001 | When ``nside`` is not provided, it is estimated from ``angular_resolution`` and rounded to the nearest power of 2:: nside_estimate = round_to_pow2( â(3/Ï) Ã 60 / angular_resolution ) Mathematical construction ------------------------- HEALPix construction is performed entirely by ``healpy``. At a high level: 1. The sphere is divided into 12 congruent base pixels (a curvilinear quadrilateral arrangement at three latitude zones: polar caps and equatorial belt). 2. Each base pixel is subdivided into ``nsideÂ²`` equal-area children using a hierarchical quadtree. 3. Pixel centres are returned by ``healpy.pix2ang(nside, ipix)`` in RING ordering (pixels ordered by increasing colatitude). 4. This builder keeps only pixels with ``theta â¤ Ï/2 â cutoff_theta`` (northern hemisphere above the elevation mask). Parameters ---------- angular_resolution : float Approximate angular resolution in degrees. Used only to derive ``nside`` when that parameter is not given explicitly. cutoff_theta : float Elevation mask angle in degrees. Pixels with colatitude ``theta &gt; Ï/2 â cutoff_theta`` (i.e. below the mask) are excluded. nside : int or None HEALPix resolution parameter. Must be a power of 2. If ``None``, estimated from ``angular_resolution``. phi_rotation : float Rigid azimuthal rotation applied after construction, in degrees. Raises ------ ImportError If ``healpy`` is not installed. ValueError If ``nside`` is not a power of 2. &quot;&quot;&quot; def __init__( self, angular_resolution: float = 2, cutoff_theta: float = 0, nside: int | None = None, phi_rotation: float = 0, ) -&gt; None: &quot;&quot;&quot;Initialize the HEALPix grid builder. Parameters ---------- angular_resolution : float, default 2 Angular resolution in degrees. cutoff_theta : float, default 0 Maximum polar angle cutoff in degrees. nside : int | None, optional HEALPix nside parameter. phi_rotation : float, default 0 Rotation angle in degrees. &quot;&quot;&quot; super().__init__(angular_resolution, cutoff_theta, phi_rotation) # Determine nside if nside is None: nside_estimate = int(np.sqrt(3 / np.pi) * 60 / angular_resolution) self.nside = 2 ** max(0, int(np.round(np.log2(nside_estimate)))) else: if nside &lt; 1 or (nside &amp; (nside - 1)) != 0: raise ValueError(f&quot;nside must be a power of 2, got {nside}&quot;) self.nside = nside # Import healpy try: import healpy as hp self.hp = hp except ImportError: raise ImportError( &quot;healpy is required for HEALPix grid. Install with: pip install healpy&quot; ) pixel_size_arcmin = self.hp.nside2resol(self.nside, arcmin=True) self.actual_angular_resolution = pixel_size_arcmin / 60.0 self._logger.info( f&quot;HEALPix: nside={self.nside}, &quot; f&quot;requested_res={angular_resolution:.2f}Â°, &quot; f&quot;actual_res={self.actual_angular_resolution:.2f}Â°&quot; ) def get_grid_type(self) -&gt; str: &quot;&quot;&quot;Return the grid-type identifier string. Returns ------- str ``&quot;healpix&quot;`` &quot;&quot;&quot; return GridType.HEALPIX.value def _build_grid( self, ) -&gt; tuple[pl.DataFrame, np.ndarray, list[np.ndarray], list[np.ndarray]]: &quot;&quot;&quot;Build HEALPix grid for the northern hemisphere. Iterates over all ``12 Ã nsideÂ²`` pixels, retains those with ``theta â¤ Ï/2 â cutoff_theta``, and constructs approximate bounding boxes from the pixel resolution. Returns ------- grid : pl.DataFrame One row per pixel. Contains phi, theta (centre), approximate bounding-box limits, ``healpix_ipix`` (RING-ordered pixel index), and ``healpix_nside``. theta_lims : np.ndarray Synthetic evenly-spaced theta limits (interface compatibility only). phi_lims : list[np.ndarray] Synthetic evenly-spaced phi limits (interface compatibility only). cell_ids : list[np.ndarray] Single-element list containing the valid pixel indices. &quot;&quot;&quot; npix = self.hp.nside2npix(self.nside) cells = [] valid_pixels = [] for ipix in range(npix): theta, phi = self.hp.pix2ang(self.nside, ipix) # Keep only northern hemisphere above the elevation mask if theta &gt; (np.pi / 2 - self.cutoff_theta_rad): continue pixel_radius = self.hp.nside2resol(self.nside) cells.append( { &quot;phi&quot;: float(phi), &quot;theta&quot;: float(theta), &quot;phi_min&quot;: float(max(0, phi - pixel_radius / 2)), &quot;phi_max&quot;: float(min(2 * np.pi, phi + pixel_radius / 2)), &quot;theta_min&quot;: float(max(0, theta - pixel_radius / 2)), &quot;theta_max&quot;: float(min(np.pi / 2, theta + pixel_radius / 2)), &quot;healpix_ipix&quot;: int(ipix), &quot;healpix_nside&quot;: int(self.nside), } ) valid_pixels.append(int(ipix)) if len(cells) == 0: raise ValueError(&quot;No valid HEALPix pixels found in hemisphere&quot;) grid = pl.DataFrame(cells) grid = grid.with_columns( [ pl.col(&quot;healpix_ipix&quot;).cast(pl.Int64), pl.col(&quot;healpix_nside&quot;).cast(pl.Int64), ] ) theta_unique = sorted(grid[&quot;theta&quot;].unique()) n_theta_bands = len(theta_unique) # NOTE: These limits are SYNTHETIC and do NOT correspond to actual # HEALPix pixel boundaries. They exist only for interface # compatibility with ring-based grids. For spatial queries, use the # per-pixel theta_min/max and phi_min/max columns instead. theta_lims = np.linspace(0, np.pi / 2, min(n_theta_bands, 20)) phi_lims = [np.linspace(0, 2 * np.pi, 20) for _ in range(len(theta_lims))] cell_ids_list = [np.array(valid_pixels, dtype=np.int64)] return grid, theta_lims, phi_lims, cell_ids_list def get_healpix_info(self) -&gt; dict: &quot;&quot;&quot;Get HEALPix-specific information. Returns ------- info : dict Keys: ``nside``, ``npix_total``, ``pixel_area_sr``, ``pixel_area_arcmin2``, ``resolution_arcmin``, ``resolution_deg``, ``max_pixel_radius_deg``. &quot;&quot;&quot; return { &quot;nside&quot;: self.nside, &quot;npix_total&quot;: self.hp.nside2npix(self.nside), &quot;pixel_area_sr&quot;: self.hp.nside2pixarea(self.nside), &quot;pixel_area_arcmin2&quot;: ( self.hp.nside2pixarea(self.nside, degrees=True) * 3600 ), &quot;resolution_arcmin&quot;: self.hp.nside2resol(self.nside, arcmin=True), &quot;resolution_deg&quot;: self.actual_angular_resolution, &quot;max_pixel_radius_deg&quot;: np.rad2deg(self.hp.max_pixrad(self.nside)), } __init__(angular_resolution=2, cutoff_theta=0, nside=None, phi_rotation=0) &para; Initialize the HEALPix grid builder. Parameters&para; angular_resolution : float, default 2 Angular resolution in degrees. cutoff_theta : float, default 0 Maximum polar angle cutoff in degrees. nside : int | None, optional HEALPix nside parameter. phi_rotation : float, default 0 Rotation angle in degrees. Source code in packages/canvod-grids/src/canvod/grids/grids_impl/healpix_grid.py 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145def __init__( self, angular_resolution: float = 2, cutoff_theta: float = 0, nside: int | None = None, phi_rotation: float = 0, ) -&gt; None: &quot;&quot;&quot;Initialize the HEALPix grid builder. Parameters ---------- angular_resolution : float, default 2 Angular resolution in degrees. cutoff_theta : float, default 0 Maximum polar angle cutoff in degrees. nside : int | None, optional HEALPix nside parameter. phi_rotation : float, default 0 Rotation angle in degrees. &quot;&quot;&quot; super().__init__(angular_resolution, cutoff_theta, phi_rotation) # Determine nside if nside is None: nside_estimate = int(np.sqrt(3 / np.pi) * 60 / angular_resolution) self.nside = 2 ** max(0, int(np.round(np.log2(nside_estimate)))) else: if nside &lt; 1 or (nside &amp; (nside - 1)) != 0: raise ValueError(f&quot;nside must be a power of 2, got {nside}&quot;) self.nside = nside # Import healpy try: import healpy as hp self.hp = hp except ImportError: raise ImportError( &quot;healpy is required for HEALPix grid. Install with: pip install healpy&quot; ) pixel_size_arcmin = self.hp.nside2resol(self.nside, arcmin=True) self.actual_angular_resolution = pixel_size_arcmin / 60.0 self._logger.info( f&quot;HEALPix: nside={self.nside}, &quot; f&quot;requested_res={angular_resolution:.2f}Â°, &quot; f&quot;actual_res={self.actual_angular_resolution:.2f}Â°&quot; ) get_grid_type() &para; Return the grid-type identifier string. Returns&para; str "healpix" Source code in packages/canvod-grids/src/canvod/grids/grids_impl/healpix_grid.py 147 148 149 150 151 152 153 154 155 156def get_grid_type(self) -&gt; str: &quot;&quot;&quot;Return the grid-type identifier string. Returns ------- str ``&quot;healpix&quot;`` &quot;&quot;&quot; return GridType.HEALPIX.value get_healpix_info() &para; Get HEALPix-specific information. Returns&para; info : dict Keys: nside, npix_total, pixel_area_sr, pixel_area_arcmin2, resolution_arcmin, resolution_deg, max_pixel_radius_deg. Source code in packages/canvod-grids/src/canvod/grids/grids_impl/healpix_grid.py 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256def get_healpix_info(self) -&gt; dict: &quot;&quot;&quot;Get HEALPix-specific information. Returns ------- info : dict Keys: ``nside``, ``npix_total``, ``pixel_area_sr``, ``pixel_area_arcmin2``, ``resolution_arcmin``, ``resolution_deg``, ``max_pixel_radius_deg``. &quot;&quot;&quot; return { &quot;nside&quot;: self.nside, &quot;npix_total&quot;: self.hp.nside2npix(self.nside), &quot;pixel_area_sr&quot;: self.hp.nside2pixarea(self.nside), &quot;pixel_area_arcmin2&quot;: ( self.hp.nside2pixarea(self.nside, degrees=True) * 3600 ), &quot;resolution_arcmin&quot;: self.hp.nside2resol(self.nside, arcmin=True), &quot;resolution_deg&quot;: self.actual_angular_resolution, &quot;max_pixel_radius_deg&quot;: np.rad2deg(self.hp.max_pixrad(self.nside)), } (resolution) means
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.htm_grid.HTMBuilder--mathematical-construction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mathematical construction
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.htm_grid.HTMBuilder--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.htm_grid.HTMBuilder--notes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.htm_grid.HTMBuilder--references" class="md-nav__link">
    <span class="md-ellipsis">
      
        References
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.htm_grid.HTMBuilder.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.htm_grid.HTMBuilder.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.htm_grid.HTMBuilder.get_grid_type" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_grid_type
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_grid_type">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.htm_grid.HTMBuilder.get_grid_type--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.htm_grid.HTMBuilder.get_htm_info" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_htm_info
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_htm_info">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.htm_grid.HTMBuilder.get_htm_info--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#equal-angle-grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        Equal-Angle Grid
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_angle_grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        equal_angle_grid
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_angle_grid.EqualAngleBuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        EqualAngleBuilder
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EqualAngleBuilder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_angle_grid.EqualAngleBuilder--coordinate-convention-physics-gnss" class="md-nav__link">
    <span class="md-ellipsis">
      
        Coordinate convention (physics / GNSS)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_angle_grid.EqualAngleBuilder--what-angular_resolution-means" class="md-nav__link">
    <span class="md-ellipsis">
      
        What Equal-area grid implementation. EqualAreaBuilder &para; Bases: BaseGridBuilder Equal solid angle tessellation using concentric theta bands. The hemisphere is divided into annular bands of constant width in theta. Within each band the number of azimuthal (phi) sectors is chosen so that every cell subtends approximately the same solid angle. This is the only grid type that has been validated for scientific use in this codebase. Coordinate convention (physics / GNSS)&para; phi â [0, 2Ï) â azimuthal angle measured from East, counter-clockwise theta â [0, Ï/2] â polar angle measured from zenith (0 = straight up, Ï/2 = horizon) What angular_resolution means&para; angular_resolution (degrees) sets the width of each theta band. All bands have this same width ÎÎ¸. The azimuthal width of cells varies by band: near the zenith cells are wide in phi; near the horizon they are narrow, so that the solid angle stays constant. Mathematical construction&para; Target solid angle per cell is chosen equal to the solid angle of a cap of half-angle ÎÎ¸/2:: Î©_target = 2Ï (1 â cos(ÎÎ¸/2)) Zenith cap â a single cell covers [0, ÎÎ¸/2] in theta and the full azimuth [0, 2Ï). Theta bands â edges are placed at ÎÎ¸/2, 3ÎÎ¸/2, 5ÎÎ¸/2, â¦ up to Ï/2 â cutoff_theta. For each band [Î¸_inner, Î¸_outer] the band's total solid angle is:: Î©_band = 2Ï (cos Î¸_inner â cos Î¸_outer) Phi divisions â the number of sectors in the band is:: n_phi = round(Î©_band / Î©_target) Each sector spans ÎÏ = 2Ï / n_phi. The cell centre is placed at the geometric midpoint of its (phi, theta) rectangle. Parameters&para; angular_resolution : float Theta-band width in degrees. Controls both the radial resolution and (indirectly, via the equal-area constraint) the azimuthal resolution. cutoff_theta : float Minimum elevation above the horizon in degrees. Bands whose outer edge is at or below this cutoff are omitted. In GNSS terms this is the satellite elevation mask angle. phi_rotation : float Rigid rotation applied to all phi coordinates after grid construction, in degrees. Source code in packages/canvod-grids/src/canvod/grids/grids_impl/equal_area_grid.py 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182class EqualAreaBuilder(BaseGridBuilder): &quot;&quot;&quot;Equal solid angle tessellation using concentric theta bands. The hemisphere is divided into annular bands of constant width in theta. Within each band the number of azimuthal (phi) sectors is chosen so that every cell subtends approximately the same solid angle. This is the only grid type that has been validated for scientific use in this codebase. Coordinate convention (physics / GNSS) --------------------------------------- * phi â [0, 2Ï) â azimuthal angle measured from East, counter-clockwise * theta â [0, Ï/2] â polar angle measured from zenith (0 = straight up, Ï/2 = horizon) What ``angular_resolution`` means ---------------------------------- ``angular_resolution`` (degrees) sets the **width of each theta band**. All bands have this same width ÎÎ¸. The *azimuthal* width of cells varies by band: near the zenith cells are wide in phi; near the horizon they are narrow, so that the solid angle stays constant. Mathematical construction ------------------------- 1. **Target solid angle** per cell is chosen equal to the solid angle of a cap of half-angle ÎÎ¸/2:: Î©_target = 2Ï (1 â cos(ÎÎ¸/2)) 2. **Zenith cap** â a single cell covers [0, ÎÎ¸/2] in theta and the full azimuth [0, 2Ï). 3. **Theta bands** â edges are placed at ÎÎ¸/2, 3ÎÎ¸/2, 5ÎÎ¸/2, â¦ up to Ï/2 â cutoff_theta. For each band [Î¸_inner, Î¸_outer] the band&#39;s total solid angle is:: Î©_band = 2Ï (cos Î¸_inner â cos Î¸_outer) 4. **Phi divisions** â the number of sectors in the band is:: n_phi = round(Î©_band / Î©_target) Each sector spans ÎÏ = 2Ï / n_phi. The cell centre is placed at the geometric midpoint of its (phi, theta) rectangle. Parameters ---------- angular_resolution : float Theta-band width in degrees. Controls both the radial resolution and (indirectly, via the equal-area constraint) the azimuthal resolution. cutoff_theta : float Minimum elevation above the horizon in degrees. Bands whose outer edge is at or below this cutoff are omitted. In GNSS terms this is the satellite elevation mask angle. phi_rotation : float Rigid rotation applied to all phi coordinates after grid construction, in degrees. &quot;&quot;&quot; def get_grid_type(self) -&gt; str: &quot;&quot;&quot;Return the grid-type identifier string. Returns ------- str ``&quot;equal_area&quot;`` &quot;&quot;&quot; return GridType.EQUAL_AREA.value def _build_grid( self, ) -&gt; tuple[pl.DataFrame, np.ndarray, list[np.ndarray], list[np.ndarray]]: &quot;&quot;&quot;Construct the equal-area hemisphere grid. Returns ------- grid : pl.DataFrame One row per cell with columns: phi, theta, phi_min, phi_max, theta_min, theta_max, cell_id. theta_lims : np.ndarray Outer theta edge of each band (radians). phi_lims : list[np.ndarray] Array of phi_min values for each band. cell_ids : list[np.ndarray] Cell-id arrays, one per band. &quot;&quot;&quot; # Theta band edges (from zenith to horizon) max_theta = np.pi / 2 # horizon theta_edges = np.arange( self.angular_resolution_rad / 2, max_theta - self.cutoff_theta_rad, self.angular_resolution_rad, ) # Target solid angle per cell target_omega = 2 * np.pi * (1 - np.cos(self.angular_resolution_rad / 2)) cells = [] theta_lims = [] phi_lims = [] cell_ids = [] # Zenith cell (special case) - only if cutoff allows next_cell_id = 0 zenith_theta_max = self.angular_resolution_rad / 2 if self.cutoff_theta_rad &lt; zenith_theta_max: cells.append( pl.DataFrame( { &quot;phi&quot;: [0.0], &quot;theta&quot;: [0.0], &quot;phi_min&quot;: [0.0], &quot;phi_max&quot;: [2 * np.pi], &quot;theta_min&quot;: [max(0.0, self.cutoff_theta_rad)], &quot;theta_max&quot;: [zenith_theta_max], } ) ) theta_lims.append(zenith_theta_max) phi_lims.append(np.array([0.0])) cell_ids.append(np.array([0])) next_cell_id = 1 # Build theta bands for iband, theta_outer in enumerate(theta_edges[1:]): theta_inner = theta_edges[iband] # Skip bands below cutoff if theta_outer &lt;= self.cutoff_theta_rad: continue # Solid angle of this band band_omega = 2 * np.pi * (np.cos(theta_inner) - np.cos(theta_outer)) # Number of phi divisions n_phi = max(1, round(band_omega / target_omega)) phi_span = 2 * np.pi / n_phi cell_id_list = list(range(next_cell_id, next_cell_id + n_phi)) next_cell_id = cell_id_list[-1] + 1 # Use arange for better precision than linspace phi_min_arr = np.arange(n_phi) * phi_span phi_max_arr = (np.arange(n_phi) + 1) * phi_span phi_max_arr[-1] = 2 * np.pi # Force exact closure cells.append( pl.DataFrame( { &quot;phi&quot;: (phi_min_arr + phi_max_arr) / 2, &quot;theta&quot;: np.full(n_phi, (theta_inner + theta_outer) / 2), &quot;phi_min&quot;: phi_min_arr, &quot;phi_max&quot;: phi_max_arr, &quot;theta_min&quot;: np.full(n_phi, theta_inner), &quot;theta_max&quot;: np.full(n_phi, theta_outer), } ) ) theta_lims.append(theta_outer) phi_lims.append(phi_min_arr) cell_ids.append(np.array(cell_id_list)) if len(cells) == 0: raise ValueError( &quot;No cells generated - check cutoff_theta and angular_resolution&quot; ) grid = pl.concat(cells).with_columns(pl.int_range(0, pl.len()).alias(&quot;cell_id&quot;)) return grid, np.array(theta_lims), phi_lims, cell_ids get_grid_type() &para; Return the grid-type identifier string. Returns&para; str "equal_area" Source code in packages/canvod-grids/src/canvod/grids/grids_impl/equal_area_grid.py 68 69 70 71 72 73 74 75 76 77def get_grid_type(self) -&gt; str: &quot;&quot;&quot;Return the grid-type identifier string. Returns ------- str ``&quot;equal_area&quot;`` &quot;&quot;&quot; return GridType.EQUAL_AREA.value means
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_angle_grid.EqualAngleBuilder--mathematical-construction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mathematical construction
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_angle_grid.EqualAngleBuilder--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_angle_grid.EqualAngleBuilder.get_grid_type" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_grid_type
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_grid_type">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_angle_grid.EqualAngleBuilder.get_grid_type--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#equirectangular-grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        Equirectangular Grid
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equirectangular_grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        equirectangular_grid
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equirectangular_grid.EquirectangularBuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        EquirectangularBuilder
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EquirectangularBuilder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equirectangular_grid.EquirectangularBuilder--coordinate-convention-physics-gnss" class="md-nav__link">
    <span class="md-ellipsis">
      
        Coordinate convention (physics / GNSS)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equirectangular_grid.EquirectangularBuilder--what-angular_resolution-means" class="md-nav__link">
    <span class="md-ellipsis">
      
        What Geodesic grid implementation. GeodesicBuilder &para; Bases: BaseGridBuilder Geodesic grid based on a subdivided icosahedron. The sphere is tessellated into triangular cells by starting with an icosahedron (20 equilateral triangles) and recursively subdividing each triangle into four smaller triangles. All vertices are projected back onto the unit sphere after each subdivision step, so the final cells are spherical triangles. The grid has no polar singularity and provides near-uniform cell areas, though strict equal-area is not guaranteed â cell areas vary by a few percent depending on how they inherit the icosahedral symmetry axes. Coordinate convention (physics / GNSS)&para; phi â [0, 2Ï) â azimuthal angle from East, counter-clockwise theta â [0, Ï/2] â polar angle from zenith (0 = straight up, Ï/2 = horizon) Cell centres are computed as the 3D Cartesian mean of the three vertices, re-normalised onto the unit sphere. What angular_resolution means&para; angular_resolution is not used directly as a cell size. Instead it is used only when subdivision_level is not explicitly supplied, to estimate an appropriate subdivision level. The heuristic targets an approximate triangle edge length of 2 Ã angular_resolution:: target_edge â 2 Ã angular_resolution (degrees) subdivision_level = ceil(logâ(63.4 / target_edge)) The number 63.4Â° is the edge length of a regular icosahedron inscribed in a unit sphere. Each subdivision halves the edge length, so the actual edge length at level n is approximately:: edge â 63.4Â° / 2â¿ (degrees) The total number of triangles on the full sphere is 20 Ã 4â¿. Roughly half fall in the northern hemisphere (exact count depends on the hemisphere boundary). Mathematical construction&para; Icosahedron â 12 vertices placed at the intersections of three mutually perpendicular golden-ratio rectangles, normalised to the unit sphere. 20 triangular faces connect them. Subdivision â each triangle is split into 4 by inserting edge midpoints. Each midpoint is projected onto the unit sphere (re-normalised) before the next subdivision. This is repeated subdivision_level times. Hemisphere filter â faces are kept if any of their three vertices satisfies theta â¤ Ï/2 â cutoff_theta. Consequently, boundary triangles that straddle the horizon are included and extend slightly below it. Phi wrapping â for triangles that straddle the 0/2Ï azimuthal boundary, vertex phis below Ï are shifted by +2Ï before computing bounding-box limits, then wrapped back. Parameters&para; angular_resolution : float Approximate angular resolution in degrees. Used only to derive subdivision_level when that parameter is not given explicitly. cutoff_theta : float Elevation mask angle in degrees. Triangles are excluded only if all their vertices are below this elevation. subdivision_level : int or None Number of icosahedral subdivisions. If None, estimated from angular_resolution. Typical range 0â5. phi_rotation : float Rigid azimuthal rotation applied after construction, in degrees. Notes&para; The theta_lims, phi_lims, and cell_ids fields of the returned GridData are synthetic evenly-spaced arrays kept only for interface compatibility with ring-based grids. They do not describe the actual triangular cell layout. Use the geodesic_vertices column and the vertices array in GridData.vertices for the true geometry. Source code in packages/canvod-grids/src/canvod/grids/grids_impl/geodesic_grid.py 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433class GeodesicBuilder(BaseGridBuilder): &quot;&quot;&quot;Geodesic grid based on a subdivided icosahedron. The sphere is tessellated into triangular cells by starting with an icosahedron (20 equilateral triangles) and recursively subdividing each triangle into four smaller triangles. All vertices are projected back onto the unit sphere after each subdivision step, so the final cells are *spherical* triangles. The grid has no polar singularity and provides near-uniform cell areas, though strict equal-area is *not* guaranteed â cell areas vary by a few percent depending on how they inherit the icosahedral symmetry axes. Coordinate convention (physics / GNSS) --------------------------------------- * phi â [0, 2Ï) â azimuthal angle from East, counter-clockwise * theta â [0, Ï/2] â polar angle from zenith (0 = straight up, Ï/2 = horizon) Cell centres are computed as the 3D Cartesian mean of the three vertices, re-normalised onto the unit sphere. What ``angular_resolution`` means ---------------------------------- ``angular_resolution`` is **not** used directly as a cell size. Instead it is used only when ``subdivision_level`` is *not* explicitly supplied, to *estimate* an appropriate subdivision level. The heuristic targets an approximate triangle edge length of ``2 Ã angular_resolution``:: target_edge â 2 Ã angular_resolution (degrees) subdivision_level = ceil(logâ(63.4 / target_edge)) The number 63.4Â° is the edge length of a regular icosahedron inscribed in a unit sphere. Each subdivision halves the edge length, so the actual edge length at level *n* is approximately:: edge â 63.4Â° / 2â¿ (degrees) The total number of triangles on the **full sphere** is ``20 Ã 4â¿``. Roughly half fall in the northern hemisphere (exact count depends on the hemisphere boundary). Mathematical construction ------------------------- 1. **Icosahedron** â 12 vertices placed at the intersections of three mutually perpendicular golden-ratio rectangles, normalised to the unit sphere. 20 triangular faces connect them. 2. **Subdivision** â each triangle is split into 4 by inserting edge midpoints. Each midpoint is projected onto the unit sphere (re-normalised) before the next subdivision. This is repeated ``subdivision_level`` times. 3. **Hemisphere filter** â faces are kept if *any* of their three vertices satisfies ``theta â¤ Ï/2 â cutoff_theta``. Consequently, boundary triangles that straddle the horizon *are* included and extend slightly below it. 4. **Phi wrapping** â for triangles that straddle the 0/2Ï azimuthal boundary, vertex phis below Ï are shifted by +2Ï before computing bounding-box limits, then wrapped back. Parameters ---------- angular_resolution : float Approximate angular resolution in degrees. Used only to derive ``subdivision_level`` when that parameter is not given explicitly. cutoff_theta : float Elevation mask angle in degrees. Triangles are excluded only if *all* their vertices are below this elevation. subdivision_level : int or None Number of icosahedral subdivisions. If ``None``, estimated from ``angular_resolution``. Typical range 0â5. phi_rotation : float Rigid azimuthal rotation applied after construction, in degrees. Notes ----- The ``theta_lims``, ``phi_lims``, and ``cell_ids`` fields of the returned ``GridData`` are *synthetic* evenly-spaced arrays kept only for interface compatibility with ring-based grids. They do **not** describe the actual triangular cell layout. Use the ``geodesic_vertices`` column and the ``vertices`` array in ``GridData.vertices`` for the true geometry. &quot;&quot;&quot; def __init__( self, angular_resolution: float = 2, cutoff_theta: float = 0, subdivision_level: int | None = None, phi_rotation: float = 0, ) -&gt; None: &quot;&quot;&quot;Initialize the geodesic grid builder. Parameters ---------- angular_resolution : float, default 2 Angular resolution in degrees. cutoff_theta : float, default 0 Maximum polar angle cutoff in degrees. subdivision_level : int | None, optional Subdivision level override. phi_rotation : float, default 0 Rotation angle in degrees. &quot;&quot;&quot; super().__init__(angular_resolution, cutoff_theta, phi_rotation) self._triangles: np.ndarray | None = None if subdivision_level is None: target_edge_deg = angular_resolution * 2 self.subdivision_level = max( 0, int(np.ceil(np.log2(63.4 / target_edge_deg))), ) else: self.subdivision_level = subdivision_level self._logger.info( f&quot;Geodesic: subdivision_level={self.subdivision_level}, &quot; f&quot;~{20 * 4**self.subdivision_level} triangles&quot; ) def get_triangles(self) -&gt; np.ndarray | None: &quot;&quot;&quot;Return triangle vertex coordinates for visualization. Returns ------- triangles : np.ndarray or None Array of shape ``(n_faces, 3, 3)`` where ``triangles[i]`` contains the three 3D unit-sphere vertices of triangle *i*. ``None`` if the grid has not been built yet. &quot;&quot;&quot; return self._triangles def get_grid_type(self) -&gt; str: &quot;&quot;&quot;Return the grid-type identifier string. Returns ------- str ``&quot;geodesic&quot;`` &quot;&quot;&quot; return GridType.GEODESIC.value def _extract_triangle_vertices( self, vertices: np.ndarray, faces: np.ndarray ) -&gt; np.ndarray: &quot;&quot;&quot;Extract 3D vertex coordinates for each face. Parameters ---------- vertices : np.ndarray All sphere vertices, shape ``(n_vertices, 3)``. faces : np.ndarray Face index array, shape ``(n_faces, 3)``. Returns ------- triangles : np.ndarray Shape ``(n_faces, 3, 3)`` â three 3D vertices per face. &quot;&quot;&quot; # Vectorized: use NumPy advanced indexing instead of loop return vertices[faces] def _build_grid( self, ) -&gt; tuple[ pl.DataFrame, np.ndarray, list[np.ndarray], list[np.ndarray], dict[str, Any] ]: &quot;&quot;&quot;Build geodesic grid from subdivided icosahedron. Returns ------- grid : pl.DataFrame One row per triangular cell. Columns include phi, theta (centre), bounding-box limits, ``geodesic_vertices`` (3 vertex indices into the ``vertices`` array), and ``geodesic_subdivision``. theta_lims : np.ndarray Synthetic evenly-spaced theta limits (interface compatibility only). phi_lims : list[np.ndarray] Synthetic evenly-spaced phi limits (interface compatibility only). cell_ids : list[np.ndarray] Single-element list containing all cell ids. extra_kwargs : dict Contains ``vertices`` (shape ``(n_vertices, 3)``), ``vertex_phi``, and ``vertex_theta`` arrays for the full subdivided icosahedron. &quot;&quot;&quot; vertices, faces = self._create_icosahedron() # Subdivide for _ in range(self.subdivision_level): vertices, faces = self._subdivide_mesh(vertices, faces) # Project to unit sphere vertices = vertices / np.linalg.norm(vertices, axis=1, keepdims=True) # Convert to spherical x, y, z = vertices[:, 0], vertices[:, 1], vertices[:, 2] theta = np.arccos(np.clip(z, -1, 1)) phi = np.arctan2(y, x) phi = np.mod(phi, 2 * np.pi) # Filter to northern hemisphere hemisphere_mask = theta &lt;= (np.pi / 2 - self.cutoff_theta_rad) # Filter faces valid_faces = [] for face in faces: if any(hemisphere_mask[v] for v in face): valid_faces.append(face) if len(valid_faces) == 0: raise ValueError(&quot;No valid faces in hemisphere&quot;) valid_faces = np.array(valid_faces) # Create cells cells = [] for face in valid_faces: v_indices = face face_phi = phi[v_indices] face_theta = theta[v_indices] # Handle phi wrapping for triangles crossing 0/2Ï boundary phi_range = np.ptp(face_phi) if phi_range &gt; np.pi: # Triangle crosses the wraparound - unwrap relative to median ref_phi = np.median(face_phi) face_phi_unwrapped = face_phi.copy() # Unwrap angles that are &gt; Ï away from reference mask_low = (ref_phi - face_phi_unwrapped) &gt; np.pi mask_high = (face_phi_unwrapped - ref_phi) &gt; np.pi face_phi_unwrapped[mask_low] += 2 * np.pi face_phi_unwrapped[mask_high] -= 2 * np.pi phi_min = float(np.min(face_phi_unwrapped) % (2 * np.pi)) phi_max = float(np.max(face_phi_unwrapped) % (2 * np.pi)) else: phi_min = float(np.min(face_phi)) phi_max = float(np.max(face_phi)) # Cell center - 3D Cartesian mean face_vertices_3d = vertices[v_indices] center_3d = np.mean(face_vertices_3d, axis=0) center_3d = center_3d / np.linalg.norm(center_3d) center_theta = np.arccos(np.clip(center_3d[2], -1, 1)) center_phi = np.arctan2(center_3d[1], center_3d[0]) center_phi = np.mod(center_phi, 2 * np.pi) # Cell bounds (theta from vertices, phi already computed above) theta_min = float(np.min(face_theta)) theta_max = float(np.max(face_theta)) cells.append( { &quot;phi&quot;: center_phi, &quot;theta&quot;: center_theta, &quot;phi_min&quot;: phi_min, &quot;phi_max&quot;: phi_max, &quot;theta_min&quot;: theta_min, &quot;theta_max&quot;: theta_max, &quot;geodesic_vertices&quot;: v_indices.tolist(), &quot;geodesic_subdivision&quot;: self.subdivision_level, } ) grid = pl.DataFrame(cells).with_columns( pl.int_range(0, pl.len()).alias(&quot;cell_id&quot;) ) extra_kwargs: dict[str, Any] = { &quot;vertices&quot;: vertices, &quot;vertex_phi&quot;: phi, &quot;vertex_theta&quot;: theta, } theta_lims = np.linspace(0, np.pi / 2, 10) phi_lims = [np.linspace(0, 2 * np.pi, 20) for _ in range(len(theta_lims))] cell_ids_list = [np.arange(grid.height)] self._triangles = self._extract_triangle_vertices(vertices, faces) return grid, theta_lims, phi_lims, cell_ids_list, extra_kwargs def _create_icosahedron(self) -&gt; tuple[np.ndarray, np.ndarray]: &quot;&quot;&quot;Create a unit-sphere icosahedron. Returns ------- vertices : np.ndarray Shape ``(12, 3)`` â vertices on the unit sphere. faces : np.ndarray Shape ``(20, 3)`` â integer vertex indices per triangular face. &quot;&quot;&quot; phi_golden = (1 + np.sqrt(5)) / 2 vertices = np.array( [ [-1, phi_golden, 0], [1, phi_golden, 0], [-1, -phi_golden, 0], [1, -phi_golden, 0], [0, -1, phi_golden], [0, 1, phi_golden], [0, -1, -phi_golden], [0, 1, -phi_golden], [phi_golden, 0, -1], [phi_golden, 0, 1], [-phi_golden, 0, -1], [-phi_golden, 0, 1], ], dtype=np.float64, ) vertices = vertices / np.linalg.norm(vertices, axis=1, keepdims=True) faces = np.array( [ [0, 11, 5], [0, 5, 1], [0, 1, 7], [0, 7, 10], [0, 10, 11], [1, 5, 9], [5, 11, 4], [11, 10, 2], [10, 7, 6], [7, 1, 8], [3, 9, 4], [3, 4, 2], [3, 2, 6], [3, 6, 8], [3, 8, 9], [4, 9, 5], [2, 4, 11], [6, 2, 10], [8, 6, 7], [9, 8, 1], ], dtype=np.int64, ) return vertices, faces def _subdivide_mesh( self, vertices: np.ndarray, faces: np.ndarray ) -&gt; tuple[np.ndarray, np.ndarray]: &quot;&quot;&quot;Subdivide each triangle into 4 smaller triangles. Each edge midpoint is computed, normalised onto the unit sphere, and cached so that shared edges produce only one new vertex. Parameters ---------- vertices : np.ndarray Current vertex array, shape ``(n_vertices, 3)``. faces : np.ndarray Current face array, shape ``(n_faces, 3)``. Returns ------- new_vertices : np.ndarray Expanded vertex array, shape ``(n_vertices + n_new_midpoints, 3)``. new_faces : np.ndarray New face array, shape ``(4 Ã n_faces, 3)``. &quot;&quot;&quot; new_faces = [] edge_midpoints: dict[tuple[int, int], int] = {} def get_midpoint(v1: int, v2: int) -&gt; int: &quot;&quot;&quot;Return midpoint vertex index for an edge. Parameters ---------- v1 : int First vertex index. v2 : int Second vertex index. Returns ------- int Index of the midpoint vertex. &quot;&quot;&quot; edge = tuple(sorted([v1, v2])) if edge not in edge_midpoints: edge_midpoints[edge] = len(vertices) + len(edge_midpoints) return edge_midpoints[edge] for face in faces: v0, v1, v2 = face m01 = get_midpoint(v0, v1) m12 = get_midpoint(v1, v2) m20 = get_midpoint(v2, v0) new_faces.extend( [ [v0, m01, m20], [v1, m12, m01], [v2, m20, m12], [m01, m12, m20], ] ) n_original = len(vertices) n_new = len(edge_midpoints) final_vertices = np.zeros((n_original + n_new, 3)) final_vertices[:n_original] = vertices for edge, idx in edge_midpoints.items(): v1, v2 = edge midpoint = (vertices[v1] + vertices[v2]) / 2 midpoint = midpoint / np.linalg.norm(midpoint) final_vertices[idx] = midpoint return final_vertices, np.array(new_faces) __init__(angular_resolution=2, cutoff_theta=0, subdivision_level=None, phi_rotation=0) &para; Initialize the geodesic grid builder. Parameters&para; angular_resolution : float, default 2 Angular resolution in degrees. cutoff_theta : float, default 0 Maximum polar angle cutoff in degrees. subdivision_level : int | None, optional Subdivision level override. phi_rotation : float, default 0 Rotation angle in degrees. Source code in packages/canvod-grids/src/canvod/grids/grids_impl/geodesic_grid.py 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129def __init__( self, angular_resolution: float = 2, cutoff_theta: float = 0, subdivision_level: int | None = None, phi_rotation: float = 0, ) -&gt; None: &quot;&quot;&quot;Initialize the geodesic grid builder. Parameters ---------- angular_resolution : float, default 2 Angular resolution in degrees. cutoff_theta : float, default 0 Maximum polar angle cutoff in degrees. subdivision_level : int | None, optional Subdivision level override. phi_rotation : float, default 0 Rotation angle in degrees. &quot;&quot;&quot; super().__init__(angular_resolution, cutoff_theta, phi_rotation) self._triangles: np.ndarray | None = None if subdivision_level is None: target_edge_deg = angular_resolution * 2 self.subdivision_level = max( 0, int(np.ceil(np.log2(63.4 / target_edge_deg))), ) else: self.subdivision_level = subdivision_level self._logger.info( f&quot;Geodesic: subdivision_level={self.subdivision_level}, &quot; f&quot;~{20 * 4**self.subdivision_level} triangles&quot; ) get_triangles() &para; Return triangle vertex coordinates for visualization. Returns&para; triangles : np.ndarray or None Array of shape (n_faces, 3, 3) where triangles[i] contains the three 3D unit-sphere vertices of triangle i. None if the grid has not been built yet. Source code in packages/canvod-grids/src/canvod/grids/grids_impl/geodesic_grid.py 131 132 133 134 135 136 137 138 139 140 141 142def get_triangles(self) -&gt; np.ndarray | None: &quot;&quot;&quot;Return triangle vertex coordinates for visualization. Returns ------- triangles : np.ndarray or None Array of shape ``(n_faces, 3, 3)`` where ``triangles[i]`` contains the three 3D unit-sphere vertices of triangle *i*. ``None`` if the grid has not been built yet. &quot;&quot;&quot; return self._triangles get_grid_type() &para; Return the grid-type identifier string. Returns&para; str "geodesic" Source code in packages/canvod-grids/src/canvod/grids/grids_impl/geodesic_grid.py 144 145 146 147 148 149 150 151 152 153def get_grid_type(self) -&gt; str: &quot;&quot;&quot;Return the grid-type identifier string. Returns ------- str ``&quot;geodesic&quot;`` &quot;&quot;&quot; return GridType.GEODESIC.value means
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equirectangular_grid.EquirectangularBuilder--mathematical-construction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mathematical construction
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equirectangular_grid.EquirectangularBuilder--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equirectangular_grid.EquirectangularBuilder.get_grid_type" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_grid_type
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_grid_type">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equirectangular_grid.EquirectangularBuilder.get_grid_type--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#grid-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Grid Operations
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        operations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="operations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations--cell-assignment" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cell assignment
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations--vertex-grid-conversion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Vertex / grid conversion
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.operations.add_cell_ids_to_vod_fast" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_cell_ids_to_vod_fast
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_cell_ids_to_vod_fast">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.add_cell_ids_to_vod_fast--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.add_cell_ids_to_vod_fast--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.operations.add_cell_ids_to_vod" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_cell_ids_to_vod
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_cell_ids_to_vod">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.add_cell_ids_to_vod--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.add_cell_ids_to_vod--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.operations.add_cell_ids_to_ds_fast" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_cell_ids_to_ds_fast
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_cell_ids_to_ds_fast">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.add_cell_ids_to_ds_fast--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.add_cell_ids_to_ds_fast--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.operations.extract_grid_vertices" class="md-nav__link">
    <span class="md-ellipsis">
      
        extract_grid_vertices
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="extract_grid_vertices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.extract_grid_vertices--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.extract_grid_vertices--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.operations.grid_to_dataset" class="md-nav__link">
    <span class="md-ellipsis">
      
        grid_to_dataset
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="grid_to_dataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.grid_to_dataset--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.grid_to_dataset--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.grid_to_dataset--notes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notes
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.operations.store_grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        store_grid
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="store_grid">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.store_grid--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.store_grid--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.store_grid--examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Examples
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.operations.load_grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        load_grid
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="load_grid">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.load_grid--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.load_grid--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.load_grid--examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Examples
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aggregation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Aggregation
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.aggregation" class="md-nav__link">
    <span class="md-ellipsis">
      
        aggregation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="aggregation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation--top-level-entry-points" class="md-nav__link">
    <span class="md-ellipsis">
      
        Top-level entry points
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation--analysis-helpers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Analysis helpers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation--convenience-wrappers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Convenience wrappers
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.CellAggregator" class="md-nav__link">
    <span class="md-ellipsis">
      
        CellAggregator
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CellAggregator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.CellAggregator.aggregate_by_cell" class="md-nav__link">
    <span class="md-ellipsis">
      
        aggregate_by_cell
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="aggregate_by_cell">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.CellAggregator.aggregate_by_cell--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.CellAggregator.aggregate_by_cell--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.aggregate_data_to_grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        aggregate_data_to_grid
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="aggregate_data_to_grid">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.aggregate_data_to_grid--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.aggregate_data_to_grid--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.compute_percell_timeseries" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_percell_timeseries
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_percell_timeseries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.compute_percell_timeseries--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.compute_percell_timeseries--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.compute_global_average" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_global_average
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_global_average">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.compute_global_average--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.compute_global_average--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.compute_regional_average" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_regional_average
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_regional_average">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.compute_regional_average--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.compute_regional_average--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.analyze_diurnal_patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        analyze_diurnal_patterns
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="analyze_diurnal_patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.analyze_diurnal_patterns--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.analyze_diurnal_patterns--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.analyze_spatial_patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        analyze_spatial_patterns
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="analyze_spatial_patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.analyze_spatial_patterns--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.analyze_spatial_patterns--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.compute_hemisphere_percell" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_hemisphere_percell
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.compute_zenith_percell" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_zenith_percell
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        Analysis
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        analysis
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis--modules" class="md-nav__link">
    <span class="md-ellipsis">
      
        Modules
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.Filter" class="md-nav__link">
    <span class="md-ellipsis">
      
        Filter
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Filter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.Filter.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.Filter.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.Filter.compute_mask" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_mask
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.Filter.apply" class="md-nav__link">
    <span class="md-ellipsis">
      
        apply
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="apply">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.Filter.apply--new-variables" class="md-nav__link">
    <span class="md-ellipsis">
      
        New variables
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.FilterPipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        FilterPipeline
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FilterPipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.FilterPipeline--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.FilterPipeline.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.FilterPipeline.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.FilterPipeline.add_filter" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_filter
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_filter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.FilterPipeline.add_filter--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.FilterPipeline.add_filter--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.FilterPipeline.apply" class="md-nav__link">
    <span class="md-ellipsis">
      
        apply
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="apply">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.FilterPipeline.apply--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.FilterPipeline.apply--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.FilterPipeline.summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        summary
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.IQRFilter" class="md-nav__link">
    <span class="md-ellipsis">
      
        IQRFilter
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="IQRFilter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.IQRFilter.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.IQRFilter.compute_mask" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_mask
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_mask">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.IQRFilter.compute_mask--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.IQRFilter.compute_mask--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.ZScoreFilter" class="md-nav__link">
    <span class="md-ellipsis">
      
        ZScoreFilter
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ZScoreFilter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.ZScoreFilter.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.ZScoreFilter.compute_mask" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_mask
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_mask">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.ZScoreFilter.compute_mask--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.ZScoreFilter.compute_mask--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask" class="md-nav__link">
    <span class="md-ellipsis">
      
        SpatialMask
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SpatialMask">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask--examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Examples
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_phi_range" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_phi_range
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_phi_range">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_phi_range--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_phi_range--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_phi_range--notes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notes
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_theta_range" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_theta_range
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_theta_range">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_theta_range--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_theta_range--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_theta_range--notes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notes
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_elevation_range" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_elevation_range
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_elevation_range">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_elevation_range--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_elevation_range--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_elevation_range--notes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notes
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_cell_ids" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_cell_ids
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_cell_ids">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_cell_ids--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_cell_ids--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_exclude_cell_ids" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_exclude_cell_ids
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_exclude_cell_ids">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_exclude_cell_ids--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_exclude_cell_ids--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_quality_threshold" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_quality_threshold
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_quality_threshold">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_quality_threshold--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_quality_threshold--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_quality_threshold--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_boundary_cells" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_boundary_cells
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_boundary_cells">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_boundary_cells--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_boundary_cells--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_boundary_cells--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_boundary_cells--notes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notes
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_custom_mask" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_custom_mask
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_custom_mask">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_custom_mask--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_custom_mask--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_custom_mask--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_custom_mask--examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Examples
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_radial_sector" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_radial_sector
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_radial_sector">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_radial_sector--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_radial_sector--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_radial_sector--examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Examples
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_radial_sector--northern-sector-30-wide-excluding-low-elevations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Northern sector, 30Â° wide, excluding low elevations
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.compute" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.compute--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.compute--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.compute--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.get_mask_summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_mask_summary
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_mask_summary">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.get_mask_summary--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.clear" class="md-nav__link">
    <span class="md-ellipsis">
      
        clear
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="clear">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.clear--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.__repr__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __repr__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__repr__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.__repr__--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellVODAnalyzer" class="md-nav__link">
    <span class="md-ellipsis">
      
        PerCellVODAnalyzer
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PerCellVODAnalyzer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellVODAnalyzer--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellVODAnalyzer--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellVODAnalyzer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellVODAnalyzer.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilter" class="md-nav__link">
    <span class="md-ellipsis">
      
        PerCellFilter
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PerCellFilter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilter.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilter.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilter.compute_cell_mask" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_cell_mask
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_cell_mask">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilter.compute_cell_mask--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilter.compute_cell_mask--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilter.apply" class="md-nav__link">
    <span class="md-ellipsis">
      
        apply
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="apply">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilter.apply--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilter.apply--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilterPipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        PerCellFilterPipeline
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PerCellFilterPipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilterPipeline--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilterPipeline.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilterPipeline.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilterPipeline.add_filter" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_filter
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_filter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilterPipeline.add_filter--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilterPipeline.add_filter--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilterPipeline.apply" class="md-nav__link">
    <span class="md-ellipsis">
      
        apply
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="apply">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilterPipeline.apply--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilterPipeline.apply--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellIQRFilter" class="md-nav__link">
    <span class="md-ellipsis">
      
        PerCellIQRFilter
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PerCellIQRFilter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellIQRFilter.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellIQRFilter.compute_cell_mask" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_cell_mask
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_cell_mask">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellIQRFilter.compute_cell_mask--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellIQRFilter.compute_cell_mask--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellZScoreFilter" class="md-nav__link">
    <span class="md-ellipsis">
      
        PerCellZScoreFilter
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PerCellZScoreFilter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellZScoreFilter.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellZScoreFilter.compute_cell_mask" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_cell_mask
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_cell_mask">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellZScoreFilter.compute_cell_mask--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellZScoreFilter.compute_cell_mask--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator" class="md-nav__link">
    <span class="md-ellipsis">
      
        SolarPositionCalculator
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SolarPositionCalculator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator--examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Examples
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.compute_solar_position" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_solar_position
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_solar_position">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.compute_solar_position--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.compute_solar_position--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.compute_solar_elevation" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_solar_elevation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_solar_elevation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.compute_solar_elevation--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.compute_solar_elevation--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.is_daytime" class="md-nav__link">
    <span class="md-ellipsis">
      
        is_daytime
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="is_daytime">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.is_daytime--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.is_daytime--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.apply_solar_correction" class="md-nav__link">
    <span class="md-ellipsis">
      
        apply_solar_correction
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="apply_solar_correction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.apply_solar_correction--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.apply_solar_correction--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.compute_solar_bins" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_solar_bins
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_solar_bins">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.compute_solar_bins--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.compute_solar_bins--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.get_sunrise_sunset" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_sunrise_sunset
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_sunrise_sunset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.get_sunrise_sunset--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.get_sunrise_sunset--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.__repr__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __repr__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__repr__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.__repr__--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.VODSpatialAnalyzer" class="md-nav__link">
    <span class="md-ellipsis">
      
        VODSpatialAnalyzer
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VODSpatialAnalyzer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.VODSpatialAnalyzer--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.VODSpatialAnalyzer--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.VODSpatialAnalyzer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.VODSpatialAnalyzer.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.VODSpatialAnalyzer.compute_spatial_statistics" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_spatial_statistics
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_spatial_statistics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.VODSpatialAnalyzer.compute_spatial_statistics--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.VODSpatialAnalyzer.compute_spatial_statistics--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.VODSpatialAnalyzer.compute_spatial_statistics--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.VODSpatialAnalyzer.compare_filtering_methods" class="md-nav__link">
    <span class="md-ellipsis">
      
        compare_filtering_methods
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compare_filtering_methods">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.VODSpatialAnalyzer.compare_filtering_methods--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.VODSpatialAnalyzer.compare_filtering_methods--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        TemporalAnalysis
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TemporalAnalysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis--examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Examples
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.compute_timeseries" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_timeseries
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_timeseries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.compute_timeseries--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.compute_timeseries--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.compute_timeseries--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.compute_timeseries_solar_corrected" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_timeseries_solar_corrected
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_timeseries_solar_corrected">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.compute_timeseries_solar_corrected--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.compute_timeseries_solar_corrected--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.compute_timeseries_solar_corrected--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.compute_diurnal_cycle" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_diurnal_cycle
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_diurnal_cycle">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.compute_diurnal_cycle--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.compute_diurnal_cycle--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.compute_diurnal_cycle_solar" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_diurnal_cycle_solar
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_diurnal_cycle_solar">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.compute_diurnal_cycle_solar--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.compute_diurnal_cycle_solar--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.compute_diurnal_cycle_solar--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.add_solar_metadata_to_timeseries" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_solar_metadata_to_timeseries
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_solar_metadata_to_timeseries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.add_solar_metadata_to_timeseries--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.add_solar_metadata_to_timeseries--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.add_solar_metadata_to_timeseries--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.plot_timeseries" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_timeseries
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="plot_timeseries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.plot_timeseries--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.plot_timeseries--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.plot_diurnal_cycle" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_diurnal_cycle
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="plot_diurnal_cycle">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.plot_diurnal_cycle--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.plot_diurnal_cycle--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.plot_diurnal_cycle_comparison" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_diurnal_cycle_comparison
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="plot_diurnal_cycle_comparison">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.plot_diurnal_cycle_comparison--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.plot_diurnal_cycle_comparison--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator" class="md-nav__link">
    <span class="md-ellipsis">
      
        WeightCalculator
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="WeightCalculator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator--examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Examples
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.add_weight" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_weight
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_weight">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.add_weight--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.add_weight--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.add_weight--examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Examples
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.compute" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.compute--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.compute--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.compute--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.get_weight_summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_weight_summary
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_weight_summary">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.get_weight_summary--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.remove_weight" class="md-nav__link">
    <span class="md-ellipsis">
      
        remove_weight
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="remove_weight">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.remove_weight--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.remove_weight--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.clear" class="md-nav__link">
    <span class="md-ellipsis">
      
        clear
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="clear">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.clear--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.__repr__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __repr__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__repr__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.__repr__--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.aggr_hampel_cell_sid_parallelized" class="md-nav__link">
    <span class="md-ellipsis">
      
        aggr_hampel_cell_sid_parallelized
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="aggr_hampel_cell_sid_parallelized">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.aggr_hampel_cell_sid_parallelized--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.aggr_hampel_cell_sid_parallelized--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.hampel_cell_sid_parallelized" class="md-nav__link">
    <span class="md-ellipsis">
      
        hampel_cell_sid_parallelized
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="hampel_cell_sid_parallelized">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.hampel_cell_sid_parallelized--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.hampel_cell_sid_parallelized--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.create_elevation_mask" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_elevation_mask
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="create_elevation_mask">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.create_elevation_mask--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.create_elevation_mask--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.create_hemisphere_mask" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_hemisphere_mask
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="create_hemisphere_mask">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.create_hemisphere_mask--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.create_hemisphere_mask--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.create_hemisphere_mask--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.extract_percell_coverage" class="md-nav__link">
    <span class="md-ellipsis">
      
        extract_percell_coverage
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="extract_percell_coverage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.extract_percell_coverage--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.extract_percell_coverage--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.extract_percell_stats" class="md-nav__link">
    <span class="md-ellipsis">
      
        extract_percell_stats
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="extract_percell_stats">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.extract_percell_stats--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.extract_percell_stats--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.extract_percell_temporal_stats" class="md-nav__link">
    <span class="md-ellipsis">
      
        extract_percell_temporal_stats
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="extract_percell_temporal_stats">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.extract_percell_temporal_stats--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.extract_percell_temporal_stats--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.percell_to_grid_counts" class="md-nav__link">
    <span class="md-ellipsis">
      
        percell_to_grid_counts
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="percell_to_grid_counts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.percell_to_grid_counts--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.percell_to_grid_counts--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.percell_to_grid_data" class="md-nav__link">
    <span class="md-ellipsis">
      
        percell_to_grid_data
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="percell_to_grid_data">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.percell_to_grid_data--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.percell_to_grid_data--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.astropy_hampel_ultra_fast" class="md-nav__link">
    <span class="md-ellipsis">
      
        astropy_hampel_ultra_fast
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="astropy_hampel_ultra_fast">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.astropy_hampel_ultra_fast--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.astropy_hampel_ultra_fast--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.astropy_hampel_ultra_fast--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.astropy_hampel_vectorized_fast" class="md-nav__link">
    <span class="md-ellipsis">
      
        astropy_hampel_vectorized_fast
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="astropy_hampel_vectorized_fast">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.astropy_hampel_vectorized_fast--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.astropy_hampel_vectorized_fast--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.astropy_hampel_vectorized_fast--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.AnalysisStorage" class="md-nav__link">
    <span class="md-ellipsis">
      
        AnalysisStorage
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AnalysisStorage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.AnalysisStorage--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.AnalysisStorage--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../canvod-vod/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    canvod.vod
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../canvod-store/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    canvod.store
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../canvod-viz/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    canvod.viz
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../canvod-utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    canvod.utils
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#package" class="md-nav__link">
    <span class="md-ellipsis">
      
        Package
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids" class="md-nav__link">
    <span class="md-ellipsis">
      
        grids
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.BaseGridBuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        BaseGridBuilder
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BaseGridBuilder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.BaseGridBuilder--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.BaseGridBuilder.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.BaseGridBuilder.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.BaseGridBuilder.get_grid_type" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_grid_type
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.BaseGridBuilder.build" class="md-nav__link">
    <span class="md-ellipsis">
      
        build
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="build">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.BaseGridBuilder.build--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.GridData" class="md-nav__link">
    <span class="md-ellipsis">
      
        GridData
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GridData">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.GridData--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.GridData.coords" class="md-nav__link">
    <span class="md-ellipsis">
      
        coords
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.GridData.ncells" class="md-nav__link">
    <span class="md-ellipsis">
      
        ncells
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.GridData.get_patches" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_patches
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.GridData.get_solid_angles" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_solid_angles
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.GridData.get_grid_stats" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_grid_stats
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.GridType" class="md-nav__link">
    <span class="md-ellipsis">
      
        GridType
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.CellAggregator" class="md-nav__link">
    <span class="md-ellipsis">
      
        CellAggregator
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CellAggregator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.CellAggregator.aggregate_by_cell" class="md-nav__link">
    <span class="md-ellipsis">
      
        aggregate_by_cell
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="aggregate_by_cell">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.CellAggregator.aggregate_by_cell--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.CellAggregator.aggregate_by_cell--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.create_hemigrid" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_hemigrid
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="create_hemigrid">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.create_hemigrid--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.create_hemigrid--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.create_hemigrid--examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Examples
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.create_hemigrid--equal-area-grid-with-10-resolution" class="md-nav__link">
    <span class="md-ellipsis">
      
        Equal area grid with 10Â° resolution
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.create_hemigrid--htm-grid-with-subdivision-level-3" class="md-nav__link">
    <span class="md-ellipsis">
      
        HTM grid with subdivision level 3
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.create_hemigrid--geodesic-grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        Geodesic grid
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Geodesic grid">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.create_hemigrid--notes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notes
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#grid-builders" class="md-nav__link">
    <span class="md-ellipsis">
      
        Grid Builders
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.core.grid_builder" class="md-nav__link">
    <span class="md-ellipsis">
      
        grid_builder
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.core.grid_builder.BaseGridBuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        BaseGridBuilder
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="BaseGridBuilder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.core.grid_builder.BaseGridBuilder--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.core.grid_builder.BaseGridBuilder.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.core.grid_builder.BaseGridBuilder.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.core.grid_builder.BaseGridBuilder.get_grid_type" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_grid_type
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.core.grid_builder.BaseGridBuilder.build" class="md-nav__link">
    <span class="md-ellipsis">
      
        build
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="build">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.core.grid_builder.BaseGridBuilder.build--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#equal-area-grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        Equal-Area Grid
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_area_grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        equal_area_grid
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_area_grid.EqualAreaBuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        EqualAreaBuilder
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EqualAreaBuilder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_area_grid.EqualAreaBuilder--coordinate-convention-physics-gnss" class="md-nav__link">
    <span class="md-ellipsis">
      
        Coordinate convention (physics / GNSS)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_area_grid.EqualAreaBuilder--what-angular_resolution-means" class="md-nav__link">
    <span class="md-ellipsis">
      
        What HEALPix and hemispheric grid operations. Provides hemisphere grid structures for GNSS signal observation analysis. BaseGridBuilder &para; Bases: ABC Abstract base for hemispherical grid builders. Parameters&para; angular_resolution : float Angular resolution in degrees cutoff_theta : float Maximum polar angle cutoff in degrees phi_rotation : float Rotation angle in degrees (applied to all phi values) Source code in packages/canvod-grids/src/canvod/grids/core/grid_builder.py 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140class BaseGridBuilder(ABC): &quot;&quot;&quot;Abstract base for hemispherical grid builders. Parameters ---------- angular_resolution : float Angular resolution in degrees cutoff_theta : float Maximum polar angle cutoff in degrees phi_rotation : float Rotation angle in degrees (applied to all phi values) &quot;&quot;&quot; def __init__( self, angular_resolution: float = 2, cutoff_theta: float = 0, phi_rotation: float = 0, ) -&gt; None: &quot;&quot;&quot;Initialize the grid builder. Parameters ---------- angular_resolution : float, default 2 Angular resolution in degrees. cutoff_theta : float, default 0 Maximum polar angle cutoff in degrees. phi_rotation : float, default 0 Rotation angle in degrees. &quot;&quot;&quot; self.angular_resolution = angular_resolution self.angular_resolution_rad = np.deg2rad(angular_resolution) self.cutoff_theta = cutoff_theta self.cutoff_theta_rad = np.deg2rad(cutoff_theta) self.phi_rotation = phi_rotation self.phi_rotation_rad = np.deg2rad(phi_rotation) self._logger = _get_logger() @abstractmethod def _build_grid( self, ) -&gt; ( tuple[pl.DataFrame, np.ndarray, list[np.ndarray], list[np.ndarray]] | tuple[ pl.DataFrame, np.ndarray, list[np.ndarray], list[np.ndarray], dict[str, Any] ] ): &quot;&quot;&quot;Build grid. Returns ------- grid : pl.DataFrame Grid cells theta_lims : np.ndarray Theta band limits phi_lims : list[np.ndarray] Phi limits per band cell_ids : list[np.ndarray] Cell IDs per band extra_kwargs : dict, optional Additional metadata &quot;&quot;&quot; @abstractmethod def get_grid_type(self) -&gt; str: &quot;&quot;&quot;Get grid type identifier.&quot;&quot;&quot; def build(self) -&gt; GridData: &quot;&quot;&quot;Build hemisphere grid. Returns ------- GridData Complete grid data structure &quot;&quot;&quot; self._logger.info( &quot;grid_build_started&quot;, grid_type=self.get_grid_type(), angular_resolution=self.angular_resolution, ) result = self._build_grid() if len(result) == 4: grid, theta_lims, phi_lims, cell_ids = result extra_kwargs = {} elif len(result) == 5: grid, theta_lims, phi_lims, cell_ids, extra_kwargs = result else: raise ValueError(f&quot;Invalid grid builder result: {len(result)} elements&quot;) # Apply phi rotation if specified (vectorized operations) if self.phi_rotation_rad != 0: grid = grid.with_columns( [(pl.col(&quot;phi&quot;) + self.phi_rotation_rad) % (2 * np.pi)] ) if &quot;phi_min&quot; in grid.columns: grid = grid.with_columns( [ ( (pl.col(&quot;phi_min&quot;) + self.phi_rotation_rad) % (2 * np.pi) ).alias(&quot;phi_min&quot;), ( (pl.col(&quot;phi_max&quot;) + self.phi_rotation_rad) % (2 * np.pi) ).alias(&quot;phi_max&quot;), ] ) self._logger.info(&quot;grid_build_complete&quot;, ncells=len(grid)) return GridData( grid=grid, theta_lims=theta_lims, phi_lims=phi_lims, cell_ids=cell_ids, grid_type=self.get_grid_type(), **extra_kwargs, ) __init__(angular_resolution=2, cutoff_theta=0, phi_rotation=0) &para; Initialize the grid builder. Parameters&para; angular_resolution : float, default 2 Angular resolution in degrees. cutoff_theta : float, default 0 Maximum polar angle cutoff in degrees. phi_rotation : float, default 0 Rotation angle in degrees. Source code in packages/canvod-grids/src/canvod/grids/core/grid_builder.py 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56def __init__( self, angular_resolution: float = 2, cutoff_theta: float = 0, phi_rotation: float = 0, ) -&gt; None: &quot;&quot;&quot;Initialize the grid builder. Parameters ---------- angular_resolution : float, default 2 Angular resolution in degrees. cutoff_theta : float, default 0 Maximum polar angle cutoff in degrees. phi_rotation : float, default 0 Rotation angle in degrees. &quot;&quot;&quot; self.angular_resolution = angular_resolution self.angular_resolution_rad = np.deg2rad(angular_resolution) self.cutoff_theta = cutoff_theta self.cutoff_theta_rad = np.deg2rad(cutoff_theta) self.phi_rotation = phi_rotation self.phi_rotation_rad = np.deg2rad(phi_rotation) self._logger = _get_logger() get_grid_type() abstractmethod &para; Get grid type identifier. Source code in packages/canvod-grids/src/canvod/grids/core/grid_builder.py 84 85 86@abstractmethod def get_grid_type(self) -&gt; str: &quot;&quot;&quot;Get grid type identifier.&quot;&quot;&quot; build() &para; Build hemisphere grid. Returns&para; GridData Complete grid data structure Source code in packages/canvod-grids/src/canvod/grids/core/grid_builder.py 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140def build(self) -&gt; GridData: &quot;&quot;&quot;Build hemisphere grid. Returns ------- GridData Complete grid data structure &quot;&quot;&quot; self._logger.info( &quot;grid_build_started&quot;, grid_type=self.get_grid_type(), angular_resolution=self.angular_resolution, ) result = self._build_grid() if len(result) == 4: grid, theta_lims, phi_lims, cell_ids = result extra_kwargs = {} elif len(result) == 5: grid, theta_lims, phi_lims, cell_ids, extra_kwargs = result else: raise ValueError(f&quot;Invalid grid builder result: {len(result)} elements&quot;) # Apply phi rotation if specified (vectorized operations) if self.phi_rotation_rad != 0: grid = grid.with_columns( [(pl.col(&quot;phi&quot;) + self.phi_rotation_rad) % (2 * np.pi)] ) if &quot;phi_min&quot; in grid.columns: grid = grid.with_columns( [ ( (pl.col(&quot;phi_min&quot;) + self.phi_rotation_rad) % (2 * np.pi) ).alias(&quot;phi_min&quot;), ( (pl.col(&quot;phi_max&quot;) + self.phi_rotation_rad) % (2 * np.pi) ).alias(&quot;phi_max&quot;), ] ) self._logger.info(&quot;grid_build_complete&quot;, ncells=len(grid)) return GridData( grid=grid, theta_lims=theta_lims, phi_lims=phi_lims, cell_ids=cell_ids, grid_type=self.get_grid_type(), **extra_kwargs, ) GridData dataclass &para; Immutable container for hemispherical grid structure. Parameters&para; grid : pl.DataFrame Grid cells with phi, theta, and bounds theta_lims : np.ndarray Theta band limits phi_lims : list[np.ndarray] Phi limits per theta band cell_ids : list[np.ndarray] Cell IDs per theta band grid_type : str Grid type identifier solid_angles : np.ndarray, optional Solid angles per cell [steradians] metadata : dict, optional Additional grid metadata voronoi : Any, optional Voronoi tessellation object (for Fibonacci grids) vertices : np.ndarray, optional 3D vertices (for triangular grids) points_xyz : np.ndarray, optional 3D point cloud (for Fibonacci grids) vertex_phi : np.ndarray, optional Vertex phi coordinates vertex_theta : np.ndarray, optional Vertex theta coordinates Source code in packages/canvod-grids/src/canvod/grids/core/grid_data.py 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251@dataclass(frozen=True) class GridData: &quot;&quot;&quot;Immutable container for hemispherical grid structure. Parameters ---------- grid : pl.DataFrame Grid cells with phi, theta, and bounds theta_lims : np.ndarray Theta band limits phi_lims : list[np.ndarray] Phi limits per theta band cell_ids : list[np.ndarray] Cell IDs per theta band grid_type : str Grid type identifier solid_angles : np.ndarray, optional Solid angles per cell [steradians] metadata : dict, optional Additional grid metadata voronoi : Any, optional Voronoi tessellation object (for Fibonacci grids) vertices : np.ndarray, optional 3D vertices (for triangular grids) points_xyz : np.ndarray, optional 3D point cloud (for Fibonacci grids) vertex_phi : np.ndarray, optional Vertex phi coordinates vertex_theta : np.ndarray, optional Vertex theta coordinates &quot;&quot;&quot; grid: pl.DataFrame theta_lims: np.ndarray phi_lims: list[np.ndarray] cell_ids: list[np.ndarray] grid_type: str solid_angles: np.ndarray | None = None metadata: dict | None = None voronoi: Any | None = None vertices: np.ndarray | None = None points_xyz: np.ndarray | None = None vertex_phi: np.ndarray | None = None vertex_theta: np.ndarray | None = None @property def coords(self) -&gt; pl.DataFrame: &quot;&quot;&quot;Get cell coordinates.&quot;&quot;&quot; return self.grid.select([&quot;phi&quot;, &quot;theta&quot;]) @property def ncells(self) -&gt; int: &quot;&quot;&quot;Number of cells in grid.&quot;&quot;&quot; return len(self.grid) def get_patches(self) -&gt; pl.Series: &quot;&quot;&quot;Create matplotlib patches for polar visualization.&quot;&quot;&quot; patches = [ Rectangle( (row[&quot;phi_min&quot;], row[&quot;theta_min&quot;]), row[&quot;phi_max&quot;] - row[&quot;phi_min&quot;], row[&quot;theta_max&quot;] - row[&quot;theta_min&quot;], fill=True, ) for row in self.grid.iter_rows(named=True) ] return pl.Series(&quot;Patches&quot;, patches) def get_solid_angles(self) -&gt; np.ndarray: &quot;&quot;&quot;Calculate solid angle for each cell [steradians].&quot;&quot;&quot; if self.solid_angles is not None: return self.solid_angles # HEALPix if self.grid_type == &quot;healpix&quot; and &quot;healpix_nside&quot; in self.grid.columns: try: import healpy as hp nside = int(self.grid[&quot;healpix_nside&quot;][0]) return np.full( len(self.grid), hp.nside2pixarea(nside), dtype=np.float64 ) except ImportError: pass # Geodesic if self.grid_type == &quot;geodesic&quot; and &quot;geodesic_vertices&quot; in self.grid.columns: return self._compute_geodesic_solid_angles() # HTM if self.grid_type == &quot;htm&quot; and &quot;htm_vertex_0&quot; in self.grid.columns: return self._compute_htm_solid_angles() # Fibonacci if self.grid_type == &quot;fibonacci&quot; and &quot;voronoi_region&quot; in self.grid.columns: return self._compute_voronoi_solid_angles() # Default return self._geometric_solid_angles() def _compute_htm_solid_angles(self) -&gt; np.ndarray: &quot;&quot;&quot;Compute solid angles for HTM triangular cells.&quot;&quot;&quot; solid_angles = [] for row in self.grid.iter_rows(named=True): v0 = np.array(row[&quot;htm_vertex_0&quot;]) v1 = np.array(row[&quot;htm_vertex_1&quot;]) v2 = np.array(row[&quot;htm_vertex_2&quot;]) # Spherical excess formula a = np.arccos(np.clip(np.dot(v1, v2), -1, 1)) b = np.arccos(np.clip(np.dot(v0, v2), -1, 1)) c = np.arccos(np.clip(np.dot(v0, v1), -1, 1)) s = (a + b + c) / 2 tan_E_4 = np.sqrt( np.tan(s / 2) * np.tan((s - a) / 2) * np.tan((s - b) / 2) * np.tan((s - c) / 2) ) E = 4 * np.arctan(tan_E_4) solid_angles.append(E) return np.array(solid_angles) def _compute_geodesic_solid_angles(self) -&gt; np.ndarray: &quot;&quot;&quot;Compute solid angles for geodesic triangular cells.&quot;&quot;&quot; vertices = (self.metadata or {}).get(&quot;vertices&quot;) if vertices is None: return self._geometric_solid_angles() solid_angles = [] for row in self.grid.iter_rows(named=True): v_indices = row[&quot;geodesic_vertices&quot;] v0, v1, v2 = vertices[v_indices] a = np.arccos(np.clip(np.dot(v1, v2), -1, 1)) b = np.arccos(np.clip(np.dot(v0, v2), -1, 1)) c = np.arccos(np.clip(np.dot(v0, v1), -1, 1)) s = (a + b + c) / 2 tan_E_4 = np.sqrt( np.tan(s / 2) * np.tan((s - a) / 2) * np.tan((s - b) / 2) * np.tan((s - c) / 2) ) E = 4 * np.arctan(tan_E_4) solid_angles.append(E) return np.array(solid_angles) def _compute_voronoi_solid_angles(self) -&gt; np.ndarray: &quot;&quot;&quot;Compute solid angles for Voronoi cells.&quot;&quot;&quot; if self.voronoi is None: return self._geometric_solid_angles() sv = self.voronoi solid_angles = [] for row in self.grid.iter_rows(named=True): region = row[&quot;voronoi_region&quot;] if len(region) &lt; 3: solid_angles.append(np.nan) continue vertices = sv.vertices[region] center = np.array( [ np.sin(row[&quot;theta&quot;]) * np.cos(row[&quot;phi&quot;]), np.sin(row[&quot;theta&quot;]) * np.sin(row[&quot;phi&quot;]), np.cos(row[&quot;theta&quot;]), ] ) total_angle = 0 n = len(vertices) for i in range(n): v1 = vertices[i] v2 = vertices[(i + 1) % n] a = np.arccos(np.clip(np.dot(center, v1), -1, 1)) b = np.arccos(np.clip(np.dot(center, v2), -1, 1)) c = np.arccos(np.clip(np.dot(v1, v2), -1, 1)) s = (a + b + c) / 2 tan_E_4 = np.sqrt( np.tan(s / 2) * np.tan((s - a) / 2) * np.tan((s - b) / 2) * np.tan((s - c) / 2) ) E = 4 * np.arctan(tan_E_4) total_angle += E solid_angles.append(total_angle) return np.array(solid_angles) def _geometric_solid_angles(self) -&gt; np.ndarray: &quot;&quot;&quot;Fallback geometric calculation.&quot;&quot;&quot; solid_angles = [] for row in self.grid.iter_rows(named=True): delta_phi = row[&quot;phi_max&quot;] - row[&quot;phi_min&quot;] cos_diff = np.cos(row[&quot;theta_min&quot;]) - np.cos(row[&quot;theta_max&quot;]) omega = delta_phi * cos_diff solid_angles.append(omega) return np.array(solid_angles) def get_grid_stats(self) -&gt; dict: &quot;&quot;&quot;Get grid statistics including solid angle uniformity.&quot;&quot;&quot; solid_angles = self.get_solid_angles() stats = { &quot;total_cells&quot;: self.ncells, &quot;grid_type&quot;: self.grid_type, &quot;theta_bands&quot;: len(self.theta_lims), &quot;cells_per_band&quot;: [len(ids) for ids in self.cell_ids], &quot;solid_angle_mean_sr&quot;: float(np.mean(solid_angles)), &quot;solid_angle_std_sr&quot;: float(np.std(solid_angles)), &quot;solid_angle_cv_percent&quot;: float( np.std(solid_angles) / np.mean(solid_angles) * 100 ), &quot;total_solid_angle_sr&quot;: float(np.sum(solid_angles)), &quot;hemisphere_solid_angle_sr&quot;: 2 * np.pi, } # Add HEALPix-specific info if self.grid_type == &quot;healpix&quot; and &quot;healpix_nside&quot; in self.grid.columns: try: import healpy as hp nside = int(self.grid[&quot;healpix_nside&quot;][0]) stats[&quot;healpix_nside&quot;] = nside stats[&quot;healpix_npix_total&quot;] = hp.nside2npix(nside) stats[&quot;healpix_pixel_area_sr&quot;] = hp.nside2pixarea(nside) stats[&quot;healpix_resolution_arcmin&quot;] = hp.nside2resol(nside, arcmin=True) except ImportError: pass return stats coords property &para; Get cell coordinates. ncells property &para; Number of cells in grid. get_patches() &para; Create matplotlib patches for polar visualization. Source code in packages/canvod-grids/src/canvod/grids/core/grid_data.py 67 68 69 70 71 72 73 74 75 76 77 78def get_patches(self) -&gt; pl.Series: &quot;&quot;&quot;Create matplotlib patches for polar visualization.&quot;&quot;&quot; patches = [ Rectangle( (row[&quot;phi_min&quot;], row[&quot;theta_min&quot;]), row[&quot;phi_max&quot;] - row[&quot;phi_min&quot;], row[&quot;theta_max&quot;] - row[&quot;theta_min&quot;], fill=True, ) for row in self.grid.iter_rows(named=True) ] return pl.Series(&quot;Patches&quot;, patches) get_solid_angles() &para; Calculate solid angle for each cell [steradians]. Source code in packages/canvod-grids/src/canvod/grids/core/grid_data.py 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110def get_solid_angles(self) -&gt; np.ndarray: &quot;&quot;&quot;Calculate solid angle for each cell [steradians].&quot;&quot;&quot; if self.solid_angles is not None: return self.solid_angles # HEALPix if self.grid_type == &quot;healpix&quot; and &quot;healpix_nside&quot; in self.grid.columns: try: import healpy as hp nside = int(self.grid[&quot;healpix_nside&quot;][0]) return np.full( len(self.grid), hp.nside2pixarea(nside), dtype=np.float64 ) except ImportError: pass # Geodesic if self.grid_type == &quot;geodesic&quot; and &quot;geodesic_vertices&quot; in self.grid.columns: return self._compute_geodesic_solid_angles() # HTM if self.grid_type == &quot;htm&quot; and &quot;htm_vertex_0&quot; in self.grid.columns: return self._compute_htm_solid_angles() # Fibonacci if self.grid_type == &quot;fibonacci&quot; and &quot;voronoi_region&quot; in self.grid.columns: return self._compute_voronoi_solid_angles() # Default return self._geometric_solid_angles() get_grid_stats() &para; Get grid statistics including solid angle uniformity. Source code in packages/canvod-grids/src/canvod/grids/core/grid_data.py 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251def get_grid_stats(self) -&gt; dict: &quot;&quot;&quot;Get grid statistics including solid angle uniformity.&quot;&quot;&quot; solid_angles = self.get_solid_angles() stats = { &quot;total_cells&quot;: self.ncells, &quot;grid_type&quot;: self.grid_type, &quot;theta_bands&quot;: len(self.theta_lims), &quot;cells_per_band&quot;: [len(ids) for ids in self.cell_ids], &quot;solid_angle_mean_sr&quot;: float(np.mean(solid_angles)), &quot;solid_angle_std_sr&quot;: float(np.std(solid_angles)), &quot;solid_angle_cv_percent&quot;: float( np.std(solid_angles) / np.mean(solid_angles) * 100 ), &quot;total_solid_angle_sr&quot;: float(np.sum(solid_angles)), &quot;hemisphere_solid_angle_sr&quot;: 2 * np.pi, } # Add HEALPix-specific info if self.grid_type == &quot;healpix&quot; and &quot;healpix_nside&quot; in self.grid.columns: try: import healpy as hp nside = int(self.grid[&quot;healpix_nside&quot;][0]) stats[&quot;healpix_nside&quot;] = nside stats[&quot;healpix_npix_total&quot;] = hp.nside2npix(nside) stats[&quot;healpix_pixel_area_sr&quot;] = hp.nside2pixarea(nside) stats[&quot;healpix_resolution_arcmin&quot;] = hp.nside2resol(nside, arcmin=True) except ImportError: pass return stats GridType &para; Bases: Enum Available grid projection types for hemispherical tessellation. Source code in packages/canvod-grids/src/canvod/grids/core/grid_types.py 6 7 8 9 10 11 12 13 14 15class GridType(Enum): &quot;&quot;&quot;Available grid projection types for hemispherical tessellation.&quot;&quot;&quot; EQUAL_AREA = &quot;equal_area&quot; # Equal solid angle (ring-based) EQUAL_ANGLE = &quot;equal_angle&quot; # Equal angular spacing EQUIRECTANGULAR = &quot;equirectangular&quot; # Simple rectangular HEALPIX = &quot;healpix&quot; # Hierarchical equal area GEODESIC = &quot;geodesic&quot; # Icosahedral triangular FIBONACCI = &quot;fibonacci&quot; # Golden spiral + Voronoi HTM = &quot;htm&quot; # Hierarchical Triangular Mesh CellAggregator &para; Polars-based per-cell aggregation helpers. Source code in packages/canvod-grids/src/canvod/grids/aggregation.py 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168class CellAggregator: &quot;&quot;&quot;Polars-based per-cell aggregation helpers.&quot;&quot;&quot; @staticmethod def aggregate_by_cell( df: pl.DataFrame, value_var: str = &quot;VOD&quot;, method: str = &quot;mean&quot;, ) -&gt; pl.DataFrame: &quot;&quot;&quot;Aggregate values by ``cell_id``. Parameters ---------- df : pl.DataFrame Must contain ``cell_id`` and *value_var* columns. value_var : str Column to aggregate. method : {&#39;mean&#39;, &#39;median&#39;, &#39;std&#39;, &#39;count&#39;} Aggregation method. Returns ------- pl.DataFrame Two-column DataFrame: ``cell_id``, *value_var*. &quot;&quot;&quot; if &quot;cell_id&quot; not in df.columns: raise ValueError(&quot;pl.DataFrame must have &#39;cell_id&#39; column&quot;) if value_var not in df.columns: raise ValueError(f&quot;pl.DataFrame must have &#39;{value_var}&#39; column&quot;) agg_map = { &quot;mean&quot;: pl.col(value_var).mean(), &quot;median&quot;: pl.col(value_var).median(), &quot;std&quot;: pl.col(value_var).std(), &quot;count&quot;: pl.col(value_var).count(), } if method not in agg_map: raise ValueError(f&quot;Unknown method: {method}&quot;) return ( df.group_by(&quot;cell_id&quot;).agg(agg_map[method].alias(value_var)).sort(&quot;cell_id&quot;) ) aggregate_by_cell(df, value_var=&#39;VOD&#39;, method=&#39;mean&#39;) staticmethod &para; Aggregate values by cell_id. Parameters&para; df : pl.DataFrame Must contain cell_id and value_var columns. value_var : str Column to aggregate. method : {'mean', 'median', 'std', 'count'} Aggregation method. Returns&para; pl.DataFrame Two-column DataFrame: cell_id, value_var. Source code in packages/canvod-grids/src/canvod/grids/aggregation.py 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168@staticmethod def aggregate_by_cell( df: pl.DataFrame, value_var: str = &quot;VOD&quot;, method: str = &quot;mean&quot;, ) -&gt; pl.DataFrame: &quot;&quot;&quot;Aggregate values by ``cell_id``. Parameters ---------- df : pl.DataFrame Must contain ``cell_id`` and *value_var* columns. value_var : str Column to aggregate. method : {&#39;mean&#39;, &#39;median&#39;, &#39;std&#39;, &#39;count&#39;} Aggregation method. Returns ------- pl.DataFrame Two-column DataFrame: ``cell_id``, *value_var*. &quot;&quot;&quot; if &quot;cell_id&quot; not in df.columns: raise ValueError(&quot;pl.DataFrame must have &#39;cell_id&#39; column&quot;) if value_var not in df.columns: raise ValueError(f&quot;pl.DataFrame must have &#39;{value_var}&#39; column&quot;) agg_map = { &quot;mean&quot;: pl.col(value_var).mean(), &quot;median&quot;: pl.col(value_var).median(), &quot;std&quot;: pl.col(value_var).std(), &quot;count&quot;: pl.col(value_var).count(), } if method not in agg_map: raise ValueError(f&quot;Unknown method: {method}&quot;) return ( df.group_by(&quot;cell_id&quot;).agg(agg_map[method].alias(value_var)).sort(&quot;cell_id&quot;) ) create_hemigrid(grid_type, angular_resolution=10.0, **kwargs) &para; Create hemisphere grid of specified type. Factory function for creating various hemisphere grid types commonly used in GNSS analysis. Parameters&para; grid_type : str Type of grid to create: - 'equal_area': Regular lat/lon grid with equal solid angle cells - 'equal_angle': Regular angular spacing (not recommended) - 'rectangular' or 'equirectangular': Simple rectangular grid - 'HTM': Hierarchical Triangular Mesh - 'geodesic': Geodesic sphere subdivision (icosahedron-based) - 'healpix': HEALPix grid (requires healpy) - 'fibonacci': Fibonacci sphere (requires scipy) angular_resolution : float, default 10.0 Angular resolution in degrees **kwargs Additional grid-specific parameters: - cutoff_theta : float - Maximum theta angle cutoff (degrees) - phi_rotation : float - Rotation angle (degrees) - subdivision_level : int - For geodesic/HTM grids - htm_level : int - For HTM grids specifically - nside : int - For HEALPix grids - n_points : int - For Fibonacci grids Returns&para; GridData Complete hemisphere grid data structure Examples&para; Equal area grid with 10Â° resolution&para; grid = create_hemigrid('equal_area', angular_resolution=10.0) HTM grid with subdivision level 3&para; grid = create_hemigrid('HTM', angular_resolution=5.0, htm_level=3) Geodesic grid&para; grid = create_hemigrid('geodesic', angular_resolution=5.0, subdivision_level=2) Notes&para; Grid coordinates use standard spherical convention: - phi: azimuth angle, 0 to 2Ï (0 = East, Ï/2 = North) - theta: elevation angle, 0 to Ï/2 (0 = zenith, Ï/2 = horizon) Source code in packages/canvod-grids/src/canvod/grids/__init__.py 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195def create_hemigrid( grid_type: Literal[ &quot;equal_area&quot;, &quot;equal_angle&quot;, &quot;rectangular&quot;, &quot;equirectangular&quot;, &quot;HTM&quot;, &quot;geodesic&quot;, &quot;healpix&quot;, &quot;fibonacci&quot;, ], angular_resolution: float = 10.0, **kwargs: Any, ) -&gt; GridData: &quot;&quot;&quot;Create hemisphere grid of specified type. Factory function for creating various hemisphere grid types commonly used in GNSS analysis. Parameters ---------- grid_type : str Type of grid to create: - &#39;equal_area&#39;: Regular lat/lon grid with equal solid angle cells - &#39;equal_angle&#39;: Regular angular spacing (not recommended) - &#39;rectangular&#39; or &#39;equirectangular&#39;: Simple rectangular grid - &#39;HTM&#39;: Hierarchical Triangular Mesh - &#39;geodesic&#39;: Geodesic sphere subdivision (icosahedron-based) - &#39;healpix&#39;: HEALPix grid (requires healpy) - &#39;fibonacci&#39;: Fibonacci sphere (requires scipy) angular_resolution : float, default 10.0 Angular resolution in degrees **kwargs Additional grid-specific parameters: - cutoff_theta : float - Maximum theta angle cutoff (degrees) - phi_rotation : float - Rotation angle (degrees) - subdivision_level : int - For geodesic/HTM grids - htm_level : int - For HTM grids specifically - nside : int - For HEALPix grids - n_points : int - For Fibonacci grids Returns ------- GridData Complete hemisphere grid data structure Examples -------- &gt;&gt;&gt; # Equal area grid with 10Â° resolution &gt;&gt;&gt; grid = create_hemigrid(&#39;equal_area&#39;, angular_resolution=10.0) &gt;&gt;&gt; &gt;&gt;&gt; # HTM grid with subdivision level 3 &gt;&gt;&gt; grid = create_hemigrid(&#39;HTM&#39;, angular_resolution=5.0, htm_level=3) &gt;&gt;&gt; &gt;&gt;&gt; # Geodesic grid &gt;&gt;&gt; grid = create_hemigrid(&#39;geodesic&#39;, angular_resolution=5.0, subdivision_level=2) Notes ----- Grid coordinates use standard spherical convention: - phi: azimuth angle, 0 to 2Ï (0 = East, Ï/2 = North) - theta: elevation angle, 0 to Ï/2 (0 = zenith, Ï/2 = horizon) &quot;&quot;&quot; grid_type_lower = grid_type.lower() if grid_type_lower == &quot;equal_area&quot;: builder = EqualAreaBuilder( angular_resolution=angular_resolution, **kwargs, ) elif grid_type_lower == &quot;equal_angle&quot;: builder = EqualAngleBuilder( angular_resolution=angular_resolution, **kwargs, ) elif grid_type_lower in [&quot;rectangular&quot;, &quot;equirectangular&quot;]: builder = EquirectangularBuilder( angular_resolution=angular_resolution, **kwargs, ) elif grid_type_lower == &quot;htm&quot;: builder = HTMBuilder( angular_resolution=angular_resolution, **kwargs, ) elif grid_type_lower == &quot;geodesic&quot;: builder = GeodesicBuilder( angular_resolution=angular_resolution, **kwargs, ) elif grid_type_lower == &quot;healpix&quot;: builder = HEALPixBuilder( angular_resolution=angular_resolution, **kwargs, ) elif grid_type_lower == &quot;fibonacci&quot;: builder = FibonacciBuilder( angular_resolution=angular_resolution, **kwargs, ) else: raise ValueError( f&quot;Unknown grid type: {grid_type}. &quot; f&quot;Available types: equal_area, equal_angle, rectangular, &quot; f&quot;equirectangular, HTM, geodesic, healpix, fibonacci&quot; ) return builder.build() means
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_area_grid.EqualAreaBuilder--mathematical-construction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mathematical construction
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_area_grid.EqualAreaBuilder--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_area_grid.EqualAreaBuilder.get_grid_type" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_grid_type
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_grid_type">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_area_grid.EqualAreaBuilder.get_grid_type--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#healpix-grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        HEALPix Grid
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.healpix_grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        healpix_grid
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        HEALPixBuilder
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HEALPixBuilder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder--coordinate-convention" class="md-nav__link">
    <span class="md-ellipsis">
      
        Coordinate convention
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder--what-nside-resolution-means" class="md-nav__link">
    <span class="md-ellipsis">
      
        What Cell assignment and vertex extraction for hemisphere grids. Functions in this module operate on :class:~canvod.grids.core.GridData instances and VOD xarray Datasets. Cell assignment&para; add_cell_ids_to_vod_fast â vectorised KDTree lookup (preferred) add_cell_ids_to_vod â element-wise fallback add_cell_ids_to_ds_fast â dask-lazy variant for out-of-core data Vertex / grid conversion&para; extract_grid_vertices â flat (x, y, z) arrays for 3-D visualisation grid_to_dataset â xarray Dataset with vertices and solid angles add_cell_ids_to_vod_fast(vod_ds, grid, grid_name) &para; Assign grid cells to every observation in a VOD dataset (vectorised). Uses a KDTree built from the grid cell centres for O(n log m) lookup. Parameters&para; vod_ds : xr.Dataset VOD dataset with phi(epoch, sid) and theta(epoch, sid) coordinate variables and a VOD data variable. grid : GridData Hemisphere grid instance. grid_name : str Grid identifier used to name the output coordinate (cell_id_&lt;grid_name&gt;). Returns&para; xr.Dataset vod_ds with an additional cell_id_&lt;grid_name&gt;(epoch, sid) variable. Observations with non-finite Ï or Î¸ receive NaN. Source code in packages/canvod-grids/src/canvod/grids/operations.py 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154def add_cell_ids_to_vod_fast( vod_ds: xr.Dataset, grid: GridData, grid_name: str ) -&gt; xr.Dataset: &quot;&quot;&quot;Assign grid cells to every observation in a VOD dataset (vectorised). Uses a KDTree built from the grid cell centres for O(n log m) lookup. Parameters ---------- vod_ds : xr.Dataset VOD dataset with ``phi(epoch, sid)`` and ``theta(epoch, sid)`` coordinate variables and a ``VOD`` data variable. grid : GridData Hemisphere grid instance. grid_name : str Grid identifier used to name the output coordinate (``cell_id_&lt;grid_name&gt;``). Returns ------- xr.Dataset *vod_ds* with an additional ``cell_id_&lt;grid_name&gt;(epoch, sid)`` variable. Observations with non-finite Ï or Î¸ receive NaN. &quot;&quot;&quot; start_time = time.time() print(f&quot;\nAssigning cells for &#39;{grid_name}&#39;...&quot;) log.info( &quot;cell_assignment_started&quot;, grid_name=grid_name, grid_cells=len(grid.grid), observations=vod_ds[&quot;VOD&quot;].size, method=&quot;kdtree_fast&quot;, ) tree = _build_kdtree(grid) cell_id_col = grid.grid[&quot;cell_id&quot;].to_numpy() phi = vod_ds[&quot;phi&quot;].values.ravel() theta = vod_ds[&quot;theta&quot;].values.ravel() valid = np.isfinite(phi) &amp; np.isfinite(theta) cell_ids = np.full(len(phi), np.nan, dtype=np.float64) if np.any(valid): cell_ids[valid] = _query_points(tree, cell_id_col, phi[valid], theta[valid]) cell_ids_2d = cell_ids.reshape(vod_ds[&quot;VOD&quot;].shape) coord_name = f&quot;cell_id_{grid_name}&quot; vod_ds[coord_name] = ((&quot;epoch&quot;, &quot;sid&quot;), cell_ids_2d) n_assigned = np.sum(np.isfinite(cell_ids_2d)) n_unique = len(np.unique(cell_ids[np.isfinite(cell_ids)])) duration = time.time() - start_time print(f&quot; â Assigned: {n_assigned:,} / {cell_ids_2d.size:,} observations&quot;) print(f&quot; â Unique cells: {n_unique:,}&quot;) log.info( &quot;cell_assignment_complete&quot;, grid_name=grid_name, duration_seconds=round(duration, 2), observations_assigned=int(n_assigned), observations_total=cell_ids_2d.size, unique_cells=int(n_unique), coverage_percent=round(100 * n_assigned / cell_ids_2d.size, 2), ) return vod_ds add_cell_ids_to_vod(vod_ds, grid, grid_name) &para; Assign grid cells to a VOD dataset (element-wise fallback). Slower than :func:add_cell_ids_to_vod_fast; kept for cases where the full dataset does not fit in memory as numpy arrays. Parameters&para; vod_ds : xr.Dataset VOD dataset with phi, theta, and VOD variables. grid : GridData Hemisphere grid instance. grid_name : str Grid identifier for the output coordinate name. Returns&para; xr.Dataset vod_ds with cell_id_&lt;grid_name&gt;(epoch, sid) added. Source code in packages/canvod-grids/src/canvod/grids/operations.py 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210def add_cell_ids_to_vod( vod_ds: xr.Dataset, grid: GridData, grid_name: str ) -&gt; xr.Dataset: &quot;&quot;&quot;Assign grid cells to a VOD dataset (element-wise fallback). Slower than :func:`add_cell_ids_to_vod_fast`; kept for cases where the full dataset does not fit in memory as numpy arrays. Parameters ---------- vod_ds : xr.Dataset VOD dataset with ``phi``, ``theta``, and ``VOD`` variables. grid : GridData Hemisphere grid instance. grid_name : str Grid identifier for the output coordinate name. Returns ------- xr.Dataset *vod_ds* with ``cell_id_&lt;grid_name&gt;(epoch, sid)`` added. &quot;&quot;&quot; print(f&quot;\nAssigning cells for &#39;{grid_name}&#39;...&quot;) tree = _build_kdtree(grid) cell_id_col = grid.grid[&quot;cell_id&quot;].to_numpy() phi_flat = vod_ds[&quot;phi&quot;].to_numpy().ravel() theta_flat = vod_ds[&quot;theta&quot;].to_numpy().ravel() cell_ids_flat = np.full(vod_ds[&quot;VOD&quot;].size, np.nan) for i in range(len(phi_flat)): if np.isfinite(phi_flat[i]) and np.isfinite(theta_flat[i]): cell_ids_flat[i] = _query_points( tree, cell_id_col, np.array([phi_flat[i]]), np.array([theta_flat[i]]) )[0] cell_ids_2d = cell_ids_flat.reshape(vod_ds[&quot;VOD&quot;].shape) coord_name = f&quot;cell_id_{grid_name}&quot; vod_ds[coord_name] = ((&quot;epoch&quot;, &quot;sid&quot;), cell_ids_2d) n_assigned = np.sum(~np.isnan(cell_ids_2d)) print(f&quot; â Added coordinate &#39;{coord_name}&#39;&quot;) print(f&quot; â Assigned: {n_assigned:,} / {cell_ids_2d.size:,} observations&quot;) # Track grid references in dataset attrs if &quot;grid_references&quot; not in vod_ds.attrs: vod_ds.attrs[&quot;grid_references&quot;] = [] vod_ds.attrs[&quot;grid_references&quot;].append(f&quot;grids/{grid_name}&quot;) return vod_ds add_cell_ids_to_ds_fast(ds, grid, grid_name, data_var=&#39;VOD&#39;) &para; Assign grid cells lazily via dask (avoids loading full arrays). The output cell_id_&lt;grid_name&gt; variable is a dask array that computes on access or save. Parameters&para; ds : xr.Dataset Dataset with dask-backed phi and theta arrays. grid : GridData Hemisphere grid instance. grid_name : str Grid identifier for the output coordinate name. data_var : str Name of the main data variable (used only for shape reference). Returns&para; xr.Dataset ds with a lazy cell_id_&lt;grid_name&gt;(epoch, sid) variable. Source code in packages/canvod-grids/src/canvod/grids/operations.py 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291def add_cell_ids_to_ds_fast( ds: xr.Dataset, grid: GridData, grid_name: str, data_var: str = &quot;VOD&quot; ) -&gt; xr.Dataset: &quot;&quot;&quot;Assign grid cells lazily via dask (avoids loading full arrays). The output ``cell_id_&lt;grid_name&gt;`` variable is a dask array that computes on access or save. Parameters ---------- ds : xr.Dataset Dataset with dask-backed ``phi`` and ``theta`` arrays. grid : GridData Hemisphere grid instance. grid_name : str Grid identifier for the output coordinate name. data_var : str Name of the main data variable (used only for shape reference). Returns ------- xr.Dataset *ds* with a lazy ``cell_id_&lt;grid_name&gt;(epoch, sid)`` variable. &quot;&quot;&quot; import dask.array as da print(f&quot;\nAssigning cells for &#39;{grid_name}&#39;...&quot;) tree = _build_kdtree(grid) cell_id_col = grid.grid[&quot;cell_id&quot;].to_numpy() def _assign_chunk( phi_chunk: np.ndarray, theta_chunk: np.ndarray, ) -&gt; np.ndarray: &quot;&quot;&quot;Assign cell IDs for a chunk of data. Parameters ---------- phi_chunk : np.ndarray Chunk of azimuth values. theta_chunk : np.ndarray Chunk of elevation values. Returns ------- np.ndarray Chunk of cell IDs. &quot;&quot;&quot; phi_flat = phi_chunk.ravel() theta_flat = theta_chunk.ravel() valid = np.isfinite(phi_flat) &amp; np.isfinite(theta_flat) cell_ids = np.full(len(phi_flat), np.nan, dtype=np.float32) if np.any(valid): cell_ids[valid] = _query_points( tree, cell_id_col, phi_flat[valid], theta_flat[valid] ) return cell_ids.reshape(phi_chunk.shape) cell_ids_dask = da.map_blocks( _assign_chunk, ds[&quot;phi&quot;].data, ds[&quot;theta&quot;].data, dtype=np.float32, drop_axis=[], ) coord_name = f&quot;cell_id_{grid_name}&quot; ds[coord_name] = ((&quot;epoch&quot;, &quot;sid&quot;), cell_ids_dask) print(&quot; â Cell IDs assigned as lazy dask array&quot;) print(&quot; â Will compute on access/save&quot;) return ds extract_grid_vertices(grid) &para; Extract 3D vertices from hemisphere grid cells. Dispatches to a grid-typeâspecific extractor. The returned arrays are flat (not per-cell); use them directly for 3-D scatter plots. Parameters&para; grid : GridData Hemisphere grid instance. Returns&para; x_vertices, y_vertices, z_vertices : np.ndarray Cartesian vertex coordinates on the unit sphere. Source code in packages/canvod-grids/src/canvod/grids/operations.py 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328def extract_grid_vertices(grid: GridData) -&gt; tuple[np.ndarray, np.ndarray, np.ndarray]: &quot;&quot;&quot;Extract 3D vertices from hemisphere grid cells. Dispatches to a grid-typeâspecific extractor. The returned arrays are flat (not per-cell); use them directly for 3-D scatter plots. Parameters ---------- grid : GridData Hemisphere grid instance. Returns ------- x_vertices, y_vertices, z_vertices : np.ndarray Cartesian vertex coordinates on the unit sphere. &quot;&quot;&quot; extractors = { &quot;htm&quot;: _extract_htm_vertices, &quot;geodesic&quot;: _extract_geodesic_vertices, &quot;equal_area&quot;: _extract_rectangular_vertices, &quot;equal_angle&quot;: _extract_rectangular_vertices, &quot;equirectangular&quot;: _extract_rectangular_vertices, &quot;healpix&quot;: _extract_healpix_vertices, &quot;fibonacci&quot;: _extract_fibonacci_vertices, } extractor = extractors.get(grid.grid_type) if extractor is None: raise ValueError(f&quot;Unknown grid type: {grid.grid_type}&quot;) return extractor(grid) grid_to_dataset(grid) &para; Convert a HemiGrid to a unified xarray Dataset with vertices. The returned Dataset carries cell centres, NaN-padded vertex arrays, vertex counts, and solid angles â all indexed by cell_id. Parameters&para; grid : GridData Hemisphere grid instance. Returns&para; xr.Dataset Dataset with dimensions (cell_id, vertex) and variables cell_phi, cell_theta, vertices_phi, vertices_theta, n_vertices, solid_angle. Notes&para; This function is distinct from :meth:HemiGridStorageAdapter._prepare_vertices_dataframe in canvod-store. That method produces a long-form DataFrame for zarr ragged-array storage; this one produces a rectangular xarray Dataset suitable for analysis and visualisation. Source code in packages/canvod-grids/src/canvod/grids/operations.py 441 442 443 444 445 446 447 448 449 450 451 452 453 454 455 456 457 458 459 460 461 462 463 464 465 466 467 468 469 470 471 472 473 474 475 476 477 478 479 480 481 482 483 484 485 486 487 488 489 490 491 492 493 494 495 496 497 498 499 500 501 502 503 504 505 506 507 508 509 510 511 512 513 514 515 516 517 518 519 520 521 522 523 524 525 526 527 528 529 530 531 532 533 534 535 536 537 538 539 540 541 542 543 544 545 546 547 548 549 550 551 552 553 554 555 556 557 558 559 560 561 562 563 564 565 566 567 568 569 570 571 572 573 574 575 576 577 578def grid_to_dataset(grid: GridData) -&gt; xr.Dataset: &quot;&quot;&quot;Convert a HemiGrid to a unified xarray Dataset with vertices. The returned Dataset carries cell centres, NaN-padded vertex arrays, vertex counts, and solid angles â all indexed by ``cell_id``. Parameters ---------- grid : GridData Hemisphere grid instance. Returns ------- xr.Dataset Dataset with dimensions ``(cell_id, vertex)`` and variables ``cell_phi``, ``cell_theta``, ``vertices_phi``, ``vertices_theta``, ``n_vertices``, ``solid_angle``. Notes ----- This function is distinct from :meth:`HemiGridStorageAdapter._prepare_vertices_dataframe` in ``canvod-store``. That method produces a long-form DataFrame for zarr ragged-array storage; this one produces a rectangular xarray Dataset suitable for analysis and visualisation. &quot;&quot;&quot; # Reuse the commented-out logic pattern from gnssvodpy vertices.py: # extract per-cell vertices into (n_cells, max_vertices) arrays. n_cells = grid.ncells grid_type = grid.grid_type if grid_type in (&quot;equal_area&quot;, &quot;equal_angle&quot;, &quot;equirectangular&quot;): max_v = 4 vertices_phi = np.full((n_cells, max_v), np.nan) vertices_theta = np.full((n_cells, max_v), np.nan) n_vertices = np.full(n_cells, 4, dtype=np.int32) for i, row in enumerate(grid.grid.iter_rows(named=True)): phi_min, phi_max = row[&quot;phi_min&quot;], row[&quot;phi_max&quot;] theta_min, theta_max = row[&quot;theta_min&quot;], row[&quot;theta_max&quot;] vertices_phi[i, :] = [phi_min, phi_max, phi_max, phi_min] vertices_theta[i, :] = [theta_min, theta_min, theta_max, theta_max] elif grid_type == &quot;htm&quot;: max_v = 4 # padded to 4 for rectangular layout; only 3 used vertices_phi = np.full((n_cells, max_v), np.nan) vertices_theta = np.full((n_cells, max_v), np.nan) n_vertices = np.full(n_cells, 3, dtype=np.int32) for i, row in enumerate(grid.grid.iter_rows(named=True)): for j, col in enumerate([&quot;htm_vertex_0&quot;, &quot;htm_vertex_1&quot;, &quot;htm_vertex_2&quot;]): v = np.array(row[col], dtype=float) r = np.linalg.norm(v) if r == 0: continue x, y, z = v / r vertices_theta[i, j] = np.arccos(np.clip(z, -1, 1)) vertices_phi[i, j] = np.mod(np.arctan2(y, x), 2 * np.pi) elif grid_type == &quot;geodesic&quot;: max_v = 3 vertices_phi = np.full((n_cells, max_v), np.nan) vertices_theta = np.full((n_cells, max_v), np.nan) n_vertices = np.full(n_cells, 3, dtype=np.int32) shared = grid.vertices # shared vertex array from GridData if shared is not None and &quot;geodesic_vertices&quot; in grid.grid.columns: shared = np.asarray(shared, dtype=float) for i, row in enumerate(grid.grid.iter_rows(named=True)): indices = row[&quot;geodesic_vertices&quot;] for j, v_idx in enumerate(indices): v = shared[int(v_idx)] r = np.linalg.norm(v) if r == 0: continue x, y, z = v / r vertices_theta[i, j] = np.arccos(np.clip(z, -1, 1)) vertices_phi[i, j] = np.mod(np.arctan2(y, x), 2 * np.pi) else: # Fallback: use cell centres as single-point &quot;vertices&quot; n_vertices[:] = 1 vertices_phi[:, 0] = grid.grid[&quot;phi&quot;].to_numpy() vertices_theta[:, 0] = grid.grid[&quot;theta&quot;].to_numpy() elif grid_type == &quot;healpix&quot;: max_v = 4 vertices_phi = np.full((n_cells, max_v), np.nan) vertices_theta = np.full((n_cells, max_v), np.nan) n_vertices = np.full(n_cells, 4, dtype=np.int32) for i, row in enumerate(grid.grid.iter_rows(named=True)): phi_min, phi_max = row[&quot;phi_min&quot;], row[&quot;phi_max&quot;] theta_min, theta_max = row[&quot;theta_min&quot;], row[&quot;theta_max&quot;] vertices_phi[i, :] = [phi_min, phi_max, phi_max, phi_min] vertices_theta[i, :] = [theta_min, theta_min, theta_max, theta_max] elif grid_type == &quot;fibonacci&quot;: # Point-based: single vertex per cell (the centre) max_v = 1 vertices_phi = grid.grid[&quot;phi&quot;].to_numpy().reshape(n_cells, 1) vertices_theta = grid.grid[&quot;theta&quot;].to_numpy().reshape(n_cells, 1) n_vertices = np.ones(n_cells, dtype=np.int32) else: raise ValueError(f&quot;Unknown grid type: {grid_type}&quot;) # Cell centres cell_phi = grid.grid[&quot;phi&quot;].to_numpy() cell_theta = grid.grid[&quot;theta&quot;].to_numpy() solid_angles = grid.get_solid_angles() ds = xr.Dataset( { &quot;cell_phi&quot;: ([&quot;cell_id&quot;], cell_phi), &quot;cell_theta&quot;: ([&quot;cell_id&quot;], cell_theta), &quot;vertices_phi&quot;: ([&quot;cell_id&quot;, &quot;vertex&quot;], vertices_phi), &quot;vertices_theta&quot;: ([&quot;cell_id&quot;, &quot;vertex&quot;], vertices_theta), &quot;n_vertices&quot;: ([&quot;cell_id&quot;], n_vertices), &quot;solid_angle&quot;: ([&quot;cell_id&quot;], solid_angles), }, coords={ &quot;cell_id&quot;: np.arange(n_cells), &quot;vertex&quot;: np.arange(max_v), }, attrs={ &quot;grid_type&quot;: grid.grid_type, &quot;angular_resolution&quot;: ( grid.metadata.get(&quot;angular_resolution&quot;, 0.0) if grid.metadata else 0.0 ), &quot;cutoff_theta&quot;: ( grid.metadata.get(&quot;cutoff_theta&quot;, 0.0) if grid.metadata else 0.0 ), &quot;n_cells&quot;: n_cells, }, ) return ds store_grid(grid, store, grid_name) &para; Store grid in unified xarray format to Icechunk store. Converts the grid to an xarray Dataset with vertex information and writes it to the grids/ group in the store. Parameters&para; grid : GridData Hemisphere grid instance to store. store Icechunk store instance (e.g., MyIcechunkStore). grid_name : str Grid identifier for storage path (e.g., 'equal_area_4deg'). Returns&para; str Snapshot ID from the commit. Examples&para; from canvod.grids import create_hemigrid, store_grid grid = create_hemigrid(angular_resolution=4, grid_type='equal_area') snapshot_id = store_grid(grid, my_store, 'equal_area_4deg') Source code in packages/canvod-grids/src/canvod/grids/operations.py 586 587 588 589 590 591 592 593 594 595 596 597 598 599 600 601 602 603 604 605 606 607 608 609 610 611 612 613 614 615 616 617 618 619 620 621 622 623 624 625 626 627 628 629 630 631 632 633 634 635def store_grid( grid: GridData, store: Any, grid_name: str, ) -&gt; str: &quot;&quot;&quot;Store grid in unified xarray format to Icechunk store. Converts the grid to an xarray Dataset with vertex information and writes it to the ``grids/`` group in the store. Parameters ---------- grid : GridData Hemisphere grid instance to store. store Icechunk store instance (e.g., MyIcechunkStore). grid_name : str Grid identifier for storage path (e.g., &#39;equal_area_4deg&#39;). Returns ------- str Snapshot ID from the commit. Examples -------- &gt;&gt;&gt; from canvod.grids import create_hemigrid, store_grid &gt;&gt;&gt; grid = create_hemigrid(angular_resolution=4, grid_type=&#39;equal_area&#39;) &gt;&gt;&gt; snapshot_id = store_grid(grid, my_store, &#39;equal_area_4deg&#39;) &quot;&quot;&quot; print(f&quot;\nStoring grid &#39;{grid_name}&#39;...&quot;) # Convert to unified xarray format ds_grid = grid_to_dataset(grid) # Store in grids/ directory group_path = f&quot;grids/{grid_name}&quot; with store.writable_session() as session: from icechunk.xarray import to_icechunk to_icechunk(ds_grid, session, group=group_path, mode=&quot;w&quot;) snapshot_id = session.commit(f&quot;Stored {grid_name} grid structure&quot;) print(f&quot; â Stored to &#39;{group_path}&#39;&quot;) print(f&quot; â Snapshot: {snapshot_id[:8]}...&quot;) print(f&quot; â Cells: {grid.ncells}, Type: {grid.grid_type}&quot;) return snapshot_id load_grid(store, grid_name) &para; Load a grid from Icechunk store. Loads the grid structure from grids/{grid_name} and reconstructs a GridData object. Parameters&para; store Icechunk store instance (e.g., MyIcechunkStore). grid_name : str Grid identifier (e.g., 'equal_area_4deg'). Returns&para; GridData Reconstructed grid instance. Examples&para; from canvod.grids import load_grid grid = load_grid(my_store, 'equal_area_4deg') print(f"Loaded {grid.ncells} cells") Source code in packages/canvod-grids/src/canvod/grids/operations.py 638 639 640 641 642 643 644 645 646 647 648 649 650 651 652 653 654 655 656 657 658 659 660 661 662 663 664 665 666 667 668 669 670 671 672 673 674 675 676 677 678 679 680 681 682 683 684 685 686 687 688 689 690 691 692 693 694 695 696 697 698 699 700 701 702 703 704 705 706 707 708 709 710 711 712 713 714 715 716 717 718 719 720 721 722 723 724 725 726 727 728 729 730 731 732 733 734 735 736 737 738 739 740 741 742 743 744 745 746 747 748 749 750 751 752 753 754 755 756 757 758 759 760 761 762 763 764 765 766 767 768 769 770 771 772 773 774 775 776 777 778 779 780 781 782 783 784def load_grid( store: Any, grid_name: str, ) -&gt; GridData: &quot;&quot;&quot;Load a grid from Icechunk store. Loads the grid structure from ``grids/{grid_name}`` and reconstructs a GridData object. Parameters ---------- store Icechunk store instance (e.g., MyIcechunkStore). grid_name : str Grid identifier (e.g., &#39;equal_area_4deg&#39;). Returns ------- GridData Reconstructed grid instance. Examples -------- &gt;&gt;&gt; from canvod.grids import load_grid &gt;&gt;&gt; grid = load_grid(my_store, &#39;equal_area_4deg&#39;) &gt;&gt;&gt; print(f&quot;Loaded {grid.ncells} cells&quot;) &quot;&quot;&quot; import polars as pl print(f&quot;\nLoading grid &#39;{grid_name}&#39;...&quot;) group_path = f&quot;grids/{grid_name}&quot; # Load from store with store.readonly_session() as session: ds_grid = xr.open_zarr(session.store, group=group_path, consolidated=False) # Extract metadata grid_type = ds_grid.attrs.get(&quot;grid_type&quot;) angular_resolution = ds_grid.attrs.get(&quot;angular_resolution&quot;, 0.0) cutoff_theta = ds_grid.attrs.get(&quot;cutoff_theta&quot;, np.pi / 2) if not grid_type: raise ValueError(f&quot;Grid &#39;{grid_name}&#39; missing grid_type attribute&quot;) # Reconstruct grid DataFrame from cell centers cell_phi = ds_grid[&quot;cell_phi&quot;].values cell_theta = ds_grid[&quot;cell_theta&quot;].values n_cells = len(cell_phi) # Build basic grid DataFrame grid_data = { &quot;cell_id&quot;: np.arange(n_cells), &quot;phi&quot;: cell_phi, &quot;theta&quot;: cell_theta, } # Add grid-type-specific columns if grid_type in (&quot;equal_area&quot;, &quot;equal_angle&quot;, &quot;equirectangular&quot;): # Reconstruct boundaries from vertices vertices_phi = ds_grid[&quot;vertices_phi&quot;].values vertices_theta = ds_grid[&quot;vertices_theta&quot;].values phi_min = vertices_phi[:, 0] # All 4 vertices are corners phi_max = vertices_phi[:, 1] theta_min = vertices_theta[:, 0] theta_max = vertices_theta[:, 2] grid_data.update( { &quot;phi_min&quot;: phi_min, &quot;phi_max&quot;: phi_max, &quot;theta_min&quot;: theta_min, &quot;theta_max&quot;: theta_max, } ) elif grid_type == &quot;htm&quot;: # Reconstruct HTM vertices from spherical to Cartesian vertices_phi = ds_grid[&quot;vertices_phi&quot;].values vertices_theta = ds_grid[&quot;vertices_theta&quot;].values htm_v0 = [] htm_v1 = [] htm_v2 = [] for i in range(n_cells): vertices = [] for j in range(3): phi_v = vertices_phi[i, j] theta_v = vertices_theta[i, j] x = np.sin(theta_v) * np.cos(phi_v) y = np.sin(theta_v) * np.sin(phi_v) z = np.cos(theta_v) vertices.append([x, y, z]) htm_v0.append(vertices[0]) htm_v1.append(vertices[1]) htm_v2.append(vertices[2]) grid_data.update( { &quot;htm_vertex_0&quot;: htm_v0, &quot;htm_vertex_1&quot;: htm_v1, &quot;htm_vertex_2&quot;: htm_v2, } ) # Create Polars DataFrame df_grid = pl.DataFrame(grid_data) # Reconstruct theta_lims, phi_lims, and cell_ids from grid # These are required for GridData but not critical for basic usage unique_theta = sorted(df_grid[&quot;theta&quot;].unique().to_list()) theta_lims = np.array(unique_theta) # Group cells by theta bin phi_lims_list = [] cell_ids_list = [] for theta_val in unique_theta: theta_cells = df_grid.filter(pl.col(&quot;theta&quot;) == theta_val) phi_vals = sorted(theta_cells[&quot;phi&quot;].to_list()) cell_ids = theta_cells[&quot;cell_id&quot;].to_list() phi_lims_list.append(np.array(phi_vals)) cell_ids_list.append(np.array(cell_ids)) # Create GridData instance from canvod.grids.core import GridData grid = GridData( grid=df_grid, theta_lims=theta_lims, phi_lims=phi_lims_list, cell_ids=cell_ids_list, grid_type=grid_type, metadata={ &quot;angular_resolution&quot;: angular_resolution, &quot;cutoff_theta&quot;: cutoff_theta, }, ) print(f&quot; â Loaded from &#39;{group_path}&#39;&quot;) print(f&quot; â Cells: {grid.ncells}, Type: {grid.grid_type}&quot;) return grid (resolution) means
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder--mathematical-construction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mathematical construction
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder.get_grid_type" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_grid_type
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_grid_type">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder.get_grid_type--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder.get_healpix_info" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_healpix_info
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_healpix_info">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder.get_healpix_info--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#geodesic-grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        Geodesic Grid
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.geodesic_grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        geodesic_grid
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        GeodesicBuilder
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="GeodesicBuilder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder--coordinate-convention-physics-gnss" class="md-nav__link">
    <span class="md-ellipsis">
      
        Coordinate convention (physics / GNSS)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder--what-angular_resolution-means" class="md-nav__link">
    <span class="md-ellipsis">
      
        What Equal-area grid implementation. EqualAreaBuilder &para; Bases: BaseGridBuilder Equal solid angle tessellation using concentric theta bands. The hemisphere is divided into annular bands of constant width in theta. Within each band the number of azimuthal (phi) sectors is chosen so that every cell subtends approximately the same solid angle. This is the only grid type that has been validated for scientific use in this codebase. Coordinate convention (physics / GNSS)&para; phi â [0, 2Ï) â azimuthal angle measured from East, counter-clockwise theta â [0, Ï/2] â polar angle measured from zenith (0 = straight up, Ï/2 = horizon) What angular_resolution means&para; angular_resolution (degrees) sets the width of each theta band. All bands have this same width ÎÎ¸. The azimuthal width of cells varies by band: near the zenith cells are wide in phi; near the horizon they are narrow, so that the solid angle stays constant. Mathematical construction&para; Target solid angle per cell is chosen equal to the solid angle of a cap of half-angle ÎÎ¸/2:: Î©_target = 2Ï (1 â cos(ÎÎ¸/2)) Zenith cap â a single cell covers [0, ÎÎ¸/2] in theta and the full azimuth [0, 2Ï). Theta bands â edges are placed at ÎÎ¸/2, 3ÎÎ¸/2, 5ÎÎ¸/2, â¦ up to Ï/2 â cutoff_theta. For each band [Î¸_inner, Î¸_outer] the band's total solid angle is:: Î©_band = 2Ï (cos Î¸_inner â cos Î¸_outer) Phi divisions â the number of sectors in the band is:: n_phi = round(Î©_band / Î©_target) Each sector spans ÎÏ = 2Ï / n_phi. The cell centre is placed at the geometric midpoint of its (phi, theta) rectangle. Parameters&para; angular_resolution : float Theta-band width in degrees. Controls both the radial resolution and (indirectly, via the equal-area constraint) the azimuthal resolution. cutoff_theta : float Minimum elevation above the horizon in degrees. Bands whose outer edge is at or below this cutoff are omitted. In GNSS terms this is the satellite elevation mask angle. phi_rotation : float Rigid rotation applied to all phi coordinates after grid construction, in degrees. Source code in packages/canvod-grids/src/canvod/grids/grids_impl/equal_area_grid.py 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182class EqualAreaBuilder(BaseGridBuilder): &quot;&quot;&quot;Equal solid angle tessellation using concentric theta bands. The hemisphere is divided into annular bands of constant width in theta. Within each band the number of azimuthal (phi) sectors is chosen so that every cell subtends approximately the same solid angle. This is the only grid type that has been validated for scientific use in this codebase. Coordinate convention (physics / GNSS) --------------------------------------- * phi â [0, 2Ï) â azimuthal angle measured from East, counter-clockwise * theta â [0, Ï/2] â polar angle measured from zenith (0 = straight up, Ï/2 = horizon) What ``angular_resolution`` means ---------------------------------- ``angular_resolution`` (degrees) sets the **width of each theta band**. All bands have this same width ÎÎ¸. The *azimuthal* width of cells varies by band: near the zenith cells are wide in phi; near the horizon they are narrow, so that the solid angle stays constant. Mathematical construction ------------------------- 1. **Target solid angle** per cell is chosen equal to the solid angle of a cap of half-angle ÎÎ¸/2:: Î©_target = 2Ï (1 â cos(ÎÎ¸/2)) 2. **Zenith cap** â a single cell covers [0, ÎÎ¸/2] in theta and the full azimuth [0, 2Ï). 3. **Theta bands** â edges are placed at ÎÎ¸/2, 3ÎÎ¸/2, 5ÎÎ¸/2, â¦ up to Ï/2 â cutoff_theta. For each band [Î¸_inner, Î¸_outer] the band&#39;s total solid angle is:: Î©_band = 2Ï (cos Î¸_inner â cos Î¸_outer) 4. **Phi divisions** â the number of sectors in the band is:: n_phi = round(Î©_band / Î©_target) Each sector spans ÎÏ = 2Ï / n_phi. The cell centre is placed at the geometric midpoint of its (phi, theta) rectangle. Parameters ---------- angular_resolution : float Theta-band width in degrees. Controls both the radial resolution and (indirectly, via the equal-area constraint) the azimuthal resolution. cutoff_theta : float Minimum elevation above the horizon in degrees. Bands whose outer edge is at or below this cutoff are omitted. In GNSS terms this is the satellite elevation mask angle. phi_rotation : float Rigid rotation applied to all phi coordinates after grid construction, in degrees. &quot;&quot;&quot; def get_grid_type(self) -&gt; str: &quot;&quot;&quot;Return the grid-type identifier string. Returns ------- str ``&quot;equal_area&quot;`` &quot;&quot;&quot; return GridType.EQUAL_AREA.value def _build_grid( self, ) -&gt; tuple[pl.DataFrame, np.ndarray, list[np.ndarray], list[np.ndarray]]: &quot;&quot;&quot;Construct the equal-area hemisphere grid. Returns ------- grid : pl.DataFrame One row per cell with columns: phi, theta, phi_min, phi_max, theta_min, theta_max, cell_id. theta_lims : np.ndarray Outer theta edge of each band (radians). phi_lims : list[np.ndarray] Array of phi_min values for each band. cell_ids : list[np.ndarray] Cell-id arrays, one per band. &quot;&quot;&quot; # Theta band edges (from zenith to horizon) max_theta = np.pi / 2 # horizon theta_edges = np.arange( self.angular_resolution_rad / 2, max_theta - self.cutoff_theta_rad, self.angular_resolution_rad, ) # Target solid angle per cell target_omega = 2 * np.pi * (1 - np.cos(self.angular_resolution_rad / 2)) cells = [] theta_lims = [] phi_lims = [] cell_ids = [] # Zenith cell (special case) - only if cutoff allows next_cell_id = 0 zenith_theta_max = self.angular_resolution_rad / 2 if self.cutoff_theta_rad &lt; zenith_theta_max: cells.append( pl.DataFrame( { &quot;phi&quot;: [0.0], &quot;theta&quot;: [0.0], &quot;phi_min&quot;: [0.0], &quot;phi_max&quot;: [2 * np.pi], &quot;theta_min&quot;: [max(0.0, self.cutoff_theta_rad)], &quot;theta_max&quot;: [zenith_theta_max], } ) ) theta_lims.append(zenith_theta_max) phi_lims.append(np.array([0.0])) cell_ids.append(np.array([0])) next_cell_id = 1 # Build theta bands for iband, theta_outer in enumerate(theta_edges[1:]): theta_inner = theta_edges[iband] # Skip bands below cutoff if theta_outer &lt;= self.cutoff_theta_rad: continue # Solid angle of this band band_omega = 2 * np.pi * (np.cos(theta_inner) - np.cos(theta_outer)) # Number of phi divisions n_phi = max(1, round(band_omega / target_omega)) phi_span = 2 * np.pi / n_phi cell_id_list = list(range(next_cell_id, next_cell_id + n_phi)) next_cell_id = cell_id_list[-1] + 1 # Use arange for better precision than linspace phi_min_arr = np.arange(n_phi) * phi_span phi_max_arr = (np.arange(n_phi) + 1) * phi_span phi_max_arr[-1] = 2 * np.pi # Force exact closure cells.append( pl.DataFrame( { &quot;phi&quot;: (phi_min_arr + phi_max_arr) / 2, &quot;theta&quot;: np.full(n_phi, (theta_inner + theta_outer) / 2), &quot;phi_min&quot;: phi_min_arr, &quot;phi_max&quot;: phi_max_arr, &quot;theta_min&quot;: np.full(n_phi, theta_inner), &quot;theta_max&quot;: np.full(n_phi, theta_outer), } ) ) theta_lims.append(theta_outer) phi_lims.append(phi_min_arr) cell_ids.append(np.array(cell_id_list)) if len(cells) == 0: raise ValueError( &quot;No cells generated - check cutoff_theta and angular_resolution&quot; ) grid = pl.concat(cells).with_columns(pl.int_range(0, pl.len()).alias(&quot;cell_id&quot;)) return grid, np.array(theta_lims), phi_lims, cell_ids get_grid_type() &para; Return the grid-type identifier string. Returns&para; str "equal_area" Source code in packages/canvod-grids/src/canvod/grids/grids_impl/equal_area_grid.py 68 69 70 71 72 73 74 75 76 77def get_grid_type(self) -&gt; str: &quot;&quot;&quot;Return the grid-type identifier string. Returns ------- str ``&quot;equal_area&quot;`` &quot;&quot;&quot; return GridType.EQUAL_AREA.value means
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder--mathematical-construction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mathematical construction
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder--notes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder.get_triangles" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_triangles
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_triangles">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder.get_triangles--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder.get_grid_type" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_grid_type
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_grid_type">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder.get_grid_type--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#fibonacci-grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        Fibonacci Grid
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.fibonacci_grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        fibonacci_grid
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        FibonacciBuilder
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FibonacciBuilder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder--coordinate-convention-physics-gnss" class="md-nav__link">
    <span class="md-ellipsis">
      
        Coordinate convention (physics / GNSS)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder--what-n_points-resolution-means" class="md-nav__link">
    <span class="md-ellipsis">
      
        What Equal-angle grid implementation. EqualAngleBuilder &para; Bases: BaseGridBuilder Equal angular spacing in both theta and phi (NOT equal area). Every cell is a rectangle of the same angular size ÎÎ¸ Ã ÎÏ in the (theta, phi) parameter space. Because solid angle depends on cos(theta), cells near the zenith subtend more solid angle than cells near the horizon. This makes the grid biased toward the zenith for any solid-angle-weighted statistic. Not recommended for scientific analysis â use EqualAreaBuilder instead. Coordinate convention (physics / GNSS)&para; phi â [0, 2Ï) â azimuthal angle from East, counter-clockwise theta â [0, Ï/2] â polar angle from zenith What angular_resolution means&para; angular_resolution (degrees) is used as both the theta-band width and the phi-sector width. The number of phi divisions is constant across all bands:: n_phi = round(2Ï / ÎÎ¸) and does not change with latitude. Mathematical construction&para; A zenith cap cell covers [0, ÎÎ¸/2] Ã [0, 2Ï). Theta band edges are placed at ÎÎ¸/2, 3ÎÎ¸/2, â¦ up to Ï/2. Within every band, the full azimuth is split into n_phi sectors of equal width ÎÏ = 2Ï / n_phi. Cell centres are at the midpoint of each (phi, theta) rectangle. Parameters&para; angular_resolution : float Angular spacing in degrees, applied identically in both theta and phi. cutoff_theta : float Elevation mask angle in degrees (bands below this are omitted). phi_rotation : float Rigid azimuthal rotation applied after construction, in degrees. Source code in packages/canvod-grids/src/canvod/grids/grids_impl/equal_angle_grid.py 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144class EqualAngleBuilder(BaseGridBuilder): &quot;&quot;&quot;Equal angular spacing in both theta and phi (NOT equal area). Every cell is a rectangle of the same angular size ÎÎ¸ Ã ÎÏ in the (theta, phi) parameter space. Because solid angle depends on cos(theta), cells near the zenith subtend *more* solid angle than cells near the horizon. This makes the grid biased toward the zenith for any solid-angle-weighted statistic. **Not recommended for scientific analysis** â use ``EqualAreaBuilder`` instead. Coordinate convention (physics / GNSS) --------------------------------------- * phi â [0, 2Ï) â azimuthal angle from East, counter-clockwise * theta â [0, Ï/2] â polar angle from zenith What ``angular_resolution`` means ---------------------------------- ``angular_resolution`` (degrees) is used as **both** the theta-band width and the phi-sector width. The number of phi divisions is constant across all bands:: n_phi = round(2Ï / ÎÎ¸) and does not change with latitude. Mathematical construction ------------------------- 1. A zenith cap cell covers [0, ÎÎ¸/2] Ã [0, 2Ï). 2. Theta band edges are placed at ÎÎ¸/2, 3ÎÎ¸/2, â¦ up to Ï/2. 3. Within every band, the full azimuth is split into ``n_phi`` sectors of equal width ÎÏ = 2Ï / n_phi. 4. Cell centres are at the midpoint of each (phi, theta) rectangle. Parameters ---------- angular_resolution : float Angular spacing in degrees, applied identically in both theta and phi. cutoff_theta : float Elevation mask angle in degrees (bands below this are omitted). phi_rotation : float Rigid azimuthal rotation applied after construction, in degrees. &quot;&quot;&quot; def get_grid_type(self) -&gt; str: &quot;&quot;&quot;Return the grid-type identifier string. Returns ------- str ``&quot;equal_angle&quot;`` &quot;&quot;&quot; return GridType.EQUAL_ANGLE.value def _build_grid( self, ) -&gt; tuple[pl.DataFrame, np.ndarray, list[np.ndarray], list[np.ndarray]]: &quot;&quot;&quot;Construct the equal-angle hemisphere grid. Returns ------- grid : pl.DataFrame One row per cell. theta_lims : np.ndarray Outer theta edge of each band (radians). phi_lims : list[np.ndarray] Array of phi_min values for each band (identical across bands). cell_ids : list[np.ndarray] Cell-id arrays, one per band. &quot;&quot;&quot; max_theta = np.pi / 2 theta_edges = np.arange( self.angular_resolution_rad / 2, max_theta - self.cutoff_theta_rad, self.angular_resolution_rad, ) n_phi_divisions = int(2 * np.pi / self.angular_resolution_rad) cells = [] theta_lims = [] phi_lims = [] cell_ids = [] # Zenith cells.append( pl.DataFrame( { &quot;phi&quot;: [0.0], &quot;theta&quot;: [0.0], &quot;phi_min&quot;: [0.0], &quot;phi_max&quot;: [2 * np.pi], &quot;theta_min&quot;: [0.0], &quot;theta_max&quot;: [self.angular_resolution_rad / 2], } ) ) theta_lims.append(self.angular_resolution_rad / 2) phi_lims.append(np.array([0.0])) cell_ids.append(np.array([0])) next_cell_id = 1 for iband, theta_outer in enumerate(theta_edges[1:]): theta_inner = theta_edges[iband] phi_span = 2 * np.pi / n_phi_divisions cell_id_list = list(range(next_cell_id, next_cell_id + n_phi_divisions)) next_cell_id = cell_id_list[-1] + 1 phi_min_arr = np.linspace(0, 2 * np.pi - phi_span, n_phi_divisions) phi_max_arr = np.concatenate((phi_min_arr[1:], [2 * np.pi])) cells.append( pl.DataFrame( { &quot;phi&quot;: (phi_min_arr + phi_max_arr) / 2, &quot;theta&quot;: np.full( n_phi_divisions, (theta_inner + theta_outer) / 2, ), &quot;phi_min&quot;: phi_min_arr, &quot;phi_max&quot;: phi_max_arr, &quot;theta_min&quot;: np.full(n_phi_divisions, theta_inner), &quot;theta_max&quot;: np.full(n_phi_divisions, theta_outer), } ) ) theta_lims.append(theta_outer) phi_lims.append(phi_min_arr) cell_ids.append(np.array(cell_id_list)) grid = pl.concat(cells).with_row_index(&quot;cell_id&quot;) return grid, np.array(theta_lims), phi_lims, cell_ids get_grid_type() &para; Return the grid-type identifier string. Returns&para; str "equal_angle" Source code in packages/canvod-grids/src/canvod/grids/grids_impl/equal_angle_grid.py 53 54 55 56 57 58 59 60 61 62def get_grid_type(self) -&gt; str: &quot;&quot;&quot;Return the grid-type identifier string. Returns ------- str ``&quot;equal_angle&quot;`` &quot;&quot;&quot; return GridType.EQUAL_ANGLE.value (resolution) means
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder--mathematical-construction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mathematical construction
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder--notes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder.get_grid_type" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_grid_type
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_grid_type">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder.get_grid_type--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#htm-grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        HTM Grid
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.htm_grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        htm_grid
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.htm_grid.HTMBuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        HTMBuilder
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="HTMBuilder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.htm_grid.HTMBuilder--coordinate-convention-physics-gnss" class="md-nav__link">
    <span class="md-ellipsis">
      
        Coordinate convention (physics / GNSS)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.htm_grid.HTMBuilder--what-htm_level-resolution-means" class="md-nav__link">
    <span class="md-ellipsis">
      
        What HEALPix grid implementation. HEALPixBuilder &para; Bases: BaseGridBuilder HEALPix tessellation (Hierarchical Equal Area isoLatitude Pixelization). HEALPix partitions the sphere into 12 base pixels arranged at equal latitudes. Each base pixel is recursively subdivided into 4 children, producing 12 Ã nsideÂ² pixels on the full sphere, all with exactly the same solid angle. This strict equal-area property makes HEALPix the gold standard for pixelisations that must be unbiased under solid-angle weighting. This builder delegates the pixel geometry entirely to the healpy library. It filters the full-sphere pixelisation down to the northern hemisphere and stores approximate bounding boxes (phi_min/max, theta_min/max) derived from the pixel resolution. The bounding boxes are not the true pixel boundaries (which are curvilinear); they are only approximations suitable for quick spatial queries. For exact pixel membership use healpy.ang2pix directly. Coordinate convention&para; HEALPix natively uses colatitude theta â [0, Ï] (0 = North Pole) and longitude phi â [0, 2Ï). This matches the GNSS convention used elsewhere in canvodpy: theta = 0 is the zenith, theta = Ï/2 is the horizon. No coordinate transform is applied. What nside (resolution) means&para; nside is the single resolution parameter of HEALPix. It must be a power of 2. The key derived quantities are:: n_pixels = 12 Ã nsideÂ² (full sphere) pixel_area = 4Ï / n_pixels (steradians, exact) resolution â â(pixel_area) (approximate angular diameter) â 58.6Â° / nside (degrees) nside Pixels (full) Approx resolution Pixel area (sr) 1 12 58.6Â° 1.049 2 48 29.3Â° 0.262 4 192 14.7Â° 0.065 8 768 7.3Â° 0.016 16 3 072 3.7Â° 0.004 32 12 288 1.8Â° 0.001 When nside is not provided, it is estimated from angular_resolution and rounded to the nearest power of 2:: nside_estimate = round_to_pow2( â(3/Ï) Ã 60 / angular_resolution ) Mathematical construction&para; HEALPix construction is performed entirely by healpy. At a high level: The sphere is divided into 12 congruent base pixels (a curvilinear quadrilateral arrangement at three latitude zones: polar caps and equatorial belt). Each base pixel is subdivided into nsideÂ² equal-area children using a hierarchical quadtree. Pixel centres are returned by healpy.pix2ang(nside, ipix) in RING ordering (pixels ordered by increasing colatitude). This builder keeps only pixels with theta â¤ Ï/2 â cutoff_theta (northern hemisphere above the elevation mask). Parameters&para; angular_resolution : float Approximate angular resolution in degrees. Used only to derive nside when that parameter is not given explicitly. cutoff_theta : float Elevation mask angle in degrees. Pixels with colatitude theta &gt; Ï/2 â cutoff_theta (i.e. below the mask) are excluded. nside : int or None HEALPix resolution parameter. Must be a power of 2. If None, estimated from angular_resolution. phi_rotation : float Rigid azimuthal rotation applied after construction, in degrees. Raises&para; ImportError If healpy is not installed. ValueError If nside is not a power of 2. Source code in packages/canvod-grids/src/canvod/grids/grids_impl/healpix_grid.py 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256class HEALPixBuilder(BaseGridBuilder): &quot;&quot;&quot;HEALPix tessellation (Hierarchical Equal Area isoLatitude Pixelization). HEALPix partitions the sphere into 12 base pixels arranged at equal latitudes. Each base pixel is recursively subdivided into 4 children, producing ``12 Ã nsideÂ²`` pixels on the full sphere, all with *exactly* the same solid angle. This strict equal-area property makes HEALPix the gold standard for pixelisations that must be unbiased under solid-angle weighting. This builder delegates the pixel geometry entirely to the ``healpy`` library. It filters the full-sphere pixelisation down to the northern hemisphere and stores approximate bounding boxes (``phi_min/max``, ``theta_min/max``) derived from the pixel resolution. The bounding boxes are **not** the true pixel boundaries (which are curvilinear); they are only approximations suitable for quick spatial queries. For exact pixel membership use ``healpy.ang2pix`` directly. Coordinate convention --------------------- HEALPix natively uses colatitude ``theta â [0, Ï]`` (0 = North Pole) and longitude ``phi â [0, 2Ï)``. This matches the GNSS convention used elsewhere in canvodpy: theta = 0 is the zenith, theta = Ï/2 is the horizon. **No coordinate transform is applied.** What ``nside`` (resolution) means ---------------------------------- ``nside`` is the single resolution parameter of HEALPix. It must be a power of 2. The key derived quantities are:: n_pixels = 12 Ã nsideÂ² (full sphere) pixel_area = 4Ï / n_pixels (steradians, exact) resolution â â(pixel_area) (approximate angular diameter) â 58.6Â° / nside (degrees) | nside | Pixels (full) | Approx resolution | Pixel area (sr) | |-------|---------------|-------------------|-----------------| | 1 | 12 | 58.6Â° | 1.049 | | 2 | 48 | 29.3Â° | 0.262 | | 4 | 192 | 14.7Â° | 0.065 | | 8 | 768 | 7.3Â° | 0.016 | | 16 | 3 072 | 3.7Â° | 0.004 | | 32 | 12 288 | 1.8Â° | 0.001 | When ``nside`` is not provided, it is estimated from ``angular_resolution`` and rounded to the nearest power of 2:: nside_estimate = round_to_pow2( â(3/Ï) Ã 60 / angular_resolution ) Mathematical construction ------------------------- HEALPix construction is performed entirely by ``healpy``. At a high level: 1. The sphere is divided into 12 congruent base pixels (a curvilinear quadrilateral arrangement at three latitude zones: polar caps and equatorial belt). 2. Each base pixel is subdivided into ``nsideÂ²`` equal-area children using a hierarchical quadtree. 3. Pixel centres are returned by ``healpy.pix2ang(nside, ipix)`` in RING ordering (pixels ordered by increasing colatitude). 4. This builder keeps only pixels with ``theta â¤ Ï/2 â cutoff_theta`` (northern hemisphere above the elevation mask). Parameters ---------- angular_resolution : float Approximate angular resolution in degrees. Used only to derive ``nside`` when that parameter is not given explicitly. cutoff_theta : float Elevation mask angle in degrees. Pixels with colatitude ``theta &gt; Ï/2 â cutoff_theta`` (i.e. below the mask) are excluded. nside : int or None HEALPix resolution parameter. Must be a power of 2. If ``None``, estimated from ``angular_resolution``. phi_rotation : float Rigid azimuthal rotation applied after construction, in degrees. Raises ------ ImportError If ``healpy`` is not installed. ValueError If ``nside`` is not a power of 2. &quot;&quot;&quot; def __init__( self, angular_resolution: float = 2, cutoff_theta: float = 0, nside: int | None = None, phi_rotation: float = 0, ) -&gt; None: &quot;&quot;&quot;Initialize the HEALPix grid builder. Parameters ---------- angular_resolution : float, default 2 Angular resolution in degrees. cutoff_theta : float, default 0 Maximum polar angle cutoff in degrees. nside : int | None, optional HEALPix nside parameter. phi_rotation : float, default 0 Rotation angle in degrees. &quot;&quot;&quot; super().__init__(angular_resolution, cutoff_theta, phi_rotation) # Determine nside if nside is None: nside_estimate = int(np.sqrt(3 / np.pi) * 60 / angular_resolution) self.nside = 2 ** max(0, int(np.round(np.log2(nside_estimate)))) else: if nside &lt; 1 or (nside &amp; (nside - 1)) != 0: raise ValueError(f&quot;nside must be a power of 2, got {nside}&quot;) self.nside = nside # Import healpy try: import healpy as hp self.hp = hp except ImportError: raise ImportError( &quot;healpy is required for HEALPix grid. Install with: pip install healpy&quot; ) pixel_size_arcmin = self.hp.nside2resol(self.nside, arcmin=True) self.actual_angular_resolution = pixel_size_arcmin / 60.0 self._logger.info( f&quot;HEALPix: nside={self.nside}, &quot; f&quot;requested_res={angular_resolution:.2f}Â°, &quot; f&quot;actual_res={self.actual_angular_resolution:.2f}Â°&quot; ) def get_grid_type(self) -&gt; str: &quot;&quot;&quot;Return the grid-type identifier string. Returns ------- str ``&quot;healpix&quot;`` &quot;&quot;&quot; return GridType.HEALPIX.value def _build_grid( self, ) -&gt; tuple[pl.DataFrame, np.ndarray, list[np.ndarray], list[np.ndarray]]: &quot;&quot;&quot;Build HEALPix grid for the northern hemisphere. Iterates over all ``12 Ã nsideÂ²`` pixels, retains those with ``theta â¤ Ï/2 â cutoff_theta``, and constructs approximate bounding boxes from the pixel resolution. Returns ------- grid : pl.DataFrame One row per pixel. Contains phi, theta (centre), approximate bounding-box limits, ``healpix_ipix`` (RING-ordered pixel index), and ``healpix_nside``. theta_lims : np.ndarray Synthetic evenly-spaced theta limits (interface compatibility only). phi_lims : list[np.ndarray] Synthetic evenly-spaced phi limits (interface compatibility only). cell_ids : list[np.ndarray] Single-element list containing the valid pixel indices. &quot;&quot;&quot; npix = self.hp.nside2npix(self.nside) cells = [] valid_pixels = [] for ipix in range(npix): theta, phi = self.hp.pix2ang(self.nside, ipix) # Keep only northern hemisphere above the elevation mask if theta &gt; (np.pi / 2 - self.cutoff_theta_rad): continue pixel_radius = self.hp.nside2resol(self.nside) cells.append( { &quot;phi&quot;: float(phi), &quot;theta&quot;: float(theta), &quot;phi_min&quot;: float(max(0, phi - pixel_radius / 2)), &quot;phi_max&quot;: float(min(2 * np.pi, phi + pixel_radius / 2)), &quot;theta_min&quot;: float(max(0, theta - pixel_radius / 2)), &quot;theta_max&quot;: float(min(np.pi / 2, theta + pixel_radius / 2)), &quot;healpix_ipix&quot;: int(ipix), &quot;healpix_nside&quot;: int(self.nside), } ) valid_pixels.append(int(ipix)) if len(cells) == 0: raise ValueError(&quot;No valid HEALPix pixels found in hemisphere&quot;) grid = pl.DataFrame(cells) grid = grid.with_columns( [ pl.col(&quot;healpix_ipix&quot;).cast(pl.Int64), pl.col(&quot;healpix_nside&quot;).cast(pl.Int64), ] ) theta_unique = sorted(grid[&quot;theta&quot;].unique()) n_theta_bands = len(theta_unique) # NOTE: These limits are SYNTHETIC and do NOT correspond to actual # HEALPix pixel boundaries. They exist only for interface # compatibility with ring-based grids. For spatial queries, use the # per-pixel theta_min/max and phi_min/max columns instead. theta_lims = np.linspace(0, np.pi / 2, min(n_theta_bands, 20)) phi_lims = [np.linspace(0, 2 * np.pi, 20) for _ in range(len(theta_lims))] cell_ids_list = [np.array(valid_pixels, dtype=np.int64)] return grid, theta_lims, phi_lims, cell_ids_list def get_healpix_info(self) -&gt; dict: &quot;&quot;&quot;Get HEALPix-specific information. Returns ------- info : dict Keys: ``nside``, ``npix_total``, ``pixel_area_sr``, ``pixel_area_arcmin2``, ``resolution_arcmin``, ``resolution_deg``, ``max_pixel_radius_deg``. &quot;&quot;&quot; return { &quot;nside&quot;: self.nside, &quot;npix_total&quot;: self.hp.nside2npix(self.nside), &quot;pixel_area_sr&quot;: self.hp.nside2pixarea(self.nside), &quot;pixel_area_arcmin2&quot;: ( self.hp.nside2pixarea(self.nside, degrees=True) * 3600 ), &quot;resolution_arcmin&quot;: self.hp.nside2resol(self.nside, arcmin=True), &quot;resolution_deg&quot;: self.actual_angular_resolution, &quot;max_pixel_radius_deg&quot;: np.rad2deg(self.hp.max_pixrad(self.nside)), } __init__(angular_resolution=2, cutoff_theta=0, nside=None, phi_rotation=0) &para; Initialize the HEALPix grid builder. Parameters&para; angular_resolution : float, default 2 Angular resolution in degrees. cutoff_theta : float, default 0 Maximum polar angle cutoff in degrees. nside : int | None, optional HEALPix nside parameter. phi_rotation : float, default 0 Rotation angle in degrees. Source code in packages/canvod-grids/src/canvod/grids/grids_impl/healpix_grid.py 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145def __init__( self, angular_resolution: float = 2, cutoff_theta: float = 0, nside: int | None = None, phi_rotation: float = 0, ) -&gt; None: &quot;&quot;&quot;Initialize the HEALPix grid builder. Parameters ---------- angular_resolution : float, default 2 Angular resolution in degrees. cutoff_theta : float, default 0 Maximum polar angle cutoff in degrees. nside : int | None, optional HEALPix nside parameter. phi_rotation : float, default 0 Rotation angle in degrees. &quot;&quot;&quot; super().__init__(angular_resolution, cutoff_theta, phi_rotation) # Determine nside if nside is None: nside_estimate = int(np.sqrt(3 / np.pi) * 60 / angular_resolution) self.nside = 2 ** max(0, int(np.round(np.log2(nside_estimate)))) else: if nside &lt; 1 or (nside &amp; (nside - 1)) != 0: raise ValueError(f&quot;nside must be a power of 2, got {nside}&quot;) self.nside = nside # Import healpy try: import healpy as hp self.hp = hp except ImportError: raise ImportError( &quot;healpy is required for HEALPix grid. Install with: pip install healpy&quot; ) pixel_size_arcmin = self.hp.nside2resol(self.nside, arcmin=True) self.actual_angular_resolution = pixel_size_arcmin / 60.0 self._logger.info( f&quot;HEALPix: nside={self.nside}, &quot; f&quot;requested_res={angular_resolution:.2f}Â°, &quot; f&quot;actual_res={self.actual_angular_resolution:.2f}Â°&quot; ) get_grid_type() &para; Return the grid-type identifier string. Returns&para; str "healpix" Source code in packages/canvod-grids/src/canvod/grids/grids_impl/healpix_grid.py 147 148 149 150 151 152 153 154 155 156def get_grid_type(self) -&gt; str: &quot;&quot;&quot;Return the grid-type identifier string. Returns ------- str ``&quot;healpix&quot;`` &quot;&quot;&quot; return GridType.HEALPIX.value get_healpix_info() &para; Get HEALPix-specific information. Returns&para; info : dict Keys: nside, npix_total, pixel_area_sr, pixel_area_arcmin2, resolution_arcmin, resolution_deg, max_pixel_radius_deg. Source code in packages/canvod-grids/src/canvod/grids/grids_impl/healpix_grid.py 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256def get_healpix_info(self) -&gt; dict: &quot;&quot;&quot;Get HEALPix-specific information. Returns ------- info : dict Keys: ``nside``, ``npix_total``, ``pixel_area_sr``, ``pixel_area_arcmin2``, ``resolution_arcmin``, ``resolution_deg``, ``max_pixel_radius_deg``. &quot;&quot;&quot; return { &quot;nside&quot;: self.nside, &quot;npix_total&quot;: self.hp.nside2npix(self.nside), &quot;pixel_area_sr&quot;: self.hp.nside2pixarea(self.nside), &quot;pixel_area_arcmin2&quot;: ( self.hp.nside2pixarea(self.nside, degrees=True) * 3600 ), &quot;resolution_arcmin&quot;: self.hp.nside2resol(self.nside, arcmin=True), &quot;resolution_deg&quot;: self.actual_angular_resolution, &quot;max_pixel_radius_deg&quot;: np.rad2deg(self.hp.max_pixrad(self.nside)), } (resolution) means
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.htm_grid.HTMBuilder--mathematical-construction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mathematical construction
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.htm_grid.HTMBuilder--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.htm_grid.HTMBuilder--notes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notes
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.htm_grid.HTMBuilder--references" class="md-nav__link">
    <span class="md-ellipsis">
      
        References
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.htm_grid.HTMBuilder.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.htm_grid.HTMBuilder.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.htm_grid.HTMBuilder.get_grid_type" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_grid_type
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_grid_type">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.htm_grid.HTMBuilder.get_grid_type--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.htm_grid.HTMBuilder.get_htm_info" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_htm_info
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_htm_info">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.htm_grid.HTMBuilder.get_htm_info--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#equal-angle-grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        Equal-Angle Grid
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_angle_grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        equal_angle_grid
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_angle_grid.EqualAngleBuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        EqualAngleBuilder
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EqualAngleBuilder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_angle_grid.EqualAngleBuilder--coordinate-convention-physics-gnss" class="md-nav__link">
    <span class="md-ellipsis">
      
        Coordinate convention (physics / GNSS)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_angle_grid.EqualAngleBuilder--what-angular_resolution-means" class="md-nav__link">
    <span class="md-ellipsis">
      
        What Equal-area grid implementation. EqualAreaBuilder &para; Bases: BaseGridBuilder Equal solid angle tessellation using concentric theta bands. The hemisphere is divided into annular bands of constant width in theta. Within each band the number of azimuthal (phi) sectors is chosen so that every cell subtends approximately the same solid angle. This is the only grid type that has been validated for scientific use in this codebase. Coordinate convention (physics / GNSS)&para; phi â [0, 2Ï) â azimuthal angle measured from East, counter-clockwise theta â [0, Ï/2] â polar angle measured from zenith (0 = straight up, Ï/2 = horizon) What angular_resolution means&para; angular_resolution (degrees) sets the width of each theta band. All bands have this same width ÎÎ¸. The azimuthal width of cells varies by band: near the zenith cells are wide in phi; near the horizon they are narrow, so that the solid angle stays constant. Mathematical construction&para; Target solid angle per cell is chosen equal to the solid angle of a cap of half-angle ÎÎ¸/2:: Î©_target = 2Ï (1 â cos(ÎÎ¸/2)) Zenith cap â a single cell covers [0, ÎÎ¸/2] in theta and the full azimuth [0, 2Ï). Theta bands â edges are placed at ÎÎ¸/2, 3ÎÎ¸/2, 5ÎÎ¸/2, â¦ up to Ï/2 â cutoff_theta. For each band [Î¸_inner, Î¸_outer] the band's total solid angle is:: Î©_band = 2Ï (cos Î¸_inner â cos Î¸_outer) Phi divisions â the number of sectors in the band is:: n_phi = round(Î©_band / Î©_target) Each sector spans ÎÏ = 2Ï / n_phi. The cell centre is placed at the geometric midpoint of its (phi, theta) rectangle. Parameters&para; angular_resolution : float Theta-band width in degrees. Controls both the radial resolution and (indirectly, via the equal-area constraint) the azimuthal resolution. cutoff_theta : float Minimum elevation above the horizon in degrees. Bands whose outer edge is at or below this cutoff are omitted. In GNSS terms this is the satellite elevation mask angle. phi_rotation : float Rigid rotation applied to all phi coordinates after grid construction, in degrees. Source code in packages/canvod-grids/src/canvod/grids/grids_impl/equal_area_grid.py 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182class EqualAreaBuilder(BaseGridBuilder): &quot;&quot;&quot;Equal solid angle tessellation using concentric theta bands. The hemisphere is divided into annular bands of constant width in theta. Within each band the number of azimuthal (phi) sectors is chosen so that every cell subtends approximately the same solid angle. This is the only grid type that has been validated for scientific use in this codebase. Coordinate convention (physics / GNSS) --------------------------------------- * phi â [0, 2Ï) â azimuthal angle measured from East, counter-clockwise * theta â [0, Ï/2] â polar angle measured from zenith (0 = straight up, Ï/2 = horizon) What ``angular_resolution`` means ---------------------------------- ``angular_resolution`` (degrees) sets the **width of each theta band**. All bands have this same width ÎÎ¸. The *azimuthal* width of cells varies by band: near the zenith cells are wide in phi; near the horizon they are narrow, so that the solid angle stays constant. Mathematical construction ------------------------- 1. **Target solid angle** per cell is chosen equal to the solid angle of a cap of half-angle ÎÎ¸/2:: Î©_target = 2Ï (1 â cos(ÎÎ¸/2)) 2. **Zenith cap** â a single cell covers [0, ÎÎ¸/2] in theta and the full azimuth [0, 2Ï). 3. **Theta bands** â edges are placed at ÎÎ¸/2, 3ÎÎ¸/2, 5ÎÎ¸/2, â¦ up to Ï/2 â cutoff_theta. For each band [Î¸_inner, Î¸_outer] the band&#39;s total solid angle is:: Î©_band = 2Ï (cos Î¸_inner â cos Î¸_outer) 4. **Phi divisions** â the number of sectors in the band is:: n_phi = round(Î©_band / Î©_target) Each sector spans ÎÏ = 2Ï / n_phi. The cell centre is placed at the geometric midpoint of its (phi, theta) rectangle. Parameters ---------- angular_resolution : float Theta-band width in degrees. Controls both the radial resolution and (indirectly, via the equal-area constraint) the azimuthal resolution. cutoff_theta : float Minimum elevation above the horizon in degrees. Bands whose outer edge is at or below this cutoff are omitted. In GNSS terms this is the satellite elevation mask angle. phi_rotation : float Rigid rotation applied to all phi coordinates after grid construction, in degrees. &quot;&quot;&quot; def get_grid_type(self) -&gt; str: &quot;&quot;&quot;Return the grid-type identifier string. Returns ------- str ``&quot;equal_area&quot;`` &quot;&quot;&quot; return GridType.EQUAL_AREA.value def _build_grid( self, ) -&gt; tuple[pl.DataFrame, np.ndarray, list[np.ndarray], list[np.ndarray]]: &quot;&quot;&quot;Construct the equal-area hemisphere grid. Returns ------- grid : pl.DataFrame One row per cell with columns: phi, theta, phi_min, phi_max, theta_min, theta_max, cell_id. theta_lims : np.ndarray Outer theta edge of each band (radians). phi_lims : list[np.ndarray] Array of phi_min values for each band. cell_ids : list[np.ndarray] Cell-id arrays, one per band. &quot;&quot;&quot; # Theta band edges (from zenith to horizon) max_theta = np.pi / 2 # horizon theta_edges = np.arange( self.angular_resolution_rad / 2, max_theta - self.cutoff_theta_rad, self.angular_resolution_rad, ) # Target solid angle per cell target_omega = 2 * np.pi * (1 - np.cos(self.angular_resolution_rad / 2)) cells = [] theta_lims = [] phi_lims = [] cell_ids = [] # Zenith cell (special case) - only if cutoff allows next_cell_id = 0 zenith_theta_max = self.angular_resolution_rad / 2 if self.cutoff_theta_rad &lt; zenith_theta_max: cells.append( pl.DataFrame( { &quot;phi&quot;: [0.0], &quot;theta&quot;: [0.0], &quot;phi_min&quot;: [0.0], &quot;phi_max&quot;: [2 * np.pi], &quot;theta_min&quot;: [max(0.0, self.cutoff_theta_rad)], &quot;theta_max&quot;: [zenith_theta_max], } ) ) theta_lims.append(zenith_theta_max) phi_lims.append(np.array([0.0])) cell_ids.append(np.array([0])) next_cell_id = 1 # Build theta bands for iband, theta_outer in enumerate(theta_edges[1:]): theta_inner = theta_edges[iband] # Skip bands below cutoff if theta_outer &lt;= self.cutoff_theta_rad: continue # Solid angle of this band band_omega = 2 * np.pi * (np.cos(theta_inner) - np.cos(theta_outer)) # Number of phi divisions n_phi = max(1, round(band_omega / target_omega)) phi_span = 2 * np.pi / n_phi cell_id_list = list(range(next_cell_id, next_cell_id + n_phi)) next_cell_id = cell_id_list[-1] + 1 # Use arange for better precision than linspace phi_min_arr = np.arange(n_phi) * phi_span phi_max_arr = (np.arange(n_phi) + 1) * phi_span phi_max_arr[-1] = 2 * np.pi # Force exact closure cells.append( pl.DataFrame( { &quot;phi&quot;: (phi_min_arr + phi_max_arr) / 2, &quot;theta&quot;: np.full(n_phi, (theta_inner + theta_outer) / 2), &quot;phi_min&quot;: phi_min_arr, &quot;phi_max&quot;: phi_max_arr, &quot;theta_min&quot;: np.full(n_phi, theta_inner), &quot;theta_max&quot;: np.full(n_phi, theta_outer), } ) ) theta_lims.append(theta_outer) phi_lims.append(phi_min_arr) cell_ids.append(np.array(cell_id_list)) if len(cells) == 0: raise ValueError( &quot;No cells generated - check cutoff_theta and angular_resolution&quot; ) grid = pl.concat(cells).with_columns(pl.int_range(0, pl.len()).alias(&quot;cell_id&quot;)) return grid, np.array(theta_lims), phi_lims, cell_ids get_grid_type() &para; Return the grid-type identifier string. Returns&para; str "equal_area" Source code in packages/canvod-grids/src/canvod/grids/grids_impl/equal_area_grid.py 68 69 70 71 72 73 74 75 76 77def get_grid_type(self) -&gt; str: &quot;&quot;&quot;Return the grid-type identifier string. Returns ------- str ``&quot;equal_area&quot;`` &quot;&quot;&quot; return GridType.EQUAL_AREA.value means
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_angle_grid.EqualAngleBuilder--mathematical-construction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mathematical construction
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_angle_grid.EqualAngleBuilder--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_angle_grid.EqualAngleBuilder.get_grid_type" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_grid_type
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_grid_type">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equal_angle_grid.EqualAngleBuilder.get_grid_type--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#equirectangular-grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        Equirectangular Grid
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equirectangular_grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        equirectangular_grid
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equirectangular_grid.EquirectangularBuilder" class="md-nav__link">
    <span class="md-ellipsis">
      
        EquirectangularBuilder
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="EquirectangularBuilder">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equirectangular_grid.EquirectangularBuilder--coordinate-convention-physics-gnss" class="md-nav__link">
    <span class="md-ellipsis">
      
        Coordinate convention (physics / GNSS)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equirectangular_grid.EquirectangularBuilder--what-angular_resolution-means" class="md-nav__link">
    <span class="md-ellipsis">
      
        What Geodesic grid implementation. GeodesicBuilder &para; Bases: BaseGridBuilder Geodesic grid based on a subdivided icosahedron. The sphere is tessellated into triangular cells by starting with an icosahedron (20 equilateral triangles) and recursively subdividing each triangle into four smaller triangles. All vertices are projected back onto the unit sphere after each subdivision step, so the final cells are spherical triangles. The grid has no polar singularity and provides near-uniform cell areas, though strict equal-area is not guaranteed â cell areas vary by a few percent depending on how they inherit the icosahedral symmetry axes. Coordinate convention (physics / GNSS)&para; phi â [0, 2Ï) â azimuthal angle from East, counter-clockwise theta â [0, Ï/2] â polar angle from zenith (0 = straight up, Ï/2 = horizon) Cell centres are computed as the 3D Cartesian mean of the three vertices, re-normalised onto the unit sphere. What angular_resolution means&para; angular_resolution is not used directly as a cell size. Instead it is used only when subdivision_level is not explicitly supplied, to estimate an appropriate subdivision level. The heuristic targets an approximate triangle edge length of 2 Ã angular_resolution:: target_edge â 2 Ã angular_resolution (degrees) subdivision_level = ceil(logâ(63.4 / target_edge)) The number 63.4Â° is the edge length of a regular icosahedron inscribed in a unit sphere. Each subdivision halves the edge length, so the actual edge length at level n is approximately:: edge â 63.4Â° / 2â¿ (degrees) The total number of triangles on the full sphere is 20 Ã 4â¿. Roughly half fall in the northern hemisphere (exact count depends on the hemisphere boundary). Mathematical construction&para; Icosahedron â 12 vertices placed at the intersections of three mutually perpendicular golden-ratio rectangles, normalised to the unit sphere. 20 triangular faces connect them. Subdivision â each triangle is split into 4 by inserting edge midpoints. Each midpoint is projected onto the unit sphere (re-normalised) before the next subdivision. This is repeated subdivision_level times. Hemisphere filter â faces are kept if any of their three vertices satisfies theta â¤ Ï/2 â cutoff_theta. Consequently, boundary triangles that straddle the horizon are included and extend slightly below it. Phi wrapping â for triangles that straddle the 0/2Ï azimuthal boundary, vertex phis below Ï are shifted by +2Ï before computing bounding-box limits, then wrapped back. Parameters&para; angular_resolution : float Approximate angular resolution in degrees. Used only to derive subdivision_level when that parameter is not given explicitly. cutoff_theta : float Elevation mask angle in degrees. Triangles are excluded only if all their vertices are below this elevation. subdivision_level : int or None Number of icosahedral subdivisions. If None, estimated from angular_resolution. Typical range 0â5. phi_rotation : float Rigid azimuthal rotation applied after construction, in degrees. Notes&para; The theta_lims, phi_lims, and cell_ids fields of the returned GridData are synthetic evenly-spaced arrays kept only for interface compatibility with ring-based grids. They do not describe the actual triangular cell layout. Use the geodesic_vertices column and the vertices array in GridData.vertices for the true geometry. Source code in packages/canvod-grids/src/canvod/grids/grids_impl/geodesic_grid.py 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129 130 131 132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 252 253 254 255 256 257 258 259 260 261 262 263 264 265 266 267 268 269 270 271 272 273 274 275 276 277 278 279 280 281 282 283 284 285 286 287 288 289 290 291 292 293 294 295 296 297 298 299 300 301 302 303 304 305 306 307 308 309 310 311 312 313 314 315 316 317 318 319 320 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 337 338 339 340 341 342 343 344 345 346 347 348 349 350 351 352 353 354 355 356 357 358 359 360 361 362 363 364 365 366 367 368 369 370 371 372 373 374 375 376 377 378 379 380 381 382 383 384 385 386 387 388 389 390 391 392 393 394 395 396 397 398 399 400 401 402 403 404 405 406 407 408 409 410 411 412 413 414 415 416 417 418 419 420 421 422 423 424 425 426 427 428 429 430 431 432 433class GeodesicBuilder(BaseGridBuilder): &quot;&quot;&quot;Geodesic grid based on a subdivided icosahedron. The sphere is tessellated into triangular cells by starting with an icosahedron (20 equilateral triangles) and recursively subdividing each triangle into four smaller triangles. All vertices are projected back onto the unit sphere after each subdivision step, so the final cells are *spherical* triangles. The grid has no polar singularity and provides near-uniform cell areas, though strict equal-area is *not* guaranteed â cell areas vary by a few percent depending on how they inherit the icosahedral symmetry axes. Coordinate convention (physics / GNSS) --------------------------------------- * phi â [0, 2Ï) â azimuthal angle from East, counter-clockwise * theta â [0, Ï/2] â polar angle from zenith (0 = straight up, Ï/2 = horizon) Cell centres are computed as the 3D Cartesian mean of the three vertices, re-normalised onto the unit sphere. What ``angular_resolution`` means ---------------------------------- ``angular_resolution`` is **not** used directly as a cell size. Instead it is used only when ``subdivision_level`` is *not* explicitly supplied, to *estimate* an appropriate subdivision level. The heuristic targets an approximate triangle edge length of ``2 Ã angular_resolution``:: target_edge â 2 Ã angular_resolution (degrees) subdivision_level = ceil(logâ(63.4 / target_edge)) The number 63.4Â° is the edge length of a regular icosahedron inscribed in a unit sphere. Each subdivision halves the edge length, so the actual edge length at level *n* is approximately:: edge â 63.4Â° / 2â¿ (degrees) The total number of triangles on the **full sphere** is ``20 Ã 4â¿``. Roughly half fall in the northern hemisphere (exact count depends on the hemisphere boundary). Mathematical construction ------------------------- 1. **Icosahedron** â 12 vertices placed at the intersections of three mutually perpendicular golden-ratio rectangles, normalised to the unit sphere. 20 triangular faces connect them. 2. **Subdivision** â each triangle is split into 4 by inserting edge midpoints. Each midpoint is projected onto the unit sphere (re-normalised) before the next subdivision. This is repeated ``subdivision_level`` times. 3. **Hemisphere filter** â faces are kept if *any* of their three vertices satisfies ``theta â¤ Ï/2 â cutoff_theta``. Consequently, boundary triangles that straddle the horizon *are* included and extend slightly below it. 4. **Phi wrapping** â for triangles that straddle the 0/2Ï azimuthal boundary, vertex phis below Ï are shifted by +2Ï before computing bounding-box limits, then wrapped back. Parameters ---------- angular_resolution : float Approximate angular resolution in degrees. Used only to derive ``subdivision_level`` when that parameter is not given explicitly. cutoff_theta : float Elevation mask angle in degrees. Triangles are excluded only if *all* their vertices are below this elevation. subdivision_level : int or None Number of icosahedral subdivisions. If ``None``, estimated from ``angular_resolution``. Typical range 0â5. phi_rotation : float Rigid azimuthal rotation applied after construction, in degrees. Notes ----- The ``theta_lims``, ``phi_lims``, and ``cell_ids`` fields of the returned ``GridData`` are *synthetic* evenly-spaced arrays kept only for interface compatibility with ring-based grids. They do **not** describe the actual triangular cell layout. Use the ``geodesic_vertices`` column and the ``vertices`` array in ``GridData.vertices`` for the true geometry. &quot;&quot;&quot; def __init__( self, angular_resolution: float = 2, cutoff_theta: float = 0, subdivision_level: int | None = None, phi_rotation: float = 0, ) -&gt; None: &quot;&quot;&quot;Initialize the geodesic grid builder. Parameters ---------- angular_resolution : float, default 2 Angular resolution in degrees. cutoff_theta : float, default 0 Maximum polar angle cutoff in degrees. subdivision_level : int | None, optional Subdivision level override. phi_rotation : float, default 0 Rotation angle in degrees. &quot;&quot;&quot; super().__init__(angular_resolution, cutoff_theta, phi_rotation) self._triangles: np.ndarray | None = None if subdivision_level is None: target_edge_deg = angular_resolution * 2 self.subdivision_level = max( 0, int(np.ceil(np.log2(63.4 / target_edge_deg))), ) else: self.subdivision_level = subdivision_level self._logger.info( f&quot;Geodesic: subdivision_level={self.subdivision_level}, &quot; f&quot;~{20 * 4**self.subdivision_level} triangles&quot; ) def get_triangles(self) -&gt; np.ndarray | None: &quot;&quot;&quot;Return triangle vertex coordinates for visualization. Returns ------- triangles : np.ndarray or None Array of shape ``(n_faces, 3, 3)`` where ``triangles[i]`` contains the three 3D unit-sphere vertices of triangle *i*. ``None`` if the grid has not been built yet. &quot;&quot;&quot; return self._triangles def get_grid_type(self) -&gt; str: &quot;&quot;&quot;Return the grid-type identifier string. Returns ------- str ``&quot;geodesic&quot;`` &quot;&quot;&quot; return GridType.GEODESIC.value def _extract_triangle_vertices( self, vertices: np.ndarray, faces: np.ndarray ) -&gt; np.ndarray: &quot;&quot;&quot;Extract 3D vertex coordinates for each face. Parameters ---------- vertices : np.ndarray All sphere vertices, shape ``(n_vertices, 3)``. faces : np.ndarray Face index array, shape ``(n_faces, 3)``. Returns ------- triangles : np.ndarray Shape ``(n_faces, 3, 3)`` â three 3D vertices per face. &quot;&quot;&quot; # Vectorized: use NumPy advanced indexing instead of loop return vertices[faces] def _build_grid( self, ) -&gt; tuple[ pl.DataFrame, np.ndarray, list[np.ndarray], list[np.ndarray], dict[str, Any] ]: &quot;&quot;&quot;Build geodesic grid from subdivided icosahedron. Returns ------- grid : pl.DataFrame One row per triangular cell. Columns include phi, theta (centre), bounding-box limits, ``geodesic_vertices`` (3 vertex indices into the ``vertices`` array), and ``geodesic_subdivision``. theta_lims : np.ndarray Synthetic evenly-spaced theta limits (interface compatibility only). phi_lims : list[np.ndarray] Synthetic evenly-spaced phi limits (interface compatibility only). cell_ids : list[np.ndarray] Single-element list containing all cell ids. extra_kwargs : dict Contains ``vertices`` (shape ``(n_vertices, 3)``), ``vertex_phi``, and ``vertex_theta`` arrays for the full subdivided icosahedron. &quot;&quot;&quot; vertices, faces = self._create_icosahedron() # Subdivide for _ in range(self.subdivision_level): vertices, faces = self._subdivide_mesh(vertices, faces) # Project to unit sphere vertices = vertices / np.linalg.norm(vertices, axis=1, keepdims=True) # Convert to spherical x, y, z = vertices[:, 0], vertices[:, 1], vertices[:, 2] theta = np.arccos(np.clip(z, -1, 1)) phi = np.arctan2(y, x) phi = np.mod(phi, 2 * np.pi) # Filter to northern hemisphere hemisphere_mask = theta &lt;= (np.pi / 2 - self.cutoff_theta_rad) # Filter faces valid_faces = [] for face in faces: if any(hemisphere_mask[v] for v in face): valid_faces.append(face) if len(valid_faces) == 0: raise ValueError(&quot;No valid faces in hemisphere&quot;) valid_faces = np.array(valid_faces) # Create cells cells = [] for face in valid_faces: v_indices = face face_phi = phi[v_indices] face_theta = theta[v_indices] # Handle phi wrapping for triangles crossing 0/2Ï boundary phi_range = np.ptp(face_phi) if phi_range &gt; np.pi: # Triangle crosses the wraparound - unwrap relative to median ref_phi = np.median(face_phi) face_phi_unwrapped = face_phi.copy() # Unwrap angles that are &gt; Ï away from reference mask_low = (ref_phi - face_phi_unwrapped) &gt; np.pi mask_high = (face_phi_unwrapped - ref_phi) &gt; np.pi face_phi_unwrapped[mask_low] += 2 * np.pi face_phi_unwrapped[mask_high] -= 2 * np.pi phi_min = float(np.min(face_phi_unwrapped) % (2 * np.pi)) phi_max = float(np.max(face_phi_unwrapped) % (2 * np.pi)) else: phi_min = float(np.min(face_phi)) phi_max = float(np.max(face_phi)) # Cell center - 3D Cartesian mean face_vertices_3d = vertices[v_indices] center_3d = np.mean(face_vertices_3d, axis=0) center_3d = center_3d / np.linalg.norm(center_3d) center_theta = np.arccos(np.clip(center_3d[2], -1, 1)) center_phi = np.arctan2(center_3d[1], center_3d[0]) center_phi = np.mod(center_phi, 2 * np.pi) # Cell bounds (theta from vertices, phi already computed above) theta_min = float(np.min(face_theta)) theta_max = float(np.max(face_theta)) cells.append( { &quot;phi&quot;: center_phi, &quot;theta&quot;: center_theta, &quot;phi_min&quot;: phi_min, &quot;phi_max&quot;: phi_max, &quot;theta_min&quot;: theta_min, &quot;theta_max&quot;: theta_max, &quot;geodesic_vertices&quot;: v_indices.tolist(), &quot;geodesic_subdivision&quot;: self.subdivision_level, } ) grid = pl.DataFrame(cells).with_columns( pl.int_range(0, pl.len()).alias(&quot;cell_id&quot;) ) extra_kwargs: dict[str, Any] = { &quot;vertices&quot;: vertices, &quot;vertex_phi&quot;: phi, &quot;vertex_theta&quot;: theta, } theta_lims = np.linspace(0, np.pi / 2, 10) phi_lims = [np.linspace(0, 2 * np.pi, 20) for _ in range(len(theta_lims))] cell_ids_list = [np.arange(grid.height)] self._triangles = self._extract_triangle_vertices(vertices, faces) return grid, theta_lims, phi_lims, cell_ids_list, extra_kwargs def _create_icosahedron(self) -&gt; tuple[np.ndarray, np.ndarray]: &quot;&quot;&quot;Create a unit-sphere icosahedron. Returns ------- vertices : np.ndarray Shape ``(12, 3)`` â vertices on the unit sphere. faces : np.ndarray Shape ``(20, 3)`` â integer vertex indices per triangular face. &quot;&quot;&quot; phi_golden = (1 + np.sqrt(5)) / 2 vertices = np.array( [ [-1, phi_golden, 0], [1, phi_golden, 0], [-1, -phi_golden, 0], [1, -phi_golden, 0], [0, -1, phi_golden], [0, 1, phi_golden], [0, -1, -phi_golden], [0, 1, -phi_golden], [phi_golden, 0, -1], [phi_golden, 0, 1], [-phi_golden, 0, -1], [-phi_golden, 0, 1], ], dtype=np.float64, ) vertices = vertices / np.linalg.norm(vertices, axis=1, keepdims=True) faces = np.array( [ [0, 11, 5], [0, 5, 1], [0, 1, 7], [0, 7, 10], [0, 10, 11], [1, 5, 9], [5, 11, 4], [11, 10, 2], [10, 7, 6], [7, 1, 8], [3, 9, 4], [3, 4, 2], [3, 2, 6], [3, 6, 8], [3, 8, 9], [4, 9, 5], [2, 4, 11], [6, 2, 10], [8, 6, 7], [9, 8, 1], ], dtype=np.int64, ) return vertices, faces def _subdivide_mesh( self, vertices: np.ndarray, faces: np.ndarray ) -&gt; tuple[np.ndarray, np.ndarray]: &quot;&quot;&quot;Subdivide each triangle into 4 smaller triangles. Each edge midpoint is computed, normalised onto the unit sphere, and cached so that shared edges produce only one new vertex. Parameters ---------- vertices : np.ndarray Current vertex array, shape ``(n_vertices, 3)``. faces : np.ndarray Current face array, shape ``(n_faces, 3)``. Returns ------- new_vertices : np.ndarray Expanded vertex array, shape ``(n_vertices + n_new_midpoints, 3)``. new_faces : np.ndarray New face array, shape ``(4 Ã n_faces, 3)``. &quot;&quot;&quot; new_faces = [] edge_midpoints: dict[tuple[int, int], int] = {} def get_midpoint(v1: int, v2: int) -&gt; int: &quot;&quot;&quot;Return midpoint vertex index for an edge. Parameters ---------- v1 : int First vertex index. v2 : int Second vertex index. Returns ------- int Index of the midpoint vertex. &quot;&quot;&quot; edge = tuple(sorted([v1, v2])) if edge not in edge_midpoints: edge_midpoints[edge] = len(vertices) + len(edge_midpoints) return edge_midpoints[edge] for face in faces: v0, v1, v2 = face m01 = get_midpoint(v0, v1) m12 = get_midpoint(v1, v2) m20 = get_midpoint(v2, v0) new_faces.extend( [ [v0, m01, m20], [v1, m12, m01], [v2, m20, m12], [m01, m12, m20], ] ) n_original = len(vertices) n_new = len(edge_midpoints) final_vertices = np.zeros((n_original + n_new, 3)) final_vertices[:n_original] = vertices for edge, idx in edge_midpoints.items(): v1, v2 = edge midpoint = (vertices[v1] + vertices[v2]) / 2 midpoint = midpoint / np.linalg.norm(midpoint) final_vertices[idx] = midpoint return final_vertices, np.array(new_faces) __init__(angular_resolution=2, cutoff_theta=0, subdivision_level=None, phi_rotation=0) &para; Initialize the geodesic grid builder. Parameters&para; angular_resolution : float, default 2 Angular resolution in degrees. cutoff_theta : float, default 0 Maximum polar angle cutoff in degrees. subdivision_level : int | None, optional Subdivision level override. phi_rotation : float, default 0 Rotation angle in degrees. Source code in packages/canvod-grids/src/canvod/grids/grids_impl/geodesic_grid.py 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 123 124 125 126 127 128 129def __init__( self, angular_resolution: float = 2, cutoff_theta: float = 0, subdivision_level: int | None = None, phi_rotation: float = 0, ) -&gt; None: &quot;&quot;&quot;Initialize the geodesic grid builder. Parameters ---------- angular_resolution : float, default 2 Angular resolution in degrees. cutoff_theta : float, default 0 Maximum polar angle cutoff in degrees. subdivision_level : int | None, optional Subdivision level override. phi_rotation : float, default 0 Rotation angle in degrees. &quot;&quot;&quot; super().__init__(angular_resolution, cutoff_theta, phi_rotation) self._triangles: np.ndarray | None = None if subdivision_level is None: target_edge_deg = angular_resolution * 2 self.subdivision_level = max( 0, int(np.ceil(np.log2(63.4 / target_edge_deg))), ) else: self.subdivision_level = subdivision_level self._logger.info( f&quot;Geodesic: subdivision_level={self.subdivision_level}, &quot; f&quot;~{20 * 4**self.subdivision_level} triangles&quot; ) get_triangles() &para; Return triangle vertex coordinates for visualization. Returns&para; triangles : np.ndarray or None Array of shape (n_faces, 3, 3) where triangles[i] contains the three 3D unit-sphere vertices of triangle i. None if the grid has not been built yet. Source code in packages/canvod-grids/src/canvod/grids/grids_impl/geodesic_grid.py 131 132 133 134 135 136 137 138 139 140 141 142def get_triangles(self) -&gt; np.ndarray | None: &quot;&quot;&quot;Return triangle vertex coordinates for visualization. Returns ------- triangles : np.ndarray or None Array of shape ``(n_faces, 3, 3)`` where ``triangles[i]`` contains the three 3D unit-sphere vertices of triangle *i*. ``None`` if the grid has not been built yet. &quot;&quot;&quot; return self._triangles get_grid_type() &para; Return the grid-type identifier string. Returns&para; str "geodesic" Source code in packages/canvod-grids/src/canvod/grids/grids_impl/geodesic_grid.py 144 145 146 147 148 149 150 151 152 153def get_grid_type(self) -&gt; str: &quot;&quot;&quot;Return the grid-type identifier string. Returns ------- str ``&quot;geodesic&quot;`` &quot;&quot;&quot; return GridType.GEODESIC.value means
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equirectangular_grid.EquirectangularBuilder--mathematical-construction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Mathematical construction
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equirectangular_grid.EquirectangularBuilder--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equirectangular_grid.EquirectangularBuilder.get_grid_type" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_grid_type
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_grid_type">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.grids_impl.equirectangular_grid.EquirectangularBuilder.get_grid_type--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#grid-operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Grid Operations
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.operations" class="md-nav__link">
    <span class="md-ellipsis">
      
        operations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="operations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations--cell-assignment" class="md-nav__link">
    <span class="md-ellipsis">
      
        Cell assignment
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations--vertex-grid-conversion" class="md-nav__link">
    <span class="md-ellipsis">
      
        Vertex / grid conversion
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.operations.add_cell_ids_to_vod_fast" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_cell_ids_to_vod_fast
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_cell_ids_to_vod_fast">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.add_cell_ids_to_vod_fast--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.add_cell_ids_to_vod_fast--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.operations.add_cell_ids_to_vod" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_cell_ids_to_vod
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_cell_ids_to_vod">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.add_cell_ids_to_vod--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.add_cell_ids_to_vod--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.operations.add_cell_ids_to_ds_fast" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_cell_ids_to_ds_fast
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_cell_ids_to_ds_fast">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.add_cell_ids_to_ds_fast--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.add_cell_ids_to_ds_fast--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.operations.extract_grid_vertices" class="md-nav__link">
    <span class="md-ellipsis">
      
        extract_grid_vertices
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="extract_grid_vertices">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.extract_grid_vertices--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.extract_grid_vertices--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.operations.grid_to_dataset" class="md-nav__link">
    <span class="md-ellipsis">
      
        grid_to_dataset
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="grid_to_dataset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.grid_to_dataset--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.grid_to_dataset--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.grid_to_dataset--notes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notes
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.operations.store_grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        store_grid
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="store_grid">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.store_grid--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.store_grid--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.store_grid--examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Examples
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.operations.load_grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        load_grid
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="load_grid">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.load_grid--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.load_grid--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.operations.load_grid--examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Examples
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#aggregation" class="md-nav__link">
    <span class="md-ellipsis">
      
        Aggregation
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.aggregation" class="md-nav__link">
    <span class="md-ellipsis">
      
        aggregation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="aggregation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation--top-level-entry-points" class="md-nav__link">
    <span class="md-ellipsis">
      
        Top-level entry points
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation--analysis-helpers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Analysis helpers
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation--convenience-wrappers" class="md-nav__link">
    <span class="md-ellipsis">
      
        Convenience wrappers
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.CellAggregator" class="md-nav__link">
    <span class="md-ellipsis">
      
        CellAggregator
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="CellAggregator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.CellAggregator.aggregate_by_cell" class="md-nav__link">
    <span class="md-ellipsis">
      
        aggregate_by_cell
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="aggregate_by_cell">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.CellAggregator.aggregate_by_cell--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.CellAggregator.aggregate_by_cell--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.aggregate_data_to_grid" class="md-nav__link">
    <span class="md-ellipsis">
      
        aggregate_data_to_grid
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="aggregate_data_to_grid">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.aggregate_data_to_grid--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.aggregate_data_to_grid--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.compute_percell_timeseries" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_percell_timeseries
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_percell_timeseries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.compute_percell_timeseries--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.compute_percell_timeseries--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.compute_global_average" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_global_average
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_global_average">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.compute_global_average--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.compute_global_average--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.compute_regional_average" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_regional_average
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_regional_average">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.compute_regional_average--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.compute_regional_average--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.analyze_diurnal_patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        analyze_diurnal_patterns
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="analyze_diurnal_patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.analyze_diurnal_patterns--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.analyze_diurnal_patterns--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.analyze_spatial_patterns" class="md-nav__link">
    <span class="md-ellipsis">
      
        analyze_spatial_patterns
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="analyze_spatial_patterns">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.analyze_spatial_patterns--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.analyze_spatial_patterns--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.compute_hemisphere_percell" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_hemisphere_percell
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.aggregation.compute_zenith_percell" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_zenith_percell
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        Analysis
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        analysis
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis--modules" class="md-nav__link">
    <span class="md-ellipsis">
      
        Modules
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.Filter" class="md-nav__link">
    <span class="md-ellipsis">
      
        Filter
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Filter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.Filter.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.Filter.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.Filter.compute_mask" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_mask
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.Filter.apply" class="md-nav__link">
    <span class="md-ellipsis">
      
        apply
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="apply">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.Filter.apply--new-variables" class="md-nav__link">
    <span class="md-ellipsis">
      
        New variables
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.FilterPipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        FilterPipeline
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FilterPipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.FilterPipeline--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.FilterPipeline.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.FilterPipeline.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.FilterPipeline.add_filter" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_filter
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_filter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.FilterPipeline.add_filter--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.FilterPipeline.add_filter--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.FilterPipeline.apply" class="md-nav__link">
    <span class="md-ellipsis">
      
        apply
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="apply">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.FilterPipeline.apply--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.FilterPipeline.apply--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.FilterPipeline.summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        summary
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.IQRFilter" class="md-nav__link">
    <span class="md-ellipsis">
      
        IQRFilter
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="IQRFilter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.IQRFilter.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.IQRFilter.compute_mask" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_mask
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_mask">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.IQRFilter.compute_mask--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.IQRFilter.compute_mask--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.ZScoreFilter" class="md-nav__link">
    <span class="md-ellipsis">
      
        ZScoreFilter
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ZScoreFilter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.ZScoreFilter.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.ZScoreFilter.compute_mask" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_mask
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_mask">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.ZScoreFilter.compute_mask--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.ZScoreFilter.compute_mask--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask" class="md-nav__link">
    <span class="md-ellipsis">
      
        SpatialMask
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SpatialMask">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask--examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Examples
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_phi_range" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_phi_range
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_phi_range">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_phi_range--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_phi_range--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_phi_range--notes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notes
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_theta_range" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_theta_range
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_theta_range">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_theta_range--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_theta_range--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_theta_range--notes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notes
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_elevation_range" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_elevation_range
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_elevation_range">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_elevation_range--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_elevation_range--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_elevation_range--notes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notes
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_cell_ids" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_cell_ids
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_cell_ids">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_cell_ids--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_cell_ids--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_exclude_cell_ids" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_exclude_cell_ids
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_exclude_cell_ids">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_exclude_cell_ids--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_exclude_cell_ids--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_quality_threshold" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_quality_threshold
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_quality_threshold">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_quality_threshold--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_quality_threshold--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_quality_threshold--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_boundary_cells" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_boundary_cells
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_boundary_cells">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_boundary_cells--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_boundary_cells--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_boundary_cells--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_boundary_cells--notes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Notes
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_custom_mask" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_custom_mask
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_custom_mask">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_custom_mask--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_custom_mask--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_custom_mask--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_custom_mask--examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Examples
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_radial_sector" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_radial_sector
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_radial_sector">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_radial_sector--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_radial_sector--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_radial_sector--examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Examples
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.add_radial_sector--northern-sector-30-wide-excluding-low-elevations" class="md-nav__link">
    <span class="md-ellipsis">
      
        Northern sector, 30Â° wide, excluding low elevations
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.compute" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.compute--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.compute--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.compute--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.get_mask_summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_mask_summary
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_mask_summary">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.get_mask_summary--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.clear" class="md-nav__link">
    <span class="md-ellipsis">
      
        clear
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="clear">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.clear--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.__repr__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __repr__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__repr__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SpatialMask.__repr__--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellVODAnalyzer" class="md-nav__link">
    <span class="md-ellipsis">
      
        PerCellVODAnalyzer
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PerCellVODAnalyzer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellVODAnalyzer--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellVODAnalyzer--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellVODAnalyzer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellVODAnalyzer.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilter" class="md-nav__link">
    <span class="md-ellipsis">
      
        PerCellFilter
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PerCellFilter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilter.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilter.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilter.compute_cell_mask" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_cell_mask
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_cell_mask">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilter.compute_cell_mask--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilter.compute_cell_mask--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilter.apply" class="md-nav__link">
    <span class="md-ellipsis">
      
        apply
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="apply">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilter.apply--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilter.apply--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilterPipeline" class="md-nav__link">
    <span class="md-ellipsis">
      
        PerCellFilterPipeline
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PerCellFilterPipeline">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilterPipeline--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilterPipeline.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilterPipeline.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilterPipeline.add_filter" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_filter
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_filter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilterPipeline.add_filter--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilterPipeline.add_filter--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilterPipeline.apply" class="md-nav__link">
    <span class="md-ellipsis">
      
        apply
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="apply">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilterPipeline.apply--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellFilterPipeline.apply--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellIQRFilter" class="md-nav__link">
    <span class="md-ellipsis">
      
        PerCellIQRFilter
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PerCellIQRFilter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellIQRFilter.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellIQRFilter.compute_cell_mask" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_cell_mask
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_cell_mask">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellIQRFilter.compute_cell_mask--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellIQRFilter.compute_cell_mask--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellZScoreFilter" class="md-nav__link">
    <span class="md-ellipsis">
      
        PerCellZScoreFilter
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="PerCellZScoreFilter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellZScoreFilter.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellZScoreFilter.compute_cell_mask" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_cell_mask
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_cell_mask">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellZScoreFilter.compute_cell_mask--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.PerCellZScoreFilter.compute_cell_mask--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator" class="md-nav__link">
    <span class="md-ellipsis">
      
        SolarPositionCalculator
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SolarPositionCalculator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator--examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Examples
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.compute_solar_position" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_solar_position
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_solar_position">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.compute_solar_position--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.compute_solar_position--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.compute_solar_elevation" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_solar_elevation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_solar_elevation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.compute_solar_elevation--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.compute_solar_elevation--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.is_daytime" class="md-nav__link">
    <span class="md-ellipsis">
      
        is_daytime
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="is_daytime">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.is_daytime--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.is_daytime--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.apply_solar_correction" class="md-nav__link">
    <span class="md-ellipsis">
      
        apply_solar_correction
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="apply_solar_correction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.apply_solar_correction--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.apply_solar_correction--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.compute_solar_bins" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_solar_bins
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_solar_bins">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.compute_solar_bins--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.compute_solar_bins--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.get_sunrise_sunset" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_sunrise_sunset
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_sunrise_sunset">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.get_sunrise_sunset--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.get_sunrise_sunset--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.__repr__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __repr__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__repr__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.SolarPositionCalculator.__repr__--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.VODSpatialAnalyzer" class="md-nav__link">
    <span class="md-ellipsis">
      
        VODSpatialAnalyzer
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="VODSpatialAnalyzer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.VODSpatialAnalyzer--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.VODSpatialAnalyzer--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.VODSpatialAnalyzer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.VODSpatialAnalyzer.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.VODSpatialAnalyzer.compute_spatial_statistics" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_spatial_statistics
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_spatial_statistics">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.VODSpatialAnalyzer.compute_spatial_statistics--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.VODSpatialAnalyzer.compute_spatial_statistics--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.VODSpatialAnalyzer.compute_spatial_statistics--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.VODSpatialAnalyzer.compare_filtering_methods" class="md-nav__link">
    <span class="md-ellipsis">
      
        compare_filtering_methods
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compare_filtering_methods">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.VODSpatialAnalyzer.compare_filtering_methods--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.VODSpatialAnalyzer.compare_filtering_methods--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        TemporalAnalysis
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="TemporalAnalysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis--examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Examples
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.compute_timeseries" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_timeseries
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_timeseries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.compute_timeseries--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.compute_timeseries--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.compute_timeseries--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.compute_timeseries_solar_corrected" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_timeseries_solar_corrected
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_timeseries_solar_corrected">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.compute_timeseries_solar_corrected--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.compute_timeseries_solar_corrected--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.compute_timeseries_solar_corrected--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.compute_diurnal_cycle" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_diurnal_cycle
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_diurnal_cycle">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.compute_diurnal_cycle--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.compute_diurnal_cycle--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.compute_diurnal_cycle_solar" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute_diurnal_cycle_solar
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute_diurnal_cycle_solar">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.compute_diurnal_cycle_solar--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.compute_diurnal_cycle_solar--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.compute_diurnal_cycle_solar--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.add_solar_metadata_to_timeseries" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_solar_metadata_to_timeseries
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_solar_metadata_to_timeseries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.add_solar_metadata_to_timeseries--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.add_solar_metadata_to_timeseries--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.add_solar_metadata_to_timeseries--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.plot_timeseries" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_timeseries
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="plot_timeseries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.plot_timeseries--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.plot_timeseries--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.plot_diurnal_cycle" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_diurnal_cycle
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="plot_diurnal_cycle">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.plot_diurnal_cycle--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.plot_diurnal_cycle--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.plot_diurnal_cycle_comparison" class="md-nav__link">
    <span class="md-ellipsis">
      
        plot_diurnal_cycle_comparison
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="plot_diurnal_cycle_comparison">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.plot_diurnal_cycle_comparison--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.TemporalAnalysis.plot_diurnal_cycle_comparison--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator" class="md-nav__link">
    <span class="md-ellipsis">
      
        WeightCalculator
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="WeightCalculator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator--examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Examples
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __init__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__init__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.__init__--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.add_weight" class="md-nav__link">
    <span class="md-ellipsis">
      
        add_weight
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="add_weight">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.add_weight--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.add_weight--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.add_weight--examples" class="md-nav__link">
    <span class="md-ellipsis">
      
        Examples
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.compute" class="md-nav__link">
    <span class="md-ellipsis">
      
        compute
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="compute">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.compute--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.compute--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.compute--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.get_weight_summary" class="md-nav__link">
    <span class="md-ellipsis">
      
        get_weight_summary
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="get_weight_summary">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.get_weight_summary--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.remove_weight" class="md-nav__link">
    <span class="md-ellipsis">
      
        remove_weight
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="remove_weight">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.remove_weight--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.remove_weight--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.clear" class="md-nav__link">
    <span class="md-ellipsis">
      
        clear
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="clear">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.clear--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.__repr__" class="md-nav__link">
    <span class="md-ellipsis">
      
        __repr__
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="__repr__">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.WeightCalculator.__repr__--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.aggr_hampel_cell_sid_parallelized" class="md-nav__link">
    <span class="md-ellipsis">
      
        aggr_hampel_cell_sid_parallelized
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="aggr_hampel_cell_sid_parallelized">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.aggr_hampel_cell_sid_parallelized--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.aggr_hampel_cell_sid_parallelized--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.hampel_cell_sid_parallelized" class="md-nav__link">
    <span class="md-ellipsis">
      
        hampel_cell_sid_parallelized
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="hampel_cell_sid_parallelized">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.hampel_cell_sid_parallelized--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.hampel_cell_sid_parallelized--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.create_elevation_mask" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_elevation_mask
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="create_elevation_mask">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.create_elevation_mask--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.create_elevation_mask--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.create_hemisphere_mask" class="md-nav__link">
    <span class="md-ellipsis">
      
        create_hemisphere_mask
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="create_hemisphere_mask">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.create_hemisphere_mask--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.create_hemisphere_mask--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.create_hemisphere_mask--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.extract_percell_coverage" class="md-nav__link">
    <span class="md-ellipsis">
      
        extract_percell_coverage
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="extract_percell_coverage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.extract_percell_coverage--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.extract_percell_coverage--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.extract_percell_stats" class="md-nav__link">
    <span class="md-ellipsis">
      
        extract_percell_stats
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="extract_percell_stats">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.extract_percell_stats--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.extract_percell_stats--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.extract_percell_temporal_stats" class="md-nav__link">
    <span class="md-ellipsis">
      
        extract_percell_temporal_stats
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="extract_percell_temporal_stats">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.extract_percell_temporal_stats--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.extract_percell_temporal_stats--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.percell_to_grid_counts" class="md-nav__link">
    <span class="md-ellipsis">
      
        percell_to_grid_counts
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="percell_to_grid_counts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.percell_to_grid_counts--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.percell_to_grid_counts--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.percell_to_grid_data" class="md-nav__link">
    <span class="md-ellipsis">
      
        percell_to_grid_data
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="percell_to_grid_data">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.percell_to_grid_data--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.percell_to_grid_data--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.astropy_hampel_ultra_fast" class="md-nav__link">
    <span class="md-ellipsis">
      
        astropy_hampel_ultra_fast
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="astropy_hampel_ultra_fast">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.astropy_hampel_ultra_fast--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.astropy_hampel_ultra_fast--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.astropy_hampel_ultra_fast--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.astropy_hampel_vectorized_fast" class="md-nav__link">
    <span class="md-ellipsis">
      
        astropy_hampel_vectorized_fast
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="astropy_hampel_vectorized_fast">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.astropy_hampel_vectorized_fast--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.astropy_hampel_vectorized_fast--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.astropy_hampel_vectorized_fast--raises" class="md-nav__link">
    <span class="md-ellipsis">
      
        Raises
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#canvod.grids.analysis.AnalysisStorage" class="md-nav__link">
    <span class="md-ellipsis">
      
        AnalysisStorage
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AnalysisStorage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.AnalysisStorage--parameters" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canvod.grids.analysis.AnalysisStorage--returns" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returns
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
                



  


  <nav class="md-path" aria-label="Navigation" >
    <ol class="md-path__list">
      
        
  
  
    <li class="md-path__item">
      <a href="../.." class="md-path__link">
        
  <span class="md-ellipsis">
    Home
  </span>

      </a>
    </li>
  

      
      
        
  
  
    
    
      <li class="md-path__item">
        <a href="../canvodpy/" class="md-path__link">
          
  <span class="md-ellipsis">
    API Reference
  </span>

        </a>
      </li>
    
  

      
    </ol>
  </nav>

              
              <article class="md-content__inner md-typeset">
                
                  
  
  


<h1 id="canvodgrids-api-reference">canvod.grids API Reference<a class="headerlink" href="#canvodgrids-api-reference" title="Permanent link">&para;</a></h1>
<p>Hemispheric grid implementations and spatial analysis tools.</p>
<h2 id="package">Package<a class="headerlink" href="#package" title="Permanent link">&para;</a></h2>


<div class="doc doc-object doc-module">



<a id="canvod.grids"></a>
    <div class="doc doc-contents first">

        <p>HEALPix and hemispheric grid operations.</p>
<p>Provides hemisphere grid structures for GNSS signal observation analysis.</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="canvod.grids.BaseGridBuilder" class="doc doc-heading">
            <code>BaseGridBuilder</code>


<a href="#canvod.grids.BaseGridBuilder" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>



        <p>Abstract base for hemispherical grid builders.</p>
<h4 id="canvod.grids.BaseGridBuilder--parameters">Parameters<a class="headerlink" href="#canvod.grids.BaseGridBuilder--parameters" title="Permanent link">&para;</a></h4>
<p>angular_resolution : float
    Angular resolution in degrees
cutoff_theta : float
    Maximum polar angle cutoff in degrees
phi_rotation : float
    Rotation angle in degrees (applied to all phi values)</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/core/grid_builder.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BaseGridBuilder</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base for hemispherical grid builders.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    angular_resolution : float</span>
<span class="sd">        Angular resolution in degrees</span>
<span class="sd">    cutoff_theta : float</span>
<span class="sd">        Maximum polar angle cutoff in degrees</span>
<span class="sd">    phi_rotation : float</span>
<span class="sd">        Rotation angle in degrees (applied to all phi values)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">angular_resolution</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">cutoff_theta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">phi_rotation</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the grid builder.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        angular_resolution : float, default 2</span>
<span class="sd">            Angular resolution in degrees.</span>
<span class="sd">        cutoff_theta : float, default 0</span>
<span class="sd">            Maximum polar angle cutoff in degrees.</span>
<span class="sd">        phi_rotation : float, default 0</span>
<span class="sd">            Rotation angle in degrees.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angular_resolution</span> <span class="o">=</span> <span class="n">angular_resolution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angular_resolution_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angular_resolution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cutoff_theta</span> <span class="o">=</span> <span class="n">cutoff_theta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cutoff_theta_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">cutoff_theta</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phi_rotation</span> <span class="o">=</span> <span class="n">phi_rotation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phi_rotation_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">phi_rotation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">_get_logger</span><span class="p">()</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_grid</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span>
        <span class="nb">tuple</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span>
        <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
        <span class="p">]</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build grid.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        grid : pl.DataFrame</span>
<span class="sd">            Grid cells</span>
<span class="sd">        theta_lims : np.ndarray</span>
<span class="sd">            Theta band limits</span>
<span class="sd">        phi_lims : list[np.ndarray]</span>
<span class="sd">            Phi limits per band</span>
<span class="sd">        cell_ids : list[np.ndarray]</span>
<span class="sd">            Cell IDs per band</span>
<span class="sd">        extra_kwargs : dict, optional</span>
<span class="sd">            Additional metadata</span>

<span class="sd">        &quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_grid_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get grid type identifier.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GridData</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build hemisphere grid.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        GridData</span>
<span class="sd">            Complete grid data structure</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;grid_build_started&quot;</span><span class="p">,</span>
            <span class="n">grid_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_grid_type</span><span class="p">(),</span>
            <span class="n">angular_resolution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">angular_resolution</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_grid</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">grid</span><span class="p">,</span> <span class="n">theta_lims</span><span class="p">,</span> <span class="n">phi_lims</span><span class="p">,</span> <span class="n">cell_ids</span> <span class="o">=</span> <span class="n">result</span>
            <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">grid</span><span class="p">,</span> <span class="n">theta_lims</span><span class="p">,</span> <span class="n">phi_lims</span><span class="p">,</span> <span class="n">cell_ids</span><span class="p">,</span> <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid grid builder result: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="si">}</span><span class="s2"> elements&quot;</span><span class="p">)</span>

        <span class="c1"># Apply phi rotation if specified (vectorized operations)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_rotation_rad</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="p">[(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;phi&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_rotation_rad</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)]</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;phi_min&quot;</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">(</span>
                            <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;phi_min&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_rotation_rad</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;phi_min&quot;</span><span class="p">),</span>
                        <span class="p">(</span>
                            <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;phi_max&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_rotation_rad</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;phi_max&quot;</span><span class="p">),</span>
                    <span class="p">]</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;grid_build_complete&quot;</span><span class="p">,</span> <span class="n">ncells</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">grid</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">GridData</span><span class="p">(</span>
            <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
            <span class="n">theta_lims</span><span class="o">=</span><span class="n">theta_lims</span><span class="p">,</span>
            <span class="n">phi_lims</span><span class="o">=</span><span class="n">phi_lims</span><span class="p">,</span>
            <span class="n">cell_ids</span><span class="o">=</span><span class="n">cell_ids</span><span class="p">,</span>
            <span class="n">grid_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_grid_type</span><span class="p">(),</span>
            <span class="o">**</span><span class="n">extra_kwargs</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="canvod.grids.BaseGridBuilder.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">angular_resolution</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cutoff_theta</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">phi_rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>

<a href="#canvod.grids.BaseGridBuilder.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the grid builder.</p>
<h5 id="canvod.grids.BaseGridBuilder.__init__--parameters">Parameters<a class="headerlink" href="#canvod.grids.BaseGridBuilder.__init__--parameters" title="Permanent link">&para;</a></h5>
<p>angular_resolution : float, default 2
    Angular resolution in degrees.
cutoff_theta : float, default 0
    Maximum polar angle cutoff in degrees.
phi_rotation : float, default 0
    Rotation angle in degrees.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/core/grid_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">angular_resolution</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">cutoff_theta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">phi_rotation</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the grid builder.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    angular_resolution : float, default 2</span>
<span class="sd">        Angular resolution in degrees.</span>
<span class="sd">    cutoff_theta : float, default 0</span>
<span class="sd">        Maximum polar angle cutoff in degrees.</span>
<span class="sd">    phi_rotation : float, default 0</span>
<span class="sd">        Rotation angle in degrees.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">angular_resolution</span> <span class="o">=</span> <span class="n">angular_resolution</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">angular_resolution_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angular_resolution</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cutoff_theta</span> <span class="o">=</span> <span class="n">cutoff_theta</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cutoff_theta_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">cutoff_theta</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">phi_rotation</span> <span class="o">=</span> <span class="n">phi_rotation</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">phi_rotation_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">phi_rotation</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">_get_logger</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.BaseGridBuilder.get_grid_type" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_grid_type</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

<a href="#canvod.grids.BaseGridBuilder.get_grid_type" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Get grid type identifier.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/core/grid_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_grid_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get grid type identifier.&quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.BaseGridBuilder.build" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build</span><span class="p">()</span></code>

<a href="#canvod.grids.BaseGridBuilder.build" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Build hemisphere grid.</p>
<h5 id="canvod.grids.BaseGridBuilder.build--returns">Returns<a class="headerlink" href="#canvod.grids.BaseGridBuilder.build--returns" title="Permanent link">&para;</a></h5>
<p>GridData
    Complete grid data structure</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/core/grid_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GridData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build hemisphere grid.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    GridData</span>
<span class="sd">        Complete grid data structure</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;grid_build_started&quot;</span><span class="p">,</span>
        <span class="n">grid_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_grid_type</span><span class="p">(),</span>
        <span class="n">angular_resolution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">angular_resolution</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_grid</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">grid</span><span class="p">,</span> <span class="n">theta_lims</span><span class="p">,</span> <span class="n">phi_lims</span><span class="p">,</span> <span class="n">cell_ids</span> <span class="o">=</span> <span class="n">result</span>
        <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">grid</span><span class="p">,</span> <span class="n">theta_lims</span><span class="p">,</span> <span class="n">phi_lims</span><span class="p">,</span> <span class="n">cell_ids</span><span class="p">,</span> <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid grid builder result: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="si">}</span><span class="s2"> elements&quot;</span><span class="p">)</span>

    <span class="c1"># Apply phi rotation if specified (vectorized operations)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_rotation_rad</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="p">[(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;phi&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_rotation_rad</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)]</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;phi_min&quot;</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">(</span>
                        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;phi_min&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_rotation_rad</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;phi_min&quot;</span><span class="p">),</span>
                    <span class="p">(</span>
                        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;phi_max&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_rotation_rad</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;phi_max&quot;</span><span class="p">),</span>
                <span class="p">]</span>
            <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;grid_build_complete&quot;</span><span class="p">,</span> <span class="n">ncells</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">grid</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">GridData</span><span class="p">(</span>
        <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
        <span class="n">theta_lims</span><span class="o">=</span><span class="n">theta_lims</span><span class="p">,</span>
        <span class="n">phi_lims</span><span class="o">=</span><span class="n">phi_lims</span><span class="p">,</span>
        <span class="n">cell_ids</span><span class="o">=</span><span class="n">cell_ids</span><span class="p">,</span>
        <span class="n">grid_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_grid_type</span><span class="p">(),</span>
        <span class="o">**</span><span class="n">extra_kwargs</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="canvod.grids.GridData" class="doc doc-heading">
            <code>GridData</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

<a href="#canvod.grids.GridData" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">



        <p>Immutable container for hemispherical grid structure.</p>
<h4 id="canvod.grids.GridData--parameters">Parameters<a class="headerlink" href="#canvod.grids.GridData--parameters" title="Permanent link">&para;</a></h4>
<p>grid : pl.DataFrame
    Grid cells with phi, theta, and bounds
theta_lims : np.ndarray
    Theta band limits
phi_lims : list[np.ndarray]
    Phi limits per theta band
cell_ids : list[np.ndarray]
    Cell IDs per theta band
grid_type : str
    Grid type identifier
solid_angles : np.ndarray, optional
    Solid angles per cell [steradians]
metadata : dict, optional
    Additional grid metadata
voronoi : Any, optional
    Voronoi tessellation object (for Fibonacci grids)
vertices : np.ndarray, optional
    3D vertices (for triangular grids)
points_xyz : np.ndarray, optional
    3D point cloud (for Fibonacci grids)
vertex_phi : np.ndarray, optional
    Vertex phi coordinates
vertex_theta : np.ndarray, optional
    Vertex theta coordinates</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/core/grid_data.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">GridData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Immutable container for hemispherical grid structure.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    grid : pl.DataFrame</span>
<span class="sd">        Grid cells with phi, theta, and bounds</span>
<span class="sd">    theta_lims : np.ndarray</span>
<span class="sd">        Theta band limits</span>
<span class="sd">    phi_lims : list[np.ndarray]</span>
<span class="sd">        Phi limits per theta band</span>
<span class="sd">    cell_ids : list[np.ndarray]</span>
<span class="sd">        Cell IDs per theta band</span>
<span class="sd">    grid_type : str</span>
<span class="sd">        Grid type identifier</span>
<span class="sd">    solid_angles : np.ndarray, optional</span>
<span class="sd">        Solid angles per cell [steradians]</span>
<span class="sd">    metadata : dict, optional</span>
<span class="sd">        Additional grid metadata</span>
<span class="sd">    voronoi : Any, optional</span>
<span class="sd">        Voronoi tessellation object (for Fibonacci grids)</span>
<span class="sd">    vertices : np.ndarray, optional</span>
<span class="sd">        3D vertices (for triangular grids)</span>
<span class="sd">    points_xyz : np.ndarray, optional</span>
<span class="sd">        3D point cloud (for Fibonacci grids)</span>
<span class="sd">    vertex_phi : np.ndarray, optional</span>
<span class="sd">        Vertex phi coordinates</span>
<span class="sd">    vertex_theta : np.ndarray, optional</span>
<span class="sd">        Vertex theta coordinates</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">grid</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span>
    <span class="n">theta_lims</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">phi_lims</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
    <span class="n">cell_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
    <span class="n">grid_type</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">solid_angles</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">voronoi</span><span class="p">:</span> <span class="n">Any</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">vertices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">points_xyz</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">vertex_phi</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">vertex_theta</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">coords</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get cell coordinates.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;phi&quot;</span><span class="p">,</span> <span class="s2">&quot;theta&quot;</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ncells</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Number of cells in grid.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_patches</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create matplotlib patches for polar visualization.&quot;&quot;&quot;</span>
        <span class="n">patches</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Rectangle</span><span class="p">(</span>
                <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;phi_min&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;theta_min&quot;</span><span class="p">]),</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">&quot;phi_max&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;phi_min&quot;</span><span class="p">],</span>
                <span class="n">row</span><span class="p">[</span><span class="s2">&quot;theta_max&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;theta_min&quot;</span><span class="p">],</span>
                <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">iter_rows</span><span class="p">(</span><span class="n">named</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="s2">&quot;Patches&quot;</span><span class="p">,</span> <span class="n">patches</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_solid_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate solid angle for each cell [steradians].&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solid_angles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">solid_angles</span>

        <span class="c1"># HEALPix</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_type</span> <span class="o">==</span> <span class="s2">&quot;healpix&quot;</span> <span class="ow">and</span> <span class="s2">&quot;healpix_nside&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">healpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">hp</span>

                <span class="n">nside</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s2">&quot;healpix_nside&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">),</span> <span class="n">hp</span><span class="o">.</span><span class="n">nside2pixarea</span><span class="p">(</span><span class="n">nside</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="c1"># Geodesic</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_type</span> <span class="o">==</span> <span class="s2">&quot;geodesic&quot;</span> <span class="ow">and</span> <span class="s2">&quot;geodesic_vertices&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_geodesic_solid_angles</span><span class="p">()</span>

        <span class="c1"># HTM</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_type</span> <span class="o">==</span> <span class="s2">&quot;htm&quot;</span> <span class="ow">and</span> <span class="s2">&quot;htm_vertex_0&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_htm_solid_angles</span><span class="p">()</span>

        <span class="c1"># Fibonacci</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_type</span> <span class="o">==</span> <span class="s2">&quot;fibonacci&quot;</span> <span class="ow">and</span> <span class="s2">&quot;voronoi_region&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_voronoi_solid_angles</span><span class="p">()</span>

        <span class="c1"># Default</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geometric_solid_angles</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_htm_solid_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute solid angles for HTM triangular cells.&quot;&quot;&quot;</span>
        <span class="n">solid_angles</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">iter_rows</span><span class="p">(</span><span class="n">named</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">v0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;htm_vertex_0&quot;</span><span class="p">])</span>
            <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;htm_vertex_1&quot;</span><span class="p">])</span>
            <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;htm_vertex_2&quot;</span><span class="p">])</span>

            <span class="c1"># Spherical excess formula</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">v2</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">v1</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

            <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">tan_E_4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">s</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">((</span><span class="n">s</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">((</span><span class="n">s</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">((</span><span class="n">s</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">E</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">tan_E_4</span><span class="p">)</span>

            <span class="n">solid_angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">solid_angles</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_geodesic_solid_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute solid angles for geodesic triangular cells.&quot;&quot;&quot;</span>
        <span class="n">vertices</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">or</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;vertices&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vertices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geometric_solid_angles</span><span class="p">()</span>

        <span class="n">solid_angles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">iter_rows</span><span class="p">(</span><span class="n">named</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">v_indices</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;geodesic_vertices&quot;</span><span class="p">]</span>
            <span class="n">v0</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">vertices</span><span class="p">[</span><span class="n">v_indices</span><span class="p">]</span>

            <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">v2</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">v1</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

            <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">tan_E_4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">s</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">((</span><span class="n">s</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">((</span><span class="n">s</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">((</span><span class="n">s</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">E</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">tan_E_4</span><span class="p">)</span>

            <span class="n">solid_angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">solid_angles</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_voronoi_solid_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute solid angles for Voronoi cells.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">voronoi</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geometric_solid_angles</span><span class="p">()</span>

        <span class="n">sv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">voronoi</span>
        <span class="n">solid_angles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">iter_rows</span><span class="p">(</span><span class="n">named</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">region</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;voronoi_region&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">region</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">solid_angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">vertices</span> <span class="o">=</span> <span class="n">sv</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">region</span><span class="p">]</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;phi&quot;</span><span class="p">]),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;phi&quot;</span><span class="p">]),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">]),</span>
                <span class="p">]</span>
            <span class="p">)</span>

            <span class="n">total_angle</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vertices</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
                <span class="n">v1</span> <span class="o">=</span> <span class="n">vertices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">v2</span> <span class="o">=</span> <span class="n">vertices</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">n</span><span class="p">]</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">v1</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">v2</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                <span class="n">tan_E_4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">s</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">((</span><span class="n">s</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">((</span><span class="n">s</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">((</span><span class="n">s</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">E</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">tan_E_4</span><span class="p">)</span>
                <span class="n">total_angle</span> <span class="o">+=</span> <span class="n">E</span>
            <span class="n">solid_angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">total_angle</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">solid_angles</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_geometric_solid_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Fallback geometric calculation.&quot;&quot;&quot;</span>
        <span class="n">solid_angles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">iter_rows</span><span class="p">(</span><span class="n">named</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">delta_phi</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;phi_max&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;phi_min&quot;</span><span class="p">]</span>
            <span class="n">cos_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;theta_min&quot;</span><span class="p">])</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;theta_max&quot;</span><span class="p">])</span>
            <span class="n">omega</span> <span class="o">=</span> <span class="n">delta_phi</span> <span class="o">*</span> <span class="n">cos_diff</span>
            <span class="n">solid_angles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">omega</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">solid_angles</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_grid_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get grid statistics including solid angle uniformity.&quot;&quot;&quot;</span>
        <span class="n">solid_angles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_solid_angles</span><span class="p">()</span>

        <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;total_cells&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span>
            <span class="s2">&quot;grid_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_type</span><span class="p">,</span>
            <span class="s2">&quot;theta_bands&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_lims</span><span class="p">),</span>
            <span class="s2">&quot;cells_per_band&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="k">for</span> <span class="n">ids</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_ids</span><span class="p">],</span>
            <span class="s2">&quot;solid_angle_mean_sr&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">solid_angles</span><span class="p">)),</span>
            <span class="s2">&quot;solid_angle_std_sr&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">solid_angles</span><span class="p">)),</span>
            <span class="s2">&quot;solid_angle_cv_percent&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">solid_angles</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">solid_angles</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
            <span class="p">),</span>
            <span class="s2">&quot;total_solid_angle_sr&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">solid_angles</span><span class="p">)),</span>
            <span class="s2">&quot;hemisphere_solid_angle_sr&quot;</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># Add HEALPix-specific info</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_type</span> <span class="o">==</span> <span class="s2">&quot;healpix&quot;</span> <span class="ow">and</span> <span class="s2">&quot;healpix_nside&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">healpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">hp</span>

                <span class="n">nside</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s2">&quot;healpix_nside&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;healpix_nside&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nside</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;healpix_npix_total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hp</span><span class="o">.</span><span class="n">nside2npix</span><span class="p">(</span><span class="n">nside</span><span class="p">)</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;healpix_pixel_area_sr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hp</span><span class="o">.</span><span class="n">nside2pixarea</span><span class="p">(</span><span class="n">nside</span><span class="p">)</span>
                <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;healpix_resolution_arcmin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hp</span><span class="o">.</span><span class="n">nside2resol</span><span class="p">(</span><span class="n">nside</span><span class="p">,</span> <span class="n">arcmin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="n">stats</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="canvod.grids.GridData.coords" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">coords</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#canvod.grids.GridData.coords" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Get cell coordinates.</p>

    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="canvod.grids.GridData.ncells" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">ncells</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

<a href="#canvod.grids.GridData.ncells" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Number of cells in grid.</p>

    </div>

</div>




<div class="doc doc-object doc-function">


<h3 id="canvod.grids.GridData.get_patches" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_patches</span><span class="p">()</span></code>

<a href="#canvod.grids.GridData.get_patches" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Create matplotlib patches for polar visualization.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/core/grid_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_patches</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create matplotlib patches for polar visualization.&quot;&quot;&quot;</span>
    <span class="n">patches</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">Rectangle</span><span class="p">(</span>
            <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;phi_min&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;theta_min&quot;</span><span class="p">]),</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;phi_max&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;phi_min&quot;</span><span class="p">],</span>
            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;theta_max&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;theta_min&quot;</span><span class="p">],</span>
            <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">iter_rows</span><span class="p">(</span><span class="n">named</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">pl</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="s2">&quot;Patches&quot;</span><span class="p">,</span> <span class="n">patches</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.GridData.get_solid_angles" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_solid_angles</span><span class="p">()</span></code>

<a href="#canvod.grids.GridData.get_solid_angles" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Calculate solid angle for each cell [steradians].</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/core/grid_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_solid_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate solid angle for each cell [steradians].&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solid_angles</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">solid_angles</span>

    <span class="c1"># HEALPix</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_type</span> <span class="o">==</span> <span class="s2">&quot;healpix&quot;</span> <span class="ow">and</span> <span class="s2">&quot;healpix_nside&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">healpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">hp</span>

            <span class="n">nside</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s2">&quot;healpix_nside&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">),</span> <span class="n">hp</span><span class="o">.</span><span class="n">nside2pixarea</span><span class="p">(</span><span class="n">nside</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c1"># Geodesic</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_type</span> <span class="o">==</span> <span class="s2">&quot;geodesic&quot;</span> <span class="ow">and</span> <span class="s2">&quot;geodesic_vertices&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_geodesic_solid_angles</span><span class="p">()</span>

    <span class="c1"># HTM</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_type</span> <span class="o">==</span> <span class="s2">&quot;htm&quot;</span> <span class="ow">and</span> <span class="s2">&quot;htm_vertex_0&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_htm_solid_angles</span><span class="p">()</span>

    <span class="c1"># Fibonacci</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_type</span> <span class="o">==</span> <span class="s2">&quot;fibonacci&quot;</span> <span class="ow">and</span> <span class="s2">&quot;voronoi_region&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_voronoi_solid_angles</span><span class="p">()</span>

    <span class="c1"># Default</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_geometric_solid_angles</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.GridData.get_grid_stats" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_grid_stats</span><span class="p">()</span></code>

<a href="#canvod.grids.GridData.get_grid_stats" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Get grid statistics including solid angle uniformity.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/core/grid_data.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_grid_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get grid statistics including solid angle uniformity.&quot;&quot;&quot;</span>
    <span class="n">solid_angles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_solid_angles</span><span class="p">()</span>

    <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;total_cells&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span>
        <span class="s2">&quot;grid_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_type</span><span class="p">,</span>
        <span class="s2">&quot;theta_bands&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">theta_lims</span><span class="p">),</span>
        <span class="s2">&quot;cells_per_band&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span> <span class="k">for</span> <span class="n">ids</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_ids</span><span class="p">],</span>
        <span class="s2">&quot;solid_angle_mean_sr&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">solid_angles</span><span class="p">)),</span>
        <span class="s2">&quot;solid_angle_std_sr&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">solid_angles</span><span class="p">)),</span>
        <span class="s2">&quot;solid_angle_cv_percent&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">solid_angles</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">solid_angles</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="p">),</span>
        <span class="s2">&quot;total_solid_angle_sr&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">solid_angles</span><span class="p">)),</span>
        <span class="s2">&quot;hemisphere_solid_angle_sr&quot;</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Add HEALPix-specific info</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_type</span> <span class="o">==</span> <span class="s2">&quot;healpix&quot;</span> <span class="ow">and</span> <span class="s2">&quot;healpix_nside&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">healpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">hp</span>

            <span class="n">nside</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s2">&quot;healpix_nside&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;healpix_nside&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nside</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;healpix_npix_total&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hp</span><span class="o">.</span><span class="n">nside2npix</span><span class="p">(</span><span class="n">nside</span><span class="p">)</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;healpix_pixel_area_sr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hp</span><span class="o">.</span><span class="n">nside2pixarea</span><span class="p">(</span><span class="n">nside</span><span class="p">)</span>
            <span class="n">stats</span><span class="p">[</span><span class="s2">&quot;healpix_resolution_arcmin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hp</span><span class="o">.</span><span class="n">nside2resol</span><span class="p">(</span><span class="n">nside</span><span class="p">,</span> <span class="n">arcmin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">return</span> <span class="n">stats</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="canvod.grids.GridType" class="doc doc-heading">
            <code>GridType</code>


<a href="#canvod.grids.GridType" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="enum.Enum">Enum</span></code></p>



        <p>Available grid projection types for hemispherical tessellation.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/core/grid_types.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GridType</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Available grid projection types for hemispherical tessellation.&quot;&quot;&quot;</span>

    <span class="n">EQUAL_AREA</span> <span class="o">=</span> <span class="s2">&quot;equal_area&quot;</span>  <span class="c1"># Equal solid angle (ring-based)</span>
    <span class="n">EQUAL_ANGLE</span> <span class="o">=</span> <span class="s2">&quot;equal_angle&quot;</span>  <span class="c1"># Equal angular spacing</span>
    <span class="n">EQUIRECTANGULAR</span> <span class="o">=</span> <span class="s2">&quot;equirectangular&quot;</span>  <span class="c1"># Simple rectangular</span>
    <span class="n">HEALPIX</span> <span class="o">=</span> <span class="s2">&quot;healpix&quot;</span>  <span class="c1"># Hierarchical equal area</span>
    <span class="n">GEODESIC</span> <span class="o">=</span> <span class="s2">&quot;geodesic&quot;</span>  <span class="c1"># Icosahedral triangular</span>
    <span class="n">FIBONACCI</span> <span class="o">=</span> <span class="s2">&quot;fibonacci&quot;</span>  <span class="c1"># Golden spiral + Voronoi</span>
    <span class="n">HTM</span> <span class="o">=</span> <span class="s2">&quot;htm&quot;</span>  <span class="c1"># Hierarchical Triangular Mesh</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="canvod.grids.CellAggregator" class="doc doc-heading">
            <code>CellAggregator</code>


<a href="#canvod.grids.CellAggregator" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">



        <p>Polars-based per-cell aggregation helpers.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/aggregation.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CellAggregator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Polars-based per-cell aggregation helpers.&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">aggregate_by_cell</span><span class="p">(</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">value_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;VOD&quot;</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregate values by ``cell_id``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df : pl.DataFrame</span>
<span class="sd">            Must contain ``cell_id`` and *value_var* columns.</span>
<span class="sd">        value_var : str</span>
<span class="sd">            Column to aggregate.</span>
<span class="sd">        method : {&#39;mean&#39;, &#39;median&#39;, &#39;std&#39;, &#39;count&#39;}</span>
<span class="sd">            Aggregation method.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pl.DataFrame</span>
<span class="sd">            Two-column DataFrame: ``cell_id``, *value_var*.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;cell_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;pl.DataFrame must have &#39;cell_id&#39; column&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pl.DataFrame must have &#39;</span><span class="si">{</span><span class="n">value_var</span><span class="si">}</span><span class="s2">&#39; column&quot;</span><span class="p">)</span>

        <span class="n">agg_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">value_var</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s2">&quot;median&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">value_var</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span>
            <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">value_var</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
            <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">value_var</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">agg_map</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown method: </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;cell_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">agg_map</span><span class="p">[</span><span class="n">method</span><span class="p">]</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">value_var</span><span class="p">))</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;cell_id&quot;</span><span class="p">)</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="canvod.grids.CellAggregator.aggregate_by_cell" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">aggregate_by_cell</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">value_var</span><span class="o">=</span><span class="s1">&#39;VOD&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#canvod.grids.CellAggregator.aggregate_by_cell" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Aggregate values by <code>cell_id</code>.</p>
<h5 id="canvod.grids.CellAggregator.aggregate_by_cell--parameters">Parameters<a class="headerlink" href="#canvod.grids.CellAggregator.aggregate_by_cell--parameters" title="Permanent link">&para;</a></h5>
<p>df : pl.DataFrame
    Must contain <code>cell_id</code> and <em>value_var</em> columns.
value_var : str
    Column to aggregate.
method : {'mean', 'median', 'std', 'count'}
    Aggregation method.</p>
<h5 id="canvod.grids.CellAggregator.aggregate_by_cell--returns">Returns<a class="headerlink" href="#canvod.grids.CellAggregator.aggregate_by_cell--returns" title="Permanent link">&para;</a></h5>
<p>pl.DataFrame
    Two-column DataFrame: <code>cell_id</code>, <em>value_var</em>.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/aggregation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">aggregate_by_cell</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">value_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;VOD&quot;</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Aggregate values by ``cell_id``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pl.DataFrame</span>
<span class="sd">        Must contain ``cell_id`` and *value_var* columns.</span>
<span class="sd">    value_var : str</span>
<span class="sd">        Column to aggregate.</span>
<span class="sd">    method : {&#39;mean&#39;, &#39;median&#39;, &#39;std&#39;, &#39;count&#39;}</span>
<span class="sd">        Aggregation method.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pl.DataFrame</span>
<span class="sd">        Two-column DataFrame: ``cell_id``, *value_var*.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;cell_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;pl.DataFrame must have &#39;cell_id&#39; column&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pl.DataFrame must have &#39;</span><span class="si">{</span><span class="n">value_var</span><span class="si">}</span><span class="s2">&#39; column&quot;</span><span class="p">)</span>

    <span class="n">agg_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">value_var</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="s2">&quot;median&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">value_var</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span>
        <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">value_var</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
        <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">value_var</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">agg_map</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown method: </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">df</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;cell_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">agg_map</span><span class="p">[</span><span class="n">method</span><span class="p">]</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">value_var</span><span class="p">))</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;cell_id&quot;</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="canvod.grids.create_hemigrid" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_hemigrid</span><span class="p">(</span><span class="n">grid_type</span><span class="p">,</span> <span class="n">angular_resolution</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#canvod.grids.create_hemigrid" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Create hemisphere grid of specified type.</p>
<p>Factory function for creating various hemisphere grid types commonly
used in GNSS analysis.</p>
<h4 id="canvod.grids.create_hemigrid--parameters">Parameters<a class="headerlink" href="#canvod.grids.create_hemigrid--parameters" title="Permanent link">&para;</a></h4>
<p>grid_type : str
    Type of grid to create:
    - 'equal_area': Regular lat/lon grid with equal solid angle cells
    - 'equal_angle': Regular angular spacing (not recommended)
    - 'rectangular' or 'equirectangular': Simple rectangular grid
    - 'HTM': Hierarchical Triangular Mesh
    - 'geodesic': Geodesic sphere subdivision (icosahedron-based)
    - 'healpix': HEALPix grid (requires healpy)
    - 'fibonacci': Fibonacci sphere (requires scipy)
angular_resolution : float, default 10.0
    Angular resolution in degrees
**kwargs
    Additional grid-specific parameters:
    - cutoff_theta : float - Maximum theta angle cutoff (degrees)
    - phi_rotation : float - Rotation angle (degrees)
    - subdivision_level : int - For geodesic/HTM grids
    - htm_level : int - For HTM grids specifically
    - nside : int - For HEALPix grids
    - n_points : int - For Fibonacci grids</p>
<h4 id="canvod.grids.create_hemigrid--returns">Returns<a class="headerlink" href="#canvod.grids.create_hemigrid--returns" title="Permanent link">&para;</a></h4>
<p>GridData
    Complete hemisphere grid data structure</p>
<h4 id="canvod.grids.create_hemigrid--examples">Examples<a class="headerlink" href="#canvod.grids.create_hemigrid--examples" title="Permanent link">&para;</a></h4>
<blockquote>
<blockquote>
<blockquote>
<h3 id="canvod.grids.create_hemigrid--equal-area-grid-with-10-resolution">Equal area grid with 10Â° resolution<a class="headerlink" href="#canvod.grids.create_hemigrid--equal-area-grid-with-10-resolution" title="Permanent link">&para;</a></h3>
<p>grid = create_hemigrid('equal_area', angular_resolution=10.0)</p>
<h3 id="canvod.grids.create_hemigrid--htm-grid-with-subdivision-level-3">HTM grid with subdivision level 3<a class="headerlink" href="#canvod.grids.create_hemigrid--htm-grid-with-subdivision-level-3" title="Permanent link">&para;</a></h3>
<p>grid = create_hemigrid('HTM', angular_resolution=5.0, htm_level=3)</p>
<h3 id="canvod.grids.create_hemigrid--geodesic-grid">Geodesic grid<a class="headerlink" href="#canvod.grids.create_hemigrid--geodesic-grid" title="Permanent link">&para;</a></h3>
<p>grid = create_hemigrid('geodesic', angular_resolution=5.0, subdivision_level=2)</p>
</blockquote>
</blockquote>
</blockquote>
<h4 id="canvod.grids.create_hemigrid--notes">Notes<a class="headerlink" href="#canvod.grids.create_hemigrid--notes" title="Permanent link">&para;</a></h4>
<p>Grid coordinates use standard spherical convention:
- phi: azimuth angle, 0 to 2Ï (0 = East, Ï/2 = North)
- theta: elevation angle, 0 to Ï/2 (0 = zenith, Ï/2 = horizon)</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/__init__.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_hemigrid</span><span class="p">(</span>
    <span class="n">grid_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span>
        <span class="s2">&quot;equal_area&quot;</span><span class="p">,</span>
        <span class="s2">&quot;equal_angle&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rectangular&quot;</span><span class="p">,</span>
        <span class="s2">&quot;equirectangular&quot;</span><span class="p">,</span>
        <span class="s2">&quot;HTM&quot;</span><span class="p">,</span>
        <span class="s2">&quot;geodesic&quot;</span><span class="p">,</span>
        <span class="s2">&quot;healpix&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fibonacci&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">angular_resolution</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">10.0</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GridData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create hemisphere grid of specified type.</span>

<span class="sd">    Factory function for creating various hemisphere grid types commonly</span>
<span class="sd">    used in GNSS analysis.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    grid_type : str</span>
<span class="sd">        Type of grid to create:</span>
<span class="sd">        - &#39;equal_area&#39;: Regular lat/lon grid with equal solid angle cells</span>
<span class="sd">        - &#39;equal_angle&#39;: Regular angular spacing (not recommended)</span>
<span class="sd">        - &#39;rectangular&#39; or &#39;equirectangular&#39;: Simple rectangular grid</span>
<span class="sd">        - &#39;HTM&#39;: Hierarchical Triangular Mesh</span>
<span class="sd">        - &#39;geodesic&#39;: Geodesic sphere subdivision (icosahedron-based)</span>
<span class="sd">        - &#39;healpix&#39;: HEALPix grid (requires healpy)</span>
<span class="sd">        - &#39;fibonacci&#39;: Fibonacci sphere (requires scipy)</span>
<span class="sd">    angular_resolution : float, default 10.0</span>
<span class="sd">        Angular resolution in degrees</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Additional grid-specific parameters:</span>
<span class="sd">        - cutoff_theta : float - Maximum theta angle cutoff (degrees)</span>
<span class="sd">        - phi_rotation : float - Rotation angle (degrees)</span>
<span class="sd">        - subdivision_level : int - For geodesic/HTM grids</span>
<span class="sd">        - htm_level : int - For HTM grids specifically</span>
<span class="sd">        - nside : int - For HEALPix grids</span>
<span class="sd">        - n_points : int - For Fibonacci grids</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    GridData</span>
<span class="sd">        Complete hemisphere grid data structure</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; # Equal area grid with 10Â° resolution</span>
<span class="sd">    &gt;&gt;&gt; grid = create_hemigrid(&#39;equal_area&#39;, angular_resolution=10.0)</span>
<span class="sd">    &gt;&gt;&gt;</span>
<span class="sd">    &gt;&gt;&gt; # HTM grid with subdivision level 3</span>
<span class="sd">    &gt;&gt;&gt; grid = create_hemigrid(&#39;HTM&#39;, angular_resolution=5.0, htm_level=3)</span>
<span class="sd">    &gt;&gt;&gt;</span>
<span class="sd">    &gt;&gt;&gt; # Geodesic grid</span>
<span class="sd">    &gt;&gt;&gt; grid = create_hemigrid(&#39;geodesic&#39;, angular_resolution=5.0, subdivision_level=2)</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Grid coordinates use standard spherical convention:</span>
<span class="sd">    - phi: azimuth angle, 0 to 2Ï (0 = East, Ï/2 = North)</span>
<span class="sd">    - theta: elevation angle, 0 to Ï/2 (0 = zenith, Ï/2 = horizon)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">grid_type_lower</span> <span class="o">=</span> <span class="n">grid_type</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">grid_type_lower</span> <span class="o">==</span> <span class="s2">&quot;equal_area&quot;</span><span class="p">:</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">EqualAreaBuilder</span><span class="p">(</span>
            <span class="n">angular_resolution</span><span class="o">=</span><span class="n">angular_resolution</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">grid_type_lower</span> <span class="o">==</span> <span class="s2">&quot;equal_angle&quot;</span><span class="p">:</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">EqualAngleBuilder</span><span class="p">(</span>
            <span class="n">angular_resolution</span><span class="o">=</span><span class="n">angular_resolution</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">grid_type_lower</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;rectangular&quot;</span><span class="p">,</span> <span class="s2">&quot;equirectangular&quot;</span><span class="p">]:</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">EquirectangularBuilder</span><span class="p">(</span>
            <span class="n">angular_resolution</span><span class="o">=</span><span class="n">angular_resolution</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">grid_type_lower</span> <span class="o">==</span> <span class="s2">&quot;htm&quot;</span><span class="p">:</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">HTMBuilder</span><span class="p">(</span>
            <span class="n">angular_resolution</span><span class="o">=</span><span class="n">angular_resolution</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">grid_type_lower</span> <span class="o">==</span> <span class="s2">&quot;geodesic&quot;</span><span class="p">:</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">GeodesicBuilder</span><span class="p">(</span>
            <span class="n">angular_resolution</span><span class="o">=</span><span class="n">angular_resolution</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">grid_type_lower</span> <span class="o">==</span> <span class="s2">&quot;healpix&quot;</span><span class="p">:</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">HEALPixBuilder</span><span class="p">(</span>
            <span class="n">angular_resolution</span><span class="o">=</span><span class="n">angular_resolution</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="n">grid_type_lower</span> <span class="o">==</span> <span class="s2">&quot;fibonacci&quot;</span><span class="p">:</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">FibonacciBuilder</span><span class="p">(</span>
            <span class="n">angular_resolution</span><span class="o">=</span><span class="n">angular_resolution</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unknown grid type: </span><span class="si">{</span><span class="n">grid_type</span><span class="si">}</span><span class="s2">. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Available types: equal_area, equal_angle, rectangular, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;equirectangular, HTM, geodesic, healpix, fibonacci&quot;</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h2 id="grid-builders">Grid Builders<a class="headerlink" href="#grid-builders" title="Permanent link">&para;</a></h2>


<div class="doc doc-object doc-module">



<a id="canvod.grids.core.grid_builder"></a>
    <div class="doc doc-contents first">

        <p>Base class for hemisphere grid builders.</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="canvod.grids.core.grid_builder.BaseGridBuilder" class="doc doc-heading">
            <code>BaseGridBuilder</code>


<a href="#canvod.grids.core.grid_builder.BaseGridBuilder" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>



        <p>Abstract base for hemispherical grid builders.</p>
<h4 id="canvod.grids.core.grid_builder.BaseGridBuilder--parameters">Parameters<a class="headerlink" href="#canvod.grids.core.grid_builder.BaseGridBuilder--parameters" title="Permanent link">&para;</a></h4>
<p>angular_resolution : float
    Angular resolution in degrees
cutoff_theta : float
    Maximum polar angle cutoff in degrees
phi_rotation : float
    Rotation angle in degrees (applied to all phi values)</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/core/grid_builder.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BaseGridBuilder</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base for hemispherical grid builders.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    angular_resolution : float</span>
<span class="sd">        Angular resolution in degrees</span>
<span class="sd">    cutoff_theta : float</span>
<span class="sd">        Maximum polar angle cutoff in degrees</span>
<span class="sd">    phi_rotation : float</span>
<span class="sd">        Rotation angle in degrees (applied to all phi values)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">angular_resolution</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">cutoff_theta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">phi_rotation</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the grid builder.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        angular_resolution : float, default 2</span>
<span class="sd">            Angular resolution in degrees.</span>
<span class="sd">        cutoff_theta : float, default 0</span>
<span class="sd">            Maximum polar angle cutoff in degrees.</span>
<span class="sd">        phi_rotation : float, default 0</span>
<span class="sd">            Rotation angle in degrees.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angular_resolution</span> <span class="o">=</span> <span class="n">angular_resolution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">angular_resolution_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angular_resolution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cutoff_theta</span> <span class="o">=</span> <span class="n">cutoff_theta</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cutoff_theta_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">cutoff_theta</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phi_rotation</span> <span class="o">=</span> <span class="n">phi_rotation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phi_rotation_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">phi_rotation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">_get_logger</span><span class="p">()</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_build_grid</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span>
        <span class="nb">tuple</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span>
        <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
        <span class="p">]</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build grid.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        grid : pl.DataFrame</span>
<span class="sd">            Grid cells</span>
<span class="sd">        theta_lims : np.ndarray</span>
<span class="sd">            Theta band limits</span>
<span class="sd">        phi_lims : list[np.ndarray]</span>
<span class="sd">            Phi limits per band</span>
<span class="sd">        cell_ids : list[np.ndarray]</span>
<span class="sd">            Cell IDs per band</span>
<span class="sd">        extra_kwargs : dict, optional</span>
<span class="sd">            Additional metadata</span>

<span class="sd">        &quot;&quot;&quot;</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_grid_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get grid type identifier.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GridData</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build hemisphere grid.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        GridData</span>
<span class="sd">            Complete grid data structure</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;grid_build_started&quot;</span><span class="p">,</span>
            <span class="n">grid_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_grid_type</span><span class="p">(),</span>
            <span class="n">angular_resolution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">angular_resolution</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_grid</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">grid</span><span class="p">,</span> <span class="n">theta_lims</span><span class="p">,</span> <span class="n">phi_lims</span><span class="p">,</span> <span class="n">cell_ids</span> <span class="o">=</span> <span class="n">result</span>
            <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">grid</span><span class="p">,</span> <span class="n">theta_lims</span><span class="p">,</span> <span class="n">phi_lims</span><span class="p">,</span> <span class="n">cell_ids</span><span class="p">,</span> <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="n">result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid grid builder result: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="si">}</span><span class="s2"> elements&quot;</span><span class="p">)</span>

        <span class="c1"># Apply phi rotation if specified (vectorized operations)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_rotation_rad</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="p">[(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;phi&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_rotation_rad</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)]</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="s2">&quot;phi_min&quot;</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="p">(</span>
                            <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;phi_min&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_rotation_rad</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;phi_min&quot;</span><span class="p">),</span>
                        <span class="p">(</span>
                            <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;phi_max&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_rotation_rad</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;phi_max&quot;</span><span class="p">),</span>
                    <span class="p">]</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;grid_build_complete&quot;</span><span class="p">,</span> <span class="n">ncells</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">grid</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">GridData</span><span class="p">(</span>
            <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
            <span class="n">theta_lims</span><span class="o">=</span><span class="n">theta_lims</span><span class="p">,</span>
            <span class="n">phi_lims</span><span class="o">=</span><span class="n">phi_lims</span><span class="p">,</span>
            <span class="n">cell_ids</span><span class="o">=</span><span class="n">cell_ids</span><span class="p">,</span>
            <span class="n">grid_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_grid_type</span><span class="p">(),</span>
            <span class="o">**</span><span class="n">extra_kwargs</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="canvod.grids.core.grid_builder.BaseGridBuilder.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">angular_resolution</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cutoff_theta</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">phi_rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>

<a href="#canvod.grids.core.grid_builder.BaseGridBuilder.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the grid builder.</p>
<h5 id="canvod.grids.core.grid_builder.BaseGridBuilder.__init__--parameters">Parameters<a class="headerlink" href="#canvod.grids.core.grid_builder.BaseGridBuilder.__init__--parameters" title="Permanent link">&para;</a></h5>
<p>angular_resolution : float, default 2
    Angular resolution in degrees.
cutoff_theta : float, default 0
    Maximum polar angle cutoff in degrees.
phi_rotation : float, default 0
    Rotation angle in degrees.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/core/grid_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">angular_resolution</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">cutoff_theta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">phi_rotation</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the grid builder.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    angular_resolution : float, default 2</span>
<span class="sd">        Angular resolution in degrees.</span>
<span class="sd">    cutoff_theta : float, default 0</span>
<span class="sd">        Maximum polar angle cutoff in degrees.</span>
<span class="sd">    phi_rotation : float, default 0</span>
<span class="sd">        Rotation angle in degrees.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">angular_resolution</span> <span class="o">=</span> <span class="n">angular_resolution</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">angular_resolution_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">angular_resolution</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cutoff_theta</span> <span class="o">=</span> <span class="n">cutoff_theta</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cutoff_theta_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">cutoff_theta</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">phi_rotation</span> <span class="o">=</span> <span class="n">phi_rotation</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">phi_rotation_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">phi_rotation</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">_get_logger</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.core.grid_builder.BaseGridBuilder.get_grid_type" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_grid_type</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

<a href="#canvod.grids.core.grid_builder.BaseGridBuilder.get_grid_type" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Get grid type identifier.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/core/grid_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_grid_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get grid type identifier.&quot;&quot;&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.core.grid_builder.BaseGridBuilder.build" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">build</span><span class="p">()</span></code>

<a href="#canvod.grids.core.grid_builder.BaseGridBuilder.build" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Build hemisphere grid.</p>
<h5 id="canvod.grids.core.grid_builder.BaseGridBuilder.build--returns">Returns<a class="headerlink" href="#canvod.grids.core.grid_builder.BaseGridBuilder.build--returns" title="Permanent link">&para;</a></h5>
<p>GridData
    Complete grid data structure</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/core/grid_builder.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GridData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build hemisphere grid.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    GridData</span>
<span class="sd">        Complete grid data structure</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;grid_build_started&quot;</span><span class="p">,</span>
        <span class="n">grid_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_grid_type</span><span class="p">(),</span>
        <span class="n">angular_resolution</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">angular_resolution</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_build_grid</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
        <span class="n">grid</span><span class="p">,</span> <span class="n">theta_lims</span><span class="p">,</span> <span class="n">phi_lims</span><span class="p">,</span> <span class="n">cell_ids</span> <span class="o">=</span> <span class="n">result</span>
        <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
        <span class="n">grid</span><span class="p">,</span> <span class="n">theta_lims</span><span class="p">,</span> <span class="n">phi_lims</span><span class="p">,</span> <span class="n">cell_ids</span><span class="p">,</span> <span class="n">extra_kwargs</span> <span class="o">=</span> <span class="n">result</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid grid builder result: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="si">}</span><span class="s2"> elements&quot;</span><span class="p">)</span>

    <span class="c1"># Apply phi rotation if specified (vectorized operations)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_rotation_rad</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="p">[(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;phi&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_rotation_rad</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)]</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;phi_min&quot;</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">(</span>
                        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;phi_min&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_rotation_rad</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;phi_min&quot;</span><span class="p">),</span>
                    <span class="p">(</span>
                        <span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;phi_max&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">phi_rotation_rad</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;phi_max&quot;</span><span class="p">),</span>
                <span class="p">]</span>
            <span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;grid_build_complete&quot;</span><span class="p">,</span> <span class="n">ncells</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">grid</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">GridData</span><span class="p">(</span>
        <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
        <span class="n">theta_lims</span><span class="o">=</span><span class="n">theta_lims</span><span class="p">,</span>
        <span class="n">phi_lims</span><span class="o">=</span><span class="n">phi_lims</span><span class="p">,</span>
        <span class="n">cell_ids</span><span class="o">=</span><span class="n">cell_ids</span><span class="p">,</span>
        <span class="n">grid_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_grid_type</span><span class="p">(),</span>
        <span class="o">**</span><span class="n">extra_kwargs</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><h3 id="equal-area-grid">Equal-Area Grid<a class="headerlink" href="#equal-area-grid" title="Permanent link">&para;</a></h3>


<div class="doc doc-object doc-module">



<a id="canvod.grids.grids_impl.equal_area_grid"></a>
    <div class="doc doc-contents first">

        <p>Equal-area grid implementation.</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="canvod.grids.grids_impl.equal_area_grid.EqualAreaBuilder" class="doc doc-heading">
            <code>EqualAreaBuilder</code>


<a href="#canvod.grids.grids_impl.equal_area_grid.EqualAreaBuilder" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="canvod.grids.core.grid_builder.BaseGridBuilder">BaseGridBuilder</span></code></p>



        <p>Equal solid angle tessellation using concentric theta bands.</p>
<p>The hemisphere is divided into annular bands of constant width in theta.
Within each band the number of azimuthal (phi) sectors is chosen so that
every cell subtends approximately the same solid angle.  This is the only
grid type that has been validated for scientific use in this codebase.</p>
<h4 id="canvod.grids.grids_impl.equal_area_grid.EqualAreaBuilder--coordinate-convention-physics-gnss">Coordinate convention (physics / GNSS)<a class="headerlink" href="#canvod.grids.grids_impl.equal_area_grid.EqualAreaBuilder--coordinate-convention-physics-gnss" title="Permanent link">&para;</a></h4>
<ul>
<li>phi  â [0, 2Ï)  â azimuthal angle measured from East, counter-clockwise</li>
<li>theta â [0, Ï/2] â polar angle measured from zenith (0 = straight up,
  Ï/2 = horizon)</li>
</ul>
<h4 id="canvod.grids.grids_impl.equal_area_grid.EqualAreaBuilder--what-angular_resolution-means">What <code>angular_resolution</code> means<a class="headerlink" href="#canvod.grids.grids_impl.equal_area_grid.EqualAreaBuilder--what-angular_resolution-means" title="Permanent link">&para;</a></h4>
<p><code>angular_resolution</code> (degrees) sets the <strong>width of each theta band</strong>.
All bands have this same width ÎÎ¸.  The <em>azimuthal</em> width of cells varies
by band: near the zenith cells are wide in phi; near the horizon they are
narrow, so that the solid angle stays constant.</p>
<h4 id="canvod.grids.grids_impl.equal_area_grid.EqualAreaBuilder--mathematical-construction">Mathematical construction<a class="headerlink" href="#canvod.grids.grids_impl.equal_area_grid.EqualAreaBuilder--mathematical-construction" title="Permanent link">&para;</a></h4>
<ol>
<li>
<p><strong>Target solid angle</strong> per cell is chosen equal to the solid angle of a
   cap of half-angle ÎÎ¸/2::</p>
<p>Î©_target = 2Ï (1 â cos(ÎÎ¸/2))</p>
</li>
<li>
<p><strong>Zenith cap</strong> â a single cell covers [0, ÎÎ¸/2] in theta and the full
   azimuth [0, 2Ï).</p>
</li>
<li>
<p><strong>Theta bands</strong> â edges are placed at ÎÎ¸/2, 3ÎÎ¸/2, 5ÎÎ¸/2, â¦ up to
   Ï/2 â cutoff_theta.  For each band [Î¸_inner, Î¸_outer] the band's
   total solid angle is::</p>
<p>Î©_band = 2Ï (cos Î¸_inner â cos Î¸_outer)</p>
</li>
<li>
<p><strong>Phi divisions</strong> â the number of sectors in the band is::</p>
<p>n_phi = round(Î©_band / Î©_target)</p>
</li>
</ol>
<p>Each sector spans ÎÏ = 2Ï / n_phi.  The cell centre is placed at the
   geometric midpoint of its (phi, theta) rectangle.</p>
<h4 id="canvod.grids.grids_impl.equal_area_grid.EqualAreaBuilder--parameters">Parameters<a class="headerlink" href="#canvod.grids.grids_impl.equal_area_grid.EqualAreaBuilder--parameters" title="Permanent link">&para;</a></h4>
<p>angular_resolution : float
    Theta-band width in degrees.  Controls both the radial resolution and
    (indirectly, via the equal-area constraint) the azimuthal resolution.
cutoff_theta : float
    Minimum elevation above the horizon in degrees.  Bands whose outer
    edge is at or below this cutoff are omitted.  In GNSS terms this is
    the satellite elevation mask angle.
phi_rotation : float
    Rigid rotation applied to all phi coordinates after grid construction,
    in degrees.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/grids_impl/equal_area_grid.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">EqualAreaBuilder</span><span class="p">(</span><span class="n">BaseGridBuilder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Equal solid angle tessellation using concentric theta bands.</span>

<span class="sd">    The hemisphere is divided into annular bands of constant width in theta.</span>
<span class="sd">    Within each band the number of azimuthal (phi) sectors is chosen so that</span>
<span class="sd">    every cell subtends approximately the same solid angle.  This is the only</span>
<span class="sd">    grid type that has been validated for scientific use in this codebase.</span>

<span class="sd">    Coordinate convention (physics / GNSS)</span>
<span class="sd">    ---------------------------------------</span>
<span class="sd">    * phi  â [0, 2Ï)  â azimuthal angle measured from East, counter-clockwise</span>
<span class="sd">    * theta â [0, Ï/2] â polar angle measured from zenith (0 = straight up,</span>
<span class="sd">      Ï/2 = horizon)</span>

<span class="sd">    What ``angular_resolution`` means</span>
<span class="sd">    ----------------------------------</span>
<span class="sd">    ``angular_resolution`` (degrees) sets the **width of each theta band**.</span>
<span class="sd">    All bands have this same width ÎÎ¸.  The *azimuthal* width of cells varies</span>
<span class="sd">    by band: near the zenith cells are wide in phi; near the horizon they are</span>
<span class="sd">    narrow, so that the solid angle stays constant.</span>

<span class="sd">    Mathematical construction</span>
<span class="sd">    -------------------------</span>
<span class="sd">    1. **Target solid angle** per cell is chosen equal to the solid angle of a</span>
<span class="sd">       cap of half-angle ÎÎ¸/2::</span>

<span class="sd">           Î©_target = 2Ï (1 â cos(ÎÎ¸/2))</span>

<span class="sd">    2. **Zenith cap** â a single cell covers [0, ÎÎ¸/2] in theta and the full</span>
<span class="sd">       azimuth [0, 2Ï).</span>

<span class="sd">    3. **Theta bands** â edges are placed at ÎÎ¸/2, 3ÎÎ¸/2, 5ÎÎ¸/2, â¦ up to</span>
<span class="sd">       Ï/2 â cutoff_theta.  For each band [Î¸_inner, Î¸_outer] the band&#39;s</span>
<span class="sd">       total solid angle is::</span>

<span class="sd">           Î©_band = 2Ï (cos Î¸_inner â cos Î¸_outer)</span>

<span class="sd">    4. **Phi divisions** â the number of sectors in the band is::</span>

<span class="sd">           n_phi = round(Î©_band / Î©_target)</span>

<span class="sd">       Each sector spans ÎÏ = 2Ï / n_phi.  The cell centre is placed at the</span>
<span class="sd">       geometric midpoint of its (phi, theta) rectangle.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    angular_resolution : float</span>
<span class="sd">        Theta-band width in degrees.  Controls both the radial resolution and</span>
<span class="sd">        (indirectly, via the equal-area constraint) the azimuthal resolution.</span>
<span class="sd">    cutoff_theta : float</span>
<span class="sd">        Minimum elevation above the horizon in degrees.  Bands whose outer</span>
<span class="sd">        edge is at or below this cutoff are omitted.  In GNSS terms this is</span>
<span class="sd">        the satellite elevation mask angle.</span>
<span class="sd">    phi_rotation : float</span>
<span class="sd">        Rigid rotation applied to all phi coordinates after grid construction,</span>
<span class="sd">        in degrees.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_grid_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the grid-type identifier string.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            ``&quot;equal_area&quot;``</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">GridType</span><span class="o">.</span><span class="n">EQUAL_AREA</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_grid</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct the equal-area hemisphere grid.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        grid : pl.DataFrame</span>
<span class="sd">            One row per cell with columns: phi, theta, phi_min, phi_max,</span>
<span class="sd">            theta_min, theta_max, cell_id.</span>
<span class="sd">        theta_lims : np.ndarray</span>
<span class="sd">            Outer theta edge of each band (radians).</span>
<span class="sd">        phi_lims : list[np.ndarray]</span>
<span class="sd">            Array of phi_min values for each band.</span>
<span class="sd">        cell_ids : list[np.ndarray]</span>
<span class="sd">            Cell-id arrays, one per band.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Theta band edges (from zenith to horizon)</span>
        <span class="n">max_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># horizon</span>
        <span class="n">theta_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">angular_resolution_rad</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">max_theta</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff_theta_rad</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">angular_resolution_rad</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Target solid angle per cell</span>
        <span class="n">target_omega</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angular_resolution_rad</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>

        <span class="n">cells</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">theta_lims</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">phi_lims</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cell_ids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Zenith cell (special case) - only if cutoff allows</span>
        <span class="n">next_cell_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">zenith_theta_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angular_resolution_rad</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff_theta_rad</span> <span class="o">&lt;</span> <span class="n">zenith_theta_max</span><span class="p">:</span>
            <span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;phi&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span>
                        <span class="s2">&quot;theta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span>
                        <span class="s2">&quot;phi_min&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span>
                        <span class="s2">&quot;phi_max&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">],</span>
                        <span class="s2">&quot;theta_min&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff_theta_rad</span><span class="p">)],</span>
                        <span class="s2">&quot;theta_max&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">zenith_theta_max</span><span class="p">],</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">theta_lims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">zenith_theta_max</span><span class="p">)</span>
            <span class="n">phi_lims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]))</span>
            <span class="n">cell_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">next_cell_id</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Build theta bands</span>
        <span class="k">for</span> <span class="n">iband</span><span class="p">,</span> <span class="n">theta_outer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">theta_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="n">theta_inner</span> <span class="o">=</span> <span class="n">theta_edges</span><span class="p">[</span><span class="n">iband</span><span class="p">]</span>

            <span class="c1"># Skip bands below cutoff</span>
            <span class="k">if</span> <span class="n">theta_outer</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff_theta_rad</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># Solid angle of this band</span>
            <span class="n">band_omega</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_inner</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_outer</span><span class="p">))</span>

            <span class="c1"># Number of phi divisions</span>
            <span class="n">n_phi</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">band_omega</span> <span class="o">/</span> <span class="n">target_omega</span><span class="p">))</span>
            <span class="n">phi_span</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">n_phi</span>

            <span class="n">cell_id_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">next_cell_id</span><span class="p">,</span> <span class="n">next_cell_id</span> <span class="o">+</span> <span class="n">n_phi</span><span class="p">))</span>
            <span class="n">next_cell_id</span> <span class="o">=</span> <span class="n">cell_id_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="c1"># Use arange for better precision than linspace</span>
            <span class="n">phi_min_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">phi_span</span>
            <span class="n">phi_max_arr</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_phi</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">phi_span</span>
            <span class="n">phi_max_arr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>  <span class="c1"># Force exact closure</span>

            <span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;phi&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">phi_min_arr</span> <span class="o">+</span> <span class="n">phi_max_arr</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="s2">&quot;theta&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_phi</span><span class="p">,</span> <span class="p">(</span><span class="n">theta_inner</span> <span class="o">+</span> <span class="n">theta_outer</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span>
                        <span class="s2">&quot;phi_min&quot;</span><span class="p">:</span> <span class="n">phi_min_arr</span><span class="p">,</span>
                        <span class="s2">&quot;phi_max&quot;</span><span class="p">:</span> <span class="n">phi_max_arr</span><span class="p">,</span>
                        <span class="s2">&quot;theta_min&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_phi</span><span class="p">,</span> <span class="n">theta_inner</span><span class="p">),</span>
                        <span class="s2">&quot;theta_max&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_phi</span><span class="p">,</span> <span class="n">theta_outer</span><span class="p">),</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="n">theta_lims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">theta_outer</span><span class="p">)</span>
            <span class="n">phi_lims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phi_min_arr</span><span class="p">)</span>
            <span class="n">cell_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cell_id_list</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;No cells generated - check cutoff_theta and angular_resolution&quot;</span>
            <span class="p">)</span>

        <span class="n">grid</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">int_range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">())</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;cell_id&quot;</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">grid</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">theta_lims</span><span class="p">),</span> <span class="n">phi_lims</span><span class="p">,</span> <span class="n">cell_ids</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="canvod.grids.grids_impl.equal_area_grid.EqualAreaBuilder.get_grid_type" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_grid_type</span><span class="p">()</span></code>

<a href="#canvod.grids.grids_impl.equal_area_grid.EqualAreaBuilder.get_grid_type" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Return the grid-type identifier string.</p>
<h5 id="canvod.grids.grids_impl.equal_area_grid.EqualAreaBuilder.get_grid_type--returns">Returns<a class="headerlink" href="#canvod.grids.grids_impl.equal_area_grid.EqualAreaBuilder.get_grid_type--returns" title="Permanent link">&para;</a></h5>
<p>str
    <code>"equal_area"</code></p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/grids_impl/equal_area_grid.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_grid_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the grid-type identifier string.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        ``&quot;equal_area&quot;``</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">GridType</span><span class="o">.</span><span class="n">EQUAL_AREA</span><span class="o">.</span><span class="n">value</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><h3 id="healpix-grid">HEALPix Grid<a class="headerlink" href="#healpix-grid" title="Permanent link">&para;</a></h3>


<div class="doc doc-object doc-module">



<a id="canvod.grids.grids_impl.healpix_grid"></a>
    <div class="doc doc-contents first">

        <p>HEALPix grid implementation.</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="canvod.grids.grids_impl.healpix_grid.HEALPixBuilder" class="doc doc-heading">
            <code>HEALPixBuilder</code>


<a href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="canvod.grids.core.grid_builder.BaseGridBuilder">BaseGridBuilder</span></code></p>



        <p>HEALPix tessellation (Hierarchical Equal Area isoLatitude Pixelization).</p>
<p>HEALPix partitions the sphere into 12 base pixels arranged at equal
latitudes.  Each base pixel is recursively subdivided into 4 children,
producing <code>12 Ã nsideÂ²</code> pixels on the full sphere, all with <em>exactly</em>
the same solid angle.  This strict equal-area property makes HEALPix
the gold standard for pixelisations that must be unbiased under
solid-angle weighting.</p>
<p>This builder delegates the pixel geometry entirely to the <code>healpy</code>
library.  It filters the full-sphere pixelisation down to the northern
hemisphere and stores approximate bounding boxes (<code>phi_min/max</code>,
<code>theta_min/max</code>) derived from the pixel resolution.  The bounding
boxes are <strong>not</strong> the true pixel boundaries (which are curvilinear);
they are only approximations suitable for quick spatial queries.  For
exact pixel membership use <code>healpy.ang2pix</code> directly.</p>
<h4 id="canvod.grids.grids_impl.healpix_grid.HEALPixBuilder--coordinate-convention">Coordinate convention<a class="headerlink" href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder--coordinate-convention" title="Permanent link">&para;</a></h4>
<p>HEALPix natively uses colatitude <code>theta â [0, Ï]</code> (0 = North Pole)
and longitude <code>phi â [0, 2Ï)</code>.  This matches the GNSS convention used
elsewhere in canvodpy: theta = 0 is the zenith, theta = Ï/2 is the
horizon.  <strong>No coordinate transform is applied.</strong></p>
<h4 id="canvod.grids.grids_impl.healpix_grid.HEALPixBuilder--what-nside-resolution-means">What <code>nside</code> (resolution) means<a class="headerlink" href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder--what-nside-resolution-means" title="Permanent link">&para;</a></h4>
<p><code>nside</code> is the single resolution parameter of HEALPix.  It must be a
power of 2.  The key derived quantities are::</p>
<div class="highlight"><pre><span></span><code>n_pixels   = 12 Ã nsideÂ²           (full sphere)
pixel_area = 4Ï / n_pixels          (steradians, exact)
resolution â â(pixel_area)          (approximate angular diameter)
           â 58.6Â° / nside         (degrees)
</code></pre></div>
<table>
<thead>
<tr>
<th>nside</th>
<th>Pixels (full)</th>
<th>Approx resolution</th>
<th>Pixel area (sr)</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>12</td>
<td>58.6Â°</td>
<td>1.049</td>
</tr>
<tr>
<td>2</td>
<td>48</td>
<td>29.3Â°</td>
<td>0.262</td>
</tr>
<tr>
<td>4</td>
<td>192</td>
<td>14.7Â°</td>
<td>0.065</td>
</tr>
<tr>
<td>8</td>
<td>768</td>
<td>7.3Â°</td>
<td>0.016</td>
</tr>
<tr>
<td>16</td>
<td>3 072</td>
<td>3.7Â°</td>
<td>0.004</td>
</tr>
<tr>
<td>32</td>
<td>12 288</td>
<td>1.8Â°</td>
<td>0.001</td>
</tr>
</tbody>
</table>
<p>When <code>nside</code> is not provided, it is estimated from <code>angular_resolution</code>
and rounded to the nearest power of 2::</p>
<div class="highlight"><pre><span></span><code>nside_estimate = round_to_pow2( â(3/Ï) Ã 60 / angular_resolution )
</code></pre></div>
<h4 id="canvod.grids.grids_impl.healpix_grid.HEALPixBuilder--mathematical-construction">Mathematical construction<a class="headerlink" href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder--mathematical-construction" title="Permanent link">&para;</a></h4>
<p>HEALPix construction is performed entirely by <code>healpy</code>.  At a high
level:</p>
<ol>
<li>The sphere is divided into 12 congruent base pixels (a curvilinear
   quadrilateral arrangement at three latitude zones: polar caps and
   equatorial belt).</li>
<li>Each base pixel is subdivided into <code>nsideÂ²</code> equal-area children
   using a hierarchical quadtree.</li>
<li>Pixel centres are returned by <code>healpy.pix2ang(nside, ipix)</code> in
   RING ordering (pixels ordered by increasing colatitude).</li>
<li>This builder keeps only pixels with <code>theta â¤ Ï/2 â cutoff_theta</code>
   (northern hemisphere above the elevation mask).</li>
</ol>
<h4 id="canvod.grids.grids_impl.healpix_grid.HEALPixBuilder--parameters">Parameters<a class="headerlink" href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder--parameters" title="Permanent link">&para;</a></h4>
<p>angular_resolution : float
    Approximate angular resolution in degrees.  Used only to derive
    <code>nside</code> when that parameter is not given explicitly.
cutoff_theta : float
    Elevation mask angle in degrees.  Pixels with colatitude
    <code>theta &gt; Ï/2 â cutoff_theta</code> (i.e. below the mask) are excluded.
nside : int or None
    HEALPix resolution parameter.  Must be a power of 2.  If <code>None</code>,
    estimated from <code>angular_resolution</code>.
phi_rotation : float
    Rigid azimuthal rotation applied after construction, in degrees.</p>
<h4 id="canvod.grids.grids_impl.healpix_grid.HEALPixBuilder--raises">Raises<a class="headerlink" href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder--raises" title="Permanent link">&para;</a></h4>
<p>ImportError
    If <code>healpy</code> is not installed.
ValueError
    If <code>nside</code> is not a power of 2.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/grids_impl/healpix_grid.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">HEALPixBuilder</span><span class="p">(</span><span class="n">BaseGridBuilder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;HEALPix tessellation (Hierarchical Equal Area isoLatitude Pixelization).</span>

<span class="sd">    HEALPix partitions the sphere into 12 base pixels arranged at equal</span>
<span class="sd">    latitudes.  Each base pixel is recursively subdivided into 4 children,</span>
<span class="sd">    producing ``12 Ã nsideÂ²`` pixels on the full sphere, all with *exactly*</span>
<span class="sd">    the same solid angle.  This strict equal-area property makes HEALPix</span>
<span class="sd">    the gold standard for pixelisations that must be unbiased under</span>
<span class="sd">    solid-angle weighting.</span>

<span class="sd">    This builder delegates the pixel geometry entirely to the ``healpy``</span>
<span class="sd">    library.  It filters the full-sphere pixelisation down to the northern</span>
<span class="sd">    hemisphere and stores approximate bounding boxes (``phi_min/max``,</span>
<span class="sd">    ``theta_min/max``) derived from the pixel resolution.  The bounding</span>
<span class="sd">    boxes are **not** the true pixel boundaries (which are curvilinear);</span>
<span class="sd">    they are only approximations suitable for quick spatial queries.  For</span>
<span class="sd">    exact pixel membership use ``healpy.ang2pix`` directly.</span>

<span class="sd">    Coordinate convention</span>
<span class="sd">    ---------------------</span>
<span class="sd">    HEALPix natively uses colatitude ``theta â [0, Ï]`` (0 = North Pole)</span>
<span class="sd">    and longitude ``phi â [0, 2Ï)``.  This matches the GNSS convention used</span>
<span class="sd">    elsewhere in canvodpy: theta = 0 is the zenith, theta = Ï/2 is the</span>
<span class="sd">    horizon.  **No coordinate transform is applied.**</span>

<span class="sd">    What ``nside`` (resolution) means</span>
<span class="sd">    ----------------------------------</span>
<span class="sd">    ``nside`` is the single resolution parameter of HEALPix.  It must be a</span>
<span class="sd">    power of 2.  The key derived quantities are::</span>

<span class="sd">        n_pixels   = 12 Ã nsideÂ²           (full sphere)</span>
<span class="sd">        pixel_area = 4Ï / n_pixels          (steradians, exact)</span>
<span class="sd">        resolution â â(pixel_area)          (approximate angular diameter)</span>
<span class="sd">                   â 58.6Â° / nside         (degrees)</span>

<span class="sd">    | nside | Pixels (full) | Approx resolution | Pixel area (sr) |</span>
<span class="sd">    |-------|---------------|-------------------|-----------------|</span>
<span class="sd">    | 1     | 12            | 58.6Â°             | 1.049           |</span>
<span class="sd">    | 2     | 48            | 29.3Â°             | 0.262           |</span>
<span class="sd">    | 4     | 192           | 14.7Â°             | 0.065           |</span>
<span class="sd">    | 8     | 768           | 7.3Â°              | 0.016           |</span>
<span class="sd">    | 16    | 3 072         | 3.7Â°              | 0.004           |</span>
<span class="sd">    | 32    | 12 288        | 1.8Â°              | 0.001           |</span>

<span class="sd">    When ``nside`` is not provided, it is estimated from ``angular_resolution``</span>
<span class="sd">    and rounded to the nearest power of 2::</span>

<span class="sd">        nside_estimate = round_to_pow2( â(3/Ï) Ã 60 / angular_resolution )</span>

<span class="sd">    Mathematical construction</span>
<span class="sd">    -------------------------</span>
<span class="sd">    HEALPix construction is performed entirely by ``healpy``.  At a high</span>
<span class="sd">    level:</span>

<span class="sd">    1. The sphere is divided into 12 congruent base pixels (a curvilinear</span>
<span class="sd">       quadrilateral arrangement at three latitude zones: polar caps and</span>
<span class="sd">       equatorial belt).</span>
<span class="sd">    2. Each base pixel is subdivided into ``nsideÂ²`` equal-area children</span>
<span class="sd">       using a hierarchical quadtree.</span>
<span class="sd">    3. Pixel centres are returned by ``healpy.pix2ang(nside, ipix)`` in</span>
<span class="sd">       RING ordering (pixels ordered by increasing colatitude).</span>
<span class="sd">    4. This builder keeps only pixels with ``theta â¤ Ï/2 â cutoff_theta``</span>
<span class="sd">       (northern hemisphere above the elevation mask).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    angular_resolution : float</span>
<span class="sd">        Approximate angular resolution in degrees.  Used only to derive</span>
<span class="sd">        ``nside`` when that parameter is not given explicitly.</span>
<span class="sd">    cutoff_theta : float</span>
<span class="sd">        Elevation mask angle in degrees.  Pixels with colatitude</span>
<span class="sd">        ``theta &gt; Ï/2 â cutoff_theta`` (i.e. below the mask) are excluded.</span>
<span class="sd">    nside : int or None</span>
<span class="sd">        HEALPix resolution parameter.  Must be a power of 2.  If ``None``,</span>
<span class="sd">        estimated from ``angular_resolution``.</span>
<span class="sd">    phi_rotation : float</span>
<span class="sd">        Rigid azimuthal rotation applied after construction, in degrees.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ImportError</span>
<span class="sd">        If ``healpy`` is not installed.</span>
<span class="sd">    ValueError</span>
<span class="sd">        If ``nside`` is not a power of 2.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">angular_resolution</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">cutoff_theta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">nside</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">phi_rotation</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the HEALPix grid builder.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        angular_resolution : float, default 2</span>
<span class="sd">            Angular resolution in degrees.</span>
<span class="sd">        cutoff_theta : float, default 0</span>
<span class="sd">            Maximum polar angle cutoff in degrees.</span>
<span class="sd">        nside : int | None, optional</span>
<span class="sd">            HEALPix nside parameter.</span>
<span class="sd">        phi_rotation : float, default 0</span>
<span class="sd">            Rotation angle in degrees.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">angular_resolution</span><span class="p">,</span> <span class="n">cutoff_theta</span><span class="p">,</span> <span class="n">phi_rotation</span><span class="p">)</span>

        <span class="c1"># Determine nside</span>
        <span class="k">if</span> <span class="n">nside</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nside_estimate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">/</span> <span class="n">angular_resolution</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nside</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">nside_estimate</span><span class="p">))))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">nside</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span><span class="n">nside</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">nside</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;nside must be a power of 2, got </span><span class="si">{</span><span class="n">nside</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nside</span> <span class="o">=</span> <span class="n">nside</span>

        <span class="c1"># Import healpy</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">healpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">hp</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="n">hp</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">&quot;healpy is required for HEALPix grid. Install with: pip install healpy&quot;</span>
            <span class="p">)</span>

        <span class="n">pixel_size_arcmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">nside2resol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">,</span> <span class="n">arcmin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">actual_angular_resolution</span> <span class="o">=</span> <span class="n">pixel_size_arcmin</span> <span class="o">/</span> <span class="mf">60.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;HEALPix: nside=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;requested_res=</span><span class="si">{</span><span class="n">angular_resolution</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">Â°, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;actual_res=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">actual_angular_resolution</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">Â°&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_grid_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the grid-type identifier string.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            ``&quot;healpix&quot;``</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">GridType</span><span class="o">.</span><span class="n">HEALPIX</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_grid</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build HEALPix grid for the northern hemisphere.</span>

<span class="sd">        Iterates over all ``12 Ã nsideÂ²`` pixels, retains those with</span>
<span class="sd">        ``theta â¤ Ï/2 â cutoff_theta``, and constructs approximate</span>
<span class="sd">        bounding boxes from the pixel resolution.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        grid : pl.DataFrame</span>
<span class="sd">            One row per pixel.  Contains phi, theta (centre), approximate</span>
<span class="sd">            bounding-box limits, ``healpix_ipix`` (RING-ordered pixel index),</span>
<span class="sd">            and ``healpix_nside``.</span>
<span class="sd">        theta_lims : np.ndarray</span>
<span class="sd">            Synthetic evenly-spaced theta limits (interface compatibility only).</span>
<span class="sd">        phi_lims : list[np.ndarray]</span>
<span class="sd">            Synthetic evenly-spaced phi limits (interface compatibility only).</span>
<span class="sd">        cell_ids : list[np.ndarray]</span>
<span class="sd">            Single-element list containing the valid pixel indices.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">npix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">nside2npix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">)</span>

        <span class="n">cells</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">valid_pixels</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">ipix</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">npix</span><span class="p">):</span>
            <span class="n">theta</span><span class="p">,</span> <span class="n">phi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">pix2ang</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">,</span> <span class="n">ipix</span><span class="p">)</span>

            <span class="c1"># Keep only northern hemisphere above the elevation mask</span>
            <span class="k">if</span> <span class="n">theta</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff_theta_rad</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">pixel_radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">nside2resol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">)</span>

            <span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;phi&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span>
                    <span class="s2">&quot;theta&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span>
                    <span class="s2">&quot;phi_min&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">phi</span> <span class="o">-</span> <span class="n">pixel_radius</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)),</span>
                    <span class="s2">&quot;phi_max&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">phi</span> <span class="o">+</span> <span class="n">pixel_radius</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)),</span>
                    <span class="s2">&quot;theta_min&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">theta</span> <span class="o">-</span> <span class="n">pixel_radius</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)),</span>
                    <span class="s2">&quot;theta_max&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">theta</span> <span class="o">+</span> <span class="n">pixel_radius</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)),</span>
                    <span class="s2">&quot;healpix_ipix&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">ipix</span><span class="p">),</span>
                    <span class="s2">&quot;healpix_nside&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">),</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="n">valid_pixels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ipix</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No valid HEALPix pixels found in hemisphere&quot;</span><span class="p">)</span>

        <span class="n">grid</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span>

        <span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;healpix_ipix&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">),</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;healpix_nside&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">Int64</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">theta_unique</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">grid</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">n_theta_bands</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">theta_unique</span><span class="p">)</span>

        <span class="c1"># NOTE: These limits are SYNTHETIC and do NOT correspond to actual</span>
        <span class="c1"># HEALPix pixel boundaries. They exist only for interface</span>
        <span class="c1"># compatibility with ring-based grids. For spatial queries, use the</span>
        <span class="c1"># per-pixel theta_min/max and phi_min/max columns instead.</span>
        <span class="n">theta_lims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_theta_bands</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
        <span class="n">phi_lims</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">theta_lims</span><span class="p">))]</span>

        <span class="n">cell_ids_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">valid_pixels</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">grid</span><span class="p">,</span> <span class="n">theta_lims</span><span class="p">,</span> <span class="n">phi_lims</span><span class="p">,</span> <span class="n">cell_ids_list</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_healpix_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get HEALPix-specific information.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        info : dict</span>
<span class="sd">            Keys: ``nside``, ``npix_total``, ``pixel_area_sr``,</span>
<span class="sd">            ``pixel_area_arcmin2``, ``resolution_arcmin``,</span>
<span class="sd">            ``resolution_deg``, ``max_pixel_radius_deg``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;nside&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">,</span>
            <span class="s2">&quot;npix_total&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">nside2npix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">),</span>
            <span class="s2">&quot;pixel_area_sr&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">nside2pixarea</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">),</span>
            <span class="s2">&quot;pixel_area_arcmin2&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">nside2pixarea</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3600</span>
            <span class="p">),</span>
            <span class="s2">&quot;resolution_arcmin&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">nside2resol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">,</span> <span class="n">arcmin</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="s2">&quot;resolution_deg&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">actual_angular_resolution</span><span class="p">,</span>
            <span class="s2">&quot;max_pixel_radius_deg&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">max_pixrad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">)),</span>
        <span class="p">}</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="canvod.grids.grids_impl.healpix_grid.HEALPixBuilder.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">angular_resolution</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cutoff_theta</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nside</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phi_rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>

<a href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the HEALPix grid builder.</p>
<h5 id="canvod.grids.grids_impl.healpix_grid.HEALPixBuilder.__init__--parameters">Parameters<a class="headerlink" href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder.__init__--parameters" title="Permanent link">&para;</a></h5>
<p>angular_resolution : float, default 2
    Angular resolution in degrees.
cutoff_theta : float, default 0
    Maximum polar angle cutoff in degrees.
nside : int | None, optional
    HEALPix nside parameter.
phi_rotation : float, default 0
    Rotation angle in degrees.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/grids_impl/healpix_grid.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">angular_resolution</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">cutoff_theta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">nside</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">phi_rotation</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the HEALPix grid builder.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    angular_resolution : float, default 2</span>
<span class="sd">        Angular resolution in degrees.</span>
<span class="sd">    cutoff_theta : float, default 0</span>
<span class="sd">        Maximum polar angle cutoff in degrees.</span>
<span class="sd">    nside : int | None, optional</span>
<span class="sd">        HEALPix nside parameter.</span>
<span class="sd">    phi_rotation : float, default 0</span>
<span class="sd">        Rotation angle in degrees.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">angular_resolution</span><span class="p">,</span> <span class="n">cutoff_theta</span><span class="p">,</span> <span class="n">phi_rotation</span><span class="p">)</span>

    <span class="c1"># Determine nside</span>
    <span class="k">if</span> <span class="n">nside</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nside_estimate</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">/</span> <span class="n">angular_resolution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nside</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">nside_estimate</span><span class="p">))))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">nside</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="p">(</span><span class="n">nside</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">nside</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;nside must be a power of 2, got </span><span class="si">{</span><span class="n">nside</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nside</span> <span class="o">=</span> <span class="n">nside</span>

    <span class="c1"># Import healpy</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">healpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">hp</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">hp</span> <span class="o">=</span> <span class="n">hp</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
            <span class="s2">&quot;healpy is required for HEALPix grid. Install with: pip install healpy&quot;</span>
        <span class="p">)</span>

    <span class="n">pixel_size_arcmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">nside2resol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">,</span> <span class="n">arcmin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">actual_angular_resolution</span> <span class="o">=</span> <span class="n">pixel_size_arcmin</span> <span class="o">/</span> <span class="mf">60.0</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;HEALPix: nside=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="si">}</span><span class="s2">, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;requested_res=</span><span class="si">{</span><span class="n">angular_resolution</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">Â°, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;actual_res=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">actual_angular_resolution</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">Â°&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.grids_impl.healpix_grid.HEALPixBuilder.get_grid_type" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_grid_type</span><span class="p">()</span></code>

<a href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder.get_grid_type" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Return the grid-type identifier string.</p>
<h5 id="canvod.grids.grids_impl.healpix_grid.HEALPixBuilder.get_grid_type--returns">Returns<a class="headerlink" href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder.get_grid_type--returns" title="Permanent link">&para;</a></h5>
<p>str
    <code>"healpix"</code></p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/grids_impl/healpix_grid.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_grid_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the grid-type identifier string.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        ``&quot;healpix&quot;``</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">GridType</span><span class="o">.</span><span class="n">HEALPIX</span><span class="o">.</span><span class="n">value</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.grids_impl.healpix_grid.HEALPixBuilder.get_healpix_info" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_healpix_info</span><span class="p">()</span></code>

<a href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder.get_healpix_info" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Get HEALPix-specific information.</p>
<h5 id="canvod.grids.grids_impl.healpix_grid.HEALPixBuilder.get_healpix_info--returns">Returns<a class="headerlink" href="#canvod.grids.grids_impl.healpix_grid.HEALPixBuilder.get_healpix_info--returns" title="Permanent link">&para;</a></h5>
<p>info : dict
    Keys: <code>nside</code>, <code>npix_total</code>, <code>pixel_area_sr</code>,
    <code>pixel_area_arcmin2</code>, <code>resolution_arcmin</code>,
    <code>resolution_deg</code>, <code>max_pixel_radius_deg</code>.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/grids_impl/healpix_grid.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_healpix_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get HEALPix-specific information.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    info : dict</span>
<span class="sd">        Keys: ``nside``, ``npix_total``, ``pixel_area_sr``,</span>
<span class="sd">        ``pixel_area_arcmin2``, ``resolution_arcmin``,</span>
<span class="sd">        ``resolution_deg``, ``max_pixel_radius_deg``.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;nside&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">,</span>
        <span class="s2">&quot;npix_total&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">nside2npix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">),</span>
        <span class="s2">&quot;pixel_area_sr&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">nside2pixarea</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">),</span>
        <span class="s2">&quot;pixel_area_arcmin2&quot;</span><span class="p">:</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">nside2pixarea</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3600</span>
        <span class="p">),</span>
        <span class="s2">&quot;resolution_arcmin&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">nside2resol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">,</span> <span class="n">arcmin</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="s2">&quot;resolution_deg&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">actual_angular_resolution</span><span class="p">,</span>
        <span class="s2">&quot;max_pixel_radius_deg&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hp</span><span class="o">.</span><span class="n">max_pixrad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nside</span><span class="p">)),</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><h3 id="geodesic-grid">Geodesic Grid<a class="headerlink" href="#geodesic-grid" title="Permanent link">&para;</a></h3>


<div class="doc doc-object doc-module">



<a id="canvod.grids.grids_impl.geodesic_grid"></a>
    <div class="doc doc-contents first">

        <p>Geodesic grid implementation.</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder" class="doc doc-heading">
            <code>GeodesicBuilder</code>


<a href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="canvod.grids.core.grid_builder.BaseGridBuilder">BaseGridBuilder</span></code></p>



        <p>Geodesic grid based on a subdivided icosahedron.</p>
<p>The sphere is tessellated into triangular cells by starting with an
icosahedron (20 equilateral triangles) and recursively subdividing each
triangle into four smaller triangles.  All vertices are projected back
onto the unit sphere after each subdivision step, so the final cells are
<em>spherical</em> triangles.  The grid has no polar singularity and provides
near-uniform cell areas, though strict equal-area is <em>not</em> guaranteed â
cell areas vary by a few percent depending on how they inherit the
icosahedral symmetry axes.</p>
<h4 id="canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder--coordinate-convention-physics-gnss">Coordinate convention (physics / GNSS)<a class="headerlink" href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder--coordinate-convention-physics-gnss" title="Permanent link">&para;</a></h4>
<ul>
<li>phi  â [0, 2Ï)  â azimuthal angle from East, counter-clockwise</li>
<li>theta â [0, Ï/2] â polar angle from zenith (0 = straight up,
  Ï/2 = horizon)</li>
</ul>
<p>Cell centres are computed as the 3D Cartesian mean of the three vertices,
re-normalised onto the unit sphere.</p>
<h4 id="canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder--what-angular_resolution-means">What <code>angular_resolution</code> means<a class="headerlink" href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder--what-angular_resolution-means" title="Permanent link">&para;</a></h4>
<p><code>angular_resolution</code> is <strong>not</strong> used directly as a cell size.  Instead it
is used only when <code>subdivision_level</code> is <em>not</em> explicitly supplied, to
<em>estimate</em> an appropriate subdivision level.  The heuristic targets an
approximate triangle edge length of <code>2 Ã angular_resolution</code>::</p>
<div class="highlight"><pre><span></span><code>target_edge â 2 Ã angular_resolution   (degrees)
subdivision_level = ceil(logâ(63.4 / target_edge))
</code></pre></div>
<p>The number 63.4Â° is the edge length of a regular icosahedron inscribed in
a unit sphere.  Each subdivision halves the edge length, so the actual
edge length at level <em>n</em> is approximately::</p>
<div class="highlight"><pre><span></span><code>edge â 63.4Â° / 2â¿   (degrees)
</code></pre></div>
<p>The total number of triangles on the <strong>full sphere</strong> is <code>20 Ã 4â¿</code>.
Roughly half fall in the northern hemisphere (exact count depends on
the hemisphere boundary).</p>
<h4 id="canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder--mathematical-construction">Mathematical construction<a class="headerlink" href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder--mathematical-construction" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>Icosahedron</strong> â 12 vertices placed at the intersections of three
   mutually perpendicular golden-ratio rectangles, normalised to the
   unit sphere.  20 triangular faces connect them.</li>
<li><strong>Subdivision</strong> â each triangle is split into 4 by inserting edge
   midpoints.  Each midpoint is projected onto the unit sphere
   (re-normalised) before the next subdivision.  This is repeated
   <code>subdivision_level</code> times.</li>
<li><strong>Hemisphere filter</strong> â faces are kept if <em>any</em> of their three
   vertices satisfies <code>theta â¤ Ï/2 â cutoff_theta</code>.  Consequently,
   boundary triangles that straddle the horizon <em>are</em> included and
   extend slightly below it.</li>
<li><strong>Phi wrapping</strong> â for triangles that straddle the 0/2Ï azimuthal
   boundary, vertex phis below Ï are shifted by +2Ï before computing
   bounding-box limits, then wrapped back.</li>
</ol>
<h4 id="canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder--parameters">Parameters<a class="headerlink" href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder--parameters" title="Permanent link">&para;</a></h4>
<p>angular_resolution : float
    Approximate angular resolution in degrees.  Used only to derive
    <code>subdivision_level</code> when that parameter is not given explicitly.
cutoff_theta : float
    Elevation mask angle in degrees.  Triangles are excluded only if
    <em>all</em> their vertices are below this elevation.
subdivision_level : int or None
    Number of icosahedral subdivisions.  If <code>None</code>, estimated from
    <code>angular_resolution</code>.  Typical range 0â5.
phi_rotation : float
    Rigid azimuthal rotation applied after construction, in degrees.</p>
<h4 id="canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder--notes">Notes<a class="headerlink" href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder--notes" title="Permanent link">&para;</a></h4>
<p>The <code>theta_lims</code>, <code>phi_lims</code>, and <code>cell_ids</code> fields of the returned
<code>GridData</code> are <em>synthetic</em> evenly-spaced arrays kept only for interface
compatibility with ring-based grids.  They do <strong>not</strong> describe the actual
triangular cell layout.  Use the <code>geodesic_vertices</code> column and the
<code>vertices</code> array in <code>GridData.vertices</code> for the true geometry.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/grids_impl/geodesic_grid.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">GeodesicBuilder</span><span class="p">(</span><span class="n">BaseGridBuilder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Geodesic grid based on a subdivided icosahedron.</span>

<span class="sd">    The sphere is tessellated into triangular cells by starting with an</span>
<span class="sd">    icosahedron (20 equilateral triangles) and recursively subdividing each</span>
<span class="sd">    triangle into four smaller triangles.  All vertices are projected back</span>
<span class="sd">    onto the unit sphere after each subdivision step, so the final cells are</span>
<span class="sd">    *spherical* triangles.  The grid has no polar singularity and provides</span>
<span class="sd">    near-uniform cell areas, though strict equal-area is *not* guaranteed â</span>
<span class="sd">    cell areas vary by a few percent depending on how they inherit the</span>
<span class="sd">    icosahedral symmetry axes.</span>

<span class="sd">    Coordinate convention (physics / GNSS)</span>
<span class="sd">    ---------------------------------------</span>
<span class="sd">    * phi  â [0, 2Ï)  â azimuthal angle from East, counter-clockwise</span>
<span class="sd">    * theta â [0, Ï/2] â polar angle from zenith (0 = straight up,</span>
<span class="sd">      Ï/2 = horizon)</span>

<span class="sd">    Cell centres are computed as the 3D Cartesian mean of the three vertices,</span>
<span class="sd">    re-normalised onto the unit sphere.</span>

<span class="sd">    What ``angular_resolution`` means</span>
<span class="sd">    ----------------------------------</span>
<span class="sd">    ``angular_resolution`` is **not** used directly as a cell size.  Instead it</span>
<span class="sd">    is used only when ``subdivision_level`` is *not* explicitly supplied, to</span>
<span class="sd">    *estimate* an appropriate subdivision level.  The heuristic targets an</span>
<span class="sd">    approximate triangle edge length of ``2 Ã angular_resolution``::</span>

<span class="sd">        target_edge â 2 Ã angular_resolution   (degrees)</span>
<span class="sd">        subdivision_level = ceil(logâ(63.4 / target_edge))</span>

<span class="sd">    The number 63.4Â° is the edge length of a regular icosahedron inscribed in</span>
<span class="sd">    a unit sphere.  Each subdivision halves the edge length, so the actual</span>
<span class="sd">    edge length at level *n* is approximately::</span>

<span class="sd">        edge â 63.4Â° / 2â¿   (degrees)</span>

<span class="sd">    The total number of triangles on the **full sphere** is ``20 Ã 4â¿``.</span>
<span class="sd">    Roughly half fall in the northern hemisphere (exact count depends on</span>
<span class="sd">    the hemisphere boundary).</span>

<span class="sd">    Mathematical construction</span>
<span class="sd">    -------------------------</span>
<span class="sd">    1. **Icosahedron** â 12 vertices placed at the intersections of three</span>
<span class="sd">       mutually perpendicular golden-ratio rectangles, normalised to the</span>
<span class="sd">       unit sphere.  20 triangular faces connect them.</span>
<span class="sd">    2. **Subdivision** â each triangle is split into 4 by inserting edge</span>
<span class="sd">       midpoints.  Each midpoint is projected onto the unit sphere</span>
<span class="sd">       (re-normalised) before the next subdivision.  This is repeated</span>
<span class="sd">       ``subdivision_level`` times.</span>
<span class="sd">    3. **Hemisphere filter** â faces are kept if *any* of their three</span>
<span class="sd">       vertices satisfies ``theta â¤ Ï/2 â cutoff_theta``.  Consequently,</span>
<span class="sd">       boundary triangles that straddle the horizon *are* included and</span>
<span class="sd">       extend slightly below it.</span>
<span class="sd">    4. **Phi wrapping** â for triangles that straddle the 0/2Ï azimuthal</span>
<span class="sd">       boundary, vertex phis below Ï are shifted by +2Ï before computing</span>
<span class="sd">       bounding-box limits, then wrapped back.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    angular_resolution : float</span>
<span class="sd">        Approximate angular resolution in degrees.  Used only to derive</span>
<span class="sd">        ``subdivision_level`` when that parameter is not given explicitly.</span>
<span class="sd">    cutoff_theta : float</span>
<span class="sd">        Elevation mask angle in degrees.  Triangles are excluded only if</span>
<span class="sd">        *all* their vertices are below this elevation.</span>
<span class="sd">    subdivision_level : int or None</span>
<span class="sd">        Number of icosahedral subdivisions.  If ``None``, estimated from</span>
<span class="sd">        ``angular_resolution``.  Typical range 0â5.</span>
<span class="sd">    phi_rotation : float</span>
<span class="sd">        Rigid azimuthal rotation applied after construction, in degrees.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The ``theta_lims``, ``phi_lims``, and ``cell_ids`` fields of the returned</span>
<span class="sd">    ``GridData`` are *synthetic* evenly-spaced arrays kept only for interface</span>
<span class="sd">    compatibility with ring-based grids.  They do **not** describe the actual</span>
<span class="sd">    triangular cell layout.  Use the ``geodesic_vertices`` column and the</span>
<span class="sd">    ``vertices`` array in ``GridData.vertices`` for the true geometry.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">angular_resolution</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">cutoff_theta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">subdivision_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">phi_rotation</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the geodesic grid builder.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        angular_resolution : float, default 2</span>
<span class="sd">            Angular resolution in degrees.</span>
<span class="sd">        cutoff_theta : float, default 0</span>
<span class="sd">            Maximum polar angle cutoff in degrees.</span>
<span class="sd">        subdivision_level : int | None, optional</span>
<span class="sd">            Subdivision level override.</span>
<span class="sd">        phi_rotation : float, default 0</span>
<span class="sd">            Rotation angle in degrees.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">angular_resolution</span><span class="p">,</span> <span class="n">cutoff_theta</span><span class="p">,</span> <span class="n">phi_rotation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_triangles</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">subdivision_level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_edge_deg</span> <span class="o">=</span> <span class="n">angular_resolution</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subdivision_level</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="mf">63.4</span> <span class="o">/</span> <span class="n">target_edge_deg</span><span class="p">))),</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subdivision_level</span> <span class="o">=</span> <span class="n">subdivision_level</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Geodesic: subdivision_level=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subdivision_level</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;~</span><span class="si">{</span><span class="mi">20</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">subdivision_level</span><span class="si">}</span><span class="s2"> triangles&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_triangles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return triangle vertex coordinates for visualization.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        triangles : np.ndarray or None</span>
<span class="sd">            Array of shape ``(n_faces, 3, 3)`` where ``triangles[i]`` contains</span>
<span class="sd">            the three 3D unit-sphere vertices of triangle *i*.  ``None`` if</span>
<span class="sd">            the grid has not been built yet.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_triangles</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_grid_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the grid-type identifier string.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            ``&quot;geodesic&quot;``</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">GridType</span><span class="o">.</span><span class="n">GEODESIC</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_extract_triangle_vertices</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">vertices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">faces</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Extract 3D vertex coordinates for each face.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vertices : np.ndarray</span>
<span class="sd">            All sphere vertices, shape ``(n_vertices, 3)``.</span>
<span class="sd">        faces : np.ndarray</span>
<span class="sd">            Face index array, shape ``(n_faces, 3)``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        triangles : np.ndarray</span>
<span class="sd">            Shape ``(n_faces, 3, 3)`` â three 3D vertices per face.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Vectorized: use NumPy advanced indexing instead of loop</span>
        <span class="k">return</span> <span class="n">vertices</span><span class="p">[</span><span class="n">faces</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_grid</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build geodesic grid from subdivided icosahedron.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        grid : pl.DataFrame</span>
<span class="sd">            One row per triangular cell.  Columns include phi, theta (centre),</span>
<span class="sd">            bounding-box limits, ``geodesic_vertices`` (3 vertex indices into</span>
<span class="sd">            the ``vertices`` array), and ``geodesic_subdivision``.</span>
<span class="sd">        theta_lims : np.ndarray</span>
<span class="sd">            Synthetic evenly-spaced theta limits (interface compatibility only).</span>
<span class="sd">        phi_lims : list[np.ndarray]</span>
<span class="sd">            Synthetic evenly-spaced phi limits (interface compatibility only).</span>
<span class="sd">        cell_ids : list[np.ndarray]</span>
<span class="sd">            Single-element list containing all cell ids.</span>
<span class="sd">        extra_kwargs : dict</span>
<span class="sd">            Contains ``vertices`` (shape ``(n_vertices, 3)``),</span>
<span class="sd">            ``vertex_phi``, and ``vertex_theta`` arrays for the full</span>
<span class="sd">            subdivided icosahedron.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vertices</span><span class="p">,</span> <span class="n">faces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_icosahedron</span><span class="p">()</span>

        <span class="c1"># Subdivide</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subdivision_level</span><span class="p">):</span>
            <span class="n">vertices</span><span class="p">,</span> <span class="n">faces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subdivide_mesh</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span> <span class="n">faces</span><span class="p">)</span>

        <span class="c1"># Project to unit sphere</span>
        <span class="n">vertices</span> <span class="o">=</span> <span class="n">vertices</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Convert to spherical</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">vertices</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">vertices</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">vertices</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

        <span class="c1"># Filter to northern hemisphere</span>
        <span class="n">hemisphere_mask</span> <span class="o">=</span> <span class="n">theta</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff_theta_rad</span><span class="p">)</span>

        <span class="c1"># Filter faces</span>
        <span class="n">valid_faces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">faces</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">hemisphere_mask</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">face</span><span class="p">):</span>
                <span class="n">valid_faces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">face</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_faces</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No valid faces in hemisphere&quot;</span><span class="p">)</span>

        <span class="n">valid_faces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">valid_faces</span><span class="p">)</span>

        <span class="c1"># Create cells</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">valid_faces</span><span class="p">:</span>
            <span class="n">v_indices</span> <span class="o">=</span> <span class="n">face</span>
            <span class="n">face_phi</span> <span class="o">=</span> <span class="n">phi</span><span class="p">[</span><span class="n">v_indices</span><span class="p">]</span>
            <span class="n">face_theta</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="n">v_indices</span><span class="p">]</span>

            <span class="c1"># Handle phi wrapping for triangles crossing 0/2Ï boundary</span>
            <span class="n">phi_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ptp</span><span class="p">(</span><span class="n">face_phi</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">phi_range</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">:</span>
                <span class="c1"># Triangle crosses the wraparound - unwrap relative to median</span>
                <span class="n">ref_phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">face_phi</span><span class="p">)</span>
                <span class="n">face_phi_unwrapped</span> <span class="o">=</span> <span class="n">face_phi</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="c1"># Unwrap angles that are &gt; Ï away from reference</span>
                <span class="n">mask_low</span> <span class="o">=</span> <span class="p">(</span><span class="n">ref_phi</span> <span class="o">-</span> <span class="n">face_phi_unwrapped</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                <span class="n">mask_high</span> <span class="o">=</span> <span class="p">(</span><span class="n">face_phi_unwrapped</span> <span class="o">-</span> <span class="n">ref_phi</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                <span class="n">face_phi_unwrapped</span><span class="p">[</span><span class="n">mask_low</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                <span class="n">face_phi_unwrapped</span><span class="p">[</span><span class="n">mask_high</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                <span class="n">phi_min</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">face_phi_unwrapped</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
                <span class="n">phi_max</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">face_phi_unwrapped</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">phi_min</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">face_phi</span><span class="p">))</span>
                <span class="n">phi_max</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">face_phi</span><span class="p">))</span>

            <span class="c1"># Cell center - 3D Cartesian mean</span>
            <span class="n">face_vertices_3d</span> <span class="o">=</span> <span class="n">vertices</span><span class="p">[</span><span class="n">v_indices</span><span class="p">]</span>
            <span class="n">center_3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">face_vertices_3d</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">center_3d</span> <span class="o">=</span> <span class="n">center_3d</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">center_3d</span><span class="p">)</span>

            <span class="n">center_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">center_3d</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">center_phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">center_3d</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">center_3d</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">center_phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">center_phi</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

            <span class="c1"># Cell bounds (theta from vertices, phi already computed above)</span>
            <span class="n">theta_min</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">face_theta</span><span class="p">))</span>
            <span class="n">theta_max</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">face_theta</span><span class="p">))</span>

            <span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;phi&quot;</span><span class="p">:</span> <span class="n">center_phi</span><span class="p">,</span>
                    <span class="s2">&quot;theta&quot;</span><span class="p">:</span> <span class="n">center_theta</span><span class="p">,</span>
                    <span class="s2">&quot;phi_min&quot;</span><span class="p">:</span> <span class="n">phi_min</span><span class="p">,</span>
                    <span class="s2">&quot;phi_max&quot;</span><span class="p">:</span> <span class="n">phi_max</span><span class="p">,</span>
                    <span class="s2">&quot;theta_min&quot;</span><span class="p">:</span> <span class="n">theta_min</span><span class="p">,</span>
                    <span class="s2">&quot;theta_max&quot;</span><span class="p">:</span> <span class="n">theta_max</span><span class="p">,</span>
                    <span class="s2">&quot;geodesic_vertices&quot;</span><span class="p">:</span> <span class="n">v_indices</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                    <span class="s2">&quot;geodesic_subdivision&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdivision_level</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="n">grid</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">int_range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">())</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;cell_id&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">extra_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;vertices&quot;</span><span class="p">:</span> <span class="n">vertices</span><span class="p">,</span>
            <span class="s2">&quot;vertex_phi&quot;</span><span class="p">:</span> <span class="n">phi</span><span class="p">,</span>
            <span class="s2">&quot;vertex_theta&quot;</span><span class="p">:</span> <span class="n">theta</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">theta_lims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">phi_lims</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">theta_lims</span><span class="p">))]</span>
        <span class="n">cell_ids_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">height</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_triangles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_triangle_vertices</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span> <span class="n">faces</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">grid</span><span class="p">,</span> <span class="n">theta_lims</span><span class="p">,</span> <span class="n">phi_lims</span><span class="p">,</span> <span class="n">cell_ids_list</span><span class="p">,</span> <span class="n">extra_kwargs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_icosahedron</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create a unit-sphere icosahedron.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        vertices : np.ndarray</span>
<span class="sd">            Shape ``(12, 3)`` â vertices on the unit sphere.</span>
<span class="sd">        faces : np.ndarray</span>
<span class="sd">            Shape ``(20, 3)`` â integer vertex indices per triangular face.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">phi_golden</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="n">vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">phi_golden</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">phi_golden</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">phi_golden</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">phi_golden</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">phi_golden</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">phi_golden</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">phi_golden</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="n">phi_golden</span><span class="p">],</span>
                <span class="p">[</span><span class="n">phi_golden</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="p">[</span><span class="n">phi_golden</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="p">[</span><span class="o">-</span><span class="n">phi_golden</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="p">[</span><span class="o">-</span><span class="n">phi_golden</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">vertices</span> <span class="o">=</span> <span class="n">vertices</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">faces</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">11</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span>
                <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">faces</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_subdivide_mesh</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">vertices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">faces</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Subdivide each triangle into 4 smaller triangles.</span>

<span class="sd">        Each edge midpoint is computed, normalised onto the unit sphere, and</span>
<span class="sd">        cached so that shared edges produce only one new vertex.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vertices : np.ndarray</span>
<span class="sd">            Current vertex array, shape ``(n_vertices, 3)``.</span>
<span class="sd">        faces : np.ndarray</span>
<span class="sd">            Current face array, shape ``(n_faces, 3)``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        new_vertices : np.ndarray</span>
<span class="sd">            Expanded vertex array, shape ``(n_vertices + n_new_midpoints, 3)``.</span>
<span class="sd">        new_faces : np.ndarray</span>
<span class="sd">            New face array, shape ``(4 Ã n_faces, 3)``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_faces</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">edge_midpoints</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">get_midpoint</span><span class="p">(</span><span class="n">v1</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">v2</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Return midpoint vertex index for an edge.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            v1 : int</span>
<span class="sd">                First vertex index.</span>
<span class="sd">            v2 : int</span>
<span class="sd">                Second vertex index.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            int</span>
<span class="sd">                Index of the midpoint vertex.</span>

<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">edge</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">([</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">edge</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">edge_midpoints</span><span class="p">:</span>
                <span class="n">edge_midpoints</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vertices</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">edge_midpoints</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">edge_midpoints</span><span class="p">[</span><span class="n">edge</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">face</span> <span class="ow">in</span> <span class="n">faces</span><span class="p">:</span>
            <span class="n">v0</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">face</span>

            <span class="n">m01</span> <span class="o">=</span> <span class="n">get_midpoint</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">v1</span><span class="p">)</span>
            <span class="n">m12</span> <span class="o">=</span> <span class="n">get_midpoint</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span>
            <span class="n">m20</span> <span class="o">=</span> <span class="n">get_midpoint</span><span class="p">(</span><span class="n">v2</span><span class="p">,</span> <span class="n">v0</span><span class="p">)</span>

            <span class="n">new_faces</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="p">[</span><span class="n">v0</span><span class="p">,</span> <span class="n">m01</span><span class="p">,</span> <span class="n">m20</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">v1</span><span class="p">,</span> <span class="n">m12</span><span class="p">,</span> <span class="n">m01</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">v2</span><span class="p">,</span> <span class="n">m20</span><span class="p">,</span> <span class="n">m12</span><span class="p">],</span>
                    <span class="p">[</span><span class="n">m01</span><span class="p">,</span> <span class="n">m12</span><span class="p">,</span> <span class="n">m20</span><span class="p">],</span>
                <span class="p">]</span>
            <span class="p">)</span>

        <span class="n">n_original</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">vertices</span><span class="p">)</span>
        <span class="n">n_new</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">edge_midpoints</span><span class="p">)</span>
        <span class="n">final_vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_original</span> <span class="o">+</span> <span class="n">n_new</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">final_vertices</span><span class="p">[:</span><span class="n">n_original</span><span class="p">]</span> <span class="o">=</span> <span class="n">vertices</span>

        <span class="k">for</span> <span class="n">edge</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">edge_midpoints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">edge</span>
            <span class="n">midpoint</span> <span class="o">=</span> <span class="p">(</span><span class="n">vertices</span><span class="p">[</span><span class="n">v1</span><span class="p">]</span> <span class="o">+</span> <span class="n">vertices</span><span class="p">[</span><span class="n">v2</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">midpoint</span> <span class="o">=</span> <span class="n">midpoint</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">midpoint</span><span class="p">)</span>
            <span class="n">final_vertices</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">midpoint</span>

        <span class="k">return</span> <span class="n">final_vertices</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">new_faces</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">angular_resolution</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cutoff_theta</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">subdivision_level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phi_rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>

<a href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the geodesic grid builder.</p>
<h5 id="canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder.__init__--parameters">Parameters<a class="headerlink" href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder.__init__--parameters" title="Permanent link">&para;</a></h5>
<p>angular_resolution : float, default 2
    Angular resolution in degrees.
cutoff_theta : float, default 0
    Maximum polar angle cutoff in degrees.
subdivision_level : int | None, optional
    Subdivision level override.
phi_rotation : float, default 0
    Rotation angle in degrees.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/grids_impl/geodesic_grid.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">angular_resolution</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">cutoff_theta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">subdivision_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">phi_rotation</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the geodesic grid builder.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    angular_resolution : float, default 2</span>
<span class="sd">        Angular resolution in degrees.</span>
<span class="sd">    cutoff_theta : float, default 0</span>
<span class="sd">        Maximum polar angle cutoff in degrees.</span>
<span class="sd">    subdivision_level : int | None, optional</span>
<span class="sd">        Subdivision level override.</span>
<span class="sd">    phi_rotation : float, default 0</span>
<span class="sd">        Rotation angle in degrees.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">angular_resolution</span><span class="p">,</span> <span class="n">cutoff_theta</span><span class="p">,</span> <span class="n">phi_rotation</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_triangles</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">subdivision_level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">target_edge_deg</span> <span class="o">=</span> <span class="n">angular_resolution</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subdivision_level</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="mf">63.4</span> <span class="o">/</span> <span class="n">target_edge_deg</span><span class="p">))),</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subdivision_level</span> <span class="o">=</span> <span class="n">subdivision_level</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Geodesic: subdivision_level=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">subdivision_level</span><span class="si">}</span><span class="s2">, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;~</span><span class="si">{</span><span class="mi">20</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">subdivision_level</span><span class="si">}</span><span class="s2"> triangles&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder.get_triangles" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_triangles</span><span class="p">()</span></code>

<a href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder.get_triangles" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Return triangle vertex coordinates for visualization.</p>
<h5 id="canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder.get_triangles--returns">Returns<a class="headerlink" href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder.get_triangles--returns" title="Permanent link">&para;</a></h5>
<p>triangles : np.ndarray or None
    Array of shape <code>(n_faces, 3, 3)</code> where <code>triangles[i]</code> contains
    the three 3D unit-sphere vertices of triangle <em>i</em>.  <code>None</code> if
    the grid has not been built yet.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/grids_impl/geodesic_grid.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_triangles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return triangle vertex coordinates for visualization.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    triangles : np.ndarray or None</span>
<span class="sd">        Array of shape ``(n_faces, 3, 3)`` where ``triangles[i]`` contains</span>
<span class="sd">        the three 3D unit-sphere vertices of triangle *i*.  ``None`` if</span>
<span class="sd">        the grid has not been built yet.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_triangles</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder.get_grid_type" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_grid_type</span><span class="p">()</span></code>

<a href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder.get_grid_type" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Return the grid-type identifier string.</p>
<h5 id="canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder.get_grid_type--returns">Returns<a class="headerlink" href="#canvod.grids.grids_impl.geodesic_grid.GeodesicBuilder.get_grid_type--returns" title="Permanent link">&para;</a></h5>
<p>str
    <code>"geodesic"</code></p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/grids_impl/geodesic_grid.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_grid_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the grid-type identifier string.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        ``&quot;geodesic&quot;``</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">GridType</span><span class="o">.</span><span class="n">GEODESIC</span><span class="o">.</span><span class="n">value</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><h3 id="fibonacci-grid">Fibonacci Grid<a class="headerlink" href="#fibonacci-grid" title="Permanent link">&para;</a></h3>


<div class="doc doc-object doc-module">



<a id="canvod.grids.grids_impl.fibonacci_grid"></a>
    <div class="doc doc-contents first">

        <p>Fibonacci sphere grid implementation.</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder" class="doc doc-heading">
            <code>FibonacciBuilder</code>


<a href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="canvod.grids.core.grid_builder.BaseGridBuilder">BaseGridBuilder</span></code></p>



        <p>Fibonacci sphere grid with spherical Voronoi tessellation.</p>
<p>Points are distributed on the sphere using the <em>Fibonacci lattice</em>
(golden-spiral method), which provides one of the most uniform
point distributions achievable on a sphere without iterative
optimisation.  Each point then becomes the centre of a <em>spherical
Voronoi cell</em> â the region of the sphere closer to that point than
to any other.  The resulting tessellation has no polar singularities
and near-uniform cell areas.</p>
<p>The tessellation is computed by <code>scipy.spatial.SphericalVoronoi</code>.
Because Voronoi cells have curvilinear boundaries, the <code>phi_min/max</code>
and <code>theta_min/max</code> columns in the grid are axis-aligned <em>bounding
boxes</em>, <strong>not</strong> the true cell boundaries.  They are unreliable for
spatial queries â use the <code>voronoi_region</code> column (vertex indices
into the <code>SphericalVoronoi.vertices</code> array) for exact geometry.</p>
<h4 id="canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder--coordinate-convention-physics-gnss">Coordinate convention (physics / GNSS)<a class="headerlink" href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder--coordinate-convention-physics-gnss" title="Permanent link">&para;</a></h4>
<ul>
<li>phi  â [0, 2Ï)  â azimuthal angle from East, counter-clockwise</li>
<li>theta â [0, Ï/2] â polar angle from zenith (0 = straight up,
  Ï/2 = horizon)</li>
</ul>
<h4 id="canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder--what-n_points-resolution-means">What <code>n_points</code> (resolution) means<a class="headerlink" href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder--what-n_points-resolution-means" title="Permanent link">&para;</a></h4>
<p>Resolution is controlled by <code>n_points</code>, the number of Voronoi cells
in the hemisphere.  When <code>n_points</code> is not supplied it is estimated
from <code>angular_resolution</code> via::</p>
<div class="highlight"><pre><span></span><code>cell_area  â angular_resolutionÂ²   (radiansÂ²)
n_points   = max(10, round(2Ï / cell_area))
</code></pre></div>
<p>The approximate cell "diameter" (assuming a circular cell of equal area)
is::</p>
<div class="highlight"><pre><span></span><code>d â 2 â(2Ï / n_points)   (radians)
  â 2 Ã angular_resolution
</code></pre></div>
<p><code>angular_resolution</code> therefore has <strong>no direct geometric meaning</strong> for
this grid type â it is only a convenience for the <code>n_points</code> estimator.</p>
<h4 id="canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder--mathematical-construction">Mathematical construction<a class="headerlink" href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder--mathematical-construction" title="Permanent link">&para;</a></h4>
<ol>
<li>
<p><strong>Full-sphere Fibonacci lattice</strong> â <code>2 Ã n_points</code> points are
   generated on the unit sphere.  Point <em>i</em> has::</p>
<p>Î¸áµ¢ = arccos(1 â 2(i + 0.5) / N)
   Ïáµ¢ = 2Ï (i + 0.5) / Ï_golden   (mod 2Ï)</p>
</li>
</ol>
<p>where <code>N = 2 Ã n_points</code> and <code>Ï_golden = (1+â5)/2</code>.  The
   <code>+0.5</code> offset avoids placing points exactly at the poles.
2. <strong>Hemisphere filter</strong> â points with <code>Î¸ &gt; Ï/2 â cutoff_theta</code>
   are discarded.
3. <strong>Spherical Voronoi tessellation</strong> â
   <code>scipy.spatial.SphericalVoronoi</code> computes the Voronoi diagram
   on the unit sphere.  Regions are sorted so that vertices appear
   in counter-clockwise order around each cell.
4. <strong>Bounding boxes</strong> â axis-aligned bounding boxes in (phi, theta)
   are computed from the Voronoi vertex coordinates.  These are
   approximations only (see caveat above).</p>
<h4 id="canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder--parameters">Parameters<a class="headerlink" href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder--parameters" title="Permanent link">&para;</a></h4>
<p>angular_resolution : float
    Approximate angular resolution in degrees.  Used only to estimate
    <code>n_points</code> when that parameter is not given explicitly.
cutoff_theta : float
    Elevation mask angle in degrees.  Points below this elevation are
    excluded before tessellation.
n_points : int or None
    Target number of Voronoi cells in the hemisphere.  If <code>None</code>,
    estimated from <code>angular_resolution</code>.
phi_rotation : float
    Rigid azimuthal rotation applied after construction, in degrees.</p>
<h4 id="canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder--raises">Raises<a class="headerlink" href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder--raises" title="Permanent link">&para;</a></h4>
<p>ImportError
    If <code>scipy</code> is not installed.
ValueError
    If fewer than 4 points survive the hemisphere filter.</p>
<h4 id="canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder--notes">Notes<a class="headerlink" href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder--notes" title="Permanent link">&para;</a></h4>
<p>The <code>theta_lims</code>, <code>phi_lims</code>, and <code>cell_ids</code> fields of the returned
<code>GridData</code> are <em>synthetic</em> evenly-spaced arrays kept only for interface
compatibility with ring-based grids.  They do <strong>not</strong> describe the actual
Voronoi cell layout.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/grids_impl/fibonacci_grid.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FibonacciBuilder</span><span class="p">(</span><span class="n">BaseGridBuilder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Fibonacci sphere grid with spherical Voronoi tessellation.</span>

<span class="sd">    Points are distributed on the sphere using the *Fibonacci lattice*</span>
<span class="sd">    (golden-spiral method), which provides one of the most uniform</span>
<span class="sd">    point distributions achievable on a sphere without iterative</span>
<span class="sd">    optimisation.  Each point then becomes the centre of a *spherical</span>
<span class="sd">    Voronoi cell* â the region of the sphere closer to that point than</span>
<span class="sd">    to any other.  The resulting tessellation has no polar singularities</span>
<span class="sd">    and near-uniform cell areas.</span>

<span class="sd">    The tessellation is computed by ``scipy.spatial.SphericalVoronoi``.</span>
<span class="sd">    Because Voronoi cells have curvilinear boundaries, the ``phi_min/max``</span>
<span class="sd">    and ``theta_min/max`` columns in the grid are axis-aligned *bounding</span>
<span class="sd">    boxes*, **not** the true cell boundaries.  They are unreliable for</span>
<span class="sd">    spatial queries â use the ``voronoi_region`` column (vertex indices</span>
<span class="sd">    into the ``SphericalVoronoi.vertices`` array) for exact geometry.</span>

<span class="sd">    Coordinate convention (physics / GNSS)</span>
<span class="sd">    ---------------------------------------</span>
<span class="sd">    * phi  â [0, 2Ï)  â azimuthal angle from East, counter-clockwise</span>
<span class="sd">    * theta â [0, Ï/2] â polar angle from zenith (0 = straight up,</span>
<span class="sd">      Ï/2 = horizon)</span>

<span class="sd">    What ``n_points`` (resolution) means</span>
<span class="sd">    -------------------------------------</span>
<span class="sd">    Resolution is controlled by ``n_points``, the number of Voronoi cells</span>
<span class="sd">    in the hemisphere.  When ``n_points`` is not supplied it is estimated</span>
<span class="sd">    from ``angular_resolution`` via::</span>

<span class="sd">        cell_area  â angular_resolutionÂ²   (radiansÂ²)</span>
<span class="sd">        n_points   = max(10, round(2Ï / cell_area))</span>

<span class="sd">    The approximate cell &quot;diameter&quot; (assuming a circular cell of equal area)</span>
<span class="sd">    is::</span>

<span class="sd">        d â 2 â(2Ï / n_points)   (radians)</span>
<span class="sd">          â 2 Ã angular_resolution</span>

<span class="sd">    ``angular_resolution`` therefore has **no direct geometric meaning** for</span>
<span class="sd">    this grid type â it is only a convenience for the ``n_points`` estimator.</span>

<span class="sd">    Mathematical construction</span>
<span class="sd">    -------------------------</span>
<span class="sd">    1. **Full-sphere Fibonacci lattice** â ``2 Ã n_points`` points are</span>
<span class="sd">       generated on the unit sphere.  Point *i* has::</span>

<span class="sd">           Î¸áµ¢ = arccos(1 â 2(i + 0.5) / N)</span>
<span class="sd">           Ïáµ¢ = 2Ï (i + 0.5) / Ï_golden   (mod 2Ï)</span>

<span class="sd">       where ``N = 2 Ã n_points`` and ``Ï_golden = (1+â5)/2``.  The</span>
<span class="sd">       ``+0.5`` offset avoids placing points exactly at the poles.</span>
<span class="sd">    2. **Hemisphere filter** â points with ``Î¸ &gt; Ï/2 â cutoff_theta``</span>
<span class="sd">       are discarded.</span>
<span class="sd">    3. **Spherical Voronoi tessellation** â</span>
<span class="sd">       ``scipy.spatial.SphericalVoronoi`` computes the Voronoi diagram</span>
<span class="sd">       on the unit sphere.  Regions are sorted so that vertices appear</span>
<span class="sd">       in counter-clockwise order around each cell.</span>
<span class="sd">    4. **Bounding boxes** â axis-aligned bounding boxes in (phi, theta)</span>
<span class="sd">       are computed from the Voronoi vertex coordinates.  These are</span>
<span class="sd">       approximations only (see caveat above).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    angular_resolution : float</span>
<span class="sd">        Approximate angular resolution in degrees.  Used only to estimate</span>
<span class="sd">        ``n_points`` when that parameter is not given explicitly.</span>
<span class="sd">    cutoff_theta : float</span>
<span class="sd">        Elevation mask angle in degrees.  Points below this elevation are</span>
<span class="sd">        excluded before tessellation.</span>
<span class="sd">    n_points : int or None</span>
<span class="sd">        Target number of Voronoi cells in the hemisphere.  If ``None``,</span>
<span class="sd">        estimated from ``angular_resolution``.</span>
<span class="sd">    phi_rotation : float</span>
<span class="sd">        Rigid azimuthal rotation applied after construction, in degrees.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ImportError</span>
<span class="sd">        If ``scipy`` is not installed.</span>
<span class="sd">    ValueError</span>
<span class="sd">        If fewer than 4 points survive the hemisphere filter.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The ``theta_lims``, ``phi_lims``, and ``cell_ids`` fields of the returned</span>
<span class="sd">    ``GridData`` are *synthetic* evenly-spaced arrays kept only for interface</span>
<span class="sd">    compatibility with ring-based grids.  They do **not** describe the actual</span>
<span class="sd">    Voronoi cell layout.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">angular_resolution</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">cutoff_theta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">n_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">phi_rotation</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the Fibonacci grid builder.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        angular_resolution : float, default 2</span>
<span class="sd">            Angular resolution in degrees.</span>
<span class="sd">        cutoff_theta : float, default 0</span>
<span class="sd">            Maximum polar angle cutoff in degrees.</span>
<span class="sd">        n_points : int | None, optional</span>
<span class="sd">            Number of points to generate.</span>
<span class="sd">        phi_rotation : float, default 0</span>
<span class="sd">            Rotation angle in degrees.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">angular_resolution</span><span class="p">,</span> <span class="n">cutoff_theta</span><span class="p">,</span> <span class="n">phi_rotation</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n_points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cell_area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angular_resolution_rad</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">hemisphere_area</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_points</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">hemisphere_area</span> <span class="o">/</span> <span class="n">cell_area</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n_points</span> <span class="o">=</span> <span class="n">n_points</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fibonacci: generating </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_points</span><span class="si">}</span><span class="s2"> points&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_grid_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the grid-type identifier string.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            ``&quot;fibonacci&quot;``</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">GridType</span><span class="o">.</span><span class="n">FIBONACCI</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_grid</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
        <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build Fibonacci sphere grid with Voronoi tessellation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        grid : pl.DataFrame</span>
<span class="sd">            One row per Voronoi cell.  Contains phi, theta (centre),</span>
<span class="sd">            bounding-box limits, ``voronoi_region`` (list of vertex indices</span>
<span class="sd">            into the Voronoi vertex array), and ``n_vertices``.</span>
<span class="sd">        theta_lims : np.ndarray</span>
<span class="sd">            Synthetic evenly-spaced theta limits (interface compatibility only).</span>
<span class="sd">        phi_lims : list[np.ndarray]</span>
<span class="sd">            Synthetic evenly-spaced phi limits (interface compatibility only).</span>
<span class="sd">        cell_ids : list[np.ndarray]</span>
<span class="sd">            Single-element list containing all cell ids.</span>
<span class="sd">        extra_kwargs : dict</span>
<span class="sd">            Contains ``voronoi`` (the ``SphericalVoronoi`` object) and</span>
<span class="sd">            ``points_xyz`` (the hemisphere point cloud, shape</span>
<span class="sd">            ``(n_points, 3)``).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">points_xyz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_fibonacci_sphere</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_points</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Convert to spherical</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">points_xyz</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">points_xyz</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">points_xyz</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

        <span class="c1"># Filter to northern hemisphere</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">theta</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff_theta_rad</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">theta</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">phi</span> <span class="o">=</span> <span class="n">phi</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
        <span class="n">points_xyz</span> <span class="o">=</span> <span class="n">points_xyz</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not enough points in hemisphere for Voronoi tessellation&quot;</span><span class="p">)</span>

        <span class="c1"># Compute spherical Voronoi tessellation</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span><span class="w"> </span><span class="nn">scipy.spatial</span><span class="w"> </span><span class="kn">import</span> <span class="n">SphericalVoronoi</span>

            <span class="n">sv</span> <span class="o">=</span> <span class="n">SphericalVoronoi</span><span class="p">(</span><span class="n">points_xyz</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">)</span>
            <span class="n">sv</span><span class="o">.</span><span class="n">sort_vertices_of_regions</span><span class="p">()</span>

        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
                <span class="s2">&quot;scipy required for Fibonacci grid. Install: pip install scipy&quot;</span>
            <span class="p">)</span>

        <span class="c1"># Create cells</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">point_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">p_phi</span><span class="p">,</span> <span class="n">p_theta</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">theta</span><span class="p">)):</span>
            <span class="n">region_vertices</span> <span class="o">=</span> <span class="n">sv</span><span class="o">.</span><span class="n">regions</span><span class="p">[</span><span class="n">point_idx</span><span class="p">]</span>

            <span class="k">if</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">in</span> <span class="n">region_vertices</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">region_coords</span> <span class="o">=</span> <span class="n">sv</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">region_vertices</span><span class="p">]</span>

            <span class="c1"># Convert region vertices to spherical</span>
            <span class="n">rv_x</span><span class="p">,</span> <span class="n">rv_y</span><span class="p">,</span> <span class="n">rv_z</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">region_coords</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
                <span class="n">region_coords</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                <span class="n">region_coords</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="n">rv_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">rv_z</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">rv_phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">rv_y</span><span class="p">,</span> <span class="n">rv_x</span><span class="p">)</span>
            <span class="n">rv_phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">rv_phi</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

            <span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;phi&quot;</span><span class="p">:</span> <span class="n">p_phi</span><span class="p">,</span>
                    <span class="s2">&quot;theta&quot;</span><span class="p">:</span> <span class="n">p_theta</span><span class="p">,</span>
                    <span class="s2">&quot;phi_min&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">rv_phi</span><span class="p">),</span>
                    <span class="s2">&quot;phi_max&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rv_phi</span><span class="p">),</span>
                    <span class="s2">&quot;theta_min&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">rv_theta</span><span class="p">),</span>
                    <span class="s2">&quot;theta_max&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rv_theta</span><span class="p">),</span>
                    <span class="s2">&quot;voronoi_region&quot;</span><span class="p">:</span> <span class="p">(</span>
                        <span class="n">region_vertices</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">region_vertices</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
                        <span class="k">else</span> <span class="n">region_vertices</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
                    <span class="p">),</span>
                    <span class="s2">&quot;n_vertices&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">region_vertices</span><span class="p">),</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="n">grid</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">int_range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">())</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;cell_id&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">extra_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;voronoi&quot;</span><span class="p">:</span> <span class="n">sv</span><span class="p">,</span>
            <span class="s2">&quot;points_xyz&quot;</span><span class="p">:</span> <span class="n">points_xyz</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="n">theta_lims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">phi_lims</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">theta_lims</span><span class="p">))]</span>
        <span class="n">cell_ids_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">height</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">grid</span><span class="p">,</span> <span class="n">theta_lims</span><span class="p">,</span> <span class="n">phi_lims</span><span class="p">,</span> <span class="n">cell_ids_list</span><span class="p">,</span> <span class="n">extra_kwargs</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_fibonacci_sphere</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate points on the unit sphere using the golden-spiral lattice.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        n : int</span>
<span class="sd">            Total number of points on the full sphere.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        points : np.ndarray</span>
<span class="sd">            Shape ``(n, 3)`` â Cartesian (x, y, z) coordinates on the unit</span>
<span class="sd">            sphere.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">golden_ratio</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span>

        <span class="c1"># Polar angle</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">indices</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span>

        <span class="c1"># Azimuthal angle</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">indices</span> <span class="o">/</span> <span class="n">golden_ratio</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

        <span class="c1"># Convert to Cartesian</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">angular_resolution</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cutoff_theta</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">n_points</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phi_rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>

<a href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the Fibonacci grid builder.</p>
<h5 id="canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder.__init__--parameters">Parameters<a class="headerlink" href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder.__init__--parameters" title="Permanent link">&para;</a></h5>
<p>angular_resolution : float, default 2
    Angular resolution in degrees.
cutoff_theta : float, default 0
    Maximum polar angle cutoff in degrees.
n_points : int | None, optional
    Number of points to generate.
phi_rotation : float, default 0
    Rotation angle in degrees.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/grids_impl/fibonacci_grid.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">angular_resolution</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">cutoff_theta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">n_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">phi_rotation</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the Fibonacci grid builder.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    angular_resolution : float, default 2</span>
<span class="sd">        Angular resolution in degrees.</span>
<span class="sd">    cutoff_theta : float, default 0</span>
<span class="sd">        Maximum polar angle cutoff in degrees.</span>
<span class="sd">    n_points : int | None, optional</span>
<span class="sd">        Number of points to generate.</span>
<span class="sd">    phi_rotation : float, default 0</span>
<span class="sd">        Rotation angle in degrees.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">angular_resolution</span><span class="p">,</span> <span class="n">cutoff_theta</span><span class="p">,</span> <span class="n">phi_rotation</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">n_points</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cell_area</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">angular_resolution_rad</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">hemisphere_area</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_points</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">hemisphere_area</span> <span class="o">/</span> <span class="n">cell_area</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_points</span> <span class="o">=</span> <span class="n">n_points</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fibonacci: generating </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_points</span><span class="si">}</span><span class="s2"> points&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder.get_grid_type" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_grid_type</span><span class="p">()</span></code>

<a href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder.get_grid_type" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Return the grid-type identifier string.</p>
<h5 id="canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder.get_grid_type--returns">Returns<a class="headerlink" href="#canvod.grids.grids_impl.fibonacci_grid.FibonacciBuilder.get_grid_type--returns" title="Permanent link">&para;</a></h5>
<p>str
    <code>"fibonacci"</code></p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/grids_impl/fibonacci_grid.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_grid_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the grid-type identifier string.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        ``&quot;fibonacci&quot;``</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">GridType</span><span class="o">.</span><span class="n">FIBONACCI</span><span class="o">.</span><span class="n">value</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><h3 id="htm-grid">HTM Grid<a class="headerlink" href="#htm-grid" title="Permanent link">&para;</a></h3>


<div class="doc doc-object doc-module">



<a id="canvod.grids.grids_impl.htm_grid"></a>
    <div class="doc doc-contents first">

        <p>HTM (Hierarchical Triangular Mesh) grid implementation.</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="canvod.grids.grids_impl.htm_grid.HTMBuilder" class="doc doc-heading">
            <code>HTMBuilder</code>


<a href="#canvod.grids.grids_impl.htm_grid.HTMBuilder" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="canvod.grids.core.grid_builder.BaseGridBuilder">BaseGridBuilder</span></code></p>



        <p>Hierarchical Triangular Mesh (HTM) grid.</p>
<p>HTM divides the sphere into an octahedron (8 triangular faces), then
recursively subdivides each face into 4 smaller triangles by inserting
edge-midpoint vertices projected onto the unit sphere.  The recursion
depth is controlled by <code>htm_level</code>.  This produces a strictly
hierarchical triangulation: every triangle at level <em>n</em> is the union of
exactly 4 triangles at level <em>n</em> + 1.</p>
<p>Cell areas are <em>approximately</em> equal but not strictly so â area
uniformity improves with level because the icosahedral edge-length
asymmetry averages out over many subdivisions.</p>
<h4 id="canvod.grids.grids_impl.htm_grid.HTMBuilder--coordinate-convention-physics-gnss">Coordinate convention (physics / GNSS)<a class="headerlink" href="#canvod.grids.grids_impl.htm_grid.HTMBuilder--coordinate-convention-physics-gnss" title="Permanent link">&para;</a></h4>
<ul>
<li>phi  â [0, 2Ï)  â azimuthal angle from East, counter-clockwise</li>
<li>theta â [0, Ï/2] â polar angle from zenith (0 = straight up,
  Ï/2 = horizon)</li>
</ul>
<p>Cell centres are the 3D Cartesian mean of the three triangle vertices,
re-normalised onto the unit sphere.</p>
<h4 id="canvod.grids.grids_impl.htm_grid.HTMBuilder--what-htm_level-resolution-means">What <code>htm_level</code> (resolution) means<a class="headerlink" href="#canvod.grids.grids_impl.htm_grid.HTMBuilder--what-htm_level-resolution-means" title="Permanent link">&para;</a></h4>
<p>The resolution is set by <code>htm_level</code>, <strong>not</strong> by <code>angular_resolution</code>.
<code>angular_resolution</code> is used only to <em>estimate</em> an appropriate level
when <code>htm_level</code> is not supplied explicitly.  The heuristic is::</p>
<div class="highlight"><pre><span></span><code>target_edge â 2 Ã angular_resolution   (degrees)
htm_level   = min(15, ceil(logâ(90 / target_edge)))
</code></pre></div>
<p>The approximate triangle edge length at level <em>n</em> is::</p>
<div class="highlight"><pre><span></span><code>edge â 90Â° / 2â¿
</code></pre></div>
<table>
<thead>
<tr>
<th>Level</th>
<th>Triangles (full sphere)</th>
<th>Approx edge</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>8</td>
<td>90Â°</td>
</tr>
<tr>
<td>1</td>
<td>32</td>
<td>45Â°</td>
</tr>
<tr>
<td>2</td>
<td>128</td>
<td>22.5Â°</td>
</tr>
<tr>
<td>3</td>
<td>512</td>
<td>11.25Â°</td>
</tr>
<tr>
<td>4</td>
<td>2 048</td>
<td>5.6Â°</td>
</tr>
<tr>
<td>n</td>
<td>8 Ã 4â¿</td>
<td>90Â° / 2â¿</td>
</tr>
</tbody>
</table>
<h4 id="canvod.grids.grids_impl.htm_grid.HTMBuilder--mathematical-construction">Mathematical construction<a class="headerlink" href="#canvod.grids.grids_impl.htm_grid.HTMBuilder--mathematical-construction" title="Permanent link">&para;</a></h4>
<ol>
<li><strong>Octahedron</strong> â 6 vertices at Â±x, Â±y, Â±z on the unit sphere, forming
   8 triangular faces (4 northern, 4 southern).</li>
<li>
<p><strong>Subdivision</strong> â for each triangle [vâ, vâ, vâ], three edge
   midpoints are computed and projected onto the unit sphere::</p>
<p>mâ = normalise((vâ + vâ) / 2)
   mâ = normalise((vâ + vâ) / 2)
   mâ = normalise((vâ + vâ) / 2)</p>
</li>
</ol>
<p>The four children are [vâ, mâ, mâ], [vâ, mâ, mâ], [vâ, mâ, mâ],
   and [mâ, mâ, mâ].  This is repeated <code>htm_level</code> times.
3. <strong>Hemisphere filter</strong> â a triangle is kept if <em>any</em> of its three
   vertices satisfies <code>theta â¤ Ï/2 â cutoff_theta</code>.  Boundary
   triangles that straddle the horizon are therefore included and may
   extend slightly below it.
4. Each leaf triangle becomes one cell; its centre, bounding box, and
   three vertex coordinates are stored.</p>
<h4 id="canvod.grids.grids_impl.htm_grid.HTMBuilder--parameters">Parameters<a class="headerlink" href="#canvod.grids.grids_impl.htm_grid.HTMBuilder--parameters" title="Permanent link">&para;</a></h4>
<p>angular_resolution : float
    Approximate angular resolution in degrees.  Used only to derive
    <code>htm_level</code> when that parameter is not given explicitly.
cutoff_theta : float
    Elevation mask angle in degrees.  Triangles are excluded only when
    <em>all</em> their vertices are below this elevation.
htm_level : int or None
    HTM subdivision depth.  If <code>None</code>, estimated from
    <code>angular_resolution</code>.  Practical range 0â15.
phi_rotation : float
    Rigid azimuthal rotation applied after construction, in degrees.</p>
<h4 id="canvod.grids.grids_impl.htm_grid.HTMBuilder--notes">Notes<a class="headerlink" href="#canvod.grids.grids_impl.htm_grid.HTMBuilder--notes" title="Permanent link">&para;</a></h4>
<p>The <code>theta_lims</code>, <code>phi_lims</code>, and <code>cell_ids</code> fields of the returned
<code>GridData</code> are <em>synthetic</em> evenly-spaced arrays kept only for interface
compatibility with ring-based grids.  They do <strong>not</strong> describe the actual
triangular cell layout.</p>
<p>HTM IDs in this implementation use a decimal-digit scheme
(<code>parent_id Ã 10 + child_index</code>) which diverges from the original
SDSS HTM binary-coded ID scheme.  This is adequate for indexing but
should not be compared with external HTM catalogues.</p>
<h4 id="canvod.grids.grids_impl.htm_grid.HTMBuilder--references">References<a class="headerlink" href="#canvod.grids.grids_impl.htm_grid.HTMBuilder--references" title="Permanent link">&para;</a></h4>
<p>Kunszt et al. (2001): "The Hierarchical Triangular Mesh"
https://www.sdss.org/dr12/algorithms/htm/</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/grids_impl/htm_grid.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">HTMBuilder</span><span class="p">(</span><span class="n">BaseGridBuilder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Hierarchical Triangular Mesh (HTM) grid.</span>

<span class="sd">    HTM divides the sphere into an octahedron (8 triangular faces), then</span>
<span class="sd">    recursively subdivides each face into 4 smaller triangles by inserting</span>
<span class="sd">    edge-midpoint vertices projected onto the unit sphere.  The recursion</span>
<span class="sd">    depth is controlled by ``htm_level``.  This produces a strictly</span>
<span class="sd">    hierarchical triangulation: every triangle at level *n* is the union of</span>
<span class="sd">    exactly 4 triangles at level *n* + 1.</span>

<span class="sd">    Cell areas are *approximately* equal but not strictly so â area</span>
<span class="sd">    uniformity improves with level because the icosahedral edge-length</span>
<span class="sd">    asymmetry averages out over many subdivisions.</span>

<span class="sd">    Coordinate convention (physics / GNSS)</span>
<span class="sd">    ---------------------------------------</span>
<span class="sd">    * phi  â [0, 2Ï)  â azimuthal angle from East, counter-clockwise</span>
<span class="sd">    * theta â [0, Ï/2] â polar angle from zenith (0 = straight up,</span>
<span class="sd">      Ï/2 = horizon)</span>

<span class="sd">    Cell centres are the 3D Cartesian mean of the three triangle vertices,</span>
<span class="sd">    re-normalised onto the unit sphere.</span>

<span class="sd">    What ``htm_level`` (resolution) means</span>
<span class="sd">    --------------------------------------</span>
<span class="sd">    The resolution is set by ``htm_level``, **not** by ``angular_resolution``.</span>
<span class="sd">    ``angular_resolution`` is used only to *estimate* an appropriate level</span>
<span class="sd">    when ``htm_level`` is not supplied explicitly.  The heuristic is::</span>

<span class="sd">        target_edge â 2 Ã angular_resolution   (degrees)</span>
<span class="sd">        htm_level   = min(15, ceil(logâ(90 / target_edge)))</span>

<span class="sd">    The approximate triangle edge length at level *n* is::</span>

<span class="sd">        edge â 90Â° / 2â¿</span>

<span class="sd">    | Level | Triangles (full sphere) | Approx edge |</span>
<span class="sd">    |-------|-------------------------|-------------|</span>
<span class="sd">    | 0     | 8                       | 90Â°         |</span>
<span class="sd">    | 1     | 32                      | 45Â°         |</span>
<span class="sd">    | 2     | 128                     | 22.5Â°       |</span>
<span class="sd">    | 3     | 512                     | 11.25Â°      |</span>
<span class="sd">    | 4     | 2 048                   | 5.6Â°        |</span>
<span class="sd">    | n     | 8 Ã 4â¿                  | 90Â° / 2â¿   |</span>

<span class="sd">    Mathematical construction</span>
<span class="sd">    -------------------------</span>
<span class="sd">    1. **Octahedron** â 6 vertices at Â±x, Â±y, Â±z on the unit sphere, forming</span>
<span class="sd">       8 triangular faces (4 northern, 4 southern).</span>
<span class="sd">    2. **Subdivision** â for each triangle [vâ, vâ, vâ], three edge</span>
<span class="sd">       midpoints are computed and projected onto the unit sphere::</span>

<span class="sd">           mâ = normalise((vâ + vâ) / 2)</span>
<span class="sd">           mâ = normalise((vâ + vâ) / 2)</span>
<span class="sd">           mâ = normalise((vâ + vâ) / 2)</span>

<span class="sd">       The four children are [vâ, mâ, mâ], [vâ, mâ, mâ], [vâ, mâ, mâ],</span>
<span class="sd">       and [mâ, mâ, mâ].  This is repeated ``htm_level`` times.</span>
<span class="sd">    3. **Hemisphere filter** â a triangle is kept if *any* of its three</span>
<span class="sd">       vertices satisfies ``theta â¤ Ï/2 â cutoff_theta``.  Boundary</span>
<span class="sd">       triangles that straddle the horizon are therefore included and may</span>
<span class="sd">       extend slightly below it.</span>
<span class="sd">    4. Each leaf triangle becomes one cell; its centre, bounding box, and</span>
<span class="sd">       three vertex coordinates are stored.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    angular_resolution : float</span>
<span class="sd">        Approximate angular resolution in degrees.  Used only to derive</span>
<span class="sd">        ``htm_level`` when that parameter is not given explicitly.</span>
<span class="sd">    cutoff_theta : float</span>
<span class="sd">        Elevation mask angle in degrees.  Triangles are excluded only when</span>
<span class="sd">        *all* their vertices are below this elevation.</span>
<span class="sd">    htm_level : int or None</span>
<span class="sd">        HTM subdivision depth.  If ``None``, estimated from</span>
<span class="sd">        ``angular_resolution``.  Practical range 0â15.</span>
<span class="sd">    phi_rotation : float</span>
<span class="sd">        Rigid azimuthal rotation applied after construction, in degrees.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The ``theta_lims``, ``phi_lims``, and ``cell_ids`` fields of the returned</span>
<span class="sd">    ``GridData`` are *synthetic* evenly-spaced arrays kept only for interface</span>
<span class="sd">    compatibility with ring-based grids.  They do **not** describe the actual</span>
<span class="sd">    triangular cell layout.</span>

<span class="sd">    HTM IDs in this implementation use a decimal-digit scheme</span>
<span class="sd">    (``parent_id Ã 10 + child_index``) which diverges from the original</span>
<span class="sd">    SDSS HTM binary-coded ID scheme.  This is adequate for indexing but</span>
<span class="sd">    should not be compared with external HTM catalogues.</span>

<span class="sd">    References</span>
<span class="sd">    ----------</span>
<span class="sd">    Kunszt et al. (2001): &quot;The Hierarchical Triangular Mesh&quot;</span>
<span class="sd">    https://www.sdss.org/dr12/algorithms/htm/</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">angular_resolution</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">cutoff_theta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">htm_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">phi_rotation</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the HTM grid builder.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        angular_resolution : float, default 2</span>
<span class="sd">            Angular resolution in degrees.</span>
<span class="sd">        cutoff_theta : float, default 0</span>
<span class="sd">            Maximum polar angle cutoff in degrees.</span>
<span class="sd">        htm_level : int | None, optional</span>
<span class="sd">            HTM subdivision level.</span>
<span class="sd">        phi_rotation : float, default 0</span>
<span class="sd">            Rotation angle in degrees.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">angular_resolution</span><span class="p">,</span> <span class="n">cutoff_theta</span><span class="p">,</span> <span class="n">phi_rotation</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">htm_level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">target_edge_deg</span> <span class="o">=</span> <span class="n">angular_resolution</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">htm_level</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
                <span class="mi">0</span><span class="p">,</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="mi">90</span> <span class="o">/</span> <span class="n">target_edge_deg</span><span class="p">))),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">htm_level</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">htm_level</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">htm_level</span> <span class="o">=</span> <span class="n">htm_level</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;HTM: level=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">htm_level</span><span class="si">}</span><span class="s2">, ~</span><span class="si">{</span><span class="mi">8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">htm_level</span><span class="si">}</span><span class="s2"> triangles&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_grid_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the grid-type identifier string.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            ``&quot;htm&quot;``</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">GridType</span><span class="o">.</span><span class="n">HTM</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_grid</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Build HTM grid by recursive octahedron subdivision.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        grid : pl.DataFrame</span>
<span class="sd">            One row per triangular cell.  Contains phi, theta (centre),</span>
<span class="sd">            bounding-box limits, ``htm_id``, ``htm_level``, and the three</span>
<span class="sd">            vertex coordinate columns ``htm_vertex_0/1/2`` (each a list of</span>
<span class="sd">            3 floats in Cartesian xyz).</span>
<span class="sd">        theta_lims : np.ndarray</span>
<span class="sd">            Synthetic evenly-spaced theta limits (interface compatibility only).</span>
<span class="sd">        phi_lims : list[np.ndarray]</span>
<span class="sd">            Synthetic evenly-spaced phi limits (interface compatibility only).</span>
<span class="sd">        cell_ids : list[np.ndarray]</span>
<span class="sd">            Single-element list containing all cell ids.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>  <span class="c1"># 0: North pole</span>
                <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># 1: +X</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># 2: +Y</span>
                <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># 3: -X</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># 4: -Y</span>
                <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># 5: South pole</span>
            <span class="p">],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">base_faces</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>  <span class="c1"># Northern</span>
            <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span>
            <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span>  <span class="c1"># Southern</span>
        <span class="p">]</span>

        <span class="n">all_triangles</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_htm_ids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">base_idx</span><span class="p">,</span> <span class="n">base_face</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">base_faces</span><span class="p">):</span>
            <span class="n">v0</span> <span class="o">=</span> <span class="n">base_vertices</span><span class="p">[</span><span class="n">base_face</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">v1</span> <span class="o">=</span> <span class="n">base_vertices</span><span class="p">[</span><span class="n">base_face</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">v2</span> <span class="o">=</span> <span class="n">base_vertices</span><span class="p">[</span><span class="n">base_face</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>

            <span class="n">triangles</span><span class="p">,</span> <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subdivide_htm</span><span class="p">([</span><span class="n">v0</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">],</span> <span class="n">base_idx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">htm_level</span><span class="p">)</span>
            <span class="n">all_triangles</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">triangles</span><span class="p">)</span>
            <span class="n">all_htm_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>

        <span class="c1"># Convert to cells</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">tri</span><span class="p">,</span> <span class="n">htm_id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">all_triangles</span><span class="p">,</span> <span class="n">all_htm_ids</span><span class="p">):</span>
            <span class="n">v0</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">tri</span>

            <span class="c1"># Center</span>
            <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">v0</span> <span class="o">+</span> <span class="n">v1</span> <span class="o">+</span> <span class="n">v2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span>
            <span class="n">center</span> <span class="o">=</span> <span class="n">center</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">center</span><span class="p">)</span>

            <span class="n">theta_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">phi_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">phi_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">phi_center</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

            <span class="c1"># Filter hemisphere</span>
            <span class="n">vertex_thetas</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="n">v0</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">]]</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">t</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff_theta_rad</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">vertex_thetas</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="c1"># Vertex coords</span>
            <span class="n">thetas</span><span class="p">,</span> <span class="n">phis</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="p">[</span><span class="n">v0</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">]:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
                <span class="n">thetas</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="n">phis</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

            <span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;phi&quot;</span><span class="p">:</span> <span class="n">phi_center</span><span class="p">,</span>
                    <span class="s2">&quot;theta&quot;</span><span class="p">:</span> <span class="n">theta_center</span><span class="p">,</span>
                    <span class="s2">&quot;phi_min&quot;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">phis</span><span class="p">),</span>
                    <span class="s2">&quot;phi_max&quot;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">phis</span><span class="p">),</span>
                    <span class="s2">&quot;theta_min&quot;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="n">thetas</span><span class="p">),</span>
                    <span class="s2">&quot;theta_max&quot;</span><span class="p">:</span> <span class="nb">max</span><span class="p">(</span><span class="n">thetas</span><span class="p">),</span>
                    <span class="s2">&quot;htm_id&quot;</span><span class="p">:</span> <span class="n">htm_id</span><span class="p">,</span>
                    <span class="s2">&quot;htm_level&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">htm_level</span><span class="p">,</span>
                    <span class="s2">&quot;htm_vertex_0&quot;</span><span class="p">:</span> <span class="n">v0</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                    <span class="s2">&quot;htm_vertex_1&quot;</span><span class="p">:</span> <span class="n">v1</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                    <span class="s2">&quot;htm_vertex_2&quot;</span><span class="p">:</span> <span class="n">v2</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="n">grid</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">int_range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">())</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;cell_id&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">theta_lims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="n">phi_lims</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">theta_lims</span><span class="p">))]</span>
        <span class="n">cell_ids_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">grid</span><span class="p">[</span><span class="s2">&quot;cell_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()]</span>

        <span class="k">return</span> <span class="n">grid</span><span class="p">,</span> <span class="n">theta_lims</span><span class="p">,</span> <span class="n">phi_lims</span><span class="p">,</span> <span class="n">cell_ids_list</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_subdivide_htm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">tri</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">htm_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">target_level</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">current_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">list</span><span class="p">,</span> <span class="nb">list</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Recursively subdivide a single triangle.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        tri : list of np.ndarray</span>
<span class="sd">            Three vertex arrays [vâ, vâ, vâ], each shape ``(3,)``.</span>
<span class="sd">        htm_id : int</span>
<span class="sd">            Current HTM identifier for this triangle.</span>
<span class="sd">        target_level : int</span>
<span class="sd">            Recursion depth to reach.</span>
<span class="sd">        current_level : int</span>
<span class="sd">            Current recursion depth.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        triangles : list of list</span>
<span class="sd">            Leaf triangles at ``target_level``.</span>
<span class="sd">        ids : list of int</span>
<span class="sd">            Corresponding HTM identifiers.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">current_level</span> <span class="o">==</span> <span class="n">target_level</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">tri</span><span class="p">],</span> <span class="p">[</span><span class="n">htm_id</span><span class="p">]</span>

        <span class="n">v0</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">tri</span>

        <span class="c1"># Midpoints on sphere</span>
        <span class="n">m0</span> <span class="o">=</span> <span class="p">(</span><span class="n">v0</span> <span class="o">+</span> <span class="n">v1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">m0</span> <span class="o">=</span> <span class="n">m0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">m0</span><span class="p">)</span>
        <span class="n">m1</span> <span class="o">=</span> <span class="p">(</span><span class="n">v1</span> <span class="o">+</span> <span class="n">v2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">m1</span> <span class="o">=</span> <span class="n">m1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">m1</span><span class="p">)</span>
        <span class="n">m2</span> <span class="o">=</span> <span class="p">(</span><span class="n">v2</span> <span class="o">+</span> <span class="n">v0</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">m2</span> <span class="o">=</span> <span class="n">m2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">m2</span><span class="p">)</span>

        <span class="c1"># 4 children</span>
        <span class="n">children</span> <span class="o">=</span> <span class="p">[[</span><span class="n">v0</span><span class="p">,</span> <span class="n">m0</span><span class="p">,</span> <span class="n">m2</span><span class="p">],</span> <span class="p">[</span><span class="n">v1</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m0</span><span class="p">],</span> <span class="p">[</span><span class="n">v2</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">m1</span><span class="p">],</span> <span class="p">[</span><span class="n">m0</span><span class="p">,</span> <span class="n">m1</span><span class="p">,</span> <span class="n">m2</span><span class="p">]]</span>

        <span class="n">all_tris</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_ids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">child_idx</span><span class="p">,</span> <span class="n">child</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">children</span><span class="p">):</span>
            <span class="n">child_id</span> <span class="o">=</span> <span class="n">htm_id</span> <span class="o">*</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">child_idx</span>
            <span class="n">tris</span><span class="p">,</span> <span class="n">ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subdivide_htm</span><span class="p">(</span>
                <span class="n">child</span><span class="p">,</span>
                <span class="n">child_id</span><span class="p">,</span>
                <span class="n">target_level</span><span class="p">,</span>
                <span class="n">current_level</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">all_tris</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tris</span><span class="p">)</span>
            <span class="n">all_ids</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">all_tris</span><span class="p">,</span> <span class="n">all_ids</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_htm_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get HTM-specific information.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        info : dict</span>
<span class="sd">            Keys: ``htm_level``, ``n_triangles_full_sphere``,</span>
<span class="sd">            ``approx_edge_length_deg``, ``approx_edge_length_arcmin``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_triangles</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">4</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">htm_level</span>
        <span class="n">approx_edge_deg</span> <span class="o">=</span> <span class="mi">90</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">htm_level</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;htm_level&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">htm_level</span><span class="p">,</span>
            <span class="s2">&quot;n_triangles_full_sphere&quot;</span><span class="p">:</span> <span class="n">n_triangles</span><span class="p">,</span>
            <span class="s2">&quot;approx_edge_length_deg&quot;</span><span class="p">:</span> <span class="n">approx_edge_deg</span><span class="p">,</span>
            <span class="s2">&quot;approx_edge_length_arcmin&quot;</span><span class="p">:</span> <span class="n">approx_edge_deg</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span>
        <span class="p">}</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="canvod.grids.grids_impl.htm_grid.HTMBuilder.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">angular_resolution</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cutoff_theta</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">htm_level</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phi_rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></code>

<a href="#canvod.grids.grids_impl.htm_grid.HTMBuilder.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the HTM grid builder.</p>
<h5 id="canvod.grids.grids_impl.htm_grid.HTMBuilder.__init__--parameters">Parameters<a class="headerlink" href="#canvod.grids.grids_impl.htm_grid.HTMBuilder.__init__--parameters" title="Permanent link">&para;</a></h5>
<p>angular_resolution : float, default 2
    Angular resolution in degrees.
cutoff_theta : float, default 0
    Maximum polar angle cutoff in degrees.
htm_level : int | None, optional
    HTM subdivision level.
phi_rotation : float, default 0
    Rotation angle in degrees.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/grids_impl/htm_grid.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">angular_resolution</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">cutoff_theta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">htm_level</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">phi_rotation</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the HTM grid builder.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    angular_resolution : float, default 2</span>
<span class="sd">        Angular resolution in degrees.</span>
<span class="sd">    cutoff_theta : float, default 0</span>
<span class="sd">        Maximum polar angle cutoff in degrees.</span>
<span class="sd">    htm_level : int | None, optional</span>
<span class="sd">        HTM subdivision level.</span>
<span class="sd">    phi_rotation : float, default 0</span>
<span class="sd">        Rotation angle in degrees.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">angular_resolution</span><span class="p">,</span> <span class="n">cutoff_theta</span><span class="p">,</span> <span class="n">phi_rotation</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">htm_level</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">target_edge_deg</span> <span class="o">=</span> <span class="n">angular_resolution</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">htm_level</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span>
            <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="mi">90</span> <span class="o">/</span> <span class="n">target_edge_deg</span><span class="p">))),</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">htm_level</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">htm_level</span><span class="p">,</span> <span class="mi">15</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">htm_level</span> <span class="o">=</span> <span class="n">htm_level</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;HTM: level=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">htm_level</span><span class="si">}</span><span class="s2">, ~</span><span class="si">{</span><span class="mi">8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">4</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">htm_level</span><span class="si">}</span><span class="s2"> triangles&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.grids_impl.htm_grid.HTMBuilder.get_grid_type" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_grid_type</span><span class="p">()</span></code>

<a href="#canvod.grids.grids_impl.htm_grid.HTMBuilder.get_grid_type" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Return the grid-type identifier string.</p>
<h5 id="canvod.grids.grids_impl.htm_grid.HTMBuilder.get_grid_type--returns">Returns<a class="headerlink" href="#canvod.grids.grids_impl.htm_grid.HTMBuilder.get_grid_type--returns" title="Permanent link">&para;</a></h5>
<p>str
    <code>"htm"</code></p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/grids_impl/htm_grid.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_grid_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the grid-type identifier string.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        ``&quot;htm&quot;``</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">GridType</span><span class="o">.</span><span class="n">HTM</span><span class="o">.</span><span class="n">value</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.grids_impl.htm_grid.HTMBuilder.get_htm_info" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_htm_info</span><span class="p">()</span></code>

<a href="#canvod.grids.grids_impl.htm_grid.HTMBuilder.get_htm_info" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Get HTM-specific information.</p>
<h5 id="canvod.grids.grids_impl.htm_grid.HTMBuilder.get_htm_info--returns">Returns<a class="headerlink" href="#canvod.grids.grids_impl.htm_grid.HTMBuilder.get_htm_info--returns" title="Permanent link">&para;</a></h5>
<p>info : dict
    Keys: <code>htm_level</code>, <code>n_triangles_full_sphere</code>,
    <code>approx_edge_length_deg</code>, <code>approx_edge_length_arcmin</code>.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/grids_impl/htm_grid.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_htm_info</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get HTM-specific information.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    info : dict</span>
<span class="sd">        Keys: ``htm_level``, ``n_triangles_full_sphere``,</span>
<span class="sd">        ``approx_edge_length_deg``, ``approx_edge_length_arcmin``.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n_triangles</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">*</span> <span class="mi">4</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">htm_level</span>
    <span class="n">approx_edge_deg</span> <span class="o">=</span> <span class="mi">90</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">htm_level</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;htm_level&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">htm_level</span><span class="p">,</span>
        <span class="s2">&quot;n_triangles_full_sphere&quot;</span><span class="p">:</span> <span class="n">n_triangles</span><span class="p">,</span>
        <span class="s2">&quot;approx_edge_length_deg&quot;</span><span class="p">:</span> <span class="n">approx_edge_deg</span><span class="p">,</span>
        <span class="s2">&quot;approx_edge_length_arcmin&quot;</span><span class="p">:</span> <span class="n">approx_edge_deg</span> <span class="o">*</span> <span class="mi">60</span><span class="p">,</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><h3 id="equal-angle-grid">Equal-Angle Grid<a class="headerlink" href="#equal-angle-grid" title="Permanent link">&para;</a></h3>


<div class="doc doc-object doc-module">



<a id="canvod.grids.grids_impl.equal_angle_grid"></a>
    <div class="doc doc-contents first">

        <p>Equal-angle grid implementation.</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="canvod.grids.grids_impl.equal_angle_grid.EqualAngleBuilder" class="doc doc-heading">
            <code>EqualAngleBuilder</code>


<a href="#canvod.grids.grids_impl.equal_angle_grid.EqualAngleBuilder" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="canvod.grids.core.grid_builder.BaseGridBuilder">BaseGridBuilder</span></code></p>



        <p>Equal angular spacing in both theta and phi (NOT equal area).</p>
<p>Every cell is a rectangle of the same angular size ÎÎ¸ Ã ÎÏ in the
(theta, phi) parameter space.  Because solid angle depends on cos(theta),
cells near the zenith subtend <em>more</em> solid angle than cells near the
horizon.  This makes the grid biased toward the zenith for any
solid-angle-weighted statistic.  <strong>Not recommended for scientific
analysis</strong> â use <code>EqualAreaBuilder</code> instead.</p>
<h4 id="canvod.grids.grids_impl.equal_angle_grid.EqualAngleBuilder--coordinate-convention-physics-gnss">Coordinate convention (physics / GNSS)<a class="headerlink" href="#canvod.grids.grids_impl.equal_angle_grid.EqualAngleBuilder--coordinate-convention-physics-gnss" title="Permanent link">&para;</a></h4>
<ul>
<li>phi  â [0, 2Ï)  â azimuthal angle from East, counter-clockwise</li>
<li>theta â [0, Ï/2] â polar angle from zenith</li>
</ul>
<h4 id="canvod.grids.grids_impl.equal_angle_grid.EqualAngleBuilder--what-angular_resolution-means">What <code>angular_resolution</code> means<a class="headerlink" href="#canvod.grids.grids_impl.equal_angle_grid.EqualAngleBuilder--what-angular_resolution-means" title="Permanent link">&para;</a></h4>
<p><code>angular_resolution</code> (degrees) is used as <strong>both</strong> the theta-band width
and the phi-sector width.  The number of phi divisions is constant across
all bands::</p>
<div class="highlight"><pre><span></span><code>n_phi = round(2Ï / ÎÎ¸)
</code></pre></div>
<p>and does not change with latitude.</p>
<h4 id="canvod.grids.grids_impl.equal_angle_grid.EqualAngleBuilder--mathematical-construction">Mathematical construction<a class="headerlink" href="#canvod.grids.grids_impl.equal_angle_grid.EqualAngleBuilder--mathematical-construction" title="Permanent link">&para;</a></h4>
<ol>
<li>A zenith cap cell covers [0, ÎÎ¸/2] Ã [0, 2Ï).</li>
<li>Theta band edges are placed at ÎÎ¸/2, 3ÎÎ¸/2, â¦ up to Ï/2.</li>
<li>Within every band, the full azimuth is split into <code>n_phi</code> sectors of
   equal width ÎÏ = 2Ï / n_phi.</li>
<li>Cell centres are at the midpoint of each (phi, theta) rectangle.</li>
</ol>
<h4 id="canvod.grids.grids_impl.equal_angle_grid.EqualAngleBuilder--parameters">Parameters<a class="headerlink" href="#canvod.grids.grids_impl.equal_angle_grid.EqualAngleBuilder--parameters" title="Permanent link">&para;</a></h4>
<p>angular_resolution : float
    Angular spacing in degrees, applied identically in both theta and phi.
cutoff_theta : float
    Elevation mask angle in degrees (bands below this are omitted).
phi_rotation : float
    Rigid azimuthal rotation applied after construction, in degrees.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/grids_impl/equal_angle_grid.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">EqualAngleBuilder</span><span class="p">(</span><span class="n">BaseGridBuilder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Equal angular spacing in both theta and phi (NOT equal area).</span>

<span class="sd">    Every cell is a rectangle of the same angular size ÎÎ¸ Ã ÎÏ in the</span>
<span class="sd">    (theta, phi) parameter space.  Because solid angle depends on cos(theta),</span>
<span class="sd">    cells near the zenith subtend *more* solid angle than cells near the</span>
<span class="sd">    horizon.  This makes the grid biased toward the zenith for any</span>
<span class="sd">    solid-angle-weighted statistic.  **Not recommended for scientific</span>
<span class="sd">    analysis** â use ``EqualAreaBuilder`` instead.</span>

<span class="sd">    Coordinate convention (physics / GNSS)</span>
<span class="sd">    ---------------------------------------</span>
<span class="sd">    * phi  â [0, 2Ï)  â azimuthal angle from East, counter-clockwise</span>
<span class="sd">    * theta â [0, Ï/2] â polar angle from zenith</span>

<span class="sd">    What ``angular_resolution`` means</span>
<span class="sd">    ----------------------------------</span>
<span class="sd">    ``angular_resolution`` (degrees) is used as **both** the theta-band width</span>
<span class="sd">    and the phi-sector width.  The number of phi divisions is constant across</span>
<span class="sd">    all bands::</span>

<span class="sd">        n_phi = round(2Ï / ÎÎ¸)</span>

<span class="sd">    and does not change with latitude.</span>

<span class="sd">    Mathematical construction</span>
<span class="sd">    -------------------------</span>
<span class="sd">    1. A zenith cap cell covers [0, ÎÎ¸/2] Ã [0, 2Ï).</span>
<span class="sd">    2. Theta band edges are placed at ÎÎ¸/2, 3ÎÎ¸/2, â¦ up to Ï/2.</span>
<span class="sd">    3. Within every band, the full azimuth is split into ``n_phi`` sectors of</span>
<span class="sd">       equal width ÎÏ = 2Ï / n_phi.</span>
<span class="sd">    4. Cell centres are at the midpoint of each (phi, theta) rectangle.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    angular_resolution : float</span>
<span class="sd">        Angular spacing in degrees, applied identically in both theta and phi.</span>
<span class="sd">    cutoff_theta : float</span>
<span class="sd">        Elevation mask angle in degrees (bands below this are omitted).</span>
<span class="sd">    phi_rotation : float</span>
<span class="sd">        Rigid azimuthal rotation applied after construction, in degrees.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_grid_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the grid-type identifier string.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            ``&quot;equal_angle&quot;``</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">GridType</span><span class="o">.</span><span class="n">EQUAL_ANGLE</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_grid</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct the equal-angle hemisphere grid.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        grid : pl.DataFrame</span>
<span class="sd">            One row per cell.</span>
<span class="sd">        theta_lims : np.ndarray</span>
<span class="sd">            Outer theta edge of each band (radians).</span>
<span class="sd">        phi_lims : list[np.ndarray]</span>
<span class="sd">            Array of phi_min values for each band (identical across bands).</span>
<span class="sd">        cell_ids : list[np.ndarray]</span>
<span class="sd">            Cell-id arrays, one per band.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">max_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">theta_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">angular_resolution_rad</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
            <span class="n">max_theta</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">cutoff_theta_rad</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">angular_resolution_rad</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">n_phi_divisions</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">angular_resolution_rad</span><span class="p">)</span>

        <span class="n">cells</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">theta_lims</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">phi_lims</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cell_ids</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Zenith</span>
        <span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;phi&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span>
                    <span class="s2">&quot;theta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span>
                    <span class="s2">&quot;phi_min&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span>
                    <span class="s2">&quot;phi_max&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">],</span>
                    <span class="s2">&quot;theta_min&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">],</span>
                    <span class="s2">&quot;theta_max&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">angular_resolution_rad</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span>
                <span class="p">}</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">theta_lims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">angular_resolution_rad</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">phi_lims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]))</span>
        <span class="n">cell_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">next_cell_id</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">iband</span><span class="p">,</span> <span class="n">theta_outer</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">theta_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
            <span class="n">theta_inner</span> <span class="o">=</span> <span class="n">theta_edges</span><span class="p">[</span><span class="n">iband</span><span class="p">]</span>
            <span class="n">phi_span</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="n">n_phi_divisions</span>

            <span class="n">cell_id_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">next_cell_id</span><span class="p">,</span> <span class="n">next_cell_id</span> <span class="o">+</span> <span class="n">n_phi_divisions</span><span class="p">))</span>
            <span class="n">next_cell_id</span> <span class="o">=</span> <span class="n">cell_id_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="n">phi_min_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">-</span> <span class="n">phi_span</span><span class="p">,</span> <span class="n">n_phi_divisions</span><span class="p">)</span>
            <span class="n">phi_max_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">phi_min_arr</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">]))</span>

            <span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;phi&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">phi_min_arr</span> <span class="o">+</span> <span class="n">phi_max_arr</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="s2">&quot;theta&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
                            <span class="n">n_phi_divisions</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">theta_inner</span> <span class="o">+</span> <span class="n">theta_outer</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="p">),</span>
                        <span class="s2">&quot;phi_min&quot;</span><span class="p">:</span> <span class="n">phi_min_arr</span><span class="p">,</span>
                        <span class="s2">&quot;phi_max&quot;</span><span class="p">:</span> <span class="n">phi_max_arr</span><span class="p">,</span>
                        <span class="s2">&quot;theta_min&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_phi_divisions</span><span class="p">,</span> <span class="n">theta_inner</span><span class="p">),</span>
                        <span class="s2">&quot;theta_max&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_phi_divisions</span><span class="p">,</span> <span class="n">theta_outer</span><span class="p">),</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="p">)</span>

            <span class="n">theta_lims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">theta_outer</span><span class="p">)</span>
            <span class="n">phi_lims</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">phi_min_arr</span><span class="p">)</span>
            <span class="n">cell_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cell_id_list</span><span class="p">))</span>

        <span class="n">grid</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span><span class="o">.</span><span class="n">with_row_index</span><span class="p">(</span><span class="s2">&quot;cell_id&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">grid</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">theta_lims</span><span class="p">),</span> <span class="n">phi_lims</span><span class="p">,</span> <span class="n">cell_ids</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="canvod.grids.grids_impl.equal_angle_grid.EqualAngleBuilder.get_grid_type" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_grid_type</span><span class="p">()</span></code>

<a href="#canvod.grids.grids_impl.equal_angle_grid.EqualAngleBuilder.get_grid_type" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Return the grid-type identifier string.</p>
<h5 id="canvod.grids.grids_impl.equal_angle_grid.EqualAngleBuilder.get_grid_type--returns">Returns<a class="headerlink" href="#canvod.grids.grids_impl.equal_angle_grid.EqualAngleBuilder.get_grid_type--returns" title="Permanent link">&para;</a></h5>
<p>str
    <code>"equal_angle"</code></p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/grids_impl/equal_angle_grid.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_grid_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the grid-type identifier string.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        ``&quot;equal_angle&quot;``</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">GridType</span><span class="o">.</span><span class="n">EQUAL_ANGLE</span><span class="o">.</span><span class="n">value</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><h3 id="equirectangular-grid">Equirectangular Grid<a class="headerlink" href="#equirectangular-grid" title="Permanent link">&para;</a></h3>


<div class="doc doc-object doc-module">



<a id="canvod.grids.grids_impl.equirectangular_grid"></a>
    <div class="doc doc-contents first">

        <p>Equirectangular grid implementation.</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="canvod.grids.grids_impl.equirectangular_grid.EquirectangularBuilder" class="doc doc-heading">
            <code>EquirectangularBuilder</code>


<a href="#canvod.grids.grids_impl.equirectangular_grid.EquirectangularBuilder" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="canvod.grids.core.grid_builder.BaseGridBuilder">BaseGridBuilder</span></code></p>



        <p>Simple rectangular grid in (theta, phi) space.</p>
<p>The hemisphere is divided into a regular rectangular array: a constant
number of theta bands, each containing the same constant number of phi
sectors.  Every cell is an identical rectangle in angular coordinates.
This is <em>structurally</em> identical to <code>EqualAngleBuilder</code> except for one
difference in the zenith treatment: <code>EqualAngleBuilder</code> collapses the
first band into a single zenith cap, while this builder does not â every
band has the same number of sectors.</p>
<p>Because solid angle depends on cos(theta), cells near the zenith subtend
<em>more</em> solid angle than cells near the horizon.  This makes the grid
biased toward the zenith for any solid-angle-weighted statistic.
<strong>Not recommended for scientific analysis</strong> â use <code>EqualAreaBuilder</code>
instead.</p>
<h4 id="canvod.grids.grids_impl.equirectangular_grid.EquirectangularBuilder--coordinate-convention-physics-gnss">Coordinate convention (physics / GNSS)<a class="headerlink" href="#canvod.grids.grids_impl.equirectangular_grid.EquirectangularBuilder--coordinate-convention-physics-gnss" title="Permanent link">&para;</a></h4>
<ul>
<li>phi  â [0, 2Ï)  â azimuthal angle from East, counter-clockwise</li>
<li>theta â [0, Ï/2] â polar angle from zenith (0 = straight up,
  Ï/2 = horizon)</li>
</ul>
<h4 id="canvod.grids.grids_impl.equirectangular_grid.EquirectangularBuilder--what-angular_resolution-means">What <code>angular_resolution</code> means<a class="headerlink" href="#canvod.grids.grids_impl.equirectangular_grid.EquirectangularBuilder--what-angular_resolution-means" title="Permanent link">&para;</a></h4>
<p><code>angular_resolution</code> (degrees) is used as <strong>both</strong> the theta-band width
<em>and</em> the phi-sector width.  The grid is therefore square in angular
coordinates::</p>
<div class="highlight"><pre><span></span><code>n_theta = round((Ï/2 â cutoff) / ÎÎ¸)
n_phi   = round(2Ï / ÎÎ¸)
total cells = n_theta Ã n_phi
</code></pre></div>
<h4 id="canvod.grids.grids_impl.equirectangular_grid.EquirectangularBuilder--mathematical-construction">Mathematical construction<a class="headerlink" href="#canvod.grids.grids_impl.equirectangular_grid.EquirectangularBuilder--mathematical-construction" title="Permanent link">&para;</a></h4>
<ol>
<li>Theta edges are placed at <code>cutoff_theta</code>, <code>cutoff_theta + ÎÎ¸</code>,
   <code>cutoff_theta + 2ÎÎ¸</code>, â¦ up to Ï/2.</li>
<li>Phi edges are placed at 0, ÎÎ¸, 2ÎÎ¸, â¦ up to 2Ï.</li>
<li>Every (theta_band, phi_sector) combination produces one cell.  The
   cell centre is the midpoint of the rectangle.</li>
<li>No special zenith cap is created; the band nearest the zenith has
   the same number of phi sectors as all other bands.</li>
</ol>
<h4 id="canvod.grids.grids_impl.equirectangular_grid.EquirectangularBuilder--parameters">Parameters<a class="headerlink" href="#canvod.grids.grids_impl.equirectangular_grid.EquirectangularBuilder--parameters" title="Permanent link">&para;</a></h4>
<p>angular_resolution : float
    Angular spacing in degrees, applied identically in both theta and phi.
cutoff_theta : float
    Elevation mask angle in degrees.  Bands whose <em>inner</em> edge is at or
    below <code>Ï/2 â cutoff_theta</code> are omitted.
phi_rotation : float
    Rigid azimuthal rotation applied after construction, in degrees.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/grids_impl/equirectangular_grid.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">  9</span>
<span class="normal"> 10</span>
<span class="normal"> 11</span>
<span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">EquirectangularBuilder</span><span class="p">(</span><span class="n">BaseGridBuilder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Simple rectangular grid in (theta, phi) space.</span>

<span class="sd">    The hemisphere is divided into a regular rectangular array: a constant</span>
<span class="sd">    number of theta bands, each containing the same constant number of phi</span>
<span class="sd">    sectors.  Every cell is an identical rectangle in angular coordinates.</span>
<span class="sd">    This is *structurally* identical to ``EqualAngleBuilder`` except for one</span>
<span class="sd">    difference in the zenith treatment: ``EqualAngleBuilder`` collapses the</span>
<span class="sd">    first band into a single zenith cap, while this builder does not â every</span>
<span class="sd">    band has the same number of sectors.</span>

<span class="sd">    Because solid angle depends on cos(theta), cells near the zenith subtend</span>
<span class="sd">    *more* solid angle than cells near the horizon.  This makes the grid</span>
<span class="sd">    biased toward the zenith for any solid-angle-weighted statistic.</span>
<span class="sd">    **Not recommended for scientific analysis** â use ``EqualAreaBuilder``</span>
<span class="sd">    instead.</span>

<span class="sd">    Coordinate convention (physics / GNSS)</span>
<span class="sd">    ---------------------------------------</span>
<span class="sd">    * phi  â [0, 2Ï)  â azimuthal angle from East, counter-clockwise</span>
<span class="sd">    * theta â [0, Ï/2] â polar angle from zenith (0 = straight up,</span>
<span class="sd">      Ï/2 = horizon)</span>

<span class="sd">    What ``angular_resolution`` means</span>
<span class="sd">    ----------------------------------</span>
<span class="sd">    ``angular_resolution`` (degrees) is used as **both** the theta-band width</span>
<span class="sd">    *and* the phi-sector width.  The grid is therefore square in angular</span>
<span class="sd">    coordinates::</span>

<span class="sd">        n_theta = round((Ï/2 â cutoff) / ÎÎ¸)</span>
<span class="sd">        n_phi   = round(2Ï / ÎÎ¸)</span>
<span class="sd">        total cells = n_theta Ã n_phi</span>

<span class="sd">    Mathematical construction</span>
<span class="sd">    -------------------------</span>
<span class="sd">    1. Theta edges are placed at ``cutoff_theta``, ``cutoff_theta + ÎÎ¸``,</span>
<span class="sd">       ``cutoff_theta + 2ÎÎ¸``, â¦ up to Ï/2.</span>
<span class="sd">    2. Phi edges are placed at 0, ÎÎ¸, 2ÎÎ¸, â¦ up to 2Ï.</span>
<span class="sd">    3. Every (theta_band, phi_sector) combination produces one cell.  The</span>
<span class="sd">       cell centre is the midpoint of the rectangle.</span>
<span class="sd">    4. No special zenith cap is created; the band nearest the zenith has</span>
<span class="sd">       the same number of phi sectors as all other bands.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    angular_resolution : float</span>
<span class="sd">        Angular spacing in degrees, applied identically in both theta and phi.</span>
<span class="sd">    cutoff_theta : float</span>
<span class="sd">        Elevation mask angle in degrees.  Bands whose *inner* edge is at or</span>
<span class="sd">        below ``Ï/2 â cutoff_theta`` are omitted.</span>
<span class="sd">    phi_rotation : float</span>
<span class="sd">        Rigid azimuthal rotation applied after construction, in degrees.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_grid_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the grid-type identifier string.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            ``&quot;equirectangular&quot;``</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">GridType</span><span class="o">.</span><span class="n">EQUIRECTANGULAR</span><span class="o">.</span><span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_grid</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct the equirectangular hemisphere grid.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        grid : pl.DataFrame</span>
<span class="sd">            One row per cell with columns: phi, theta, phi_min, phi_max,</span>
<span class="sd">            theta_min, theta_max, cell_id.</span>
<span class="sd">        theta_lims : np.ndarray</span>
<span class="sd">            Inner theta edge of each band (radians).</span>
<span class="sd">        phi_lims : list[np.ndarray]</span>
<span class="sd">            Array of phi_min values for each band (identical across bands).</span>
<span class="sd">        cell_ids : list[np.ndarray]</span>
<span class="sd">            Cell-id arrays, one per band.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">max_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="n">theta_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cutoff_theta_rad</span><span class="p">,</span>
            <span class="n">max_theta</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">angular_resolution_rad</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">angular_resolution_rad</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">phi_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">angular_resolution_rad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">angular_resolution_rad</span>
        <span class="p">)</span>

        <span class="n">cells</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">theta_edges</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">theta_min</span><span class="p">,</span> <span class="n">theta_max</span> <span class="o">=</span> <span class="n">theta_edges</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">theta_edges</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">phi_edges</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">phi_min</span><span class="p">,</span> <span class="n">phi_max</span> <span class="o">=</span> <span class="n">phi_edges</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">phi_edges</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>

                <span class="n">cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;phi&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">phi_min</span> <span class="o">+</span> <span class="n">phi_max</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="s2">&quot;theta&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">theta_min</span> <span class="o">+</span> <span class="n">theta_max</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
                        <span class="s2">&quot;phi_min&quot;</span><span class="p">:</span> <span class="n">phi_min</span><span class="p">,</span>
                        <span class="s2">&quot;phi_max&quot;</span><span class="p">:</span> <span class="nb">min</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">phi_max</span><span class="p">),</span>
                        <span class="s2">&quot;theta_min&quot;</span><span class="p">:</span> <span class="n">theta_min</span><span class="p">,</span>
                        <span class="s2">&quot;theta_max&quot;</span><span class="p">:</span> <span class="n">theta_max</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>

        <span class="n">grid</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span><span class="o">.</span><span class="n">with_columns</span><span class="p">(</span>
            <span class="n">pl</span><span class="o">.</span><span class="n">int_range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pl</span><span class="o">.</span><span class="n">len</span><span class="p">())</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;cell_id&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">theta_lims</span> <span class="o">=</span> <span class="n">theta_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">phi_lims</span> <span class="o">=</span> <span class="p">[</span><span class="n">phi_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">theta_edges</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="n">cell_ids_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">phi_edges</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">phi_edges</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">theta_edges</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">return</span> <span class="n">grid</span><span class="p">,</span> <span class="n">theta_lims</span><span class="p">,</span> <span class="n">phi_lims</span><span class="p">,</span> <span class="n">cell_ids_list</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="canvod.grids.grids_impl.equirectangular_grid.EquirectangularBuilder.get_grid_type" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_grid_type</span><span class="p">()</span></code>

<a href="#canvod.grids.grids_impl.equirectangular_grid.EquirectangularBuilder.get_grid_type" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Return the grid-type identifier string.</p>
<h5 id="canvod.grids.grids_impl.equirectangular_grid.EquirectangularBuilder.get_grid_type--returns">Returns<a class="headerlink" href="#canvod.grids.grids_impl.equirectangular_grid.EquirectangularBuilder.get_grid_type--returns" title="Permanent link">&para;</a></h5>
<p>str
    <code>"equirectangular"</code></p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/grids_impl/equirectangular_grid.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_grid_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the grid-type identifier string.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        ``&quot;equirectangular&quot;``</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">GridType</span><span class="o">.</span><span class="n">EQUIRECTANGULAR</span><span class="o">.</span><span class="n">value</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div><h2 id="grid-operations">Grid Operations<a class="headerlink" href="#grid-operations" title="Permanent link">&para;</a></h2>


<div class="doc doc-object doc-module">



<a id="canvod.grids.operations"></a>
    <div class="doc doc-contents first">

        <p>Cell assignment and vertex extraction for hemisphere grids.</p>
<p>Functions in this module operate on :class:<code>~canvod.grids.core.GridData</code>
instances and VOD xarray Datasets.</p>
<h3 id="canvod.grids.operations--cell-assignment">Cell assignment<a class="headerlink" href="#canvod.grids.operations--cell-assignment" title="Permanent link">&para;</a></h3>
<p><code>add_cell_ids_to_vod_fast</code>   â vectorised KDTree lookup (preferred)
<code>add_cell_ids_to_vod</code>        â element-wise fallback
<code>add_cell_ids_to_ds_fast</code>    â dask-lazy variant for out-of-core data</p>
<h3 id="canvod.grids.operations--vertex-grid-conversion">Vertex / grid conversion<a class="headerlink" href="#canvod.grids.operations--vertex-grid-conversion" title="Permanent link">&para;</a></h3>
<p><code>extract_grid_vertices</code>      â flat (x, y, z) arrays for 3-D visualisation
<code>grid_to_dataset</code>            â xarray Dataset with vertices and solid angles</p>










<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h2 id="canvod.grids.operations.add_cell_ids_to_vod_fast" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_cell_ids_to_vod_fast</span><span class="p">(</span><span class="n">vod_ds</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">grid_name</span><span class="p">)</span></code>

<a href="#canvod.grids.operations.add_cell_ids_to_vod_fast" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Assign grid cells to every observation in a VOD dataset (vectorised).</p>
<p>Uses a KDTree built from the grid cell centres for O(n log m) lookup.</p>
<h4 id="canvod.grids.operations.add_cell_ids_to_vod_fast--parameters">Parameters<a class="headerlink" href="#canvod.grids.operations.add_cell_ids_to_vod_fast--parameters" title="Permanent link">&para;</a></h4>
<p>vod_ds : xr.Dataset
    VOD dataset with <code>phi(epoch, sid)</code> and <code>theta(epoch, sid)</code>
    coordinate variables and a <code>VOD</code> data variable.
grid : GridData
    Hemisphere grid instance.
grid_name : str
    Grid identifier used to name the output coordinate
    (<code>cell_id_&lt;grid_name&gt;</code>).</p>
<h4 id="canvod.grids.operations.add_cell_ids_to_vod_fast--returns">Returns<a class="headerlink" href="#canvod.grids.operations.add_cell_ids_to_vod_fast--returns" title="Permanent link">&para;</a></h4>
<p>xr.Dataset
    <em>vod_ds</em> with an additional <code>cell_id_&lt;grid_name&gt;(epoch, sid)</code>
    variable.  Observations with non-finite Ï or Î¸ receive NaN.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/operations.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_cell_ids_to_vod_fast</span><span class="p">(</span>
    <span class="n">vod_ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">grid</span><span class="p">:</span> <span class="n">GridData</span><span class="p">,</span> <span class="n">grid_name</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Assign grid cells to every observation in a VOD dataset (vectorised).</span>

<span class="sd">    Uses a KDTree built from the grid cell centres for O(n log m) lookup.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vod_ds : xr.Dataset</span>
<span class="sd">        VOD dataset with ``phi(epoch, sid)`` and ``theta(epoch, sid)``</span>
<span class="sd">        coordinate variables and a ``VOD`` data variable.</span>
<span class="sd">    grid : GridData</span>
<span class="sd">        Hemisphere grid instance.</span>
<span class="sd">    grid_name : str</span>
<span class="sd">        Grid identifier used to name the output coordinate</span>
<span class="sd">        (``cell_id_&lt;grid_name&gt;``).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xr.Dataset</span>
<span class="sd">        *vod_ds* with an additional ``cell_id_&lt;grid_name&gt;(epoch, sid)``</span>
<span class="sd">        variable.  Observations with non-finite Ï or Î¸ receive NaN.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Assigning cells for &#39;</span><span class="si">{</span><span class="n">grid_name</span><span class="si">}</span><span class="s2">&#39;...&quot;</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;cell_assignment_started&quot;</span><span class="p">,</span>
        <span class="n">grid_name</span><span class="o">=</span><span class="n">grid_name</span><span class="p">,</span>
        <span class="n">grid_cells</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">grid</span><span class="p">),</span>
        <span class="n">observations</span><span class="o">=</span><span class="n">vod_ds</span><span class="p">[</span><span class="s2">&quot;VOD&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="s2">&quot;kdtree_fast&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">tree</span> <span class="o">=</span> <span class="n">_build_kdtree</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
    <span class="n">cell_id_col</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s2">&quot;cell_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="n">phi</span> <span class="o">=</span> <span class="n">vod_ds</span><span class="p">[</span><span class="s2">&quot;phi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">vod_ds</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="n">valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>

    <span class="n">cell_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">valid</span><span class="p">):</span>
        <span class="n">cell_ids</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span> <span class="o">=</span> <span class="n">_query_points</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="n">cell_id_col</span><span class="p">,</span> <span class="n">phi</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span> <span class="n">theta</span><span class="p">[</span><span class="n">valid</span><span class="p">])</span>

    <span class="n">cell_ids_2d</span> <span class="o">=</span> <span class="n">cell_ids</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">vod_ds</span><span class="p">[</span><span class="s2">&quot;VOD&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">coord_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;cell_id_</span><span class="si">{</span><span class="n">grid_name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">vod_ds</span><span class="p">[</span><span class="n">coord_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="s2">&quot;sid&quot;</span><span class="p">),</span> <span class="n">cell_ids_2d</span><span class="p">)</span>

    <span class="n">n_assigned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cell_ids_2d</span><span class="p">))</span>
    <span class="n">n_unique</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">cell_ids</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cell_ids</span><span class="p">)]))</span>
    <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  â Assigned: </span><span class="si">{</span><span class="n">n_assigned</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">cell_ids_2d</span><span class="o">.</span><span class="n">size</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> observations&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  â Unique cells: </span><span class="si">{</span><span class="n">n_unique</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;cell_assignment_complete&quot;</span><span class="p">,</span>
        <span class="n">grid_name</span><span class="o">=</span><span class="n">grid_name</span><span class="p">,</span>
        <span class="n">duration_seconds</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">duration</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="n">observations_assigned</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">n_assigned</span><span class="p">),</span>
        <span class="n">observations_total</span><span class="o">=</span><span class="n">cell_ids_2d</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
        <span class="n">unique_cells</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">n_unique</span><span class="p">),</span>
        <span class="n">coverage_percent</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">n_assigned</span> <span class="o">/</span> <span class="n">cell_ids_2d</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">vod_ds</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="canvod.grids.operations.add_cell_ids_to_vod" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_cell_ids_to_vod</span><span class="p">(</span><span class="n">vod_ds</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">grid_name</span><span class="p">)</span></code>

<a href="#canvod.grids.operations.add_cell_ids_to_vod" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Assign grid cells to a VOD dataset (element-wise fallback).</p>
<p>Slower than :func:<code>add_cell_ids_to_vod_fast</code>; kept for cases where the
full dataset does not fit in memory as numpy arrays.</p>
<h4 id="canvod.grids.operations.add_cell_ids_to_vod--parameters">Parameters<a class="headerlink" href="#canvod.grids.operations.add_cell_ids_to_vod--parameters" title="Permanent link">&para;</a></h4>
<p>vod_ds : xr.Dataset
    VOD dataset with <code>phi</code>, <code>theta</code>, and <code>VOD</code> variables.
grid : GridData
    Hemisphere grid instance.
grid_name : str
    Grid identifier for the output coordinate name.</p>
<h4 id="canvod.grids.operations.add_cell_ids_to_vod--returns">Returns<a class="headerlink" href="#canvod.grids.operations.add_cell_ids_to_vod--returns" title="Permanent link">&para;</a></h4>
<p>xr.Dataset
    <em>vod_ds</em> with <code>cell_id_&lt;grid_name&gt;(epoch, sid)</code> added.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/operations.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_cell_ids_to_vod</span><span class="p">(</span>
    <span class="n">vod_ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">grid</span><span class="p">:</span> <span class="n">GridData</span><span class="p">,</span> <span class="n">grid_name</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Assign grid cells to a VOD dataset (element-wise fallback).</span>

<span class="sd">    Slower than :func:`add_cell_ids_to_vod_fast`; kept for cases where the</span>
<span class="sd">    full dataset does not fit in memory as numpy arrays.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vod_ds : xr.Dataset</span>
<span class="sd">        VOD dataset with ``phi``, ``theta``, and ``VOD`` variables.</span>
<span class="sd">    grid : GridData</span>
<span class="sd">        Hemisphere grid instance.</span>
<span class="sd">    grid_name : str</span>
<span class="sd">        Grid identifier for the output coordinate name.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xr.Dataset</span>
<span class="sd">        *vod_ds* with ``cell_id_&lt;grid_name&gt;(epoch, sid)`` added.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Assigning cells for &#39;</span><span class="si">{</span><span class="n">grid_name</span><span class="si">}</span><span class="s2">&#39;...&quot;</span><span class="p">)</span>

    <span class="n">tree</span> <span class="o">=</span> <span class="n">_build_kdtree</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
    <span class="n">cell_id_col</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s2">&quot;cell_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="n">phi_flat</span> <span class="o">=</span> <span class="n">vod_ds</span><span class="p">[</span><span class="s2">&quot;phi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">theta_flat</span> <span class="o">=</span> <span class="n">vod_ds</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="n">cell_ids_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">vod_ds</span><span class="p">[</span><span class="s2">&quot;VOD&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">phi_flat</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">phi_flat</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">theta_flat</span><span class="p">[</span><span class="n">i</span><span class="p">]):</span>
            <span class="n">cell_ids_flat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">_query_points</span><span class="p">(</span>
                <span class="n">tree</span><span class="p">,</span> <span class="n">cell_id_col</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">phi_flat</span><span class="p">[</span><span class="n">i</span><span class="p">]]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">theta_flat</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
            <span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">cell_ids_2d</span> <span class="o">=</span> <span class="n">cell_ids_flat</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">vod_ds</span><span class="p">[</span><span class="s2">&quot;VOD&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">coord_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;cell_id_</span><span class="si">{</span><span class="n">grid_name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">vod_ds</span><span class="p">[</span><span class="n">coord_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="s2">&quot;sid&quot;</span><span class="p">),</span> <span class="n">cell_ids_2d</span><span class="p">)</span>

    <span class="n">n_assigned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">cell_ids_2d</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  â Added coordinate &#39;</span><span class="si">{</span><span class="n">coord_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  â Assigned: </span><span class="si">{</span><span class="n">n_assigned</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">cell_ids_2d</span><span class="o">.</span><span class="n">size</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> observations&quot;</span><span class="p">)</span>

    <span class="c1"># Track grid references in dataset attrs</span>
    <span class="k">if</span> <span class="s2">&quot;grid_references&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vod_ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
        <span class="n">vod_ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;grid_references&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">vod_ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;grid_references&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;grids/</span><span class="si">{</span><span class="n">grid_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">vod_ds</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="canvod.grids.operations.add_cell_ids_to_ds_fast" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_cell_ids_to_ds_fast</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">grid_name</span><span class="p">,</span> <span class="n">data_var</span><span class="o">=</span><span class="s1">&#39;VOD&#39;</span><span class="p">)</span></code>

<a href="#canvod.grids.operations.add_cell_ids_to_ds_fast" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Assign grid cells lazily via dask (avoids loading full arrays).</p>
<p>The output <code>cell_id_&lt;grid_name&gt;</code> variable is a dask array that
computes on access or save.</p>
<h4 id="canvod.grids.operations.add_cell_ids_to_ds_fast--parameters">Parameters<a class="headerlink" href="#canvod.grids.operations.add_cell_ids_to_ds_fast--parameters" title="Permanent link">&para;</a></h4>
<p>ds : xr.Dataset
    Dataset with dask-backed <code>phi</code> and <code>theta</code> arrays.
grid : GridData
    Hemisphere grid instance.
grid_name : str
    Grid identifier for the output coordinate name.
data_var : str
    Name of the main data variable (used only for shape reference).</p>
<h4 id="canvod.grids.operations.add_cell_ids_to_ds_fast--returns">Returns<a class="headerlink" href="#canvod.grids.operations.add_cell_ids_to_ds_fast--returns" title="Permanent link">&para;</a></h4>
<p>xr.Dataset
    <em>ds</em> with a lazy <code>cell_id_&lt;grid_name&gt;(epoch, sid)</code> variable.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/operations.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_cell_ids_to_ds_fast</span><span class="p">(</span>
    <span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">grid</span><span class="p">:</span> <span class="n">GridData</span><span class="p">,</span> <span class="n">grid_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">data_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;VOD&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Assign grid cells lazily via dask (avoids loading full arrays).</span>

<span class="sd">    The output ``cell_id_&lt;grid_name&gt;`` variable is a dask array that</span>
<span class="sd">    computes on access or save.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ds : xr.Dataset</span>
<span class="sd">        Dataset with dask-backed ``phi`` and ``theta`` arrays.</span>
<span class="sd">    grid : GridData</span>
<span class="sd">        Hemisphere grid instance.</span>
<span class="sd">    grid_name : str</span>
<span class="sd">        Grid identifier for the output coordinate name.</span>
<span class="sd">    data_var : str</span>
<span class="sd">        Name of the main data variable (used only for shape reference).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xr.Dataset</span>
<span class="sd">        *ds* with a lazy ``cell_id_&lt;grid_name&gt;(epoch, sid)`` variable.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">dask.array</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">da</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Assigning cells for &#39;</span><span class="si">{</span><span class="n">grid_name</span><span class="si">}</span><span class="s2">&#39;...&quot;</span><span class="p">)</span>

    <span class="n">tree</span> <span class="o">=</span> <span class="n">_build_kdtree</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
    <span class="n">cell_id_col</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s2">&quot;cell_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_assign_chunk</span><span class="p">(</span>
        <span class="n">phi_chunk</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">theta_chunk</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assign cell IDs for a chunk of data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        phi_chunk : np.ndarray</span>
<span class="sd">            Chunk of azimuth values.</span>
<span class="sd">        theta_chunk : np.ndarray</span>
<span class="sd">            Chunk of elevation values.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Chunk of cell IDs.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">phi_flat</span> <span class="o">=</span> <span class="n">phi_chunk</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">theta_flat</span> <span class="o">=</span> <span class="n">theta_chunk</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="n">valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">phi_flat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">theta_flat</span><span class="p">)</span>
        <span class="n">cell_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">phi_flat</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">valid</span><span class="p">):</span>
            <span class="n">cell_ids</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span> <span class="o">=</span> <span class="n">_query_points</span><span class="p">(</span>
                <span class="n">tree</span><span class="p">,</span> <span class="n">cell_id_col</span><span class="p">,</span> <span class="n">phi_flat</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span> <span class="n">theta_flat</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">cell_ids</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">phi_chunk</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">cell_ids_dask</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">map_blocks</span><span class="p">(</span>
        <span class="n">_assign_chunk</span><span class="p">,</span>
        <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;phi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
        <span class="n">ds</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span>
        <span class="n">drop_axis</span><span class="o">=</span><span class="p">[],</span>
    <span class="p">)</span>

    <span class="n">coord_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;cell_id_</span><span class="si">{</span><span class="n">grid_name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">ds</span><span class="p">[</span><span class="n">coord_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="s2">&quot;sid&quot;</span><span class="p">),</span> <span class="n">cell_ids_dask</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  â Cell IDs assigned as lazy dask array&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  â Will compute on access/save&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ds</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="canvod.grids.operations.extract_grid_vertices" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">extract_grid_vertices</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span></code>

<a href="#canvod.grids.operations.extract_grid_vertices" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Extract 3D vertices from hemisphere grid cells.</p>
<p>Dispatches to a grid-typeâspecific extractor.  The returned arrays are
flat (not per-cell); use them directly for 3-D scatter plots.</p>
<h4 id="canvod.grids.operations.extract_grid_vertices--parameters">Parameters<a class="headerlink" href="#canvod.grids.operations.extract_grid_vertices--parameters" title="Permanent link">&para;</a></h4>
<p>grid : GridData
    Hemisphere grid instance.</p>
<h4 id="canvod.grids.operations.extract_grid_vertices--returns">Returns<a class="headerlink" href="#canvod.grids.operations.extract_grid_vertices--returns" title="Permanent link">&para;</a></h4>
<p>x_vertices, y_vertices, z_vertices : np.ndarray
    Cartesian vertex coordinates on the unit sphere.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/operations.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">extract_grid_vertices</span><span class="p">(</span><span class="n">grid</span><span class="p">:</span> <span class="n">GridData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extract 3D vertices from hemisphere grid cells.</span>

<span class="sd">    Dispatches to a grid-typeâspecific extractor.  The returned arrays are</span>
<span class="sd">    flat (not per-cell); use them directly for 3-D scatter plots.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    grid : GridData</span>
<span class="sd">        Hemisphere grid instance.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    x_vertices, y_vertices, z_vertices : np.ndarray</span>
<span class="sd">        Cartesian vertex coordinates on the unit sphere.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">extractors</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;htm&quot;</span><span class="p">:</span> <span class="n">_extract_htm_vertices</span><span class="p">,</span>
        <span class="s2">&quot;geodesic&quot;</span><span class="p">:</span> <span class="n">_extract_geodesic_vertices</span><span class="p">,</span>
        <span class="s2">&quot;equal_area&quot;</span><span class="p">:</span> <span class="n">_extract_rectangular_vertices</span><span class="p">,</span>
        <span class="s2">&quot;equal_angle&quot;</span><span class="p">:</span> <span class="n">_extract_rectangular_vertices</span><span class="p">,</span>
        <span class="s2">&quot;equirectangular&quot;</span><span class="p">:</span> <span class="n">_extract_rectangular_vertices</span><span class="p">,</span>
        <span class="s2">&quot;healpix&quot;</span><span class="p">:</span> <span class="n">_extract_healpix_vertices</span><span class="p">,</span>
        <span class="s2">&quot;fibonacci&quot;</span><span class="p">:</span> <span class="n">_extract_fibonacci_vertices</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">extractor</span> <span class="o">=</span> <span class="n">extractors</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">grid_type</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">extractor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown grid type: </span><span class="si">{</span><span class="n">grid</span><span class="o">.</span><span class="n">grid_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">extractor</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="canvod.grids.operations.grid_to_dataset" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">grid_to_dataset</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span></code>

<a href="#canvod.grids.operations.grid_to_dataset" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Convert a HemiGrid to a unified xarray Dataset with vertices.</p>
<p>The returned Dataset carries cell centres, NaN-padded vertex arrays,
vertex counts, and solid angles â all indexed by <code>cell_id</code>.</p>
<h4 id="canvod.grids.operations.grid_to_dataset--parameters">Parameters<a class="headerlink" href="#canvod.grids.operations.grid_to_dataset--parameters" title="Permanent link">&para;</a></h4>
<p>grid : GridData
    Hemisphere grid instance.</p>
<h4 id="canvod.grids.operations.grid_to_dataset--returns">Returns<a class="headerlink" href="#canvod.grids.operations.grid_to_dataset--returns" title="Permanent link">&para;</a></h4>
<p>xr.Dataset
    Dataset with dimensions <code>(cell_id, vertex)</code> and variables
    <code>cell_phi</code>, <code>cell_theta</code>, <code>vertices_phi</code>, <code>vertices_theta</code>,
    <code>n_vertices</code>, <code>solid_angle</code>.</p>
<h4 id="canvod.grids.operations.grid_to_dataset--notes">Notes<a class="headerlink" href="#canvod.grids.operations.grid_to_dataset--notes" title="Permanent link">&para;</a></h4>
<p>This function is distinct from
:meth:<code>HemiGridStorageAdapter._prepare_vertices_dataframe</code> in
<code>canvod-store</code>. That method produces a long-form DataFrame for zarr
ragged-array storage; this one produces a rectangular xarray Dataset
suitable for analysis and visualisation.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/operations.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">grid_to_dataset</span><span class="p">(</span><span class="n">grid</span><span class="p">:</span> <span class="n">GridData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a HemiGrid to a unified xarray Dataset with vertices.</span>

<span class="sd">    The returned Dataset carries cell centres, NaN-padded vertex arrays,</span>
<span class="sd">    vertex counts, and solid angles â all indexed by ``cell_id``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    grid : GridData</span>
<span class="sd">        Hemisphere grid instance.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xr.Dataset</span>
<span class="sd">        Dataset with dimensions ``(cell_id, vertex)`` and variables</span>
<span class="sd">        ``cell_phi``, ``cell_theta``, ``vertices_phi``, ``vertices_theta``,</span>
<span class="sd">        ``n_vertices``, ``solid_angle``.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    This function is distinct from</span>
<span class="sd">    :meth:`HemiGridStorageAdapter._prepare_vertices_dataframe` in</span>
<span class="sd">    ``canvod-store``. That method produces a long-form DataFrame for zarr</span>
<span class="sd">    ragged-array storage; this one produces a rectangular xarray Dataset</span>
<span class="sd">    suitable for analysis and visualisation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Reuse the commented-out logic pattern from gnssvodpy vertices.py:</span>
    <span class="c1"># extract per-cell vertices into (n_cells, max_vertices) arrays.</span>
    <span class="n">n_cells</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">ncells</span>
    <span class="n">grid_type</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">grid_type</span>

    <span class="k">if</span> <span class="n">grid_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;equal_area&quot;</span><span class="p">,</span> <span class="s2">&quot;equal_angle&quot;</span><span class="p">,</span> <span class="s2">&quot;equirectangular&quot;</span><span class="p">):</span>
        <span class="n">max_v</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">vertices_phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">max_v</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">vertices_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">max_v</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">n_vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">iter_rows</span><span class="p">(</span><span class="n">named</span><span class="o">=</span><span class="kc">True</span><span class="p">)):</span>
            <span class="n">phi_min</span><span class="p">,</span> <span class="n">phi_max</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;phi_min&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;phi_max&quot;</span><span class="p">]</span>
            <span class="n">theta_min</span><span class="p">,</span> <span class="n">theta_max</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;theta_min&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;theta_max&quot;</span><span class="p">]</span>
            <span class="n">vertices_phi</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">phi_min</span><span class="p">,</span> <span class="n">phi_max</span><span class="p">,</span> <span class="n">phi_max</span><span class="p">,</span> <span class="n">phi_min</span><span class="p">]</span>
            <span class="n">vertices_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">theta_min</span><span class="p">,</span> <span class="n">theta_min</span><span class="p">,</span> <span class="n">theta_max</span><span class="p">,</span> <span class="n">theta_max</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">grid_type</span> <span class="o">==</span> <span class="s2">&quot;htm&quot;</span><span class="p">:</span>
        <span class="n">max_v</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># padded to 4 for rectangular layout; only 3 used</span>
        <span class="n">vertices_phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">max_v</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">vertices_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">max_v</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">n_vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">iter_rows</span><span class="p">(</span><span class="n">named</span><span class="o">=</span><span class="kc">True</span><span class="p">)):</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s2">&quot;htm_vertex_0&quot;</span><span class="p">,</span> <span class="s2">&quot;htm_vertex_1&quot;</span><span class="p">,</span> <span class="s2">&quot;htm_vertex_2&quot;</span><span class="p">]):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">v</span> <span class="o">/</span> <span class="n">r</span>
                <span class="n">vertices_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">vertices_phi</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">grid_type</span> <span class="o">==</span> <span class="s2">&quot;geodesic&quot;</span><span class="p">:</span>
        <span class="n">max_v</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">vertices_phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">max_v</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">vertices_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">max_v</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">n_vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="n">shared</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">vertices</span>  <span class="c1"># shared vertex array from GridData</span>
        <span class="k">if</span> <span class="n">shared</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;geodesic_vertices&quot;</span> <span class="ow">in</span> <span class="n">grid</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">shared</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">shared</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">iter_rows</span><span class="p">(</span><span class="n">named</span><span class="o">=</span><span class="kc">True</span><span class="p">)):</span>
                <span class="n">indices</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;geodesic_vertices&quot;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">v_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">shared</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">v_idx</span><span class="p">)]</span>
                    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">v</span> <span class="o">/</span> <span class="n">r</span>
                    <span class="n">vertices_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                    <span class="n">vertices_phi</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Fallback: use cell centres as single-point &quot;vertices&quot;</span>
            <span class="n">n_vertices</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">vertices_phi</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s2">&quot;phi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">vertices_theta</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">grid_type</span> <span class="o">==</span> <span class="s2">&quot;healpix&quot;</span><span class="p">:</span>
        <span class="n">max_v</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">vertices_phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">max_v</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">vertices_theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">max_v</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">n_vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">iter_rows</span><span class="p">(</span><span class="n">named</span><span class="o">=</span><span class="kc">True</span><span class="p">)):</span>
            <span class="n">phi_min</span><span class="p">,</span> <span class="n">phi_max</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;phi_min&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;phi_max&quot;</span><span class="p">]</span>
            <span class="n">theta_min</span><span class="p">,</span> <span class="n">theta_max</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;theta_min&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;theta_max&quot;</span><span class="p">]</span>
            <span class="n">vertices_phi</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">phi_min</span><span class="p">,</span> <span class="n">phi_max</span><span class="p">,</span> <span class="n">phi_max</span><span class="p">,</span> <span class="n">phi_min</span><span class="p">]</span>
            <span class="n">vertices_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">theta_min</span><span class="p">,</span> <span class="n">theta_min</span><span class="p">,</span> <span class="n">theta_max</span><span class="p">,</span> <span class="n">theta_max</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">grid_type</span> <span class="o">==</span> <span class="s2">&quot;fibonacci&quot;</span><span class="p">:</span>
        <span class="c1"># Point-based: single vertex per cell (the centre)</span>
        <span class="n">max_v</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">vertices_phi</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s2">&quot;phi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">vertices_theta</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">n_vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown grid type: </span><span class="si">{</span><span class="n">grid_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Cell centres</span>
    <span class="n">cell_phi</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s2">&quot;phi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">cell_theta</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">grid</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">solid_angles</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">get_solid_angles</span><span class="p">()</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;cell_phi&quot;</span><span class="p">:</span> <span class="p">([</span><span class="s2">&quot;cell_id&quot;</span><span class="p">],</span> <span class="n">cell_phi</span><span class="p">),</span>
            <span class="s2">&quot;cell_theta&quot;</span><span class="p">:</span> <span class="p">([</span><span class="s2">&quot;cell_id&quot;</span><span class="p">],</span> <span class="n">cell_theta</span><span class="p">),</span>
            <span class="s2">&quot;vertices_phi&quot;</span><span class="p">:</span> <span class="p">([</span><span class="s2">&quot;cell_id&quot;</span><span class="p">,</span> <span class="s2">&quot;vertex&quot;</span><span class="p">],</span> <span class="n">vertices_phi</span><span class="p">),</span>
            <span class="s2">&quot;vertices_theta&quot;</span><span class="p">:</span> <span class="p">([</span><span class="s2">&quot;cell_id&quot;</span><span class="p">,</span> <span class="s2">&quot;vertex&quot;</span><span class="p">],</span> <span class="n">vertices_theta</span><span class="p">),</span>
            <span class="s2">&quot;n_vertices&quot;</span><span class="p">:</span> <span class="p">([</span><span class="s2">&quot;cell_id&quot;</span><span class="p">],</span> <span class="n">n_vertices</span><span class="p">),</span>
            <span class="s2">&quot;solid_angle&quot;</span><span class="p">:</span> <span class="p">([</span><span class="s2">&quot;cell_id&quot;</span><span class="p">],</span> <span class="n">solid_angles</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="n">coords</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;cell_id&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_cells</span><span class="p">),</span>
            <span class="s2">&quot;vertex&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">max_v</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="n">attrs</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;grid_type&quot;</span><span class="p">:</span> <span class="n">grid</span><span class="o">.</span><span class="n">grid_type</span><span class="p">,</span>
            <span class="s2">&quot;angular_resolution&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">grid</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;angular_resolution&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">metadata</span> <span class="k">else</span> <span class="mf">0.0</span>
            <span class="p">),</span>
            <span class="s2">&quot;cutoff_theta&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">grid</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cutoff_theta&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span> <span class="k">if</span> <span class="n">grid</span><span class="o">.</span><span class="n">metadata</span> <span class="k">else</span> <span class="mf">0.0</span>
            <span class="p">),</span>
            <span class="s2">&quot;n_cells&quot;</span><span class="p">:</span> <span class="n">n_cells</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">ds</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="canvod.grids.operations.store_grid" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">store_grid</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">store</span><span class="p">,</span> <span class="n">grid_name</span><span class="p">)</span></code>

<a href="#canvod.grids.operations.store_grid" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Store grid in unified xarray format to Icechunk store.</p>
<p>Converts the grid to an xarray Dataset with vertex information
and writes it to the <code>grids/</code> group in the store.</p>
<h4 id="canvod.grids.operations.store_grid--parameters">Parameters<a class="headerlink" href="#canvod.grids.operations.store_grid--parameters" title="Permanent link">&para;</a></h4>
<p>grid : GridData
    Hemisphere grid instance to store.
store
    Icechunk store instance (e.g., MyIcechunkStore).
grid_name : str
    Grid identifier for storage path (e.g., 'equal_area_4deg').</p>
<h4 id="canvod.grids.operations.store_grid--returns">Returns<a class="headerlink" href="#canvod.grids.operations.store_grid--returns" title="Permanent link">&para;</a></h4>
<p>str
    Snapshot ID from the commit.</p>
<h4 id="canvod.grids.operations.store_grid--examples">Examples<a class="headerlink" href="#canvod.grids.operations.store_grid--examples" title="Permanent link">&para;</a></h4>
<blockquote>
<blockquote>
<blockquote>
<p>from canvod.grids import create_hemigrid, store_grid
grid = create_hemigrid(angular_resolution=4, grid_type='equal_area')
snapshot_id = store_grid(grid, my_store, 'equal_area_4deg')</p>
</blockquote>
</blockquote>
</blockquote>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/operations.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">store_grid</span><span class="p">(</span>
    <span class="n">grid</span><span class="p">:</span> <span class="n">GridData</span><span class="p">,</span>
    <span class="n">store</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">grid_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Store grid in unified xarray format to Icechunk store.</span>

<span class="sd">    Converts the grid to an xarray Dataset with vertex information</span>
<span class="sd">    and writes it to the ``grids/`` group in the store.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    grid : GridData</span>
<span class="sd">        Hemisphere grid instance to store.</span>
<span class="sd">    store</span>
<span class="sd">        Icechunk store instance (e.g., MyIcechunkStore).</span>
<span class="sd">    grid_name : str</span>
<span class="sd">        Grid identifier for storage path (e.g., &#39;equal_area_4deg&#39;).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Snapshot ID from the commit.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from canvod.grids import create_hemigrid, store_grid</span>
<span class="sd">    &gt;&gt;&gt; grid = create_hemigrid(angular_resolution=4, grid_type=&#39;equal_area&#39;)</span>
<span class="sd">    &gt;&gt;&gt; snapshot_id = store_grid(grid, my_store, &#39;equal_area_4deg&#39;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Storing grid &#39;</span><span class="si">{</span><span class="n">grid_name</span><span class="si">}</span><span class="s2">&#39;...&quot;</span><span class="p">)</span>

    <span class="c1"># Convert to unified xarray format</span>
    <span class="n">ds_grid</span> <span class="o">=</span> <span class="n">grid_to_dataset</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>

    <span class="c1"># Store in grids/ directory</span>
    <span class="n">group_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;grids/</span><span class="si">{</span><span class="n">grid_name</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">with</span> <span class="n">store</span><span class="o">.</span><span class="n">writable_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">icechunk.xarray</span><span class="w"> </span><span class="kn">import</span> <span class="n">to_icechunk</span>

        <span class="n">to_icechunk</span><span class="p">(</span><span class="n">ds_grid</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">snapshot_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Stored </span><span class="si">{</span><span class="n">grid_name</span><span class="si">}</span><span class="s2"> grid structure&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  â Stored to &#39;</span><span class="si">{</span><span class="n">group_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  â Snapshot: </span><span class="si">{</span><span class="n">snapshot_id</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  â Cells: </span><span class="si">{</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="si">}</span><span class="s2">, Type: </span><span class="si">{</span><span class="n">grid</span><span class="o">.</span><span class="n">grid_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">snapshot_id</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="canvod.grids.operations.load_grid" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load_grid</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">grid_name</span><span class="p">)</span></code>

<a href="#canvod.grids.operations.load_grid" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Load a grid from Icechunk store.</p>
<p>Loads the grid structure from <code>grids/{grid_name}</code> and reconstructs
a GridData object.</p>
<h4 id="canvod.grids.operations.load_grid--parameters">Parameters<a class="headerlink" href="#canvod.grids.operations.load_grid--parameters" title="Permanent link">&para;</a></h4>
<p>store
    Icechunk store instance (e.g., MyIcechunkStore).
grid_name : str
    Grid identifier (e.g., 'equal_area_4deg').</p>
<h4 id="canvod.grids.operations.load_grid--returns">Returns<a class="headerlink" href="#canvod.grids.operations.load_grid--returns" title="Permanent link">&para;</a></h4>
<p>GridData
    Reconstructed grid instance.</p>
<h4 id="canvod.grids.operations.load_grid--examples">Examples<a class="headerlink" href="#canvod.grids.operations.load_grid--examples" title="Permanent link">&para;</a></h4>
<blockquote>
<blockquote>
<blockquote>
<p>from canvod.grids import load_grid
grid = load_grid(my_store, 'equal_area_4deg')
print(f"Loaded {grid.ncells} cells")</p>
</blockquote>
</blockquote>
</blockquote>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/operations.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">load_grid</span><span class="p">(</span>
    <span class="n">store</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="n">grid_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GridData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Load a grid from Icechunk store.</span>

<span class="sd">    Loads the grid structure from ``grids/{grid_name}`` and reconstructs</span>
<span class="sd">    a GridData object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    store</span>
<span class="sd">        Icechunk store instance (e.g., MyIcechunkStore).</span>
<span class="sd">    grid_name : str</span>
<span class="sd">        Grid identifier (e.g., &#39;equal_area_4deg&#39;).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    GridData</span>
<span class="sd">        Reconstructed grid instance.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; from canvod.grids import load_grid</span>
<span class="sd">    &gt;&gt;&gt; grid = load_grid(my_store, &#39;equal_area_4deg&#39;)</span>
<span class="sd">    &gt;&gt;&gt; print(f&quot;Loaded {grid.ncells} cells&quot;)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Loading grid &#39;</span><span class="si">{</span><span class="n">grid_name</span><span class="si">}</span><span class="s2">&#39;...&quot;</span><span class="p">)</span>

    <span class="n">group_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;grids/</span><span class="si">{</span><span class="n">grid_name</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Load from store</span>
    <span class="k">with</span> <span class="n">store</span><span class="o">.</span><span class="n">readonly_session</span><span class="p">()</span> <span class="k">as</span> <span class="n">session</span><span class="p">:</span>
        <span class="n">ds_grid</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_zarr</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">store</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group_path</span><span class="p">,</span> <span class="n">consolidated</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Extract metadata</span>
    <span class="n">grid_type</span> <span class="o">=</span> <span class="n">ds_grid</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;grid_type&quot;</span><span class="p">)</span>
    <span class="n">angular_resolution</span> <span class="o">=</span> <span class="n">ds_grid</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;angular_resolution&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="n">cutoff_theta</span> <span class="o">=</span> <span class="n">ds_grid</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cutoff_theta&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">grid_type</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grid &#39;</span><span class="si">{</span><span class="n">grid_name</span><span class="si">}</span><span class="s2">&#39; missing grid_type attribute&quot;</span><span class="p">)</span>

    <span class="c1"># Reconstruct grid DataFrame from cell centers</span>
    <span class="n">cell_phi</span> <span class="o">=</span> <span class="n">ds_grid</span><span class="p">[</span><span class="s2">&quot;cell_phi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">cell_theta</span> <span class="o">=</span> <span class="n">ds_grid</span><span class="p">[</span><span class="s2">&quot;cell_theta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">n_cells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell_phi</span><span class="p">)</span>

    <span class="c1"># Build basic grid DataFrame</span>
    <span class="n">grid_data</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;cell_id&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_cells</span><span class="p">),</span>
        <span class="s2">&quot;phi&quot;</span><span class="p">:</span> <span class="n">cell_phi</span><span class="p">,</span>
        <span class="s2">&quot;theta&quot;</span><span class="p">:</span> <span class="n">cell_theta</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># Add grid-type-specific columns</span>
    <span class="k">if</span> <span class="n">grid_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;equal_area&quot;</span><span class="p">,</span> <span class="s2">&quot;equal_angle&quot;</span><span class="p">,</span> <span class="s2">&quot;equirectangular&quot;</span><span class="p">):</span>
        <span class="c1"># Reconstruct boundaries from vertices</span>
        <span class="n">vertices_phi</span> <span class="o">=</span> <span class="n">ds_grid</span><span class="p">[</span><span class="s2">&quot;vertices_phi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">vertices_theta</span> <span class="o">=</span> <span class="n">ds_grid</span><span class="p">[</span><span class="s2">&quot;vertices_theta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">phi_min</span> <span class="o">=</span> <span class="n">vertices_phi</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>  <span class="c1"># All 4 vertices are corners</span>
        <span class="n">phi_max</span> <span class="o">=</span> <span class="n">vertices_phi</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">theta_min</span> <span class="o">=</span> <span class="n">vertices_theta</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">theta_max</span> <span class="o">=</span> <span class="n">vertices_theta</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span>

        <span class="n">grid_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;phi_min&quot;</span><span class="p">:</span> <span class="n">phi_min</span><span class="p">,</span>
                <span class="s2">&quot;phi_max&quot;</span><span class="p">:</span> <span class="n">phi_max</span><span class="p">,</span>
                <span class="s2">&quot;theta_min&quot;</span><span class="p">:</span> <span class="n">theta_min</span><span class="p">,</span>
                <span class="s2">&quot;theta_max&quot;</span><span class="p">:</span> <span class="n">theta_max</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="k">elif</span> <span class="n">grid_type</span> <span class="o">==</span> <span class="s2">&quot;htm&quot;</span><span class="p">:</span>
        <span class="c1"># Reconstruct HTM vertices from spherical to Cartesian</span>
        <span class="n">vertices_phi</span> <span class="o">=</span> <span class="n">ds_grid</span><span class="p">[</span><span class="s2">&quot;vertices_phi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">vertices_theta</span> <span class="o">=</span> <span class="n">ds_grid</span><span class="p">[</span><span class="s2">&quot;vertices_theta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">htm_v0</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">htm_v1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">htm_v2</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cells</span><span class="p">):</span>
            <span class="n">vertices</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">phi_v</span> <span class="o">=</span> <span class="n">vertices_phi</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">theta_v</span> <span class="o">=</span> <span class="n">vertices_theta</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_v</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi_v</span><span class="p">)</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta_v</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi_v</span><span class="p">)</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_v</span><span class="p">)</span>
                <span class="n">vertices</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span>

            <span class="n">htm_v0</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vertices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">htm_v1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vertices</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">htm_v2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">vertices</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">grid_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;htm_vertex_0&quot;</span><span class="p">:</span> <span class="n">htm_v0</span><span class="p">,</span>
                <span class="s2">&quot;htm_vertex_1&quot;</span><span class="p">:</span> <span class="n">htm_v1</span><span class="p">,</span>
                <span class="s2">&quot;htm_vertex_2&quot;</span><span class="p">:</span> <span class="n">htm_v2</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="c1"># Create Polars DataFrame</span>
    <span class="n">df_grid</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">grid_data</span><span class="p">)</span>

    <span class="c1"># Reconstruct theta_lims, phi_lims, and cell_ids from grid</span>
    <span class="c1"># These are required for GridData but not critical for basic usage</span>
    <span class="n">unique_theta</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df_grid</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
    <span class="n">theta_lims</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">unique_theta</span><span class="p">)</span>

    <span class="c1"># Group cells by theta bin</span>
    <span class="n">phi_lims_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cell_ids_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">theta_val</span> <span class="ow">in</span> <span class="n">unique_theta</span><span class="p">:</span>
        <span class="n">theta_cells</span> <span class="o">=</span> <span class="n">df_grid</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;theta&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">theta_val</span><span class="p">)</span>
        <span class="n">phi_vals</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">theta_cells</span><span class="p">[</span><span class="s2">&quot;phi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
        <span class="n">cell_ids</span> <span class="o">=</span> <span class="n">theta_cells</span><span class="p">[</span><span class="s2">&quot;cell_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

        <span class="n">phi_lims_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">phi_vals</span><span class="p">))</span>
        <span class="n">cell_ids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cell_ids</span><span class="p">))</span>

    <span class="c1"># Create GridData instance</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">canvod.grids.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">GridData</span>

    <span class="n">grid</span> <span class="o">=</span> <span class="n">GridData</span><span class="p">(</span>
        <span class="n">grid</span><span class="o">=</span><span class="n">df_grid</span><span class="p">,</span>
        <span class="n">theta_lims</span><span class="o">=</span><span class="n">theta_lims</span><span class="p">,</span>
        <span class="n">phi_lims</span><span class="o">=</span><span class="n">phi_lims_list</span><span class="p">,</span>
        <span class="n">cell_ids</span><span class="o">=</span><span class="n">cell_ids_list</span><span class="p">,</span>
        <span class="n">grid_type</span><span class="o">=</span><span class="n">grid_type</span><span class="p">,</span>
        <span class="n">metadata</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;angular_resolution&quot;</span><span class="p">:</span> <span class="n">angular_resolution</span><span class="p">,</span>
            <span class="s2">&quot;cutoff_theta&quot;</span><span class="p">:</span> <span class="n">cutoff_theta</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  â Loaded from &#39;</span><span class="si">{</span><span class="n">group_path</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  â Cells: </span><span class="si">{</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="si">}</span><span class="s2">, Type: </span><span class="si">{</span><span class="n">grid</span><span class="o">.</span><span class="n">grid_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">grid</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h2 id="aggregation">Aggregation<a class="headerlink" href="#aggregation" title="Permanent link">&para;</a></h2>


<div class="doc doc-object doc-module">



<a id="canvod.grids.aggregation"></a>
    <div class="doc doc-contents first">

        <p>Per-cell aggregation of VOD observations onto hemisphere grids.</p>
<h3 id="canvod.grids.aggregation--top-level-entry-points">Top-level entry points<a class="headerlink" href="#canvod.grids.aggregation--top-level-entry-points" title="Permanent link">&para;</a></h3>
<p><code>aggregate_data_to_grid</code>       â single-statistic spatial aggregation
<code>compute_percell_timeseries</code>   â chunked (cell Ã time) time-series</p>
<h3 id="canvod.grids.aggregation--analysis-helpers">Analysis helpers<a class="headerlink" href="#canvod.grids.aggregation--analysis-helpers" title="Permanent link">&para;</a></h3>
<p><code>compute_global_average</code>       â observation-countâweighted global mean
<code>compute_regional_average</code>     â same, restricted to a cell subset
<code>analyze_diurnal_patterns</code>     â hourly groupby
<code>analyze_spatial_patterns</code>     â time-averaged spatial field</p>
<h3 id="canvod.grids.aggregation--convenience-wrappers">Convenience wrappers<a class="headerlink" href="#canvod.grids.aggregation--convenience-wrappers" title="Permanent link">&para;</a></h3>
<p><code>compute_hemisphere_percell</code>   â daily, full hemisphere
<code>compute_zenith_percell</code>       â daily, Î¸ â¤ 30Â°</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="canvod.grids.aggregation.CellAggregator" class="doc doc-heading">
            <code>CellAggregator</code>


<a href="#canvod.grids.aggregation.CellAggregator" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">



        <p>Polars-based per-cell aggregation helpers.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/aggregation.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CellAggregator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Polars-based per-cell aggregation helpers.&quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">aggregate_by_cell</span><span class="p">(</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">value_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;VOD&quot;</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregate values by ``cell_id``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df : pl.DataFrame</span>
<span class="sd">            Must contain ``cell_id`` and *value_var* columns.</span>
<span class="sd">        value_var : str</span>
<span class="sd">            Column to aggregate.</span>
<span class="sd">        method : {&#39;mean&#39;, &#39;median&#39;, &#39;std&#39;, &#39;count&#39;}</span>
<span class="sd">            Aggregation method.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pl.DataFrame</span>
<span class="sd">            Two-column DataFrame: ``cell_id``, *value_var*.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;cell_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;pl.DataFrame must have &#39;cell_id&#39; column&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">value_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pl.DataFrame must have &#39;</span><span class="si">{</span><span class="n">value_var</span><span class="si">}</span><span class="s2">&#39; column&quot;</span><span class="p">)</span>

        <span class="n">agg_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">value_var</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
            <span class="s2">&quot;median&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">value_var</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span>
            <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">value_var</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
            <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">value_var</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">agg_map</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown method: </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;cell_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">agg_map</span><span class="p">[</span><span class="n">method</span><span class="p">]</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">value_var</span><span class="p">))</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;cell_id&quot;</span><span class="p">)</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="canvod.grids.aggregation.CellAggregator.aggregate_by_cell" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">aggregate_by_cell</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">value_var</span><span class="o">=</span><span class="s1">&#39;VOD&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-staticmethod"><code>staticmethod</code></small>
  </span>

<a href="#canvod.grids.aggregation.CellAggregator.aggregate_by_cell" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Aggregate values by <code>cell_id</code>.</p>
<h5 id="canvod.grids.aggregation.CellAggregator.aggregate_by_cell--parameters">Parameters<a class="headerlink" href="#canvod.grids.aggregation.CellAggregator.aggregate_by_cell--parameters" title="Permanent link">&para;</a></h5>
<p>df : pl.DataFrame
    Must contain <code>cell_id</code> and <em>value_var</em> columns.
value_var : str
    Column to aggregate.
method : {'mean', 'median', 'std', 'count'}
    Aggregation method.</p>
<h5 id="canvod.grids.aggregation.CellAggregator.aggregate_by_cell--returns">Returns<a class="headerlink" href="#canvod.grids.aggregation.CellAggregator.aggregate_by_cell--returns" title="Permanent link">&para;</a></h5>
<p>pl.DataFrame
    Two-column DataFrame: <code>cell_id</code>, <em>value_var</em>.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/aggregation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@staticmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">aggregate_by_cell</span><span class="p">(</span>
    <span class="n">df</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
    <span class="n">value_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;VOD&quot;</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Aggregate values by ``cell_id``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pl.DataFrame</span>
<span class="sd">        Must contain ``cell_id`` and *value_var* columns.</span>
<span class="sd">    value_var : str</span>
<span class="sd">        Column to aggregate.</span>
<span class="sd">    method : {&#39;mean&#39;, &#39;median&#39;, &#39;std&#39;, &#39;count&#39;}</span>
<span class="sd">        Aggregation method.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pl.DataFrame</span>
<span class="sd">        Two-column DataFrame: ``cell_id``, *value_var*.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;cell_id&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;pl.DataFrame must have &#39;cell_id&#39; column&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">value_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;pl.DataFrame must have &#39;</span><span class="si">{</span><span class="n">value_var</span><span class="si">}</span><span class="s2">&#39; column&quot;</span><span class="p">)</span>

    <span class="n">agg_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">value_var</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="s2">&quot;median&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">value_var</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span>
        <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">value_var</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
        <span class="s2">&quot;count&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">value_var</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">agg_map</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown method: </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">df</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;cell_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">agg_map</span><span class="p">[</span><span class="n">method</span><span class="p">]</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">value_var</span><span class="p">))</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="s2">&quot;cell_id&quot;</span><span class="p">)</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="canvod.grids.aggregation.aggregate_data_to_grid" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">aggregate_data_to_grid</span><span class="p">(</span><span class="n">data_ds</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">value_var</span><span class="o">=</span><span class="s1">&#39;VOD&#39;</span><span class="p">,</span> <span class="n">cell_var</span><span class="o">=</span><span class="s1">&#39;cell_id_equal_area_2deg&#39;</span><span class="p">,</span> <span class="n">sid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)</span></code>

<a href="#canvod.grids.aggregation.aggregate_data_to_grid" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Aggregate VOD data across all timestamps and SIDs to per-cell statistics.</p>
<h4 id="canvod.grids.aggregation.aggregate_data_to_grid--parameters">Parameters<a class="headerlink" href="#canvod.grids.aggregation.aggregate_data_to_grid--parameters" title="Permanent link">&para;</a></h4>
<p>data_ds : xr.Dataset
    Full VOD dataset from the Icechunk store.
grid : GridData
    Grid definition.
value_var : str
    Name of the VOD variable.
cell_var : str
    Name of the cell-ID variable in <em>data_ds</em>.
sid : list[str], optional
    Satellite IDs to include.  <code>None</code> â all.
time_range : tuple, optional
    <code>(start, end)</code> datetimes for epoch filtering.
stat : {'mean', 'median', 'std'}
    Statistic to compute per cell.</p>
<h4 id="canvod.grids.aggregation.aggregate_data_to_grid--returns">Returns<a class="headerlink" href="#canvod.grids.aggregation.aggregate_data_to_grid--returns" title="Permanent link">&para;</a></h4>
<p>np.ndarray
    Array of length <code>grid.ncells</code> with per-cell aggregated values
    (NaN where no observations exist).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/aggregation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">aggregate_data_to_grid</span><span class="p">(</span>
    <span class="n">data_ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="n">grid</span><span class="p">:</span> <span class="n">GridData</span><span class="p">,</span>
    <span class="n">value_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;VOD&quot;</span><span class="p">,</span>
    <span class="n">cell_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_id_equal_area_2deg&quot;</span><span class="p">,</span>
    <span class="n">sid</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">time_range</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">stat</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;median&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Aggregate VOD data across all timestamps and SIDs to per-cell statistics.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_ds : xr.Dataset</span>
<span class="sd">        Full VOD dataset from the Icechunk store.</span>
<span class="sd">    grid : GridData</span>
<span class="sd">        Grid definition.</span>
<span class="sd">    value_var : str</span>
<span class="sd">        Name of the VOD variable.</span>
<span class="sd">    cell_var : str</span>
<span class="sd">        Name of the cell-ID variable in *data_ds*.</span>
<span class="sd">    sid : list[str], optional</span>
<span class="sd">        Satellite IDs to include.  ``None`` â all.</span>
<span class="sd">    time_range : tuple, optional</span>
<span class="sd">        ``(start, end)`` datetimes for epoch filtering.</span>
<span class="sd">    stat : {&#39;mean&#39;, &#39;median&#39;, &#39;std&#39;}</span>
<span class="sd">        Statistic to compute per cell.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Array of length ``grid.ncells`` with per-cell aggregated values</span>
<span class="sd">        (NaN where no observations exist).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">vod</span> <span class="o">=</span> <span class="n">data_ds</span><span class="p">[</span><span class="n">value_var</span><span class="p">]</span>
    <span class="n">cell_ids</span> <span class="o">=</span> <span class="n">data_ds</span><span class="p">[</span><span class="n">cell_var</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">sid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;sid&quot;</span> <span class="ow">in</span> <span class="n">vod</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
        <span class="n">vod</span> <span class="o">=</span> <span class="n">vod</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">sid</span><span class="o">=</span><span class="n">sid</span><span class="p">)</span>
        <span class="n">cell_ids</span> <span class="o">=</span> <span class="n">cell_ids</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">sid</span><span class="o">=</span><span class="n">sid</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using SIDs: </span><span class="si">{</span><span class="n">sid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">sid</span> <span class="ow">and</span> <span class="s2">&quot;sid&quot;</span> <span class="ow">in</span> <span class="n">vod</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
        <span class="n">available_sids</span> <span class="o">=</span> <span class="n">vod</span><span class="o">.</span><span class="n">sid</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using all available SIDs: </span><span class="si">{</span><span class="n">available_sids</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No SID dimension in data.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">time_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">vod</span> <span class="o">=</span> <span class="n">vod</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">epoch</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">time_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">cell_ids</span> <span class="o">=</span> <span class="n">cell_ids</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">epoch</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">time_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">vod_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">vod</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">cell_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cell_ids</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">vod_flat</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cell_flat</span><span class="p">)</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pl</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;cell_id&quot;</span><span class="p">:</span> <span class="n">cell_flat</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
            <span class="s2">&quot;vod&quot;</span><span class="p">:</span> <span class="n">vod_flat</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="n">agg_expr</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vod&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="s2">&quot;median&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vod&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">median</span><span class="p">(),</span>
        <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;vod&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">stat</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">agg_expr</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported stat: </span><span class="si">{</span><span class="n">stat</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">agg</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="s2">&quot;cell_id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">agg_expr</span><span class="p">[</span><span class="n">stat</span><span class="p">]</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;vod_stat&quot;</span><span class="p">))</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">result</span><span class="p">[</span><span class="n">agg</span><span class="p">[</span><span class="s2">&quot;cell_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()]</span> <span class="o">=</span> <span class="n">agg</span><span class="p">[</span><span class="s2">&quot;vod_stat&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="canvod.grids.aggregation.compute_percell_timeseries" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_percell_timeseries</span><span class="p">(</span><span class="n">data_ds</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">value_var</span><span class="o">=</span><span class="s1">&#39;VOD&#39;</span><span class="p">,</span> <span class="n">cell_var</span><span class="o">=</span><span class="s1">&#39;cell_id_equal_area_2deg&#39;</span><span class="p">,</span> <span class="n">theta_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phi_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">selected_sids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">temporal_resolution</span><span class="o">=</span><span class="s1">&#39;1D&#39;</span><span class="p">,</span> <span class="n">chunk_days</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">min_obs_per_cell_time</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

<a href="#canvod.grids.aggregation.compute_percell_timeseries" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Compute time series per cell with SID aggregation.</p>
<p>Processing is chunked over time to bound memory usage.</p>
<h4 id="canvod.grids.aggregation.compute_percell_timeseries--parameters">Parameters<a class="headerlink" href="#canvod.grids.aggregation.compute_percell_timeseries--parameters" title="Permanent link">&para;</a></h4>
<p>data_ds : xr.Dataset
    Full VOD dataset.
grid : GridData
    Grid definition.
value_var : str
    VOD variable name.
cell_var : str
    Cell-ID variable name.
theta_range : tuple, optional
    <code>(min_deg, max_deg)</code> elevation filter.
phi_range : tuple, optional
    <code>(min_deg, max_deg)</code> azimuth filter (wraps at 360Â°).
selected_sids : list[str], optional
    Satellite IDs to include.
time_range : tuple, optional
    <code>(start, end)</code> epoch slice.
temporal_resolution : str
    Pandas/polars frequency string (e.g. <code>"1D"</code>, <code>"30min"</code>).
chunk_days : int
    Days per processing chunk.
min_obs_per_cell_time : int
    Minimum SID observations per (cell, time-bin) to retain.</p>
<h4 id="canvod.grids.aggregation.compute_percell_timeseries--returns">Returns<a class="headerlink" href="#canvod.grids.aggregation.compute_percell_timeseries--returns" title="Permanent link">&para;</a></h4>
<p>xr.Dataset
    Dataset with dimensions <code>(cell, time)</code> and variables
    <code>cell_timeseries</code>, <code>cell_weights</code>, <code>cell_counts</code>,
    <code>cell_theta</code>, <code>cell_phi</code>.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/aggregation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_percell_timeseries</span><span class="p">(</span>
    <span class="n">data_ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="n">grid</span><span class="p">:</span> <span class="n">GridData</span><span class="p">,</span>
    <span class="n">value_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;VOD&quot;</span><span class="p">,</span>
    <span class="n">cell_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;cell_id_equal_area_2deg&quot;</span><span class="p">,</span>
    <span class="n">theta_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">phi_range</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">selected_sids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">time_range</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">temporal_resolution</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1D&quot;</span><span class="p">,</span>
    <span class="n">chunk_days</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">21</span><span class="p">,</span>
    <span class="n">min_obs_per_cell_time</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute time series per cell with SID aggregation.</span>

<span class="sd">    Processing is chunked over time to bound memory usage.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_ds : xr.Dataset</span>
<span class="sd">        Full VOD dataset.</span>
<span class="sd">    grid : GridData</span>
<span class="sd">        Grid definition.</span>
<span class="sd">    value_var : str</span>
<span class="sd">        VOD variable name.</span>
<span class="sd">    cell_var : str</span>
<span class="sd">        Cell-ID variable name.</span>
<span class="sd">    theta_range : tuple, optional</span>
<span class="sd">        ``(min_deg, max_deg)`` elevation filter.</span>
<span class="sd">    phi_range : tuple, optional</span>
<span class="sd">        ``(min_deg, max_deg)`` azimuth filter (wraps at 360Â°).</span>
<span class="sd">    selected_sids : list[str], optional</span>
<span class="sd">        Satellite IDs to include.</span>
<span class="sd">    time_range : tuple, optional</span>
<span class="sd">        ``(start, end)`` epoch slice.</span>
<span class="sd">    temporal_resolution : str</span>
<span class="sd">        Pandas/polars frequency string (e.g. ``&quot;1D&quot;``, ``&quot;30min&quot;``).</span>
<span class="sd">    chunk_days : int</span>
<span class="sd">        Days per processing chunk.</span>
<span class="sd">    min_obs_per_cell_time : int</span>
<span class="sd">        Minimum SID observations per (cell, time-bin) to retain.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xr.Dataset</span>
<span class="sd">        Dataset with dimensions ``(cell, time)`` and variables</span>
<span class="sd">        ``cell_timeseries``, ``cell_weights``, ``cell_counts``,</span>
<span class="sd">        ``cell_theta``, ``cell_phi``.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ð PER-CELL TIME SERIES AGGREGATION&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ð¦ Chunk size: </span><span class="si">{</span><span class="n">chunk_days</span><span class="si">}</span><span class="s2"> days&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ð Resolution: </span><span class="si">{</span><span class="n">temporal_resolution</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">selected_cells</span> <span class="o">=</span> <span class="n">_create_spatial_selection</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">theta_range</span><span class="p">,</span> <span class="n">phi_range</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ð Selected cells: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_cells</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">selected_sids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="s2">&quot;sid&quot;</span> <span class="ow">in</span> <span class="n">data_ds</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
        <span class="n">data_ds</span> <span class="o">=</span> <span class="n">data_ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">sid</span><span class="o">=</span><span class="n">selected_sids</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ð°ï¸  Selected SIDs: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">selected_sids</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">time_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data_ds</span> <span class="o">=</span> <span class="n">data_ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">epoch</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">time_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">time_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ð Data shape: </span><span class="si">{</span><span class="n">data_ds</span><span class="p">[</span><span class="n">value_var</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">time_start</span><span class="p">,</span> <span class="n">time_end</span> <span class="o">=</span> <span class="n">data_ds</span><span class="o">.</span><span class="n">epoch</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data_ds</span><span class="o">.</span><span class="n">epoch</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Normalise frequency string for pandas</span>
    <span class="n">pandas_freq</span> <span class="o">=</span> <span class="n">_normalise_pandas_freq</span><span class="p">(</span><span class="n">temporal_resolution</span><span class="p">)</span>

    <span class="n">output_times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span>
        <span class="n">start</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">time_start</span><span class="p">),</span>
        <span class="n">end</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">time_end</span><span class="p">),</span>
        <span class="n">freq</span><span class="o">=</span><span class="n">pandas_freq</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">n_times</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_times</span><span class="p">)</span>
    <span class="n">n_cells</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">selected_cells</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ð Output shape: </span><span class="si">{</span><span class="n">n_cells</span><span class="si">}</span><span class="s2"> cells Ã </span><span class="si">{</span><span class="n">n_times</span><span class="si">}</span><span class="s2"> time bins&quot;</span><span class="p">)</span>

    <span class="c1"># Result arrays (cell Ã time)</span>
    <span class="n">cell_timeseries</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_times</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">cell_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_times</span><span class="p">))</span>
    <span class="n">cell_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_cells</span><span class="p">,</span> <span class="n">n_times</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">cell_to_idx</span> <span class="o">=</span> <span class="p">{</span><span class="nb">int</span><span class="p">(</span><span class="n">cell_id</span><span class="p">):</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cell_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">selected_cells</span><span class="p">)}</span>
    <span class="n">time_to_idx</span> <span class="o">=</span> <span class="p">{</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="n">t</span><span class="p">):</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output_times</span><span class="p">)}</span>

    <span class="n">chunk_starts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span>
        <span class="n">start</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">time_start</span><span class="p">),</span>
        <span class="n">end</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">time_end</span><span class="p">),</span>
        <span class="n">freq</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">chunk_days</span><span class="si">}</span><span class="s2">D&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ð Processing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk_starts</span><span class="p">)</span><span class="si">}</span><span class="s2"> chunks...&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">chunk_start</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">chunk_starts</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing chunks&quot;</span><span class="p">):</span>
        <span class="n">chunk_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span>
            <span class="n">chunk_start</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">chunk_days</span><span class="p">),</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">time_end</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">chunk_data</span> <span class="o">=</span> <span class="n">data_ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">epoch</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">chunk_start</span><span class="p">,</span> <span class="n">chunk_end</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk_data</span><span class="o">.</span><span class="n">epoch</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">chunk_results</span> <span class="o">=</span> <span class="n">_process_chunk_percell</span><span class="p">(</span>
            <span class="n">chunk_data</span><span class="p">,</span>
            <span class="n">selected_cells</span><span class="p">,</span>
            <span class="n">temporal_resolution</span><span class="p">,</span>
            <span class="n">value_var</span><span class="p">,</span>
            <span class="n">cell_var</span><span class="p">,</span>
            <span class="n">min_obs_per_cell_time</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">chunk_results</span><span class="p">:</span>
            <span class="n">_merge_percell_results</span><span class="p">(</span>
                <span class="n">chunk_results</span><span class="p">,</span>
                <span class="n">cell_timeseries</span><span class="p">,</span>
                <span class="n">cell_weights</span><span class="p">,</span>
                <span class="n">cell_counts</span><span class="p">,</span>
                <span class="n">cell_to_idx</span><span class="p">,</span>
                <span class="n">time_to_idx</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">del</span> <span class="n">chunk_data</span>
        <span class="n">gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>

    <span class="n">processing_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

    <span class="n">result_ds</span> <span class="o">=</span> <span class="n">_create_percell_dataset</span><span class="p">(</span>
        <span class="n">cell_timeseries</span><span class="p">,</span>
        <span class="n">cell_weights</span><span class="p">,</span>
        <span class="n">cell_counts</span><span class="p">,</span>
        <span class="n">selected_cells</span><span class="p">,</span>
        <span class="n">output_times</span><span class="p">,</span>
        <span class="n">grid</span><span class="p">,</span>
        <span class="n">processing_time</span><span class="p">,</span>
        <span class="n">theta_range</span><span class="p">,</span>
        <span class="n">phi_range</span><span class="p">,</span>
        <span class="n">temporal_resolution</span><span class="p">,</span>
        <span class="n">chunk_days</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">valid_cell_times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cell_timeseries</span><span class="p">))</span>
    <span class="n">total_cell_times</span> <span class="o">=</span> <span class="n">n_cells</span> <span class="o">*</span> <span class="n">n_times</span>
    <span class="n">coverage</span> <span class="o">=</span> <span class="p">(</span><span class="n">valid_cell_times</span> <span class="o">/</span> <span class="n">total_cell_times</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">â PER-CELL AGGREGATION COMPLETE!&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;â¡ Time: </span><span class="si">{</span><span class="n">processing_time</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">60</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> minutes&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ð Output: </span><span class="si">{</span><span class="n">n_cells</span><span class="si">}</span><span class="s2"> cells Ã </span><span class="si">{</span><span class="n">n_times</span><span class="si">}</span><span class="s2"> times&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ð Coverage: </span><span class="si">{</span><span class="n">valid_cell_times</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="n">total_cell_times</span><span class="si">:</span><span class="s2">,</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="n">coverage</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%)&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ð¯ Ready for diurnal analysis, spatial patterns, custom aggregations!&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result_ds</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="canvod.grids.aggregation.compute_global_average" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_global_average</span><span class="p">(</span><span class="n">percell_ds</span><span class="p">)</span></code>

<a href="#canvod.grids.aggregation.compute_global_average" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Compute observation-countâweighted global average from per-cell data.</p>
<h4 id="canvod.grids.aggregation.compute_global_average--parameters">Parameters<a class="headerlink" href="#canvod.grids.aggregation.compute_global_average--parameters" title="Permanent link">&para;</a></h4>
<p>percell_ds : xr.Dataset
    Output of :func:<code>compute_percell_timeseries</code>.</p>
<h4 id="canvod.grids.aggregation.compute_global_average--returns">Returns<a class="headerlink" href="#canvod.grids.aggregation.compute_global_average--returns" title="Permanent link">&para;</a></h4>
<p>xr.Dataset
    Variables: <code>global_timeseries</code>, <code>spatial_std</code>,
    <code>total_weights</code>, <code>active_cells</code>.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/aggregation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_global_average</span><span class="p">(</span><span class="n">percell_ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute observation-countâweighted global average from per-cell data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    percell_ds : xr.Dataset</span>
<span class="sd">        Output of :func:`compute_percell_timeseries`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xr.Dataset</span>
<span class="sd">        Variables: ``global_timeseries``, ``spatial_std``,</span>
<span class="sd">        ``total_weights``, ``active_cells``.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">percell_ds</span><span class="o">.</span><span class="n">cell_weights</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">percell_ds</span><span class="o">.</span><span class="n">cell_timeseries</span>

    <span class="n">weighted_sum</span> <span class="o">=</span> <span class="p">(</span><span class="n">values</span> <span class="o">*</span> <span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;cell&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">total_weights</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;cell&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">global_mean</span> <span class="o">=</span> <span class="n">weighted_sum</span> <span class="o">/</span> <span class="n">total_weights</span>

    <span class="n">valid_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
    <span class="n">spatial_std</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;cell&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;global_timeseries&quot;</span><span class="p">:</span> <span class="n">global_mean</span><span class="p">,</span>
            <span class="s2">&quot;spatial_std&quot;</span><span class="p">:</span> <span class="n">spatial_std</span><span class="p">,</span>
            <span class="s2">&quot;total_weights&quot;</span><span class="p">:</span> <span class="n">total_weights</span><span class="p">,</span>
            <span class="s2">&quot;active_cells&quot;</span><span class="p">:</span> <span class="n">valid_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;cell&quot;</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="canvod.grids.aggregation.compute_regional_average" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_regional_average</span><span class="p">(</span><span class="n">percell_ds</span><span class="p">,</span> <span class="n">region_cells</span><span class="p">)</span></code>

<a href="#canvod.grids.aggregation.compute_regional_average" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Compute observation-countâweighted average for a cell subset.</p>
<h4 id="canvod.grids.aggregation.compute_regional_average--parameters">Parameters<a class="headerlink" href="#canvod.grids.aggregation.compute_regional_average--parameters" title="Permanent link">&para;</a></h4>
<p>percell_ds : xr.Dataset
    Output of :func:<code>compute_percell_timeseries</code>.
region_cells : array-like
    Cell IDs defining the region.</p>
<h4 id="canvod.grids.aggregation.compute_regional_average--returns">Returns<a class="headerlink" href="#canvod.grids.aggregation.compute_regional_average--returns" title="Permanent link">&para;</a></h4>
<p>xr.DataArray
    Weighted regional mean time series.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/aggregation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_regional_average</span><span class="p">(</span>
    <span class="n">percell_ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">region_cells</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute observation-countâweighted average for a cell subset.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    percell_ds : xr.Dataset</span>
<span class="sd">        Output of :func:`compute_percell_timeseries`.</span>
<span class="sd">    region_cells : array-like</span>
<span class="sd">        Cell IDs defining the region.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xr.DataArray</span>
<span class="sd">        Weighted regional mean time series.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">regional_data</span> <span class="o">=</span> <span class="n">percell_ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">cell</span><span class="o">=</span><span class="n">region_cells</span><span class="p">)</span>

    <span class="n">weights</span> <span class="o">=</span> <span class="n">regional_data</span><span class="o">.</span><span class="n">cell_weights</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">regional_data</span><span class="o">.</span><span class="n">cell_timeseries</span>

    <span class="n">weighted_sum</span> <span class="o">=</span> <span class="p">(</span><span class="n">values</span> <span class="o">*</span> <span class="n">weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;cell&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">total_weights</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;cell&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">weighted_sum</span> <span class="o">/</span> <span class="n">total_weights</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="canvod.grids.aggregation.analyze_diurnal_patterns" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analyze_diurnal_patterns</span><span class="p">(</span><span class="n">percell_ds</span><span class="p">)</span></code>

<a href="#canvod.grids.aggregation.analyze_diurnal_patterns" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Compute hourly means from per-cell time series.</p>
<h4 id="canvod.grids.aggregation.analyze_diurnal_patterns--parameters">Parameters<a class="headerlink" href="#canvod.grids.aggregation.analyze_diurnal_patterns--parameters" title="Permanent link">&para;</a></h4>
<p>percell_ds : xr.Dataset
    Output of :func:<code>compute_percell_timeseries</code>.</p>
<h4 id="canvod.grids.aggregation.analyze_diurnal_patterns--returns">Returns<a class="headerlink" href="#canvod.grids.aggregation.analyze_diurnal_patterns--returns" title="Permanent link">&para;</a></h4>
<p>xr.Dataset
    Grouped by <code>time.hour</code>.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/aggregation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analyze_diurnal_patterns</span><span class="p">(</span><span class="n">percell_ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute hourly means from per-cell time series.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    percell_ds : xr.Dataset</span>
<span class="sd">        Output of :func:`compute_percell_timeseries`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xr.Dataset</span>
<span class="sd">        Grouped by ``time.hour``.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">percell_ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.hour&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="canvod.grids.aggregation.analyze_spatial_patterns" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">analyze_spatial_patterns</span><span class="p">(</span><span class="n">percell_ds</span><span class="p">)</span></code>

<a href="#canvod.grids.aggregation.analyze_spatial_patterns" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Compute time-averaged spatial field.</p>
<h4 id="canvod.grids.aggregation.analyze_spatial_patterns--parameters">Parameters<a class="headerlink" href="#canvod.grids.aggregation.analyze_spatial_patterns--parameters" title="Permanent link">&para;</a></h4>
<p>percell_ds : xr.Dataset
    Output of :func:<code>compute_percell_timeseries</code>.</p>
<h4 id="canvod.grids.aggregation.analyze_spatial_patterns--returns">Returns<a class="headerlink" href="#canvod.grids.aggregation.analyze_spatial_patterns--returns" title="Permanent link">&para;</a></h4>
<p>xr.Dataset
    Time-averaged dataset.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/aggregation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">analyze_spatial_patterns</span><span class="p">(</span><span class="n">percell_ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute time-averaged spatial field.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    percell_ds : xr.Dataset</span>
<span class="sd">        Output of :func:`compute_percell_timeseries`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xr.Dataset</span>
<span class="sd">        Time-averaged dataset.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">percell_ds</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="canvod.grids.aggregation.compute_hemisphere_percell" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_hemisphere_percell</span><span class="p">(</span><span class="n">data_ds</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#canvod.grids.aggregation.compute_hemisphere_percell" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Daily per-cell time series for the full hemisphere.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/aggregation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_hemisphere_percell</span><span class="p">(</span>
    <span class="n">data_ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="n">grid</span><span class="p">:</span> <span class="n">GridData</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Daily per-cell time series for the full hemisphere.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">compute_percell_timeseries</span><span class="p">(</span>
        <span class="n">data_ds</span><span class="o">=</span><span class="n">data_ds</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span> <span class="n">temporal_resolution</span><span class="o">=</span><span class="s2">&quot;1D&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="canvod.grids.aggregation.compute_zenith_percell" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_zenith_percell</span><span class="p">(</span><span class="n">data_ds</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#canvod.grids.aggregation.compute_zenith_percell" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Daily per-cell time series restricted to Î¸ â¤ 30Â°.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/aggregation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_zenith_percell</span><span class="p">(</span>
    <span class="n">data_ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="n">grid</span><span class="p">:</span> <span class="n">GridData</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Daily per-cell time series restricted to Î¸ â¤ 30Â°.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">compute_percell_timeseries</span><span class="p">(</span>
        <span class="n">data_ds</span><span class="o">=</span><span class="n">data_ds</span><span class="p">,</span>
        <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span>
        <span class="n">theta_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
        <span class="n">temporal_resolution</span><span class="o">=</span><span class="s2">&quot;1D&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div><h2 id="analysis">Analysis<a class="headerlink" href="#analysis" title="Permanent link">&para;</a></h2>


<div class="doc doc-object doc-module">



<a id="canvod.grids.analysis"></a>
    <div class="doc doc-contents first">

        <p>Analysis subpackage for canvod-grids.</p>
<p>Per-cell and global analysis of VOD hemisphere-grid datasets: filtering,
masking, weighting, temporal/spatial aggregation, and persistent storage
of precomputed results.</p>
<h3 id="canvod.grids.analysis--modules">Modules<a class="headerlink" href="#canvod.grids.analysis--modules" title="Permanent link">&para;</a></h3>
<p>filtering           Global statistical filters (IQR, Z-score).
per_cell_filtering  Per-cell statistical filters.
masking             Spatial and temporal mask construction.
solar               Solar geometry computations.
weighting           Per-cell weight calculators.
hampel_filtering    Hampel (median-MAD) outlier filtering.
sigma_clip_filter   Numba-accelerated sigma-clipping / Hampel filtering.
temporal            Weighted temporal aggregation and diurnal analysis.
spatial             Per-cell spatial statistics.
per_cell_analysis   Multi-dataset per-cell VOD analysis.
analysis_storage    Persistent Icechunk storage for analysis results
                    (requires <code>canvod-store</code>).</p>










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h2 id="canvod.grids.analysis.Filter" class="doc doc-heading">
            <code>Filter</code>


<a href="#canvod.grids.analysis.Filter" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>



        <p>Base class for all filters.  Filters NEVER modify original data.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/filtering.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Filter</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for all filters.  Filters NEVER modify original data.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the filter.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Filter name.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;filter_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
        <span class="p">}</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_mask</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute boolean mask (True = keep, False = remove).&quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
        <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">output_suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply filter to *ds*, returning a copy with filtered variable added.</span>

<span class="sd">        New variables</span>
<span class="sd">        -------------</span>
<span class="sd">        ``&lt;var_name&gt;_filtered_&lt;suffix&gt;`` : filtered data (NaN where masked).</span>
<span class="sd">        ``mask_&lt;suffix&gt;``               : boolean keep-mask.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="n">output_suffix</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_mask</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

        <span class="n">n_total</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">n_removed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="o">~</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="s2">&quot;applied_to&quot;</span><span class="p">:</span> <span class="n">var_name</span><span class="p">,</span>
            <span class="s2">&quot;n_total&quot;</span><span class="p">:</span> <span class="n">n_total</span><span class="p">,</span>
            <span class="s2">&quot;n_removed&quot;</span><span class="p">:</span> <span class="n">n_removed</span><span class="p">,</span>
            <span class="s2">&quot;fraction_removed&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">n_removed</span> <span class="o">/</span> <span class="n">n_total</span><span class="p">),</span>
            <span class="s2">&quot;filter_chain&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
        <span class="p">}</span>

        <span class="n">ds_out</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">filtered_var_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">_filtered_</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">mask_var_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mask_</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">ds_out</span><span class="p">[</span><span class="n">filtered_var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_data</span>
        <span class="n">ds_out</span><span class="p">[</span><span class="n">filtered_var_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">metadata</span>

        <span class="n">ds_out</span><span class="p">[</span><span class="n">mask_var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>
        <span class="n">ds_out</span><span class="p">[</span><span class="n">mask_var_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Boolean mask for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> filter&quot;</span><span class="p">,</span>
            <span class="s2">&quot;True&quot;</span><span class="p">:</span> <span class="s2">&quot;keep&quot;</span><span class="p">,</span>
            <span class="s2">&quot;False&quot;</span><span class="p">:</span> <span class="s2">&quot;filtered out&quot;</span><span class="p">,</span>
            <span class="o">**</span><span class="n">metadata</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">ds_out</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.Filter.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.Filter.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the filter.</p>
<h5 id="canvod.grids.analysis.Filter.__init__--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.Filter.__init__--parameters" title="Permanent link">&para;</a></h5>
<p>name : str
    Filter name.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/filtering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the filter.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Filter name.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;filter_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
        <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.Filter.compute_mask" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_mask</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

<a href="#canvod.grids.analysis.Filter.compute_mask" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Compute boolean mask (True = keep, False = remove).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/filtering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_mask</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute boolean mask (True = keep, False = remove).&quot;&quot;&quot;</span>
    <span class="o">...</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.Filter.apply" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">apply</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">output_suffix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.Filter.apply" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Apply filter to <em>ds</em>, returning a copy with filtered variable added.</p>
<h5 id="canvod.grids.analysis.Filter.apply--new-variables">New variables<a class="headerlink" href="#canvod.grids.analysis.Filter.apply--new-variables" title="Permanent link">&para;</a></h5>
<p><code>&lt;var_name&gt;_filtered_&lt;suffix&gt;</code> : filtered data (NaN where masked).
<code>mask_&lt;suffix&gt;</code>               : boolean keep-mask.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/filtering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">output_suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply filter to *ds*, returning a copy with filtered variable added.</span>

<span class="sd">    New variables</span>
<span class="sd">    -------------</span>
<span class="sd">    ``&lt;var_name&gt;_filtered_&lt;suffix&gt;`` : filtered data (NaN where masked).</span>
<span class="sd">    ``mask_&lt;suffix&gt;``               : boolean keep-mask.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">suffix</span> <span class="o">=</span> <span class="n">output_suffix</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="n">data</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_mask</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>

    <span class="n">n_total</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="n">n_removed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="o">~</span><span class="n">mask</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="s2">&quot;applied_to&quot;</span><span class="p">:</span> <span class="n">var_name</span><span class="p">,</span>
        <span class="s2">&quot;n_total&quot;</span><span class="p">:</span> <span class="n">n_total</span><span class="p">,</span>
        <span class="s2">&quot;n_removed&quot;</span><span class="p">:</span> <span class="n">n_removed</span><span class="p">,</span>
        <span class="s2">&quot;fraction_removed&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">n_removed</span> <span class="o">/</span> <span class="n">n_total</span><span class="p">),</span>
        <span class="s2">&quot;filter_chain&quot;</span><span class="p">:</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="n">ds_out</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">filtered_var_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">_filtered_</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">mask_var_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mask_</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">ds_out</span><span class="p">[</span><span class="n">filtered_var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_data</span>
    <span class="n">ds_out</span><span class="p">[</span><span class="n">filtered_var_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">metadata</span>

    <span class="n">ds_out</span><span class="p">[</span><span class="n">mask_var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>
    <span class="n">ds_out</span><span class="p">[</span><span class="n">mask_var_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Boolean mask for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> filter&quot;</span><span class="p">,</span>
        <span class="s2">&quot;True&quot;</span><span class="p">:</span> <span class="s2">&quot;keep&quot;</span><span class="p">,</span>
        <span class="s2">&quot;False&quot;</span><span class="p">:</span> <span class="s2">&quot;filtered out&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">metadata</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">ds_out</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="canvod.grids.analysis.FilterPipeline" class="doc doc-heading">
            <code>FilterPipeline</code>


<a href="#canvod.grids.analysis.FilterPipeline" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">



        <p>Manage multiple filters applied sequentially or combined.</p>
<p>Non-destructive: creates new DataArrays, never modifies originals.</p>
<h4 id="canvod.grids.analysis.FilterPipeline--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.FilterPipeline--parameters" title="Permanent link">&para;</a></h4>
<p>ds : xr.Dataset
    Input dataset.
var_name : str
    Variable to filter (default: <code>'VOD'</code>).</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/filtering.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FilterPipeline</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Manage multiple filters applied sequentially or combined.</span>

<span class="sd">    Non-destructive: creates new DataArrays, never modifies originals.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ds : xr.Dataset</span>
<span class="sd">        Input dataset.</span>
<span class="sd">    var_name : str</span>
<span class="sd">        Variable to filter (default: ``&#39;VOD&#39;``).</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;VOD&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the filter pipeline.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ds : xr.Dataset</span>
<span class="sd">            Input dataset.</span>
<span class="sd">        var_name : str, default &quot;VOD&quot;</span>
<span class="sd">            Variable to filter.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_name</span> <span class="o">=</span> <span class="n">var_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Filter</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_obj</span><span class="p">:</span> <span class="n">Filter</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FilterPipeline</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add filter to pipeline.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filter_obj : Filter or str</span>
<span class="sd">            Filter instance or short name</span>
<span class="sd">            (``&#39;zscore&#39;``, ``&#39;iqr&#39;``, ``&#39;range&#39;``, ``&#39;percentile&#39;``).</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Parameters forwarded to ``compute_mask``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        FilterPipeline</span>
<span class="sd">            Self (for chaining).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filter_obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">_filter_map</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;zscore&quot;</span><span class="p">:</span> <span class="n">ZScoreFilter</span><span class="p">,</span>
                <span class="s2">&quot;iqr&quot;</span><span class="p">:</span> <span class="n">IQRFilter</span><span class="p">,</span>
                <span class="s2">&quot;range&quot;</span><span class="p">:</span> <span class="n">RangeFilter</span><span class="p">,</span>
                <span class="s2">&quot;percentile&quot;</span><span class="p">:</span> <span class="n">PercentileFilter</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">filter_obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_filter_map</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown filter: </span><span class="si">{</span><span class="n">filter_obj</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">filter_obj</span> <span class="o">=</span> <span class="n">_filter_map</span><span class="p">[</span><span class="n">filter_obj</span><span class="p">]()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">filter_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;sequential&quot;</span><span class="p">,</span> <span class="n">output_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply all filters in the pipeline.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mode : {&#39;sequential&#39;, &#39;combined&#39;}</span>
<span class="sd">            ``&#39;sequential&#39;`` â masks accumulate (AND) after each filter;</span>
<span class="sd">            intermediate filtered variables are written.</span>
<span class="sd">            ``&#39;combined&#39;``   â all masks computed independently on the</span>
<span class="sd">            original data, then AND-ed once.</span>
<span class="sd">        output_name : str, optional</span>
<span class="sd">            Alias for the final filtered variable.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xr.Dataset</span>
<span class="sd">            Dataset with filtered variables appended.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No filters in pipeline&quot;</span><span class="p">)</span>

        <span class="n">ds_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;sequential&quot;</span><span class="p">:</span>
            <span class="n">masks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">filter_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">all_params</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">filter_obj</span><span class="p">,</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">filter_obj</span><span class="o">.</span><span class="n">compute_mask</span><span class="p">(</span><span class="n">ds_out</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
                <span class="n">filter_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filter_obj</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">all_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

                <span class="c1"># Store individual mask</span>
                <span class="n">mask_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mask_</span><span class="si">{</span><span class="n">filter_obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">mask_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ds_out</span><span class="p">:</span>
                    <span class="n">ds_out</span><span class="p">[</span><span class="n">mask_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>
                    <span class="n">ds_out</span><span class="p">[</span><span class="n">mask_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;filter_type&quot;</span><span class="p">:</span> <span class="n">filter_obj</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                    <span class="p">}</span>

                <span class="c1"># Accumulate masks (AND)</span>
                <span class="n">cumulative_mask</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">masks</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="n">cumulative_mask</span> <span class="o">=</span> <span class="n">cumulative_mask</span> <span class="o">&amp;</span> <span class="n">m</span>

                <span class="n">cumulative_suffix</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filter_names</span><span class="p">)</span>
                <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">ds_out</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cumulative_mask</span><span class="p">)</span>

                <span class="n">filtered_var_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">_filtered_</span><span class="si">{</span><span class="n">cumulative_suffix</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">cumulative_mask_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mask_</span><span class="si">{</span><span class="n">cumulative_suffix</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="n">ds_out</span><span class="p">[</span><span class="n">filtered_var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_data</span>
                <span class="n">ds_out</span><span class="p">[</span><span class="n">cumulative_mask_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cumulative_mask</span>

                <span class="n">n_total</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cumulative_mask</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                <span class="n">n_removed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="o">~</span><span class="n">cumulative_mask</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

                <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;filter_chain&quot;</span><span class="p">:</span> <span class="n">filter_names</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                    <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;sequential&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;applied_to&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="p">,</span>
                    <span class="s2">&quot;n_total&quot;</span><span class="p">:</span> <span class="n">n_total</span><span class="p">,</span>
                    <span class="s2">&quot;n_removed&quot;</span><span class="p">:</span> <span class="n">n_removed</span><span class="p">,</span>
                    <span class="s2">&quot;fraction_removed&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">n_removed</span> <span class="o">/</span> <span class="n">n_total</span><span class="p">),</span>
                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                    <span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="n">fname</span><span class="p">:</span> <span class="n">params</span> <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">filter_names</span><span class="p">,</span> <span class="n">all_params</span><span class="p">)</span>
                    <span class="p">},</span>
                <span class="p">}</span>

                <span class="n">ds_out</span><span class="p">[</span><span class="n">filtered_var_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">metadata</span>
                <span class="n">ds_out</span><span class="p">[</span><span class="n">cumulative_mask_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">metadata</span>

            <span class="k">if</span> <span class="n">output_name</span><span class="p">:</span>
                <span class="n">final_var</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">_filtered_</span><span class="si">{</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filter_names</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">final_mask</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mask_</span><span class="si">{</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filter_names</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

                <span class="n">ds_out</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">_filtered_</span><span class="si">{</span><span class="n">output_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_out</span><span class="p">[</span><span class="n">final_var</span><span class="p">]</span>
                <span class="n">ds_out</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;mask_</span><span class="si">{</span><span class="n">output_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_out</span><span class="p">[</span><span class="n">final_mask</span><span class="p">]</span>
                <span class="n">ds_out</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">_filtered_</span><span class="si">{</span><span class="n">output_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">ds_out</span><span class="p">[</span>
                    <span class="n">final_var</span>
                <span class="p">]</span><span class="o">.</span><span class="n">attrs</span>
                <span class="n">ds_out</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;mask_</span><span class="si">{</span><span class="n">output_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">ds_out</span><span class="p">[</span><span class="n">final_mask</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>

        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;combined&quot;</span><span class="p">:</span>
            <span class="n">masks</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">filter_names</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">all_params</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">filter_obj</span><span class="p">,</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">filter_obj</span><span class="o">.</span><span class="n">compute_mask</span><span class="p">(</span><span class="n">ds_out</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
                <span class="n">filter_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filter_obj</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                <span class="n">all_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

                <span class="n">mask_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mask_</span><span class="si">{</span><span class="n">filter_obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">mask_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ds_out</span><span class="p">:</span>
                    <span class="n">ds_out</span><span class="p">[</span><span class="n">mask_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>
                    <span class="n">ds_out</span><span class="p">[</span><span class="n">mask_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;filter_type&quot;</span><span class="p">:</span> <span class="n">filter_obj</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                    <span class="p">}</span>

            <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">masks</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">combined_mask</span> <span class="o">&amp;</span> <span class="n">mask</span>

            <span class="n">suffix</span> <span class="o">=</span> <span class="n">output_name</span> <span class="ow">or</span> <span class="s2">&quot;combined&quot;</span>
            <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">ds_out</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">combined_mask</span><span class="p">)</span>

            <span class="n">filtered_var_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">_filtered_</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">mask_var_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mask_</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">ds_out</span><span class="p">[</span><span class="n">filtered_var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_data</span>
            <span class="n">ds_out</span><span class="p">[</span><span class="n">mask_var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined_mask</span>

            <span class="n">n_total</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">combined_mask</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">n_removed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="o">~</span><span class="n">combined_mask</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

            <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;filter_chain&quot;</span><span class="p">:</span> <span class="n">filter_names</span><span class="p">,</span>
                <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;combined&quot;</span><span class="p">,</span>
                <span class="s2">&quot;applied_to&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="p">,</span>
                <span class="s2">&quot;n_total&quot;</span><span class="p">:</span> <span class="n">n_total</span><span class="p">,</span>
                <span class="s2">&quot;n_removed&quot;</span><span class="p">:</span> <span class="n">n_removed</span><span class="p">,</span>
                <span class="s2">&quot;fraction_removed&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">n_removed</span> <span class="o">/</span> <span class="n">n_total</span><span class="p">),</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="n">fname</span><span class="p">:</span> <span class="n">params</span> <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">filter_names</span><span class="p">,</span> <span class="n">all_params</span><span class="p">)</span>
                <span class="p">},</span>
            <span class="p">}</span>

            <span class="n">ds_out</span><span class="p">[</span><span class="n">filtered_var_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">metadata</span>
            <span class="n">ds_out</span><span class="p">[</span><span class="n">mask_var_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">metadata</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown mode: </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ds_out</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a human-readable summary of the pipeline.&quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Filter Pipeline for &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">&#39;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">filter_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">filter_obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.FilterPipeline.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;VOD&#39;</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.FilterPipeline.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the filter pipeline.</p>
<h5 id="canvod.grids.analysis.FilterPipeline.__init__--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.FilterPipeline.__init__--parameters" title="Permanent link">&para;</a></h5>
<p>ds : xr.Dataset
    Input dataset.
var_name : str, default "VOD"
    Variable to filter.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/filtering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;VOD&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the filter pipeline.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ds : xr.Dataset</span>
<span class="sd">        Input dataset.</span>
<span class="sd">    var_name : str, default &quot;VOD&quot;</span>
<span class="sd">        Variable to filter.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">var_name</span> <span class="o">=</span> <span class="n">var_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">Filter</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.FilterPipeline.add_filter" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_filter</span><span class="p">(</span><span class="n">filter_obj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.FilterPipeline.add_filter" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Add filter to pipeline.</p>
<h5 id="canvod.grids.analysis.FilterPipeline.add_filter--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.FilterPipeline.add_filter--parameters" title="Permanent link">&para;</a></h5>
<p>filter_obj : Filter or str
    Filter instance or short name
    (<code>'zscore'</code>, <code>'iqr'</code>, <code>'range'</code>, <code>'percentile'</code>).
**kwargs
    Parameters forwarded to <code>compute_mask</code>.</p>
<h5 id="canvod.grids.analysis.FilterPipeline.add_filter--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.FilterPipeline.add_filter--returns" title="Permanent link">&para;</a></h5>
<p>FilterPipeline
    Self (for chaining).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/filtering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_obj</span><span class="p">:</span> <span class="n">Filter</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FilterPipeline</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add filter to pipeline.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filter_obj : Filter or str</span>
<span class="sd">        Filter instance or short name</span>
<span class="sd">        (``&#39;zscore&#39;``, ``&#39;iqr&#39;``, ``&#39;range&#39;``, ``&#39;percentile&#39;``).</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Parameters forwarded to ``compute_mask``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    FilterPipeline</span>
<span class="sd">        Self (for chaining).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filter_obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">_filter_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;zscore&quot;</span><span class="p">:</span> <span class="n">ZScoreFilter</span><span class="p">,</span>
            <span class="s2">&quot;iqr&quot;</span><span class="p">:</span> <span class="n">IQRFilter</span><span class="p">,</span>
            <span class="s2">&quot;range&quot;</span><span class="p">:</span> <span class="n">RangeFilter</span><span class="p">,</span>
            <span class="s2">&quot;percentile&quot;</span><span class="p">:</span> <span class="n">PercentileFilter</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">filter_obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_filter_map</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown filter: </span><span class="si">{</span><span class="n">filter_obj</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">filter_obj</span> <span class="o">=</span> <span class="n">_filter_map</span><span class="p">[</span><span class="n">filter_obj</span><span class="p">]()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">filter_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.FilterPipeline.apply" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">apply</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;sequential&#39;</span><span class="p">,</span> <span class="n">output_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.FilterPipeline.apply" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Apply all filters in the pipeline.</p>
<h5 id="canvod.grids.analysis.FilterPipeline.apply--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.FilterPipeline.apply--parameters" title="Permanent link">&para;</a></h5>
<p>mode : {'sequential', 'combined'}
    <code>'sequential'</code> â masks accumulate (AND) after each filter;
    intermediate filtered variables are written.
    <code>'combined'</code>   â all masks computed independently on the
    original data, then AND-ed once.
output_name : str, optional
    Alias for the final filtered variable.</p>
<h5 id="canvod.grids.analysis.FilterPipeline.apply--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.FilterPipeline.apply--returns" title="Permanent link">&para;</a></h5>
<p>xr.Dataset
    Dataset with filtered variables appended.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/filtering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;sequential&quot;</span><span class="p">,</span> <span class="n">output_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply all filters in the pipeline.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mode : {&#39;sequential&#39;, &#39;combined&#39;}</span>
<span class="sd">        ``&#39;sequential&#39;`` â masks accumulate (AND) after each filter;</span>
<span class="sd">        intermediate filtered variables are written.</span>
<span class="sd">        ``&#39;combined&#39;``   â all masks computed independently on the</span>
<span class="sd">        original data, then AND-ed once.</span>
<span class="sd">    output_name : str, optional</span>
<span class="sd">        Alias for the final filtered variable.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xr.Dataset</span>
<span class="sd">        Dataset with filtered variables appended.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No filters in pipeline&quot;</span><span class="p">)</span>

    <span class="n">ds_out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;sequential&quot;</span><span class="p">:</span>
        <span class="n">masks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">filter_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_params</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">filter_obj</span><span class="p">,</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">filter_obj</span><span class="o">.</span><span class="n">compute_mask</span><span class="p">(</span><span class="n">ds_out</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">filter_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filter_obj</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">all_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="c1"># Store individual mask</span>
            <span class="n">mask_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mask_</span><span class="si">{</span><span class="n">filter_obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">mask_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ds_out</span><span class="p">:</span>
                <span class="n">ds_out</span><span class="p">[</span><span class="n">mask_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>
                <span class="n">ds_out</span><span class="p">[</span><span class="n">mask_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;filter_type&quot;</span><span class="p">:</span> <span class="n">filter_obj</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">}</span>

            <span class="c1"># Accumulate masks (AND)</span>
            <span class="n">cumulative_mask</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">masks</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">cumulative_mask</span> <span class="o">=</span> <span class="n">cumulative_mask</span> <span class="o">&amp;</span> <span class="n">m</span>

            <span class="n">cumulative_suffix</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filter_names</span><span class="p">)</span>
            <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">ds_out</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cumulative_mask</span><span class="p">)</span>

            <span class="n">filtered_var_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">_filtered_</span><span class="si">{</span><span class="n">cumulative_suffix</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">cumulative_mask_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mask_</span><span class="si">{</span><span class="n">cumulative_suffix</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">ds_out</span><span class="p">[</span><span class="n">filtered_var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_data</span>
            <span class="n">ds_out</span><span class="p">[</span><span class="n">cumulative_mask_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">cumulative_mask</span>

            <span class="n">n_total</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cumulative_mask</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">n_removed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="o">~</span><span class="n">cumulative_mask</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

            <span class="n">metadata</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;filter_chain&quot;</span><span class="p">:</span> <span class="n">filter_names</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
                <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;sequential&quot;</span><span class="p">,</span>
                <span class="s2">&quot;applied_to&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="p">,</span>
                <span class="s2">&quot;n_total&quot;</span><span class="p">:</span> <span class="n">n_total</span><span class="p">,</span>
                <span class="s2">&quot;n_removed&quot;</span><span class="p">:</span> <span class="n">n_removed</span><span class="p">,</span>
                <span class="s2">&quot;fraction_removed&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">n_removed</span> <span class="o">/</span> <span class="n">n_total</span><span class="p">),</span>
                <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
                <span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="n">fname</span><span class="p">:</span> <span class="n">params</span> <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">filter_names</span><span class="p">,</span> <span class="n">all_params</span><span class="p">)</span>
                <span class="p">},</span>
            <span class="p">}</span>

            <span class="n">ds_out</span><span class="p">[</span><span class="n">filtered_var_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">metadata</span>
            <span class="n">ds_out</span><span class="p">[</span><span class="n">cumulative_mask_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">metadata</span>

        <span class="k">if</span> <span class="n">output_name</span><span class="p">:</span>
            <span class="n">final_var</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">_filtered_</span><span class="si">{</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filter_names</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">final_mask</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mask_</span><span class="si">{</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filter_names</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">ds_out</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">_filtered_</span><span class="si">{</span><span class="n">output_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_out</span><span class="p">[</span><span class="n">final_var</span><span class="p">]</span>
            <span class="n">ds_out</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;mask_</span><span class="si">{</span><span class="n">output_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds_out</span><span class="p">[</span><span class="n">final_mask</span><span class="p">]</span>
            <span class="n">ds_out</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">_filtered_</span><span class="si">{</span><span class="n">output_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">ds_out</span><span class="p">[</span>
                <span class="n">final_var</span>
            <span class="p">]</span><span class="o">.</span><span class="n">attrs</span>
            <span class="n">ds_out</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;mask_</span><span class="si">{</span><span class="n">output_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">ds_out</span><span class="p">[</span><span class="n">final_mask</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span>

    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;combined&quot;</span><span class="p">:</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">filter_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_params</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">filter_obj</span><span class="p">,</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">filter_obj</span><span class="o">.</span><span class="n">compute_mask</span><span class="p">(</span><span class="n">ds_out</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">masks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">filter_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filter_obj</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">all_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">mask_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mask_</span><span class="si">{</span><span class="n">filter_obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">mask_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ds_out</span><span class="p">:</span>
                <span class="n">ds_out</span><span class="p">[</span><span class="n">mask_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>
                <span class="n">ds_out</span><span class="p">[</span><span class="n">mask_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;filter_type&quot;</span><span class="p">:</span> <span class="n">filter_obj</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
                <span class="p">}</span>

        <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">masks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">mask</span> <span class="ow">in</span> <span class="n">masks</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">combined_mask</span> <span class="o">&amp;</span> <span class="n">mask</span>

        <span class="n">suffix</span> <span class="o">=</span> <span class="n">output_name</span> <span class="ow">or</span> <span class="s2">&quot;combined&quot;</span>
        <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">ds_out</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">combined_mask</span><span class="p">)</span>

        <span class="n">filtered_var_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">_filtered_</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">mask_var_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;mask_</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">ds_out</span><span class="p">[</span><span class="n">filtered_var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_data</span>
        <span class="n">ds_out</span><span class="p">[</span><span class="n">mask_var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined_mask</span>

        <span class="n">n_total</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">combined_mask</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">n_removed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="o">~</span><span class="n">combined_mask</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;filter_chain&quot;</span><span class="p">:</span> <span class="n">filter_names</span><span class="p">,</span>
            <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;combined&quot;</span><span class="p">,</span>
            <span class="s2">&quot;applied_to&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="p">,</span>
            <span class="s2">&quot;n_total&quot;</span><span class="p">:</span> <span class="n">n_total</span><span class="p">,</span>
            <span class="s2">&quot;n_removed&quot;</span><span class="p">:</span> <span class="n">n_removed</span><span class="p">,</span>
            <span class="s2">&quot;fraction_removed&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">n_removed</span> <span class="o">/</span> <span class="n">n_total</span><span class="p">),</span>
            <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s2">&quot;filters&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="n">fname</span><span class="p">:</span> <span class="n">params</span> <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">params</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">filter_names</span><span class="p">,</span> <span class="n">all_params</span><span class="p">)</span>
            <span class="p">},</span>
        <span class="p">}</span>

        <span class="n">ds_out</span><span class="p">[</span><span class="n">filtered_var_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">metadata</span>
        <span class="n">ds_out</span><span class="p">[</span><span class="n">mask_var_name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">metadata</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown mode: </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ds_out</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.FilterPipeline.summary" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">summary</span><span class="p">()</span></code>

<a href="#canvod.grids.analysis.FilterPipeline.summary" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Return a human-readable summary of the pipeline.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/filtering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a human-readable summary of the pipeline.&quot;&quot;&quot;</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Filter Pipeline for &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">&#39;:&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">filter_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">):</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">filter_obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;   - </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="canvod.grids.analysis.IQRFilter" class="doc doc-heading">
            <code>IQRFilter</code>


<a href="#canvod.grids.analysis.IQRFilter" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="canvod.grids.analysis.filtering.Filter">Filter</span></code></p>



        <p>Remove outliers using Interquartile Range method.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/filtering.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">IQRFilter</span><span class="p">(</span><span class="n">Filter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove outliers using Interquartile Range method.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the filter.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;iqr&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span> <span class="n">factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute IQR mask.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : xr.DataArray</span>
<span class="sd">            Input data.</span>
<span class="sd">        factor : float</span>
<span class="sd">            IQR factor (default: 1.5).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xr.DataArray</span>
<span class="sd">            Boolean mask (True = keep).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">Array</span><span class="p">):</span>
            <span class="n">flat_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="n">q1_val</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">flat_data</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="n">q3_val</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">flat_data</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

            <span class="n">iqr</span> <span class="o">=</span> <span class="n">q3_val</span> <span class="o">-</span> <span class="n">q1_val</span>
            <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">q1_val</span> <span class="o">-</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">iqr</span>
            <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">q3_val</span> <span class="o">+</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">iqr</span>

            <span class="n">mask_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;=</span> <span class="n">lower_bound</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;=</span> <span class="n">upper_bound</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mask_data</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">q1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">q3</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">iqr</span> <span class="o">=</span> <span class="n">q3</span> <span class="o">-</span> <span class="n">q1</span>

            <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">q1</span> <span class="o">-</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">iqr</span>
            <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">q3</span> <span class="o">+</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">iqr</span>

            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;=</span> <span class="n">lower_bound</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;=</span> <span class="n">upper_bound</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mask</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.IQRFilter.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">()</span></code>

<a href="#canvod.grids.analysis.IQRFilter.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the filter.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/filtering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the filter.&quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;iqr&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.IQRFilter.compute_mask" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_mask</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.IQRFilter.compute_mask" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Compute IQR mask.</p>
<h5 id="canvod.grids.analysis.IQRFilter.compute_mask--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.IQRFilter.compute_mask--parameters" title="Permanent link">&para;</a></h5>
<p>data : xr.DataArray
    Input data.
factor : float
    IQR factor (default: 1.5).</p>
<h5 id="canvod.grids.analysis.IQRFilter.compute_mask--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.IQRFilter.compute_mask--returns" title="Permanent link">&para;</a></h5>
<p>xr.DataArray
    Boolean mask (True = keep).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/filtering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span> <span class="n">factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute IQR mask.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : xr.DataArray</span>
<span class="sd">        Input data.</span>
<span class="sd">    factor : float</span>
<span class="sd">        IQR factor (default: 1.5).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xr.DataArray</span>
<span class="sd">        Boolean mask (True = keep).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">Array</span><span class="p">):</span>
        <span class="n">flat_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">q1_val</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">flat_data</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="n">q3_val</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">flat_data</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

        <span class="n">iqr</span> <span class="o">=</span> <span class="n">q3_val</span> <span class="o">-</span> <span class="n">q1_val</span>
        <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">q1_val</span> <span class="o">-</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">iqr</span>
        <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">q3_val</span> <span class="o">+</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">iqr</span>

        <span class="n">mask_data</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;=</span> <span class="n">lower_bound</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;=</span> <span class="n">upper_bound</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mask_data</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">q1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">q3</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">iqr</span> <span class="o">=</span> <span class="n">q3</span> <span class="o">-</span> <span class="n">q1</span>

        <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">q1</span> <span class="o">-</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">iqr</span>
        <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">q3</span> <span class="o">+</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">iqr</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&gt;=</span> <span class="n">lower_bound</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;=</span> <span class="n">upper_bound</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mask</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="canvod.grids.analysis.ZScoreFilter" class="doc doc-heading">
            <code>ZScoreFilter</code>


<a href="#canvod.grids.analysis.ZScoreFilter" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="canvod.grids.analysis.filtering.Filter">Filter</span></code></p>



        <p>Remove statistical outliers using z-score method.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/filtering.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ZScoreFilter</span><span class="p">(</span><span class="n">Filter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove statistical outliers using z-score method.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the filter.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;zscore&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute z-score mask.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : xr.DataArray</span>
<span class="sd">            Input data.</span>
<span class="sd">        threshold : float</span>
<span class="sd">            Z-score threshold (default: 3.0).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xr.DataArray</span>
<span class="sd">            Boolean mask (True = keep).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">Array</span><span class="p">):</span>
            <span class="n">mean</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="n">std</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
            <span class="n">z_scores</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">fabs</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span><span class="p">)</span>
            <span class="n">mask_data</span> <span class="o">=</span> <span class="n">z_scores</span> <span class="o">&lt;=</span> <span class="n">threshold</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mask_data</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mean</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">std</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">z_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">data</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">z_scores</span> <span class="o">&lt;=</span> <span class="n">threshold</span>

        <span class="k">return</span> <span class="n">mask</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.ZScoreFilter.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">()</span></code>

<a href="#canvod.grids.analysis.ZScoreFilter.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the filter.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/filtering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the filter.&quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;zscore&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.ZScoreFilter.compute_mask" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_mask</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.ZScoreFilter.compute_mask" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Compute z-score mask.</p>
<h5 id="canvod.grids.analysis.ZScoreFilter.compute_mask--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.ZScoreFilter.compute_mask--parameters" title="Permanent link">&para;</a></h5>
<p>data : xr.DataArray
    Input data.
threshold : float
    Z-score threshold (default: 3.0).</p>
<h5 id="canvod.grids.analysis.ZScoreFilter.compute_mask--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.ZScoreFilter.compute_mask--returns" title="Permanent link">&para;</a></h5>
<p>xr.DataArray
    Boolean mask (True = keep).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/filtering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute z-score mask.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : xr.DataArray</span>
<span class="sd">        Input data.</span>
<span class="sd">    threshold : float</span>
<span class="sd">        Z-score threshold (default: 3.0).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xr.DataArray</span>
<span class="sd">        Boolean mask (True = keep).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">Array</span><span class="p">):</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="n">z_scores</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">fabs</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">data</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span><span class="p">)</span>
        <span class="n">mask_data</span> <span class="o">=</span> <span class="n">z_scores</span> <span class="o">&lt;=</span> <span class="n">threshold</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mask_data</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">z_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">data</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">z_scores</span> <span class="o">&lt;=</span> <span class="n">threshold</span>

    <span class="k">return</span> <span class="n">mask</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="canvod.grids.analysis.SpatialMask" class="doc doc-heading">
            <code>SpatialMask</code>


<a href="#canvod.grids.analysis.SpatialMask" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">



        <p>Create spatial masks for grid cells.</p>
<p>Masks are boolean arrays where <code>True</code> = include cell,
<code>False</code> = exclude cell.  Multiple constraints can be combined
with AND or OR logic.</p>
<h4 id="canvod.grids.analysis.SpatialMask--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.SpatialMask--parameters" title="Permanent link">&para;</a></h4>
<p>grid : GridData
    Grid instance.</p>
<h4 id="canvod.grids.analysis.SpatialMask--examples">Examples<a class="headerlink" href="#canvod.grids.analysis.SpatialMask--examples" title="Permanent link">&para;</a></h4>
<blockquote>
<blockquote>
<blockquote>
<p>mask = SpatialMask(grid)
mask.add_phi_range(0, np.pi)          # Northern hemisphere
mask.add_theta_range(0, np.pi / 3)    # Exclude low elevations
mask.add_quality_threshold('mean_snr', min_value=40)
spatial_mask = mask.compute()          # Returns boolean array</p>
</blockquote>
</blockquote>
</blockquote>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/masking.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SpatialMask</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create spatial masks for grid cells.</span>

<span class="sd">    Masks are boolean arrays where ``True`` = include cell,</span>
<span class="sd">    ``False`` = exclude cell.  Multiple constraints can be combined</span>
<span class="sd">    with AND or OR logic.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    grid : GridData</span>
<span class="sd">        Grid instance.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; mask = SpatialMask(grid)</span>
<span class="sd">    &gt;&gt;&gt; mask.add_phi_range(0, np.pi)          # Northern hemisphere</span>
<span class="sd">    &gt;&gt;&gt; mask.add_theta_range(0, np.pi / 3)    # Exclude low elevations</span>
<span class="sd">    &gt;&gt;&gt; mask.add_quality_threshold(&#39;mean_snr&#39;, min_value=40)</span>
<span class="sd">    &gt;&gt;&gt; spatial_mask = mask.compute()          # Returns boolean array</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid</span><span class="p">:</span> <span class="n">GridData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the spatial mask builder.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        grid : GridData</span>
<span class="sd">            Grid instance.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_grid_df</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">grid</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Constraint builders</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_phi_range</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">phi_min</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">phi_max</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">degrees</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpatialMask</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add azimuth angle constraint.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        phi_min : float</span>
<span class="sd">            Minimum azimuth angle.</span>
<span class="sd">        phi_max : float</span>
<span class="sd">            Maximum azimuth angle.</span>
<span class="sd">        degrees : bool</span>
<span class="sd">            If ``True``, angles are in degrees; otherwise radians.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        SpatialMask</span>
<span class="sd">            Self for chaining.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Handles wraparound at 0Â°/360Â° correctly.</span>
<span class="sd">        Example: ``phi_range(350, 10)`` includes both 350Â°â360Â° and 0Â°â10Â°.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">degrees</span><span class="p">:</span>
            <span class="n">phi_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">phi_min</span><span class="p">)</span>
            <span class="n">phi_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">phi_max</span><span class="p">)</span>

        <span class="n">phi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid_df</span><span class="p">[</span><span class="s2">&quot;phi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="c1"># Normalise to [0, 2Ï)</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">phi_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">phi_min</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="n">phi_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">phi_max</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">phi_min</span> <span class="o">&lt;=</span> <span class="n">phi_max</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">phi</span> <span class="o">&gt;=</span> <span class="n">phi_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">phi</span> <span class="o">&lt;=</span> <span class="n">phi_max</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Wraparound: e.g. 350Â° to 10Â°</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">phi</span> <span class="o">&gt;=</span> <span class="n">phi_min</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">phi</span> <span class="o">&lt;=</span> <span class="n">phi_max</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;phi_range&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_theta_range</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">theta_min</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">theta_max</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">degrees</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpatialMask</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add polar angle (zenith angle) constraint.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        theta_min : float</span>
<span class="sd">            Minimum polar angle (0 = zenith).</span>
<span class="sd">        theta_max : float</span>
<span class="sd">            Maximum polar angle (Ï/2 = horizon).</span>
<span class="sd">        degrees : bool</span>
<span class="sd">            If ``True``, angles are in degrees; otherwise radians.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        SpatialMask</span>
<span class="sd">            Self for chaining.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        ``theta = 0Â°`` is zenith (straight up), ``theta = 90Â°`` is horizon.</span>
<span class="sd">        To exclude low elevations, use ``theta_max &lt; 90Â°``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">degrees</span><span class="p">:</span>
            <span class="n">theta_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">theta_min</span><span class="p">)</span>
            <span class="n">theta_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">theta_max</span><span class="p">)</span>

        <span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid_df</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">theta</span> <span class="o">&gt;=</span> <span class="n">theta_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">theta</span> <span class="o">&lt;=</span> <span class="n">theta_max</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;theta_range&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_elevation_range</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">elev_min</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">elev_max</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">degrees</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpatialMask</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add elevation angle constraint (complementary to theta).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        elev_min : float</span>
<span class="sd">            Minimum elevation angle (0 = horizon, 90 = zenith).</span>
<span class="sd">        elev_max : float</span>
<span class="sd">            Maximum elevation angle.</span>
<span class="sd">        degrees : bool</span>
<span class="sd">            If ``True``, angles are in degrees; otherwise radians.</span>
<span class="sd">            Default: ``True``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        SpatialMask</span>
<span class="sd">            Self for chaining.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        ``elevation = 90Â° â theta``.  This is more intuitive for users</span>
<span class="sd">        who think in elevation angles.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">degrees</span><span class="p">:</span>
            <span class="n">elev_min_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">elev_min</span><span class="p">)</span>
            <span class="n">elev_max_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">elev_max</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">elev_min_rad</span> <span class="o">=</span> <span class="n">elev_min</span>
            <span class="n">elev_max_rad</span> <span class="o">=</span> <span class="n">elev_max</span>

        <span class="c1"># Convert elevation â theta: theta = Ï/2 â elevation</span>
        <span class="n">theta_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">elev_min_rad</span>
        <span class="n">theta_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">elev_max_rad</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_theta_range</span><span class="p">(</span><span class="n">theta_min</span><span class="p">,</span> <span class="n">theta_max</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_cell_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpatialMask</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Include specific cell IDs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cell_ids : list[int] or np.ndarray</span>
<span class="sd">            Cell IDs to include.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        SpatialMask</span>
<span class="sd">            Self for chaining.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">cell_ids</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;cell_ids&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_exclude_cell_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpatialMask</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Exclude specific cell IDs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cell_ids : list[int] or np.ndarray</span>
<span class="sd">            Cell IDs to exclude.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        SpatialMask</span>
<span class="sd">            Self for chaining.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">cell_ids</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;exclude_cell_ids&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_quality_threshold</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">min_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpatialMask</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add data quality threshold based on grid cell properties.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        var_name : str</span>
<span class="sd">            Variable name in grid (e.g. ``&#39;mean_snr&#39;``,</span>
<span class="sd">            ``&#39;n_observations&#39;``).</span>
<span class="sd">        min_value : float, optional</span>
<span class="sd">            Minimum allowed value.</span>
<span class="sd">        max_value : float, optional</span>
<span class="sd">            Maximum allowed value.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        SpatialMask</span>
<span class="sd">            Self for chaining.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If *var_name* doesn&#39;t exist in the grid DataFrame.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">var_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">available</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_grid_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Variable &#39;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">&#39; not found in grid. Available: </span><span class="si">{</span><span class="n">available</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid_df</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">min_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">values</span> <span class="o">&gt;=</span> <span class="n">min_value</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">values</span> <span class="o">&lt;=</span> <span class="n">max_value</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">_threshold&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_boundary_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exclude</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpatialMask</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Include or exclude boundary cells.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        exclude : bool</span>
<span class="sd">            If ``True``, exclude boundary cells; if ``False``, include</span>
<span class="sd">            only boundary cells.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        SpatialMask</span>
<span class="sd">            Self for chaining.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the grid does not have an ``&#39;is_boundary&#39;`` column.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Only works if the grid DataFrame contains an ``&#39;is_boundary&#39;``</span>
<span class="sd">        column.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;is_boundary&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Grid does not have &#39;is_boundary&#39; information&quot;</span><span class="p">)</span>

        <span class="n">is_boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid_df</span><span class="p">[</span><span class="s2">&quot;is_boundary&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">is_boundary</span> <span class="k">if</span> <span class="n">exclude</span> <span class="k">else</span> <span class="n">is_boundary</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;boundary_cells&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_custom_mask</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="n">Callable</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;custom&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpatialMask</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add custom mask or mask-generating callable.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mask : np.ndarray or callable</span>
<span class="sd">            * If array: boolean mask of shape ``(ncells,)``.</span>
<span class="sd">            * If callable: function ``(grid: GridData) -&gt; np.ndarray``.</span>
<span class="sd">        name : str</span>
<span class="sd">            Label for this mask (used in summary).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        SpatialMask</span>
<span class="sd">            Self for chaining.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If the resulting array has wrong shape or dtype.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; custom = np.array([True, False, True, ...])</span>
<span class="sd">        &gt;&gt;&gt; mask.add_custom_mask(custom)</span>

<span class="sd">        &gt;&gt;&gt; def high_snr_north(grid):</span>
<span class="sd">        ...     snr   = grid.grid[&#39;mean_snr&#39;].to_numpy()</span>
<span class="sd">        ...     phi   = grid.grid[&#39;phi&#39;].to_numpy()</span>
<span class="sd">        ...     return (snr &gt; 40) &amp; (phi &lt; np.pi)</span>
<span class="sd">        &gt;&gt;&gt; mask.add_custom_mask(high_snr_north)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
            <span class="n">mask_array</span> <span class="o">=</span> <span class="n">mask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask_array</span> <span class="o">=</span> <span class="n">mask</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask_array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Custom mask must be numpy array or return numpy array&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mask_array</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Custom mask shape </span><span class="si">{</span><span class="n">mask_array</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> doesn&#39;t match &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;grid size (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="si">}</span><span class="s2">,)&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">mask_array</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Custom mask must be boolean dtype&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">mask_array</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_radial_sector</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">center_phi</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">sector_width</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">theta_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">theta_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">degrees</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpatialMask</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add radial sector (wedge) mask.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        center_phi : float</span>
<span class="sd">            Centre azimuth of sector.</span>
<span class="sd">        sector_width : float</span>
<span class="sd">            Full angular width of sector.</span>
<span class="sd">        theta_min : float</span>
<span class="sd">            Minimum polar angle (radial inner bound).</span>
<span class="sd">        theta_max : float</span>
<span class="sd">            Maximum polar angle (radial outer bound).</span>
<span class="sd">        degrees : bool</span>
<span class="sd">            If ``True``, all angles in degrees; otherwise radians.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        SpatialMask</span>
<span class="sd">            Self for chaining.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; # Northern sector, 30Â° wide, excluding low elevations</span>
<span class="sd">        &gt;&gt;&gt; mask.add_radial_sector(center_phi=0, sector_width=30,</span>
<span class="sd">        ...                        theta_max=60, degrees=True)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">degrees</span><span class="p">:</span>
            <span class="n">center_phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">center_phi</span><span class="p">)</span>
            <span class="n">sector_width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">sector_width</span><span class="p">)</span>
            <span class="n">theta_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">theta_min</span><span class="p">)</span>
            <span class="n">theta_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">theta_max</span><span class="p">)</span>

        <span class="n">half_width</span> <span class="o">=</span> <span class="n">sector_width</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_phi_range</span><span class="p">(</span>
            <span class="n">center_phi</span> <span class="o">-</span> <span class="n">half_width</span><span class="p">,</span>
            <span class="n">center_phi</span> <span class="o">+</span> <span class="n">half_width</span><span class="p">,</span>
            <span class="n">degrees</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_theta_range</span><span class="p">(</span><span class="n">theta_min</span><span class="p">,</span> <span class="n">theta_max</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Computation &amp; introspection</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;AND&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute final combined boolean mask.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mode : str</span>
<span class="sd">            Combination mode:</span>

<span class="sd">            * ``&#39;AND&#39;`` â all constraints must be satisfied (intersection).</span>
<span class="sd">            * ``&#39;OR&#39;``  â at least one constraint must be satisfied (union).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Boolean array of shape ``(ncells,)`` where ``True`` = include.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If no masks have been added or *mode* is unknown.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No masks added. Use add_* methods before compute()&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;AND&quot;</span><span class="p">:</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_name</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span>
                <span class="n">combined</span> <span class="o">=</span> <span class="n">combined</span> <span class="o">&amp;</span> <span class="n">mask</span>
        <span class="k">elif</span> <span class="n">mode</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;OR&quot;</span><span class="p">:</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_name</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span>
                <span class="n">combined</span> <span class="o">=</span> <span class="n">combined</span> <span class="o">|</span> <span class="n">mask</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown mode: </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">. Use &#39;AND&#39; or &#39;OR&#39;&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">combined</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_mask_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get summary of all added masks.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary with mask names and per-mask / combined cell counts.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">summary</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;total_cells&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span> <span class="s2">&quot;masks&quot;</span><span class="p">:</span> <span class="p">[]}</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span>
            <span class="n">n_included</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;masks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                    <span class="s2">&quot;n_cells_included&quot;</span><span class="p">:</span> <span class="n">n_included</span><span class="p">,</span>
                    <span class="s2">&quot;fraction_included&quot;</span><span class="p">:</span> <span class="n">n_included</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span>
            <span class="n">combined_and</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;AND&quot;</span><span class="p">)</span>
            <span class="n">combined_or</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;OR&quot;</span><span class="p">)</span>
            <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;combined&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;AND&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;n_cells&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">combined_and</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span>
                    <span class="s2">&quot;fraction&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">combined_and</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">),</span>
                <span class="p">},</span>
                <span class="s2">&quot;OR&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;n_cells&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">combined_or</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span>
                    <span class="s2">&quot;fraction&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">combined_or</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">),</span>
                <span class="p">},</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="n">summary</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpatialMask</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear all masks.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        SpatialMask</span>
<span class="sd">            Self for chaining.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the developer-facing representation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            Representation string.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mask_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;SpatialMask(grid=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">grid_type</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;n_masks=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">)</span><span class="si">}</span><span class="s2">, masks=</span><span class="si">{</span><span class="n">mask_names</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.SpatialMask.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.SpatialMask.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the spatial mask builder.</p>
<h5 id="canvod.grids.analysis.SpatialMask.__init__--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.__init__--parameters" title="Permanent link">&para;</a></h5>
<p>grid : GridData
    Grid instance.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/masking.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid</span><span class="p">:</span> <span class="n">GridData</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the spatial mask builder.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    grid : GridData</span>
<span class="sd">        Grid instance.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_grid_df</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">grid</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.SpatialMask.add_phi_range" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_phi_range</span><span class="p">(</span><span class="n">phi_min</span><span class="p">,</span> <span class="n">phi_max</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.SpatialMask.add_phi_range" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Add azimuth angle constraint.</p>
<h5 id="canvod.grids.analysis.SpatialMask.add_phi_range--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.add_phi_range--parameters" title="Permanent link">&para;</a></h5>
<p>phi_min : float
    Minimum azimuth angle.
phi_max : float
    Maximum azimuth angle.
degrees : bool
    If <code>True</code>, angles are in degrees; otherwise radians.</p>
<h5 id="canvod.grids.analysis.SpatialMask.add_phi_range--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.add_phi_range--returns" title="Permanent link">&para;</a></h5>
<p>SpatialMask
    Self for chaining.</p>
<h5 id="canvod.grids.analysis.SpatialMask.add_phi_range--notes">Notes<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.add_phi_range--notes" title="Permanent link">&para;</a></h5>
<p>Handles wraparound at 0Â°/360Â° correctly.
Example: <code>phi_range(350, 10)</code> includes both 350Â°â360Â° and 0Â°â10Â°.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/masking.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_phi_range</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">phi_min</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">phi_max</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">degrees</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpatialMask</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add azimuth angle constraint.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    phi_min : float</span>
<span class="sd">        Minimum azimuth angle.</span>
<span class="sd">    phi_max : float</span>
<span class="sd">        Maximum azimuth angle.</span>
<span class="sd">    degrees : bool</span>
<span class="sd">        If ``True``, angles are in degrees; otherwise radians.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    SpatialMask</span>
<span class="sd">        Self for chaining.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Handles wraparound at 0Â°/360Â° correctly.</span>
<span class="sd">    Example: ``phi_range(350, 10)`` includes both 350Â°â360Â° and 0Â°â10Â°.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">degrees</span><span class="p">:</span>
        <span class="n">phi_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">phi_min</span><span class="p">)</span>
        <span class="n">phi_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">phi_max</span><span class="p">)</span>

    <span class="n">phi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid_df</span><span class="p">[</span><span class="s2">&quot;phi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

    <span class="c1"># Normalise to [0, 2Ï)</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="n">phi_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">phi_min</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    <span class="n">phi_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">phi_max</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">phi_min</span> <span class="o">&lt;=</span> <span class="n">phi_max</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">phi</span> <span class="o">&gt;=</span> <span class="n">phi_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">phi</span> <span class="o">&lt;=</span> <span class="n">phi_max</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Wraparound: e.g. 350Â° to 10Â°</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">phi</span> <span class="o">&gt;=</span> <span class="n">phi_min</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">phi</span> <span class="o">&lt;=</span> <span class="n">phi_max</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;phi_range&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.SpatialMask.add_theta_range" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_theta_range</span><span class="p">(</span><span class="n">theta_min</span><span class="p">,</span> <span class="n">theta_max</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.SpatialMask.add_theta_range" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Add polar angle (zenith angle) constraint.</p>
<h5 id="canvod.grids.analysis.SpatialMask.add_theta_range--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.add_theta_range--parameters" title="Permanent link">&para;</a></h5>
<p>theta_min : float
    Minimum polar angle (0 = zenith).
theta_max : float
    Maximum polar angle (Ï/2 = horizon).
degrees : bool
    If <code>True</code>, angles are in degrees; otherwise radians.</p>
<h5 id="canvod.grids.analysis.SpatialMask.add_theta_range--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.add_theta_range--returns" title="Permanent link">&para;</a></h5>
<p>SpatialMask
    Self for chaining.</p>
<h5 id="canvod.grids.analysis.SpatialMask.add_theta_range--notes">Notes<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.add_theta_range--notes" title="Permanent link">&para;</a></h5>
<p><code>theta = 0Â°</code> is zenith (straight up), <code>theta = 90Â°</code> is horizon.
To exclude low elevations, use <code>theta_max &lt; 90Â°</code>.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/masking.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_theta_range</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">theta_min</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">theta_max</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">degrees</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpatialMask</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add polar angle (zenith angle) constraint.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    theta_min : float</span>
<span class="sd">        Minimum polar angle (0 = zenith).</span>
<span class="sd">    theta_max : float</span>
<span class="sd">        Maximum polar angle (Ï/2 = horizon).</span>
<span class="sd">    degrees : bool</span>
<span class="sd">        If ``True``, angles are in degrees; otherwise radians.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    SpatialMask</span>
<span class="sd">        Self for chaining.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    ``theta = 0Â°`` is zenith (straight up), ``theta = 90Â°`` is horizon.</span>
<span class="sd">    To exclude low elevations, use ``theta_max &lt; 90Â°``.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">degrees</span><span class="p">:</span>
        <span class="n">theta_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">theta_min</span><span class="p">)</span>
        <span class="n">theta_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">theta_max</span><span class="p">)</span>

    <span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid_df</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">theta</span> <span class="o">&gt;=</span> <span class="n">theta_min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">theta</span> <span class="o">&lt;=</span> <span class="n">theta_max</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;theta_range&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.SpatialMask.add_elevation_range" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_elevation_range</span><span class="p">(</span><span class="n">elev_min</span><span class="p">,</span> <span class="n">elev_max</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.SpatialMask.add_elevation_range" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Add elevation angle constraint (complementary to theta).</p>
<h5 id="canvod.grids.analysis.SpatialMask.add_elevation_range--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.add_elevation_range--parameters" title="Permanent link">&para;</a></h5>
<p>elev_min : float
    Minimum elevation angle (0 = horizon, 90 = zenith).
elev_max : float
    Maximum elevation angle.
degrees : bool
    If <code>True</code>, angles are in degrees; otherwise radians.
    Default: <code>True</code>.</p>
<h5 id="canvod.grids.analysis.SpatialMask.add_elevation_range--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.add_elevation_range--returns" title="Permanent link">&para;</a></h5>
<p>SpatialMask
    Self for chaining.</p>
<h5 id="canvod.grids.analysis.SpatialMask.add_elevation_range--notes">Notes<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.add_elevation_range--notes" title="Permanent link">&para;</a></h5>
<p><code>elevation = 90Â° â theta</code>.  This is more intuitive for users
who think in elevation angles.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/masking.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_elevation_range</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">elev_min</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">elev_max</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">degrees</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpatialMask</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add elevation angle constraint (complementary to theta).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    elev_min : float</span>
<span class="sd">        Minimum elevation angle (0 = horizon, 90 = zenith).</span>
<span class="sd">    elev_max : float</span>
<span class="sd">        Maximum elevation angle.</span>
<span class="sd">    degrees : bool</span>
<span class="sd">        If ``True``, angles are in degrees; otherwise radians.</span>
<span class="sd">        Default: ``True``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    SpatialMask</span>
<span class="sd">        Self for chaining.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    ``elevation = 90Â° â theta``.  This is more intuitive for users</span>
<span class="sd">    who think in elevation angles.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">degrees</span><span class="p">:</span>
        <span class="n">elev_min_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">elev_min</span><span class="p">)</span>
        <span class="n">elev_max_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">elev_max</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">elev_min_rad</span> <span class="o">=</span> <span class="n">elev_min</span>
        <span class="n">elev_max_rad</span> <span class="o">=</span> <span class="n">elev_max</span>

    <span class="c1"># Convert elevation â theta: theta = Ï/2 â elevation</span>
    <span class="n">theta_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">elev_min_rad</span>
    <span class="n">theta_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">elev_max_rad</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_theta_range</span><span class="p">(</span><span class="n">theta_min</span><span class="p">,</span> <span class="n">theta_max</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.SpatialMask.add_cell_ids" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_cell_ids</span><span class="p">(</span><span class="n">cell_ids</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.SpatialMask.add_cell_ids" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Include specific cell IDs.</p>
<h5 id="canvod.grids.analysis.SpatialMask.add_cell_ids--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.add_cell_ids--parameters" title="Permanent link">&para;</a></h5>
<p>cell_ids : list[int] or np.ndarray
    Cell IDs to include.</p>
<h5 id="canvod.grids.analysis.SpatialMask.add_cell_ids--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.add_cell_ids--returns" title="Permanent link">&para;</a></h5>
<p>SpatialMask
    Self for chaining.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/masking.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_cell_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpatialMask</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Include specific cell IDs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cell_ids : list[int] or np.ndarray</span>
<span class="sd">        Cell IDs to include.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    SpatialMask</span>
<span class="sd">        Self for chaining.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">mask</span><span class="p">[</span><span class="n">cell_ids</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;cell_ids&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.SpatialMask.add_exclude_cell_ids" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_exclude_cell_ids</span><span class="p">(</span><span class="n">cell_ids</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.SpatialMask.add_exclude_cell_ids" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Exclude specific cell IDs.</p>
<h5 id="canvod.grids.analysis.SpatialMask.add_exclude_cell_ids--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.add_exclude_cell_ids--parameters" title="Permanent link">&para;</a></h5>
<p>cell_ids : list[int] or np.ndarray
    Cell IDs to exclude.</p>
<h5 id="canvod.grids.analysis.SpatialMask.add_exclude_cell_ids--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.add_exclude_cell_ids--returns" title="Permanent link">&para;</a></h5>
<p>SpatialMask
    Self for chaining.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/masking.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_exclude_cell_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpatialMask</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exclude specific cell IDs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cell_ids : list[int] or np.ndarray</span>
<span class="sd">        Cell IDs to exclude.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    SpatialMask</span>
<span class="sd">        Self for chaining.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">mask</span><span class="p">[</span><span class="n">cell_ids</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;exclude_cell_ids&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.SpatialMask.add_quality_threshold" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_quality_threshold</span><span class="p">(</span><span class="n">var_name</span><span class="p">,</span> <span class="n">min_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_value</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.SpatialMask.add_quality_threshold" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Add data quality threshold based on grid cell properties.</p>
<h5 id="canvod.grids.analysis.SpatialMask.add_quality_threshold--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.add_quality_threshold--parameters" title="Permanent link">&para;</a></h5>
<p>var_name : str
    Variable name in grid (e.g. <code>'mean_snr'</code>,
    <code>'n_observations'</code>).
min_value : float, optional
    Minimum allowed value.
max_value : float, optional
    Maximum allowed value.</p>
<h5 id="canvod.grids.analysis.SpatialMask.add_quality_threshold--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.add_quality_threshold--returns" title="Permanent link">&para;</a></h5>
<p>SpatialMask
    Self for chaining.</p>
<h5 id="canvod.grids.analysis.SpatialMask.add_quality_threshold--raises">Raises<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.add_quality_threshold--raises" title="Permanent link">&para;</a></h5>
<p>ValueError
    If <em>var_name</em> doesn't exist in the grid DataFrame.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/masking.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_quality_threshold</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">min_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">max_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpatialMask</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add data quality threshold based on grid cell properties.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    var_name : str</span>
<span class="sd">        Variable name in grid (e.g. ``&#39;mean_snr&#39;``,</span>
<span class="sd">        ``&#39;n_observations&#39;``).</span>
<span class="sd">    min_value : float, optional</span>
<span class="sd">        Minimum allowed value.</span>
<span class="sd">    max_value : float, optional</span>
<span class="sd">        Maximum allowed value.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    SpatialMask</span>
<span class="sd">        Self for chaining.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If *var_name* doesn&#39;t exist in the grid DataFrame.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">var_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="n">available</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_grid_df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Variable &#39;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">&#39; not found in grid. Available: </span><span class="si">{</span><span class="n">available</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid_df</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">min_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">values</span> <span class="o">&gt;=</span> <span class="n">min_value</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">max_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">values</span> <span class="o">&lt;=</span> <span class="n">max_value</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">_threshold&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.SpatialMask.add_boundary_cells" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_boundary_cells</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.SpatialMask.add_boundary_cells" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Include or exclude boundary cells.</p>
<h5 id="canvod.grids.analysis.SpatialMask.add_boundary_cells--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.add_boundary_cells--parameters" title="Permanent link">&para;</a></h5>
<p>exclude : bool
    If <code>True</code>, exclude boundary cells; if <code>False</code>, include
    only boundary cells.</p>
<h5 id="canvod.grids.analysis.SpatialMask.add_boundary_cells--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.add_boundary_cells--returns" title="Permanent link">&para;</a></h5>
<p>SpatialMask
    Self for chaining.</p>
<h5 id="canvod.grids.analysis.SpatialMask.add_boundary_cells--raises">Raises<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.add_boundary_cells--raises" title="Permanent link">&para;</a></h5>
<p>ValueError
    If the grid does not have an <code>'is_boundary'</code> column.</p>
<h5 id="canvod.grids.analysis.SpatialMask.add_boundary_cells--notes">Notes<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.add_boundary_cells--notes" title="Permanent link">&para;</a></h5>
<p>Only works if the grid DataFrame contains an <code>'is_boundary'</code>
column.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/masking.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_boundary_cells</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exclude</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpatialMask</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Include or exclude boundary cells.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    exclude : bool</span>
<span class="sd">        If ``True``, exclude boundary cells; if ``False``, include</span>
<span class="sd">        only boundary cells.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    SpatialMask</span>
<span class="sd">        Self for chaining.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the grid does not have an ``&#39;is_boundary&#39;`` column.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Only works if the grid DataFrame contains an ``&#39;is_boundary&#39;``</span>
<span class="sd">    column.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="s2">&quot;is_boundary&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Grid does not have &#39;is_boundary&#39; information&quot;</span><span class="p">)</span>

    <span class="n">is_boundary</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid_df</span><span class="p">[</span><span class="s2">&quot;is_boundary&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">is_boundary</span> <span class="k">if</span> <span class="n">exclude</span> <span class="k">else</span> <span class="n">is_boundary</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s2">&quot;boundary_cells&quot;</span><span class="p">,</span> <span class="n">mask</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.SpatialMask.add_custom_mask" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_custom_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;custom&#39;</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.SpatialMask.add_custom_mask" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Add custom mask or mask-generating callable.</p>
<h5 id="canvod.grids.analysis.SpatialMask.add_custom_mask--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.add_custom_mask--parameters" title="Permanent link">&para;</a></h5>
<p>mask : np.ndarray or callable
    * If array: boolean mask of shape <code>(ncells,)</code>.
    * If callable: function <code>(grid: GridData) -&gt; np.ndarray</code>.
name : str
    Label for this mask (used in summary).</p>
<h5 id="canvod.grids.analysis.SpatialMask.add_custom_mask--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.add_custom_mask--returns" title="Permanent link">&para;</a></h5>
<p>SpatialMask
    Self for chaining.</p>
<h5 id="canvod.grids.analysis.SpatialMask.add_custom_mask--raises">Raises<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.add_custom_mask--raises" title="Permanent link">&para;</a></h5>
<p>ValueError
    If the resulting array has wrong shape or dtype.</p>
<h5 id="canvod.grids.analysis.SpatialMask.add_custom_mask--examples">Examples<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.add_custom_mask--examples" title="Permanent link">&para;</a></h5>
<blockquote>
<blockquote>
<blockquote>
<p>custom = np.array([True, False, True, ...])
mask.add_custom_mask(custom)</p>
<p>def high_snr_north(grid):
...     snr   = grid.grid['mean_snr'].to_numpy()
...     phi   = grid.grid['phi'].to_numpy()
...     return (snr &gt; 40) &amp; (phi &lt; np.pi)
mask.add_custom_mask(high_snr_north)</p>
</blockquote>
</blockquote>
</blockquote>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/masking.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_custom_mask</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="n">Callable</span><span class="p">,</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;custom&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpatialMask</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add custom mask or mask-generating callable.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mask : np.ndarray or callable</span>
<span class="sd">        * If array: boolean mask of shape ``(ncells,)``.</span>
<span class="sd">        * If callable: function ``(grid: GridData) -&gt; np.ndarray``.</span>
<span class="sd">    name : str</span>
<span class="sd">        Label for this mask (used in summary).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    SpatialMask</span>
<span class="sd">        Self for chaining.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the resulting array has wrong shape or dtype.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; custom = np.array([True, False, True, ...])</span>
<span class="sd">    &gt;&gt;&gt; mask.add_custom_mask(custom)</span>

<span class="sd">    &gt;&gt;&gt; def high_snr_north(grid):</span>
<span class="sd">    ...     snr   = grid.grid[&#39;mean_snr&#39;].to_numpy()</span>
<span class="sd">    ...     phi   = grid.grid[&#39;phi&#39;].to_numpy()</span>
<span class="sd">    ...     return (snr &gt; 40) &amp; (phi &lt; np.pi)</span>
<span class="sd">    &gt;&gt;&gt; mask.add_custom_mask(high_snr_north)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
        <span class="n">mask_array</span> <span class="o">=</span> <span class="n">mask</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mask_array</span> <span class="o">=</span> <span class="n">mask</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mask_array</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Custom mask must be numpy array or return numpy array&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mask_array</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Custom mask shape </span><span class="si">{</span><span class="n">mask_array</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> doesn&#39;t match &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;grid size (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="si">}</span><span class="s2">,)&quot;</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">mask_array</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Custom mask must be boolean dtype&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="n">mask_array</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.SpatialMask.add_radial_sector" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_radial_sector</span><span class="p">(</span><span class="n">center_phi</span><span class="p">,</span> <span class="n">sector_width</span><span class="p">,</span> <span class="n">theta_min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">theta_max</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.SpatialMask.add_radial_sector" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Add radial sector (wedge) mask.</p>
<h5 id="canvod.grids.analysis.SpatialMask.add_radial_sector--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.add_radial_sector--parameters" title="Permanent link">&para;</a></h5>
<p>center_phi : float
    Centre azimuth of sector.
sector_width : float
    Full angular width of sector.
theta_min : float
    Minimum polar angle (radial inner bound).
theta_max : float
    Maximum polar angle (radial outer bound).
degrees : bool
    If <code>True</code>, all angles in degrees; otherwise radians.</p>
<h5 id="canvod.grids.analysis.SpatialMask.add_radial_sector--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.add_radial_sector--returns" title="Permanent link">&para;</a></h5>
<p>SpatialMask
    Self for chaining.</p>
<h5 id="canvod.grids.analysis.SpatialMask.add_radial_sector--examples">Examples<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.add_radial_sector--examples" title="Permanent link">&para;</a></h5>
<blockquote>
<blockquote>
<blockquote>
<h4 id="canvod.grids.analysis.SpatialMask.add_radial_sector--northern-sector-30-wide-excluding-low-elevations">Northern sector, 30Â° wide, excluding low elevations<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.add_radial_sector--northern-sector-30-wide-excluding-low-elevations" title="Permanent link">&para;</a></h4>
<p>mask.add_radial_sector(center_phi=0, sector_width=30,
...                        theta_max=60, degrees=True)</p>
</blockquote>
</blockquote>
</blockquote>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/masking.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_radial_sector</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">center_phi</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">sector_width</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">theta_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">theta_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">degrees</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpatialMask</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add radial sector (wedge) mask.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    center_phi : float</span>
<span class="sd">        Centre azimuth of sector.</span>
<span class="sd">    sector_width : float</span>
<span class="sd">        Full angular width of sector.</span>
<span class="sd">    theta_min : float</span>
<span class="sd">        Minimum polar angle (radial inner bound).</span>
<span class="sd">    theta_max : float</span>
<span class="sd">        Maximum polar angle (radial outer bound).</span>
<span class="sd">    degrees : bool</span>
<span class="sd">        If ``True``, all angles in degrees; otherwise radians.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    SpatialMask</span>
<span class="sd">        Self for chaining.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; # Northern sector, 30Â° wide, excluding low elevations</span>
<span class="sd">    &gt;&gt;&gt; mask.add_radial_sector(center_phi=0, sector_width=30,</span>
<span class="sd">    ...                        theta_max=60, degrees=True)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">degrees</span><span class="p">:</span>
        <span class="n">center_phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">center_phi</span><span class="p">)</span>
        <span class="n">sector_width</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">sector_width</span><span class="p">)</span>
        <span class="n">theta_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">theta_min</span><span class="p">)</span>
        <span class="n">theta_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">theta_max</span><span class="p">)</span>

    <span class="n">half_width</span> <span class="o">=</span> <span class="n">sector_width</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_phi_range</span><span class="p">(</span>
        <span class="n">center_phi</span> <span class="o">-</span> <span class="n">half_width</span><span class="p">,</span>
        <span class="n">center_phi</span> <span class="o">+</span> <span class="n">half_width</span><span class="p">,</span>
        <span class="n">degrees</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_theta_range</span><span class="p">(</span><span class="n">theta_min</span><span class="p">,</span> <span class="n">theta_max</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.SpatialMask.compute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;AND&#39;</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.SpatialMask.compute" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Compute final combined boolean mask.</p>
<h5 id="canvod.grids.analysis.SpatialMask.compute--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.compute--parameters" title="Permanent link">&para;</a></h5>
<p>mode : str
    Combination mode:</p>
<div class="highlight"><pre><span></span><code>* ``&#39;AND&#39;`` â all constraints must be satisfied (intersection).
* ``&#39;OR&#39;``  â at least one constraint must be satisfied (union).
</code></pre></div>
<h5 id="canvod.grids.analysis.SpatialMask.compute--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.compute--returns" title="Permanent link">&para;</a></h5>
<p>np.ndarray
    Boolean array of shape <code>(ncells,)</code> where <code>True</code> = include.</p>
<h5 id="canvod.grids.analysis.SpatialMask.compute--raises">Raises<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.compute--raises" title="Permanent link">&para;</a></h5>
<p>ValueError
    If no masks have been added or <em>mode</em> is unknown.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/masking.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;AND&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute final combined boolean mask.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mode : str</span>
<span class="sd">        Combination mode:</span>

<span class="sd">        * ``&#39;AND&#39;`` â all constraints must be satisfied (intersection).</span>
<span class="sd">        * ``&#39;OR&#39;``  â at least one constraint must be satisfied (union).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Boolean array of shape ``(ncells,)`` where ``True`` = include.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If no masks have been added or *mode* is unknown.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No masks added. Use add_* methods before compute()&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mode</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;AND&quot;</span><span class="p">:</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_name</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="n">combined</span> <span class="o">&amp;</span> <span class="n">mask</span>
    <span class="k">elif</span> <span class="n">mode</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;OR&quot;</span><span class="p">:</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_name</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="n">combined</span> <span class="o">|</span> <span class="n">mask</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown mode: </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">. Use &#39;AND&#39; or &#39;OR&#39;&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">combined</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.SpatialMask.get_mask_summary" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_mask_summary</span><span class="p">()</span></code>

<a href="#canvod.grids.analysis.SpatialMask.get_mask_summary" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Get summary of all added masks.</p>
<h5 id="canvod.grids.analysis.SpatialMask.get_mask_summary--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.get_mask_summary--returns" title="Permanent link">&para;</a></h5>
<p>dict
    Dictionary with mask names and per-mask / combined cell counts.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/masking.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_mask_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get summary of all added masks.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary with mask names and per-mask / combined cell counts.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">summary</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;total_cells&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span> <span class="s2">&quot;masks&quot;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span>
        <span class="n">n_included</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;masks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;n_cells_included&quot;</span><span class="p">:</span> <span class="n">n_included</span><span class="p">,</span>
                <span class="s2">&quot;fraction_included&quot;</span><span class="p">:</span> <span class="n">n_included</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">:</span>
        <span class="n">combined_and</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;AND&quot;</span><span class="p">)</span>
        <span class="n">combined_or</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;OR&quot;</span><span class="p">)</span>
        <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;combined&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;AND&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;n_cells&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">combined_and</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span>
                <span class="s2">&quot;fraction&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">combined_and</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">),</span>
            <span class="p">},</span>
            <span class="s2">&quot;OR&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;n_cells&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">combined_or</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span>
                <span class="s2">&quot;fraction&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">combined_or</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">),</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="k">return</span> <span class="n">summary</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.SpatialMask.clear" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">clear</span><span class="p">()</span></code>

<a href="#canvod.grids.analysis.SpatialMask.clear" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Clear all masks.</p>
<h5 id="canvod.grids.analysis.SpatialMask.clear--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.clear--returns" title="Permanent link">&para;</a></h5>
<p>SpatialMask
    Self for chaining.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/masking.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">SpatialMask</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clear all masks.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    SpatialMask</span>
<span class="sd">        Self for chaining.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">masks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.SpatialMask.__repr__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__repr__</span><span class="p">()</span></code>

<a href="#canvod.grids.analysis.SpatialMask.__repr__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Return the developer-facing representation.</p>
<h5 id="canvod.grids.analysis.SpatialMask.__repr__--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.SpatialMask.__repr__--returns" title="Permanent link">&para;</a></h5>
<p>str
    Representation string.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/masking.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the developer-facing representation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Representation string.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;SpatialMask(grid=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">grid_type</span><span class="si">}</span><span class="s2">, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;n_masks=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">masks</span><span class="p">)</span><span class="si">}</span><span class="s2">, masks=</span><span class="si">{</span><span class="n">mask_names</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="canvod.grids.analysis.PerCellVODAnalyzer" class="doc doc-heading">
            <code>PerCellVODAnalyzer</code>


<a href="#canvod.grids.analysis.PerCellVODAnalyzer" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">



        <p>Multi-dataset per-cell VOD analyzer.</p>
<h4 id="canvod.grids.analysis.PerCellVODAnalyzer--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.PerCellVODAnalyzer--parameters" title="Permanent link">&para;</a></h4>
<p>datasets : xr.Dataset or list of xr.Dataset
    Per-cell dataset(s).  Each must contain <code>cell_timeseries</code>,
    <code>cell_theta</code>, and <code>cell_phi</code>.
labels : list of str or None, optional
    Human-readable labels for each dataset.</p>
<h4 id="canvod.grids.analysis.PerCellVODAnalyzer--raises">Raises<a class="headerlink" href="#canvod.grids.analysis.PerCellVODAnalyzer--raises" title="Permanent link">&para;</a></h4>
<p>ValueError
    If any dataset is missing required variables.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/per_cell_analysis.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PerCellVODAnalyzer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Multi-dataset per-cell VOD analyzer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    datasets : xr.Dataset or list of xr.Dataset</span>
<span class="sd">        Per-cell dataset(s).  Each must contain ``cell_timeseries``,</span>
<span class="sd">        ``cell_theta``, and ``cell_phi``.</span>
<span class="sd">    labels : list of str or None, optional</span>
<span class="sd">        Human-readable labels for each dataset.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If any dataset is missing required variables.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">datasets</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">],</span>
        <span class="n">labels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the analyzer.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        datasets : xr.Dataset | list[xr.Dataset]</span>
<span class="sd">            Per-cell dataset(s).</span>
<span class="sd">        labels : list[str] | None, optional</span>
<span class="sd">            Labels for each dataset.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="p">[</span><span class="n">datasets</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Dataset&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="n">datasets</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span> <span class="ow">or</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Dataset </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">))]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_datasets</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;PerCellVODAnalyzer: </span><span class="si">%d</span><span class="s2"> dataset(s), shapes=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">),</span>
            <span class="p">[</span><span class="n">ds</span><span class="o">.</span><span class="n">cell_timeseries</span><span class="o">.</span><span class="n">shape</span> <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">],</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_datasets</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Raise if any dataset is missing required variables.&quot;&quot;&quot;</span>
        <span class="n">required</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;cell_timeseries&quot;</span><span class="p">,</span> <span class="s2">&quot;cell_theta&quot;</span><span class="p">,</span> <span class="s2">&quot;cell_phi&quot;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ds</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">):</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="n">required</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dataset </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> missing variables: </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Computation helpers</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_dataset_hash</span><span class="p">(</span><span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Deterministic hash for a per-cell dataset (for optional caching).</span>

<span class="sd">        Samples up to 10 000 values from ``cell_timeseries`` for</span>
<span class="sd">        efficiency on large datasets.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parts</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">8</span><span class="p">])</span>

        <span class="n">cell_data</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">cell_timeseries</span><span class="o">.</span><span class="n">values</span>
        <span class="k">if</span> <span class="n">cell_data</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">10_000</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">cell_data</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10_000</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">cell_data</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">cell_data</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="n">valid</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">sample</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">valid</span><span class="o">.</span><span class="n">tobytes</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">8</span><span class="p">])</span>

        <span class="n">shape_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ds</span><span class="o">.</span><span class="n">cell_timeseries</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">shape_str</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">8</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()[:</span><span class="mi">16</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_diurnal_dynamics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Hourly diurnal statistics (mean, std, count) from one dataset.</span>

<span class="sd">        Uses ``cell_weights`` when available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cell_ts</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">cell_timeseries</span>
        <span class="n">hours</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">values</span>
        <span class="n">unique_hours</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">hours</span><span class="p">)</span>

        <span class="n">means</span><span class="p">,</span> <span class="n">stds</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="n">unique_hours</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">hours</span> <span class="o">==</span> <span class="n">hour</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
                <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">hour_data</span> <span class="o">=</span> <span class="n">cell_ts</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>

            <span class="k">if</span> <span class="s2">&quot;cell_weights&quot;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">cell_weights</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
                <span class="n">w_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">w_sum</span><span class="p">[</span><span class="n">w_sum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">weighted_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">hour_data</span> <span class="o">*</span> <span class="n">w</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">w_sum</span>
                <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">weighted_means</span><span class="p">)))</span>
                <span class="n">stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">weighted_means</span><span class="p">)))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">hour_data</span><span class="p">)))</span>
                <span class="n">stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">hour_data</span><span class="p">)))</span>

            <span class="n">counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">hour_data</span><span class="p">))))</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;hours&quot;</span><span class="p">:</span> <span class="n">unique_hours</span><span class="p">,</span>
            <span class="s2">&quot;means&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">means</span><span class="p">),</span>
            <span class="s2">&quot;stds&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stds</span><span class="p">),</span>
            <span class="s2">&quot;counts&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">counts</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_diurnal_dynamics_30min</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;30-minute-resolution diurnal statistics from one dataset.&quot;&quot;&quot;</span>
        <span class="n">cell_ts</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">cell_timeseries</span>
        <span class="n">hours</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">values</span>
        <span class="n">minutes</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">minute</span><span class="o">.</span><span class="n">values</span>
        <span class="n">bins_30</span> <span class="o">=</span> <span class="n">hours</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">minutes</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">unique_bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">bins_30</span><span class="p">)</span>

        <span class="n">means</span><span class="p">,</span> <span class="n">stds</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">unique_bins</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">bins_30</span> <span class="o">==</span> <span class="n">b</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
                <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bin_data</span> <span class="o">=</span> <span class="n">cell_ts</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
                <span class="k">if</span> <span class="s2">&quot;cell_weights&quot;</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span><span class="p">:</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">cell_weights</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span>
                    <span class="n">w_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">w_sum</span><span class="p">[</span><span class="n">w_sum</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">wm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">bin_data</span> <span class="o">*</span> <span class="n">w</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">w_sum</span>
                    <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">wm</span><span class="p">)))</span>
                    <span class="n">stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">wm</span><span class="p">)))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">bin_data</span><span class="p">)))</span>
                    <span class="n">stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">bin_data</span><span class="p">)))</span>
                <span class="n">counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">bin_data</span><span class="p">))))</span>

            <span class="n">h</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">30</span> <span class="k">if</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">h</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">m</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;time_bins&quot;</span><span class="p">:</span> <span class="n">unique_bins</span><span class="p">,</span>
            <span class="s2">&quot;time_labels&quot;</span><span class="p">:</span> <span class="n">labels</span><span class="p">,</span>
            <span class="s2">&quot;means&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">means</span><span class="p">),</span>
            <span class="s2">&quot;stds&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stds</span><span class="p">),</span>
            <span class="s2">&quot;counts&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">counts</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_averaged_diurnal_dynamics</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Average diurnal dynamics across all datasets.</span>

<span class="sd">        Uncertainty is propagated as Ï_avg = â(Î£Ïáµ¢Â²) / N.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">all_data</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_compute_diurnal_dynamics</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span> <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">]</span>
        <span class="n">all_hours</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;hours&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_data</span><span class="p">]</span>
        <span class="n">common</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">h</span><span class="p">)</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">all_hours</span><span class="p">]))</span>

        <span class="n">avg_means</span><span class="p">,</span> <span class="n">avg_stds</span><span class="p">,</span> <span class="n">avg_counts</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="n">common</span><span class="p">:</span>
            <span class="n">h_means</span><span class="p">,</span> <span class="n">h_stds</span><span class="p">,</span> <span class="n">h_counts</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_data</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;hours&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">hour</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
                    <span class="n">h_means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;means&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                    <span class="n">h_stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;stds&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                    <span class="n">h_counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;counts&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">h_means</span><span class="p">:</span>
                <span class="n">avg_means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">h_means</span><span class="p">))</span>
                <span class="n">avg_stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">h_stds</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">h_stds</span><span class="p">))</span>
                <span class="n">avg_counts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">h_counts</span><span class="p">)))</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;hours&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">common</span><span class="p">),</span>
            <span class="s2">&quot;means&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">avg_means</span><span class="p">),</span>
            <span class="s2">&quot;stds&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">avg_stds</span><span class="p">),</span>
            <span class="s2">&quot;counts&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">avg_counts</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_combined_diurnal_distributions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Collect all hourly value distributions across all datasets.&quot;&quot;&quot;</span>
        <span class="n">combined</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">hour</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">24</span><span class="p">):</span>
            <span class="n">vals</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">hour</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
                    <span class="n">raw</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">cell_timeseries</span><span class="p">[:,</span> <span class="n">mask</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
                    <span class="n">vals</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">raw</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">raw</span><span class="p">)]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">vals</span><span class="p">:</span>
                <span class="n">combined</span><span class="p">[</span><span class="n">hour</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span>
        <span class="k">return</span> <span class="n">combined</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_radial_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Bin mean VOD by polar angle (5Â° bins, 0â90Â°).&quot;&quot;&quot;</span>
        <span class="n">polar</span> <span class="o">=</span> <span class="mf">90.0</span> <span class="o">-</span> <span class="n">ds</span><span class="o">.</span><span class="n">cell_theta</span><span class="o">.</span><span class="n">values</span>
        <span class="n">mean_vod</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">cell_timeseries</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>

        <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
        <span class="n">centers</span> <span class="o">=</span> <span class="n">edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">2.5</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">polar</span><span class="p">,</span> <span class="n">edges</span><span class="p">)</span>

        <span class="n">binned</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">centers</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">indices</span> <span class="o">==</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">mask</span><span class="p">):</span>
                <span class="n">clean</span> <span class="o">=</span> <span class="n">mean_vod</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
                <span class="n">clean</span> <span class="o">=</span> <span class="n">clean</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">clean</span><span class="p">)]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clean</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">binned</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clean</span><span class="p">)</span>
                    <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">edges</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">edges</span><span class="p">[</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">Â°&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;binned_data&quot;</span><span class="p">:</span> <span class="n">binned</span><span class="p">,</span>
            <span class="s2">&quot;bin_labels&quot;</span><span class="p">:</span> <span class="n">labels</span><span class="p">,</span>
            <span class="s2">&quot;bin_centers&quot;</span><span class="p">:</span> <span class="n">centers</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">binned</span><span class="p">)],</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_averaged_radial_distribution</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Average radial distributions across all datasets.&quot;&quot;&quot;</span>
        <span class="n">all_radial</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_compute_radial_distribution</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span> <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">]</span>
        <span class="n">all_centers</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;bin_centers&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_radial</span><span class="p">]</span>
        <span class="n">common</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="nb">set</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">all_centers</span><span class="p">]))</span>

        <span class="n">avg_binned</span><span class="p">,</span> <span class="n">avg_labels</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">common</span><span class="p">:</span>
            <span class="n">combined</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">all_radial</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;bin_centers&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">idx</span><span class="p">):</span>
                    <span class="n">combined</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;binned_data&quot;</span><span class="p">][</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
            <span class="k">if</span> <span class="n">combined</span><span class="p">:</span>
                <span class="n">avg_binned</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>
                <span class="n">avg_labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">c</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2.5</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">c</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">2.5</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">Â°&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;binned_data&quot;</span><span class="p">:</span> <span class="n">avg_binned</span><span class="p">,</span>
            <span class="s2">&quot;bin_labels&quot;</span><span class="p">:</span> <span class="n">avg_labels</span><span class="p">,</span>
            <span class="s2">&quot;bin_centers&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">common</span><span class="p">),</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_single_theta_time_heatmap</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">time_aggregation</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">theta_bins</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute one theta Ã time heatmap.&quot;&quot;&quot;</span>
        <span class="n">polar</span> <span class="o">=</span> <span class="mf">90.0</span> <span class="o">-</span> <span class="n">ds</span><span class="o">.</span><span class="n">cell_theta</span><span class="o">.</span><span class="n">values</span>
        <span class="n">cell_ts</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">cell_timeseries</span><span class="o">.</span><span class="n">values</span>
        <span class="n">time_coord</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span>

        <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="n">theta_bins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">time_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process_time_aggregation</span><span class="p">(</span><span class="n">time_coord</span><span class="p">,</span> <span class="n">time_aggregation</span><span class="p">)</span>

        <span class="n">heatmap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">theta_bins</span><span class="p">,</span> <span class="n">time_info</span><span class="p">[</span><span class="s2">&quot;n_time_bins&quot;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">theta_bins</span><span class="p">):</span>
            <span class="n">theta_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">polar</span> <span class="o">&gt;=</span> <span class="n">edges</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">polar</span> <span class="o">&lt;</span> <span class="n">edges</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">theta_mask</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">bin_ts</span> <span class="o">=</span> <span class="n">cell_ts</span><span class="p">[</span><span class="n">theta_mask</span><span class="p">,</span> <span class="p">:]</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">time_info</span><span class="p">[</span><span class="s2">&quot;n_time_bins&quot;</span><span class="p">]):</span>
                <span class="n">t_mask</span> <span class="o">=</span> <span class="n">time_info</span><span class="p">[</span><span class="s2">&quot;time_groups&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">t</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">t_mask</span><span class="p">):</span>
                    <span class="n">heatmap</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">bin_ts</span><span class="p">[:,</span> <span class="n">t_mask</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">heatmap</span><span class="p">,</span> <span class="n">time_info</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_averaged_theta_time_heatmap</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">time_aggregation</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">theta_bins</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Average theta-time heatmaps across all datasets.&quot;&quot;&quot;</span>
        <span class="n">heatmaps</span><span class="p">,</span> <span class="n">time_info</span> <span class="o">=</span> <span class="p">[],</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">:</span>
            <span class="n">h</span><span class="p">,</span> <span class="n">ti</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_single_theta_time_heatmap</span><span class="p">(</span>
                <span class="n">ds</span><span class="p">,</span>
                <span class="n">time_aggregation</span><span class="p">,</span>
                <span class="n">theta_bins</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">heatmaps</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">time_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">time_info</span> <span class="o">=</span> <span class="n">ti</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">heatmaps</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">time_info</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_process_time_aggregation</span><span class="p">(</span>
        <span class="n">time_coord</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">time_aggregation</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Map raw timestamps to integer group indices.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            ``time_groups``, ``n_time_bins``, ``time_ticks``,</span>
<span class="sd">            ``time_tick_labels``, ``x_label``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">time_aggregation</span> <span class="o">==</span> <span class="s2">&quot;diurnal&quot;</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">time_coord</span><span class="p">)</span><span class="o">.</span><span class="n">hour</span><span class="o">.</span><span class="n">values</span>
            <span class="n">n</span> <span class="o">=</span> <span class="mi">24</span>
            <span class="n">ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">tick_labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">h</span><span class="si">:</span><span class="s2">02d</span><span class="si">}</span><span class="s2">:00&quot;</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">]</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;Hour of Day (UTC)&quot;</span>

        <span class="k">elif</span> <span class="n">time_aggregation</span> <span class="o">==</span> <span class="s2">&quot;daily&quot;</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">time_coord</span><span class="p">))</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">time_coord</span><span class="p">)</span>
            <span class="n">ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">//</span> <span class="mi">10</span><span class="p">))</span>
            <span class="n">tick_labels</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">time_coord</span><span class="p">)[</span><span class="n">ticks</span><span class="p">]</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;Date&quot;</span>

        <span class="k">elif</span> <span class="n">time_aggregation</span> <span class="o">==</span> <span class="s2">&quot;weekly&quot;</span><span class="p">:</span>
            <span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">time_coord</span><span class="p">)</span>
            <span class="n">weeks</span> <span class="o">=</span> <span class="n">dates</span><span class="o">.</span><span class="n">isocalendar</span><span class="p">()</span><span class="o">.</span><span class="n">week</span>
            <span class="n">unique_weeks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">weeks</span><span class="p">)</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">unique_weeks</span><span class="p">,</span> <span class="n">weeks</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_weeks</span><span class="p">)</span>
            <span class="n">ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">//</span> <span class="mi">10</span><span class="p">))</span>
            <span class="n">tick_labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Week </span><span class="si">{</span><span class="n">unique_weeks</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">]</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;Week&quot;</span>

        <span class="k">elif</span> <span class="n">time_aggregation</span> <span class="o">==</span> <span class="s2">&quot;monthly&quot;</span><span class="p">:</span>
            <span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">time_coord</span><span class="p">)</span>
            <span class="n">months</span> <span class="o">=</span> <span class="n">dates</span><span class="o">.</span><span class="n">month</span>
            <span class="n">unique_months</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">months</span><span class="p">)</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">unique_months</span><span class="p">,</span> <span class="n">months</span><span class="p">)</span>
            <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_months</span><span class="p">)</span>
            <span class="n">ticks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="n">tick_labels</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Month </span><span class="si">{</span><span class="n">unique_months</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ticks</span><span class="p">]</span>
            <span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;Month&quot;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown time_aggregation: &#39;</span><span class="si">{</span><span class="n">time_aggregation</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;time_groups&quot;</span><span class="p">:</span> <span class="n">groups</span><span class="p">,</span>
            <span class="s2">&quot;n_time_bins&quot;</span><span class="p">:</span> <span class="n">n</span><span class="p">,</span>
            <span class="s2">&quot;time_ticks&quot;</span><span class="p">:</span> <span class="n">ticks</span><span class="p">,</span>
            <span class="s2">&quot;time_tick_labels&quot;</span><span class="p">:</span> <span class="n">tick_labels</span><span class="p">,</span>
            <span class="s2">&quot;x_label&quot;</span><span class="p">:</span> <span class="n">xlabel</span><span class="p">,</span>
        <span class="p">}</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.PerCellVODAnalyzer.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.PerCellVODAnalyzer.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the analyzer.</p>
<h5 id="canvod.grids.analysis.PerCellVODAnalyzer.__init__--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.PerCellVODAnalyzer.__init__--parameters" title="Permanent link">&para;</a></h5>
<p>datasets : xr.Dataset | list[xr.Dataset]
    Per-cell dataset(s).
labels : list[str] | None, optional
    Labels for each dataset.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/per_cell_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">datasets</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">|</span> <span class="nb">list</span><span class="p">[</span><span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">],</span>
    <span class="n">labels</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the analyzer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    datasets : xr.Dataset | list[xr.Dataset]</span>
<span class="sd">        Per-cell dataset(s).</span>
<span class="sd">    labels : list[str] | None, optional</span>
<span class="sd">        Labels for each dataset.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">datasets</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="p">[</span><span class="n">datasets</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Dataset&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span> <span class="o">=</span> <span class="n">datasets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span> <span class="ow">or</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Dataset </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">datasets</span><span class="p">))]</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_validate_datasets</span><span class="p">()</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;PerCellVODAnalyzer: </span><span class="si">%d</span><span class="s2"> dataset(s), shapes=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">),</span>
        <span class="p">[</span><span class="n">ds</span><span class="o">.</span><span class="n">cell_timeseries</span><span class="o">.</span><span class="n">shape</span> <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">datasets</span><span class="p">],</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="canvod.grids.analysis.PerCellFilter" class="doc doc-heading">
            <code>PerCellFilter</code>


<a href="#canvod.grids.analysis.PerCellFilter" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="abc.ABC">ABC</span></code></p>



        <p>Base class for per-cell filtering operations.</p>
<p>Sub-classes implement :meth:<code>compute_cell_mask</code> for a single cell's
1-D data array; the base class handles iteration over cells,
auto-detection of the <code>cell_id_*</code> variable, and output assembly.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/per_cell_filtering.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PerCellFilter</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class for per-cell filtering operations.</span>

<span class="sd">    Sub-classes implement :meth:`compute_cell_mask` for a single cell&#39;s</span>
<span class="sd">    1-D data array; the base class handles iteration over cells,</span>
<span class="sd">    auto-detection of the ``cell_id_*`` variable, and output assembly.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the per-cell filter.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filter_name : str</span>
<span class="sd">            Filter name.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_name</span> <span class="o">=</span> <span class="n">filter_name</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_cell_mask</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cell_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a boolean keep-mask for one cell&#39;s data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cell_data : np.ndarray</span>
<span class="sd">            1-D array of values for one cell across time.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Boolean mask (True = keep).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="o">...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
        <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;VOD&quot;</span><span class="p">,</span>
        <span class="n">cell_id_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">min_observations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply per-cell filtering to *ds*.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ds : xr.Dataset</span>
<span class="sd">            Input dataset (must contain a ``cell_id_*`` variable).</span>
<span class="sd">        var_name : str</span>
<span class="sd">            Variable to filter.</span>
<span class="sd">        cell_id_var : str, optional</span>
<span class="sd">            Cell-ID variable name.  Auto-detected from ``cell_id_*`` if *None*.</span>
<span class="sd">        output_suffix : str, optional</span>
<span class="sd">            Suffix for output variables (default: ``filter_name``).</span>
<span class="sd">        min_observations : int</span>
<span class="sd">            Minimum observations per cell required for filtering.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Forwarded to :meth:`compute_cell_mask`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xr.Dataset</span>
<span class="sd">            Copy of *ds* with ``&lt;var&gt;_filtered_&lt;suffix&gt;`` and</span>
<span class="sd">            ``mask_&lt;suffix&gt;`` appended.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">output_suffix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">output_suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_name</span>

        <span class="c1"># Auto-detect cell_id variable</span>
        <span class="k">if</span> <span class="n">cell_id_var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cell_id_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;cell_id_&quot;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">cell_id_vars</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No cell_id variable found in dataset&quot;</span><span class="p">)</span>
            <span class="n">cell_id_var</span> <span class="o">=</span> <span class="n">cell_id_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Auto-detected cell_id variable: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cell_id_var</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">var_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variable &#39;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">&#39; not found in dataset&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cell_id_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cell ID variable &#39;</span><span class="si">{</span><span class="n">cell_id_var</span><span class="si">}</span><span class="s2">&#39; not found in dataset&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Applying </span><span class="si">%s</span><span class="s2"> filter per-cell to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_name</span><span class="p">,</span> <span class="n">var_name</span><span class="p">)</span>

        <span class="n">var_data</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
        <span class="n">cell_ids</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">cell_id_var</span><span class="p">]</span>

        <span class="n">filtered_data</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_per_cell_filtering</span><span class="p">(</span>
            <span class="n">var_data</span><span class="p">,</span> <span class="n">cell_ids</span><span class="p">,</span> <span class="n">min_observations</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">_filtered_</span><span class="si">{</span><span class="n">output_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_data</span>
        <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;mask_</span><span class="si">{</span><span class="n">output_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>

        <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">_filtered_</span><span class="si">{</span><span class="n">output_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;filter_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_name</span><span class="p">,</span>
                <span class="s2">&quot;filter_params&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">),</span>
                <span class="s2">&quot;min_observations&quot;</span><span class="p">:</span> <span class="n">min_observations</span><span class="p">,</span>
                <span class="s2">&quot;source_variable&quot;</span><span class="p">:</span> <span class="n">var_name</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_per_cell_filtering</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">var_data</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
        <span class="n">cell_ids</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
        <span class="n">min_observations</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterate over unique cells and apply the mask function.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        var_data : xr.DataArray</span>
<span class="sd">            Data to filter.</span>
<span class="sd">        cell_ids : xr.DataArray</span>
<span class="sd">            Cell ID assignments.</span>
<span class="sd">        min_observations : int</span>
<span class="sd">            Minimum observations per cell.</span>
<span class="sd">        **kwargs : Any</span>
<span class="sd">            Forwarded to ``compute_cell_mask``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Tuple[xr.DataArray, xr.DataArray]</span>
<span class="sd">            Filtered values and mask arrays.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">var_data</span><span class="o">.</span><span class="n">values</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="n">cell_ids</span><span class="o">.</span><span class="n">values</span>

        <span class="n">filtered_values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">mask_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="n">unique_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">cells</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cells</span><span class="p">)])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Processing </span><span class="si">%d</span><span class="s2"> unique cells&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_cells</span><span class="p">))</span>

        <span class="n">cells_processed</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">cells_filtered</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_filtered</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">cell_id</span> <span class="ow">in</span> <span class="n">unique_cells</span><span class="p">:</span>
            <span class="n">cell_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">cells</span> <span class="o">==</span> <span class="n">cell_id</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span>
            <span class="n">cell_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cell_mask</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">min_observations</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">cell_data</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">cell_mask</span><span class="p">]</span>
            <span class="n">cell_filter_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_cell_mask</span><span class="p">(</span><span class="n">cell_data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">mask_values</span><span class="p">[</span><span class="n">cell_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_filter_mask</span>
            <span class="n">filtered_values</span><span class="p">[</span><span class="n">cell_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cell_filter_mask</span><span class="p">,</span> <span class="n">cell_data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

            <span class="n">cells_processed</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">cell_filter_mask</span><span class="p">):</span>
                <span class="n">cells_filtered</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">total_filtered</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">cell_filter_mask</span><span class="p">))</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Processed </span><span class="si">%d</span><span class="s2"> cells, filtered </span><span class="si">%d</span><span class="s2"> cells, removed </span><span class="si">%d</span><span class="s2"> observations&quot;</span><span class="p">,</span>
            <span class="n">cells_processed</span><span class="p">,</span>
            <span class="n">cells_filtered</span><span class="p">,</span>
            <span class="n">total_filtered</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">filtered_da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="n">filtered_values</span><span class="p">,</span>
            <span class="n">dims</span><span class="o">=</span><span class="n">var_data</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span>
            <span class="n">coords</span><span class="o">=</span><span class="n">var_data</span><span class="o">.</span><span class="n">coords</span><span class="p">,</span>
            <span class="n">attrs</span><span class="o">=</span><span class="n">var_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">mask_da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">mask_values</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="n">var_data</span><span class="o">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="n">var_data</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">filtered_da</span><span class="p">,</span> <span class="n">mask_da</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.PerCellFilter.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">filter_name</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.PerCellFilter.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the per-cell filter.</p>
<h5 id="canvod.grids.analysis.PerCellFilter.__init__--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.PerCellFilter.__init__--parameters" title="Permanent link">&para;</a></h5>
<p>filter_name : str
    Filter name.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/per_cell_filtering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filter_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the per-cell filter.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filter_name : str</span>
<span class="sd">        Filter name.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">filter_name</span> <span class="o">=</span> <span class="n">filter_name</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.PerCellFilter.compute_cell_mask" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_cell_mask</span><span class="p">(</span><span class="n">cell_data</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-abstractmethod"><code>abstractmethod</code></small>
  </span>

<a href="#canvod.grids.analysis.PerCellFilter.compute_cell_mask" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Return a boolean keep-mask for one cell's data.</p>
<h5 id="canvod.grids.analysis.PerCellFilter.compute_cell_mask--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.PerCellFilter.compute_cell_mask--parameters" title="Permanent link">&para;</a></h5>
<p>cell_data : np.ndarray
    1-D array of values for one cell across time.</p>
<h5 id="canvod.grids.analysis.PerCellFilter.compute_cell_mask--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.PerCellFilter.compute_cell_mask--returns" title="Permanent link">&para;</a></h5>
<p>np.ndarray
    Boolean mask (True = keep).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/per_cell_filtering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@abstractmethod</span>
<span class="k">def</span><span class="w"> </span><span class="nf">compute_cell_mask</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">cell_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return a boolean keep-mask for one cell&#39;s data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cell_data : np.ndarray</span>
<span class="sd">        1-D array of values for one cell across time.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Boolean mask (True = keep).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="o">...</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.PerCellFilter.apply" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">apply</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;VOD&#39;</span><span class="p">,</span> <span class="n">cell_id_var</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">output_suffix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">min_observations</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.PerCellFilter.apply" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Apply per-cell filtering to <em>ds</em>.</p>
<h5 id="canvod.grids.analysis.PerCellFilter.apply--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.PerCellFilter.apply--parameters" title="Permanent link">&para;</a></h5>
<p>ds : xr.Dataset
    Input dataset (must contain a <code>cell_id_*</code> variable).
var_name : str
    Variable to filter.
cell_id_var : str, optional
    Cell-ID variable name.  Auto-detected from <code>cell_id_*</code> if <em>None</em>.
output_suffix : str, optional
    Suffix for output variables (default: <code>filter_name</code>).
min_observations : int
    Minimum observations per cell required for filtering.
**kwargs
    Forwarded to :meth:<code>compute_cell_mask</code>.</p>
<h5 id="canvod.grids.analysis.PerCellFilter.apply--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.PerCellFilter.apply--returns" title="Permanent link">&para;</a></h5>
<p>xr.Dataset
    Copy of <em>ds</em> with <code>&lt;var&gt;_filtered_&lt;suffix&gt;</code> and
    <code>mask_&lt;suffix&gt;</code> appended.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/per_cell_filtering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;VOD&quot;</span><span class="p">,</span>
    <span class="n">cell_id_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">output_suffix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">min_observations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply per-cell filtering to *ds*.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ds : xr.Dataset</span>
<span class="sd">        Input dataset (must contain a ``cell_id_*`` variable).</span>
<span class="sd">    var_name : str</span>
<span class="sd">        Variable to filter.</span>
<span class="sd">    cell_id_var : str, optional</span>
<span class="sd">        Cell-ID variable name.  Auto-detected from ``cell_id_*`` if *None*.</span>
<span class="sd">    output_suffix : str, optional</span>
<span class="sd">        Suffix for output variables (default: ``filter_name``).</span>
<span class="sd">    min_observations : int</span>
<span class="sd">        Minimum observations per cell required for filtering.</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Forwarded to :meth:`compute_cell_mask`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xr.Dataset</span>
<span class="sd">        Copy of *ds* with ``&lt;var&gt;_filtered_&lt;suffix&gt;`` and</span>
<span class="sd">        ``mask_&lt;suffix&gt;`` appended.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">output_suffix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output_suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_name</span>

    <span class="c1"># Auto-detect cell_id variable</span>
    <span class="k">if</span> <span class="n">cell_id_var</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">cell_id_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;cell_id_&quot;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cell_id_vars</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No cell_id variable found in dataset&quot;</span><span class="p">)</span>
        <span class="n">cell_id_var</span> <span class="o">=</span> <span class="n">cell_id_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Auto-detected cell_id variable: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cell_id_var</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">var_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variable &#39;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">&#39; not found in dataset&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cell_id_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cell ID variable &#39;</span><span class="si">{</span><span class="n">cell_id_var</span><span class="si">}</span><span class="s2">&#39; not found in dataset&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Applying </span><span class="si">%s</span><span class="s2"> filter per-cell to &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_name</span><span class="p">,</span> <span class="n">var_name</span><span class="p">)</span>

    <span class="n">var_data</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
    <span class="n">cell_ids</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="n">cell_id_var</span><span class="p">]</span>

    <span class="n">filtered_data</span><span class="p">,</span> <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_per_cell_filtering</span><span class="p">(</span>
        <span class="n">var_data</span><span class="p">,</span> <span class="n">cell_ids</span><span class="p">,</span> <span class="n">min_observations</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">_filtered_</span><span class="si">{</span><span class="n">output_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_data</span>
    <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;mask_</span><span class="si">{</span><span class="n">output_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mask</span>

    <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">_filtered_</span><span class="si">{</span><span class="n">output_suffix</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;filter_type&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_name</span><span class="p">,</span>
            <span class="s2">&quot;filter_params&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">kwargs</span><span class="p">),</span>
            <span class="s2">&quot;min_observations&quot;</span><span class="p">:</span> <span class="n">min_observations</span><span class="p">,</span>
            <span class="s2">&quot;source_variable&quot;</span><span class="p">:</span> <span class="n">var_name</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="canvod.grids.analysis.PerCellFilterPipeline" class="doc doc-heading">
            <code>PerCellFilterPipeline</code>


<a href="#canvod.grids.analysis.PerCellFilterPipeline" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">



        <p>Sequential or combined multi-filter pipeline for per-cell filtering.</p>
<h4 id="canvod.grids.analysis.PerCellFilterPipeline--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.PerCellFilterPipeline--parameters" title="Permanent link">&para;</a></h4>
<p>ds : xr.Dataset
    Input dataset.
var_name : str
    Variable to filter (default: <code>'VOD'</code>).</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/per_cell_filtering.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PerCellFilterPipeline</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sequential or combined multi-filter pipeline for per-cell filtering.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ds : xr.Dataset</span>
<span class="sd">        Input dataset.</span>
<span class="sd">    var_name : str</span>
<span class="sd">        Variable to filter (default: ``&#39;VOD&#39;``).</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;VOD&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the filter pipeline.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ds : xr.Dataset</span>
<span class="sd">            Input dataset.</span>
<span class="sd">        var_name : str, default &quot;VOD&quot;</span>
<span class="sd">            Variable to filter.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">var_name</span> <span class="o">=</span> <span class="n">var_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">PerCellFilter</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_filter</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">filter_obj</span><span class="p">:</span> <span class="n">PerCellFilter</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PerCellFilterPipeline</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a filter.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filter_obj : PerCellFilter or str</span>
<span class="sd">            Filter instance or short name</span>
<span class="sd">            (``&#39;iqr&#39;``, ``&#39;zscore&#39;``, ``&#39;range&#39;``, ``&#39;percentile&#39;``).</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Parameters forwarded to the filter.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        PerCellFilterPipeline</span>
<span class="sd">            Self (for chaining).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filter_obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">_filter_map</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;iqr&quot;</span><span class="p">:</span> <span class="n">PerCellIQRFilter</span><span class="p">,</span>
                <span class="s2">&quot;zscore&quot;</span><span class="p">:</span> <span class="n">PerCellZScoreFilter</span><span class="p">,</span>
                <span class="s2">&quot;range&quot;</span><span class="p">:</span> <span class="n">PerCellRangeFilter</span><span class="p">,</span>
                <span class="s2">&quot;percentile&quot;</span><span class="p">:</span> <span class="n">PerCellPercentileFilter</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="n">filter_obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_filter_map</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown filter: </span><span class="si">{</span><span class="n">filter_obj</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">filter_obj</span> <span class="o">=</span> <span class="n">_filter_map</span><span class="p">[</span><span class="n">filter_obj</span><span class="p">]()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">filter_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;sequential&quot;</span><span class="p">,</span> <span class="n">output_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply all filters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        mode : {&#39;sequential&#39;, &#39;combined&#39;}</span>
<span class="sd">            ``&#39;sequential&#39;`` â each filter operates on the previous output.</span>
<span class="sd">            ``&#39;combined&#39;``   â all masks computed on the original, then AND-ed.</span>
<span class="sd">        output_name : str, optional</span>
<span class="sd">            Alias for the final filtered variable.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xr.Dataset</span>
<span class="sd">            Dataset with filtered results.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No filters added to pipeline&quot;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">current_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_name</span>

        <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;sequential&quot;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">filter_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">):</span>
                <span class="n">suffix</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filter_obj</span><span class="o">.</span><span class="n">filter_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">filter_obj</span><span class="o">.</span><span class="n">filter_name</span>
                <span class="p">)</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">filter_obj</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="n">result</span><span class="p">,</span> <span class="n">current_var</span><span class="p">,</span> <span class="n">output_suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
                <span class="p">)</span>
                <span class="n">current_var</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">_filtered_</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;combined&quot;</span><span class="p">:</span>
            <span class="n">combined_mask</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">filter_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">filter_obj</span><span class="p">,</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span>
                <span class="n">filtered</span> <span class="o">=</span> <span class="n">filter_obj</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">filtered</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;mask_</span><span class="si">{</span><span class="n">filter_obj</span><span class="o">.</span><span class="n">filter_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">combined_mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">mask</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">combined_mask</span> <span class="o">&amp;</span> <span class="n">mask</span>

                <span class="n">filter_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filter_obj</span><span class="o">.</span><span class="n">filter_name</span><span class="p">)</span>

            <span class="n">final_name</span> <span class="o">=</span> <span class="n">output_name</span> <span class="ow">or</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filter_names</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">_filtered_</span><span class="si">{</span><span class="n">final_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var_name</span>
            <span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">combined_mask</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;mask_</span><span class="si">{</span><span class="n">final_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined_mask</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown mode: </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.PerCellFilterPipeline.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;VOD&#39;</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.PerCellFilterPipeline.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the filter pipeline.</p>
<h5 id="canvod.grids.analysis.PerCellFilterPipeline.__init__--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.PerCellFilterPipeline.__init__--parameters" title="Permanent link">&para;</a></h5>
<p>ds : xr.Dataset
    Input dataset.
var_name : str, default "VOD"
    Variable to filter.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/per_cell_filtering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;VOD&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the filter pipeline.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    ds : xr.Dataset</span>
<span class="sd">        Input dataset.</span>
<span class="sd">    var_name : str, default &quot;VOD&quot;</span>
<span class="sd">        Variable to filter.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">var_name</span> <span class="o">=</span> <span class="n">var_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="n">PerCellFilter</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.PerCellFilterPipeline.add_filter" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_filter</span><span class="p">(</span><span class="n">filter_obj</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.PerCellFilterPipeline.add_filter" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Add a filter.</p>
<h5 id="canvod.grids.analysis.PerCellFilterPipeline.add_filter--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.PerCellFilterPipeline.add_filter--parameters" title="Permanent link">&para;</a></h5>
<p>filter_obj : PerCellFilter or str
    Filter instance or short name
    (<code>'iqr'</code>, <code>'zscore'</code>, <code>'range'</code>, <code>'percentile'</code>).
**kwargs
    Parameters forwarded to the filter.</p>
<h5 id="canvod.grids.analysis.PerCellFilterPipeline.add_filter--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.PerCellFilterPipeline.add_filter--returns" title="Permanent link">&para;</a></h5>
<p>PerCellFilterPipeline
    Self (for chaining).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/per_cell_filtering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_filter</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">filter_obj</span><span class="p">:</span> <span class="n">PerCellFilter</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">PerCellFilterPipeline</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a filter.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filter_obj : PerCellFilter or str</span>
<span class="sd">        Filter instance or short name</span>
<span class="sd">        (``&#39;iqr&#39;``, ``&#39;zscore&#39;``, ``&#39;range&#39;``, ``&#39;percentile&#39;``).</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Parameters forwarded to the filter.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    PerCellFilterPipeline</span>
<span class="sd">        Self (for chaining).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filter_obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">_filter_map</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;iqr&quot;</span><span class="p">:</span> <span class="n">PerCellIQRFilter</span><span class="p">,</span>
            <span class="s2">&quot;zscore&quot;</span><span class="p">:</span> <span class="n">PerCellZScoreFilter</span><span class="p">,</span>
            <span class="s2">&quot;range&quot;</span><span class="p">:</span> <span class="n">PerCellRangeFilter</span><span class="p">,</span>
            <span class="s2">&quot;percentile&quot;</span><span class="p">:</span> <span class="n">PerCellPercentileFilter</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">filter_obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_filter_map</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown filter: </span><span class="si">{</span><span class="n">filter_obj</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">filter_obj</span> <span class="o">=</span> <span class="n">_filter_map</span><span class="p">[</span><span class="n">filter_obj</span><span class="p">]()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">filter_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.PerCellFilterPipeline.apply" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">apply</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;sequential&#39;</span><span class="p">,</span> <span class="n">output_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.PerCellFilterPipeline.apply" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Apply all filters.</p>
<h5 id="canvod.grids.analysis.PerCellFilterPipeline.apply--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.PerCellFilterPipeline.apply--parameters" title="Permanent link">&para;</a></h5>
<p>mode : {'sequential', 'combined'}
    <code>'sequential'</code> â each filter operates on the previous output.
    <code>'combined'</code>   â all masks computed on the original, then AND-ed.
output_name : str, optional
    Alias for the final filtered variable.</p>
<h5 id="canvod.grids.analysis.PerCellFilterPipeline.apply--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.PerCellFilterPipeline.apply--returns" title="Permanent link">&para;</a></h5>
<p>xr.Dataset
    Dataset with filtered results.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/per_cell_filtering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">apply</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;sequential&quot;</span><span class="p">,</span> <span class="n">output_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply all filters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mode : {&#39;sequential&#39;, &#39;combined&#39;}</span>
<span class="sd">        ``&#39;sequential&#39;`` â each filter operates on the previous output.</span>
<span class="sd">        ``&#39;combined&#39;``   â all masks computed on the original, then AND-ed.</span>
<span class="sd">    output_name : str, optional</span>
<span class="sd">        Alias for the final filtered variable.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xr.Dataset</span>
<span class="sd">        Dataset with filtered results.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No filters added to pipeline&quot;</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">current_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_name</span>

    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;sequential&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">filter_obj</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">):</span>
            <span class="n">suffix</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">filter_obj</span><span class="o">.</span><span class="n">filter_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">filter_obj</span><span class="o">.</span><span class="n">filter_name</span>
            <span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">filter_obj</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="n">result</span><span class="p">,</span> <span class="n">current_var</span><span class="p">,</span> <span class="n">output_suffix</span><span class="o">=</span><span class="n">suffix</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="n">current_var</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">_filtered_</span><span class="si">{</span><span class="n">suffix</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;combined&quot;</span><span class="p">:</span>
        <span class="n">combined_mask</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">filter_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">filter_obj</span><span class="p">,</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">filters</span><span class="p">:</span>
            <span class="n">filtered</span> <span class="o">=</span> <span class="n">filter_obj</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">filtered</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;mask_</span><span class="si">{</span><span class="n">filter_obj</span><span class="o">.</span><span class="n">filter_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">combined_mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">mask</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">combined_mask</span> <span class="o">=</span> <span class="n">combined_mask</span> <span class="o">&amp;</span> <span class="n">mask</span>

            <span class="n">filter_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filter_obj</span><span class="o">.</span><span class="n">filter_name</span><span class="p">)</span>

        <span class="n">final_name</span> <span class="o">=</span> <span class="n">output_name</span> <span class="ow">or</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filter_names</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">var_name</span><span class="si">}</span><span class="s2">_filtered_</span><span class="si">{</span><span class="n">final_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var_name</span>
        <span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">combined_mask</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;mask_</span><span class="si">{</span><span class="n">final_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">combined_mask</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown mode: </span><span class="si">{</span><span class="n">mode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="canvod.grids.analysis.PerCellIQRFilter" class="doc doc-heading">
            <code>PerCellIQRFilter</code>


<a href="#canvod.grids.analysis.PerCellIQRFilter" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="canvod.grids.analysis.per_cell_filtering.PerCellFilter">PerCellFilter</span></code></p>



        <p>Per-cell IQR outlier rejection.</p>
<p>Values outside <code>[Q1 â factorÂ·IQR, Q3 + factorÂ·IQR]</code> are removed
independently within each cell.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/per_cell_filtering.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PerCellIQRFilter</span><span class="p">(</span><span class="n">PerCellFilter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Per-cell IQR outlier rejection.</span>

<span class="sd">    Values outside ``[Q1 â factorÂ·IQR, Q3 + factorÂ·IQR]`` are removed</span>
<span class="sd">    independently within each cell.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the filter.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;iqr&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_cell_mask</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">cell_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;IQR mask for a single cell.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cell_data : np.ndarray</span>
<span class="sd">            1-D cell data.</span>
<span class="sd">        factor : float</span>
<span class="sd">            IQR multiplier (default 1.5).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Boolean mask.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid_data</span> <span class="o">=</span> <span class="n">cell_data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cell_data</span><span class="p">)]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">cell_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="n">q1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">valid_data</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
        <span class="n">q3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">valid_data</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span>
        <span class="n">iqr</span> <span class="o">=</span> <span class="n">q3</span> <span class="o">-</span> <span class="n">q1</span>

        <span class="k">if</span> <span class="n">iqr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">cell_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">q1</span> <span class="o">-</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">iqr</span>
        <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">q3</span> <span class="o">+</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">iqr</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">cell_data</span> <span class="o">&gt;=</span> <span class="n">lower_bound</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cell_data</span> <span class="o">&lt;=</span> <span class="n">upper_bound</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.PerCellIQRFilter.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">()</span></code>

<a href="#canvod.grids.analysis.PerCellIQRFilter.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the filter.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/per_cell_filtering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the filter.&quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;iqr&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.PerCellIQRFilter.compute_cell_mask" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_cell_mask</span><span class="p">(</span><span class="n">cell_data</span><span class="p">,</span> <span class="n">factor</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.PerCellIQRFilter.compute_cell_mask" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>IQR mask for a single cell.</p>
<h5 id="canvod.grids.analysis.PerCellIQRFilter.compute_cell_mask--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.PerCellIQRFilter.compute_cell_mask--parameters" title="Permanent link">&para;</a></h5>
<p>cell_data : np.ndarray
    1-D cell data.
factor : float
    IQR multiplier (default 1.5).</p>
<h5 id="canvod.grids.analysis.PerCellIQRFilter.compute_cell_mask--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.PerCellIQRFilter.compute_cell_mask--returns" title="Permanent link">&para;</a></h5>
<p>np.ndarray
    Boolean mask.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/per_cell_filtering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_cell_mask</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">cell_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.5</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;IQR mask for a single cell.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cell_data : np.ndarray</span>
<span class="sd">        1-D cell data.</span>
<span class="sd">    factor : float</span>
<span class="sd">        IQR multiplier (default 1.5).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Boolean mask.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">valid_data</span> <span class="o">=</span> <span class="n">cell_data</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cell_data</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">valid_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">cell_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="n">q1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">valid_data</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
    <span class="n">q3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">valid_data</span><span class="p">,</span> <span class="mi">75</span><span class="p">)</span>
    <span class="n">iqr</span> <span class="o">=</span> <span class="n">q3</span> <span class="o">-</span> <span class="n">q1</span>

    <span class="k">if</span> <span class="n">iqr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">cell_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="n">lower_bound</span> <span class="o">=</span> <span class="n">q1</span> <span class="o">-</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">iqr</span>
    <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">q3</span> <span class="o">+</span> <span class="n">factor</span> <span class="o">*</span> <span class="n">iqr</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">cell_data</span> <span class="o">&gt;=</span> <span class="n">lower_bound</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cell_data</span> <span class="o">&lt;=</span> <span class="n">upper_bound</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="canvod.grids.analysis.PerCellZScoreFilter" class="doc doc-heading">
            <code>PerCellZScoreFilter</code>


<a href="#canvod.grids.analysis.PerCellZScoreFilter" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="canvod.grids.analysis.per_cell_filtering.PerCellFilter">PerCellFilter</span></code></p>



        <p>Per-cell z-score outlier rejection.</p>
<p>Values with <code>|z| &gt; threshold</code> are removed independently within each cell.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/per_cell_filtering.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PerCellZScoreFilter</span><span class="p">(</span><span class="n">PerCellFilter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Per-cell z-score outlier rejection.</span>

<span class="sd">    Values with ``|z| &gt; threshold`` are removed independently within each cell.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the filter.&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;zscore&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_cell_mask</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">cell_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Z-score mask for a single cell.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cell_data : np.ndarray</span>
<span class="sd">            1-D cell data.</span>
<span class="sd">        threshold : float</span>
<span class="sd">            Z-score threshold (default 3.0).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Boolean mask.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">cell_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">cell_data</span><span class="p">)</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">cell_data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">std</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">cell_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="n">z_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">cell_data</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">z_scores</span> <span class="o">&lt;=</span> <span class="n">threshold</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.PerCellZScoreFilter.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">()</span></code>

<a href="#canvod.grids.analysis.PerCellZScoreFilter.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the filter.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/per_cell_filtering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the filter.&quot;&quot;&quot;</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s2">&quot;zscore&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.PerCellZScoreFilter.compute_cell_mask" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_cell_mask</span><span class="p">(</span><span class="n">cell_data</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.PerCellZScoreFilter.compute_cell_mask" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Z-score mask for a single cell.</p>
<h5 id="canvod.grids.analysis.PerCellZScoreFilter.compute_cell_mask--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.PerCellZScoreFilter.compute_cell_mask--parameters" title="Permanent link">&para;</a></h5>
<p>cell_data : np.ndarray
    1-D cell data.
threshold : float
    Z-score threshold (default 3.0).</p>
<h5 id="canvod.grids.analysis.PerCellZScoreFilter.compute_cell_mask--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.PerCellZScoreFilter.compute_cell_mask--returns" title="Permanent link">&para;</a></h5>
<p>np.ndarray
    Boolean mask.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/per_cell_filtering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_cell_mask</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">cell_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Z-score mask for a single cell.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cell_data : np.ndarray</span>
<span class="sd">        1-D cell data.</span>
<span class="sd">    threshold : float</span>
<span class="sd">        Z-score threshold (default 3.0).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Boolean mask.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">cell_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">cell_data</span><span class="p">)</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">cell_data</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">std</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">cell_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="n">z_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">cell_data</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="n">std</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">z_scores</span> <span class="o">&lt;=</span> <span class="n">threshold</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="canvod.grids.analysis.SolarPositionCalculator" class="doc doc-heading">
            <code>SolarPositionCalculator</code>


<a href="#canvod.grids.analysis.SolarPositionCalculator" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">



        <p>Calculate solar positions for VOD corrections.</p>
<h4 id="canvod.grids.analysis.SolarPositionCalculator--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.SolarPositionCalculator--parameters" title="Permanent link">&para;</a></h4>
<p>lat : float
    Observer latitude in degrees (positive = North).
lon : float
    Observer longitude in degrees (positive = East).
elevation : float
    Elevation above sea level in metres (default: 0).
use_pvlib : bool
    If <code>True</code>, use <em>pvlib</em> when available (more accurate).
    Falls back to built-in formulas automatically.</p>
<h4 id="canvod.grids.analysis.SolarPositionCalculator--examples">Examples<a class="headerlink" href="#canvod.grids.analysis.SolarPositionCalculator--examples" title="Permanent link">&para;</a></h4>
<blockquote>
<blockquote>
<blockquote>
<p>calc = SolarPositionCalculator(lat=40.0, lon=-105.0, elevation=1655)
times = pd.date_range('2025-01-01', periods=24, freq='1H')
zenith, azimuth = calc.compute_solar_position(times)
corrected = calc.apply_solar_correction(vod_data, times)</p>
</blockquote>
</blockquote>
</blockquote>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/solar.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SolarPositionCalculator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate solar positions for VOD corrections.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lat : float</span>
<span class="sd">        Observer latitude in degrees (positive = North).</span>
<span class="sd">    lon : float</span>
<span class="sd">        Observer longitude in degrees (positive = East).</span>
<span class="sd">    elevation : float</span>
<span class="sd">        Elevation above sea level in metres (default: 0).</span>
<span class="sd">    use_pvlib : bool</span>
<span class="sd">        If ``True``, use *pvlib* when available (more accurate).</span>
<span class="sd">        Falls back to built-in formulas automatically.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; calc = SolarPositionCalculator(lat=40.0, lon=-105.0, elevation=1655)</span>
<span class="sd">    &gt;&gt;&gt; times = pd.date_range(&#39;2025-01-01&#39;, periods=24, freq=&#39;1H&#39;)</span>
<span class="sd">    &gt;&gt;&gt; zenith, azimuth = calc.compute_solar_position(times)</span>
<span class="sd">    &gt;&gt;&gt; corrected = calc.apply_solar_correction(vod_data, times)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">lat</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">lon</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">elevation</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="n">use_pvlib</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the solar position calculator.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lat : float</span>
<span class="sd">            Observer latitude in degrees.</span>
<span class="sd">        lon : float</span>
<span class="sd">            Observer longitude in degrees.</span>
<span class="sd">        elevation : float, default 0.0</span>
<span class="sd">            Elevation above sea level in metres.</span>
<span class="sd">        use_pvlib : bool, default True</span>
<span class="sd">            Whether to use pvlib if available.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lat</span> <span class="o">=</span> <span class="n">lat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lon</span> <span class="o">=</span> <span class="n">lon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elevation</span> <span class="o">=</span> <span class="n">elevation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_pvlib</span> <span class="o">=</span> <span class="n">use_pvlib</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pvlib</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">use_pvlib</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="kn">import</span><span class="w"> </span><span class="nn">pvlib</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">pvlib</span> <span class="o">=</span> <span class="n">pvlib</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using pvlib for solar position calculations&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;pvlib not available, falling back to built-in formulas. &quot;</span>
                    <span class="s2">&quot;Install pvlib for higher accuracy: pip install pvlib&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">use_pvlib</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Core position computation</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_solar_position</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">times</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute solar zenith and azimuth angles.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        times : np.ndarray or pd.DatetimeIndex</span>
<span class="sd">            Array of ``datetime64`` or ``DatetimeIndex``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        solar_zenith : np.ndarray</span>
<span class="sd">            Solar zenith angles in degrees (0Â° = directly overhead).</span>
<span class="sd">        solar_azimuth : np.ndarray</span>
<span class="sd">            Solar azimuth angles in degrees (0Â° = North, 90Â° = East).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pvlib</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvlib</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_solar_position_pvlib</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_solar_position_builtin</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_solar_position_pvlib</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">times</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute solar position using pvlib (high accuracy).&quot;&quot;&quot;</span>
        <span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvlib</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">Location</span><span class="p">(</span>
            <span class="n">latitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">,</span>
            <span class="n">longitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="p">,</span>
            <span class="n">altitude</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">elevation</span><span class="p">,</span>
            <span class="n">tz</span><span class="o">=</span><span class="s2">&quot;UTC&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">times</span><span class="o">.</span><span class="n">tz</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">times</span> <span class="o">=</span> <span class="n">times</span><span class="o">.</span><span class="n">tz_localize</span><span class="p">(</span><span class="s2">&quot;UTC&quot;</span><span class="p">)</span>

        <span class="n">solar_position</span> <span class="o">=</span> <span class="n">location</span><span class="o">.</span><span class="n">get_solarposition</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>

        <span class="n">zenith</span> <span class="o">=</span> <span class="n">solar_position</span><span class="p">[</span><span class="s2">&quot;apparent_zenith&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">azimuth</span> <span class="o">=</span> <span class="n">solar_position</span><span class="p">[</span><span class="s2">&quot;azimuth&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">return</span> <span class="n">zenith</span><span class="p">,</span> <span class="n">azimuth</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_solar_position_builtin</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">times</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute solar position using built-in NOAA algorithms.</span>

<span class="sd">        Accuracy ~0.01Â° for years 1800â2100.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">jd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_datetime_to_julian_day</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
        <span class="n">jc</span> <span class="o">=</span> <span class="p">(</span><span class="n">jd</span> <span class="o">-</span> <span class="mf">2451545.0</span><span class="p">)</span> <span class="o">/</span> <span class="mf">36525.0</span>

        <span class="c1"># Geometric mean longitude of sun (degrees)</span>
        <span class="n">geom_mean_long</span> <span class="o">=</span> <span class="p">(</span><span class="mf">280.46646</span> <span class="o">+</span> <span class="n">jc</span> <span class="o">*</span> <span class="p">(</span><span class="mf">36000.76983</span> <span class="o">+</span> <span class="n">jc</span> <span class="o">*</span> <span class="mf">0.0003032</span><span class="p">))</span> <span class="o">%</span> <span class="mi">360</span>

        <span class="c1"># Geometric mean anomaly of sun (degrees)</span>
        <span class="n">geom_mean_anom</span> <span class="o">=</span> <span class="mf">357.52911</span> <span class="o">+</span> <span class="n">jc</span> <span class="o">*</span> <span class="p">(</span><span class="mf">35999.05029</span> <span class="o">-</span> <span class="mf">0.0001537</span> <span class="o">*</span> <span class="n">jc</span><span class="p">)</span>

        <span class="c1"># Eccentricity of Earth&#39;s orbit</span>
        <span class="n">eccent</span> <span class="o">=</span> <span class="mf">0.016708634</span> <span class="o">-</span> <span class="n">jc</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.000042037</span> <span class="o">+</span> <span class="mf">0.0000001267</span> <span class="o">*</span> <span class="n">jc</span><span class="p">)</span>

        <span class="c1"># Sun equation of centre</span>
        <span class="n">sun_eq_ctr</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">geom_mean_anom</span><span class="p">))</span>
            <span class="o">*</span> <span class="p">(</span><span class="mf">1.914602</span> <span class="o">-</span> <span class="n">jc</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.004817</span> <span class="o">+</span> <span class="mf">0.000014</span> <span class="o">*</span> <span class="n">jc</span><span class="p">))</span>
            <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">geom_mean_anom</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.019993</span> <span class="o">-</span> <span class="mf">0.000101</span> <span class="o">*</span> <span class="n">jc</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">geom_mean_anom</span><span class="p">))</span> <span class="o">*</span> <span class="mf">0.000289</span>
        <span class="p">)</span>

        <span class="c1"># Sun true longitude (degrees)</span>
        <span class="n">sun_true_long</span> <span class="o">=</span> <span class="n">geom_mean_long</span> <span class="o">+</span> <span class="n">sun_eq_ctr</span>

        <span class="c1"># Sun apparent longitude (degrees)</span>
        <span class="n">sun_app_long</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">sun_true_long</span>
            <span class="o">-</span> <span class="mf">0.00569</span>
            <span class="o">-</span> <span class="mf">0.00478</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mf">125.04</span> <span class="o">-</span> <span class="mf">1934.136</span> <span class="o">*</span> <span class="n">jc</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="c1"># Mean obliquity of ecliptic (degrees)</span>
        <span class="n">mean_obliq_ecliptic</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mi">23</span>
            <span class="o">+</span> <span class="p">(</span><span class="mi">26</span> <span class="o">+</span> <span class="p">(</span><span class="mf">21.448</span> <span class="o">-</span> <span class="n">jc</span> <span class="o">*</span> <span class="p">(</span><span class="mf">46.815</span> <span class="o">+</span> <span class="n">jc</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.00059</span> <span class="o">-</span> <span class="n">jc</span> <span class="o">*</span> <span class="mf">0.001813</span><span class="p">)))</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span>
        <span class="p">)</span>

        <span class="c1"># Obliquity correction (degrees)</span>
        <span class="n">obliq_corr</span> <span class="o">=</span> <span class="n">mean_obliq_ecliptic</span> <span class="o">+</span> <span class="mf">0.00256</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="mf">125.04</span> <span class="o">-</span> <span class="mf">1934.136</span> <span class="o">*</span> <span class="n">jc</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Sun declination (degrees)</span>
        <span class="n">sun_decl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">obliq_corr</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">sun_app_long</span><span class="p">)))</span>
        <span class="p">)</span>

        <span class="c1"># Equation of time (minutes)</span>
        <span class="n">var_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">obliq_corr</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
        <span class="n">eq_of_time</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span>
            <span class="n">var_y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">geom_mean_long</span><span class="p">))</span>
            <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">eccent</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">geom_mean_anom</span><span class="p">))</span>
            <span class="o">+</span> <span class="mi">4</span>
            <span class="o">*</span> <span class="n">eccent</span>
            <span class="o">*</span> <span class="n">var_y</span>
            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">geom_mean_anom</span><span class="p">))</span>
            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">geom_mean_long</span><span class="p">))</span>
            <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">var_y</span> <span class="o">*</span> <span class="n">var_y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">geom_mean_long</span><span class="p">))</span>
            <span class="o">-</span> <span class="mf">1.25</span> <span class="o">*</span> <span class="n">eccent</span> <span class="o">*</span> <span class="n">eccent</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">geom_mean_anom</span><span class="p">))</span>
        <span class="p">)</span>

        <span class="c1"># True solar time (minutes)</span>
        <span class="n">time_offset</span> <span class="o">=</span> <span class="n">eq_of_time</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">lon</span>
        <span class="n">hour</span> <span class="o">=</span> <span class="n">times</span><span class="o">.</span><span class="n">hour</span> <span class="o">+</span> <span class="n">times</span><span class="o">.</span><span class="n">minute</span> <span class="o">/</span> <span class="mf">60.0</span> <span class="o">+</span> <span class="n">times</span><span class="o">.</span><span class="n">second</span> <span class="o">/</span> <span class="mf">3600.0</span>
        <span class="n">true_solar_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">hour</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">+</span> <span class="n">time_offset</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1440</span>

        <span class="c1"># Hour angle (degrees)</span>
        <span class="n">hour_angle</span> <span class="o">=</span> <span class="n">true_solar_time</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">-</span> <span class="mi">180</span>
        <span class="n">hour_angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">hour_angle</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">hour_angle</span> <span class="o">+</span> <span class="mi">360</span><span class="p">,</span> <span class="n">hour_angle</span><span class="p">)</span>

        <span class="c1"># Solar zenith angle (degrees)</span>
        <span class="n">lat_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="p">)</span>
        <span class="n">decl_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">sun_decl</span><span class="p">)</span>
        <span class="n">ha_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">hour_angle</span><span class="p">)</span>

        <span class="n">zenith</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat_rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">decl_rad</span><span class="p">)</span>
                <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat_rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">decl_rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ha_rad</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Solar azimuth angle (degrees from North)</span>
        <span class="n">azimuth_rad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span>
            <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">lat_rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">zenith</span><span class="p">))</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">decl_rad</span><span class="p">))</span>
            <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat_rad</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">zenith</span><span class="p">)))</span>
        <span class="p">)</span>
        <span class="n">azimuth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">degrees</span><span class="p">(</span><span class="n">azimuth_rad</span><span class="p">)</span>

        <span class="c1"># Adjust for morning vs afternoon</span>
        <span class="n">azimuth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">hour_angle</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">,</span> <span class="mi">360</span> <span class="o">-</span> <span class="n">azimuth</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">zenith</span><span class="p">,</span> <span class="n">azimuth</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_datetime_to_julian_day</span><span class="p">(</span><span class="n">times</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert datetime to Julian Day Number.&quot;&quot;&quot;</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">times</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">)</span> <span class="k">else</span> <span class="n">times</span><span class="p">)</span>
        <span class="n">year</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">year</span>
        <span class="n">month</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">month</span>
        <span class="n">day</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">day</span>
        <span class="n">hour</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">hour</span>
        <span class="n">minute</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">minute</span>
        <span class="n">second</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">second</span>

        <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="mi">14</span> <span class="o">-</span> <span class="n">month</span><span class="p">)</span> <span class="o">//</span> <span class="mi">12</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">year</span> <span class="o">+</span> <span class="mi">4800</span> <span class="o">-</span> <span class="n">a</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">month</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">*</span> <span class="n">a</span> <span class="o">-</span> <span class="mi">3</span>

        <span class="n">jdn</span> <span class="o">=</span> <span class="n">day</span> <span class="o">+</span> <span class="p">(</span><span class="mi">153</span> <span class="o">*</span> <span class="n">m</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">//</span> <span class="mi">5</span> <span class="o">+</span> <span class="mi">365</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="n">y</span> <span class="o">//</span> <span class="mi">4</span> <span class="o">-</span> <span class="n">y</span> <span class="o">//</span> <span class="mi">100</span> <span class="o">+</span> <span class="n">y</span> <span class="o">//</span> <span class="mi">400</span> <span class="o">-</span> <span class="mi">32045</span>
        <span class="n">fraction</span> <span class="o">=</span> <span class="p">(</span><span class="n">hour</span> <span class="o">-</span> <span class="mi">12</span><span class="p">)</span> <span class="o">/</span> <span class="mf">24.0</span> <span class="o">+</span> <span class="n">minute</span> <span class="o">/</span> <span class="mf">1440.0</span> <span class="o">+</span> <span class="n">second</span> <span class="o">/</span> <span class="mf">86400.0</span>

        <span class="k">return</span> <span class="n">jdn</span> <span class="o">+</span> <span class="n">fraction</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Derived quantities</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_solar_elevation</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">times</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute solar elevation angle (complementary to zenith).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        times : np.ndarray or pd.DatetimeIndex</span>
<span class="sd">            Array of times.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Solar elevation angles in degrees (0Â° = horizon, 90Â° = overhead).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">zenith</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_solar_position</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
        <span class="k">return</span> <span class="mf">90.0</span> <span class="o">-</span> <span class="n">zenith</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_daytime</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">times</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">,</span>
        <span class="n">twilight_angle</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine if times are during daytime.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        times : np.ndarray or pd.DatetimeIndex</span>
<span class="sd">            Array of times.</span>
<span class="sd">        twilight_angle : float</span>
<span class="sd">            Solar elevation threshold in degrees.</span>
<span class="sd">            Common values: ``0`` (geometric), ``-6`` (civil),</span>
<span class="sd">            ``-12`` (nautical), ``-18`` (astronomical).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Boolean array (``True`` = daytime).</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">elevation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_solar_elevation</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">elevation</span> <span class="o">&gt;</span> <span class="n">twilight_angle</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Solar correction</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">apply_solar_correction</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;normalize&quot;</span><span class="p">,</span> <span class="s2">&quot;residual&quot;</span><span class="p">,</span> <span class="s2">&quot;cos_correction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;normalize&quot;</span><span class="p">,</span>
        <span class="n">reference_zenith</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">45.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply solar correction to data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data : xr.DataArray</span>
<span class="sd">            Input data with a time dimension (``&#39;epoch&#39;`` or ``&#39;time&#39;``).</span>
<span class="sd">        method : str</span>
<span class="sd">            Correction method:</span>

<span class="sd">            * ``&#39;normalize&#39;``      â normalise by cos(zenith) relative to</span>
<span class="sd">              *reference_zenith*.</span>
<span class="sd">            * ``&#39;residual&#39;``       â subtract a 4th-order polynomial fitted</span>
<span class="sd">              to the diurnal pattern (1-D data only; falls back to</span>
<span class="sd">              ``&#39;normalize&#39;`` for multi-dimensional data).</span>
<span class="sd">            * ``&#39;cos_correction&#39;`` â simple cosine correction.</span>
<span class="sd">        reference_zenith : float</span>
<span class="sd">            Reference zenith angle for normalisation (degrees).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xr.DataArray</span>
<span class="sd">            Solar-corrected data with correction metadata in attrs.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">time_dim</span> <span class="o">=</span> <span class="s2">&quot;epoch&quot;</span> <span class="k">if</span> <span class="s2">&quot;epoch&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span> <span class="k">else</span> <span class="s2">&quot;time&quot;</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">time_dim</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="n">zenith</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_solar_position</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
        <span class="n">zenith_da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="n">zenith</span><span class="p">,</span>
            <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="n">time_dim</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">time_dim</span><span class="p">]},</span>
            <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="n">time_dim</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;normalize&quot;</span><span class="p">:</span>
            <span class="n">correction_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">reference_zenith</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">zenith_da</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">correction_factor</span> <span class="o">=</span> <span class="n">correction_factor</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>

            <span class="n">corrected</span> <span class="o">=</span> <span class="n">data</span> <span class="o">*</span> <span class="n">correction_factor</span>
            <span class="n">corrected</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;solar_correction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;normalized&quot;</span>
            <span class="n">corrected</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;reference_zenith&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reference_zenith</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;cos_correction&quot;</span><span class="p">:</span>
            <span class="n">correction_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">zenith_da</span><span class="p">))</span>
            <span class="n">correction_factor</span> <span class="o">=</span> <span class="n">correction_factor</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

            <span class="n">corrected</span> <span class="o">=</span> <span class="n">data</span> <span class="o">/</span> <span class="n">correction_factor</span>
            <span class="n">corrected</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;solar_correction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;cos_correction&quot;</span>

        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;residual&quot;</span><span class="p">:</span>
            <span class="n">hour</span> <span class="o">=</span> <span class="n">times</span><span class="o">.</span><span class="n">hour</span> <span class="o">+</span> <span class="n">times</span><span class="o">.</span><span class="n">minute</span> <span class="o">/</span> <span class="mf">60.0</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="n">coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">hour</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span> <span class="n">deg</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
                    <span class="n">solar_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">coeffs</span><span class="p">,</span> <span class="n">hour</span><span class="p">)</span>
                    <span class="n">solar_model_da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                        <span class="n">solar_model</span><span class="p">,</span>
                        <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="n">time_dim</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">time_dim</span><span class="p">]},</span>
                        <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="n">time_dim</span><span class="p">],</span>
                    <span class="p">)</span>
                    <span class="n">corrected</span> <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">solar_model_da</span>
                    <span class="n">corrected</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;solar_correction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;residual&quot;</span>
                    <span class="n">corrected</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;polynomial_degree&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Insufficient data for residual correction&quot;</span><span class="p">)</span>
                    <span class="n">corrected</span> <span class="o">=</span> <span class="n">data</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;Residual correction for multi-dimensional data not yet &quot;</span>
                    <span class="s2">&quot;implemented, using normalize instead&quot;</span>
                <span class="p">)</span>
                <span class="n">correction_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">reference_zenith</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">zenith_da</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="n">correction_factor</span> <span class="o">=</span> <span class="n">correction_factor</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
                <span class="n">corrected</span> <span class="o">=</span> <span class="n">data</span> <span class="o">*</span> <span class="n">correction_factor</span>
                <span class="n">corrected</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;solar_correction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;normalize_fallback&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown correction method: </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">corrected</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Binning &amp; sunrise/sunset</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_solar_bins</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">times</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">,</span>
        <span class="n">n_bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Bin times by solar elevation angle.</span>

<span class="sd">        Useful for solar-elevation-based composites instead of</span>
<span class="sd">        hour-of-day composites.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        times : np.ndarray or pd.DatetimeIndex</span>
<span class="sd">            Array of times.</span>
<span class="sd">        n_bins : int</span>
<span class="sd">            Number of solar elevation bins (range â20Â° to 90Â°).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Bin indices (0-based) for each time.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">elevation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_solar_elevation</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
        <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="n">n_bins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">bin_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">elevation</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">bin_indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n_bins</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_sunrise_sunset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">:</span> <span class="n">datetime</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute sunrise and sunset times for a given date.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        date : datetime</span>
<span class="sd">            Date to compute sunrise/sunset for.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        sunrise : pd.Timestamp or None</span>
<span class="sd">            Sunrise time in UTC, or ``None`` if the sun never rises.</span>
<span class="sd">        sunset : pd.Timestamp or None</span>
<span class="sd">            Sunset time in UTC, or ``None`` if the sun never sets.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span>
            <span class="n">start</span><span class="o">=</span><span class="n">date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
            <span class="n">end</span><span class="o">=</span><span class="n">date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">23</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">59</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">59</span><span class="p">),</span>
            <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;1min&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">elevation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_solar_elevation</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
        <span class="n">above_horizon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">elevation</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">sunrise</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">above_horizon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">above_horizon</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">sunset</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">above_horizon</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">above_horizon</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">sunrise</span><span class="p">,</span> <span class="n">sunset</span>

    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the developer-facing representation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            Representation string.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;pvlib&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pvlib</span> <span class="k">else</span> <span class="s2">&quot;builtin&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;SolarPositionCalculator(lat=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">Â°, lon=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">Â°, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;elevation=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">elevation</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">m, method=</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.SolarPositionCalculator.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">,</span> <span class="n">elevation</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">use_pvlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.SolarPositionCalculator.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the solar position calculator.</p>
<h5 id="canvod.grids.analysis.SolarPositionCalculator.__init__--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.SolarPositionCalculator.__init__--parameters" title="Permanent link">&para;</a></h5>
<p>lat : float
    Observer latitude in degrees.
lon : float
    Observer longitude in degrees.
elevation : float, default 0.0
    Elevation above sea level in metres.
use_pvlib : bool, default True
    Whether to use pvlib if available.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/solar.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">lat</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">lon</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">elevation</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="n">use_pvlib</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the solar position calculator.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    lat : float</span>
<span class="sd">        Observer latitude in degrees.</span>
<span class="sd">    lon : float</span>
<span class="sd">        Observer longitude in degrees.</span>
<span class="sd">    elevation : float, default 0.0</span>
<span class="sd">        Elevation above sea level in metres.</span>
<span class="sd">    use_pvlib : bool, default True</span>
<span class="sd">        Whether to use pvlib if available.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lat</span> <span class="o">=</span> <span class="n">lat</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">lon</span> <span class="o">=</span> <span class="n">lon</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">elevation</span> <span class="o">=</span> <span class="n">elevation</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">use_pvlib</span> <span class="o">=</span> <span class="n">use_pvlib</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pvlib</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">use_pvlib</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">pvlib</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">pvlib</span> <span class="o">=</span> <span class="n">pvlib</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using pvlib for solar position calculations&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;pvlib not available, falling back to built-in formulas. &quot;</span>
                <span class="s2">&quot;Install pvlib for higher accuracy: pip install pvlib&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">use_pvlib</span> <span class="o">=</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.SolarPositionCalculator.compute_solar_position" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_solar_position</span><span class="p">(</span><span class="n">times</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.SolarPositionCalculator.compute_solar_position" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Compute solar zenith and azimuth angles.</p>
<h5 id="canvod.grids.analysis.SolarPositionCalculator.compute_solar_position--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.SolarPositionCalculator.compute_solar_position--parameters" title="Permanent link">&para;</a></h5>
<p>times : np.ndarray or pd.DatetimeIndex
    Array of <code>datetime64</code> or <code>DatetimeIndex</code>.</p>
<h5 id="canvod.grids.analysis.SolarPositionCalculator.compute_solar_position--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.SolarPositionCalculator.compute_solar_position--returns" title="Permanent link">&para;</a></h5>
<p>solar_zenith : np.ndarray
    Solar zenith angles in degrees (0Â° = directly overhead).
solar_azimuth : np.ndarray
    Solar azimuth angles in degrees (0Â° = North, 90Â° = East).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/solar.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_solar_position</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">times</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute solar zenith and azimuth angles.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    times : np.ndarray or pd.DatetimeIndex</span>
<span class="sd">        Array of ``datetime64`` or ``DatetimeIndex``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    solar_zenith : np.ndarray</span>
<span class="sd">        Solar zenith angles in degrees (0Â° = directly overhead).</span>
<span class="sd">    solar_azimuth : np.ndarray</span>
<span class="sd">        Solar azimuth angles in degrees (0Â° = North, 90Â° = East).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pvlib</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvlib</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_solar_position_pvlib</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_solar_position_builtin</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.SolarPositionCalculator.compute_solar_elevation" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_solar_elevation</span><span class="p">(</span><span class="n">times</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.SolarPositionCalculator.compute_solar_elevation" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Compute solar elevation angle (complementary to zenith).</p>
<h5 id="canvod.grids.analysis.SolarPositionCalculator.compute_solar_elevation--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.SolarPositionCalculator.compute_solar_elevation--parameters" title="Permanent link">&para;</a></h5>
<p>times : np.ndarray or pd.DatetimeIndex
    Array of times.</p>
<h5 id="canvod.grids.analysis.SolarPositionCalculator.compute_solar_elevation--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.SolarPositionCalculator.compute_solar_elevation--returns" title="Permanent link">&para;</a></h5>
<p>np.ndarray
    Solar elevation angles in degrees (0Â° = horizon, 90Â° = overhead).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/solar.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_solar_elevation</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">times</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute solar elevation angle (complementary to zenith).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    times : np.ndarray or pd.DatetimeIndex</span>
<span class="sd">        Array of times.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Solar elevation angles in degrees (0Â° = horizon, 90Â° = overhead).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">zenith</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_solar_position</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
    <span class="k">return</span> <span class="mf">90.0</span> <span class="o">-</span> <span class="n">zenith</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.SolarPositionCalculator.is_daytime" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">is_daytime</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">twilight_angle</span><span class="o">=-</span><span class="mf">6.0</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.SolarPositionCalculator.is_daytime" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Determine if times are during daytime.</p>
<h5 id="canvod.grids.analysis.SolarPositionCalculator.is_daytime--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.SolarPositionCalculator.is_daytime--parameters" title="Permanent link">&para;</a></h5>
<p>times : np.ndarray or pd.DatetimeIndex
    Array of times.
twilight_angle : float
    Solar elevation threshold in degrees.
    Common values: <code>0</code> (geometric), <code>-6</code> (civil),
    <code>-12</code> (nautical), <code>-18</code> (astronomical).</p>
<h5 id="canvod.grids.analysis.SolarPositionCalculator.is_daytime--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.SolarPositionCalculator.is_daytime--returns" title="Permanent link">&para;</a></h5>
<p>np.ndarray
    Boolean array (<code>True</code> = daytime).</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/solar.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">is_daytime</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">times</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">,</span>
    <span class="n">twilight_angle</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Determine if times are during daytime.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    times : np.ndarray or pd.DatetimeIndex</span>
<span class="sd">        Array of times.</span>
<span class="sd">    twilight_angle : float</span>
<span class="sd">        Solar elevation threshold in degrees.</span>
<span class="sd">        Common values: ``0`` (geometric), ``-6`` (civil),</span>
<span class="sd">        ``-12`` (nautical), ``-18`` (astronomical).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Boolean array (``True`` = daytime).</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">elevation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_solar_elevation</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">elevation</span> <span class="o">&gt;</span> <span class="n">twilight_angle</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.SolarPositionCalculator.apply_solar_correction" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">apply_solar_correction</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;normalize&#39;</span><span class="p">,</span> <span class="n">reference_zenith</span><span class="o">=</span><span class="mf">45.0</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.SolarPositionCalculator.apply_solar_correction" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Apply solar correction to data.</p>
<h5 id="canvod.grids.analysis.SolarPositionCalculator.apply_solar_correction--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.SolarPositionCalculator.apply_solar_correction--parameters" title="Permanent link">&para;</a></h5>
<p>data : xr.DataArray
    Input data with a time dimension (<code>'epoch'</code> or <code>'time'</code>).
method : str
    Correction method:</p>
<div class="highlight"><pre><span></span><code>* ``&#39;normalize&#39;``      â normalise by cos(zenith) relative to
  *reference_zenith*.
* ``&#39;residual&#39;``       â subtract a 4th-order polynomial fitted
  to the diurnal pattern (1-D data only; falls back to
  ``&#39;normalize&#39;`` for multi-dimensional data).
* ``&#39;cos_correction&#39;`` â simple cosine correction.
</code></pre></div>
<p>reference_zenith : float
    Reference zenith angle for normalisation (degrees).</p>
<h5 id="canvod.grids.analysis.SolarPositionCalculator.apply_solar_correction--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.SolarPositionCalculator.apply_solar_correction--returns" title="Permanent link">&para;</a></h5>
<p>xr.DataArray
    Solar-corrected data with correction metadata in attrs.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/solar.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">apply_solar_correction</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;normalize&quot;</span><span class="p">,</span> <span class="s2">&quot;residual&quot;</span><span class="p">,</span> <span class="s2">&quot;cos_correction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;normalize&quot;</span><span class="p">,</span>
    <span class="n">reference_zenith</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">45.0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply solar correction to data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : xr.DataArray</span>
<span class="sd">        Input data with a time dimension (``&#39;epoch&#39;`` or ``&#39;time&#39;``).</span>
<span class="sd">    method : str</span>
<span class="sd">        Correction method:</span>

<span class="sd">        * ``&#39;normalize&#39;``      â normalise by cos(zenith) relative to</span>
<span class="sd">          *reference_zenith*.</span>
<span class="sd">        * ``&#39;residual&#39;``       â subtract a 4th-order polynomial fitted</span>
<span class="sd">          to the diurnal pattern (1-D data only; falls back to</span>
<span class="sd">          ``&#39;normalize&#39;`` for multi-dimensional data).</span>
<span class="sd">        * ``&#39;cos_correction&#39;`` â simple cosine correction.</span>
<span class="sd">    reference_zenith : float</span>
<span class="sd">        Reference zenith angle for normalisation (degrees).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xr.DataArray</span>
<span class="sd">        Solar-corrected data with correction metadata in attrs.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">time_dim</span> <span class="o">=</span> <span class="s2">&quot;epoch&quot;</span> <span class="k">if</span> <span class="s2">&quot;epoch&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span> <span class="k">else</span> <span class="s2">&quot;time&quot;</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">time_dim</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

    <span class="n">zenith</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_solar_position</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
    <span class="n">zenith_da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
        <span class="n">zenith</span><span class="p">,</span>
        <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="n">time_dim</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">time_dim</span><span class="p">]},</span>
        <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="n">time_dim</span><span class="p">],</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;normalize&quot;</span><span class="p">:</span>
        <span class="n">correction_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">reference_zenith</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">zenith_da</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">correction_factor</span> <span class="o">=</span> <span class="n">correction_factor</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>

        <span class="n">corrected</span> <span class="o">=</span> <span class="n">data</span> <span class="o">*</span> <span class="n">correction_factor</span>
        <span class="n">corrected</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;solar_correction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;normalized&quot;</span>
        <span class="n">corrected</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;reference_zenith&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reference_zenith</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;cos_correction&quot;</span><span class="p">:</span>
        <span class="n">correction_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">zenith_da</span><span class="p">))</span>
        <span class="n">correction_factor</span> <span class="o">=</span> <span class="n">correction_factor</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="n">corrected</span> <span class="o">=</span> <span class="n">data</span> <span class="o">/</span> <span class="n">correction_factor</span>
        <span class="n">corrected</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;solar_correction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;cos_correction&quot;</span>

    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;residual&quot;</span><span class="p">:</span>
        <span class="n">hour</span> <span class="o">=</span> <span class="n">times</span><span class="o">.</span><span class="n">hour</span> <span class="o">+</span> <span class="n">times</span><span class="o">.</span><span class="n">minute</span> <span class="o">/</span> <span class="mf">60.0</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">hour</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span> <span class="n">deg</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
                <span class="n">solar_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">coeffs</span><span class="p">,</span> <span class="n">hour</span><span class="p">)</span>
                <span class="n">solar_model_da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                    <span class="n">solar_model</span><span class="p">,</span>
                    <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="n">time_dim</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">time_dim</span><span class="p">]},</span>
                    <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="n">time_dim</span><span class="p">],</span>
                <span class="p">)</span>
                <span class="n">corrected</span> <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">solar_model_da</span>
                <span class="n">corrected</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;solar_correction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;residual&quot;</span>
                <span class="n">corrected</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;polynomial_degree&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Insufficient data for residual correction&quot;</span><span class="p">)</span>
                <span class="n">corrected</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;Residual correction for multi-dimensional data not yet &quot;</span>
                <span class="s2">&quot;implemented, using normalize instead&quot;</span>
            <span class="p">)</span>
            <span class="n">correction_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">reference_zenith</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">zenith_da</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">correction_factor</span> <span class="o">=</span> <span class="n">correction_factor</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
            <span class="n">corrected</span> <span class="o">=</span> <span class="n">data</span> <span class="o">*</span> <span class="n">correction_factor</span>
            <span class="n">corrected</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;solar_correction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;normalize_fallback&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown correction method: </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">corrected</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.SolarPositionCalculator.compute_solar_bins" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_solar_bins</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.SolarPositionCalculator.compute_solar_bins" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Bin times by solar elevation angle.</p>
<p>Useful for solar-elevation-based composites instead of
hour-of-day composites.</p>
<h5 id="canvod.grids.analysis.SolarPositionCalculator.compute_solar_bins--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.SolarPositionCalculator.compute_solar_bins--parameters" title="Permanent link">&para;</a></h5>
<p>times : np.ndarray or pd.DatetimeIndex
    Array of times.
n_bins : int
    Number of solar elevation bins (range â20Â° to 90Â°).</p>
<h5 id="canvod.grids.analysis.SolarPositionCalculator.compute_solar_bins--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.SolarPositionCalculator.compute_solar_bins--returns" title="Permanent link">&para;</a></h5>
<p>np.ndarray
    Bin indices (0-based) for each time.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/solar.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_solar_bins</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">times</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="n">pd</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">,</span>
    <span class="n">n_bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Bin times by solar elevation angle.</span>

<span class="sd">    Useful for solar-elevation-based composites instead of</span>
<span class="sd">    hour-of-day composites.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    times : np.ndarray or pd.DatetimeIndex</span>
<span class="sd">        Array of times.</span>
<span class="sd">    n_bins : int</span>
<span class="sd">        Number of solar elevation bins (range â20Â° to 90Â°).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Bin indices (0-based) for each time.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">elevation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_solar_elevation</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
    <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="n">n_bins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">bin_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">digitize</span><span class="p">(</span><span class="n">elevation</span><span class="p">,</span> <span class="n">bin_edges</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">bin_indices</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">n_bins</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.SolarPositionCalculator.get_sunrise_sunset" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_sunrise_sunset</span><span class="p">(</span><span class="n">date</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.SolarPositionCalculator.get_sunrise_sunset" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Compute sunrise and sunset times for a given date.</p>
<h5 id="canvod.grids.analysis.SolarPositionCalculator.get_sunrise_sunset--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.SolarPositionCalculator.get_sunrise_sunset--parameters" title="Permanent link">&para;</a></h5>
<p>date : datetime
    Date to compute sunrise/sunset for.</p>
<h5 id="canvod.grids.analysis.SolarPositionCalculator.get_sunrise_sunset--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.SolarPositionCalculator.get_sunrise_sunset--returns" title="Permanent link">&para;</a></h5>
<p>sunrise : pd.Timestamp or None
    Sunrise time in UTC, or <code>None</code> if the sun never rises.
sunset : pd.Timestamp or None
    Sunset time in UTC, or <code>None</code> if the sun never sets.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/solar.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_sunrise_sunset</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">date</span><span class="p">:</span> <span class="n">datetime</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span> <span class="o">|</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute sunrise and sunset times for a given date.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    date : datetime</span>
<span class="sd">        Date to compute sunrise/sunset for.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    sunrise : pd.Timestamp or None</span>
<span class="sd">        Sunrise time in UTC, or ``None`` if the sun never rises.</span>
<span class="sd">    sunset : pd.Timestamp or None</span>
<span class="sd">        Sunset time in UTC, or ``None`` if the sun never sets.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span>
        <span class="n">start</span><span class="o">=</span><span class="n">date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="n">end</span><span class="o">=</span><span class="n">date</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">hour</span><span class="o">=</span><span class="mi">23</span><span class="p">,</span> <span class="n">minute</span><span class="o">=</span><span class="mi">59</span><span class="p">,</span> <span class="n">second</span><span class="o">=</span><span class="mi">59</span><span class="p">),</span>
        <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;1min&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">elevation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_solar_elevation</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
    <span class="n">above_horizon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">elevation</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">sunrise</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">above_horizon</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">above_horizon</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>
    <span class="n">sunset</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">above_horizon</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">above_horizon</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">sunrise</span><span class="p">,</span> <span class="n">sunset</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.SolarPositionCalculator.__repr__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__repr__</span><span class="p">()</span></code>

<a href="#canvod.grids.analysis.SolarPositionCalculator.__repr__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Return the developer-facing representation.</p>
<h5 id="canvod.grids.analysis.SolarPositionCalculator.__repr__--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.SolarPositionCalculator.__repr__--returns" title="Permanent link">&para;</a></h5>
<p>str
    Representation string.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/solar.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the developer-facing representation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Representation string.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;pvlib&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_pvlib</span> <span class="k">else</span> <span class="s2">&quot;builtin&quot;</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;SolarPositionCalculator(lat=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lat</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">Â°, lon=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lon</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">Â°, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;elevation=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">elevation</span><span class="si">:</span><span class="s2">.0f</span><span class="si">}</span><span class="s2">m, method=</span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="canvod.grids.analysis.VODSpatialAnalyzer" class="doc doc-heading">
            <code>VODSpatialAnalyzer</code>


<a href="#canvod.grids.analysis.VODSpatialAnalyzer" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">



        <p>Per-cell spatial analysis of a VOD dataset.</p>
<h4 id="canvod.grids.analysis.VODSpatialAnalyzer--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.VODSpatialAnalyzer--parameters" title="Permanent link">&para;</a></h4>
<p>vod_data : xr.Dataset
    Dataset with a <code>cell_id_&lt;grid_name&gt;</code> variable already
    assigned.
grid : GridData
    Grid instance (must expose <code>.ncells</code>).
grid_name : str, optional
    Suffix for the cell-ID variable.</p>
<h4 id="canvod.grids.analysis.VODSpatialAnalyzer--raises">Raises<a class="headerlink" href="#canvod.grids.analysis.VODSpatialAnalyzer--raises" title="Permanent link">&para;</a></h4>
<p>ValueError
    If the expected cell-ID variable is missing.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/spatial.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">VODSpatialAnalyzer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Per-cell spatial analysis of a VOD dataset.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vod_data : xr.Dataset</span>
<span class="sd">        Dataset with a ``cell_id_&lt;grid_name&gt;`` variable already</span>
<span class="sd">        assigned.</span>
<span class="sd">    grid : GridData</span>
<span class="sd">        Grid instance (must expose ``.ncells``).</span>
<span class="sd">    grid_name : str, optional</span>
<span class="sd">        Suffix for the cell-ID variable.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the expected cell-ID variable is missing.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">vod_data</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
        <span class="n">grid</span><span class="p">:</span> <span class="n">GridData</span><span class="p">,</span>
        <span class="n">grid_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;equal_area_2deg&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the spatial analyzer.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vod_data : xr.Dataset</span>
<span class="sd">            Dataset with cell IDs.</span>
<span class="sd">        grid : GridData</span>
<span class="sd">            Grid instance.</span>
<span class="sd">        grid_name : str, default &quot;equal_area_2deg&quot;</span>
<span class="sd">            Grid name suffix for cell IDs.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vod_data</span> <span class="o">=</span> <span class="n">vod_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_name</span> <span class="o">=</span> <span class="n">grid_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_id_var</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;cell_id_</span><span class="si">{</span><span class="n">grid_name</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_id_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vod_data</span><span class="p">:</span>
            <span class="n">available</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vod_data</span><span class="o">.</span><span class="n">data_vars</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;cell_id_&quot;</span><span class="p">)]</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cell ID variable &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_id_var</span><span class="si">}</span><span class="s2">&#39; not found. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Available: </span><span class="si">{</span><span class="n">available</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;VODSpatialAnalyzer: grid=</span><span class="si">%s</span><span class="s2"> ncells=</span><span class="si">%d</span><span class="s2"> shape=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">grid_name</span><span class="p">,</span>
            <span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span>
            <span class="nb">dict</span><span class="p">(</span><span class="n">vod_data</span><span class="o">.</span><span class="n">sizes</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_spatial_statistics</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;VOD&quot;</span><span class="p">,</span>
        <span class="n">time_agg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute per-cell temporal statistics.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        var_name : str, optional</span>
<span class="sd">            Data variable to aggregate over time.</span>
<span class="sd">        time_agg : {&#39;mean&#39;, &#39;std&#39;, &#39;count&#39;, &#39;median&#39;}</span>
<span class="sd">            Aggregation function applied per cell.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Keys:</span>

<span class="sd">            ``grid_aligned`` : np.ndarray</span>
<span class="sd">                Shape ``(grid.ncells,)``.  NaN for cells without data.</span>
<span class="sd">                Use for masking, weighting, or any grid-indexed operation.</span>
<span class="sd">            ``patch_aligned`` : np.ndarray</span>
<span class="sd">                Compact array containing only cells with observations.</span>
<span class="sd">                Use when passing data to ``canvod-viz`` renderers.</span>
<span class="sd">            ``cell_ids_with_data`` : np.ndarray</span>
<span class="sd">                Integer cell IDs corresponding to ``patch_aligned``.</span>
<span class="sd">            ``metadata`` : dict</span>
<span class="sd">                ``valid_cells``, ``total_cells``, ``coverage_percent``,</span>
<span class="sd">                ``variable``, ``aggregation``.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If *var_name* is not in the dataset or *time_agg* is</span>
<span class="sd">            unrecognised.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">var_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vod_data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Variable &#39;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">&#39; not found. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Available: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vod_data</span><span class="o">.</span><span class="n">data_vars</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">_AGG_FUNCS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="s2">&quot;median&quot;</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">time_agg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_AGG_FUNCS</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unknown aggregation &#39;</span><span class="si">{</span><span class="n">time_agg</span><span class="si">}</span><span class="s2">&#39;; expected one of </span><span class="si">{</span><span class="n">_AGG_FUNCS</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;spatial statistics: var=</span><span class="si">%s</span><span class="s2"> agg=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">time_agg</span><span class="p">)</span>

        <span class="n">var_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vod_data</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
        <span class="n">cell_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vod_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_id_var</span><span class="p">]</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;cell_id&quot;</span><span class="p">:</span> <span class="n">cell_ids</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">var_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;no valid data after removing NaN values&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;grid_aligned&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span>
                <span class="s2">&quot;patch_aligned&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span>
                <span class="s2">&quot;cell_ids_with_data&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
                <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;valid_cells&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                    <span class="s2">&quot;total_cells&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span>
                    <span class="s2">&quot;coverage_percent&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                    <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">var_name</span><span class="p">,</span>
                    <span class="s2">&quot;aggregation&quot;</span><span class="p">:</span> <span class="n">time_agg</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">}</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> valid observations across </span><span class="si">%d</span><span class="s2"> cells&quot;</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;cell_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">(),</span>
        <span class="p">)</span>

        <span class="n">cell_stats</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;cell_id&quot;</span><span class="p">)[</span><span class="s2">&quot;value&quot;</span><span class="p">],</span> <span class="n">time_agg</span><span class="p">)()</span>

        <span class="n">grid_aligned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">patch_aligned</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cell_ids_with_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">cell_id</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">cell_stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">cell_id_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cell_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">cell_id_int</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">:</span>
                <span class="n">grid_aligned</span><span class="p">[</span><span class="n">cell_id_int</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">patch_aligned</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">cell_ids_with_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_id_int</span><span class="p">)</span>

        <span class="n">n_valid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">patch_aligned</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;spatial stats: </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2"> cells with data&quot;</span><span class="p">,</span> <span class="n">n_valid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;grid_aligned&quot;</span><span class="p">:</span> <span class="n">grid_aligned</span><span class="p">,</span>
            <span class="s2">&quot;patch_aligned&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">patch_aligned</span><span class="p">),</span>
            <span class="s2">&quot;cell_ids_with_data&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cell_ids_with_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
            <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;valid_cells&quot;</span><span class="p">:</span> <span class="n">n_valid</span><span class="p">,</span>
                <span class="s2">&quot;total_cells&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span>
                <span class="s2">&quot;coverage_percent&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">n_valid</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">var_name</span><span class="p">,</span>
                <span class="s2">&quot;aggregation&quot;</span><span class="p">:</span> <span class="n">time_agg</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compare_filtering_methods</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">original_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;VOD&quot;</span><span class="p">,</span>
        <span class="n">filtered_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;VOD_filtered&quot;</span><span class="p">,</span>
        <span class="n">figsize</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
        <span class="n">ax</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Histogram comparison of original vs filtered VOD distributions.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        original_var : str, optional</span>
<span class="sd">            Unfiltered variable name.</span>
<span class="sd">        filtered_var : str, optional</span>
<span class="sd">            Filtered variable name.</span>
<span class="sd">        figsize : tuple, optional</span>
<span class="sd">            Figure size when *ax* is ``None``.</span>
<span class="sd">        ax : tuple of two plt.Axes or None, optional</span>
<span class="sd">            Pre-existing axes pair.  Created if ``None``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig, axes : plt.Figure, np.ndarray of plt.Axes</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axes</span> <span class="o">=</span> <span class="n">ax</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">figure</span>

        <span class="n">stats_orig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_spatial_statistics</span><span class="p">(</span><span class="n">original_var</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">)</span>
        <span class="n">stats_filt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_spatial_statistics</span><span class="p">(</span><span class="n">filtered_var</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">)</span>

        <span class="n">data_orig</span> <span class="o">=</span> <span class="n">stats_orig</span><span class="p">[</span><span class="s2">&quot;grid_aligned&quot;</span><span class="p">]</span>
        <span class="n">data_filt</span> <span class="o">=</span> <span class="n">stats_filt</span><span class="p">[</span><span class="s2">&quot;grid_aligned&quot;</span><span class="p">]</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
            <span class="n">data_orig</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data_orig</span><span class="p">)],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Original&quot;</span>
        <span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original VOD Distribution&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;VOD&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
            <span class="n">data_filt</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data_filt</span><span class="p">)],</span>
            <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Filtered&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Filtered VOD Distribution&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;VOD&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.VODSpatialAnalyzer.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">vod_data</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">grid_name</span><span class="o">=</span><span class="s1">&#39;equal_area_2deg&#39;</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.VODSpatialAnalyzer.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the spatial analyzer.</p>
<h5 id="canvod.grids.analysis.VODSpatialAnalyzer.__init__--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.VODSpatialAnalyzer.__init__--parameters" title="Permanent link">&para;</a></h5>
<p>vod_data : xr.Dataset
    Dataset with cell IDs.
grid : GridData
    Grid instance.
grid_name : str, default "equal_area_2deg"
    Grid name suffix for cell IDs.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/spatial.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span>
<span class="normal">92</span>
<span class="normal">93</span>
<span class="normal">94</span>
<span class="normal">95</span>
<span class="normal">96</span>
<span class="normal">97</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">vod_data</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="n">grid</span><span class="p">:</span> <span class="n">GridData</span><span class="p">,</span>
    <span class="n">grid_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;equal_area_2deg&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the spatial analyzer.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vod_data : xr.Dataset</span>
<span class="sd">        Dataset with cell IDs.</span>
<span class="sd">    grid : GridData</span>
<span class="sd">        Grid instance.</span>
<span class="sd">    grid_name : str, default &quot;equal_area_2deg&quot;</span>
<span class="sd">        Grid name suffix for cell IDs.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">vod_data</span> <span class="o">=</span> <span class="n">vod_data</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">grid_name</span> <span class="o">=</span> <span class="n">grid_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cell_id_var</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;cell_id_</span><span class="si">{</span><span class="n">grid_name</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_id_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vod_data</span><span class="p">:</span>
        <span class="n">available</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vod_data</span><span class="o">.</span><span class="n">data_vars</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;cell_id_&quot;</span><span class="p">)]</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Cell ID variable &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_id_var</span><span class="si">}</span><span class="s2">&#39; not found. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Available: </span><span class="si">{</span><span class="n">available</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;VODSpatialAnalyzer: grid=</span><span class="si">%s</span><span class="s2"> ncells=</span><span class="si">%d</span><span class="s2"> shape=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">grid_name</span><span class="p">,</span>
        <span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span>
        <span class="nb">dict</span><span class="p">(</span><span class="n">vod_data</span><span class="o">.</span><span class="n">sizes</span><span class="p">),</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.VODSpatialAnalyzer.compute_spatial_statistics" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_spatial_statistics</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;VOD&#39;</span><span class="p">,</span> <span class="n">time_agg</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.VODSpatialAnalyzer.compute_spatial_statistics" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Compute per-cell temporal statistics.</p>
<h5 id="canvod.grids.analysis.VODSpatialAnalyzer.compute_spatial_statistics--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.VODSpatialAnalyzer.compute_spatial_statistics--parameters" title="Permanent link">&para;</a></h5>
<p>var_name : str, optional
    Data variable to aggregate over time.
time_agg : {'mean', 'std', 'count', 'median'}
    Aggregation function applied per cell.</p>
<h5 id="canvod.grids.analysis.VODSpatialAnalyzer.compute_spatial_statistics--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.VODSpatialAnalyzer.compute_spatial_statistics--returns" title="Permanent link">&para;</a></h5>
<p>dict
    Keys:</p>
<div class="highlight"><pre><span></span><code>``grid_aligned`` : np.ndarray
    Shape ``(grid.ncells,)``.  NaN for cells without data.
    Use for masking, weighting, or any grid-indexed operation.
``patch_aligned`` : np.ndarray
    Compact array containing only cells with observations.
    Use when passing data to ``canvod-viz`` renderers.
``cell_ids_with_data`` : np.ndarray
    Integer cell IDs corresponding to ``patch_aligned``.
``metadata`` : dict
    ``valid_cells``, ``total_cells``, ``coverage_percent``,
    ``variable``, ``aggregation``.
</code></pre></div>
<h5 id="canvod.grids.analysis.VODSpatialAnalyzer.compute_spatial_statistics--raises">Raises<a class="headerlink" href="#canvod.grids.analysis.VODSpatialAnalyzer.compute_spatial_statistics--raises" title="Permanent link">&para;</a></h5>
<p>ValueError
    If <em>var_name</em> is not in the dataset or <em>time_agg</em> is
    unrecognised.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/spatial.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_spatial_statistics</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;VOD&quot;</span><span class="p">,</span>
    <span class="n">time_agg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute per-cell temporal statistics.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    var_name : str, optional</span>
<span class="sd">        Data variable to aggregate over time.</span>
<span class="sd">    time_agg : {&#39;mean&#39;, &#39;std&#39;, &#39;count&#39;, &#39;median&#39;}</span>
<span class="sd">        Aggregation function applied per cell.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Keys:</span>

<span class="sd">        ``grid_aligned`` : np.ndarray</span>
<span class="sd">            Shape ``(grid.ncells,)``.  NaN for cells without data.</span>
<span class="sd">            Use for masking, weighting, or any grid-indexed operation.</span>
<span class="sd">        ``patch_aligned`` : np.ndarray</span>
<span class="sd">            Compact array containing only cells with observations.</span>
<span class="sd">            Use when passing data to ``canvod-viz`` renderers.</span>
<span class="sd">        ``cell_ids_with_data`` : np.ndarray</span>
<span class="sd">            Integer cell IDs corresponding to ``patch_aligned``.</span>
<span class="sd">        ``metadata`` : dict</span>
<span class="sd">            ``valid_cells``, ``total_cells``, ``coverage_percent``,</span>
<span class="sd">            ``variable``, ``aggregation``.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If *var_name* is not in the dataset or *time_agg* is</span>
<span class="sd">        unrecognised.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">var_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vod_data</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Variable &#39;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">&#39; not found. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Available: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vod_data</span><span class="o">.</span><span class="n">data_vars</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">_AGG_FUNCS</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="s2">&quot;median&quot;</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">time_agg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_AGG_FUNCS</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unknown aggregation &#39;</span><span class="si">{</span><span class="n">time_agg</span><span class="si">}</span><span class="s2">&#39;; expected one of </span><span class="si">{</span><span class="n">_AGG_FUNCS</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;spatial statistics: var=</span><span class="si">%s</span><span class="s2"> agg=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">time_agg</span><span class="p">)</span>

    <span class="n">var_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vod_data</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
    <span class="n">cell_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vod_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_id_var</span><span class="p">]</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;cell_id&quot;</span><span class="p">:</span> <span class="n">cell_ids</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">var_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;no valid data after removing NaN values&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;grid_aligned&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span>
            <span class="s2">&quot;patch_aligned&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span>
            <span class="s2">&quot;cell_ids_with_data&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
            <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;valid_cells&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;total_cells&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span>
                <span class="s2">&quot;coverage_percent&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">var_name</span><span class="p">,</span>
                <span class="s2">&quot;aggregation&quot;</span><span class="p">:</span> <span class="n">time_agg</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;</span><span class="si">%d</span><span class="s2"> valid observations across </span><span class="si">%d</span><span class="s2"> cells&quot;</span><span class="p">,</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">),</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;cell_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">(),</span>
    <span class="p">)</span>

    <span class="n">cell_stats</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;cell_id&quot;</span><span class="p">)[</span><span class="s2">&quot;value&quot;</span><span class="p">],</span> <span class="n">time_agg</span><span class="p">)()</span>

    <span class="n">grid_aligned</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">patch_aligned</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">cell_ids_with_data</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">cell_id</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">cell_stats</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">cell_id_int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cell_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">cell_id_int</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">:</span>
            <span class="n">grid_aligned</span><span class="p">[</span><span class="n">cell_id_int</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="n">patch_aligned</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="n">cell_ids_with_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_id_int</span><span class="p">)</span>

    <span class="n">n_valid</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">patch_aligned</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;spatial stats: </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2"> cells with data&quot;</span><span class="p">,</span> <span class="n">n_valid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;grid_aligned&quot;</span><span class="p">:</span> <span class="n">grid_aligned</span><span class="p">,</span>
        <span class="s2">&quot;patch_aligned&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">patch_aligned</span><span class="p">),</span>
        <span class="s2">&quot;cell_ids_with_data&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cell_ids_with_data</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">),</span>
        <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;valid_cells&quot;</span><span class="p">:</span> <span class="n">n_valid</span><span class="p">,</span>
            <span class="s2">&quot;total_cells&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span>
            <span class="s2">&quot;coverage_percent&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">n_valid</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">var_name</span><span class="p">,</span>
            <span class="s2">&quot;aggregation&quot;</span><span class="p">:</span> <span class="n">time_agg</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.VODSpatialAnalyzer.compare_filtering_methods" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compare_filtering_methods</span><span class="p">(</span><span class="n">original_var</span><span class="o">=</span><span class="s1">&#39;VOD&#39;</span><span class="p">,</span> <span class="n">filtered_var</span><span class="o">=</span><span class="s1">&#39;VOD_filtered&#39;</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.VODSpatialAnalyzer.compare_filtering_methods" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Histogram comparison of original vs filtered VOD distributions.</p>
<h5 id="canvod.grids.analysis.VODSpatialAnalyzer.compare_filtering_methods--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.VODSpatialAnalyzer.compare_filtering_methods--parameters" title="Permanent link">&para;</a></h5>
<p>original_var : str, optional
    Unfiltered variable name.
filtered_var : str, optional
    Filtered variable name.
figsize : tuple, optional
    Figure size when <em>ax</em> is <code>None</code>.
ax : tuple of two plt.Axes or None, optional
    Pre-existing axes pair.  Created if <code>None</code>.</p>
<h5 id="canvod.grids.analysis.VODSpatialAnalyzer.compare_filtering_methods--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.VODSpatialAnalyzer.compare_filtering_methods--returns" title="Permanent link">&para;</a></h5>
<p>fig, axes : plt.Figure, np.ndarray of plt.Axes</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/spatial.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compare_filtering_methods</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">original_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;VOD&quot;</span><span class="p">,</span>
    <span class="n">filtered_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;VOD_filtered&quot;</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
    <span class="n">ax</span><span class="p">:</span> <span class="nb">tuple</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Histogram comparison of original vs filtered VOD distributions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    original_var : str, optional</span>
<span class="sd">        Unfiltered variable name.</span>
<span class="sd">    filtered_var : str, optional</span>
<span class="sd">        Filtered variable name.</span>
<span class="sd">    figsize : tuple, optional</span>
<span class="sd">        Figure size when *ax* is ``None``.</span>
<span class="sd">    ax : tuple of two plt.Axes or None, optional</span>
<span class="sd">        Pre-existing axes pair.  Created if ``None``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig, axes : plt.Figure, np.ndarray of plt.Axes</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="n">ax</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">figure</span>

    <span class="n">stats_orig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_spatial_statistics</span><span class="p">(</span><span class="n">original_var</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">)</span>
    <span class="n">stats_filt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_spatial_statistics</span><span class="p">(</span><span class="n">filtered_var</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">)</span>

    <span class="n">data_orig</span> <span class="o">=</span> <span class="n">stats_orig</span><span class="p">[</span><span class="s2">&quot;grid_aligned&quot;</span><span class="p">]</span>
    <span class="n">data_filt</span> <span class="o">=</span> <span class="n">stats_filt</span><span class="p">[</span><span class="s2">&quot;grid_aligned&quot;</span><span class="p">]</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
        <span class="n">data_orig</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data_orig</span><span class="p">)],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Original&quot;</span>
    <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Original VOD Distribution&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;VOD&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
        <span class="n">data_filt</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">data_filt</span><span class="p">)],</span>
        <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Filtered&quot;</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;green&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Filtered VOD Distribution&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;VOD&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Frequency&quot;</span><span class="p">)</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="canvod.grids.analysis.TemporalAnalysis" class="doc doc-heading">
            <code>TemporalAnalysis</code>


<a href="#canvod.grids.analysis.TemporalAnalysis" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">



        <p>Temporal analysis of gridded VOD data.</p>
<p>Binds a VOD dataset (with pre-assigned cell IDs) to a grid and
exposes weighted aggregation, diurnal analysis, and plotting.</p>
<h4 id="canvod.grids.analysis.TemporalAnalysis--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.TemporalAnalysis--parameters" title="Permanent link">&para;</a></h4>
<p>vod_ds : xr.Dataset
    Dataset containing VOD data and a <code>cell_id_&lt;grid_name&gt;</code>
    variable.
grid : GridData
    Grid instance (must expose <code>.ncells</code>).
grid_name : str
    Suffix for the cell-ID variable (e.g. <code>'htm_10deg'</code>).
site_lat : float or None, optional
    Site latitude in degrees.  Required for solar methods.
site_lon : float or None, optional
    Site longitude in degrees.  Required for solar methods.
site_elevation : float, optional
    Site elevation in metres (default 0).</p>
<h4 id="canvod.grids.analysis.TemporalAnalysis--raises">Raises<a class="headerlink" href="#canvod.grids.analysis.TemporalAnalysis--raises" title="Permanent link">&para;</a></h4>
<p>ValueError
    If <code>cell_id_&lt;grid_name&gt;</code> is not present in <em>vod_ds</em>.</p>
<h4 id="canvod.grids.analysis.TemporalAnalysis--examples">Examples<a class="headerlink" href="#canvod.grids.analysis.TemporalAnalysis--examples" title="Permanent link">&para;</a></h4>
<blockquote>
<blockquote>
<blockquote>
<p>analysis = TemporalAnalysis(vod_ds, grid, "htm_10deg")
ts = analysis.compute_timeseries(aggregate="1D")</p>
</blockquote>
</blockquote>
</blockquote>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/temporal.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span>
<span class="normal">701</span>
<span class="normal">702</span>
<span class="normal">703</span>
<span class="normal">704</span>
<span class="normal">705</span>
<span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span>
<span class="normal">751</span>
<span class="normal">752</span>
<span class="normal">753</span>
<span class="normal">754</span>
<span class="normal">755</span>
<span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span>
<span class="normal">859</span>
<span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span>
<span class="normal">914</span>
<span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span>
<span class="normal">973</span>
<span class="normal">974</span>
<span class="normal">975</span>
<span class="normal">976</span>
<span class="normal">977</span>
<span class="normal">978</span>
<span class="normal">979</span>
<span class="normal">980</span>
<span class="normal">981</span>
<span class="normal">982</span>
<span class="normal">983</span>
<span class="normal">984</span>
<span class="normal">985</span>
<span class="normal">986</span>
<span class="normal">987</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TemporalAnalysis</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Temporal analysis of gridded VOD data.</span>

<span class="sd">    Binds a VOD dataset (with pre-assigned cell IDs) to a grid and</span>
<span class="sd">    exposes weighted aggregation, diurnal analysis, and plotting.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vod_ds : xr.Dataset</span>
<span class="sd">        Dataset containing VOD data and a ``cell_id_&lt;grid_name&gt;``</span>
<span class="sd">        variable.</span>
<span class="sd">    grid : GridData</span>
<span class="sd">        Grid instance (must expose ``.ncells``).</span>
<span class="sd">    grid_name : str</span>
<span class="sd">        Suffix for the cell-ID variable (e.g. ``&#39;htm_10deg&#39;``).</span>
<span class="sd">    site_lat : float or None, optional</span>
<span class="sd">        Site latitude in degrees.  Required for solar methods.</span>
<span class="sd">    site_lon : float or None, optional</span>
<span class="sd">        Site longitude in degrees.  Required for solar methods.</span>
<span class="sd">    site_elevation : float, optional</span>
<span class="sd">        Site elevation in metres (default 0).</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If ``cell_id_&lt;grid_name&gt;`` is not present in *vod_ds*.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; analysis = TemporalAnalysis(vod_ds, grid, &quot;htm_10deg&quot;)</span>
<span class="sd">    &gt;&gt;&gt; ts = analysis.compute_timeseries(aggregate=&quot;1D&quot;)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">vod_ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
        <span class="n">grid</span><span class="p">:</span> <span class="n">GridData</span><span class="p">,</span>
        <span class="n">grid_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">site_lat</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">site_lon</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">site_elevation</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the temporal analysis helper.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vod_ds : xr.Dataset</span>
<span class="sd">            VOD dataset containing cell IDs.</span>
<span class="sd">        grid : GridData</span>
<span class="sd">            Grid instance.</span>
<span class="sd">        grid_name : str</span>
<span class="sd">            Grid name suffix for cell IDs.</span>
<span class="sd">        site_lat : float | None, optional</span>
<span class="sd">            Site latitude in degrees.</span>
<span class="sd">        site_lon : float | None, optional</span>
<span class="sd">            Site longitude in degrees.</span>
<span class="sd">        site_elevation : float, default 0.0</span>
<span class="sd">            Site elevation in metres.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vod_ds</span> <span class="o">=</span> <span class="n">vod_ds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid_name</span> <span class="o">=</span> <span class="n">grid_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_id_var</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;cell_id_</span><span class="si">{</span><span class="n">grid_name</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Solar calculator (optional)</span>
        <span class="k">if</span> <span class="n">site_lat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">site_lon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solar_calc</span><span class="p">:</span> <span class="n">SolarPositionCalculator</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">SolarPositionCalculator</span><span class="p">(</span>
                <span class="n">lat</span><span class="o">=</span><span class="n">site_lat</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">site_lon</span><span class="p">,</span> <span class="n">elevation</span><span class="o">=</span><span class="n">site_elevation</span>
            <span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;solar calculator enabled for (</span><span class="si">%.4f</span><span class="s2">Â°, </span><span class="si">%.4f</span><span class="s2">Â°)&quot;</span><span class="p">,</span>
                <span class="n">site_lat</span><span class="p">,</span>
                <span class="n">site_lon</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solar_calc</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Validate dataset</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_id_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vod_ds</span><span class="p">:</span>
            <span class="n">available</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vod_ds</span><span class="o">.</span><span class="n">data_vars</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;cell_id_&quot;</span><span class="p">)]</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Cell ID variable &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_id_var</span><span class="si">}</span><span class="s2">&#39; not found in dataset. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Available: </span><span class="si">{</span><span class="n">available</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Core aggregation</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_timeseries</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;VOD&quot;</span><span class="p">,</span>
        <span class="n">spatial_mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">aggregate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1D&quot;</span><span class="p">,</span>
        <span class="n">min_cells</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute a weighted time-series aggregated over space.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        var_name : str, optional</span>
<span class="sd">            Data variable to aggregate.</span>
<span class="sd">        spatial_mask : np.ndarray or None, optional</span>
<span class="sd">            Boolean mask of shape ``(grid.ncells,)``; ``True`` = include.</span>
<span class="sd">        weights : np.ndarray or None, optional</span>
<span class="sd">            Cell weights of shape ``(grid.ncells,)``; normalised</span>
<span class="sd">            internally.  ``None`` â uniform weights.</span>
<span class="sd">        aggregate : str, optional</span>
<span class="sd">            Pandas-compatible frequency string for temporal resampling.</span>
<span class="sd">        min_cells : int, optional</span>
<span class="sd">            Minimum unique cells required per time bin.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xr.Dataset</span>
<span class="sd">            Variables: ``mean``, ``std``, ``n_cells``,</span>
<span class="sd">            ``n_observations``, ``sum_weights``.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If *var_name* is missing or mask/weight shapes are wrong.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">var_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vod_ds</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variable &#39;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">&#39; not found in dataset&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;compute_timeseries: var=</span><span class="si">%s</span><span class="s2"> aggregate=</span><span class="si">%s</span><span class="s2"> mask=</span><span class="si">%s</span><span class="s2"> weights=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">var_name</span><span class="p">,</span>
            <span class="n">aggregate</span><span class="p">,</span>
            <span class="n">spatial_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">var_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vod_ds</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
        <span class="n">cell_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vod_ds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_id_var</span><span class="p">]</span>

        <span class="c1"># Apply spatial mask</span>
        <span class="k">if</span> <span class="n">spatial_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">spatial_mask</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Spatial mask shape </span><span class="si">{</span><span class="n">spatial_mask</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> doesn&#39;t match &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;grid size (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="si">}</span><span class="s2">,)&quot;</span>
                <span class="p">)</span>
            <span class="n">data_mask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">cell_ids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cell_id</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">spatial_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">data_mask</span> <span class="o">=</span> <span class="n">data_mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">cell_ids</span> <span class="o">==</span> <span class="n">cell_id</span><span class="p">)</span>
            <span class="n">var_data</span> <span class="o">=</span> <span class="n">var_data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data_mask</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;spatial mask applied: </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2"> cells&quot;</span><span class="p">,</span>
                <span class="n">spatial_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Prepare weights</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_weights</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_weighted_timeseries</span><span class="p">(</span>
            <span class="n">var_data</span><span class="p">,</span> <span class="n">cell_ids</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">aggregate</span><span class="p">,</span> <span class="n">min_cells</span>
        <span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Solar-corrected aggregation</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_timeseries_solar_corrected</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;VOD&quot;</span><span class="p">,</span>
        <span class="n">spatial_mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">aggregate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1D&quot;</span><span class="p">,</span>
        <span class="n">min_cells</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">solar_correction</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span>
            <span class="s2">&quot;normalize&quot;</span><span class="p">,</span> <span class="s2">&quot;residual&quot;</span><span class="p">,</span> <span class="s2">&quot;cos_correction&quot;</span>
        <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;normalize&quot;</span><span class="p">,</span>
        <span class="n">reference_zenith</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">45.0</span><span class="p">,</span>
        <span class="n">daytime_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">twilight_angle</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute a time-series after applying a solar correction.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        var_name : str, optional</span>
<span class="sd">            Data variable to correct and aggregate.</span>
<span class="sd">        spatial_mask : np.ndarray or None, optional</span>
<span class="sd">            Cell selection mask.</span>
<span class="sd">        weights : np.ndarray or None, optional</span>
<span class="sd">            Cell weights.</span>
<span class="sd">        aggregate : str, optional</span>
<span class="sd">            Temporal resampling frequency.</span>
<span class="sd">        min_cells : int, optional</span>
<span class="sd">            Minimum cells per time bin.</span>
<span class="sd">        solar_correction : {&#39;normalize&#39;, &#39;residual&#39;, &#39;cos_correction&#39;}</span>
<span class="sd">            Correction method passed to</span>
<span class="sd">            :meth:`SolarPositionCalculator.apply_solar_correction`.</span>
<span class="sd">        reference_zenith : float, optional</span>
<span class="sd">            Reference zenith for normalisation (degrees).</span>
<span class="sd">        daytime_only : bool, optional</span>
<span class="sd">            If ``True``, mask out nighttime epochs.</span>
<span class="sd">        twilight_angle : float, optional</span>
<span class="sd">            Solar-elevation threshold for daytime (degrees).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xr.Dataset</span>
<span class="sd">            Solar-corrected time-series with additional metadata attrs.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If no solar calculator is configured.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solar_calc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Solar calculator not initialized. &quot;</span>
                <span class="s2">&quot;Provide site_lat and site_lon to TemporalAnalysis constructor.&quot;</span>
            <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;solar-corrected timeseries: correction=</span><span class="si">%s</span><span class="s2"> daytime_only=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">solar_correction</span><span class="p">,</span>
            <span class="n">daytime_only</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">var_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vod_ds</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>

        <span class="c1"># Apply solar correction</span>
        <span class="n">var_data_corrected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solar_calc</span><span class="o">.</span><span class="n">apply_solar_correction</span><span class="p">(</span>
            <span class="n">var_data</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">solar_correction</span><span class="p">,</span> <span class="n">reference_zenith</span><span class="o">=</span><span class="n">reference_zenith</span>
        <span class="p">)</span>

        <span class="c1"># Daytime filter</span>
        <span class="k">if</span> <span class="n">daytime_only</span><span class="p">:</span>
            <span class="n">times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">var_data</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="n">is_day</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solar_calc</span><span class="o">.</span><span class="n">is_daytime</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">twilight_angle</span><span class="p">)</span>
            <span class="n">is_day_da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                <span class="n">is_day</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="n">var_data_corrected</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]},</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">var_data_corrected</span> <span class="o">=</span> <span class="n">var_data_corrected</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_day_da</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="s2">&quot;daytime filter: </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2"> timesteps kept&quot;</span><span class="p">,</span>
                <span class="n">is_day</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">is_day</span><span class="p">),</span>
            <span class="p">)</span>

        <span class="c1"># Temporary dataset with corrected variable</span>
        <span class="n">corrected_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">_solar_corrected&quot;</span>
        <span class="n">ds_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vod_ds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ds_temp</span><span class="p">[</span><span class="n">corrected_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">var_data_corrected</span>

        <span class="c1"># Reuse compute_timeseries via a lightweight temporary instance</span>
        <span class="n">analysis_temp</span> <span class="o">=</span> <span class="n">TemporalAnalysis</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">TemporalAnalysis</span><span class="p">)</span>
        <span class="n">analysis_temp</span><span class="o">.</span><span class="n">vod_ds</span> <span class="o">=</span> <span class="n">ds_temp</span>
        <span class="n">analysis_temp</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span>
        <span class="n">analysis_temp</span><span class="o">.</span><span class="n">grid_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_name</span>
        <span class="n">analysis_temp</span><span class="o">.</span><span class="n">cell_id_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_id_var</span>
        <span class="n">analysis_temp</span><span class="o">.</span><span class="n">solar_calc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solar_calc</span>

        <span class="n">ts</span> <span class="o">=</span> <span class="n">analysis_temp</span><span class="o">.</span><span class="n">compute_timeseries</span><span class="p">(</span>
            <span class="n">var_name</span><span class="o">=</span><span class="n">corrected_name</span><span class="p">,</span>
            <span class="n">spatial_mask</span><span class="o">=</span><span class="n">spatial_mask</span><span class="p">,</span>
            <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
            <span class="n">aggregate</span><span class="o">=</span><span class="n">aggregate</span><span class="p">,</span>
            <span class="n">min_cells</span><span class="o">=</span><span class="n">min_cells</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Solar metadata</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;solar_correction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solar_correction</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;reference_zenith&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reference_zenith</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;daytime_only&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daytime_only</span>
        <span class="k">if</span> <span class="n">daytime_only</span><span class="p">:</span>
            <span class="n">ts</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;twilight_angle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">twilight_angle</span>

        <span class="k">return</span> <span class="n">ts</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Internal helpers</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate and normalise a weight array.</span>

<span class="sd">        Returns uniform weights when *weights* is ``None``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;using uniform weights&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span>

        <span class="k">if</span> <span class="n">weights</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Weights shape </span><span class="si">{</span><span class="n">weights</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> doesn&#39;t match &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;grid size (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="si">}</span><span class="s2">,)&quot;</span>
            <span class="p">)</span>
        <span class="n">w_sum</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">w_sum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">/</span> <span class="n">w_sum</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;using provided weights (sum before normalisation=</span><span class="si">%.4f</span><span class="s2">)&quot;</span><span class="p">,</span> <span class="n">w_sum</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">weights</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_weighted_timeseries</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">var_data</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
        <span class="n">cell_ids</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">,</span>
        <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">aggregate</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">min_cells</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregate *var_data* into time bins with cell weights.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xr.Dataset</span>
<span class="sd">            ``mean``, ``std``, ``n_cells``, ``n_observations``,</span>
<span class="sd">            ``sum_weights`` on the ``epoch`` dimension.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">var_data</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">n_sid</span> <span class="o">=</span> <span class="n">var_data</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sid&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Flatten (epoch Ã sid) â 1-D</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">var_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="n">cell_ids</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="n">valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span>
        <span class="n">times_valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">n_sid</span><span class="p">)[</span><span class="n">valid</span><span class="p">]</span>
        <span class="n">values_valid</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>
        <span class="n">cells_valid</span> <span class="o">=</span> <span class="n">cells</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="n">times_valid</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">values_valid</span><span class="p">,</span> <span class="s2">&quot;cell_id&quot;</span><span class="p">:</span> <span class="n">cells_valid</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;cell_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">cid</span><span class="p">:</span> <span class="n">weights</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="k">if</span> <span class="n">cid</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">])</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">)</span>

        <span class="n">grouped</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="n">aggregate</span><span class="p">))</span>

        <span class="n">result_rows</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">time_bin</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">n_cells</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s2">&quot;cell_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">n_cells</span> <span class="o">&lt;</span> <span class="n">min_cells</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">w</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">w_sum</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">w_sum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">weighted_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
                <span class="n">weighted_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">v</span> <span class="o">-</span> <span class="n">weighted_mean</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">))</span>
                <span class="n">result_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="n">time_bin</span><span class="p">,</span>
                        <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">weighted_mean</span><span class="p">,</span>
                        <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="n">weighted_std</span><span class="p">,</span>
                        <span class="s2">&quot;n_cells&quot;</span><span class="p">:</span> <span class="n">n_cells</span><span class="p">,</span>
                        <span class="s2">&quot;n_observations&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">),</span>
                        <span class="s2">&quot;sum_weights&quot;</span><span class="p">:</span> <span class="n">w_sum</span><span class="p">,</span>
                    <span class="p">}</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">result_rows</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;no data after aggregation&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">()</span>

        <span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result_rows</span><span class="p">)</span>
        <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
                <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
                <span class="s2">&quot;n_cells&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;n_cells&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
                <span class="s2">&quot;n_observations&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;n_observations&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
                <span class="s2">&quot;sum_weights&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;sum_weights&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">),</span>
            <span class="p">},</span>
            <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;variable&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">var_data</span><span class="o">.</span><span class="n">name</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;grid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_name</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;aggregation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">aggregate</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;min_cells&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_cells</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;timeseries computed: </span><span class="si">%d</span><span class="s2"> steps, mean n_cells=</span><span class="si">%.1f</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">result_df</span><span class="p">),</span>
            <span class="n">result_df</span><span class="p">[</span><span class="s2">&quot;n_cells&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ds</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Diurnal cycle</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_diurnal_cycle</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;VOD&quot;</span><span class="p">,</span>
        <span class="n">spatial_mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">hour_bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
        <span class="n">min_observations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute clock-time diurnal cycle (hour-of-day statistics).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        var_name : str, optional</span>
<span class="sd">            Data variable to bin.</span>
<span class="sd">        spatial_mask : np.ndarray or None, optional</span>
<span class="sd">            Cell selection mask.</span>
<span class="sd">        weights : np.ndarray or None, optional</span>
<span class="sd">            Cell weights.</span>
<span class="sd">        hour_bins : int, optional</span>
<span class="sd">            Number of equal-width hour bins over [0, 24).</span>
<span class="sd">        min_observations : int, optional</span>
<span class="sd">            Minimum observations required per bin.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xr.Dataset</span>
<span class="sd">            ``mean``, ``std``, ``n_observations`` on the ``hour``</span>
<span class="sd">            coordinate.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">var_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vod_ds</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variable &#39;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">&#39; not found in dataset&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;compute_diurnal_cycle: var=</span><span class="si">%s</span><span class="s2"> hour_bins=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">hour_bins</span><span class="p">)</span>

        <span class="n">var_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vod_ds</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
        <span class="n">cell_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vod_ds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_id_var</span><span class="p">]</span>

        <span class="c1"># Spatial mask</span>
        <span class="k">if</span> <span class="n">spatial_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data_mask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">cell_ids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cell_id</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">spatial_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">data_mask</span> <span class="o">=</span> <span class="n">data_mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">cell_ids</span> <span class="o">==</span> <span class="n">cell_id</span><span class="p">)</span>
            <span class="n">var_data</span> <span class="o">=</span> <span class="n">var_data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data_mask</span><span class="p">)</span>

        <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_weights</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

        <span class="c1"># Hour of day (fractional)</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">var_data</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">hours</span> <span class="o">=</span> <span class="n">times</span><span class="o">.</span><span class="n">hour</span> <span class="o">+</span> <span class="n">times</span><span class="o">.</span><span class="n">minute</span> <span class="o">/</span> <span class="mf">60.0</span>

        <span class="n">n_sid</span> <span class="o">=</span> <span class="n">var_data</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sid&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">hour_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">hour_bins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">hour_centers</span> <span class="o">=</span> <span class="p">(</span><span class="n">hour_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">hour_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="c1"># Flatten</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">var_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="n">cell_ids</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">hours_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">hours</span><span class="p">,</span> <span class="n">n_sid</span><span class="p">)</span>

        <span class="n">valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;hour&quot;</span><span class="p">:</span> <span class="n">hours_flat</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span>
                <span class="s2">&quot;cell_id&quot;</span><span class="p">:</span> <span class="n">cells</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;cell_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">cid</span><span class="p">:</span> <span class="n">weights</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="k">if</span> <span class="n">cid</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;hour_bin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;hour&quot;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">hour_edges</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">hour_centers</span><span class="p">,</span> <span class="n">include_lowest</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="n">grouped</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;hour_bin&quot;</span><span class="p">)</span>

        <span class="n">means</span><span class="p">,</span> <span class="n">stds</span><span class="p">,</span> <span class="n">n_obs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">hc</span> <span class="ow">in</span> <span class="n">hour_centers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hc</span> <span class="ow">in</span> <span class="n">grouped</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="n">hc</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_observations</span><span class="p">:</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                    <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">wm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
                        <span class="n">ws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">v</span> <span class="o">-</span> <span class="n">wm</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">wm</span><span class="p">,</span> <span class="n">ws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wm</span><span class="p">)</span>
                    <span class="n">stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>
                    <span class="n">n_obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="n">stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="n">n_obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">n_obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;hour&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">means</span><span class="p">)),</span>
                <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;hour&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stds</span><span class="p">)),</span>
                <span class="s2">&quot;n_observations&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;hour&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">n_obs</span><span class="p">)),</span>
            <span class="p">},</span>
            <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;hour&quot;</span><span class="p">:</span> <span class="n">hour_centers</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">var_name</span><span class="p">,</span>
                <span class="s2">&quot;grid&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_name</span><span class="p">,</span>
                <span class="s2">&quot;hour_bins&quot;</span><span class="p">:</span> <span class="n">hour_bins</span><span class="p">,</span>
                <span class="s2">&quot;min_observations&quot;</span><span class="p">:</span> <span class="n">min_observations</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;diurnal cycle: </span><span class="si">%d</span><span class="s2"> bins, mean n_obs=</span><span class="si">%.1f</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">hour_bins</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">n_obs</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ds</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_diurnal_cycle_solar</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;VOD&quot;</span><span class="p">,</span>
        <span class="n">spatial_mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">n_solar_bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
        <span class="n">min_observations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Diurnal cycle binned by solar elevation instead of clock time.</span>

<span class="sd">        Accounts for seasonal variation in solar position, producing a</span>
<span class="sd">        more physically meaningful diurnal pattern.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        var_name : str, optional</span>
<span class="sd">            Data variable to bin.</span>
<span class="sd">        spatial_mask : np.ndarray or None, optional</span>
<span class="sd">            Cell selection mask.</span>
<span class="sd">        weights : np.ndarray or None, optional</span>
<span class="sd">            Cell weights.</span>
<span class="sd">        n_solar_bins : int, optional</span>
<span class="sd">            Number of equal-width bins over [-20Â°, 90Â°].</span>
<span class="sd">        min_observations : int, optional</span>
<span class="sd">            Minimum observations per bin.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xr.Dataset</span>
<span class="sd">            ``mean``, ``std``, ``n_observations`` on the</span>
<span class="sd">            ``solar_elevation`` coordinate.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If no solar calculator is configured.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solar_calc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Solar calculator not initialized. &quot;</span>
                <span class="s2">&quot;Provide site_lat and site_lon to TemporalAnalysis constructor.&quot;</span>
            <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;solar-binned diurnal cycle: n_bins=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">n_solar_bins</span><span class="p">)</span>

        <span class="n">var_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vod_ds</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
        <span class="n">cell_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vod_ds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_id_var</span><span class="p">]</span>

        <span class="c1"># Spatial mask</span>
        <span class="k">if</span> <span class="n">spatial_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data_mask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">cell_ids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cell_id</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">spatial_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">data_mask</span> <span class="o">=</span> <span class="n">data_mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">cell_ids</span> <span class="o">==</span> <span class="n">cell_id</span><span class="p">)</span>
            <span class="n">var_data</span> <span class="o">=</span> <span class="n">var_data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data_mask</span><span class="p">)</span>

        <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_weights</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

        <span class="c1"># Solar bins per epoch</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">var_data</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">solar_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solar_calc</span><span class="o">.</span><span class="n">compute_solar_bins</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="n">n_solar_bins</span><span class="p">)</span>
        <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="n">n_solar_bins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">bin_centers</span> <span class="o">=</span> <span class="p">(</span><span class="n">bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="n">n_sid</span> <span class="o">=</span> <span class="n">var_data</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sid&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Flatten</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">var_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">cells</span> <span class="o">=</span> <span class="n">cell_ids</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">bins_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">solar_bins</span><span class="p">,</span> <span class="n">n_sid</span><span class="p">)</span>

        <span class="n">valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;solar_bin&quot;</span><span class="p">:</span> <span class="n">bins_flat</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span>
                <span class="s2">&quot;cell_id&quot;</span><span class="p">:</span> <span class="n">cells</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;cell_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">cid</span><span class="p">:</span> <span class="n">weights</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="k">if</span> <span class="n">cid</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0</span>
        <span class="p">)</span>

        <span class="n">grouped</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;solar_bin&quot;</span><span class="p">)</span>

        <span class="n">means</span><span class="p">,</span> <span class="n">stds</span><span class="p">,</span> <span class="n">n_obs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">bin_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_solar_bins</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">bin_idx</span> <span class="ow">in</span> <span class="n">grouped</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
                <span class="n">group</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="n">bin_idx</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_observations</span><span class="p">:</span>
                    <span class="n">w</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                    <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">wm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
                        <span class="n">ws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">v</span> <span class="o">-</span> <span class="n">wm</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">wm</span><span class="p">,</span> <span class="n">ws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                    <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wm</span><span class="p">)</span>
                    <span class="n">stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>
                    <span class="n">n_obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="n">stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                    <span class="n">n_obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">n_obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;solar_elevation&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">means</span><span class="p">)),</span>
                <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;solar_elevation&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stds</span><span class="p">)),</span>
                <span class="s2">&quot;n_observations&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;solar_elevation&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">n_obs</span><span class="p">)),</span>
            <span class="p">},</span>
            <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;solar_elevation&quot;</span><span class="p">:</span> <span class="n">bin_centers</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">var_name</span><span class="p">,</span>
                <span class="s2">&quot;grid&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_name</span><span class="p">,</span>
                <span class="s2">&quot;n_solar_bins&quot;</span><span class="p">:</span> <span class="n">n_solar_bins</span><span class="p">,</span>
                <span class="s2">&quot;min_observations&quot;</span><span class="p">:</span> <span class="n">min_observations</span><span class="p">,</span>
                <span class="s2">&quot;coordinate_type&quot;</span><span class="p">:</span> <span class="s2">&quot;solar_elevation&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;solar-binned diurnal: </span><span class="si">%d</span><span class="s2"> bins, mean n_obs=</span><span class="si">%.1f</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">n_solar_bins</span><span class="p">,</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">n_obs</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ds</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Solar metadata</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_solar_metadata_to_timeseries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Attach solar zenith, azimuth and elevation to a time-series.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        timeseries : xr.Dataset</span>
<span class="sd">            Time-series dataset with an ``epoch`` coordinate.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xr.Dataset</span>
<span class="sd">            Copy with ``solar_zenith``, ``solar_azimuth``,</span>
<span class="sd">            ``solar_elevation`` added.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If no solar calculator is configured.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solar_calc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Solar calculator not initialized&quot;</span><span class="p">)</span>

        <span class="n">times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">zenith</span><span class="p">,</span> <span class="n">azimuth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solar_calc</span><span class="o">.</span><span class="n">compute_solar_position</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
        <span class="n">elevation</span> <span class="o">=</span> <span class="mi">90</span> <span class="o">-</span> <span class="n">zenith</span>

        <span class="n">ts_solar</span> <span class="o">=</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">ts_solar</span><span class="p">[</span><span class="s2">&quot;solar_zenith&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="n">zenith</span><span class="p">)</span>
        <span class="n">ts_solar</span><span class="p">[</span><span class="s2">&quot;solar_azimuth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">)</span>
        <span class="n">ts_solar</span><span class="p">[</span><span class="s2">&quot;solar_elevation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="n">elevation</span><span class="p">)</span>

        <span class="n">ts_solar</span><span class="p">[</span><span class="s2">&quot;solar_zenith&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;degrees&quot;</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Solar zenith angle (0Â° = overhead)&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">ts_solar</span><span class="p">[</span><span class="s2">&quot;solar_azimuth&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;degrees&quot;</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Solar azimuth angle (0Â° = North, 90Â° = East)&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">ts_solar</span><span class="p">[</span><span class="s2">&quot;solar_elevation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;degrees&quot;</span><span class="p">,</span>
            <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Solar elevation angle (0Â° = horizon, 90Â° = overhead)&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">ts_solar</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Plotting</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_timeseries</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">timeseries</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
        <span class="n">smooth_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">show_uncertainty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">show_n_cells</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">style_kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot a time-series with optional Savitzky-Golay smoothing.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        timeseries : xr.Dataset</span>
<span class="sd">            Output of :meth:`compute_timeseries`.</span>
<span class="sd">        smooth_window : int, optional</span>
<span class="sd">            Savitzky-Golay window length (0 = off; forced odd internally).</span>
<span class="sd">        show_uncertainty : bool, optional</span>
<span class="sd">            Draw Â±1 std band.</span>
<span class="sd">        show_n_cells : bool, optional</span>
<span class="sd">            Secondary y-axis showing cell count.</span>
<span class="sd">        ax : plt.Axes or None, optional</span>
<span class="sd">            Axes to draw on; created if ``None``.</span>
<span class="sd">        **style_kwargs</span>
<span class="sd">            ``ylabel``, ``title``, ``figsize`` forwarded to matplotlib.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig, ax : plt.Figure, plt.Axes</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">figsize</span> <span class="o">=</span> <span class="n">style_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;figsize&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>

        <span class="n">time</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="k">if</span> <span class="n">smooth_window</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">smooth_window</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">smooth_window</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">smooth_window</span><span class="p">:</span>
                <span class="n">mean_smooth</span> <span class="o">=</span> <span class="n">mean</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">mean_smooth</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span> <span class="o">=</span> <span class="n">savgol_filter</span><span class="p">(</span>
                    <span class="n">mean</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span> <span class="n">smooth_window</span><span class="p">,</span> <span class="n">polyorder</span><span class="o">=</span><span class="mi">2</span>
                <span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">time</span><span class="p">,</span>
                    <span class="n">mean</span><span class="p">,</span>
                    <span class="s2">&quot;o&quot;</span><span class="p">,</span>
                    <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Raw&quot;</span><span class="p">,</span>
                    <span class="n">markersize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="n">time</span><span class="p">,</span>
                    <span class="n">mean_smooth</span><span class="p">,</span>
                    <span class="s2">&quot;-&quot;</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Smoothed (window=</span><span class="si">{</span><span class="n">smooth_window</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                    <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">mean_plot</span> <span class="o">=</span> <span class="n">mean_smooth</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="s2">&quot;o-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Mean&quot;</span><span class="p">)</span>
                <span class="n">mean_plot</span> <span class="o">=</span> <span class="n">mean</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="s2">&quot;o-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Mean&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
            <span class="n">mean_plot</span> <span class="o">=</span> <span class="n">mean</span>

        <span class="k">if</span> <span class="n">show_uncertainty</span> <span class="ow">and</span> <span class="s2">&quot;std&quot;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                <span class="n">time</span><span class="p">,</span>
                <span class="n">mean_plot</span> <span class="o">-</span> <span class="n">std</span><span class="p">,</span>
                <span class="n">mean_plot</span> <span class="o">+</span> <span class="n">std</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Â±1 std&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">show_n_cells</span> <span class="ow">and</span> <span class="s2">&quot;n_cells&quot;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="p">:</span>
            <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">time</span><span class="p">,</span>
                <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;n_cells&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                <span class="s2">&quot;--&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;N cells&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Number of cells&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">)</span>
            <span class="n">ax2</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">style_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ylabel&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">style_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;Timeseries&quot;</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_diurnal_cycle</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">diurnal</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
        <span class="n">show_confidence</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">style_kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot a clock-time diurnal cycle.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        diurnal : xr.Dataset</span>
<span class="sd">            Output of :meth:`compute_diurnal_cycle`.</span>
<span class="sd">        show_confidence : bool, optional</span>
<span class="sd">            Draw Â±1 std band.</span>
<span class="sd">        ax : plt.Axes or None, optional</span>
<span class="sd">            Axes to draw on; created if ``None``.</span>
<span class="sd">        **style_kwargs</span>
<span class="sd">            ``ylabel``, ``title``, ``figsize``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig, ax : plt.Figure, plt.Axes</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">figsize</span> <span class="o">=</span> <span class="n">style_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;figsize&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>

        <span class="n">hours</span> <span class="o">=</span> <span class="n">diurnal</span><span class="p">[</span><span class="s2">&quot;hour&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">diurnal</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">std</span> <span class="o">=</span> <span class="n">diurnal</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hours</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="s2">&quot;o-&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Mean&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show_confidence</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
                <span class="n">hours</span><span class="p">,</span>
                <span class="n">mean</span> <span class="o">-</span> <span class="n">std</span><span class="p">,</span>
                <span class="n">mean</span> <span class="o">+</span> <span class="n">std</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Â±1 std&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Hour of Day&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">style_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ylabel&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">style_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;Diurnal Cycle&quot;</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plot_diurnal_cycle_comparison</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">diurnal_clock</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
        <span class="n">diurnal_solar</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
        <span class="n">figsize</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
        <span class="o">**</span><span class="n">style_kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Side-by-side clock-time vs solar-time diurnal cycle plots.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        diurnal_clock : xr.Dataset</span>
<span class="sd">            Output of :meth:`compute_diurnal_cycle`.</span>
<span class="sd">        diurnal_solar : xr.Dataset</span>
<span class="sd">            Output of :meth:`compute_diurnal_cycle_solar`.</span>
<span class="sd">        figsize : tuple, optional</span>
<span class="sd">            Figure size.</span>
<span class="sd">        **style_kwargs</span>
<span class="sd">            ``ylabel``, ``title``.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig, axes : plt.Figure, np.ndarray of plt.Axes</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

        <span class="c1"># Clock-time panel</span>
        <span class="n">hours</span> <span class="o">=</span> <span class="n">diurnal_clock</span><span class="p">[</span><span class="s2">&quot;hour&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">mean_c</span> <span class="o">=</span> <span class="n">diurnal_clock</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">std_c</span> <span class="o">=</span> <span class="n">diurnal_clock</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hours</span><span class="p">,</span> <span class="n">mean_c</span><span class="p">,</span> <span class="s2">&quot;o-&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">hours</span><span class="p">,</span> <span class="n">mean_c</span> <span class="o">-</span> <span class="n">std_c</span><span class="p">,</span> <span class="n">mean_c</span> <span class="o">+</span> <span class="n">std_c</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Hour of Day&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">style_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ylabel&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">))</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Clock-Time Diurnal Cycle&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="c1"># Solar-elevation panel</span>
        <span class="n">solar_elev</span> <span class="o">=</span> <span class="n">diurnal_solar</span><span class="p">[</span><span class="s2">&quot;solar_elevation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">mean_s</span> <span class="o">=</span> <span class="n">diurnal_solar</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">std_s</span> <span class="o">=</span> <span class="n">diurnal_solar</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">solar_elev</span><span class="p">,</span>
            <span class="n">mean_s</span><span class="p">,</span>
            <span class="s2">&quot;o-&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">markersize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
            <span class="n">solar_elev</span><span class="p">,</span>
            <span class="n">mean_s</span> <span class="o">-</span> <span class="n">std_s</span><span class="p">,</span>
            <span class="n">mean_s</span> <span class="o">+</span> <span class="n">std_s</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Horizon&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Solar Elevation (Â°)&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">style_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ylabel&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">))</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Solar-Time Diurnal Cycle&quot;</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
        <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
            <span class="n">style_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;Diurnal Cycle Comparison&quot;</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.02</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.TemporalAnalysis.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">vod_ds</span><span class="p">,</span> <span class="n">grid</span><span class="p">,</span> <span class="n">grid_name</span><span class="p">,</span> <span class="n">site_lat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">site_lon</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">site_elevation</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.TemporalAnalysis.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the temporal analysis helper.</p>
<h5 id="canvod.grids.analysis.TemporalAnalysis.__init__--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.TemporalAnalysis.__init__--parameters" title="Permanent link">&para;</a></h5>
<p>vod_ds : xr.Dataset
    VOD dataset containing cell IDs.
grid : GridData
    Grid instance.
grid_name : str
    Grid name suffix for cell IDs.
site_lat : float | None, optional
    Site latitude in degrees.
site_lon : float | None, optional
    Site longitude in degrees.
site_elevation : float, default 0.0
    Site elevation in metres.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/temporal.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">vod_ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="n">grid</span><span class="p">:</span> <span class="n">GridData</span><span class="p">,</span>
    <span class="n">grid_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">site_lat</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">site_lon</span><span class="p">:</span> <span class="nb">float</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">site_elevation</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the temporal analysis helper.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vod_ds : xr.Dataset</span>
<span class="sd">        VOD dataset containing cell IDs.</span>
<span class="sd">    grid : GridData</span>
<span class="sd">        Grid instance.</span>
<span class="sd">    grid_name : str</span>
<span class="sd">        Grid name suffix for cell IDs.</span>
<span class="sd">    site_lat : float | None, optional</span>
<span class="sd">        Site latitude in degrees.</span>
<span class="sd">    site_lon : float | None, optional</span>
<span class="sd">        Site longitude in degrees.</span>
<span class="sd">    site_elevation : float, default 0.0</span>
<span class="sd">        Site elevation in metres.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">vod_ds</span> <span class="o">=</span> <span class="n">vod_ds</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">grid_name</span> <span class="o">=</span> <span class="n">grid_name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cell_id_var</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;cell_id_</span><span class="si">{</span><span class="n">grid_name</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="c1"># Solar calculator (optional)</span>
    <span class="k">if</span> <span class="n">site_lat</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">site_lon</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solar_calc</span><span class="p">:</span> <span class="n">SolarPositionCalculator</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="n">SolarPositionCalculator</span><span class="p">(</span>
            <span class="n">lat</span><span class="o">=</span><span class="n">site_lat</span><span class="p">,</span> <span class="n">lon</span><span class="o">=</span><span class="n">site_lon</span><span class="p">,</span> <span class="n">elevation</span><span class="o">=</span><span class="n">site_elevation</span>
        <span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;solar calculator enabled for (</span><span class="si">%.4f</span><span class="s2">Â°, </span><span class="si">%.4f</span><span class="s2">Â°)&quot;</span><span class="p">,</span>
            <span class="n">site_lat</span><span class="p">,</span>
            <span class="n">site_lon</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solar_calc</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Validate dataset</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_id_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vod_ds</span><span class="p">:</span>
        <span class="n">available</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">vod_ds</span><span class="o">.</span><span class="n">data_vars</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;cell_id_&quot;</span><span class="p">)]</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Cell ID variable &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_id_var</span><span class="si">}</span><span class="s2">&#39; not found in dataset. &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Available: </span><span class="si">{</span><span class="n">available</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.TemporalAnalysis.compute_timeseries" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_timeseries</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;VOD&#39;</span><span class="p">,</span> <span class="n">spatial_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aggregate</span><span class="o">=</span><span class="s1">&#39;1D&#39;</span><span class="p">,</span> <span class="n">min_cells</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.TemporalAnalysis.compute_timeseries" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Compute a weighted time-series aggregated over space.</p>
<h5 id="canvod.grids.analysis.TemporalAnalysis.compute_timeseries--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.TemporalAnalysis.compute_timeseries--parameters" title="Permanent link">&para;</a></h5>
<p>var_name : str, optional
    Data variable to aggregate.
spatial_mask : np.ndarray or None, optional
    Boolean mask of shape <code>(grid.ncells,)</code>; <code>True</code> = include.
weights : np.ndarray or None, optional
    Cell weights of shape <code>(grid.ncells,)</code>; normalised
    internally.  <code>None</code> â uniform weights.
aggregate : str, optional
    Pandas-compatible frequency string for temporal resampling.
min_cells : int, optional
    Minimum unique cells required per time bin.</p>
<h5 id="canvod.grids.analysis.TemporalAnalysis.compute_timeseries--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.TemporalAnalysis.compute_timeseries--returns" title="Permanent link">&para;</a></h5>
<p>xr.Dataset
    Variables: <code>mean</code>, <code>std</code>, <code>n_cells</code>,
    <code>n_observations</code>, <code>sum_weights</code>.</p>
<h5 id="canvod.grids.analysis.TemporalAnalysis.compute_timeseries--raises">Raises<a class="headerlink" href="#canvod.grids.analysis.TemporalAnalysis.compute_timeseries--raises" title="Permanent link">&para;</a></h5>
<p>ValueError
    If <em>var_name</em> is missing or mask/weight shapes are wrong.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/temporal.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_timeseries</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;VOD&quot;</span><span class="p">,</span>
    <span class="n">spatial_mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">aggregate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1D&quot;</span><span class="p">,</span>
    <span class="n">min_cells</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute a weighted time-series aggregated over space.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    var_name : str, optional</span>
<span class="sd">        Data variable to aggregate.</span>
<span class="sd">    spatial_mask : np.ndarray or None, optional</span>
<span class="sd">        Boolean mask of shape ``(grid.ncells,)``; ``True`` = include.</span>
<span class="sd">    weights : np.ndarray or None, optional</span>
<span class="sd">        Cell weights of shape ``(grid.ncells,)``; normalised</span>
<span class="sd">        internally.  ``None`` â uniform weights.</span>
<span class="sd">    aggregate : str, optional</span>
<span class="sd">        Pandas-compatible frequency string for temporal resampling.</span>
<span class="sd">    min_cells : int, optional</span>
<span class="sd">        Minimum unique cells required per time bin.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xr.Dataset</span>
<span class="sd">        Variables: ``mean``, ``std``, ``n_cells``,</span>
<span class="sd">        ``n_observations``, ``sum_weights``.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If *var_name* is missing or mask/weight shapes are wrong.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">var_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vod_ds</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variable &#39;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">&#39; not found in dataset&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;compute_timeseries: var=</span><span class="si">%s</span><span class="s2"> aggregate=</span><span class="si">%s</span><span class="s2"> mask=</span><span class="si">%s</span><span class="s2"> weights=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">var_name</span><span class="p">,</span>
        <span class="n">aggregate</span><span class="p">,</span>
        <span class="n">spatial_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">weights</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">var_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vod_ds</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
    <span class="n">cell_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vod_ds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_id_var</span><span class="p">]</span>

    <span class="c1"># Apply spatial mask</span>
    <span class="k">if</span> <span class="n">spatial_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">spatial_mask</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Spatial mask shape </span><span class="si">{</span><span class="n">spatial_mask</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> doesn&#39;t match &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;grid size (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="si">}</span><span class="s2">,)&quot;</span>
            <span class="p">)</span>
        <span class="n">data_mask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">cell_ids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cell_id</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">spatial_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">data_mask</span> <span class="o">=</span> <span class="n">data_mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">cell_ids</span> <span class="o">==</span> <span class="n">cell_id</span><span class="p">)</span>
        <span class="n">var_data</span> <span class="o">=</span> <span class="n">var_data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data_mask</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;spatial mask applied: </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2"> cells&quot;</span><span class="p">,</span>
            <span class="n">spatial_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Prepare weights</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_weights</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_weighted_timeseries</span><span class="p">(</span>
        <span class="n">var_data</span><span class="p">,</span> <span class="n">cell_ids</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">aggregate</span><span class="p">,</span> <span class="n">min_cells</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.TemporalAnalysis.compute_timeseries_solar_corrected" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_timeseries_solar_corrected</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;VOD&#39;</span><span class="p">,</span> <span class="n">spatial_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">aggregate</span><span class="o">=</span><span class="s1">&#39;1D&#39;</span><span class="p">,</span> <span class="n">min_cells</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">solar_correction</span><span class="o">=</span><span class="s1">&#39;normalize&#39;</span><span class="p">,</span> <span class="n">reference_zenith</span><span class="o">=</span><span class="mf">45.0</span><span class="p">,</span> <span class="n">daytime_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">twilight_angle</span><span class="o">=-</span><span class="mf">6.0</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.TemporalAnalysis.compute_timeseries_solar_corrected" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Compute a time-series after applying a solar correction.</p>
<h5 id="canvod.grids.analysis.TemporalAnalysis.compute_timeseries_solar_corrected--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.TemporalAnalysis.compute_timeseries_solar_corrected--parameters" title="Permanent link">&para;</a></h5>
<p>var_name : str, optional
    Data variable to correct and aggregate.
spatial_mask : np.ndarray or None, optional
    Cell selection mask.
weights : np.ndarray or None, optional
    Cell weights.
aggregate : str, optional
    Temporal resampling frequency.
min_cells : int, optional
    Minimum cells per time bin.
solar_correction : {'normalize', 'residual', 'cos_correction'}
    Correction method passed to
    :meth:<code>SolarPositionCalculator.apply_solar_correction</code>.
reference_zenith : float, optional
    Reference zenith for normalisation (degrees).
daytime_only : bool, optional
    If <code>True</code>, mask out nighttime epochs.
twilight_angle : float, optional
    Solar-elevation threshold for daytime (degrees).</p>
<h5 id="canvod.grids.analysis.TemporalAnalysis.compute_timeseries_solar_corrected--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.TemporalAnalysis.compute_timeseries_solar_corrected--returns" title="Permanent link">&para;</a></h5>
<p>xr.Dataset
    Solar-corrected time-series with additional metadata attrs.</p>
<h5 id="canvod.grids.analysis.TemporalAnalysis.compute_timeseries_solar_corrected--raises">Raises<a class="headerlink" href="#canvod.grids.analysis.TemporalAnalysis.compute_timeseries_solar_corrected--raises" title="Permanent link">&para;</a></h5>
<p>ValueError
    If no solar calculator is configured.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/temporal.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_timeseries_solar_corrected</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;VOD&quot;</span><span class="p">,</span>
    <span class="n">spatial_mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">aggregate</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;1D&quot;</span><span class="p">,</span>
    <span class="n">min_cells</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">solar_correction</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span>
        <span class="s2">&quot;normalize&quot;</span><span class="p">,</span> <span class="s2">&quot;residual&quot;</span><span class="p">,</span> <span class="s2">&quot;cos_correction&quot;</span>
    <span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;normalize&quot;</span><span class="p">,</span>
    <span class="n">reference_zenith</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">45.0</span><span class="p">,</span>
    <span class="n">daytime_only</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">twilight_angle</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="o">-</span><span class="mf">6.0</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute a time-series after applying a solar correction.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    var_name : str, optional</span>
<span class="sd">        Data variable to correct and aggregate.</span>
<span class="sd">    spatial_mask : np.ndarray or None, optional</span>
<span class="sd">        Cell selection mask.</span>
<span class="sd">    weights : np.ndarray or None, optional</span>
<span class="sd">        Cell weights.</span>
<span class="sd">    aggregate : str, optional</span>
<span class="sd">        Temporal resampling frequency.</span>
<span class="sd">    min_cells : int, optional</span>
<span class="sd">        Minimum cells per time bin.</span>
<span class="sd">    solar_correction : {&#39;normalize&#39;, &#39;residual&#39;, &#39;cos_correction&#39;}</span>
<span class="sd">        Correction method passed to</span>
<span class="sd">        :meth:`SolarPositionCalculator.apply_solar_correction`.</span>
<span class="sd">    reference_zenith : float, optional</span>
<span class="sd">        Reference zenith for normalisation (degrees).</span>
<span class="sd">    daytime_only : bool, optional</span>
<span class="sd">        If ``True``, mask out nighttime epochs.</span>
<span class="sd">    twilight_angle : float, optional</span>
<span class="sd">        Solar-elevation threshold for daytime (degrees).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xr.Dataset</span>
<span class="sd">        Solar-corrected time-series with additional metadata attrs.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If no solar calculator is configured.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solar_calc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Solar calculator not initialized. &quot;</span>
            <span class="s2">&quot;Provide site_lat and site_lon to TemporalAnalysis constructor.&quot;</span>
        <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;solar-corrected timeseries: correction=</span><span class="si">%s</span><span class="s2"> daytime_only=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">solar_correction</span><span class="p">,</span>
        <span class="n">daytime_only</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">var_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vod_ds</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>

    <span class="c1"># Apply solar correction</span>
    <span class="n">var_data_corrected</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solar_calc</span><span class="o">.</span><span class="n">apply_solar_correction</span><span class="p">(</span>
        <span class="n">var_data</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="n">solar_correction</span><span class="p">,</span> <span class="n">reference_zenith</span><span class="o">=</span><span class="n">reference_zenith</span>
    <span class="p">)</span>

    <span class="c1"># Daytime filter</span>
    <span class="k">if</span> <span class="n">daytime_only</span><span class="p">:</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">var_data</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">is_day</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solar_calc</span><span class="o">.</span><span class="n">is_daytime</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">twilight_angle</span><span class="p">)</span>
        <span class="n">is_day_da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
            <span class="n">is_day</span><span class="p">,</span> <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="n">var_data_corrected</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]},</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">var_data_corrected</span> <span class="o">=</span> <span class="n">var_data_corrected</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_day_da</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;daytime filter: </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2"> timesteps kept&quot;</span><span class="p">,</span>
            <span class="n">is_day</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">is_day</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="c1"># Temporary dataset with corrected variable</span>
    <span class="n">corrected_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">_solar_corrected&quot;</span>
    <span class="n">ds_temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vod_ds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">ds_temp</span><span class="p">[</span><span class="n">corrected_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">var_data_corrected</span>

    <span class="c1"># Reuse compute_timeseries via a lightweight temporary instance</span>
    <span class="n">analysis_temp</span> <span class="o">=</span> <span class="n">TemporalAnalysis</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="n">TemporalAnalysis</span><span class="p">)</span>
    <span class="n">analysis_temp</span><span class="o">.</span><span class="n">vod_ds</span> <span class="o">=</span> <span class="n">ds_temp</span>
    <span class="n">analysis_temp</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span>
    <span class="n">analysis_temp</span><span class="o">.</span><span class="n">grid_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_name</span>
    <span class="n">analysis_temp</span><span class="o">.</span><span class="n">cell_id_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_id_var</span>
    <span class="n">analysis_temp</span><span class="o">.</span><span class="n">solar_calc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solar_calc</span>

    <span class="n">ts</span> <span class="o">=</span> <span class="n">analysis_temp</span><span class="o">.</span><span class="n">compute_timeseries</span><span class="p">(</span>
        <span class="n">var_name</span><span class="o">=</span><span class="n">corrected_name</span><span class="p">,</span>
        <span class="n">spatial_mask</span><span class="o">=</span><span class="n">spatial_mask</span><span class="p">,</span>
        <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span>
        <span class="n">aggregate</span><span class="o">=</span><span class="n">aggregate</span><span class="p">,</span>
        <span class="n">min_cells</span><span class="o">=</span><span class="n">min_cells</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Solar metadata</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;solar_correction&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">solar_correction</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;reference_zenith&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reference_zenith</span>
    <span class="n">ts</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;daytime_only&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">daytime_only</span>
    <span class="k">if</span> <span class="n">daytime_only</span><span class="p">:</span>
        <span class="n">ts</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;twilight_angle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">twilight_angle</span>

    <span class="k">return</span> <span class="n">ts</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.TemporalAnalysis.compute_diurnal_cycle" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_diurnal_cycle</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;VOD&#39;</span><span class="p">,</span> <span class="n">spatial_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hour_bins</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">min_observations</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.TemporalAnalysis.compute_diurnal_cycle" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Compute clock-time diurnal cycle (hour-of-day statistics).</p>
<h5 id="canvod.grids.analysis.TemporalAnalysis.compute_diurnal_cycle--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.TemporalAnalysis.compute_diurnal_cycle--parameters" title="Permanent link">&para;</a></h5>
<p>var_name : str, optional
    Data variable to bin.
spatial_mask : np.ndarray or None, optional
    Cell selection mask.
weights : np.ndarray or None, optional
    Cell weights.
hour_bins : int, optional
    Number of equal-width hour bins over [0, 24).
min_observations : int, optional
    Minimum observations required per bin.</p>
<h5 id="canvod.grids.analysis.TemporalAnalysis.compute_diurnal_cycle--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.TemporalAnalysis.compute_diurnal_cycle--returns" title="Permanent link">&para;</a></h5>
<p>xr.Dataset
    <code>mean</code>, <code>std</code>, <code>n_observations</code> on the <code>hour</code>
    coordinate.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/temporal.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_diurnal_cycle</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;VOD&quot;</span><span class="p">,</span>
    <span class="n">spatial_mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">hour_bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
    <span class="n">min_observations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute clock-time diurnal cycle (hour-of-day statistics).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    var_name : str, optional</span>
<span class="sd">        Data variable to bin.</span>
<span class="sd">    spatial_mask : np.ndarray or None, optional</span>
<span class="sd">        Cell selection mask.</span>
<span class="sd">    weights : np.ndarray or None, optional</span>
<span class="sd">        Cell weights.</span>
<span class="sd">    hour_bins : int, optional</span>
<span class="sd">        Number of equal-width hour bins over [0, 24).</span>
<span class="sd">    min_observations : int, optional</span>
<span class="sd">        Minimum observations required per bin.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xr.Dataset</span>
<span class="sd">        ``mean``, ``std``, ``n_observations`` on the ``hour``</span>
<span class="sd">        coordinate.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">var_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">vod_ds</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variable &#39;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">&#39; not found in dataset&quot;</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;compute_diurnal_cycle: var=</span><span class="si">%s</span><span class="s2"> hour_bins=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">hour_bins</span><span class="p">)</span>

    <span class="n">var_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vod_ds</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
    <span class="n">cell_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vod_ds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_id_var</span><span class="p">]</span>

    <span class="c1"># Spatial mask</span>
    <span class="k">if</span> <span class="n">spatial_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data_mask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">cell_ids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cell_id</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">spatial_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">data_mask</span> <span class="o">=</span> <span class="n">data_mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">cell_ids</span> <span class="o">==</span> <span class="n">cell_id</span><span class="p">)</span>
        <span class="n">var_data</span> <span class="o">=</span> <span class="n">var_data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data_mask</span><span class="p">)</span>

    <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_weights</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

    <span class="c1"># Hour of day (fractional)</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">var_data</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">hours</span> <span class="o">=</span> <span class="n">times</span><span class="o">.</span><span class="n">hour</span> <span class="o">+</span> <span class="n">times</span><span class="o">.</span><span class="n">minute</span> <span class="o">/</span> <span class="mf">60.0</span>

    <span class="n">n_sid</span> <span class="o">=</span> <span class="n">var_data</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sid&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">hour_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">hour_bins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">hour_centers</span> <span class="o">=</span> <span class="p">(</span><span class="n">hour_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">hour_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="c1"># Flatten</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">var_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">cells</span> <span class="o">=</span> <span class="n">cell_ids</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">hours_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">hours</span><span class="p">,</span> <span class="n">n_sid</span><span class="p">)</span>

    <span class="n">valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;hour&quot;</span><span class="p">:</span> <span class="n">hours_flat</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span>
            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span>
            <span class="s2">&quot;cell_id&quot;</span><span class="p">:</span> <span class="n">cells</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;cell_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">cid</span><span class="p">:</span> <span class="n">weights</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="k">if</span> <span class="n">cid</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0</span>
    <span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;hour_bin&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;hour&quot;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="n">hour_edges</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">hour_centers</span><span class="p">,</span> <span class="n">include_lowest</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">grouped</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;hour_bin&quot;</span><span class="p">)</span>

    <span class="n">means</span><span class="p">,</span> <span class="n">stds</span><span class="p">,</span> <span class="n">n_obs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">hc</span> <span class="ow">in</span> <span class="n">hour_centers</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">hc</span> <span class="ow">in</span> <span class="n">grouped</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="n">hc</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_observations</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">wm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
                    <span class="n">ws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">v</span> <span class="o">-</span> <span class="n">wm</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">wm</span><span class="p">,</span> <span class="n">ws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wm</span><span class="p">)</span>
                <span class="n">stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>
                <span class="n">n_obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">n_obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">n_obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;hour&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">means</span><span class="p">)),</span>
            <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;hour&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stds</span><span class="p">)),</span>
            <span class="s2">&quot;n_observations&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;hour&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">n_obs</span><span class="p">)),</span>
        <span class="p">},</span>
        <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;hour&quot;</span><span class="p">:</span> <span class="n">hour_centers</span><span class="p">},</span>
    <span class="p">)</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">var_name</span><span class="p">,</span>
            <span class="s2">&quot;grid&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_name</span><span class="p">,</span>
            <span class="s2">&quot;hour_bins&quot;</span><span class="p">:</span> <span class="n">hour_bins</span><span class="p">,</span>
            <span class="s2">&quot;min_observations&quot;</span><span class="p">:</span> <span class="n">min_observations</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;diurnal cycle: </span><span class="si">%d</span><span class="s2"> bins, mean n_obs=</span><span class="si">%.1f</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">hour_bins</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">n_obs</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ds</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.TemporalAnalysis.compute_diurnal_cycle_solar" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute_diurnal_cycle_solar</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;VOD&#39;</span><span class="p">,</span> <span class="n">spatial_mask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_solar_bins</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">min_observations</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.TemporalAnalysis.compute_diurnal_cycle_solar" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Diurnal cycle binned by solar elevation instead of clock time.</p>
<p>Accounts for seasonal variation in solar position, producing a
more physically meaningful diurnal pattern.</p>
<h5 id="canvod.grids.analysis.TemporalAnalysis.compute_diurnal_cycle_solar--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.TemporalAnalysis.compute_diurnal_cycle_solar--parameters" title="Permanent link">&para;</a></h5>
<p>var_name : str, optional
    Data variable to bin.
spatial_mask : np.ndarray or None, optional
    Cell selection mask.
weights : np.ndarray or None, optional
    Cell weights.
n_solar_bins : int, optional
    Number of equal-width bins over [-20Â°, 90Â°].
min_observations : int, optional
    Minimum observations per bin.</p>
<h5 id="canvod.grids.analysis.TemporalAnalysis.compute_diurnal_cycle_solar--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.TemporalAnalysis.compute_diurnal_cycle_solar--returns" title="Permanent link">&para;</a></h5>
<p>xr.Dataset
    <code>mean</code>, <code>std</code>, <code>n_observations</code> on the
    <code>solar_elevation</code> coordinate.</p>
<h5 id="canvod.grids.analysis.TemporalAnalysis.compute_diurnal_cycle_solar--raises">Raises<a class="headerlink" href="#canvod.grids.analysis.TemporalAnalysis.compute_diurnal_cycle_solar--raises" title="Permanent link">&para;</a></h5>
<p>ValueError
    If no solar calculator is configured.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/temporal.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span>
<span class="normal">659</span>
<span class="normal">660</span>
<span class="normal">661</span>
<span class="normal">662</span>
<span class="normal">663</span>
<span class="normal">664</span>
<span class="normal">665</span>
<span class="normal">666</span>
<span class="normal">667</span>
<span class="normal">668</span>
<span class="normal">669</span>
<span class="normal">670</span>
<span class="normal">671</span>
<span class="normal">672</span>
<span class="normal">673</span>
<span class="normal">674</span>
<span class="normal">675</span>
<span class="normal">676</span>
<span class="normal">677</span>
<span class="normal">678</span>
<span class="normal">679</span>
<span class="normal">680</span>
<span class="normal">681</span>
<span class="normal">682</span>
<span class="normal">683</span>
<span class="normal">684</span>
<span class="normal">685</span>
<span class="normal">686</span>
<span class="normal">687</span>
<span class="normal">688</span>
<span class="normal">689</span>
<span class="normal">690</span>
<span class="normal">691</span>
<span class="normal">692</span>
<span class="normal">693</span>
<span class="normal">694</span>
<span class="normal">695</span>
<span class="normal">696</span>
<span class="normal">697</span>
<span class="normal">698</span>
<span class="normal">699</span>
<span class="normal">700</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute_diurnal_cycle_solar</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;VOD&quot;</span><span class="p">,</span>
    <span class="n">spatial_mask</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">n_solar_bins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
    <span class="n">min_observations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Diurnal cycle binned by solar elevation instead of clock time.</span>

<span class="sd">    Accounts for seasonal variation in solar position, producing a</span>
<span class="sd">    more physically meaningful diurnal pattern.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    var_name : str, optional</span>
<span class="sd">        Data variable to bin.</span>
<span class="sd">    spatial_mask : np.ndarray or None, optional</span>
<span class="sd">        Cell selection mask.</span>
<span class="sd">    weights : np.ndarray or None, optional</span>
<span class="sd">        Cell weights.</span>
<span class="sd">    n_solar_bins : int, optional</span>
<span class="sd">        Number of equal-width bins over [-20Â°, 90Â°].</span>
<span class="sd">    min_observations : int, optional</span>
<span class="sd">        Minimum observations per bin.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xr.Dataset</span>
<span class="sd">        ``mean``, ``std``, ``n_observations`` on the</span>
<span class="sd">        ``solar_elevation`` coordinate.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If no solar calculator is configured.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solar_calc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Solar calculator not initialized. &quot;</span>
            <span class="s2">&quot;Provide site_lat and site_lon to TemporalAnalysis constructor.&quot;</span>
        <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;solar-binned diurnal cycle: n_bins=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">n_solar_bins</span><span class="p">)</span>

    <span class="n">var_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vod_ds</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
    <span class="n">cell_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vod_ds</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_id_var</span><span class="p">]</span>

    <span class="c1"># Spatial mask</span>
    <span class="k">if</span> <span class="n">spatial_mask</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">data_mask</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">cell_ids</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cell_id</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">spatial_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">data_mask</span> <span class="o">=</span> <span class="n">data_mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">cell_ids</span> <span class="o">==</span> <span class="n">cell_id</span><span class="p">)</span>
        <span class="n">var_data</span> <span class="o">=</span> <span class="n">var_data</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">data_mask</span><span class="p">)</span>

    <span class="n">weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_weights</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

    <span class="c1"># Solar bins per epoch</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">var_data</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">solar_bins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solar_calc</span><span class="o">.</span><span class="n">compute_solar_bins</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">n_bins</span><span class="o">=</span><span class="n">n_solar_bins</span><span class="p">)</span>
    <span class="n">bin_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="n">n_solar_bins</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">bin_centers</span> <span class="o">=</span> <span class="p">(</span><span class="n">bin_edges</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">bin_edges</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="n">n_sid</span> <span class="o">=</span> <span class="n">var_data</span><span class="o">.</span><span class="n">sizes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;sid&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Flatten</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">var_data</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">cells</span> <span class="o">=</span> <span class="n">cell_ids</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">bins_flat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">solar_bins</span><span class="p">,</span> <span class="n">n_sid</span><span class="p">)</span>

    <span class="n">valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;solar_bin&quot;</span><span class="p">:</span> <span class="n">bins_flat</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span>
            <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">values</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span>
            <span class="s2">&quot;cell_id&quot;</span><span class="p">:</span> <span class="n">cells</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;cell_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
        <span class="k">lambda</span> <span class="n">cid</span><span class="p">:</span> <span class="n">weights</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span> <span class="k">if</span> <span class="n">cid</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="k">else</span> <span class="mf">0.0</span>
    <span class="p">)</span>

    <span class="n">grouped</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;solar_bin&quot;</span><span class="p">)</span>

    <span class="n">means</span><span class="p">,</span> <span class="n">stds</span><span class="p">,</span> <span class="n">n_obs</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">bin_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_solar_bins</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">bin_idx</span> <span class="ow">in</span> <span class="n">grouped</span><span class="o">.</span><span class="n">groups</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">grouped</span><span class="o">.</span><span class="n">get_group</span><span class="p">(</span><span class="n">bin_idx</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_observations</span><span class="p">:</span>
                <span class="n">w</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s2">&quot;weight&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                <span class="k">if</span> <span class="n">w</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">wm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">)</span>
                    <span class="n">ws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">((</span><span class="n">v</span> <span class="o">-</span> <span class="n">wm</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">w</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">wm</span><span class="p">,</span> <span class="n">ws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">wm</span><span class="p">)</span>
                <span class="n">stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ws</span><span class="p">)</span>
                <span class="n">n_obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">n_obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">means</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">stds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">n_obs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;solar_elevation&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">means</span><span class="p">)),</span>
            <span class="s2">&quot;std&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;solar_elevation&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">stds</span><span class="p">)),</span>
            <span class="s2">&quot;n_observations&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;solar_elevation&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">n_obs</span><span class="p">)),</span>
        <span class="p">},</span>
        <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;solar_elevation&quot;</span><span class="p">:</span> <span class="n">bin_centers</span><span class="p">},</span>
    <span class="p">)</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;variable&quot;</span><span class="p">:</span> <span class="n">var_name</span><span class="p">,</span>
            <span class="s2">&quot;grid&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid_name</span><span class="p">,</span>
            <span class="s2">&quot;n_solar_bins&quot;</span><span class="p">:</span> <span class="n">n_solar_bins</span><span class="p">,</span>
            <span class="s2">&quot;min_observations&quot;</span><span class="p">:</span> <span class="n">min_observations</span><span class="p">,</span>
            <span class="s2">&quot;coordinate_type&quot;</span><span class="p">:</span> <span class="s2">&quot;solar_elevation&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;solar-binned diurnal: </span><span class="si">%d</span><span class="s2"> bins, mean n_obs=</span><span class="si">%.1f</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">n_solar_bins</span><span class="p">,</span>
        <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">n_obs</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">ds</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.TemporalAnalysis.add_solar_metadata_to_timeseries" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_solar_metadata_to_timeseries</span><span class="p">(</span><span class="n">timeseries</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.TemporalAnalysis.add_solar_metadata_to_timeseries" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Attach solar zenith, azimuth and elevation to a time-series.</p>
<h5 id="canvod.grids.analysis.TemporalAnalysis.add_solar_metadata_to_timeseries--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.TemporalAnalysis.add_solar_metadata_to_timeseries--parameters" title="Permanent link">&para;</a></h5>
<p>timeseries : xr.Dataset
    Time-series dataset with an <code>epoch</code> coordinate.</p>
<h5 id="canvod.grids.analysis.TemporalAnalysis.add_solar_metadata_to_timeseries--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.TemporalAnalysis.add_solar_metadata_to_timeseries--returns" title="Permanent link">&para;</a></h5>
<p>xr.Dataset
    Copy with <code>solar_zenith</code>, <code>solar_azimuth</code>,
    <code>solar_elevation</code> added.</p>
<h5 id="canvod.grids.analysis.TemporalAnalysis.add_solar_metadata_to_timeseries--raises">Raises<a class="headerlink" href="#canvod.grids.analysis.TemporalAnalysis.add_solar_metadata_to_timeseries--raises" title="Permanent link">&para;</a></h5>
<p>ValueError
    If no solar calculator is configured.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/temporal.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">706</span>
<span class="normal">707</span>
<span class="normal">708</span>
<span class="normal">709</span>
<span class="normal">710</span>
<span class="normal">711</span>
<span class="normal">712</span>
<span class="normal">713</span>
<span class="normal">714</span>
<span class="normal">715</span>
<span class="normal">716</span>
<span class="normal">717</span>
<span class="normal">718</span>
<span class="normal">719</span>
<span class="normal">720</span>
<span class="normal">721</span>
<span class="normal">722</span>
<span class="normal">723</span>
<span class="normal">724</span>
<span class="normal">725</span>
<span class="normal">726</span>
<span class="normal">727</span>
<span class="normal">728</span>
<span class="normal">729</span>
<span class="normal">730</span>
<span class="normal">731</span>
<span class="normal">732</span>
<span class="normal">733</span>
<span class="normal">734</span>
<span class="normal">735</span>
<span class="normal">736</span>
<span class="normal">737</span>
<span class="normal">738</span>
<span class="normal">739</span>
<span class="normal">740</span>
<span class="normal">741</span>
<span class="normal">742</span>
<span class="normal">743</span>
<span class="normal">744</span>
<span class="normal">745</span>
<span class="normal">746</span>
<span class="normal">747</span>
<span class="normal">748</span>
<span class="normal">749</span>
<span class="normal">750</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_solar_metadata_to_timeseries</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeseries</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Attach solar zenith, azimuth and elevation to a time-series.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    timeseries : xr.Dataset</span>
<span class="sd">        Time-series dataset with an ``epoch`` coordinate.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xr.Dataset</span>
<span class="sd">        Copy with ``solar_zenith``, ``solar_azimuth``,</span>
<span class="sd">        ``solar_elevation`` added.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If no solar calculator is configured.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solar_calc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Solar calculator not initialized&quot;</span><span class="p">)</span>

    <span class="n">times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">zenith</span><span class="p">,</span> <span class="n">azimuth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solar_calc</span><span class="o">.</span><span class="n">compute_solar_position</span><span class="p">(</span><span class="n">times</span><span class="p">)</span>
    <span class="n">elevation</span> <span class="o">=</span> <span class="mi">90</span> <span class="o">-</span> <span class="n">zenith</span>

    <span class="n">ts_solar</span> <span class="o">=</span> <span class="n">timeseries</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">ts_solar</span><span class="p">[</span><span class="s2">&quot;solar_zenith&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="n">zenith</span><span class="p">)</span>
    <span class="n">ts_solar</span><span class="p">[</span><span class="s2">&quot;solar_azimuth&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="n">azimuth</span><span class="p">)</span>
    <span class="n">ts_solar</span><span class="p">[</span><span class="s2">&quot;solar_elevation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="n">elevation</span><span class="p">)</span>

    <span class="n">ts_solar</span><span class="p">[</span><span class="s2">&quot;solar_zenith&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;degrees&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Solar zenith angle (0Â° = overhead)&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">ts_solar</span><span class="p">[</span><span class="s2">&quot;solar_azimuth&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;degrees&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Solar azimuth angle (0Â° = North, 90Â° = East)&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">ts_solar</span><span class="p">[</span><span class="s2">&quot;solar_elevation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;degrees&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Solar elevation angle (0Â° = horizon, 90Â° = overhead)&quot;</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">ts_solar</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.TemporalAnalysis.plot_timeseries" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_timeseries</span><span class="p">(</span><span class="n">timeseries</span><span class="p">,</span> <span class="n">smooth_window</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">show_uncertainty</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_n_cells</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">style_kwargs</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.TemporalAnalysis.plot_timeseries" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Plot a time-series with optional Savitzky-Golay smoothing.</p>
<h5 id="canvod.grids.analysis.TemporalAnalysis.plot_timeseries--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.TemporalAnalysis.plot_timeseries--parameters" title="Permanent link">&para;</a></h5>
<p>timeseries : xr.Dataset
    Output of :meth:<code>compute_timeseries</code>.
smooth_window : int, optional
    Savitzky-Golay window length (0 = off; forced odd internally).
show_uncertainty : bool, optional
    Draw Â±1 std band.
show_n_cells : bool, optional
    Secondary y-axis showing cell count.
ax : plt.Axes or None, optional
    Axes to draw on; created if <code>None</code>.
**style_kwargs
    <code>ylabel</code>, <code>title</code>, <code>figsize</code> forwarded to matplotlib.</p>
<h5 id="canvod.grids.analysis.TemporalAnalysis.plot_timeseries--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.TemporalAnalysis.plot_timeseries--returns" title="Permanent link">&para;</a></h5>
<p>fig, ax : plt.Figure, plt.Axes</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/temporal.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">756</span>
<span class="normal">757</span>
<span class="normal">758</span>
<span class="normal">759</span>
<span class="normal">760</span>
<span class="normal">761</span>
<span class="normal">762</span>
<span class="normal">763</span>
<span class="normal">764</span>
<span class="normal">765</span>
<span class="normal">766</span>
<span class="normal">767</span>
<span class="normal">768</span>
<span class="normal">769</span>
<span class="normal">770</span>
<span class="normal">771</span>
<span class="normal">772</span>
<span class="normal">773</span>
<span class="normal">774</span>
<span class="normal">775</span>
<span class="normal">776</span>
<span class="normal">777</span>
<span class="normal">778</span>
<span class="normal">779</span>
<span class="normal">780</span>
<span class="normal">781</span>
<span class="normal">782</span>
<span class="normal">783</span>
<span class="normal">784</span>
<span class="normal">785</span>
<span class="normal">786</span>
<span class="normal">787</span>
<span class="normal">788</span>
<span class="normal">789</span>
<span class="normal">790</span>
<span class="normal">791</span>
<span class="normal">792</span>
<span class="normal">793</span>
<span class="normal">794</span>
<span class="normal">795</span>
<span class="normal">796</span>
<span class="normal">797</span>
<span class="normal">798</span>
<span class="normal">799</span>
<span class="normal">800</span>
<span class="normal">801</span>
<span class="normal">802</span>
<span class="normal">803</span>
<span class="normal">804</span>
<span class="normal">805</span>
<span class="normal">806</span>
<span class="normal">807</span>
<span class="normal">808</span>
<span class="normal">809</span>
<span class="normal">810</span>
<span class="normal">811</span>
<span class="normal">812</span>
<span class="normal">813</span>
<span class="normal">814</span>
<span class="normal">815</span>
<span class="normal">816</span>
<span class="normal">817</span>
<span class="normal">818</span>
<span class="normal">819</span>
<span class="normal">820</span>
<span class="normal">821</span>
<span class="normal">822</span>
<span class="normal">823</span>
<span class="normal">824</span>
<span class="normal">825</span>
<span class="normal">826</span>
<span class="normal">827</span>
<span class="normal">828</span>
<span class="normal">829</span>
<span class="normal">830</span>
<span class="normal">831</span>
<span class="normal">832</span>
<span class="normal">833</span>
<span class="normal">834</span>
<span class="normal">835</span>
<span class="normal">836</span>
<span class="normal">837</span>
<span class="normal">838</span>
<span class="normal">839</span>
<span class="normal">840</span>
<span class="normal">841</span>
<span class="normal">842</span>
<span class="normal">843</span>
<span class="normal">844</span>
<span class="normal">845</span>
<span class="normal">846</span>
<span class="normal">847</span>
<span class="normal">848</span>
<span class="normal">849</span>
<span class="normal">850</span>
<span class="normal">851</span>
<span class="normal">852</span>
<span class="normal">853</span>
<span class="normal">854</span>
<span class="normal">855</span>
<span class="normal">856</span>
<span class="normal">857</span>
<span class="normal">858</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_timeseries</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">timeseries</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="n">smooth_window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">show_uncertainty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">show_n_cells</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">style_kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot a time-series with optional Savitzky-Golay smoothing.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    timeseries : xr.Dataset</span>
<span class="sd">        Output of :meth:`compute_timeseries`.</span>
<span class="sd">    smooth_window : int, optional</span>
<span class="sd">        Savitzky-Golay window length (0 = off; forced odd internally).</span>
<span class="sd">    show_uncertainty : bool, optional</span>
<span class="sd">        Draw Â±1 std band.</span>
<span class="sd">    show_n_cells : bool, optional</span>
<span class="sd">        Secondary y-axis showing cell count.</span>
<span class="sd">    ax : plt.Axes or None, optional</span>
<span class="sd">        Axes to draw on; created if ``None``.</span>
<span class="sd">    **style_kwargs</span>
<span class="sd">        ``ylabel``, ``title``, ``figsize`` forwarded to matplotlib.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig, ax : plt.Figure, plt.Axes</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="n">style_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;figsize&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>

    <span class="n">time</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="k">if</span> <span class="n">smooth_window</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">smooth_window</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">smooth_window</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">valid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">smooth_window</span><span class="p">:</span>
            <span class="n">mean_smooth</span> <span class="o">=</span> <span class="n">mean</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">mean_smooth</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span> <span class="o">=</span> <span class="n">savgol_filter</span><span class="p">(</span>
                <span class="n">mean</span><span class="p">[</span><span class="n">valid</span><span class="p">],</span> <span class="n">smooth_window</span><span class="p">,</span> <span class="n">polyorder</span><span class="o">=</span><span class="mi">2</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">time</span><span class="p">,</span>
                <span class="n">mean</span><span class="p">,</span>
                <span class="s2">&quot;o&quot;</span><span class="p">,</span>
                <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Raw&quot;</span><span class="p">,</span>
                <span class="n">markersize</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;gray&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">time</span><span class="p">,</span>
                <span class="n">mean_smooth</span><span class="p">,</span>
                <span class="s2">&quot;-&quot;</span><span class="p">,</span>
                <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Smoothed (window=</span><span class="si">{</span><span class="n">smooth_window</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">mean_plot</span> <span class="o">=</span> <span class="n">mean_smooth</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="s2">&quot;o-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Mean&quot;</span><span class="p">)</span>
            <span class="n">mean_plot</span> <span class="o">=</span> <span class="n">mean</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="s2">&quot;o-&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Mean&quot;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="n">mean_plot</span> <span class="o">=</span> <span class="n">mean</span>

    <span class="k">if</span> <span class="n">show_uncertainty</span> <span class="ow">and</span> <span class="s2">&quot;std&quot;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
            <span class="n">time</span><span class="p">,</span>
            <span class="n">mean_plot</span> <span class="o">-</span> <span class="n">std</span><span class="p">,</span>
            <span class="n">mean_plot</span> <span class="o">+</span> <span class="n">std</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Â±1 std&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">show_n_cells</span> <span class="ow">and</span> <span class="s2">&quot;n_cells&quot;</span> <span class="ow">in</span> <span class="n">timeseries</span><span class="p">:</span>
        <span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="n">time</span><span class="p">,</span>
            <span class="n">timeseries</span><span class="p">[</span><span class="s2">&quot;n_cells&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="s2">&quot;--&quot;</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;N cells&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Number of cells&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">)</span>
        <span class="n">ax2</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">labelcolor</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Time&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">style_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ylabel&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">style_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;Timeseries&quot;</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.TemporalAnalysis.plot_diurnal_cycle" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_diurnal_cycle</span><span class="p">(</span><span class="n">diurnal</span><span class="p">,</span> <span class="n">show_confidence</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">style_kwargs</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.TemporalAnalysis.plot_diurnal_cycle" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Plot a clock-time diurnal cycle.</p>
<h5 id="canvod.grids.analysis.TemporalAnalysis.plot_diurnal_cycle--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.TemporalAnalysis.plot_diurnal_cycle--parameters" title="Permanent link">&para;</a></h5>
<p>diurnal : xr.Dataset
    Output of :meth:<code>compute_diurnal_cycle</code>.
show_confidence : bool, optional
    Draw Â±1 std band.
ax : plt.Axes or None, optional
    Axes to draw on; created if <code>None</code>.
**style_kwargs
    <code>ylabel</code>, <code>title</code>, <code>figsize</code>.</p>
<h5 id="canvod.grids.analysis.TemporalAnalysis.plot_diurnal_cycle--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.TemporalAnalysis.plot_diurnal_cycle--returns" title="Permanent link">&para;</a></h5>
<p>fig, ax : plt.Figure, plt.Axes</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/temporal.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">860</span>
<span class="normal">861</span>
<span class="normal">862</span>
<span class="normal">863</span>
<span class="normal">864</span>
<span class="normal">865</span>
<span class="normal">866</span>
<span class="normal">867</span>
<span class="normal">868</span>
<span class="normal">869</span>
<span class="normal">870</span>
<span class="normal">871</span>
<span class="normal">872</span>
<span class="normal">873</span>
<span class="normal">874</span>
<span class="normal">875</span>
<span class="normal">876</span>
<span class="normal">877</span>
<span class="normal">878</span>
<span class="normal">879</span>
<span class="normal">880</span>
<span class="normal">881</span>
<span class="normal">882</span>
<span class="normal">883</span>
<span class="normal">884</span>
<span class="normal">885</span>
<span class="normal">886</span>
<span class="normal">887</span>
<span class="normal">888</span>
<span class="normal">889</span>
<span class="normal">890</span>
<span class="normal">891</span>
<span class="normal">892</span>
<span class="normal">893</span>
<span class="normal">894</span>
<span class="normal">895</span>
<span class="normal">896</span>
<span class="normal">897</span>
<span class="normal">898</span>
<span class="normal">899</span>
<span class="normal">900</span>
<span class="normal">901</span>
<span class="normal">902</span>
<span class="normal">903</span>
<span class="normal">904</span>
<span class="normal">905</span>
<span class="normal">906</span>
<span class="normal">907</span>
<span class="normal">908</span>
<span class="normal">909</span>
<span class="normal">910</span>
<span class="normal">911</span>
<span class="normal">912</span>
<span class="normal">913</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_diurnal_cycle</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">diurnal</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="n">show_confidence</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">ax</span><span class="p">:</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="o">**</span><span class="n">style_kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="n">plt</span><span class="o">.</span><span class="n">Axes</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Plot a clock-time diurnal cycle.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    diurnal : xr.Dataset</span>
<span class="sd">        Output of :meth:`compute_diurnal_cycle`.</span>
<span class="sd">    show_confidence : bool, optional</span>
<span class="sd">        Draw Â±1 std band.</span>
<span class="sd">    ax : plt.Axes or None, optional</span>
<span class="sd">        Axes to draw on; created if ``None``.</span>
<span class="sd">    **style_kwargs</span>
<span class="sd">        ``ylabel``, ``title``, ``figsize``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig, ax : plt.Figure, plt.Axes</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="n">style_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;figsize&quot;</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">figure</span>

    <span class="n">hours</span> <span class="o">=</span> <span class="n">diurnal</span><span class="p">[</span><span class="s2">&quot;hour&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">mean</span> <span class="o">=</span> <span class="n">diurnal</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">diurnal</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hours</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="s2">&quot;o-&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Mean&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">show_confidence</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
            <span class="n">hours</span><span class="p">,</span>
            <span class="n">mean</span> <span class="o">-</span> <span class="n">std</span><span class="p">,</span>
            <span class="n">mean</span> <span class="o">+</span> <span class="n">std</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Â±1 std&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Hour of Day&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">style_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ylabel&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">style_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;Diurnal Cycle&quot;</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.TemporalAnalysis.plot_diurnal_cycle_comparison" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">plot_diurnal_cycle_comparison</span><span class="p">(</span><span class="n">diurnal_clock</span><span class="p">,</span> <span class="n">diurnal_solar</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="o">**</span><span class="n">style_kwargs</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.TemporalAnalysis.plot_diurnal_cycle_comparison" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Side-by-side clock-time vs solar-time diurnal cycle plots.</p>
<h5 id="canvod.grids.analysis.TemporalAnalysis.plot_diurnal_cycle_comparison--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.TemporalAnalysis.plot_diurnal_cycle_comparison--parameters" title="Permanent link">&para;</a></h5>
<p>diurnal_clock : xr.Dataset
    Output of :meth:<code>compute_diurnal_cycle</code>.
diurnal_solar : xr.Dataset
    Output of :meth:<code>compute_diurnal_cycle_solar</code>.
figsize : tuple, optional
    Figure size.
**style_kwargs
    <code>ylabel</code>, <code>title</code>.</p>
<h5 id="canvod.grids.analysis.TemporalAnalysis.plot_diurnal_cycle_comparison--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.TemporalAnalysis.plot_diurnal_cycle_comparison--returns" title="Permanent link">&para;</a></h5>
<p>fig, axes : plt.Figure, np.ndarray of plt.Axes</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/temporal.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">915</span>
<span class="normal">916</span>
<span class="normal">917</span>
<span class="normal">918</span>
<span class="normal">919</span>
<span class="normal">920</span>
<span class="normal">921</span>
<span class="normal">922</span>
<span class="normal">923</span>
<span class="normal">924</span>
<span class="normal">925</span>
<span class="normal">926</span>
<span class="normal">927</span>
<span class="normal">928</span>
<span class="normal">929</span>
<span class="normal">930</span>
<span class="normal">931</span>
<span class="normal">932</span>
<span class="normal">933</span>
<span class="normal">934</span>
<span class="normal">935</span>
<span class="normal">936</span>
<span class="normal">937</span>
<span class="normal">938</span>
<span class="normal">939</span>
<span class="normal">940</span>
<span class="normal">941</span>
<span class="normal">942</span>
<span class="normal">943</span>
<span class="normal">944</span>
<span class="normal">945</span>
<span class="normal">946</span>
<span class="normal">947</span>
<span class="normal">948</span>
<span class="normal">949</span>
<span class="normal">950</span>
<span class="normal">951</span>
<span class="normal">952</span>
<span class="normal">953</span>
<span class="normal">954</span>
<span class="normal">955</span>
<span class="normal">956</span>
<span class="normal">957</span>
<span class="normal">958</span>
<span class="normal">959</span>
<span class="normal">960</span>
<span class="normal">961</span>
<span class="normal">962</span>
<span class="normal">963</span>
<span class="normal">964</span>
<span class="normal">965</span>
<span class="normal">966</span>
<span class="normal">967</span>
<span class="normal">968</span>
<span class="normal">969</span>
<span class="normal">970</span>
<span class="normal">971</span>
<span class="normal">972</span>
<span class="normal">973</span>
<span class="normal">974</span>
<span class="normal">975</span>
<span class="normal">976</span>
<span class="normal">977</span>
<span class="normal">978</span>
<span class="normal">979</span>
<span class="normal">980</span>
<span class="normal">981</span>
<span class="normal">982</span>
<span class="normal">983</span>
<span class="normal">984</span>
<span class="normal">985</span>
<span class="normal">986</span>
<span class="normal">987</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">plot_diurnal_cycle_comparison</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">diurnal_clock</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="n">diurnal_solar</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="n">figsize</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span>
    <span class="o">**</span><span class="n">style_kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">plt</span><span class="o">.</span><span class="n">Figure</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Side-by-side clock-time vs solar-time diurnal cycle plots.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    diurnal_clock : xr.Dataset</span>
<span class="sd">        Output of :meth:`compute_diurnal_cycle`.</span>
<span class="sd">    diurnal_solar : xr.Dataset</span>
<span class="sd">        Output of :meth:`compute_diurnal_cycle_solar`.</span>
<span class="sd">    figsize : tuple, optional</span>
<span class="sd">        Figure size.</span>
<span class="sd">    **style_kwargs</span>
<span class="sd">        ``ylabel``, ``title``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig, axes : plt.Figure, np.ndarray of plt.Axes</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>

    <span class="c1"># Clock-time panel</span>
    <span class="n">hours</span> <span class="o">=</span> <span class="n">diurnal_clock</span><span class="p">[</span><span class="s2">&quot;hour&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">mean_c</span> <span class="o">=</span> <span class="n">diurnal_clock</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">std_c</span> <span class="o">=</span> <span class="n">diurnal_clock</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hours</span><span class="p">,</span> <span class="n">mean_c</span><span class="p">,</span> <span class="s2">&quot;o-&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">hours</span><span class="p">,</span> <span class="n">mean_c</span> <span class="o">-</span> <span class="n">std_c</span><span class="p">,</span> <span class="n">mean_c</span> <span class="o">+</span> <span class="n">std_c</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Hour of Day&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">style_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ylabel&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Clock-Time Diurnal Cycle&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

    <span class="c1"># Solar-elevation panel</span>
    <span class="n">solar_elev</span> <span class="o">=</span> <span class="n">diurnal_solar</span><span class="p">[</span><span class="s2">&quot;solar_elevation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">mean_s</span> <span class="o">=</span> <span class="n">diurnal_solar</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">std_s</span> <span class="o">=</span> <span class="n">diurnal_solar</span><span class="p">[</span><span class="s2">&quot;std&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
        <span class="n">solar_elev</span><span class="p">,</span>
        <span class="n">mean_s</span><span class="p">,</span>
        <span class="s2">&quot;o-&quot;</span><span class="p">,</span>
        <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">markersize</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span>
        <span class="n">solar_elev</span><span class="p">,</span>
        <span class="n">mean_s</span> <span class="o">-</span> <span class="n">std_s</span><span class="p">,</span>
        <span class="n">mean_s</span> <span class="o">+</span> <span class="n">std_s</span><span class="p">,</span>
        <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">&quot;orange&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Horizon&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Solar Elevation (Â°)&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">style_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;ylabel&quot;</span><span class="p">,</span> <span class="s2">&quot;Value&quot;</span><span class="p">))</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Solar-Time Diurnal Cycle&quot;</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span>
        <span class="n">style_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;Diurnal Cycle Comparison&quot;</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">1.02</span>
    <span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="canvod.grids.analysis.WeightCalculator" class="doc doc-heading">
            <code>WeightCalculator</code>


<a href="#canvod.grids.analysis.WeightCalculator" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">



        <p>Calculate and combine weights for spatial aggregation.</p>
<h4 id="canvod.grids.analysis.WeightCalculator--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.WeightCalculator--parameters" title="Permanent link">&para;</a></h4>
<p>grid : GridData
    Grid instance.
ds : xr.Dataset or None
    Dataset with data variables (required for data-dependent weights
    such as <code>observation_count</code>, <code>snr</code>, <code>inverse_variance</code>).</p>
<h4 id="canvod.grids.analysis.WeightCalculator--examples">Examples<a class="headerlink" href="#canvod.grids.analysis.WeightCalculator--examples" title="Permanent link">&para;</a></h4>
<blockquote>
<blockquote>
<blockquote>
<p>weights = WeightCalculator(grid, vod_ds)
weights.add_weight('solid_angle')
weights.add_weight('observation_count', normalize=True)
total_weights = weights.compute()</p>
</blockquote>
</blockquote>
</blockquote>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/weighting.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">WeightCalculator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate and combine weights for spatial aggregation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    grid : GridData</span>
<span class="sd">        Grid instance.</span>
<span class="sd">    ds : xr.Dataset or None</span>
<span class="sd">        Dataset with data variables (required for data-dependent weights</span>
<span class="sd">        such as ``observation_count``, ``snr``, ``inverse_variance``).</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; weights = WeightCalculator(grid, vod_ds)</span>
<span class="sd">    &gt;&gt;&gt; weights.add_weight(&#39;solid_angle&#39;)</span>
<span class="sd">    &gt;&gt;&gt; weights.add_weight(&#39;observation_count&#39;, normalize=True)</span>
<span class="sd">    &gt;&gt;&gt; total_weights = weights.compute()</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid</span><span class="p">:</span> <span class="n">GridData</span><span class="p">,</span> <span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the weight calculator.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        grid : GridData</span>
<span class="sd">            Grid instance.</span>
<span class="sd">        ds : xr.Dataset | None, optional</span>
<span class="sd">            Dataset with data variables for data-dependent weights.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_grid_df</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">grid</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Public API</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_weight</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">weight_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WeightCalculator</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a weight component.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        weight_type : str</span>
<span class="sd">            One of ``&#39;solid_angle&#39;``, ``&#39;observation_count&#39;``,</span>
<span class="sd">            ``&#39;snr&#39;``, ``&#39;sin_elevation&#39;``, ``&#39;inverse_variance&#39;``,</span>
<span class="sd">            ``&#39;custom&#39;``.</span>
<span class="sd">        normalize : bool</span>
<span class="sd">            If ``True``, normalise this component to sum to 1.0 before</span>
<span class="sd">            combination.</span>
<span class="sd">        **kwargs</span>
<span class="sd">            Weight-specific parameters (see individual ``_compute_*``</span>
<span class="sd">            methods).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        WeightCalculator</span>
<span class="sd">            Self for chaining.</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; calc.add_weight(&#39;solid_angle&#39;)</span>
<span class="sd">        &gt;&gt;&gt; calc.add_weight(&#39;observation_count&#39;, var_name=&#39;VOD&#39;, normalize=True)</span>
<span class="sd">        &gt;&gt;&gt; calc.add_weight(&#39;custom&#39;, values=my_weights, normalize=False)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">weight_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Weight &#39;</span><span class="si">{</span><span class="n">weight_type</span><span class="si">}</span><span class="s2">&#39; already exists, overwriting&quot;</span><span class="p">)</span>

        <span class="n">_DISPATCH</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;solid_angle&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_solid_angle_weight</span><span class="p">,</span>
            <span class="s2">&quot;observation_count&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_observation_count_weight</span><span class="p">,</span>
            <span class="s2">&quot;snr&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_snr_weight</span><span class="p">,</span>
            <span class="s2">&quot;sin_elevation&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_sin_elevation_weight</span><span class="p">,</span>
            <span class="s2">&quot;inverse_variance&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_inverse_variance_weight</span><span class="p">,</span>
            <span class="s2">&quot;custom&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_custom_weight</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">weight_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_DISPATCH</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unknown weight_type: </span><span class="si">{</span><span class="n">weight_type</span><span class="si">}</span><span class="s2">. Valid: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">_DISPATCH</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">weight</span> <span class="o">=</span> <span class="n">_DISPATCH</span><span class="p">[</span><span class="n">weight_type</span><span class="p">](</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
            <span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_weights</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">weight_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight_params</span><span class="p">[</span><span class="n">weight_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;normalize&quot;</span><span class="p">:</span> <span class="n">normalize</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">combination</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;multiply&quot;</span><span class="p">,</span> <span class="s2">&quot;add&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;multiply&quot;</span><span class="p">,</span>
        <span class="n">normalize_final</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute final combined weights.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        combination : str</span>
<span class="sd">            ``&#39;multiply&#39;`` â element-wise product (default).</span>
<span class="sd">            ``&#39;add&#39;``      â element-wise sum.</span>
<span class="sd">        normalize_final : bool</span>
<span class="sd">            If ``True``, normalise the final array to sum to 1.0.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Weight array of shape ``(ncells,)``.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If no weights have been added or *combination* is unknown.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No weights added. Use add_weight() before compute()&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">combination</span> <span class="o">==</span> <span class="s2">&quot;multiply&quot;</span><span class="p">:</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">combined</span> <span class="o">=</span> <span class="n">combined</span> <span class="o">*</span> <span class="n">w</span>
        <span class="k">elif</span> <span class="n">combination</span> <span class="o">==</span> <span class="s2">&quot;add&quot;</span><span class="p">:</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">combined</span> <span class="o">=</span> <span class="n">combined</span> <span class="o">+</span> <span class="n">w</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown combination: </span><span class="si">{</span><span class="n">combination</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">normalize_final</span><span class="p">:</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_weights</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>

        <span class="n">n_nonzero</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">combined</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">nonzero_vals</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="n">combined</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Computed weights: </span><span class="si">{</span><span class="n">n_nonzero</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="si">}</span><span class="s2"> cells with &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;non-zero weight, min=</span><span class="si">{</span><span class="n">nonzero_vals</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, max=</span><span class="si">{</span><span class="n">combined</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">combined</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Introspection</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_weight_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Summary statistics for each weight component.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Nested dict keyed by weight type.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">summary</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;components&quot;</span><span class="p">:</span> <span class="p">{}}</span>
        <span class="k">for</span> <span class="n">wtype</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">nonzero</span> <span class="o">=</span> <span class="n">weight</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;components&quot;</span><span class="p">][</span><span class="n">wtype</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;n_nonzero&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">nonzero</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span>
                <span class="s2">&quot;fraction_nonzero&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">nonzero</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">),</span>
                <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">weight</span><span class="p">[</span><span class="n">nonzero</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="k">if</span> <span class="n">nonzero</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">weight</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
                <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">weight</span><span class="p">[</span><span class="n">nonzero</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="k">if</span> <span class="n">nonzero</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_params</span><span class="p">[</span><span class="n">wtype</span><span class="p">],</span>
            <span class="p">}</span>
        <span class="k">return</span> <span class="n">summary</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">remove_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weight_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WeightCalculator</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove a weight component.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        weight_type : str</span>
<span class="sd">            Weight type to remove.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        WeightCalculator</span>
<span class="sd">            Self for chaining.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">weight_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">weight_type</span><span class="p">]</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_params</span><span class="p">[</span><span class="n">weight_type</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed weight: </span><span class="si">{</span><span class="n">weight_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Weight &#39;</span><span class="si">{</span><span class="n">weight_type</span><span class="si">}</span><span class="s2">&#39; not found&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WeightCalculator</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear all weights.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        WeightCalculator</span>
<span class="sd">            Self for chaining.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weight_params</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the developer-facing representation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            Representation string.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;WeightCalculator(grid=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">grid_type</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;weights=</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Weight computation (private)</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_solid_angle_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Weights based on cell solid angles (geometric fairness).&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;solid_angle&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">solid_angles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid_df</span><span class="p">[</span><span class="s2">&quot;solid_angle&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Computing solid angles from grid geometry&quot;</span><span class="p">)</span>
            <span class="n">solid_angles</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_solid_angles_from_geometry</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">solid_angles</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Found non-positive solid angles, setting to small value&quot;</span><span class="p">)</span>
            <span class="n">solid_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">solid_angles</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">solid_angles</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_solid_angles_from_geometry</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute solid angles for each cell from grid geometry.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Solid angles in steradians.</span>

<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        The sum of solid angles should equal the hemisphere area</span>
<span class="sd">        (2Ï steradians) for a complete hemisphere.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">grid_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">grid_type</span>

        <span class="k">if</span> <span class="n">grid_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;equal_area&quot;</span><span class="p">,</span> <span class="s2">&quot;equal_angle&quot;</span><span class="p">,</span> <span class="s2">&quot;equirectangular&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_rectangular_solid_angles</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">grid_type</span> <span class="o">==</span> <span class="s2">&quot;htm&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_htm_solid_angles</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">grid_type</span> <span class="o">==</span> <span class="s2">&quot;geodesic&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_geodesic_solid_angles</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">grid_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;healpix&quot;</span><span class="p">,</span> <span class="s2">&quot;fibonacci&quot;</span><span class="p">):</span>
            <span class="c1"># Both are (approximately) equal-area</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid_df</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
            <span class="n">hemisphere_cells</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">theta</span> <span class="o">&lt;=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">hemisphere_cells</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">cell_area</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="n">hemisphere_cells</span>
                <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span> <span class="n">cell_area</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown grid type: </span><span class="si">{</span><span class="n">grid_type</span><span class="si">}</span><span class="s2">, using uniform weights&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_rectangular_solid_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Solid angle = ÎÏ Ã [cos(Î¸_min) â cos(Î¸_max)].&quot;&quot;&quot;</span>
        <span class="n">phi_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid_df</span><span class="p">[</span><span class="s2">&quot;phi_min&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">phi_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid_df</span><span class="p">[</span><span class="s2">&quot;phi_max&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">theta_min</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid_df</span><span class="p">[</span><span class="s2">&quot;theta_min&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">theta_max</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid_df</span><span class="p">[</span><span class="s2">&quot;theta_max&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="n">delta_phi</span> <span class="o">=</span> <span class="n">phi_max</span> <span class="o">-</span> <span class="n">phi_min</span>
        <span class="k">return</span> <span class="n">delta_phi</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_min</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta_max</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_htm_solid_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Solid angles for HTM triangular cells via L&#39;Huilier&#39;s theorem.</span>

<span class="sd">        For each spherical triangle with vertices on the unit sphere the</span>
<span class="sd">        solid angle is computed as:</span>

<span class="sd">            Î© = 4 arctan â(tan(s/2) tan((sâa)/2) tan((sâb)/2) tan((sâc)/2))</span>

<span class="sd">        where *a*, *b*, *c* are arc-lengths between vertex pairs and</span>
<span class="sd">        *s* = (a+b+c)/2.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">solid_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_grid_df</span><span class="o">.</span><span class="n">iter_rows</span><span class="p">(</span><span class="n">named</span><span class="o">=</span><span class="kc">True</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">v0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;htm_vertex_0&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;htm_vertex_1&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;htm_vertex_2&quot;</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>

                <span class="c1"># Skip cells significantly below the horizon</span>
                <span class="k">if</span> <span class="n">v0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.01</span> <span class="ow">or</span> <span class="n">v1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.01</span> <span class="ow">or</span> <span class="n">v2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># Normalise to unit sphere</span>
                <span class="n">v0</span> <span class="o">=</span> <span class="n">v0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span>
                <span class="n">v1</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
                <span class="n">v2</span> <span class="o">=</span> <span class="n">v2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>

                <span class="c1"># Arc lengths between vertex pairs</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">v2</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">v1</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

                <span class="n">s</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">+</span> <span class="n">c</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>  <span class="c1"># semi-perimeter</span>

                <span class="n">product</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">(</span><span class="n">s</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">((</span><span class="n">s</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">((</span><span class="n">s</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">tan</span><span class="p">((</span><span class="n">s</span> <span class="o">-</span> <span class="n">c</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="p">)</span>

                <span class="n">solid_angles</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="mi">4</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">product</span><span class="p">))</span> <span class="k">if</span> <span class="n">product</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>
                <span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error computing HTM solid angle </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">solid_angles</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_geodesic_solid_angles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Solid angles for geodesic cells from vertex data.&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">polars</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pl</span>

        <span class="n">solid_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="p">,</span> <span class="s2">&quot;vertices&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">vertices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">vertices_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">vertices</span>

            <span class="k">for</span> <span class="n">cell_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cell_verts</span> <span class="o">=</span> <span class="n">vertices_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pl</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;cell_id&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">cell_id</span><span class="p">)</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span>
                        <span class="s2">&quot;vertex_idx&quot;</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell_verts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="k">continue</span>

                    <span class="n">x</span> <span class="o">=</span> <span class="n">cell_verts</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">y</span> <span class="o">=</span> <span class="n">cell_verts</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">z</span> <span class="o">=</span> <span class="n">cell_verts</span><span class="p">[</span><span class="s2">&quot;z&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()[:</span><span class="mi">3</span><span class="p">]</span>

                    <span class="n">v0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
                    <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
                    <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">z</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>

                    <span class="n">v0</span> <span class="o">=</span> <span class="n">v0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v0</span><span class="p">)</span>
                    <span class="n">v1</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
                    <span class="n">v2</span> <span class="o">=</span> <span class="n">v2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>

                    <span class="n">numerator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)))</span>
                    <span class="n">denominator</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v0</span><span class="p">,</span> <span class="n">v1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">v2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v2</span><span class="p">,</span> <span class="n">v0</span><span class="p">)</span>

                    <span class="n">solid_angles</span><span class="p">[</span><span class="n">cell_id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span>
                        <span class="n">numerator</span><span class="p">,</span>
                        <span class="n">denominator</span><span class="p">,</span>
                    <span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Error computing geodesic solid angle </span><span class="si">{</span><span class="n">cell_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Approximate: equal area</span>
            <span class="n">solid_angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span>
                <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">solid_angles</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_observation_count_weight</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;VOD&quot;</span><span class="p">,</span>
        <span class="n">cell_id_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">min_count</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Weights based on number of observations per cell.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        var_name : str</span>
<span class="sd">            Variable to count observations for.</span>
<span class="sd">        cell_id_var : str, optional</span>
<span class="sd">            Cell-ID variable name (auto-detected if ``None``).</span>
<span class="sd">        min_count : int</span>
<span class="sd">            Cells with fewer observations get weight 0.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dataset required for observation_count weights.&quot;</span><span class="p">)</span>

        <span class="n">cell_id_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_cell_id_var</span><span class="p">(</span><span class="n">cell_id_var</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">var_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variable &#39;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">&#39; not found in dataset&quot;</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing observation counts (this may take 30-60 seconds)...&quot;</span><span class="p">)</span>

        <span class="n">cell_ids_da</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">cell_id_var</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">var_values_da</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="n">valid_mask</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cell_ids_da</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">da</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">var_values_da</span><span class="p">)</span>
        <span class="n">valid_cell_ids</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">,</span> <span class="n">cell_ids_da</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="n">counts</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
            <span class="n">valid_cell_ids</span><span class="p">[</span><span class="n">valid_cell_ids</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">],</span>
            <span class="n">bins</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>

        <span class="n">weights</span> <span class="o">=</span> <span class="n">counts</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">weights</span><span class="p">[</span><span class="n">counts</span> <span class="o">&lt;</span> <span class="n">min_count</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Observation counts: min=</span><span class="si">{</span><span class="n">counts</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">}</span><span class="s2">, max=</span><span class="si">{</span><span class="n">counts</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;mean=</span><span class="si">{</span><span class="n">counts</span><span class="p">[</span><span class="n">counts</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;cells_with_data=</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">counts</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">weights</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_snr_weight</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">snr_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;SNR&quot;</span><span class="p">,</span>
        <span class="n">cell_id_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">aggregation</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;median&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Weights based on signal-to-noise ratio.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        snr_var : str</span>
<span class="sd">            SNR variable name in the dataset.</span>
<span class="sd">        cell_id_var : str, optional</span>
<span class="sd">            Cell-ID variable name.</span>
<span class="sd">        aggregation : str</span>
<span class="sd">            Per-cell aggregation: ``&#39;mean&#39;``, ``&#39;median&#39;``, or ``&#39;max&#39;``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dataset required for SNR weights&quot;</span><span class="p">)</span>

        <span class="c1"># Use pre-aggregated column if available</span>
        <span class="k">if</span> <span class="s2">&quot;mean_snr&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using pre-computed mean_snr from grid&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid_df</span><span class="p">[</span><span class="s2">&quot;mean_snr&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">snr_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SNR variable &#39;</span><span class="si">{</span><span class="n">snr_var</span><span class="si">}</span><span class="s2">&#39; not found in dataset&quot;</span><span class="p">)</span>

        <span class="n">cell_id_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_cell_id_var</span><span class="p">(</span><span class="n">cell_id_var</span><span class="p">)</span>

        <span class="n">cell_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">cell_id_var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">snr_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">snr_var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="n">valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cell_ids</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">snr_values</span><span class="p">)</span>
        <span class="n">cell_ids_valid</span> <span class="o">=</span> <span class="n">cell_ids</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">snr_valid</span> <span class="o">=</span> <span class="n">snr_values</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>

        <span class="n">_AGG</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_AGG</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown aggregation: </span><span class="si">{</span><span class="n">aggregation</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">agg_fn</span> <span class="o">=</span> <span class="n">_AGG</span><span class="p">[</span><span class="n">aggregation</span><span class="p">]</span>

        <span class="n">snr_per_cell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cell_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">):</span>
            <span class="n">cell_mask</span> <span class="o">=</span> <span class="n">cell_ids_valid</span> <span class="o">==</span> <span class="n">cell_id</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">cell_mask</span><span class="p">):</span>
                <span class="n">snr_per_cell</span><span class="p">[</span><span class="n">cell_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">agg_fn</span><span class="p">(</span><span class="n">snr_valid</span><span class="p">[</span><span class="n">cell_mask</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">snr_per_cell</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_sin_elevation_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Geometric correction: weight = sin(elevation) = cos(Î¸).</span>

<span class="sd">        Higher elevation â shorter atmospheric path â higher weight.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grid_df</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="mf">0.0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_inverse_variance_weight</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">var_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;VOD&quot;</span><span class="p">,</span>
        <span class="n">cell_id_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">min_observations</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">regularization</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Precision weighting: weight = 1 / (variance + regularization).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        var_name : str</span>
<span class="sd">            Variable to compute per-cell variance for.</span>
<span class="sd">        cell_id_var : str, optional</span>
<span class="sd">            Cell-ID variable name.</span>
<span class="sd">        min_observations : int</span>
<span class="sd">            Minimum observations to compute variance.</span>
<span class="sd">        regularization : float</span>
<span class="sd">            Added to variance to avoid division by zero.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Dataset required for inverse_variance weights&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">var_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variable &#39;</span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2">&#39; not found in dataset&quot;</span><span class="p">)</span>

        <span class="n">cell_id_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_cell_id_var</span><span class="p">(</span><span class="n">cell_id_var</span><span class="p">)</span>

        <span class="n">cell_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">cell_id_var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">var_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

        <span class="n">valid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cell_ids</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">var_values</span><span class="p">)</span>
        <span class="n">cell_ids_valid</span> <span class="o">=</span> <span class="n">cell_ids</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">var_valid</span> <span class="o">=</span> <span class="n">var_values</span><span class="p">[</span><span class="n">valid</span><span class="p">]</span>

        <span class="n">variances</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cell_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">):</span>
            <span class="n">cell_mask</span> <span class="o">=</span> <span class="n">cell_ids_valid</span> <span class="o">==</span> <span class="n">cell_id</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cell_mask</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_observations</span><span class="p">:</span>
                <span class="n">variances</span><span class="p">[</span><span class="n">cell_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">var_valid</span><span class="p">[</span><span class="n">cell_mask</span><span class="p">],</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">)</span>
        <span class="n">valid_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">variances</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">variances</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">valid_var</span><span class="p">):</span>
            <span class="n">weights</span><span class="p">[</span><span class="n">valid_var</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">variances</span><span class="p">[</span><span class="n">valid_var</span><span class="p">]</span> <span class="o">+</span> <span class="n">regularization</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">weights</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_compute_custom_weight</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;User-provided weight array.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        values : np.ndarray</span>
<span class="sd">            Must have shape ``(ncells,)``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Custom weights must be numpy array&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">,):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Custom weights shape </span><span class="si">{</span><span class="n">values</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> doesn&#39;t match &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;grid size (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="si">}</span><span class="s2">,)&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># ------------------------------------------------------------------</span>
    <span class="c1"># Helpers</span>
    <span class="c1"># ------------------------------------------------------------------</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_resolve_cell_id_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_id_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Auto-detect cell-ID variable if not specified.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cell_id_var : str or None</span>
<span class="sd">            Explicit name, or ``None`` for auto-detection.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            Resolved variable name.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError</span>
<span class="sd">            If no ``cell_id_*`` variable is found.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cell_id_var</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cell_id_var</span>

        <span class="n">candidate</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;cell_id_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">grid_type</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">candidate</span>

        <span class="n">cell_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;cell_id_&quot;</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">cell_vars</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Auto-detected cell_id variable: </span><span class="si">{</span><span class="n">cell_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">cell_vars</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No cell_id variable found in dataset.&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_normalize_weights</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Normalise weights to sum to 1.0, handling NaN and zeros.&quot;&quot;&quot;</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">weight_sum</span> <span class="o">=</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">weight_sum</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">weights</span> <span class="o">/</span> <span class="n">weight_sum</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;All weights are zero, returning uniform weights&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.WeightCalculator.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">ds</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.WeightCalculator.__init__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Initialize the weight calculator.</p>
<h5 id="canvod.grids.analysis.WeightCalculator.__init__--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.WeightCalculator.__init__--parameters" title="Permanent link">&para;</a></h5>
<p>grid : GridData
    Grid instance.
ds : xr.Dataset | None, optional
    Dataset with data variables for data-dependent weights.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/weighting.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grid</span><span class="p">:</span> <span class="n">GridData</span><span class="p">,</span> <span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the weight calculator.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    grid : GridData</span>
<span class="sd">        Grid instance.</span>
<span class="sd">    ds : xr.Dataset | None, optional</span>
<span class="sd">        Dataset with data variables for data-dependent weights.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">grid</span> <span class="o">=</span> <span class="n">grid</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">weight_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_grid_df</span> <span class="o">=</span> <span class="n">grid</span><span class="o">.</span><span class="n">grid</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.WeightCalculator.add_weight" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_weight</span><span class="p">(</span><span class="n">weight_type</span><span class="p">,</span> <span class="n">normalize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.WeightCalculator.add_weight" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Add a weight component.</p>
<h5 id="canvod.grids.analysis.WeightCalculator.add_weight--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.WeightCalculator.add_weight--parameters" title="Permanent link">&para;</a></h5>
<p>weight_type : str
    One of <code>'solid_angle'</code>, <code>'observation_count'</code>,
    <code>'snr'</code>, <code>'sin_elevation'</code>, <code>'inverse_variance'</code>,
    <code>'custom'</code>.
normalize : bool
    If <code>True</code>, normalise this component to sum to 1.0 before
    combination.
**kwargs
    Weight-specific parameters (see individual <code>_compute_*</code>
    methods).</p>
<h5 id="canvod.grids.analysis.WeightCalculator.add_weight--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.WeightCalculator.add_weight--returns" title="Permanent link">&para;</a></h5>
<p>WeightCalculator
    Self for chaining.</p>
<h5 id="canvod.grids.analysis.WeightCalculator.add_weight--examples">Examples<a class="headerlink" href="#canvod.grids.analysis.WeightCalculator.add_weight--examples" title="Permanent link">&para;</a></h5>
<blockquote>
<blockquote>
<blockquote>
<p>calc.add_weight('solid_angle')
calc.add_weight('observation_count', var_name='VOD', normalize=True)
calc.add_weight('custom', values=my_weights, normalize=False)</p>
</blockquote>
</blockquote>
</blockquote>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/weighting.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_weight</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">weight_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">normalize</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WeightCalculator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a weight component.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    weight_type : str</span>
<span class="sd">        One of ``&#39;solid_angle&#39;``, ``&#39;observation_count&#39;``,</span>
<span class="sd">        ``&#39;snr&#39;``, ``&#39;sin_elevation&#39;``, ``&#39;inverse_variance&#39;``,</span>
<span class="sd">        ``&#39;custom&#39;``.</span>
<span class="sd">    normalize : bool</span>
<span class="sd">        If ``True``, normalise this component to sum to 1.0 before</span>
<span class="sd">        combination.</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Weight-specific parameters (see individual ``_compute_*``</span>
<span class="sd">        methods).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    WeightCalculator</span>
<span class="sd">        Self for chaining.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; calc.add_weight(&#39;solid_angle&#39;)</span>
<span class="sd">    &gt;&gt;&gt; calc.add_weight(&#39;observation_count&#39;, var_name=&#39;VOD&#39;, normalize=True)</span>
<span class="sd">    &gt;&gt;&gt; calc.add_weight(&#39;custom&#39;, values=my_weights, normalize=False)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">weight_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Weight &#39;</span><span class="si">{</span><span class="n">weight_type</span><span class="si">}</span><span class="s2">&#39; already exists, overwriting&quot;</span><span class="p">)</span>

    <span class="n">_DISPATCH</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;solid_angle&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_solid_angle_weight</span><span class="p">,</span>
        <span class="s2">&quot;observation_count&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_observation_count_weight</span><span class="p">,</span>
        <span class="s2">&quot;snr&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_snr_weight</span><span class="p">,</span>
        <span class="s2">&quot;sin_elevation&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_sin_elevation_weight</span><span class="p">,</span>
        <span class="s2">&quot;inverse_variance&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_inverse_variance_weight</span><span class="p">,</span>
        <span class="s2">&quot;custom&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_custom_weight</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">weight_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_DISPATCH</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unknown weight_type: </span><span class="si">{</span><span class="n">weight_type</span><span class="si">}</span><span class="s2">. Valid: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">_DISPATCH</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">weight</span> <span class="o">=</span> <span class="n">_DISPATCH</span><span class="p">[</span><span class="n">weight_type</span><span class="p">](</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
        <span class="n">weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_weights</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">weight_type</span><span class="p">]</span> <span class="o">=</span> <span class="n">weight</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">weight_params</span><span class="p">[</span><span class="n">weight_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;normalize&quot;</span><span class="p">:</span> <span class="n">normalize</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">}</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.WeightCalculator.compute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">compute</span><span class="p">(</span><span class="n">combination</span><span class="o">=</span><span class="s1">&#39;multiply&#39;</span><span class="p">,</span> <span class="n">normalize_final</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.WeightCalculator.compute" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Compute final combined weights.</p>
<h5 id="canvod.grids.analysis.WeightCalculator.compute--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.WeightCalculator.compute--parameters" title="Permanent link">&para;</a></h5>
<p>combination : str
    <code>'multiply'</code> â element-wise product (default).
    <code>'add'</code>      â element-wise sum.
normalize_final : bool
    If <code>True</code>, normalise the final array to sum to 1.0.</p>
<h5 id="canvod.grids.analysis.WeightCalculator.compute--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.WeightCalculator.compute--returns" title="Permanent link">&para;</a></h5>
<p>np.ndarray
    Weight array of shape <code>(ncells,)</code>.</p>
<h5 id="canvod.grids.analysis.WeightCalculator.compute--raises">Raises<a class="headerlink" href="#canvod.grids.analysis.WeightCalculator.compute--raises" title="Permanent link">&para;</a></h5>
<p>ValueError
    If no weights have been added or <em>combination</em> is unknown.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/weighting.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">compute</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">combination</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;multiply&quot;</span><span class="p">,</span> <span class="s2">&quot;add&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;multiply&quot;</span><span class="p">,</span>
    <span class="n">normalize_final</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute final combined weights.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    combination : str</span>
<span class="sd">        ``&#39;multiply&#39;`` â element-wise product (default).</span>
<span class="sd">        ``&#39;add&#39;``      â element-wise sum.</span>
<span class="sd">    normalize_final : bool</span>
<span class="sd">        If ``True``, normalise the final array to sum to 1.0.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Weight array of shape ``(ncells,)``.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If no weights have been added or *combination* is unknown.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No weights added. Use add_weight() before compute()&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">combination</span> <span class="o">==</span> <span class="s2">&quot;multiply&quot;</span><span class="p">:</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="n">combined</span> <span class="o">*</span> <span class="n">w</span>
    <span class="k">elif</span> <span class="n">combination</span> <span class="o">==</span> <span class="s2">&quot;add&quot;</span><span class="p">:</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">combined</span> <span class="o">=</span> <span class="n">combined</span> <span class="o">+</span> <span class="n">w</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown combination: </span><span class="si">{</span><span class="n">combination</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">normalize_final</span><span class="p">:</span>
        <span class="n">combined</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_normalize_weights</span><span class="p">(</span><span class="n">combined</span><span class="p">)</span>

    <span class="n">n_nonzero</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">combined</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">nonzero_vals</span> <span class="o">=</span> <span class="n">combined</span><span class="p">[</span><span class="n">combined</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Computed weights: </span><span class="si">{</span><span class="n">n_nonzero</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="si">}</span><span class="s2"> cells with &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;non-zero weight, min=</span><span class="si">{</span><span class="n">nonzero_vals</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">, max=</span><span class="si">{</span><span class="n">combined</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">combined</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.WeightCalculator.get_weight_summary" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_weight_summary</span><span class="p">()</span></code>

<a href="#canvod.grids.analysis.WeightCalculator.get_weight_summary" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Summary statistics for each weight component.</p>
<h5 id="canvod.grids.analysis.WeightCalculator.get_weight_summary--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.WeightCalculator.get_weight_summary--returns" title="Permanent link">&para;</a></h5>
<p>dict
    Nested dict keyed by weight type.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/weighting.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_weight_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Summary statistics for each weight component.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Nested dict keyed by weight type.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">summary</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;components&quot;</span><span class="p">:</span> <span class="p">{}}</span>
    <span class="k">for</span> <span class="n">wtype</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">nonzero</span> <span class="o">=</span> <span class="n">weight</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;components&quot;</span><span class="p">][</span><span class="n">wtype</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;n_nonzero&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">nonzero</span><span class="o">.</span><span class="n">sum</span><span class="p">()),</span>
            <span class="s2">&quot;fraction_nonzero&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">nonzero</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">ncells</span><span class="p">),</span>
            <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">weight</span><span class="p">[</span><span class="n">nonzero</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="k">if</span> <span class="n">nonzero</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">weight</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
            <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">weight</span><span class="p">[</span><span class="n">nonzero</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span> <span class="k">if</span> <span class="n">nonzero</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;params&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_params</span><span class="p">[</span><span class="n">wtype</span><span class="p">],</span>
        <span class="p">}</span>
    <span class="k">return</span> <span class="n">summary</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.WeightCalculator.remove_weight" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">remove_weight</span><span class="p">(</span><span class="n">weight_type</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.WeightCalculator.remove_weight" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Remove a weight component.</p>
<h5 id="canvod.grids.analysis.WeightCalculator.remove_weight--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.WeightCalculator.remove_weight--parameters" title="Permanent link">&para;</a></h5>
<p>weight_type : str
    Weight type to remove.</p>
<h5 id="canvod.grids.analysis.WeightCalculator.remove_weight--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.WeightCalculator.remove_weight--returns" title="Permanent link">&para;</a></h5>
<p>WeightCalculator
    Self for chaining.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/weighting.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">remove_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weight_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WeightCalculator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove a weight component.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    weight_type : str</span>
<span class="sd">        Weight type to remove.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    WeightCalculator</span>
<span class="sd">        Self for chaining.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">weight_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">:</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">[</span><span class="n">weight_type</span><span class="p">]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_params</span><span class="p">[</span><span class="n">weight_type</span><span class="p">]</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed weight: </span><span class="si">{</span><span class="n">weight_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Weight &#39;</span><span class="si">{</span><span class="n">weight_type</span><span class="si">}</span><span class="s2">&#39; not found&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.WeightCalculator.clear" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">clear</span><span class="p">()</span></code>

<a href="#canvod.grids.analysis.WeightCalculator.clear" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Clear all weights.</p>
<h5 id="canvod.grids.analysis.WeightCalculator.clear--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.WeightCalculator.clear--returns" title="Permanent link">&para;</a></h5>
<p>WeightCalculator
    Self for chaining.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/weighting.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WeightCalculator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clear all weights.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    WeightCalculator</span>
<span class="sd">        Self for chaining.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">weights</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">weight_params</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">return</span> <span class="bp">self</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="canvod.grids.analysis.WeightCalculator.__repr__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__repr__</span><span class="p">()</span></code>

<a href="#canvod.grids.analysis.WeightCalculator.__repr__" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Return the developer-facing representation.</p>
<h5 id="canvod.grids.analysis.WeightCalculator.__repr__--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.WeightCalculator.__repr__--returns" title="Permanent link">&para;</a></h5>
<p>str
    Representation string.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/weighting.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the developer-facing representation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str</span>
<span class="sd">        Representation string.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;WeightCalculator(grid=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">grid</span><span class="o">.</span><span class="n">grid_type</span><span class="si">}</span><span class="s2">, &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;weights=</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">)&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h2 id="canvod.grids.analysis.aggr_hampel_cell_sid_parallelized" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">aggr_hampel_cell_sid_parallelized</span><span class="p">(</span><span class="n">vod_ds</span><span class="p">,</span> <span class="n">grid_name</span><span class="o">=</span><span class="s1">&#39;equal_area_2deg&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">min_obs_per_sid</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">spatial_batch_size</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">n_workers</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">temporal_agg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">agg_method</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.aggr_hampel_cell_sid_parallelized" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Parallelized cellâSID Hampel filter with optional temporal aggregation.</p>
<p>Each (cell_id, SID) series is filtered independently.  When
<em>temporal_agg</em> is set, data is first binned into temporal windows
before filtering; Ï, Î¸ and cell IDs are reassigned consistently on
the output.</p>
<h4 id="canvod.grids.analysis.aggr_hampel_cell_sid_parallelized--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.aggr_hampel_cell_sid_parallelized--parameters" title="Permanent link">&para;</a></h4>
<p>vod_ds : xr.Dataset
    Input dataset with <code>'VOD'</code>, <code>'phi'</code>, <code>'theta'</code> and a
    <code>cell_id_&lt;grid_name&gt;</code> variable.
grid_name : str
    Grid identifier (e.g. <code>'equal_area_2deg'</code>).  Used to locate
    or create the cell-ID variable.
threshold : float
    MAD multiplier.
min_obs_per_sid : int
    Minimum valid observations per cell-SID.
spatial_batch_size : int
    Cells per parallel batch.
n_workers : int or None
    Worker count (defaults to <code>min(cpu_count(), 8)</code>).
temporal_agg : str or None
    Temporal aggregation frequency (e.g. <code>'1H'</code>, <code>'1D'</code>).
    <code>None</code> â no aggregation.
agg_method : str
    <code>'mean'</code> or <code>'median'</code> for temporal aggregation.</p>
<h4 id="canvod.grids.analysis.aggr_hampel_cell_sid_parallelized--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.aggr_hampel_cell_sid_parallelized--returns" title="Permanent link">&para;</a></h4>
<p>xr.Dataset
    Dataset with <code>'VOD'</code> (aggregated raw), <code>'VOD_filtered_hampel'</code>,
    <code>'hampel_outlier_mask'</code>, <code>'hampel_processing_mask'</code>,
    reassigned <code>phi</code>, <code>theta</code> and <code>cell_id_&lt;grid_name&gt;</code>.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/hampel_filtering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">aggr_hampel_cell_sid_parallelized</span><span class="p">(</span>
    <span class="n">vod_ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="n">grid_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;equal_area_2deg&quot;</span><span class="p">,</span>
    <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
    <span class="n">min_obs_per_sid</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">spatial_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
    <span class="n">n_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">temporal_agg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">agg_method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parallelized cellâSID Hampel filter with optional temporal aggregation.</span>

<span class="sd">    Each (cell_id, SID) series is filtered independently.  When</span>
<span class="sd">    *temporal_agg* is set, data is first binned into temporal windows</span>
<span class="sd">    before filtering; Ï, Î¸ and cell IDs are reassigned consistently on</span>
<span class="sd">    the output.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vod_ds : xr.Dataset</span>
<span class="sd">        Input dataset with ``&#39;VOD&#39;``, ``&#39;phi&#39;``, ``&#39;theta&#39;`` and a</span>
<span class="sd">        ``cell_id_&lt;grid_name&gt;`` variable.</span>
<span class="sd">    grid_name : str</span>
<span class="sd">        Grid identifier (e.g. ``&#39;equal_area_2deg&#39;``).  Used to locate</span>
<span class="sd">        or create the cell-ID variable.</span>
<span class="sd">    threshold : float</span>
<span class="sd">        MAD multiplier.</span>
<span class="sd">    min_obs_per_sid : int</span>
<span class="sd">        Minimum valid observations per cell-SID.</span>
<span class="sd">    spatial_batch_size : int</span>
<span class="sd">        Cells per parallel batch.</span>
<span class="sd">    n_workers : int or None</span>
<span class="sd">        Worker count (defaults to ``min(cpu_count(), 8)``).</span>
<span class="sd">    temporal_agg : str or None</span>
<span class="sd">        Temporal aggregation frequency (e.g. ``&#39;1H&#39;``, ``&#39;1D&#39;``).</span>
<span class="sd">        ``None`` â no aggregation.</span>
<span class="sd">    agg_method : str</span>
<span class="sd">        ``&#39;mean&#39;`` or ``&#39;median&#39;`` for temporal aggregation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xr.Dataset</span>
<span class="sd">        Dataset with ``&#39;VOD&#39;`` (aggregated raw), ``&#39;VOD_filtered_hampel&#39;``,</span>
<span class="sd">        ``&#39;hampel_outlier_mask&#39;``, ``&#39;hampel_processing_mask&#39;``,</span>
<span class="sd">        reassigned ``phi``, ``theta`` and ``cell_id_&lt;grid_name&gt;``.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n_workers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_workers</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cpu_count</span><span class="p">(),</span> <span class="mi">8</span><span class="p">)</span>

    <span class="c1"># --- Parse grid_name â (grid_type, resolution) ---</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">grid_name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;deg&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Grid name &#39;</span><span class="si">{</span><span class="n">grid_name</span><span class="si">}</span><span class="s2">&#39; must end with &#39;&lt;N&gt;deg&#39;&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">resolution</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;deg&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not parse resolution from grid name &#39;</span><span class="si">{</span><span class="n">grid_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="n">grid_type</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">grid</span> <span class="o">=</span> <span class="n">create_hemigrid</span><span class="p">(</span><span class="n">angular_resolution</span><span class="o">=</span><span class="n">resolution</span><span class="p">,</span> <span class="n">grid_type</span><span class="o">=</span><span class="n">grid_type</span><span class="p">)</span>

    <span class="n">cell_id_var</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;cell_id_</span><span class="si">{</span><span class="n">grid_name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">cell_id_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vod_ds</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No &#39;</span><span class="si">%s</span><span class="s2">&#39; in input dataset â assigning now.&quot;</span><span class="p">,</span> <span class="n">cell_id_var</span><span class="p">)</span>
        <span class="n">vod_ds</span> <span class="o">=</span> <span class="n">add_cell_ids_to_vod_fast</span><span class="p">(</span><span class="n">vod_ds</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span> <span class="n">grid_name</span><span class="o">=</span><span class="n">grid_name</span><span class="p">)</span>

    <span class="n">vod_values</span> <span class="o">=</span> <span class="n">vod_ds</span><span class="p">[</span><span class="s2">&quot;VOD&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">cell_ids</span> <span class="o">=</span> <span class="n">vod_ds</span><span class="p">[</span><span class="n">cell_id_var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">n_epochs</span><span class="p">,</span> <span class="n">n_sids</span> <span class="o">=</span> <span class="n">vod_values</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">unique_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">cell_ids</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cell_ids</span><span class="p">)])</span>
    <span class="n">cell_batches</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">unique_cells</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">spatial_batch_size</span><span class="p">],</span> <span class="n">i</span> <span class="o">//</span> <span class="n">spatial_batch_size</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_cells</span><span class="p">),</span> <span class="n">spatial_batch_size</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;aggr_hampel: shape=</span><span class="si">%s</span><span class="s2">, threshold=</span><span class="si">%.1f</span><span class="s2">, workers=</span><span class="si">%d</span><span class="s2">, temporal_agg=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">vod_ds</span><span class="o">.</span><span class="n">VOD</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
        <span class="n">threshold</span><span class="p">,</span>
        <span class="n">n_workers</span><span class="p">,</span>
        <span class="n">temporal_agg</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># --- Epoch grid ---</span>
    <span class="k">if</span> <span class="n">temporal_agg</span><span class="p">:</span>
        <span class="n">new_epochs</span> <span class="o">=</span> <span class="n">_compute_time_bins</span><span class="p">(</span><span class="n">vod_ds</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">temporal_agg</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Temporal aggregation â </span><span class="si">%d</span><span class="s2"> epoch bins&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_epochs</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">new_epochs</span> <span class="o">=</span> <span class="n">vod_ds</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="c1"># --- Preallocate ---</span>
    <span class="n">vod_filtered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">new_epochs</span><span class="p">),</span> <span class="n">n_sids</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">vod_agg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">new_epochs</span><span class="p">),</span> <span class="n">n_sids</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">outlier_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">new_epochs</span><span class="p">),</span> <span class="n">n_sids</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">processing_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">new_epochs</span><span class="p">),</span> <span class="n">n_sids</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="n">total_combinations_processed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total_combinations_filtered</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">sid_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_sids</span><span class="p">):</span>
        <span class="n">valid_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">vod_values</span><span class="p">[:,</span> <span class="n">sid_idx</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span>
            <span class="n">cell_ids</span><span class="p">[:,</span> <span class="n">sid_idx</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">):</span>
            <span class="k">continue</span>

        <span class="n">sid_cells</span> <span class="o">=</span> <span class="n">cell_ids</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">,</span> <span class="n">sid_idx</span><span class="p">]</span>
        <span class="n">sid_vod</span> <span class="o">=</span> <span class="n">vod_values</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">,</span> <span class="n">sid_idx</span><span class="p">]</span>
        <span class="n">valid_times</span> <span class="o">=</span> <span class="n">vod_ds</span><span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">temporal_agg</span><span class="p">:</span>
            <span class="n">valid_times</span><span class="p">,</span> <span class="n">sid_cells</span><span class="p">,</span> <span class="n">sid_vod</span> <span class="o">=</span> <span class="n">_aggregate_temporally</span><span class="p">(</span>
                <span class="n">valid_times</span><span class="p">,</span> <span class="n">sid_cells</span><span class="p">,</span> <span class="n">sid_vod</span><span class="p">,</span> <span class="n">temporal_agg</span><span class="p">,</span> <span class="n">agg_method</span>
            <span class="p">)</span>

        <span class="c1"># Parallel filtering</span>
        <span class="n">batch_args</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span>
                <span class="n">batch_cells</span><span class="p">,</span>
                <span class="n">sid_vod</span><span class="p">,</span>
                <span class="n">sid_cells</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">valid_times</span><span class="p">)),</span>
                <span class="n">threshold</span><span class="p">,</span>
                <span class="n">min_obs_per_sid</span><span class="p">,</span>
                <span class="n">batch_idx</span><span class="p">,</span>
                <span class="n">sid_idx</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">batch_cells</span><span class="p">,</span> <span class="n">batch_idx</span> <span class="ow">in</span> <span class="n">cell_batches</span>
        <span class="p">]</span>

        <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">n_workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">batch_results</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">process_spatial_batch_worker</span><span class="p">,</span> <span class="n">batch_args</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">batch_results</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;outlier_indices&quot;</span><span class="p">]:</span>
                <span class="n">t_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span>
                    <span class="n">new_epochs</span><span class="p">,</span>
                    <span class="n">valid_times</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;outlier_indices&quot;</span><span class="p">]],</span>
                <span class="p">)</span>
                <span class="n">outlier_mask</span><span class="p">[</span><span class="n">t_idx</span><span class="p">,</span> <span class="n">sid_idx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;processing_indices&quot;</span><span class="p">]:</span>
                <span class="n">t_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span>
                    <span class="n">new_epochs</span><span class="p">,</span>
                    <span class="n">valid_times</span><span class="p">[</span><span class="n">res</span><span class="p">[</span><span class="s2">&quot;processing_indices&quot;</span><span class="p">]],</span>
                <span class="p">)</span>
                <span class="n">processing_mask</span><span class="p">[</span><span class="n">t_idx</span><span class="p">,</span> <span class="n">sid_idx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">total_combinations_processed</span> <span class="o">+=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;combinations&quot;</span><span class="p">]</span>
            <span class="n">total_combinations_filtered</span> <span class="o">+=</span> <span class="n">res</span><span class="p">[</span><span class="s2">&quot;filtered&quot;</span><span class="p">]</span>

        <span class="c1"># Assign aggregated values</span>
        <span class="n">bin_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">new_epochs</span><span class="p">,</span> <span class="n">valid_times</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t_idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bin_index</span><span class="p">):</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">t_idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_epochs</span><span class="p">):</span>
                <span class="n">vod_agg</span><span class="p">[</span><span class="n">t_idx</span><span class="p">,</span> <span class="n">sid_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">vod_agg</span><span class="p">[</span><span class="n">t_idx</span><span class="p">,</span> <span class="n">sid_idx</span><span class="p">],</span> <span class="n">sid_vod</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                <span class="p">)</span>
                <span class="n">vod_filtered</span><span class="p">[</span><span class="n">t_idx</span><span class="p">,</span> <span class="n">sid_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">vod_filtered</span><span class="p">[</span><span class="n">t_idx</span><span class="p">,</span> <span class="n">sid_idx</span><span class="p">],</span> <span class="n">sid_vod</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                <span class="p">)</span>

    <span class="n">total_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

    <span class="c1"># --- Build output dataset ---</span>
    <span class="n">result_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span>
        <span class="n">data_vars</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;VOD&quot;</span><span class="p">:</span> <span class="p">([</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="s2">&quot;sid&quot;</span><span class="p">],</span> <span class="n">vod_agg</span><span class="p">),</span>
            <span class="s2">&quot;VOD_filtered_hampel&quot;</span><span class="p">:</span> <span class="p">([</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="s2">&quot;sid&quot;</span><span class="p">],</span> <span class="n">vod_filtered</span><span class="p">),</span>
            <span class="s2">&quot;hampel_outlier_mask&quot;</span><span class="p">:</span> <span class="p">([</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="s2">&quot;sid&quot;</span><span class="p">],</span> <span class="n">outlier_mask</span><span class="p">),</span>
            <span class="s2">&quot;hampel_processing_mask&quot;</span><span class="p">:</span> <span class="p">([</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="s2">&quot;sid&quot;</span><span class="p">],</span> <span class="n">processing_mask</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;epoch&quot;</span><span class="p">:</span> <span class="n">new_epochs</span><span class="p">,</span> <span class="s2">&quot;sid&quot;</span><span class="p">:</span> <span class="n">vod_ds</span><span class="p">[</span><span class="s2">&quot;sid&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">},</span>
        <span class="n">attrs</span><span class="o">=</span><span class="n">vod_ds</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span>
    <span class="p">)</span>

    <span class="c1"># Copy geometry if present</span>
    <span class="k">if</span> <span class="s2">&quot;phi&quot;</span> <span class="ow">in</span> <span class="n">vod_ds</span> <span class="ow">and</span> <span class="s2">&quot;theta&quot;</span> <span class="ow">in</span> <span class="n">vod_ds</span><span class="p">:</span>
        <span class="n">phi_tmpl</span> <span class="o">=</span> <span class="n">vod_ds</span><span class="p">[</span><span class="s2">&quot;phi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">epoch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="n">theta_tmpl</span> <span class="o">=</span> <span class="n">vod_ds</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">epoch</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
        <span class="n">result_ds</span><span class="p">[</span><span class="s2">&quot;phi&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="s2">&quot;sid&quot;</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">phi_tmpl</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_epochs</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="n">result_ds</span><span class="p">[</span><span class="s2">&quot;theta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="s2">&quot;sid&quot;</span><span class="p">],</span>
            <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">theta_tmpl</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:],</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_epochs</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="c1"># Reassign cell IDs consistently</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Reassigning cell IDs for output dataset.&quot;</span><span class="p">)</span>
    <span class="n">result_ds</span> <span class="o">=</span> <span class="n">add_cell_ids_to_vod_fast</span><span class="p">(</span><span class="n">result_ds</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="n">grid</span><span class="p">,</span> <span class="n">grid_name</span><span class="o">=</span><span class="n">grid_name</span><span class="p">)</span>

    <span class="c1"># Metadata</span>
    <span class="n">result_ds</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;processing&quot;</span><span class="p">:</span> <span class="s2">&quot;parallelized_hampel_with_optional_aggregation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;temporal_aggregation&quot;</span><span class="p">:</span> <span class="n">temporal_agg</span> <span class="ow">or</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="s2">&quot;aggregation_method&quot;</span><span class="p">:</span> <span class="n">agg_method</span><span class="p">,</span>
            <span class="s2">&quot;threshold&quot;</span><span class="p">:</span> <span class="n">threshold</span><span class="p">,</span>
            <span class="s2">&quot;min_obs_per_sid&quot;</span><span class="p">:</span> <span class="n">min_obs_per_sid</span><span class="p">,</span>
            <span class="s2">&quot;spatial_batch_size&quot;</span><span class="p">:</span> <span class="n">spatial_batch_size</span><span class="p">,</span>
            <span class="s2">&quot;n_workers&quot;</span><span class="p">:</span> <span class="n">n_workers</span><span class="p">,</span>
            <span class="s2">&quot;execution_time_s&quot;</span><span class="p">:</span> <span class="n">total_time</span><span class="p">,</span>
            <span class="s2">&quot;combinations_processed&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_combinations_processed</span><span class="p">),</span>
            <span class="s2">&quot;combinations_filtered&quot;</span><span class="p">:</span> <span class="nb">int</span><span class="p">(</span><span class="n">total_combinations_filtered</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;aggr_hampel complete: epochs=</span><span class="si">%d</span><span class="s2">, sids=</span><span class="si">%d</span><span class="s2">, time=</span><span class="si">%.1f</span><span class="s2">s&quot;</span><span class="p">,</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">new_epochs</span><span class="p">),</span>
        <span class="n">n_sids</span><span class="p">,</span>
        <span class="n">total_time</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">result_ds</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="canvod.grids.analysis.hampel_cell_sid_parallelized" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">hampel_cell_sid_parallelized</span><span class="p">(</span><span class="n">vod_ds</span><span class="p">,</span> <span class="n">grid_name</span><span class="o">=</span><span class="s1">&#39;equal_area_2deg&#39;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">min_obs_per_sid</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">spatial_batch_size</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">n_workers</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.hampel_cell_sid_parallelized" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Parallelized cellâSID Hampel filter with complete temporal coverage.</p>
<p>Each (cell_id, SID) time series is filtered independently using
global (non-chunked) statistics.  Spatial work is distributed
across <em>n_workers</em> processes.</p>
<h4 id="canvod.grids.analysis.hampel_cell_sid_parallelized--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.hampel_cell_sid_parallelized--parameters" title="Permanent link">&para;</a></h4>
<p>vod_ds : xr.Dataset
    Input dataset containing <code>'VOD'</code> and a <code>cell_id_&lt;grid_name&gt;</code>
    variable, with dimensions <code>(epoch, sid)</code>.
grid_name : str
    Grid identifier used to locate the cell-ID variable, e.g.
    <code>'equal_area_2deg'</code>.
threshold : float
    MAD multiplier for outlier detection.
min_obs_per_sid : int
    Minimum valid observations per cell-SID to run the filter.
spatial_batch_size : int
    Number of cells per parallel batch.
n_workers : int or None
    Number of worker processes.  Defaults to <code>min(cpu_count(), 8)</code>.</p>
<h4 id="canvod.grids.analysis.hampel_cell_sid_parallelized--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.hampel_cell_sid_parallelized--returns" title="Permanent link">&para;</a></h4>
<p>xr.Dataset
    Copy of <em>vod_ds</em> with additional variables:</p>
<div class="highlight"><pre><span></span><code>* ``VOD_filtered_hampel`` â filtered VOD (outliers set to NaN).
* ``hampel_processing_mask`` â boolean mask of processed
  observations.

Dataset-level attrs include full processing metadata.
</code></pre></div>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/hampel_filtering.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">hampel_cell_sid_parallelized</span><span class="p">(</span>
    <span class="n">vod_ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="n">grid_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;equal_area_2deg&quot;</span><span class="p">,</span>
    <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
    <span class="n">min_obs_per_sid</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
    <span class="n">spatial_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>
    <span class="n">n_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parallelized cellâSID Hampel filter with complete temporal coverage.</span>

<span class="sd">    Each (cell_id, SID) time series is filtered independently using</span>
<span class="sd">    global (non-chunked) statistics.  Spatial work is distributed</span>
<span class="sd">    across *n_workers* processes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vod_ds : xr.Dataset</span>
<span class="sd">        Input dataset containing ``&#39;VOD&#39;`` and a ``cell_id_&lt;grid_name&gt;``</span>
<span class="sd">        variable, with dimensions ``(epoch, sid)``.</span>
<span class="sd">    grid_name : str</span>
<span class="sd">        Grid identifier used to locate the cell-ID variable, e.g.</span>
<span class="sd">        ``&#39;equal_area_2deg&#39;``.</span>
<span class="sd">    threshold : float</span>
<span class="sd">        MAD multiplier for outlier detection.</span>
<span class="sd">    min_obs_per_sid : int</span>
<span class="sd">        Minimum valid observations per cell-SID to run the filter.</span>
<span class="sd">    spatial_batch_size : int</span>
<span class="sd">        Number of cells per parallel batch.</span>
<span class="sd">    n_workers : int or None</span>
<span class="sd">        Number of worker processes.  Defaults to ``min(cpu_count(), 8)``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xr.Dataset</span>
<span class="sd">        Copy of *vod_ds* with additional variables:</span>

<span class="sd">        * ``VOD_filtered_hampel`` â filtered VOD (outliers set to NaN).</span>
<span class="sd">        * ``hampel_processing_mask`` â boolean mask of processed</span>
<span class="sd">          observations.</span>

<span class="sd">        Dataset-level attrs include full processing metadata.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">n_workers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n_workers</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cpu_count</span><span class="p">(),</span> <span class="mi">8</span><span class="p">)</span>

    <span class="n">cell_id_var</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;cell_id_</span><span class="si">{</span><span class="n">grid_name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">n_epochs</span><span class="p">,</span> <span class="n">n_sids</span> <span class="o">=</span> <span class="n">vod_ds</span><span class="o">.</span><span class="n">VOD</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">cell_ids</span> <span class="o">=</span> <span class="n">vod_ds</span><span class="p">[</span><span class="n">cell_id_var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">vod_values</span> <span class="o">=</span> <span class="n">vod_ds</span><span class="o">.</span><span class="n">VOD</span><span class="o">.</span><span class="n">values</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Parallelized Hampel filter: shape=</span><span class="si">%s</span><span class="s2">, threshold=</span><span class="si">%.1f</span><span class="s2">, &quot;</span>
        <span class="s2">&quot;min_obs=</span><span class="si">%d</span><span class="s2">, workers=</span><span class="si">%d</span><span class="s2">, batch_size=</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">vod_ds</span><span class="o">.</span><span class="n">VOD</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
        <span class="n">threshold</span><span class="p">,</span>
        <span class="n">min_obs_per_sid</span><span class="p">,</span>
        <span class="n">n_workers</span><span class="p">,</span>
        <span class="n">spatial_batch_size</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Unique cells and spatial batches</span>
    <span class="n">unique_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">cell_ids</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cell_ids</span><span class="p">)])</span>
    <span class="n">n_spatial_batches</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_cells</span><span class="p">)</span> <span class="o">/</span> <span class="n">spatial_batch_size</span><span class="p">))</span>

    <span class="n">cell_batches</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">unique_cells</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">spatial_batch_size</span><span class="p">],</span> <span class="n">i</span> <span class="o">//</span> <span class="n">spatial_batch_size</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_cells</span><span class="p">),</span> <span class="n">spatial_batch_size</span><span class="p">)</span>
    <span class="p">]</span>

    <span class="c1"># Result arrays</span>
    <span class="n">outlier_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_epochs</span><span class="p">,</span> <span class="n">n_sids</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">processing_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_epochs</span><span class="p">,</span> <span class="n">n_sids</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="n">total_combinations_processed</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total_combinations_filtered</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">overall_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">sid_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_sids</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">sid_idx</span> <span class="o">%</span> <span class="mi">25</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">overall_start</span>
            <span class="k">if</span> <span class="n">sid_idx</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">elapsed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">rate</span> <span class="o">=</span> <span class="n">total_combinations_processed</span> <span class="o">/</span> <span class="n">elapsed</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="s2">&quot;SID </span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2"> | rate=</span><span class="si">%.0f</span><span class="s2"> combinations/s&quot;</span><span class="p">,</span>
                    <span class="n">sid_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="n">n_sids</span><span class="p">,</span>
                    <span class="n">rate</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="n">valid_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">vod_values</span><span class="p">[:,</span> <span class="n">sid_idx</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span>
            <span class="n">cell_ids</span><span class="p">[:,</span> <span class="n">sid_idx</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">):</span>
            <span class="n">total_combinations_processed</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_cells</span><span class="p">)</span>
            <span class="k">continue</span>

        <span class="n">valid_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sid_cells</span> <span class="o">=</span> <span class="n">cell_ids</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">,</span> <span class="n">sid_idx</span><span class="p">]</span>
        <span class="n">sid_vod</span> <span class="o">=</span> <span class="n">vod_values</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">,</span> <span class="n">sid_idx</span><span class="p">]</span>

        <span class="n">batch_args</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span>
                <span class="n">batch_cells</span><span class="p">,</span>
                <span class="n">sid_vod</span><span class="p">,</span>
                <span class="n">sid_cells</span><span class="p">,</span>
                <span class="n">valid_indices</span><span class="p">,</span>
                <span class="n">threshold</span><span class="p">,</span>
                <span class="n">min_obs_per_sid</span><span class="p">,</span>
                <span class="n">batch_idx</span><span class="p">,</span>
                <span class="n">sid_idx</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">batch_cells</span><span class="p">,</span> <span class="n">batch_idx</span> <span class="ow">in</span> <span class="n">cell_batches</span>
        <span class="p">]</span>

        <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">n_workers</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">batch_results</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">process_spatial_batch_worker</span><span class="p">,</span> <span class="n">batch_args</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">batch_results</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;outlier_indices&quot;</span><span class="p">]:</span>
                <span class="n">outlier_mask</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;outlier_indices&quot;</span><span class="p">],</span> <span class="n">sid_idx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;processing_indices&quot;</span><span class="p">]:</span>
                <span class="n">processing_mask</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;processing_indices&quot;</span><span class="p">],</span> <span class="n">sid_idx</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">total_combinations_processed</span> <span class="o">+=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;combinations&quot;</span><span class="p">]</span>
            <span class="n">total_combinations_filtered</span> <span class="o">+=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;filtered&quot;</span><span class="p">]</span>

    <span class="n">total_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">overall_start</span>

    <span class="c1"># Build result dataset</span>
    <span class="n">vod_filtered</span> <span class="o">=</span> <span class="n">vod_values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">vod_filtered</span><span class="p">[</span><span class="n">outlier_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="n">result_ds</span> <span class="o">=</span> <span class="n">vod_ds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">result_ds</span><span class="p">[</span><span class="s2">&quot;VOD_filtered_hampel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="s2">&quot;sid&quot;</span><span class="p">],</span> <span class="n">vod_filtered</span><span class="p">)</span>
    <span class="n">result_ds</span><span class="p">[</span><span class="s2">&quot;hampel_processing_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">([</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="s2">&quot;sid&quot;</span><span class="p">],</span> <span class="n">processing_mask</span><span class="p">)</span>

    <span class="c1"># Statistics for logging</span>
    <span class="n">original_valid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">vod_values</span><span class="p">)))</span>
    <span class="n">outliers_removed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">outlier_mask</span><span class="p">))</span>
    <span class="n">outlier_pct</span> <span class="o">=</span> <span class="n">outliers_removed</span> <span class="o">/</span> <span class="n">original_valid</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">if</span> <span class="n">original_valid</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;Hampel complete: time=</span><span class="si">%.1f</span><span class="s2">s, rate=</span><span class="si">%.0f</span><span class="s2"> comb/s, &quot;</span>
        <span class="s2">&quot;outliers=</span><span class="si">%d</span><span class="s2"> (</span><span class="si">%.2f%%</span><span class="s2">), processed=</span><span class="si">%d</span><span class="s2"> combinations&quot;</span><span class="p">,</span>
        <span class="n">total_time</span><span class="p">,</span>
        <span class="n">total_combinations_processed</span> <span class="o">/</span> <span class="n">total_time</span> <span class="k">if</span> <span class="n">total_time</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">outliers_removed</span><span class="p">,</span>
        <span class="n">outlier_pct</span><span class="p">,</span>
        <span class="n">total_combinations_processed</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Metadata</span>
    <span class="n">result_ds</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;hampel_filtering&quot;</span><span class="p">:</span> <span class="s2">&quot;parallelized_complete_temporal&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hampel_threshold&quot;</span><span class="p">:</span> <span class="n">threshold</span><span class="p">,</span>
            <span class="s2">&quot;min_obs_per_sid&quot;</span><span class="p">:</span> <span class="n">min_obs_per_sid</span><span class="p">,</span>
            <span class="s2">&quot;spatial_batch_size&quot;</span><span class="p">:</span> <span class="n">spatial_batch_size</span><span class="p">,</span>
            <span class="s2">&quot;n_workers&quot;</span><span class="p">:</span> <span class="n">n_workers</span><span class="p">,</span>
            <span class="s2">&quot;spatial_batches&quot;</span><span class="p">:</span> <span class="n">n_spatial_batches</span><span class="p">,</span>
            <span class="s2">&quot;temporal_chunking&quot;</span><span class="p">:</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span>
            <span class="s2">&quot;temporal_coverage&quot;</span><span class="p">:</span> <span class="s2">&quot;complete&quot;</span><span class="p">,</span>
            <span class="s2">&quot;processing_time_seconds&quot;</span><span class="p">:</span> <span class="n">total_time</span><span class="p">,</span>
            <span class="s2">&quot;processing_rate_combinations_per_second&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">total_combinations_processed</span> <span class="o">/</span> <span class="n">total_time</span> <span class="k">if</span> <span class="n">total_time</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="p">),</span>
            <span class="s2">&quot;combinations_processed&quot;</span><span class="p">:</span> <span class="n">total_combinations_processed</span><span class="p">,</span>
            <span class="s2">&quot;combinations_filtered&quot;</span><span class="p">:</span> <span class="n">total_combinations_filtered</span><span class="p">,</span>
            <span class="s2">&quot;parallel_efficiency&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="n">total_combinations_processed</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_workers</span> <span class="o">*</span> <span class="n">total_time</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">total_time</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="k">else</span> <span class="mi">0</span>
            <span class="p">),</span>
            <span class="s2">&quot;outliers_removed&quot;</span><span class="p">:</span> <span class="n">outliers_removed</span><span class="p">,</span>
            <span class="s2">&quot;outlier_percentage&quot;</span><span class="p">:</span> <span class="n">outlier_pct</span><span class="p">,</span>
            <span class="s2">&quot;scientific_validity&quot;</span><span class="p">:</span> <span class="s2">&quot;complete_temporal_continuity&quot;</span><span class="p">,</span>
            <span class="s2">&quot;parallelization_method&quot;</span><span class="p">:</span> <span class="s2">&quot;multiprocessing_spatial_batches&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="n">result_ds</span><span class="p">[</span><span class="s2">&quot;VOD_filtered_hampel&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;long_name&quot;</span><span class="p">:</span> <span class="p">(</span>
                <span class="s2">&quot;VOD filtered with parallelized complete temporal Hampel method&quot;</span>
            <span class="p">),</span>
            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;global_statistics_per_cell_sid&quot;</span><span class="p">,</span>
            <span class="s2">&quot;temporal_coverage&quot;</span><span class="p">:</span> <span class="s2">&quot;complete_no_chunking&quot;</span><span class="p">,</span>
            <span class="s2">&quot;parallelization&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">n_workers</span><span class="si">}</span><span class="s2">_workers_spatial_batching&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="n">result_ds</span><span class="p">[</span><span class="s2">&quot;hampel_processing_mask&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;long_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Mask of observations processed by parallel Hampel filter&quot;</span><span class="p">,</span>
            <span class="s2">&quot;temporal_coverage&quot;</span><span class="p">:</span> <span class="s2">&quot;complete&quot;</span><span class="p">,</span>
            <span class="s2">&quot;processing_method&quot;</span><span class="p">:</span> <span class="s2">&quot;parallel_spatial_batches&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">result_ds</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="canvod.grids.analysis.create_elevation_mask" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_elevation_mask</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">min_elevation</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span> <span class="n">max_elevation</span><span class="o">=</span><span class="mf">90.0</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.create_elevation_mask" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Create mask based on elevation angle.</p>
<h4 id="canvod.grids.analysis.create_elevation_mask--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.create_elevation_mask--parameters" title="Permanent link">&para;</a></h4>
<p>grid : GridData
    Grid instance.
min_elevation : float
    Minimum elevation angle in degrees (default: 30Â°).
max_elevation : float
    Maximum elevation angle in degrees (default: 90Â°).</p>
<h4 id="canvod.grids.analysis.create_elevation_mask--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.create_elevation_mask--returns" title="Permanent link">&para;</a></h4>
<p>np.ndarray
    Boolean mask.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/masking.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_elevation_mask</span><span class="p">(</span>
    <span class="n">grid</span><span class="p">:</span> <span class="n">GridData</span><span class="p">,</span> <span class="n">min_elevation</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">,</span> <span class="n">max_elevation</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">90.0</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create mask based on elevation angle.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    grid : GridData</span>
<span class="sd">        Grid instance.</span>
<span class="sd">    min_elevation : float</span>
<span class="sd">        Minimum elevation angle in degrees (default: 30Â°).</span>
<span class="sd">    max_elevation : float</span>
<span class="sd">        Maximum elevation angle in degrees (default: 90Â°).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Boolean mask.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">SpatialMask</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
    <span class="n">mask</span><span class="o">.</span><span class="n">add_elevation_range</span><span class="p">(</span><span class="n">min_elevation</span><span class="p">,</span> <span class="n">max_elevation</span><span class="p">,</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mask</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="canvod.grids.analysis.create_hemisphere_mask" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">create_hemisphere_mask</span><span class="p">(</span><span class="n">grid</span><span class="p">,</span> <span class="n">hemisphere</span><span class="o">=</span><span class="s1">&#39;north&#39;</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.create_hemisphere_mask" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Create mask for a cardinal hemisphere.</p>
<h4 id="canvod.grids.analysis.create_hemisphere_mask--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.create_hemisphere_mask--parameters" title="Permanent link">&para;</a></h4>
<p>grid : GridData
    Grid instance.
hemisphere : str
    One of <code>'north'</code>, <code>'south'</code>, <code>'east'</code>, <code>'west'</code>.</p>
<h4 id="canvod.grids.analysis.create_hemisphere_mask--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.create_hemisphere_mask--returns" title="Permanent link">&para;</a></h4>
<p>np.ndarray
    Boolean mask.</p>
<h4 id="canvod.grids.analysis.create_hemisphere_mask--raises">Raises<a class="headerlink" href="#canvod.grids.analysis.create_hemisphere_mask--raises" title="Permanent link">&para;</a></h4>
<p>ValueError
    If <em>hemisphere</em> is not recognised.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/masking.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">create_hemisphere_mask</span><span class="p">(</span><span class="n">grid</span><span class="p">:</span> <span class="n">GridData</span><span class="p">,</span> <span class="n">hemisphere</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;north&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Create mask for a cardinal hemisphere.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    grid : GridData</span>
<span class="sd">        Grid instance.</span>
<span class="sd">    hemisphere : str</span>
<span class="sd">        One of ``&#39;north&#39;``, ``&#39;south&#39;``, ``&#39;east&#39;``, ``&#39;west&#39;``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Boolean mask.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If *hemisphere* is not recognised.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_RANGES</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;north&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">315</span><span class="p">,</span> <span class="mi">45</span><span class="p">),</span>
        <span class="s2">&quot;south&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">135</span><span class="p">,</span> <span class="mi">225</span><span class="p">),</span>
        <span class="s2">&quot;east&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">45</span><span class="p">,</span> <span class="mi">135</span><span class="p">),</span>
        <span class="s2">&quot;west&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">225</span><span class="p">,</span> <span class="mi">315</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">key</span> <span class="o">=</span> <span class="n">hemisphere</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_RANGES</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Unknown hemisphere: </span><span class="si">{</span><span class="n">hemisphere</span><span class="si">}</span><span class="s2">. Choose from </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">_RANGES</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">SpatialMask</span><span class="p">(</span><span class="n">grid</span><span class="p">)</span>
    <span class="n">mask</span><span class="o">.</span><span class="n">add_phi_range</span><span class="p">(</span><span class="o">*</span><span class="n">_RANGES</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">degrees</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mask</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="canvod.grids.analysis.extract_percell_coverage" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">extract_percell_coverage</span><span class="p">(</span><span class="n">percell_ds</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.extract_percell_coverage" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Compute the fraction of valid (non-NaN) observations per cell.</p>
<h4 id="canvod.grids.analysis.extract_percell_coverage--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.extract_percell_coverage--parameters" title="Permanent link">&para;</a></h4>
<p>percell_ds : xr.Dataset
    Per-cell dataset with <code>cell_timeseries</code>.</p>
<h4 id="canvod.grids.analysis.extract_percell_coverage--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.extract_percell_coverage--returns" title="Permanent link">&para;</a></h4>
<p>np.ndarray
    1-D array of coverage percentages (0â100) per cell.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/per_cell_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">extract_percell_coverage</span><span class="p">(</span><span class="n">percell_ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the fraction of valid (non-NaN) observations per cell.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    percell_ds : xr.Dataset</span>
<span class="sd">        Per-cell dataset with ``cell_timeseries``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        1-D array of coverage percentages (0â100) per cell.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cell_timeseries</span> <span class="o">=</span> <span class="n">percell_ds</span><span class="o">.</span><span class="n">cell_timeseries</span>

    <span class="n">valid_count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cell_timeseries</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
    <span class="n">total_count</span> <span class="o">=</span> <span class="n">cell_timeseries</span><span class="o">.</span><span class="n">sizes</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>

    <span class="n">coverage_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">valid_count</span> <span class="o">/</span> <span class="n">total_count</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
    <span class="k">return</span> <span class="n">coverage_pct</span><span class="o">.</span><span class="n">values</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="canvod.grids.analysis.extract_percell_stats" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">extract_percell_stats</span><span class="p">(</span><span class="n">percell_ds</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.extract_percell_stats" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Compute a single temporal statistic for every cell.</p>
<h4 id="canvod.grids.analysis.extract_percell_stats--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.extract_percell_stats--parameters" title="Permanent link">&para;</a></h4>
<p>percell_ds : xr.Dataset
    Per-cell dataset with a <code>cell_timeseries</code> variable of shape
    <code>(cell, time)</code>.
stat : {"mean", "median", "std"}
    Statistic to reduce across the <code>time</code> dimension.</p>
<h4 id="canvod.grids.analysis.extract_percell_stats--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.extract_percell_stats--returns" title="Permanent link">&para;</a></h4>
<p>np.ndarray
    1-D array of length <code>n_cells</code>.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/per_cell_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">extract_percell_stats</span><span class="p">(</span>
    <span class="n">percell_ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="n">stat</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;median&quot;</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;median&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute a single temporal statistic for every cell.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    percell_ds : xr.Dataset</span>
<span class="sd">        Per-cell dataset with a ``cell_timeseries`` variable of shape</span>
<span class="sd">        ``(cell, time)``.</span>
<span class="sd">    stat : {&quot;mean&quot;, &quot;median&quot;, &quot;std&quot;}</span>
<span class="sd">        Statistic to reduce across the ``time`` dimension.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        1-D array of length ``n_cells``.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cell_timeseries</span> <span class="o">=</span> <span class="n">percell_ds</span><span class="o">.</span><span class="n">cell_timeseries</span>

    <span class="k">if</span> <span class="n">stat</span> <span class="o">==</span> <span class="s2">&quot;mean&quot;</span><span class="p">:</span>
        <span class="n">cell_values</span> <span class="o">=</span> <span class="n">cell_timeseries</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stat</span> <span class="o">==</span> <span class="s2">&quot;median&quot;</span><span class="p">:</span>
        <span class="n">cell_values</span> <span class="o">=</span> <span class="n">cell_timeseries</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stat</span> <span class="o">==</span> <span class="s2">&quot;std&quot;</span><span class="p">:</span>
        <span class="n">cell_values</span> <span class="o">=</span> <span class="n">cell_timeseries</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported stat: </span><span class="si">{</span><span class="n">stat</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cell_values</span><span class="o">.</span><span class="n">values</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="canvod.grids.analysis.extract_percell_temporal_stats" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">extract_percell_temporal_stats</span><span class="p">(</span><span class="n">percell_ds</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;range&#39;</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.extract_percell_temporal_stats" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Compute a temporal-characteristic statistic for every cell.</p>
<h4 id="canvod.grids.analysis.extract_percell_temporal_stats--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.extract_percell_temporal_stats--parameters" title="Permanent link">&para;</a></h4>
<p>percell_ds : xr.Dataset
    Per-cell dataset with <code>cell_timeseries</code>.
stat : {"range", "trend", "cv"}
    Statistic:</p>
<div class="highlight"><pre><span></span><code>* ``&quot;range&quot;`` â max â min over time.
* ``&quot;trend&quot;`` â linear-regression slope (requires â¥ 4 valid points;
  otherwise NaN).  Uses :mod:`scipy.stats`.
* ``&quot;cv&quot;``    â coefficient of variation (std / mean).
</code></pre></div>
<h4 id="canvod.grids.analysis.extract_percell_temporal_stats--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.extract_percell_temporal_stats--returns" title="Permanent link">&para;</a></h4>
<p>np.ndarray
    1-D array of length <code>n_cells</code>.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/per_cell_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">extract_percell_temporal_stats</span><span class="p">(</span>
    <span class="n">percell_ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="n">stat</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;range&quot;</span><span class="p">,</span> <span class="s2">&quot;trend&quot;</span><span class="p">,</span> <span class="s2">&quot;cv&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;range&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute a temporal-characteristic statistic for every cell.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    percell_ds : xr.Dataset</span>
<span class="sd">        Per-cell dataset with ``cell_timeseries``.</span>
<span class="sd">    stat : {&quot;range&quot;, &quot;trend&quot;, &quot;cv&quot;}</span>
<span class="sd">        Statistic:</span>

<span class="sd">        * ``&quot;range&quot;`` â max â min over time.</span>
<span class="sd">        * ``&quot;trend&quot;`` â linear-regression slope (requires â¥ 4 valid points;</span>
<span class="sd">          otherwise NaN).  Uses :mod:`scipy.stats`.</span>
<span class="sd">        * ``&quot;cv&quot;``    â coefficient of variation (std / mean).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        1-D array of length ``n_cells``.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">stats</span>

    <span class="n">cell_timeseries</span> <span class="o">=</span> <span class="n">percell_ds</span><span class="o">.</span><span class="n">cell_timeseries</span>

    <span class="k">if</span> <span class="n">stat</span> <span class="o">==</span> <span class="s2">&quot;range&quot;</span><span class="p">:</span>
        <span class="n">cell_max</span> <span class="o">=</span> <span class="n">cell_timeseries</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
        <span class="n">cell_min</span> <span class="o">=</span> <span class="n">cell_timeseries</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">cell_max</span> <span class="o">-</span> <span class="n">cell_min</span>

    <span class="k">elif</span> <span class="n">stat</span> <span class="o">==</span> <span class="s2">&quot;trend&quot;</span><span class="p">:</span>
        <span class="n">trends</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cell_timeseries</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">cell_data</span> <span class="o">=</span> <span class="n">cell_timeseries</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span>
            <span class="n">valid_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cell_data</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">valid_mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">time_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cell_data</span><span class="p">))[</span><span class="n">valid_mask</span><span class="p">]</span>
                <span class="n">values</span> <span class="o">=</span> <span class="n">cell_data</span><span class="p">[</span><span class="n">valid_mask</span><span class="p">]</span>
                <span class="n">slope</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">time_indices</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
                <span class="n">trends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slope</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">trends</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">trends</span><span class="p">,</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cell&quot;</span><span class="p">])</span>

    <span class="k">elif</span> <span class="n">stat</span> <span class="o">==</span> <span class="s2">&quot;cv&quot;</span><span class="p">:</span>
        <span class="n">cell_mean</span> <span class="o">=</span> <span class="n">cell_timeseries</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
        <span class="n">cell_std</span> <span class="o">=</span> <span class="n">cell_timeseries</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">cell_std</span> <span class="o">/</span> <span class="n">cell_mean</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported temporal stat: </span><span class="si">{</span><span class="n">stat</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">values</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="canvod.grids.analysis.percell_to_grid_counts" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">percell_to_grid_counts</span><span class="p">(</span><span class="n">percell_ds</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.percell_to_grid_counts" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Sum observation counts across time for each cell.</p>
<h4 id="canvod.grids.analysis.percell_to_grid_counts--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.percell_to_grid_counts--parameters" title="Permanent link">&para;</a></h4>
<p>percell_ds : xr.Dataset
    Per-cell dataset with a <code>cell_counts</code> variable of shape
    <code>(cell, time)</code>.</p>
<h4 id="canvod.grids.analysis.percell_to_grid_counts--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.percell_to_grid_counts--returns" title="Permanent link">&para;</a></h4>
<p>np.ndarray
    1-D array of total counts per cell.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/per_cell_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">percell_to_grid_counts</span><span class="p">(</span><span class="n">percell_ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Sum observation counts across time for each cell.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    percell_ds : xr.Dataset</span>
<span class="sd">        Per-cell dataset with a ``cell_counts`` variable of shape</span>
<span class="sd">        ``(cell, time)``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        1-D array of total counts per cell.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cell_counts</span> <span class="o">=</span> <span class="n">percell_ds</span><span class="o">.</span><span class="n">cell_counts</span>
    <span class="k">return</span> <span class="n">cell_counts</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="canvod.grids.analysis.percell_to_grid_data" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">percell_to_grid_data</span><span class="p">(</span><span class="n">percell_ds</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="s1">&#39;median&#39;</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.percell_to_grid_data" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Thin wrapper around :func:<code>extract_percell_stats</code>.</p>
<p>Provided for symmetry with <code>aggregate_data_to_grid</code> workflows.</p>
<h4 id="canvod.grids.analysis.percell_to_grid_data--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.percell_to_grid_data--parameters" title="Permanent link">&para;</a></h4>
<p>percell_ds : xr.Dataset
    Per-cell dataset.
stat : {"mean", "median", "std"}
    Statistic to compute.</p>
<h4 id="canvod.grids.analysis.percell_to_grid_data--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.percell_to_grid_data--returns" title="Permanent link">&para;</a></h4>
<p>np.ndarray
    1-D array compatible with grid visualisation.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/per_cell_analysis.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">percell_to_grid_data</span><span class="p">(</span>
    <span class="n">percell_ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="n">stat</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;median&quot;</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;median&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Thin wrapper around :func:`extract_percell_stats`.</span>

<span class="sd">    Provided for symmetry with ``aggregate_data_to_grid`` workflows.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    percell_ds : xr.Dataset</span>
<span class="sd">        Per-cell dataset.</span>
<span class="sd">    stat : {&quot;mean&quot;, &quot;median&quot;, &quot;std&quot;}</span>
<span class="sd">        Statistic to compute.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        1-D array compatible with grid visualisation.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">extract_percell_stats</span><span class="p">(</span><span class="n">percell_ds</span><span class="p">,</span> <span class="n">stat</span><span class="o">=</span><span class="n">stat</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="canvod.grids.analysis.astropy_hampel_ultra_fast" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">astropy_hampel_ultra_fast</span><span class="p">(</span><span class="n">vod_ds</span><span class="p">,</span> <span class="n">grid_name</span><span class="o">=</span><span class="s1">&#39;equal_area_2deg&#39;</span><span class="p">,</span> <span class="n">window_hours</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">sigma_threshold</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">min_points</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.astropy_hampel_ultra_fast" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Pure-numpy sigma-clipping filter via <code>astropy.stats</code>.</p>
<p>Each (cell, SID) time series is clipped in one shot using
:func:<code>astropy.stats.sigma_clip</code> with median centering and MAD
scale estimation.  No per-window temporal granularity is applied;
this trades precision for throughput.</p>
<h4 id="canvod.grids.analysis.astropy_hampel_ultra_fast--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.astropy_hampel_ultra_fast--parameters" title="Permanent link">&para;</a></h4>
<p>vod_ds : xr.Dataset
    VOD dataset containing a <code>cell_id_&lt;grid_name&gt;</code> variable.
grid_name : str, optional
    Suffix for the cell-ID variable.
window_hours : float, optional
    Unused in ultra-fast mode; kept for API compatibility.
sigma_threshold : float, optional
    Sigma-clipping threshold passed to <code>astropy.stats.sigma_clip</code>.
min_points : int, optional
    Minimum finite observations required to attempt clipping.</p>
<h4 id="canvod.grids.analysis.astropy_hampel_ultra_fast--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.astropy_hampel_ultra_fast--returns" title="Permanent link">&para;</a></h4>
<p>result_ds : xr.Dataset
    Copy of <em>vod_ds</em> with <code>VOD_filtered</code> and
    <code>hampel_outlier_mask</code> variables added.</p>
<h4 id="canvod.grids.analysis.astropy_hampel_ultra_fast--raises">Raises<a class="headerlink" href="#canvod.grids.analysis.astropy_hampel_ultra_fast--raises" title="Permanent link">&para;</a></h4>
<p>ValueError
    If the expected cell-ID variable is missing from <em>vod_ds</em>.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/sigma_clip_filter.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">astropy_hampel_ultra_fast</span><span class="p">(</span>
    <span class="n">vod_ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="n">grid_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;equal_area_2deg&quot;</span><span class="p">,</span>
    <span class="n">window_hours</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">sigma_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
    <span class="n">min_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Pure-numpy sigma-clipping filter via ``astropy.stats``.</span>

<span class="sd">    Each (cell, SID) time series is clipped in one shot using</span>
<span class="sd">    :func:`astropy.stats.sigma_clip` with median centering and MAD</span>
<span class="sd">    scale estimation.  No per-window temporal granularity is applied;</span>
<span class="sd">    this trades precision for throughput.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vod_ds : xr.Dataset</span>
<span class="sd">        VOD dataset containing a ``cell_id_&lt;grid_name&gt;`` variable.</span>
<span class="sd">    grid_name : str, optional</span>
<span class="sd">        Suffix for the cell-ID variable.</span>
<span class="sd">    window_hours : float, optional</span>
<span class="sd">        Unused in ultra-fast mode; kept for API compatibility.</span>
<span class="sd">    sigma_threshold : float, optional</span>
<span class="sd">        Sigma-clipping threshold passed to ``astropy.stats.sigma_clip``.</span>
<span class="sd">    min_points : int, optional</span>
<span class="sd">        Minimum finite observations required to attempt clipping.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result_ds : xr.Dataset</span>
<span class="sd">        Copy of *vod_ds* with ``VOD_filtered`` and</span>
<span class="sd">        ``hampel_outlier_mask`` variables added.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the expected cell-ID variable is missing from *vod_ds*.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cell_id_var</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;cell_id_</span><span class="si">{</span><span class="n">grid_name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">cell_id_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vod_ds</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Cell ID variable &#39;</span><span class="si">{</span><span class="n">cell_id_var</span><span class="si">}</span><span class="s2">&#39; not found in dataset. &quot;</span>
            <span class="s2">&quot;Run add_cell_ids_to_vod_fast() first.&quot;</span>
        <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;ultra-fast hampel: sigma=</span><span class="si">%.1f</span><span class="s2">, min_points=</span><span class="si">%d</span><span class="s2">, shape=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">sigma_threshold</span><span class="p">,</span>
        <span class="n">min_points</span><span class="p">,</span>
        <span class="n">vod_ds</span><span class="o">.</span><span class="n">VOD</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">vod_values</span> <span class="o">=</span> <span class="n">vod_ds</span><span class="o">.</span><span class="n">VOD</span><span class="o">.</span><span class="n">values</span>
    <span class="n">cell_ids</span> <span class="o">=</span> <span class="n">vod_ds</span><span class="p">[</span><span class="n">cell_id_var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">vod_values</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">outlier_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">vod_values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="n">unique_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">cell_ids</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cell_ids</span><span class="p">)])</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;processing </span><span class="si">%d</span><span class="s2"> cells Ã </span><span class="si">%d</span><span class="s2"> SIDs ...&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_cells</span><span class="p">),</span> <span class="n">vod_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">for</span> <span class="n">cell_id</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">unique_cells</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Cells&quot;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">sid_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">vod_values</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="n">cell_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">cell_ids</span><span class="p">[:,</span> <span class="n">sid_idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">cell_id</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span>
                <span class="n">vod_values</span><span class="p">[:,</span> <span class="n">sid_idx</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">cell_mask</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">cell_data</span> <span class="o">=</span> <span class="n">vod_values</span><span class="p">[</span><span class="n">cell_mask</span><span class="p">,</span> <span class="n">sid_idx</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cell_data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_points</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">clipped</span> <span class="o">=</span> <span class="n">sigma_clip</span><span class="p">(</span>
                    <span class="n">cell_data</span><span class="p">,</span>
                    <span class="n">sigma</span><span class="o">=</span><span class="n">sigma_threshold</span><span class="p">,</span>
                    <span class="n">cenfunc</span><span class="o">=</span><span class="s2">&quot;median&quot;</span><span class="p">,</span>
                    <span class="n">stdfunc</span><span class="o">=</span><span class="n">mad_std</span><span class="p">,</span>
                    <span class="n">maxiters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">masked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">cell_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cell_mask</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">filtered_data</span><span class="p">[</span><span class="n">cell_indices</span><span class="p">,</span> <span class="n">sid_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">clipped</span><span class="o">.</span><span class="n">data</span>
                <span class="n">outlier_mask</span><span class="p">[</span><span class="n">cell_indices</span><span class="p">,</span> <span class="n">sid_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">clipped</span><span class="o">.</span><span class="n">mask</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">continue</span>

    <span class="n">total_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

    <span class="n">result_ds</span> <span class="o">=</span> <span class="n">vod_ds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">result_ds</span><span class="p">[</span><span class="s2">&quot;VOD_filtered&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="s2">&quot;sid&quot;</span><span class="p">),</span> <span class="n">filtered_data</span><span class="p">)</span>
    <span class="n">result_ds</span><span class="p">[</span><span class="s2">&quot;hampel_outlier_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="s2">&quot;sid&quot;</span><span class="p">),</span> <span class="n">outlier_mask</span><span class="p">)</span>

    <span class="n">total_obs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">vod_values</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">outliers</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">outlier_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

    <span class="n">result_ds</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;hampel_method&quot;</span><span class="p">:</span> <span class="s2">&quot;ultra_fast_astropy_sigma_clip&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hampel_sigma_threshold&quot;</span><span class="p">:</span> <span class="n">sigma_threshold</span><span class="p">,</span>
            <span class="s2">&quot;hampel_min_points&quot;</span><span class="p">:</span> <span class="n">min_points</span><span class="p">,</span>
            <span class="s2">&quot;hampel_processing_time_s&quot;</span><span class="p">:</span> <span class="n">total_time</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">result_ds</span><span class="p">[</span><span class="s2">&quot;VOD_filtered&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;long_name&quot;</span><span class="p">:</span> <span class="s2">&quot;VOD filtered with ultra-fast astropy sigma clipping&quot;</span><span class="p">,</span>
            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;astropy_sigma_clip_per_cell_sid&quot;</span><span class="p">,</span>
            <span class="s2">&quot;outlier_threshold_sigma&quot;</span><span class="p">:</span> <span class="n">sigma_threshold</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;done in </span><span class="si">%.1f</span><span class="s2">s | obs=</span><span class="si">%d</span><span class="s2"> outliers=</span><span class="si">%d</span><span class="s2"> (</span><span class="si">%.2f%%</span><span class="s2">)&quot;</span><span class="p">,</span>
        <span class="n">total_time</span><span class="p">,</span>
        <span class="n">total_obs</span><span class="p">,</span>
        <span class="n">outliers</span><span class="p">,</span>
        <span class="p">(</span><span class="n">outliers</span> <span class="o">/</span> <span class="n">total_obs</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">total_obs</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">result_ds</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="canvod.grids.analysis.astropy_hampel_vectorized_fast" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">astropy_hampel_vectorized_fast</span><span class="p">(</span><span class="n">vod_ds</span><span class="p">,</span> <span class="n">grid_name</span><span class="o">=</span><span class="s1">&#39;equal_area_2deg&#39;</span><span class="p">,</span> <span class="n">window_hours</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">sigma_threshold</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">min_points</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">cell_batch_size</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">n_workers</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.astropy_hampel_vectorized_fast" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Numba-accelerated sliding-window Hampel filter over a VOD dataset.</p>
<p>Temporal chunks (as stored in the dask-backed dataset) are iterated
sequentially; within each chunk the unique cells are split into
batches of <em>cell_batch_size</em> and dispatched to
:func:<code>process_cell_batch_vectorized</code>, which in turn calls the
numba-compiled :func:<code>vectorized_sliding_window_hampel</code>.</p>
<h4 id="canvod.grids.analysis.astropy_hampel_vectorized_fast--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.astropy_hampel_vectorized_fast--parameters" title="Permanent link">&para;</a></h4>
<p>vod_ds : xr.Dataset
    VOD dataset containing a <code>cell_id_&lt;grid_name&gt;</code> variable.
grid_name : str, optional
    Suffix used to locate the cell-ID variable
    (<code>cell_id_&lt;grid_name&gt;</code>).
window_hours : float, optional
    Half-window size in hours for the sliding window.
sigma_threshold : float, optional
    Outlier boundary in scaled-MAD units.
min_points : int, optional
    Minimum finite points required in a window.
cell_batch_size : int, optional
    Number of cells per batch (trades memory for cache locality).
n_workers : int or None, optional
    Unused in this implementation; reserved for future parallel
    chunk processing.</p>
<h4 id="canvod.grids.analysis.astropy_hampel_vectorized_fast--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.astropy_hampel_vectorized_fast--returns" title="Permanent link">&para;</a></h4>
<p>result_ds : xr.Dataset
    Copy of <em>vod_ds</em> with two additional variables:</p>
<div class="highlight"><pre><span></span><code>``VOD_filtered``
    Filtered VOD (outliers â NaN).
``hampel_outlier_mask``
    Boolean mask; ``True`` at outlier positions.
</code></pre></div>
<h4 id="canvod.grids.analysis.astropy_hampel_vectorized_fast--raises">Raises<a class="headerlink" href="#canvod.grids.analysis.astropy_hampel_vectorized_fast--raises" title="Permanent link">&para;</a></h4>
<p>ValueError
    If the expected cell-ID variable is missing from <em>vod_ds</em>.</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/sigma_clip_filter.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">astropy_hampel_vectorized_fast</span><span class="p">(</span>
    <span class="n">vod_ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span>
    <span class="n">grid_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;equal_area_2deg&quot;</span><span class="p">,</span>
    <span class="n">window_hours</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
    <span class="n">sigma_threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
    <span class="n">min_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">cell_batch_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
    <span class="n">n_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Numba-accelerated sliding-window Hampel filter over a VOD dataset.</span>

<span class="sd">    Temporal chunks (as stored in the dask-backed dataset) are iterated</span>
<span class="sd">    sequentially; within each chunk the unique cells are split into</span>
<span class="sd">    batches of *cell_batch_size* and dispatched to</span>
<span class="sd">    :func:`process_cell_batch_vectorized`, which in turn calls the</span>
<span class="sd">    numba-compiled :func:`vectorized_sliding_window_hampel`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vod_ds : xr.Dataset</span>
<span class="sd">        VOD dataset containing a ``cell_id_&lt;grid_name&gt;`` variable.</span>
<span class="sd">    grid_name : str, optional</span>
<span class="sd">        Suffix used to locate the cell-ID variable</span>
<span class="sd">        (``cell_id_&lt;grid_name&gt;``).</span>
<span class="sd">    window_hours : float, optional</span>
<span class="sd">        Half-window size in hours for the sliding window.</span>
<span class="sd">    sigma_threshold : float, optional</span>
<span class="sd">        Outlier boundary in scaled-MAD units.</span>
<span class="sd">    min_points : int, optional</span>
<span class="sd">        Minimum finite points required in a window.</span>
<span class="sd">    cell_batch_size : int, optional</span>
<span class="sd">        Number of cells per batch (trades memory for cache locality).</span>
<span class="sd">    n_workers : int or None, optional</span>
<span class="sd">        Unused in this implementation; reserved for future parallel</span>
<span class="sd">        chunk processing.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result_ds : xr.Dataset</span>
<span class="sd">        Copy of *vod_ds* with two additional variables:</span>

<span class="sd">        ``VOD_filtered``</span>
<span class="sd">            Filtered VOD (outliers â NaN).</span>
<span class="sd">        ``hampel_outlier_mask``</span>
<span class="sd">            Boolean mask; ``True`` at outlier positions.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If the expected cell-ID variable is missing from *vod_ds*.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cell_id_var</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;cell_id_</span><span class="si">{</span><span class="n">grid_name</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">cell_id_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vod_ds</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Cell ID variable &#39;</span><span class="si">{</span><span class="n">cell_id_var</span><span class="si">}</span><span class="s2">&#39; not found in dataset. &quot;</span>
            <span class="s2">&quot;Run add_cell_ids_to_vod_fast() first.&quot;</span>
        <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;vectorized hampel: window=</span><span class="si">%.1f</span><span class="s2">h, sigma=</span><span class="si">%.1f</span><span class="s2">, batch_size=</span><span class="si">%d</span><span class="s2">, shape=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">window_hours</span><span class="p">,</span>
        <span class="n">sigma_threshold</span><span class="p">,</span>
        <span class="n">cell_batch_size</span><span class="p">,</span>
        <span class="n">vod_ds</span><span class="o">.</span><span class="n">VOD</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">vod_data</span> <span class="o">=</span> <span class="n">vod_ds</span><span class="o">.</span><span class="n">VOD</span><span class="o">.</span><span class="n">data</span>
    <span class="n">cell_ids</span> <span class="o">=</span> <span class="n">vod_ds</span><span class="p">[</span><span class="n">cell_id_var</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
    <span class="n">times</span> <span class="o">=</span> <span class="n">vod_ds</span><span class="o">.</span><span class="n">epoch</span><span class="o">.</span><span class="n">values</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;processing </span><span class="si">%d</span><span class="s2"> temporal chunks ...&quot;</span><span class="p">,</span> <span class="n">vod_data</span><span class="o">.</span><span class="n">numblocks</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_temporal_chunk</span><span class="p">(</span><span class="n">chunk_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process a single temporal chunk.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        chunk_idx : int</span>
<span class="sd">            Chunk index along time axis.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tuple[np.ndarray, np.ndarray]</span>
<span class="sd">            Filtered values and outlier mask.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">chunk_start</span> <span class="o">=</span> <span class="n">chunk_idx</span> <span class="o">*</span> <span class="n">vod_data</span><span class="o">.</span><span class="n">chunksize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">chunk_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">chunk_start</span> <span class="o">+</span> <span class="n">vod_data</span><span class="o">.</span><span class="n">chunksize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vod_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">vod_chunk</span> <span class="o">=</span> <span class="n">vod_data</span><span class="p">[</span><span class="n">chunk_start</span><span class="p">:</span><span class="n">chunk_end</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="n">cell_chunk</span> <span class="o">=</span> <span class="n">cell_ids</span><span class="p">[</span><span class="n">chunk_start</span><span class="p">:</span><span class="n">chunk_end</span><span class="p">]</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
        <span class="n">times_chunk</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">chunk_start</span><span class="p">:</span><span class="n">chunk_end</span><span class="p">]</span>

        <span class="n">unique_cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">cell_chunk</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">cell_chunk</span><span class="p">)])</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_cells</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">vod_chunk</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">vod_chunk</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="n">n_cell_batches</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_cells</span><span class="p">)</span> <span class="o">/</span> <span class="n">cell_batch_size</span><span class="p">))</span>

        <span class="n">filtered_chunk</span> <span class="o">=</span> <span class="n">vod_chunk</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">outlier_chunk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">vod_chunk</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">batch_idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_cell_batches</span><span class="p">):</span>
            <span class="n">batch_start</span> <span class="o">=</span> <span class="n">batch_idx</span> <span class="o">*</span> <span class="n">cell_batch_size</span>
            <span class="n">batch_end</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">batch_start</span> <span class="o">+</span> <span class="n">cell_batch_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_cells</span><span class="p">))</span>
            <span class="n">cell_batch</span> <span class="o">=</span> <span class="n">unique_cells</span><span class="p">[</span><span class="n">batch_start</span><span class="p">:</span><span class="n">batch_end</span><span class="p">]</span>

            <span class="n">batch_filtered</span><span class="p">,</span> <span class="n">batch_outliers</span> <span class="o">=</span> <span class="n">process_cell_batch_vectorized</span><span class="p">(</span>
                <span class="n">cell_batch</span><span class="o">=</span><span class="n">cell_batch</span><span class="p">,</span>
                <span class="n">vod_chunk</span><span class="o">=</span><span class="n">vod_chunk</span><span class="p">,</span>
                <span class="n">times_chunk</span><span class="o">=</span><span class="n">times_chunk</span><span class="p">,</span>
                <span class="n">cell_ids_chunk</span><span class="o">=</span><span class="n">cell_chunk</span><span class="p">,</span>
                <span class="n">window_hours</span><span class="o">=</span><span class="n">window_hours</span><span class="p">,</span>
                <span class="n">sigma_threshold</span><span class="o">=</span><span class="n">sigma_threshold</span><span class="p">,</span>
                <span class="n">min_points</span><span class="o">=</span><span class="n">min_points</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">for</span> <span class="n">cell_id</span> <span class="ow">in</span> <span class="n">cell_batch</span><span class="p">:</span>
                <span class="n">cell_mask</span> <span class="o">=</span> <span class="n">cell_chunk</span> <span class="o">==</span> <span class="n">cell_id</span>
                <span class="n">filtered_chunk</span><span class="p">[</span><span class="n">cell_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch_filtered</span><span class="p">[</span><span class="n">cell_mask</span><span class="p">]</span>
                <span class="n">outlier_chunk</span><span class="p">[</span><span class="n">cell_mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch_outliers</span><span class="p">[</span><span class="n">cell_mask</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">filtered_chunk</span><span class="p">,</span> <span class="n">outlier_chunk</span>

    <span class="n">filtered_chunks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">outlier_chunks</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">chunk_idx</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">vod_data</span><span class="o">.</span><span class="n">numblocks</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Temporal chunks&quot;</span><span class="p">):</span>
        <span class="n">f_chunk</span><span class="p">,</span> <span class="n">o_chunk</span> <span class="o">=</span> <span class="n">_process_temporal_chunk</span><span class="p">(</span><span class="n">chunk_idx</span><span class="p">)</span>
        <span class="n">filtered_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f_chunk</span><span class="p">)</span>
        <span class="n">outlier_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">o_chunk</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;assembling results ...&quot;</span><span class="p">)</span>
    <span class="n">filtered_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">filtered_chunks</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">outlier_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">outlier_chunks</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">total_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>

    <span class="c1"># Build result dataset</span>
    <span class="n">result_ds</span> <span class="o">=</span> <span class="n">vod_ds</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">result_ds</span><span class="p">[</span><span class="s2">&quot;VOD_filtered&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="s2">&quot;sid&quot;</span><span class="p">),</span> <span class="n">filtered_data</span><span class="p">)</span>
    <span class="n">result_ds</span><span class="p">[</span><span class="s2">&quot;hampel_outlier_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;epoch&quot;</span><span class="p">,</span> <span class="s2">&quot;sid&quot;</span><span class="p">),</span> <span class="n">outlier_data</span><span class="p">)</span>

    <span class="n">total_obs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">vod_ds</span><span class="o">.</span><span class="n">VOD</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">outliers_detected</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">outlier_data</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
    <span class="n">outlier_pct</span> <span class="o">=</span> <span class="p">(</span><span class="n">outliers_detected</span> <span class="o">/</span> <span class="n">total_obs</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="k">if</span> <span class="n">total_obs</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">0.0</span>

    <span class="n">result_ds</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;hampel_method&quot;</span><span class="p">:</span> <span class="s2">&quot;vectorized_astropy_equivalent&quot;</span><span class="p">,</span>
            <span class="s2">&quot;hampel_window_hours&quot;</span><span class="p">:</span> <span class="n">window_hours</span><span class="p">,</span>
            <span class="s2">&quot;hampel_sigma_threshold&quot;</span><span class="p">:</span> <span class="n">sigma_threshold</span><span class="p">,</span>
            <span class="s2">&quot;hampel_min_points&quot;</span><span class="p">:</span> <span class="n">min_points</span><span class="p">,</span>
            <span class="s2">&quot;hampel_processing_time_s&quot;</span><span class="p">:</span> <span class="n">total_time</span><span class="p">,</span>
            <span class="s2">&quot;hampel_vectorized_optimized&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;performance_target_achieved&quot;</span><span class="p">:</span> <span class="n">total_time</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="n">result_ds</span><span class="p">[</span><span class="s2">&quot;VOD_filtered&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;long_name&quot;</span><span class="p">:</span> <span class="s2">&quot;VOD filtered with vectorized Hampel method&quot;</span><span class="p">,</span>
            <span class="s2">&quot;method&quot;</span><span class="p">:</span> <span class="s2">&quot;vectorized_sliding_window_with_numba_jit&quot;</span><span class="p">,</span>
            <span class="s2">&quot;temporal_window_hours&quot;</span><span class="p">:</span> <span class="n">window_hours</span><span class="p">,</span>
            <span class="s2">&quot;outlier_threshold_sigma&quot;</span><span class="p">:</span> <span class="n">sigma_threshold</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="s2">&quot;done in </span><span class="si">%.1f</span><span class="s2">s | obs=</span><span class="si">%d</span><span class="s2"> outliers=</span><span class="si">%d</span><span class="s2"> (</span><span class="si">%.2f%%</span><span class="s2">) | target_met=</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">total_time</span><span class="p">,</span>
        <span class="n">total_obs</span><span class="p">,</span>
        <span class="n">outliers_detected</span><span class="p">,</span>
        <span class="n">outlier_pct</span><span class="p">,</span>
        <span class="n">total_time</span> <span class="o">&lt;</span> <span class="mi">300</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">result_ds</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="canvod.grids.analysis.AnalysisStorage" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">AnalysisStorage</span><span class="p">(</span><span class="n">store_path</span><span class="p">)</span></code>

<a href="#canvod.grids.analysis.AnalysisStorage" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

        <p>Lazy accessor for AnalysisStorage.</p>
<p>See :class:<code>~canvod.grids.analysis.analysis_storage.AnalysisStorage</code>.</p>
<p>Defers the import so that <code>canvod-store</code> is only required when this
class is actually used.</p>
<h4 id="canvod.grids.analysis.AnalysisStorage--parameters">Parameters<a class="headerlink" href="#canvod.grids.analysis.AnalysisStorage--parameters" title="Permanent link">&para;</a></h4>
<p>store_path : Path or str
    Path to the VOD Icechunk store.</p>
<h4 id="canvod.grids.analysis.AnalysisStorage--returns">Returns<a class="headerlink" href="#canvod.grids.analysis.AnalysisStorage--returns" title="Permanent link">&para;</a></h4>
<p>AnalysisStorageType</p>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>packages/canvod-grids/src/canvod/grids/analysis/__init__.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">AnalysisStorage</span><span class="p">(</span><span class="n">store_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">|</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;AnalysisStorageType&quot;</span><span class="p">:</span>  <span class="c1"># noqa: N802</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Lazy accessor for AnalysisStorage.</span>

<span class="sd">    See :class:`~canvod.grids.analysis.analysis_storage.AnalysisStorage`.</span>

<span class="sd">    Defers the import so that ``canvod-store`` is only required when this</span>
<span class="sd">    class is actually used.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    store_path : Path or str</span>
<span class="sd">        Path to the VOD Icechunk store.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    AnalysisStorageType</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">canvod.grids.analysis.analysis_storage</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
        <span class="n">AnalysisStorage</span> <span class="k">as</span> <span class="n">_AnalysisStorage</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">_AnalysisStorage</span><span class="p">(</span><span class="n">store_path</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>














                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="lucide lucide-circle-arrow-up" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="m16 12-4-4-4 4M12 16V8"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="Footer" >
        
          
          <a href="../canvod-auxiliary/" class="md-footer__link md-footer__link--prev" aria-label="Previous: canvod.auxiliary">
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="lucide lucide-arrow-left" viewBox="0 0 24 24"><path d="m12 19-7-7 7-7M19 12H5"/></svg>
            </div>
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Previous
              </span>
              <div class="md-ellipsis">
                canvod.auxiliary
              </div>
            </div>
          </a>
        
        
          
          <a href="../canvod-vod/" class="md-footer__link md-footer__link--next" aria-label="Next: canvod.vod">
            <div class="md-footer__title">
              <span class="md-footer__direction">
                Next
              </span>
              <div class="md-ellipsis">
                canvod.vod
              </div>
            </div>
            <div class="md-footer__button md-icon">
              
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" class="lucide lucide-arrow-right" viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2026 Nicolas Bader, TU Wien
    </div>
  
  
    Made with
    <a href="https://zensical.org/" target="_blank" rel="noopener">
      Zensical
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/nfb2021/canvodpy" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://pypi.org/project/canvodpy/" target="_blank" rel="noopener" title="pypi.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 444.7a20.4 20.4 0 1 1 0-40.7 20.4 20.4 0 1 1 0 40.7M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.6-183.4a20.4 20.4 0 1 1 0 40.8 20.4 20.4 0 1 1 0-40.8"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      
      <script id="__config" type="application/json">{"annotate":null,"base":"../..","features":["content.code.copy","content.code.annotate","navigation.footer","navigation.indexes","navigation.instant","navigation.instant.prefetch","navigation.path","navigation.sections","navigation.tabs","navigation.top","navigation.tracking","search.highlight"],"search":"../../assets/javascripts/workers/search.e2d2d235.min.js","tags":null,"translations":{"clipboard.copied":"Copied to clipboard","clipboard.copy":"Copy to clipboard","search.result.more.one":"1 more on this page","search.result.more.other":"# more on this page","search.result.none":"No matching documents","search.result.one":"1 matching document","search.result.other":"# matching documents","search.result.placeholder":"Type to start searching","search.result.term.missing":"Missing","select.version":"Select version"},"version":null}</script>
    
    
      <script src="../../assets/javascripts/bundle.8ffeb9c9.min.js"></script>
      
        <script src="https://unpkg.com/beautiful-mermaid/dist/beautiful-mermaid.browser.global.js"></script>
      
        <script src="../../assets/mermaid-init.js"></script>
      
    
  </body>
</html>