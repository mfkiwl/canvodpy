flowchart TD
    subgraph INPUT["Data Acquisition"]
        RINEX["RINEX v3.04 Observation Files (SNR, Pseudorange, Phase)"]
        SP3["SP3 Precise Ephemerides (satellite orbits)"]
        CLK["CLK Precise Clock Corrections"]
    end

    subgraph DOWNLOAD["Auxiliary Data Retrieval"]
        FTP["FTP Download (ESA primary, NASA CDDIS fallback)"]
        CACHE["Local File Cache (SP3/CLK per DOY)"]
    end

    subgraph PREPROCESS["Auxiliary Preprocessing"]
        PARSE_SP3["Parse SP3 (ECEF satellite positions + velocities)"]
        PARSE_CLK["Parse CLK (satellite clock offsets)"]
        HERMITE["Hermite Spline Interpolation (cubic, velocity-aware)"]
        LINEAR["Piecewise Linear Interpolation (clock corrections)"]
        MERGE_AUX["Merge Interpolated Auxiliary Data (Zarr cache)"]
    end

    subgraph PARALLEL["Parallel RINEX Processing (ProcessPoolExecutor)"]
        READ["Read RINEX (per hourly file)"]
        SID["Signal ID Mapping (sv|band|code)"]
        SLICE["Slice Auxiliary to Observation Epochs (nearest-neighbour)"]
        SCS["Spherical Coordinate Transformation (ECEF to r, theta, phi)"]
    end

    subgraph STORAGE["Versioned Storage"]
        ICECHUNK["Icechunk Repository (append per epoch, commit per file)"]
        META["Metadata Tracking (RINEX hash, snapshot ID, epoch range)"]
    end

    subgraph GRIDDING["Hemispheric Grid Assignment"]
        GRID["Grid Construction (equal-area, HEALPix, geodesic, ...)"]
        KDTREE["KDTree Cell Assignment (O(n log m) spatial query)"]
    end

    subgraph VOD["VOD Retrieval"]
        PAIR["Canopy-Reference Dataset Pairing"]
        TAU["Zeroth-Order Tau-Omega Inversion"]
        FORMULA["DELTA_SNR = SNR_canopy - SNR_ref transmissivity = 10^(DELTA_SNR/10) VOD = -ln(transmissivity) * cos(theta)"]
    end

    subgraph OUTPUT["Output"]
        VOD_DS["VOD Dataset (per sid, epoch, cell)"]
        VIZ["Hemispheric Visualization (polar projection)"]
    end

    SP3 --> FTP
    CLK --> FTP
    FTP --> CACHE
    CACHE --> PARSE_SP3
    CACHE --> PARSE_CLK
    PARSE_SP3 --> HERMITE
    PARSE_CLK --> LINEAR
    HERMITE --> MERGE_AUX
    LINEAR --> MERGE_AUX

    RINEX --> READ
    READ --> SID
    MERGE_AUX --> SLICE
    SID --> SLICE
    SLICE --> SCS
    SCS --> ICECHUNK
    ICECHUNK --> META

    ICECHUNK --> GRID
    GRID --> KDTREE
    KDTREE --> PAIR
    PAIR --> TAU
    TAU --> FORMULA
    FORMULA --> VOD_DS
    VOD_DS --> VIZ
