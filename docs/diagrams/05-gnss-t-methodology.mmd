flowchart TD
    subgraph INPUT["Data Acquisition"]
        RINEX["RINEX v3.04 Observation Files\n(SNR, Pseudorange, Phase, Doppler)"]
        SP3["SP3 Precise Ephemerides\n(satellite positions every 5/15 min)"]
        CLK["CLK Precise Clock Corrections\n(satellite clock offsets)"]
    end

    subgraph DOWNLOAD["Auxiliary Data Retrieval"]
        FTP["FTP Download (ESA primary, NASA CDDIS fallback)"]
        CACHE["Local File Cache (SP3/CLK per DOY)"]
    end

    subgraph PREPROCESS_R["Auxiliary Preprocessing"]
        PARSE_SP3["Parse SP3 (ECEF satellite positions + velocities)"]
        PARSE_CLK["Parse CLK (satellite clock offsets)"]
        HERMITE["Hermite Spline Interpolation (cubic, velocity-aware)"]
        LINEAR["Piecewise Linear Interpolation (clock corrections)"]
        MERGE_AUX["Merge Interpolated Auxiliary Data (Zarr cache)"]
    end

    subgraph PARALLEL["Parallel RINEX Processing (ProcessPoolExecutor)"]
        READ["Read RINEX (per hourly file)"]
        SID["Signal ID Mapping (sv|band|code)"]
        SLICE["Slice Auxiliary to Observation Epochs (nearest-neighbour)"]
        SCS["Spherical Coordinate Transformation (ECEF → r, θ, φ)"]
    end

    subgraph STORAGE["Versioned Storage (Icechunk)"]
        ICECHUNK["Observations Repository\n(append per epoch, commit per file)"]
        META_TRACK["Metadata Tracking\n(RINEX hash, snapshot ID, epoch range)"]
    end

    subgraph GRIDDING["Hemispheric Grid Assignment"]
        GRID["Grid Construction\n(equal-area, HEALPix, geodesic, ...)"]
        KDTREE["KDTree Cell Assignment (O(n log m) spatial query)"]
    end

    subgraph VOD["VOD Retrieval"]
        PAIR["Canopy-Reference Dataset Pairing"]
        TAU["Zeroth-Order Tau-Omega Inversion"]
        FORMULA["ΔSNR = SNR_canopy − SNR_reference\ntransmissivity T = 10^(ΔSNR/10)\nVOD = −ln(T) · cos(θ)"]
    end

    subgraph OUTPUT["Output"]
        VOD_DS["VOD Dataset (per sid, epoch, cell)"]
        VIZ["Hemispheric Visualization (polar projection)"]
    end

    SP3 --> FTP
    CLK --> FTP
    FTP --> CACHE
    CACHE --> PARSE_SP3
    CACHE --> PARSE_CLK
    PARSE_SP3 --> HERMITE
    PARSE_CLK --> LINEAR
    HERMITE --> MERGE_AUX
    LINEAR --> MERGE_AUX

    RINEX --> READ
    READ --> SID
    MERGE_AUX --> SLICE
    SID --> SLICE
    SLICE --> SCS
    SCS --> ICECHUNK
    ICECHUNK --> META_TRACK

    ICECHUNK --> GRID
    GRID --> KDTREE
    KDTREE --> PAIR
    PAIR --> TAU
    TAU --> FORMULA
    FORMULA --> VOD_DS
    VOD_DS --> VIZ
