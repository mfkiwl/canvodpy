flowchart TD
    Start([ðŸš€ Start Processing]) --> Input

    subgraph Input["ðŸ“¥ Data Ingestion"]
        RINEX["ðŸ“„ RINEX Files\n(.XXo, all constellations)"]
        SP3["ðŸ›°ï¸ SP3 Files\n(Precise Orbits)"]
        CLK["â° CLK Files\n(Precise Clocks)"]
    end

    subgraph Reading["ðŸ” Reading & Parsing"]
        RinexReader["Rnxv3Obs\nParse RINEX v3.04"]
        AuxReader["SP3/CLK Parsers\nLoad Auxiliary Data"]
    end

    subgraph Processing["âš™ï¸ Processing"]
        Interp["Hermite Interpolation\nOrbits/clocks â†’ obs epochs"]
        Position["Coordinate Transform\nECEF â†’ spherical (r, Î¸, Ï†)"]
        Augment["Dataset Augmentation\nMerge RINEX + geometry"]
    end

    subgraph Storage["ðŸ’¾ Versioned Storage (Icechunk)"]
        Icechunk["Observations Store\n(epoch Ã— sid)"]
    end

    subgraph Analysis["ðŸ“Š Analysis"]
        GridAssign["Hemispheric Grid Assignment\nEqual-area / HEALPix / geodesic"]
        VODCalc["VOD Retrieval\nTau-Omega model Â· canopy vs reference"]
        Aggregate["Aggregation\nPer-cell statistics"]
    end

    subgraph Output["ðŸ“ˆ Output"]
        Viz2D["2D Hemisphere Plots\nPolar projection"]
        Viz3D["3D Interactive Plots\nPlotly surface"]
        Export["Data Export\nNetCDF / CSV"]
    end

    RINEX --> RinexReader
    SP3 --> AuxReader
    CLK --> AuxReader

    RinexReader --> Augment
    AuxReader --> Interp
    Interp --> Position
    Position --> Augment
    Augment --> Icechunk

    Icechunk --> GridAssign
    GridAssign --> VODCalc
    VODCalc --> Aggregate

    Aggregate --> Viz2D
    Aggregate --> Viz3D
    Aggregate --> Export

    Viz2D --> End([âœ… Complete])
    Viz3D --> End
    Export --> End

    style Start fill:#4caf50,stroke:#1b5e20,stroke-width:3px,color:#fff
    style End fill:#4caf50,stroke:#1b5e20,stroke-width:3px,color:#fff
    style Input fill:#fff3e0,stroke:#e65100,stroke-width:2px
    style Reading fill:#ffecb3,stroke:#f57c00,stroke-width:2px
    style Processing fill:#e1f5fe,stroke:#0277bd,stroke-width:2px
    style Storage fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    style Analysis fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px
    style Output fill:#e0f2f1,stroke:#00695c,stroke-width:2px
